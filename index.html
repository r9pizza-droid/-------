<!DOCTYPE html>
<html lang="ko"><head><link id="app-favicon" rel="icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;ðŸ“&lt;/text&gt;&lt;/svg&gt;"><link rel="apple-touch-icon" href="data:image/png;base64,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"><link id="app-manifest" rel="manifest" href="blob:https://checklist-zeta-woad.vercel.app/3074931f-ca70-4102-a931-ec420582fcff"></head><body __processed_8b533b5f-2a9f-4340-a6ac-054980fc5fef__="true" class="bg-white text-[#37352F] select-none overscroll-y-none md:overscroll-y-auto" __processed_ead473d2-53c5-4776-8448-f41133475e12__="true" style="zoom: 100%; --ui-scale: 1;" bis_register="W3sibWFzdGVyIjp0cnVlLCJleHRlbnNpb25JZCI6ImVwcGlvY2VtaG1ubGJoanBsY2drb2ZjaWllZ29tY29uIiwiYWRibG9ja2VyU3RhdHVzIjp7IkRJU1BMQVkiOiJlbmFibGVkIiwiRkFDRUJPT0siOiJlbmFibGVkIiwiVFdJVFRFUiI6ImVuYWJsZWQiLCJSRURESVQiOiJlbmFibGVkIiwiUElOVEVSRVNUIjoiZW5hYmxlZCIsIklOU1RBR1JBTSI6ImVuYWJsZWQiLCJUSUtUT0siOiJkaXNhYmxlZCIsIkxJTktFRElOIjoiZW5hYmxlZCIsIkNPTkZJRyI6ImRpc2FibGVkIn0sInZlcnNpb24iOiIyLjAuNDQiLCJzY29yZSI6MjAwNDQwfV0="><plasmo-csui id="brisk-teaching-extension-shadow-root" data-extension-version="1.0.349" data-extension-name="Brisk Teaching â€“ AI Assistant for Teachers" style="z-index: 2147483647;"></plasmo-csui><plasmo-csui id="brisk-teaching-extension-shadow-root" data-extension-version="1.0.349" data-extension-name="Brisk Teaching â€“ AI Assistant for Teachers" style="z-index: 2147483647;"></plasmo-csui>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤í–ˆë‚˜ìš”?</title>
    
    <meta property="og:title" content="ë‹¤í–ˆë‚˜ìš”!?">
    <meta property="og:description" content="ìš°ë¦¬ ë°˜ ìˆ™ì œ í™•ì¸ ë° í•™ê¸‰ ê²½ì˜ ë„êµ¬">
    
    
    
    <script src="https://cdn.tailwindcss.com" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/ko.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" data-app-script="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" data-app-script="true"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css" data-app-style="true">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&amp;family=Jua&amp;family=Nanum+Gothic:wght@400;700&amp;family=Nanum+Myeongjo:wght@400;700&amp;display=swap" rel="stylesheet">

    <script data-app-script="true">
        dayjs.locale('ko');
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: { 50: '#F7F7F5', 100: '#E9E9E7', 500: '#37352F', 600: '#2F2F2F', 700: '#191711' },
                        notion: {
                            bg: '#FFFFFF',
                            'bg-hover': '#F1F1EF',
                            'bg-alt': '#F7F7F5',
                            text: '#37352F',
                            'text-light': 'rgba(55, 53, 47, 0.65)',
                            border: '#E9E9E7',
                            red: '#E03E3E',
                            blue: '#0B6E99',
                            green: '#0F7B6C',
                            orange: '#D9730D',
                            yellow: '#DFAB01',
                            purple: '#6940A5',
                            pink: '#AD1A72',
                        }
                    },
                    fontFamily: { 
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Helvetica', '"Apple Color Emoji"', 'Arial', 'sans-serif', '"Segoe UI Emoji"', '"Segoe UI Symbol"'],
                        serif: ['Lyon-Text', 'Georgia', 'YuMincho', '"Yu Mincho"', '"Hiragino Mincho ProN"', '"Hiragino Mincho Pro"', '"Songti SC"', '"Shimsong"', 'serif'],
                        hand: ['"Gaegu"', 'cursive'],
                        jua: ['"Jua"', 'sans-serif'],
                        nanum: ['"Nanum Gothic"', 'sans-serif'],
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'pop-up': 'popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'modal-enter': 'modalEnter 0.25s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'expand-from': 'expandFrom 0.25s cubic-bezier(0.16, 1, 0.3, 1)',
                        'blink-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blink-strong': 'blinkStrong 0.4s ease-in-out infinite',
                        'zoom-out': 'zoomOut 0.3s ease-in-out forwards',
                        'zoom-in': 'zoomIn 0.3s ease-in-out forwards',
                        'zoom-out-reverse': 'zoomOutReverse 0.3s ease-in-out forwards',
                        'zoom-in-reverse': 'zoomInReverse 0.3s ease-in-out forwards',
                        'slide-out-left': 'slideOutLeft 0.2s ease-in-out forwards',
                        'slide-out-right': 'slideOutRight 0.2s ease-in-out forwards',
                        'slide-in-right-fwd': 'slideInRight 0.2s ease-in-out forwards',
                        'slide-in-left-fwd': 'slideInLeft 0.2s ease-in-out forwards',
                    },
                    keyframes: {
                        bounceIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        fadeIn: { 'from': { opacity: 0 }, 'to': { opacity: 1 } },
                        popUp: { 'from': { transform: 'translate(-50%, -40%) scale(0.9)', opacity: 0 }, 'to': { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 } },
                        modalEnter: { '0%': { opacity: 0, transform: 'scale(0.95) translateY(10px)' }, '100%': { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        slideInRight: { '0%': { transform: 'translateX(20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInLeft: { '0%': { transform: 'translateX(-20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInRight: { '0%': { transform: 'translateX(50%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInLeft: { '0%': { transform: 'translateX(-50%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        expandFrom: { '0%': { transform: 'scale(0)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        slideInDown: { '0%': { transform: 'translate(-50%, -100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                        blinkStrong: { '0%, 100%': { opacity: 1, transform: 'scale(1)' }, '50%': { opacity: 0.4, transform: 'scale(1.15)' } },
                        zoomOut: { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(1.15)', opacity: 0 } },
                        zoomIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        zoomOutReverse: { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.9)', opacity: 0 } },
                        zoomInReverse: { '0%': { transform: 'scale(1.15)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        slideOutLeft: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(-20%)', opacity: 0 } },
                        slideOutRight: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(20%)', opacity: 0 } },
                        slideOutLeft: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(-50%)', opacity: 0 } },
                        slideOutRight: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(50%)', opacity: 0 } },
                    }
                }
            }
        }
    </script>
    <style data-app-style="true">
        /* ðŸŒŸ ì´ í•œ ì¤„ì´ í™”ë©´ ë°‘ì˜ ëª¨ë“  ìœ ë ¹ ì—¬ë°±ì„ ê°•ì œë¡œ ìž˜ë¼ëƒ…ë‹ˆë‹¤! */
        #root > div { padding-bottom: 10px !important; margin-bottom: 0 !important; }
        
        /* ðŸŒŸ ëª» ì°¾ìœ¼ì…¨ë‹¤ë©´ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”! (main íƒœê·¸ì˜ í•˜ë‹¨ ì—¬ë°± ê°•ì œ ì¶•ì†Œ) */
        main { padding-bottom: 10px !important; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .dragging { opacity: 0.5; transform: scale(0.98); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .drag-over { background-color: #eff6ff; border-color: #3b82f6 !important; border-width: 2px !important; transform: scale(1.02); box-shadow: 0 0 0 2px #3b82f6; z-index: 10; }
        .seat-cell { position: relative; }
        .seat-cell.drag-over::after {
            content: '+';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #22c55e;
            font-size: 3rem;
            font-weight: 800;
            border-radius: 0.75rem;
            pointer-events: none;
            z-index: 50;
            border: 2px dashed #22c55e;
        }
        body.is-dragging-seat .seat-cell * { pointer-events: none !important; }
        body.is-dragging-seat .student-card { pointer-events: none !important; opacity: 0.5; }
        body.is-dragging-seat img { pointer-events: none !important; }
        body.is-dragging-group .group-card * { pointer-events: none !important; }
        /* ë“œëž˜ê·¸ ì¤‘ì¼ ë•Œ ëª¨ë“  ìžì‹ ìš”ì†Œì˜ ì´ë²¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ì—¬ ë“œë¡­ ì˜ì—­ ê°ì§€ìœ¨ì„ ë†’ìž„ */
        body.is-dragging-seat * {
            cursor: grabbing !important;
        }
        body.is-dragging-seat .student-card,
        body.is-dragging-seat .seat-cell * {
            pointer-events: none !important;
        }
/* ë“œë¡­ ê°€ëŠ¥í•œ ì˜ì—­(ì¢Œì„)ì€ ì´ë²¤íŠ¸ ë°›ê¸° í—ˆìš© */
        body.is-dragging-seat .seat-cell {
            pointer-events: auto !important;
        }
    </style>


    <div id="root" class="min-h-screen flex flex-col" bis_skin_checked="1"></div>

    <script type="text/babel" data-app-script="true">
        const safeLocalStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { return window._memStore ? window._memStore[key] : null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { if (!window._memStore) window._memStore = {}; window._memStore[key] = value; }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } 
                catch (e) { if (window._memStore) delete window._memStore[key]; }
            }
        };
        
        const updateAiUsage = () => {
            const current = parseInt(localStorage.getItem('cls_ai_usage') || '0');
            localStorage.setItem('cls_ai_usage', current + 1);
            
            try {
                const today = dayjs().format('YYYY-MM-DD');
                const history = JSON.parse(localStorage.getItem('cls_ai_usage_history') || '{}');
                history[today] = (history[today] || 0) + 1;
                
                const keys = Object.keys(history).sort();
                if (keys.length > 30) {
                    const newHistory = {};
                    keys.slice(keys.length - 30).forEach(k => newHistory[k] = history[k]);
                    localStorage.setItem('cls_ai_usage_history', JSON.stringify(newHistory));
                } else {
                    localStorage.setItem('cls_ai_usage_history', JSON.stringify(history));
                }
            } catch (e) { console.error("Usage history update failed", e); }
        };

        const logSystemEvent = (message, type = 'info') => {
            try {
                const logs = JSON.parse(localStorage.getItem('cls_system_logs') || '[]');
                const newLog = {
                    time: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                    type,
                    message: (message instanceof Error) ? message.toString() : (typeof message === 'object' ? JSON.stringify(message) : String(message))
                };
                const updatedLogs = [newLog, ...logs].slice(0, 100); // Keep last 100 logs
                localStorage.setItem('cls_system_logs', JSON.stringify(updatedLogs));
            } catch (e) { console.error("System log write failure:", e); }
        };

        const GEMINI_MODEL_NAME = "gemini-2.5-flash-lite";
        // [New] Gemini í˜¸ì¶œ í•¨ìˆ˜ (ë¦¬í¬íŠ¸ ìƒì„±ìš©)
        const callGemini = async (apiKey, prompt, temperature = 0.7) => {
            // ðŸ”’ [ë³´ì•ˆ ì ê²€] ì‹¤ì œ AIì—ê²Œ ì „ì†¡ë˜ëŠ” ë‚´ìš©ì„ ì½˜ì†”ì°½ì— ì¶œë ¥í•©ë‹ˆë‹¤.
            // F12(ê°œë°œìž ë„êµ¬) > Console íƒ­ì—ì„œ í•™ìƒ ì´ë¦„ì´ [STUDENT_TOKEN]ìœ¼ë¡œ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            console.log("ðŸš€ [Gemini ì „ì†¡ í”„ë¡¬í”„íŠ¸ í™•ì¸]", prompt);

            // [New] ê°œë°œìž ëª¨ë“œ ë˜ëŠ” ë³´ì•ˆ í™•ì¸ ëª¨ë“œì¼ ê²½ìš° ì „ì†¡ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì‚¬ìš©ìž í™•ì¸ìš©)
            if (localStorage.getItem('cls_ai_safety_check') === 'true') {
                if (window.triggerAiSecurityCheck) {
                    await window.triggerAiSecurityCheck(prompt);
                } else {
                    const msg = `[ðŸ”’ ë³´ì•ˆ í™•ì¸: AI ì „ì†¡ ë°ì´í„°]\n\n${prompt.substring(0, 300)}...\n\n(ì´ë¦„ì´ [STUDENT_TOKEN] ë˜ëŠ” 'ê¸‰ìš°' ë“±ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)\n\nì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (!confirm(msg)) throw new Error("ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }

            if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: temperature }
                    }),
                    referrerPolicy: "no-referrer"
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || response.statusText);
                updateAiUsage();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (e) {
                logSystemEvent(e, 'error');
                if (e.message.includes('Failed to fetch')) throw new Error("ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ (CORS ë˜ëŠ” ì¸í„°ë„· ë¬¸ì œ)");
                throw e;
            }
        };

        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        // ðŸŒŸ ë”°ì˜´í‘œ ì¤‘ë³µ ë°©ì§€ ë° ì „ì†¡ ìµœì í™” ë²„ì „
        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        const saveToGoogleSheet = async (studentData, category, recordContent, recordDate) => {
            let url = localStorage.getItem('cls_google_sheet_url');
            if (url) url = url.trim().replace(/^"|'|"$|'$/g, '');
            
            if (!url) {
                alert("ì„¤ì • > ë°ì´í„° ê´€ë¦¬ > ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì—ì„œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
            }
            try {
                const dateStr = recordDate ? dayjs(recordDate).format('YYYY-MM-DD') + ' ' + dayjs().format('HH:mm:ss') : dayjs().format('YYYY-MM-DD HH:mm:ss');
                const clean = (val) => String(val || "").trim().replace(/^"|"$/g, '');

                let payload;
                // ðŸŒŸ í•µì‹¬ ê¸°ìˆ : ë‹¤ìˆ˜ì˜ í•™ìƒ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ 'ë°°ì—´(Array)'ë¡œ ë¬¶ì–´ì„œ í¬ìž¥í•©ë‹ˆë‹¤!
                if (Array.isArray(studentData)) {
                    payload = studentData.map(s => ({
                        date: clean(dateStr),
                        name: clean(s.name || s),
                        category: clean(category),
                        content: clean(recordContent), 
                        memo: clean(recordContent),
                        text: clean(recordContent)
                    }));
                } else {
                    payload = {
                        date: clean(dateStr),
                        name: clean(studentData),
                        category: clean(category),
                        content: clean(recordContent), 
                        memo: clean(recordContent),
                        text: clean(recordContent)
                    };
                }

                await fetch(url, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (e) {
                console.error(e); return false;
            }
        };

        // [New] ìµëª…í™” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const anonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            let processed = text;
            processed = processed.replaceAll(studentName, '[STUDENT_TOKEN]');
            if (studentName.length >= 3) {
                const nameOnly = studentName.substring(1);
                processed = processed.replaceAll(nameOnly, '[STUDENT_TOKEN]');
            }
            return processed;
        };

        const deanonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            // [Safety] AIê°€ ì‹¤ìˆ˜ë¡œ ì‹¤ëª…ì„ í¬í•¨í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¨¼ì € ìµëª…í™” í† í°ìœ¼ë¡œ ë³€í™˜
            const safeText = anonymizeText(text, studentName);
            return safeText.replaceAll('[STUDENT_TOKEN]', studentName).replaceAll('í•´ë‹¹ í•™ìƒ', studentName);
        };

        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const getToday = () => dayjs().format('YYYY-MM-DD');
        const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        const HOLIDAYS = {
            '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚  ì—°íœ´', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚  ì—°íœ´', '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-06-03': 'ì§€ë°©ì„ ê±°', '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-09-24': 'ì¶”ì„ ì—°íœ´', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„ ì—°íœ´', '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-10-09': 'í•œê¸€ë‚ ', '2026-12-25': 'ì„±íƒ„ì ˆ'
        };
        
        const PATHS = {
            calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
            check: "M20 6 9 17l-5-5", users: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
            chart: "M3 3v18h18 M18 17V9 M13 17V5 M8 17v-3", plus: "M12 5v14 M5 12h14", trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            left: "M15 18 L9 12 L15 6", right: "M9 18 L15 12 L9 6", upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12", download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            bot: "M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M12 8v4 M4 12v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6 M9 16a2 2 0 0 1-2-2v-1 M15 16a2 2 0 0 0 2-2v-1 M12 16v-4",
            list: "M8 6h13 M8 12h13 M8 18h13 M3 6h.01 M3 12h.01 M3 18h.01", code: "M16 18l6-6-6-6 M8 6l-6 6 6 6", edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
            cloud: "M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.17 0-.335.01-.497.027C16.48 6.965 13.812 5 10.5 5 6.358 5 3 8.358 3 12.5c0 3.23 2.063 6.008 5.006 7",
            grid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z", trophy: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M2 12h20",
            warning: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01",
            lock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 10 0v4",
            unlock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 9.9-1",
            x: "M18 6L6 18M6 6l12 12", help: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-1-5h2v2h-2v-2zm2-1.645V14h-2v-1.5a1 1 0 0 1 1-1 1.5 1.5 0 1 0-1.471-1.794l-1.962-.393A3.501 3.501 0 1 1 13 13.355z",
            settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.01a2 2 0 0 1-2 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2.78a2 2 0 0 1-2-2v-.01a2 2 0 0 1-2-2z",
            down: "M6 9l6 6 6-6", sun: "M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z",
            crown: "M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14v2H5v-2z", 
            link: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71", document: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8",
            copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z",
            spinner: "M21 12a9 9 0 1 1-6.219-8.56", mic: "M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v4 M8 23h8",
            magic: "M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34 M18 2l4 4 M15.5 4.5l3 3 M10 10l8-8", book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            send: "M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z", search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
            key: "M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4",
            speaker: "M11 5L6 9H2v6h4l5 4V5z M19.07 4.93a10 10 0 0 1 0 14.14 M15.54 8.46a5 5 0 0 1 0 7.07",
            mute: "M11 5L6 9H2v6h4l5 4V5z M23 9l-6 6 M17 9l6 6",
            play: "M5 3l14 9-14 9V3z",
            history: "M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
        };

        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Btn = ({ onClick, className, children, ...props }) => (
            <button onClick={onClick} className={`transition-colors duration-100 active:opacity-70 flex items-center justify-center rounded hover:bg-notion-bg-hover ${className}`} {...props}>{children}</button>
        );
        const BaseModal = ({ isOpen, onClose, title, icon, children, footer, maxWidth = "max-w-2xl", zIndex = "z-50", onTitleClick }) => {
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                };
            }, [isOpen, onClose]);

            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 bg-black/40 ${zIndex} flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in`} onClick={onClose}>
                    <div 
                        className={`bg-white w-full ${maxWidth} rounded-xl shadow-xl border border-notion-border p-6 h-auto flex flex-col animate-modal-enter`} 
                        style={{ maxHeight: 'calc(85vh / var(--ui-scale, 1))' }}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 className={`text-lg font-bold flex items-center gap-2 text-notion-text ${onTitleClick ? 'cursor-pointer select-none' : ''}`} onClick={onTitleClick}>{icon ? <Icon d={icon} className="text-notion-text" /> : null} {title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-notion-bg-hover rounded text-notion-text-light"><Icon d={PATHS.x} /></button>
                        </div>
                        <div className="overflow-y-auto custom-scroll flex-1 pr-2 space-y-6">{children}</div>
                        {footer && <div className="pt-4 border-t mt-4 flex-shrink-0">{footer}</div>}
                    </div>
                </div>
            );
        };
        const Toast = ({ message, action, onClose }) => {
            const onCloseRef = useRef(onClose);
            useEffect(() => { onCloseRef.current = onClose; }, [onClose]);
            useEffect(() => { 
                if (!message) return; 
                let duration = action ? 4000 : 3000;
                if (message.includes("ì—°ë™ ìƒíƒœ í™•ì¸ ì¤‘")) duration = 600000; 
                if (message.includes("âŒ")) return;
                const timer = setTimeout(() => onCloseRef.current(), duration); 
                return () => clearTimeout(timer); 
            }, [message, action]);
            if (!message) return null;
            
            // ðŸŒŸ ë©”ì‹œì§€ ë‚´ìš©ì— ë”°ë¼ ë””ìžì¸ ìžë™ ë³€ê²½ (ì‚­ì œ/ì—ëŸ¬ vs ì„±ê³µ/ì €ìž¥)
            const isAlert = message.includes("ì‚­ì œ") || message.includes("ì´ˆê¸°í™”") || message.includes("ì‹¤íŒ¨") || message.includes("ì˜¤ë¥˜");
            const iconBg = isAlert ? "from-rose-400 to-rose-600" : "from-indigo-500 to-purple-500";
            const emoji = isAlert ? "ðŸ—‘ï¸" : "âœ¨";
            const borderColor = isAlert ? "border-rose-100" : "border-indigo-100";

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[4000] w-full max-w-sm px-4 animate-[slideInDown_0.5s_cubic-bezier(0.16,1,0.3,1)] pointer-events-none">
                    <div className={`bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-3 border ${borderColor} flex items-center gap-3 ring-1 ring-black/5 pointer-events-auto`}>
                        <div className={`w-10 h-10 bg-gradient-to-br ${iconBg} rounded-full flex items-center justify-center flex-shrink-0 shadow-sm`}>
                            <span className="text-lg animate-bounce">{emoji}</span>
                        </div>
                        <div className="flex-1 min-w-0 pr-2">
                            <h4 className="font-bold text-slate-800 text-sm leading-tight break-keep whitespace-pre-wrap">{message}</h4>
                        </div>
                        {action && (
                            <button onClick={action.onClick} className="ml-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-xl text-xs font-bold transition-colors shadow-sm whitespace-nowrap">
                                {action.label}
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 z-[2500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div 
                        className="bg-white rounded-xl shadow-xl border border-notion-border p-6 w-full max-w-sm animate-modal-enter relative"
                    >
                        <button onClick={onCancel} className="absolute top-4 right-4 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                            <Icon d={PATHS.x} size={18} />
                        </button>
                        <div className="flex items-center gap-2 mb-4 text-notion-text font-bold"><Icon d={PATHS.warning} /> í™•ì¸</div><p className="text-notion-text mb-6 text-sm whitespace-pre-wrap">{message}</p><div className="flex gap-3"><Btn onClick={onCancel} className="flex-1 py-2 bg-white text-slate-600 rounded border border-slate-200 font-medium hover:bg-slate-100 hover:border-slate-300 transition-colors">ì·¨ì†Œ</Btn><Btn onClick={onConfirm} className="flex-1 py-2 bg-notion-red text-white rounded font-medium hover:bg-red-600 shadow-sm transition-colors">í™•ì¸</Btn></div></div></div>
            );
        };
        const UpdateNotificationModal = ({ isOpen, onUpdate, onClose }) => {
            if (!isOpen) return null;
            
            // ðŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const latestUpdate = UPDATE_NOTES[0];
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed inset-0 bg-black/50 z-[3000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center animate-bounce-in relative overflow-hidden border border-white/50">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors z-20">
                            <Icon d={PATHS.x} size={20} />
                        </button>
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        
                        <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner ring-4 ring-indigo-50/50">
                            <span className="text-4xl animate-pulse drop-shadow-sm select-none">ðŸš€</span>
                        </div>
                        <h3 className="text-xl font-extrabold text-slate-800 mb-1">ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ!</h3>
                        <p className="text-xs text-slate-500 mb-4">ì›í™œí•œ ì‚¬ìš©ì„ ìœ„í•´ ì•±ì„ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.</p>
                        
                        {/* ðŸŒŸ ì—¬ê¸°ì— ìµœì‹  ì—…ë°ì´íŠ¸ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ */}
                        <div className="text-left bg-slate-50 p-4 rounded-xl border border-slate-100 mb-5">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded-md">
                                    {latestUpdate.version}
                                </span>
                                <span className="text-[10px] text-slate-400 font-medium">{latestUpdate.date || "ìµœì‹  ì—…ë°ì´íŠ¸"}</span>
                            </div>
                            <ul className="text-[11px] text-slate-600 space-y-1.5">
                                {changes.slice(0, 3).map((item, index) => (
                                    <li key={index} className="flex items-start gap-1.5">
                                        <span className="text-indigo-400 mt-0.5">â€¢</span>
                                        <span className="leading-tight">{item}</span>
                                    </li>
                                ))}
                                {changes.length > 3 && (
                                    <li className="text-slate-400 pl-3 pt-1 font-medium">...ì™¸ {changes.length - 3}ê±´</li>
                                )}
                            </ul>
                        </div>

                        <div className="flex flex-col gap-2">
                            <button onClick={onUpdate} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <span>âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨)</span>
                            </button>
                            <div className="flex gap-2">
                                <button onClick={() => onClose('today')} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</button>
                                <button onClick={() => onClose()} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const UpdateNotificationToast = ({ isOpen, onUpdate, onClose }) => {
            const timerRef = useRef(null);
            
            useEffect(() => {
                if (isOpen) {
                    timerRef.current = setTimeout(onClose, 8000); // í…ìŠ¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìžˆë„ë¡ 8ì´ˆ ìœ ì§€
                }
                return () => clearTimeout(timerRef.current);
            }, [isOpen, onClose]);
            
            const handleMouseEnter = () => clearTimeout(timerRef.current);
            const handleMouseLeave = () => { 
                if (isOpen) timerRef.current = setTimeout(onClose, 8000); 
            };
            
            if (!isOpen) return null;

            // ðŸŒŸ í•µì‹¬: ì—¬ëŸ¬ ë²„ì „ì˜ ê¸°ë¡ì´ ìžˆì–´ë„ ë¬´ì¡°ê±´ [0]ë²ˆì§¸(ê°€ìž¥ ìµœì‹ ) ë°ì´í„°ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤!
            const latestUpdate = UPDATE_NOTES[0] || {};
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[3000] w-full max-w-sm px-4 animate-[slideInDown_0.5s_cubic-bezier(0.16,1,0.3,1)]" 
                     onMouseEnter={handleMouseEnter} 
                     onMouseLeave={handleMouseLeave} 
                     onTouchStart={handleMouseEnter} 
                     onTouchEnd={handleMouseLeave}>
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-4 border border-indigo-100 flex flex-col gap-3 ring-1 ring-black/5 relative">
                        
                        <button onClick={() => onClose()} className="absolute top-2 right-2 p-1 text-slate-300 hover:text-slate-500 rounded-full hover:bg-slate-100 transition-colors z-10">
                            <Icon d={PATHS.x} size={14} />
                        </button>

                        <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm mt-0.5">
                                <span className="text-lg animate-pulse">ðŸš€</span>
                            </div>
                            
                            <div className="flex-1 min-w-0">
                                <h4 className="font-bold text-slate-800 text-sm flex items-center gap-2 mb-2">
                                    ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ! 
                                    <span className="bg-indigo-100 text-indigo-600 text-[10px] px-1.5 py-0.5 rounded font-bold">{latestUpdate.version}</span>
                                </h4>
                                
                                {/* ðŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ë‚´ìš© ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */}
                                <ul className="text-[11px] text-slate-600 space-y-1.5 max-h-[150px] overflow-y-auto custom-scroll pr-2">
                                    {changes.map((item, index) => (
                                        <li key={index} className="flex items-start gap-1.5">
                                            <span className="text-indigo-400 mt-0.5">â€¢</span>
                                            <span className="leading-tight break-keep">{item}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-1 pt-3 border-t border-slate-100">
                            <button onClick={() => onClose('today')} className="flex-1 py-2 text-slate-500 text-[11px] font-bold bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors">
                                ì˜¤ëŠ˜ í•˜ë£¨ ìˆ¨ê¹€
                            </button>
                            <button onClick={onUpdate} className="flex-1 py-2 bg-indigo-600 text-white text-[11px] font-bold rounded-xl hover:bg-indigo-700 shadow-sm active:scale-95 transition-all">
                                âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸
                            </button>
                        </div>
                        
                    </div>
                </div>
            );
        };
        const HelpModal = ({ isOpen, onClose }) => {
            if(!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ìžë™ ë°±ì—… ë„ì›€ë§" icon={PATHS.help}><div className="space-y-4 text-sm text-slate-600 leading-relaxed"><div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><h4 className="font-bold text-indigo-700 mb-2">ðŸš€ ê¸°ëŠ¥ ì†Œê°œ</h4><p>ì„¤ì •ëœ ì‹œê°„ì— í˜„ìž¬ ì•±ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ <strong>JSON íŒŒì¼</strong>ë¡œ ìžë™ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. ë§Œì•½ì˜ ì‚¬íƒœì— ëŒ€ë¹„í•´ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”.</p></div><div className="space-y-2"><h4 className="font-bold text-slate-800">âš ï¸ í•„ìˆ˜ ì£¼ì˜ì‚¬í•­</h4><ul className="list-disc pl-5 space-y-1"><li><strong>ì•±ì´ ì¼œì ¸ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤:</strong> ì´ ê¸°ëŠ¥ì€ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ìž‘ë™í•˜ë¯€ë¡œ, í•´ë‹¹ ì‹œê°„ì— ì´ ì›¹íŽ˜ì´ì§€ê°€ ì—´ë ¤ ìžˆì–´ì•¼ë§Œ ìž‘ë™í•©ë‹ˆë‹¤. ì»´í“¨í„°ê°€ êº¼ì ¸ ìžˆê±°ë‚˜ íƒ­ì„ ë‹«ìœ¼ë©´ ë°±ì—…ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li><strong>íŒì—… ì°¨ë‹¨ í•´ì œ:</strong> ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ 'ìžë™ ë‹¤ìš´ë¡œë“œ' ë˜ëŠ” 'íŒì—…'ì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì°¨ë‹¨í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</li><li><strong>ì €ìž¥ ìœ„ì¹˜:</strong> ë³´ì•ˆìƒ ì›¹ì‚¬ì´íŠ¸ê°€ ë°”íƒ•í™”ë©´ ë“± ì €ìž¥ ìœ„ì¹˜ë¥¼ ê°•ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì˜ 'ë‹¤ìš´ë¡œë“œ í´ë”'ì— ì €ìž¥ë©ë‹ˆë‹¤. (ì„¤ì •ì—ì„œ 'ë‹¤ìš´ë¡œë“œ ì „ì— ì €ìž¥ ìœ„ì¹˜ í™•ì¸'ì„ ì¼œë‘ì‹œë©´ ë§¤ë²ˆ ìœ„ì¹˜ë¥¼ ì§€ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.)</li></ul></div></div></BaseModal>
            );
        }

        const DEFAULT_ROLE_DESCRIPTIONS = {
            'ë‚˜ëˆ”ì´': { title: 'ìš°ë¦¬ ëª¨ë‘ ì„ ìœ„í•´ ì„¬ê²¨ì£¼ëŠ” ë‚˜ëˆ”ì´!', desc: ['ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ë‚˜ëˆ ì¤˜ìš”!', 'ì¹œêµ¬ë“¤ì´ í™œë™ì„ ìž˜ í•  ìˆ˜ ìžˆê²Œ ì±™ê²¨ì¤˜ìš”', 'ì„ ìƒë‹˜ì˜ ë§ì„ ëª¨ë‘  ì¹œêµ¬ë“¤ì—ê²Œ ì „ë‹¬í•´ìš”'] },
            'ë§ºìŒì´': { title: 'ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ì •ë¦¬í•´ì£¼ëŠ” ë§ºìŒì´!', desc: ['ì¹œêµ¬ë“¤ì˜ í™œë™ì§€ë¥¼ ì„ ìƒë‹˜ì—ê²Œ ì œì¶œí•´ìš”', 'ë‚¨ì€ í™œë™ì‹œê°„ì„ ì¹œêµ¬ë“¤ì—ê²Œ ì•Œë ¤ì¤˜ìš”'] },
            'ì±™ê¹€ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì˜¤ëŠ” ì±™ê¹€ì´', desc: ['ëª¨ë‘ ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì™€ìš”', '4êµì‹œê¹Œì§€ ì•Œë¦¼ìž¥ì„ ì“¸ ìˆ˜ ìžˆê²Œ ë„ì™€ì¤˜ìš”'] },
            'ê¹”ë”ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì •ë¦¬í•˜ëŠ” ê¹”ë”ì´!', desc: ['í’€ê³¼ ê°€ìœ„ë¥¼ ì •ë¦¬í•´ìš”', 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì œìžë¦¬ì— ë‚˜ë‘¬ìš”'] }
        };

        const RoleHelpModal = ({ isOpen, onClose, roleDescriptions }) => {
            if (!isOpen) return null;
            const descriptions = roleDescriptions || DEFAULT_ROLE_DESCRIPTIONS;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ì„¤ëª…" icon={PATHS.help}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {Object.entries(descriptions).map(([role, info]) => (
                            <div key={role} className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-2 mb-2"><span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold">{role}</span><h4 className="font-bold text-slate-700 text-sm">{info.title}</h4></div>
                                <ul className="list-disc pl-4 space-y-1">{info.desc.map((d, i) => (<li key={i} className="text-xs text-slate-600">{d}</li>))}</ul>
                            </div>
                        ))}
                    </div>
                </BaseModal>
            );
        };

        const GroupOverlay = ({ groups, avoidancePairs, isVisible, focusedGroupIdx }) => {
            const [lines, setLines] = useState([]);
            
            useEffect(() => {
                const shouldShow = isVisible || focusedGroupIdx !== null;
                if (!shouldShow) { setLines([]); return; }
                
                const updateLines = () => {
                    const newLines = [];
                    const container = document.getElementById('groups-container');
                    if (!container) return;
                    const containerRect = container.getBoundingClientRect();

                    let targetPairs = avoidancePairs;
                    if (focusedGroupIdx !== null && groups[focusedGroupIdx]) {
                        const memberNames = new Set(groups[focusedGroupIdx].map(s => s.name));
                        targetPairs = avoidancePairs.filter(p => memberNames.has(p.p1) || memberNames.has(p.p2));
                    }

                    targetPairs.forEach(pair => {
                        const el1 = document.querySelector(`[data-student-name="${pair.p1}"]`);
                        const el2 = document.querySelector(`[data-student-name="${pair.p2}"]`);
                        
                        if (el1 && el2) {
                            const r1 = el1.getBoundingClientRect();
                            const r2 = el2.getBoundingClientRect();
                            const x1 = r1.left + r1.width / 2 - containerRect.left;
                            const y1 = r1.top + r1.height / 2 - containerRect.top;
                            const x2 = r2.left + r2.width / 2 - containerRect.left;
                            const y2 = r2.top + r2.height / 2 - containerRect.top;
                            newLines.push({ x1, y1, x2, y2, id: pair.id });
                        }
                    });
                    setLines(newLines);
                };

                updateLines();
                window.addEventListener('resize', updateLines);
                const timer = setTimeout(updateLines, 500); 
                return () => { window.removeEventListener('resize', updateLines); clearTimeout(timer); };
            }, [groups, avoidancePairs, isVisible, focusedGroupIdx]);

            if (!isVisible && focusedGroupIdx === null) return null;
            return (
                <svg className="absolute inset-0 w-full h-full pointer-events-none z-50" style={{ overflow: 'visible' }}>
                    {lines.map(line => <line key={line.id} x1={line.x1} y1={line.y1} x2={line.x2} y2={line.y2} stroke="#ef4444" strokeWidth="2" strokeDasharray="5,5" opacity="0.6" />)}
                </svg>
            );
        };

        const RadarChart = ({ data }) => {
            const tags = Object.entries(data).filter(([_, stat]) => stat.cDone > 0).map(([tag]) => tag);
            if (tags.length < 3) return <div className="text-center text-xs text-slate-400 py-8 bg-slate-50 rounded-xl border border-slate-100 border-dashed">ë°©ì‚¬í˜• ì°¨íŠ¸ëŠ” ê³¼ëª©ì´ 3ê°œ ì´ìƒì¼ ë•Œ í‘œì‹œë©ë‹ˆë‹¤.<br/>(í˜„ìž¬ {tags.length}ê°œ)</div>;

            const size = 220;
            const center = size / 2;
            const radius = 70;
            const angleStep = (Math.PI * 2) / tags.length;

            const getCoordinates = (value, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const r = (value / 100) * radius;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                return [x, y];
            };

            const studentPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            const classPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.cTotal > 0 ? (stat.cDone / stat.cTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            return (
                <div className="flex flex-col items-center py-2">
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible">
                        {[20, 40, 60, 80, 100].map((level, idx) => (
                            <polygon key={idx} points={tags.map((_, i) => getCoordinates(level, i).join(',')).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 2" />
                        ))}
                        {tags.map((tag, i) => {
                            const [lx, ly] = getCoordinates(100, i);
                            const [tx, ty] = getCoordinates(120, i);
                            return (
                                <g key={i}>
                                    <line x1={center} y1={center} x2={lx} y2={ly} stroke="#e2e8f0" strokeWidth="1" />
                                    <text x={tx} y={ty} textAnchor="middle" dominantBaseline="middle" fontSize="10" fill="#64748b" className="font-bold">{tag}</text>
                                </g>
                            );
                        })}
                        <polygon points={classPoints} fill="rgba(148, 163, 184, 0.3)" stroke="#94a3b8" strokeWidth="2" />
                        <polygon points={studentPoints} fill="rgba(99, 102, 241, 0.3)" stroke="#6366f1" strokeWidth="4" />
                        {tags.map((tag, i) => {
                             const stat = data[tag];
                             const sRate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                             const [sx, sy] = getCoordinates(sRate, i);
                             return <circle key={`s-${i}`} cx={sx} cy={sy} r="3" fill="#6366f1" />;
                        })}
                    </svg>
                    <div className="flex gap-4 mt-2 text-[10px]">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-indigo-500"></div><span className="text-slate-600 font-bold">ë‚˜</span></div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-slate-400"></div><span className="text-slate-400 font-bold">í•™ê¸‰ í‰ê· </span></div>
                    </div>
                </div>
            );
        };

        const GRASS_THEMES = {
            indigo: { bg: 'bg-indigo-50', border: 'border-indigo-400', ring: 'ring-indigo-300', text: 'text-indigo-700', dot: 'bg-indigo-500' },
            rose: { bg: 'bg-rose-50', border: 'border-rose-400', ring: 'ring-rose-300', text: 'text-rose-700', dot: 'bg-rose-500' },
            blue: { bg: 'bg-blue-50', border: 'border-blue-400', ring: 'ring-blue-300', text: 'text-blue-700', dot: 'bg-blue-500' },
            green: { bg: 'bg-green-50', border: 'border-green-400', ring: 'ring-green-300', text: 'text-green-700', dot: 'bg-green-500' },
            amber: { bg: 'bg-amber-50', border: 'border-amber-400', ring: 'ring-amber-300', text: 'text-amber-700', dot: 'bg-amber-500' },
            purple: { bg: 'bg-purple-50', border: 'border-purple-400', ring: 'ring-purple-300', text: 'text-purple-700', dot: 'bg-purple-500' },
            slate: { bg: 'bg-slate-100', border: 'border-slate-400', ring: 'ring-slate-300', text: 'text-slate-700', dot: 'bg-slate-500' },
        };

        const CounselingAIModal = ({ isOpen, onClose, student, students, apiKey, showToast, onSave, notes }) => {
            const [advice, setAdvice] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [consultationTopic, setConsultationTopic] = useState("");
            const [showPromptSettings, setShowPromptSettings] = useState(false);
            const [promptTemplate, setPromptTemplate] = useState("");

            const DEFAULT_COUNSELING_TEMPLATE = `ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ìž ì‹¬ë¦¬ ìƒë‹´ê°€ìž…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒì— ëŒ€í•œ ìƒë‹´ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: (ìµëª…)
- ìµœê·¼ ê´€ì°° ê¸°ë¡:
{{records}}

[ìƒë‹´ ì£¼ì œ]
{{topic}}

[ìš”ì²­ ì‚¬í•­]
1. í•™ìƒì˜ ìƒí™©ì„ ê³µê°í•˜ê³  ì´í•´í•˜ëŠ” íƒœë„ë¡œ ìž‘ì„±í•˜ì„¸ìš”.
2. êµì‚¬ê°€ í•™ìƒì—ê²Œ í•´ì¤„ ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ ì¡°ì–¸ì´ë‚˜ ì§€ë„ ë°©ë²•ì„ 3ê°€ì§€ ì •ë„ ì œì‹œí•˜ì„¸ìš”.
3. í•™ë¶€ëª¨ë‹˜ê³¼ ìƒë‹´í•  ë•Œ í™œìš©í•  ìˆ˜ ìžˆëŠ” íŒë„ í•œ ë¬¸ìž¥ ë§ë¶™ì—¬ì£¼ì„¸ìš”.
4. ë§íˆ¬ëŠ” ì •ì¤‘í•˜ê³  ë¶€ë“œëŸ½ê²Œ í•´ì£¼ì„¸ìš”.`;

            if (!isOpen) return null;

            useEffect(() => {
                const saved = localStorage.getItem('cls_ai_prompt_counseling');
                setPromptTemplate(saved || DEFAULT_COUNSELING_TEMPLATE);
            }, []);

            const handleGenerate = async () => {
                if (!consultationTopic.trim()) return showToast("ìƒë‹´ ì£¼ì œë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsGenerating(true);
                try {
                    const recentNotes = notes.slice(0, 5).map(n => `[${n.date}] ${n.content}`).join('\n');
                    let safeNotes = recentNotes;
                    let safeTopic = consultationTopic;

                    // [ë³´ì•ˆ] ëŒ€ìƒ í•™ìƒ ìµëª…í™”
                    if (typeof anonymizeText === 'function') {
                        safeNotes = anonymizeText(safeNotes, student.name);
                        safeTopic = anonymizeText(safeTopic, student.name);
                    }

                    // [ë³´ì•ˆ] ë‹¤ë¥¸ í•™ìƒë“¤ ìµëª…í™” (ê¸‰ìš°)
                    if (students && Array.isArray(students)) {
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotes = safeNotes.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotes = safeNotes.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                                safeTopic = safeTopic.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeTopic = safeTopic.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                    }
                    
                    let prompt = promptTemplate || DEFAULT_COUNSELING_TEMPLATE;
                    prompt = prompt.replace('{{records}}', safeNotes || "ê¸°ë¡ ì—†ìŒ");
                    prompt = prompt.replace('{{topic}}', safeTopic);

                    const response = await callGemini(apiKey, prompt);
                    setAdvice(response);
                } catch (e) {
                    showToast("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleSavePrompt = () => {
                localStorage.setItem('cls_ai_prompt_counseling', promptTemplate);
                showToast("í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setShowPromptSettings(false);
            };

            const handleResetPrompt = () => {
                setPromptTemplate(DEFAULT_COUNSELING_TEMPLATE);
                localStorage.removeItem('cls_ai_prompt_counseling');
                showToast("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ¤– AI ì€ìƒ˜ì´ ìƒë‹´ì†Œ" icon={PATHS.heart}>
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">ðŸ’¡ ì„ ìƒë‹˜ì„ ìœ„í•œ AI ìƒë‹´ ì¡°ì–¸</p>
                            <p className="text-xs opacity-80">í•™ìƒì˜ í‰ì†Œ ê¸°ë¡ê³¼ ì„ ìƒë‹˜ì˜ ê³ ë¯¼ì„ ë°”íƒ•ìœ¼ë¡œ<br/>AIê°€ ë§žì¶¤í˜• ì§€ë„ ë°©ë²•ê³¼ ìƒë‹´ íŒì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">ìƒë‹´í•˜ê³  ì‹¶ì€ ë‚´ìš© (ê³ ë¯¼)</label>
                            <textarea className="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none focus:border-rose-500 resize-none h-24" placeholder="ì˜ˆ: ì¹œêµ¬ë“¤ê³¼ ìžì£¼ ë‹¤íˆ¬ëŠ”ë° ì–´ë–»ê²Œ ì§€ë„í•˜ë©´ ì¢‹ì„ê¹Œìš”? / ìˆ˜ì—… ì‹œê°„ì— ì§‘ì¤‘ì„ ìž˜ ëª»í•´ìš”." value={consultationTopic} onChange={(e) => setConsultationTopic(e.target.value)} />
                        </div>
                        
                        <div className="border-t border-slate-100 pt-2">
                            <button onClick={() => setShowPromptSettings(!showPromptSettings)} className="text-xs font-bold text-slate-400 flex items-center gap-1 hover:text-slate-600 transition-colors mb-2">
                                <Icon d={PATHS.settings} size={12} /> í”„ë¡¬í”„íŠ¸ ì„¤ì • {showPromptSettings ? 'ì ‘ê¸°' : 'ì—´ê¸°'}
                            </button>
                            {showPromptSettings && (
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fade-in space-y-2">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
    <p className="text-[10px] text-slate-500 font-bold">í”„ë¡¬í”„íŠ¸ ë³€ìˆ˜ ê°€ì´ë“œ (ìžë™ ìµëª…í™”ë¨)</p>
    <select 
        className="text-xs border border-indigo-200 rounded-lg px-2 py-1.5 bg-white text-indigo-700 font-bold focus:outline-none cursor-pointer hover:bg-indigo-50 transition-colors shadow-sm"
        onChange={(e) => {
            const val = e.target.value;
            
            // ðŸŒ± 1. ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë³µêµ¬
            if (val === "default") {
                setPromptTemplate("ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ìž ì‹¬ë¦¬ ìƒë‹´ê°€ìž…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒì— ëŒ€í•œ ìƒë‹´ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.\n\n[í•™ìƒ ì •ë³´]\n- ì´ë¦„: (ìµëª…)\n- ìµœê·¼ ê´€ì°° ê¸°ë¡:\n{{records}}\n\n[ìƒë‹´ ì£¼ì œ]\n{{topic}}\n\n[ìš”ì²­ ì‚¬í•­]\n1. í•™ìƒì˜ ìƒí™©ì„ ê¹Šì´ ê³µê°í•˜ê³  ì‹¬ë¦¬ì  ì›ì¸ì„ ë¶„ì„í•˜ì„¸ìš”.\n2. êµì‚¬ê°€ êµì‹¤ì—ì„œ ë°”ë¡œ ì ìš©í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ ì§€ë„ ë°©ë²•ì„ 3ê°€ì§€ ì œì‹œí•˜ì„¸ìš”.\n3. í•™ë¶€ëª¨ ìƒë‹´ ì‹œ í™œìš©í•  ìˆ˜ ìžˆëŠ” ë”°ëœ»í•œ ì¡°ì–¸ ë©˜íŠ¸ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.");
                if(typeof showToast !== 'undefined') showToast("ðŸŒ± ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } 
            
            // ==========================================
            // ðŸ”¬ ê·¸ë£¹ 1: í•™ë¬¸ì  ì‹¬ì¸µ í”„ë ˆìž„ì›Œí¬ (ì›ì¸/ë¶„ì„ ì¤‘ì‹¬)
            // ==========================================
            else if (val === "behavior_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì•„ë™ í–‰ë™ ì‹¬ë¦¬ ì „ë¬¸ê°€ì´ìž ì‘ìš©í–‰ë™ë¶„ì„(ABA)ì˜ ê¶Œìœ„ìžìž…ë‹ˆë‹¤.\n- ì–´ì¡°: ê°ê´€ì , ë¶„ì„ì , ë‹¨í˜¸í•˜ë˜ í•™ìƒì„ í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë”°ëœ»í•¨.\n- ê¸ˆì§€ì‚¬í•­: \"ì‚¬ëž‘ìœ¼ë¡œ ê°ì‹¸ì£¼ì„¸ìš”\" ê°™ì€ ì¶”ìƒì ì´ê³  ë»”í•œ ì¡°ì–¸ ì ˆëŒ€ ê¸ˆì§€.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ í–‰ë™ ì¤‘ìž¬ ê³„íš(BIP)ì„ ìˆ˜ë¦½í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ABC í–‰ë™ ê¸°ëŠ¥ ë¶„ì„**: A(ì„ í–‰ì‚¬ê±´)-B(ë¬¸ì œí–‰ë™)-C(ìˆ¨ì€ ëª©ì ) ì •ë°€ ë¶„ì„\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: ìš°ìˆ˜ì‚¬ë¡€ë‚˜ ì €ëª…í•œ ì‹¬ë¦¬ ì „ë¬¸ê°€ì˜ ì‹¤ì œ ê·¹ë³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **3ë‹¨ê³„ êµì‹¤ ì¤‘ìž¬ ì „ëžµ(ì‹¤ì²œë²•)**: [ì˜ˆë°©]-[ëŒ€ì²´ í–‰ë™ êµìˆ˜]-[ë°˜ì‘(15ì´ˆ ëŒ€ì²˜ë²•)]\n4. **í•™ë¶€ëª¨ ìƒë‹´ ì‹œë‚˜ë¦¬ì˜¤**: ì¼ê´€ëœ í›ˆìœ¡ì„ ëŒì–´ë‚´ê¸° ìœ„í•œ êµ¬ì²´ì  í˜‘ì¡° ìš”ì²­ ë©˜íŠ¸");
                if(typeof showToast !== 'undefined') showToast("ðŸ”¬ í–‰ë™ êµì •(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "social_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ í•™ê¸‰ ê¸ì • í›ˆìœ¡(PDC) ë° ë¹„í­ë ¥ ëŒ€í™”(NVC) ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: \"ì¹œí•˜ê²Œ ì§€ë‚´ë¼\" ìˆ˜ì¤€ì˜ 1ì°¨ì›ì  ì¡°ì–¸ ê¸ˆì§€.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë˜ëž˜ ì—­í•™ì„ ì‹¬ì¸µ ë¶„ì„í•˜ê³  ê´€ê³„ íšŒë³µ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë˜ëž˜ ì—­í•™(Sociogram) ì¶”ë¡  ë¶„ì„**: ì‚¬íšŒì  ê¸°ìˆ  ê²°í• ìš”ì†Œ(ì¶©ë™ì„±, ëˆˆì¹˜ ë“±) ì •ë°€ ë¶„ì„\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: í•™êµ í­ë ¥/ê°ˆë“± ì¤‘ìž¬ ì„±ê³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **í•™ê¸‰ ìš´ì˜(í™˜ê²½) ê°œìž…ë²•**: ìžì—°ìŠ¤ëŸ½ê²Œ ì†Œì†ê°ì„ ë¶€ì—¬í•  ìˆ˜ ìžˆëŠ” í•™ê¸‰ ì—­í• /ì§ í™œë™ ì•„ì´ë””ì–´\n4. **1:1 ë¹„í­ë ¥ ëŒ€í™”(NVC) ìŠ¤í¬ë¦½íŠ¸**: í•™ìƒì˜ ë°©ì–´ê¸°ì œë¥¼ ë‚®ì¶”ëŠ” ê´€ì°°-ëŠë‚Œ-ìš•êµ¬-ë¶€íƒì˜ ëŒ€í™” ëŒ€ë³¸\n5. **ê°ˆë“± ì¦‰ê° ê°œìž… ë©˜íŠ¸**: ë‹¤íˆ¼ ë°œìƒ ì¦‰ì‹œ êµì‚¬ê°€ ì–‘ì¸¡ì— ë˜ì§ˆ ì¤‘ë¦½ì  ì²« ë¬¸ìž¥");
                if(typeof showToast !== 'undefined') showToast("ðŸ”¬ êµìš° ê´€ê³„(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "study_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ê¸°ë°˜ í•™ìŠµ ì½”ì¹­ ë° ë©”íƒ€ì¸ì§€ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ëˆ„êµ¬ë‚˜ ì•„ëŠ” ì¼ë°˜ë¡ ì  ì¹­ì°¬ ê¸ˆì§€.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ 'í•™ìŠµëœ ë¬´ê¸°ë ¥'ì˜ ì›ì¸ì„ í•´ë¶€í•˜ëŠ” ì²˜ë°©ì „ì„ ìž‘ì„±í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë¬´ê¸°ë ¥ì˜ ì›ì¸ í•´ë¶€**: ê¸°ì´ˆ ê²°ì†(Can't)ì¸ì§€ ë™ê¸° ë¶€ì¡±(Won't)ì¸ì§€ ëª…í™•ížˆ ì§„ë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: í•™ìŠµ ë¶€ì§„ ê·¹ë³µì˜ ì‹¤ì œ ë™ê¸° íšŒë³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ë§ˆì´í¬ë¡œ í•´ë¹—(Micro-habit) ì„¤ê³„**: í•˜ë£¨ 5ë¶„ ë‹¨ìœ„ì˜ 100% ì„±ê³µ ë³´ìž¥ ì´ˆë¯¸ì„¸ í•™ìŠµ ë£¨í‹´\n4. **ë©”íƒ€ì¸ì§€ ìžê·¹ ìŠ¤í¬ë¦½íŠ¸**: ì•„ì´ê°€ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹«ê²Œ ë§Œë“œëŠ” êµì‚¬ì˜ 'ì§ˆë¬¸í˜• ëŒ€ë³¸' 3ê°€ì§€\n5. **í•™ë¶€ëª¨ ì—°ê³„ ì½”ì¹­**: ê²°ê³¼ ëŒ€ì‹  ê³¼ì •ì„ ì¹­ì°¬í•˜ê²Œ ìœ ë„í•˜ëŠ” ìƒë‹´ ë©˜íŠ¸");
                if(typeof showToast !== 'undefined') showToast("ðŸ”¬ í•™ìŠµ ë¬´ê¸°ë ¥(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "emotion_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì¡´ ê°€íŠ¸ë§¨ ê°ì • ì½”ì¹­ ì´ë¡ ê³¼ ë‡Œê³¼í•™ ê¸°ë°˜ íŠ¸ë¼ìš°ë§ˆ/ìœ„ê¸° ê°œìž… ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: \"ë§ˆìŒì„ ì½ì–´ì£¼ì„¸ìš”\"ë¡œ ëë‚˜ëŠ” ì¡°ì–¸ ê¸ˆì§€.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì¢…í•©í•˜ì—¬ ê³ ë°˜ì‘ì„± í•™ìƒì˜ ê°ì • ì‹œìŠ¤í…œì„ ë¶„ì„í•˜ê³  ì•ˆì „ ëŒ€ì²˜ ë§¤ë‰´ì–¼ì„ ì œì‹œí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê°ì •ì˜ ë‡Œê³¼í•™ì  ë¶„ì„**: íˆ¬ìŸ-ë„í”¼ ë°˜ì‘ ìœ ë°œ ìš”ì¸ ë° ë¹™ì‚° ì•„ëž˜ í•µì‹¬ ê°ì •(ìˆ˜ì¹˜ì‹¬, ë¶ˆì•ˆ ë“±) ì§„ë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: ì†Œì•„ì •ì‹ ì˜í•™íšŒ ë°œì·Œ ë“± í…íŠ¸ëŸ¼(Tantrum) ëŒ€ì²˜ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ìœ„ê¸° ê°œìž… ìŠ¤í¬ë¦½íŠ¸(ê°€íŠ¸ë§¨ 5ë‹¨ê³„)**: ê°ì • í­ë°œ ì‹œ 3ë¶„ ê³¨ë“ íƒ€ìž„ ë‚´ì— ë˜ì ¸ì•¼ í•  ëŒ€ì‚¬ì™€ í–‰ë™ ì§€ì¹¨\n4. **í‰ìƒì‹œ ê°ì • ê·¸ë¦‡ ë„“ížˆê¸°**: ì•„ì´ ìŠ¤ìŠ¤ë¡œ ê°ì •ì„ ì‹œê°í™”í•˜ê³  ì¿¨ë‹¤ìš´í•˜ëŠ” ì „ëžµ\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ë¶€ëª¨ë¥¼ ì§€ì§€í•˜ê³  ì¼ê´€ëœ ê°ì • ì½”ì¹­ì„ ê¶Œìœ í•˜ëŠ” ë©”ì‹œì§€");
                if(typeof showToast !== 'undefined') showToast("ðŸ”¬ ê°ì • ì¡°ì ˆ(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            }

            // ==========================================
            // ðŸ› ï¸ ê·¸ë£¹ 2: êµì‹¤ ì‹¤ì²œ ë„êµ¬ í”„ë ˆìž„ì›Œí¬ (ë¬¼ë¦¬ì /í™˜ê²½ ì„¸íŒ… ì¤‘ì‹¬)
            // ==========================================
            else if (val === "behavior_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì•„ë™ í–‰ë™ ì‹¬ë¦¬ ì „ë¬¸ê°€ì´ìž í•™êµì°¨ì›ì˜ ê¸ì •ì  í–‰ë™ì§€ì›(SWPBS) ì‹¤ë¬´ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ì¶”ìƒì  ì¡°ì–¸ ì ˆëŒ€ ê¸ˆì§€. êµì‹¤ì—ì„œ ëˆˆì— ë³´ì´ëŠ” ë¬¼ë¦¬ì  ìˆ˜ë‹¨ì„ ì œì‹œí•  ê²ƒ.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¹ìž¥ ë‚´ì¼ ì ìš©í•  êµì‹¤ í™˜ê²½ ì„¸íŒ…ê³¼ ì‹¤ì²œ ë„êµ¬ë¥¼ ì œì‹œí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ABC í–‰ë™ ë¶„ì„**: A(ì„ í–‰ì‚¬ê±´)-B(ë¬¸ì œí–‰ë™)-C(ìˆ¨ì€ ëª©ì ) í•µì‹¬ ìš”ì•½\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜: OOìžë£Œ] ëª…ì‹œ, ì§€ì–´ë‚´ê¸° ê¸ˆì§€)\n3. **ðŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì‹œê°ì  ì‹œê°„í‘œ, í† í° ì´ì½”ë…¸ë¯¸(ë³´ìƒíŒ), ë¹„ë°€ í–‰ë™ ê³„ì•½ì„œ, íŠ¹ì • ìžë¦¬ ë°°ì¹˜ íŒ ë“± ë‚´ì¼ ë‹¹ìž¥ ì„¸íŒ…í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ í™˜ê²½/ë¬¼ë¦¬ì  ë„êµ¬ì™€ í™œìš©ë²•\n4. **ìœ„ê¸° ê°œìž… ìŠ¤í¬ë¦½íŠ¸**: í–‰ë™ ë°œìƒ ì¦‰ì‹œì˜ ë‹¨í˜¸í•œ 15ì´ˆ ê°œìž… ëŒ€ì‚¬\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ë„êµ¬ í™œìš©ì— ëŒ€í•œ ê°€ì •í†µì‹  ì•ˆë‚´");
                if(typeof showToast !== 'undefined') showToast("ðŸ› ï¸ í–‰ë™ êµì •(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "social_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ í•™ê¸‰ ê¸ì • í›ˆìœ¡(PDC) ì‹¤ì²œê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: 1ì°¨ì›ì  í›ˆí™” ë§ì”€ ê¸ˆì§€. êµ¬ì²´ì ì¸ êµì‹¤ ë‚´ í•™ê¸‰ í™œë™(Activity)ì„ ì œì‹œí•  ê²ƒ.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê´€ê³„ íšŒë³µì„ ìœ„í•œ êµì‹¤ ë‚´ í™œë™ ë„êµ¬ì™€ ë£¨í‹´ì„ ì„¤ê³„í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê²°í• ê¸°ìˆ  ë¶„ì„**: í•™ìƒì˜ ì‚¬íšŒì  ê¸°ìˆ  ë¶€ì¡± ë¶€ë¶„ íŒŒì•…\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ðŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬/í™œë™ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì˜ë¯¸ ìžˆëŠ” 1ì¸ 1ì—­(ì—­í•  ì„¸ë¶€ ì„¤ê³„), í•™ê¸‰ íšŒì˜ ì•ˆê±´ í™œìš©ë²•, ë˜ëž˜ ë©˜í† ë§, ê²©ë ¤ ì„œí´ ë“± ìžì—°ìŠ¤ëŸ½ê²Œ ë¬´ë¦¬ì— ì„žì´ê²Œ í•˜ëŠ” êµì‹¤ í™œë™ ë§¤ë‰´ì–¼\n4. **NVC ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸**: ì§§ê³  íš¨ê³¼ì ì¸ 1:1 êµì‚¬ ë°œë¬¸\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ì‚¬íšŒì„± ê´€ë ¨ ê°€ì • ë‚´ ë¯¸ì…˜ ì•ˆë‚´");
                if(typeof showToast !== 'undefined') showToast("ðŸ› ï¸ êµìš° ê´€ê³„(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "study_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ë³´íŽ¸ì  í•™ìŠµì„¤ê³„(UDL) ë° êµë³´ìž¬ í™œìš© ì‹¤ë¬´ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ë»”í•œ ë™ê¸°ë¶€ì—¬ ëª…ì–¸ ê¸ˆì§€. ì†ì— ìž¡ížˆëŠ” í•™ìŠµ ë³´ì¡° ìž¥ì¹˜ë¥¼ ì œì‹œí•  ê²ƒ.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ ë¬´ê¸°ë ¥ì„ ê·¹ë³µí•  êµì‹¤ ë‚´ í•™ìŠµ ë³´ì¡° ë„êµ¬ì™€ ë¬¼ë¦¬ì  í™˜ê²½ì„ ì„¤ê³„í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë¬´ê¸°ë ¥ ì§„ë‹¨**: ê¸°ì´ˆ ê²°ì† vs ë™ê¸° ë¶€ì¡± íŒë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ðŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì‹œê°ì  íƒ€ì´ë¨¸(ë½€ëª¨ë„ë¡œ), ìŠ¤ìºí´ë”©(ë‚œì´ë„ ì¡°ì ˆ í•™ìŠµì§€) ì œìž‘ íŒ, ì‹œê°ì  ë‹¨ì„œ ì¹´ë“œ ì„¸íŒ…, ë§ˆì´í¬ë¡œ í•´ë¹— ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤í‹°ì»¤ ë“± êµì‚¬ê°€ ì§ê´€ì ìœ¼ë¡œ ì œê³µí•  ë³´ì¡° ë„êµ¬\n4. **ë©”íƒ€ì¸ì§€ ë°œë¬¸**: í•™ìŠµ ì ê²€ìš© ì§ˆë¬¸ ëŒ€ë³¸\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ê°€ì • í•™ìŠµ ì„¸íŒ… ê°€ì´ë“œ");
                if(typeof showToast !== 'undefined') showToast("ðŸ› ï¸ í•™ìŠµ ë¬´ê¸°ë ¥(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "emotion_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ íŠ¸ë¼ìš°ë§ˆ ê¸°ë°˜ êµì‹¤ í™˜ê²½(Trauma-Informed Classroom) ì„¸íŒ… ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ì¶”ìƒì ì¸ ê³µê° ì¡°ì–¸ ê¸ˆì§€. êµì‹¤ì˜ ê³µê°„ê³¼ ë¬¼í’ˆì„ í™œìš©í•œ ë°©ë²• ì œì‹œ.\n\n# ìž„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì¢…í•©í•˜ì—¬ í•™ìƒì˜ ê°ì •ì„ ì•ˆì „í•˜ê²Œ ìˆ˜ìš©í•  ìˆ˜ ìžˆëŠ” êµì‹¤ í™˜ê²½ ë° ë¬¼ë¦¬ì  ë„êµ¬ ì„¸íŒ… ë§¤ë‰´ì–¼ì„ ìž‘ì„±í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê°ì • ë°˜ì‘ ì§„ë‹¨**: íˆ¬ìŸ-ë„í”¼ ìœ ë°œ íŠ¸ë¦¬ê±° íŒŒì•…\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ðŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: í‰í™” êµ¬ì—­(Calming Corner)ì˜ êµ¬ì²´ì  ìœ„ì¹˜ì™€ ë¹„ì¹˜í•  ë¬¼í’ˆ(ì˜ˆ: ìŠ¤íŠ¸ë ˆìŠ¤ ë³¼, í˜¸í¡ ì¹´ë“œ), ì±…ìƒ ìœ„ ê°ì • ì‹ í˜¸ë“±/ì˜¨ë„ê³„ ì„¸íŒ…, ì¿¨ë‹¤ìš´ íƒ€ìž„(Time-In) ë§¤ë‰´ì–¼ ë“±\n4. **ìœ„ê¸° ê°œìž… ìŠ¤í¬ë¦½íŠ¸**: ëŒë°œ í–‰ë™ ì‹œ ë¬¼ë¦¬ì /ì–¸ì–´ì  ëŒ€ì²˜ ì§€ì¹¨\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ê°€ì • ë‚´ ê°ì • ì¡°ì ˆ ê³µê°„ ì„¸íŒ… íŒ");
                if(typeof showToast !== 'undefined') showToast("ðŸ› ï¸ ê°ì • ì¡°ì ˆ(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            }

            e.target.value = ""; 
        }}
    >
        <option value="">ðŸ’¡ ì¶”ì²œ í…œí”Œë¦¿ ì„ íƒ...</option>
        <option value="default">ðŸŒ± ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ì›ëž˜ëŒ€ë¡œ)</option>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
        <optgroup label="ðŸ”¬ í•™ë¬¸ì  ì‹¬ì¸µ ë¶„ì„ (ì´ë¡ /ì›ì¸ íŒŒì•…)">
            <option value="behavior_aca">ðŸš¨ í–‰ë™ êµì • (ABC ì›ì¸ë¶„ì„)</option>
            <option value="social_aca">ðŸ¤ êµìš° ê´€ê³„ (ë˜ëž˜ì—­í•™ ì¶”ë¡ )</option>
            <option value="study_aca">ðŸ“š í•™ìŠµ ë¬´ê¸°ë ¥ (ë¬´ê¸°ë ¥ í•´ë¶€)</option>
            <option value="emotion_aca">â˜” ê°ì • ì¡°ì ˆ (ë‡Œê³¼í•™ì  ë¶„ì„)</option>
        </optgroup>
        <optgroup label="ðŸ› ï¸ êµì‹¤ ì‹¤ì²œ ë„êµ¬ (ì‹¤ë¬´/í™˜ê²½ ì„¸íŒ…)">
            <option value="behavior_prac">ðŸš¨ í–‰ë™ êµì • (êµì‹¤í™˜ê²½/ë„êµ¬ì„¸íŒ…)</option>
            <option value="social_prac">ðŸ¤ êµìš° ê´€ê³„ (í•™ê¸‰í™œë™/ë£¨í‹´ì„¤ê³„)</option>
            <option value="study_prac">ðŸ“š í•™ìŠµ ë¬´ê¸°ë ¥ (í•™ìŠµë³´ì¡°/ì‹œê°í™”)</option>
            <option value="emotion_prac">â˜” ê°ì • ì¡°ì ˆ (ì•ˆì •í™”êµ¬ì—­/êµë³´ìž¬)</option>
        </optgroup>
    </select>
</div>
                                    <div className="grid grid-cols-2 gap-2 text-[10px] text-slate-600 bg-white p-2 rounded border border-slate-100">
                                        <div><code>{`{{records}}`}</code> : ê´€ì°° ê¸°ë¡</div>
                                        <div><code>{`{{topic}}`}</code> : ìƒë‹´ ì£¼ì œ</div>
                                    </div>
                                    <textarea value={promptTemplate} onChange={(e) => setPromptTemplate(e.target.value)} className="w-full h-40 p-2 border border-slate-300 rounded-lg text-xs font-mono outline-none focus:border-indigo-500 resize-none custom-scroll" />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={handleResetPrompt} className="px-3 py-1.5 bg-white border border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-50">ì´ˆê¸°í™”</button>
                                        <button onClick={handleSavePrompt} className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">ì €ìž¥</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <Btn onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md flex items-center justify-center gap-2">
                            {isGenerating ? <><Icon d={PATHS.spinner} className="animate-spin"/> ê³ ë¯¼í•˜ëŠ” ì¤‘...</> : <><Icon d={PATHS.magic}/> ì¡°ì–¸ êµ¬í•˜ê¸°</>}
                        </Btn>
                        {advice && (
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                                <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><Icon d={PATHS.bot} className="text-rose-500"/> AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸</h4>
                                <div className="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap max-h-60 overflow-y-auto custom-scroll p-2 bg-slate-50 rounded-lg">{advice}</div>
                                <div className="flex justify-end gap-2 mt-3">
                                    <Btn onClick={() => { navigator.clipboard.writeText(advice); showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50">ë³µì‚¬</Btn>
                                    <Btn onClick={() => { onSave(advice); onClose(); }} className="px-3 py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold hover:bg-rose-200">ê¸°ë¡ì— ì €ìž¥</Btn>
                                </div>
                            </div>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const StatsGrassModal = ({ isOpen, onClose, student, students, records, dates, dailyTasks, onSaveCounseling, onSaveStickers, onSaveStickerWithNote, showToast, openConfirm, appConfig, apiKey, onSaveRecordDraft, isLocalMode, db, appId, setStudents, saveData, isPortfolioMode, onSwitchStudent }) => {
            if (!isOpen || !student || !student.history) return null;
            useEffect(() => {
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                };
            }, [onClose]);

            const [notes, setNotes] = useState([]);
            const [stickerCount, setStickerCount] = useState(student.stickers || 0);
            const [selectedDate, setSelectedDate] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [showSearchCal, setShowSearchCal] = useState(false);
            const [calMonth, setCalMonth] = useState(dayjs());
            const recordDates = Array.from(new Set(notes.map(n => n.date))); // ê¸°ë¡ì´ ìžˆëŠ” ë‚ ì§œë§Œ ì™ì™ ë½‘ê¸°
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editNoteContent, setEditNoteContent] = useState("");
            const [editRelatedStudents, setEditRelatedStudents] = useState([]);
            const [editSearchText, setEditSearchText] = useState("");
            const [showEditStudentDropdown, setShowEditStudentDropdown] = useState(false);
            const [aiComment, setAiComment] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [showReportEdit, setShowReportEdit] = useState(false);
            const [reportStart, setReportStart] = useState(dayjs().subtract(1, 'month').format('YYYY-MM-DD'));
            const [reportEnd, setReportEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [tempComment, setTempComment] = useState("");
            const [reportTone, setReportTone] = useState('warm');
            const [reportFont, setReportFont] = useState('sans');
            const [reportFocus, setReportFocus] = useState('comprehensive');
            const [reportPurpose, setReportPurpose] = useState('regular');
            const [showCounselingAI, setShowCounselingAI] = useState(false);
            const [reportStats, setReportStats] = useState({ studentRate: 0, classRate: 0, tagStats: {} });
            const [animatedWidths, setAnimatedWidths] = useState({ student: 0, class: 0 });
            const [showDetailStats, setShowDetailStats] = useState(false);
            const [showStudentRecordAI, setShowStudentRecordAI] = useState(false);
            const modalRef = useRef(null);
            const reportRef = useRef(null);
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_report_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const [chartType, setChartType] = useState('bar');
            const [grassStart, setGrassStart] = useState(dayjs().startOf('month').format('YYYY-MM-DD'));
            const [grassEnd, setGrassEnd] = useState(dayjs().endOf('month').format('YYYY-MM-DD'));
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [stickerEffect, setStickerEffect] = useState(false);
            const [showButtonEffect, setShowButtonEffect] = useState(false);
            const [keepContent, setKeepContent] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);
            const [isGrassExpanded, setIsGrassExpanded] = useState(false); // [ì¶”ê°€ë¨] í™œë™ ìž”ë”” ì ‘ê³  íŽ´ê¸° ìƒíƒœ
            const [selectedGrassDate, setSelectedGrassDate] = useState(null);
            const [expandedDates, setExpandedDates] = useState({});
            const [dateRangeAnim, setDateRangeAnim] = useState(false);
            const [cachedDetailDate, setCachedDetailDate] = useState(null); // [New] ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë°ì´í„° ìœ ì§€ìš©
            const [isDetailViewOpen, setIsDetailViewOpen] = useState(false); // [New] ìŠ¬ë¼ì´ë“œ ìƒíƒœ ë¶„ë¦¬
            const [grassTheme, setGrassTheme] = useState(() => localStorage.getItem('cls_grass_theme') || 'indigo');
            const [showThemePicker, setShowThemePicker] = useState(false);
            
            // [New] ì—°ë™ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ê°’ ì„¤ì • (ì´ˆê¸°í™”)
            const [hasNotionRecord, setHasNotionRecord] = useState(false);
            const [hasNotionPortfolio, setHasNotionPortfolio] = useState(false);
            const [hasGoogleSheet, setHasGoogleSheet] = useState(false);

            const [saveTargets, setSaveTargets] = useState(() => {
                // [Fix] ì €ìž¥ëœ ì„¤ì • ìš°ì„  ë¶ˆëŸ¬ì˜¤ê¸°
                const savedPref = localStorage.getItem('cls_save_targets_pref');
                if (savedPref) {
                    try { return new Set(JSON.parse(savedPref)); } catch(e) {}
                }

                const key = localStorage.getItem('cls_notion_key');
                const dbId = localStorage.getItem('cls_notion_db_id');
                const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
                const sheetUrl = localStorage.getItem('cls_google_sheet_url');
                const targets = new Set();
                if (isPortfolioMode && key && portDbId) targets.add('notion_portfolio');
                if (key && dbId) targets.add('notion_record');
                if (sheetUrl) targets.add('google_sheet');
                return targets;
            });
            
            const [notionDate, setNotionDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [notionContent, setNotionContent] = useState('');
            const [notionCategory, setNotionCategory] = useState('ê´€ì°°');
            const [searchText, setSearchText] = useState("");
            const [selectedStudents, setSelectedStudents] = useState([]);
            const [searchQuery, setSearchQuery] = useState("");
            const [showStudentDropdown, setShowStudentDropdown] = useState(false);
            const [notionStatus, setNotionStatus] = useState('idle');
            const [hasNotionConfig, setHasNotionConfig] = useState(false);
            const [hasGoogleSheetConfig, setHasGoogleSheetConfig] = useState(false);
            const [saveProgress, setSaveProgress] = useState(0);
            
            useEffect(() => {
                if (isOpen) {
                    const key = localStorage.getItem('cls_notion_key');
                    const dbId = localStorage.getItem('cls_notion_db_id');
                    const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
                    const sheetUrl = localStorage.getItem('cls_google_sheet_url');

                    const rec = !!(key && dbId);
                    const port = !!(key && portDbId);
                    const sheet = !!sheetUrl;

                    setHasNotionRecord(rec);
                    setHasNotionPortfolio(port);
                    setHasGoogleSheet(sheet);
                    
                    // ë°°ì§€ìš© ìƒíƒœ ì—…ë°ì´íŠ¸ (í˜¸í™˜ì„± ìœ ì§€)
                    setHasNotionConfig(rec || port);
                    setHasGoogleSheetConfig(sheet);
                    
                    // [Fix] ì €ìž¥ëœ ì„¤ì •ì´ ìžˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                    const savedPref = localStorage.getItem('cls_save_targets_pref');
                    if (savedPref) {
                        try {
                            setSaveTargets(new Set(JSON.parse(savedPref)));
                        } catch (e) {}
                    } else {
                        setSaveTargets(prev => {
                            const next = new Set();
                            if (isPortfolioMode && port) next.add('notion_portfolio');
                            else if (rec) next.add('notion_record');
                            if (sheet) next.add('google_sheet');
                            return next;
                        });
                    }
                }
            }, [isOpen, isPortfolioMode]);

            // [New] ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ ì €ìž¥
            useEffect(() => {
                localStorage.setItem('cls_save_targets_pref', JSON.stringify([...saveTargets]));
            }, [saveTargets]);

            // [New] ìƒì„¸ ë·° ë°ì´í„° ìºì‹± (ë‹«íž ë•Œ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ìš©)
            useEffect(() => {
                if (selectedGrassDate) setCachedDetailDate(selectedGrassDate);
            }, [selectedGrassDate]);

            useEffect(() => {
                if (isOpen && isPortfolioMode && student) {
                    setSearchText("");
                    setSelectedStudents([student]);
                }
            }, [isOpen, isPortfolioMode, student]);

            useEffect(() => { 
                if (!student) return;
                setStickerCount(student.stickers || 0);
                if (!isLocalMode && db && appId) {
                    const unsubscribe = db.collection('classes').doc(appId).collection('studentData').doc(String(student.id))
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                if (data.counseling) setNotes(data.counseling);
                            }
                        }, err => console.error("ê°œë³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));
                    return () => unsubscribe();
                } else {
                    const data = student.counseling;
                    if (Array.isArray(data)) setNotes(data);
                    else if (data) setNotes([{ id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: data }]);
                    else setNotes([]);
                }
                setAiComment("");
                setSelectedStudents([student]);
                setNotionDate(dayjs().format('YYYY-MM-DD'));
                setNotionContent('');
                setNotionCategory('ê´€ì°°');
                setNotionStatus('idle');
                setExpandedDates({});

                const key = localStorage.getItem('cls_notion_key');
                const dbId = localStorage.getItem('cls_notion_db_id');
                setHasNotionConfig(!!(key && dbId));
            }, [student, isLocalMode, db, appId]);

            useEffect(() => {
                setNotionDate(selectedDate || dayjs().format('YYYY-MM-DD'));
            }, [selectedDate]);

            const level = Math.floor(stickerCount / 5) + 1;
            
            const handleSticker = (delta) => { 
                const newCount = Math.max(0, stickerCount + delta);
                setStickerCount(newCount); 
                onSaveStickers(student.id, newCount); 
                if(delta > 0) {
                    setStickerEffect(true);
                    setTimeout(() => setStickerEffect(false), 200);
                    if (navigator.vibrate) navigator.vibrate(15);
                    if (newCount % 5 === 0) { 
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                        if(showToast) showToast(`ðŸŽ‰ ë ˆë²¨ ì—…! Lv.${Math.floor(newCount / 5) + 1} ë‹¬ì„±!`);
                    }
                    else { 
                        confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                    }
                }
            };
            
            const handleDeleteNote = (id) => {
                const noteToDelete = notes.find(n => n.id === id);
                if (!noteToDelete) return;

                const hasRelated = noteToDelete.relatedStudents && noteToDelete.relatedStudents.length > 0;

                const deleteSingle = () => {
                    const newNotes = notes.filter(n => n.id !== id);
                    setNotes(newNotes);
                    onSaveCounseling(student.id, newNotes, "ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                };

                const deleteAll = async () => {
                    const targetIds = [student.id, ...noteToDelete.relatedStudents.map(s => s.id)];
                    let updatedStudentsList = [...students];
                    
                    if (isLocalMode) {
                        updatedStudentsList = updatedStudentsList.map(s => {
                            if (targetIds.includes(s.id)) {
                                const sNotes = s.id === student.id ? notes : (s.counseling || []);
                                const newSNotes = sNotes.filter(n => n.id !== id);
                                return { ...s, counseling: newSNotes };
                            }
                            return s;
                        });
                        setStudents(updatedStudentsList);
                        saveData('cls_students', updatedStudentsList);
                        setNotes(notes.filter(n => n.id !== id));
                        showToast("ê´€ë ¨ëœ ëª¨ë“  í•™ìƒì˜ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else if (db && appId) {
                        try {
                            const batch = db.batch();
                            const promises = targetIds.map(async (tId) => {
                                const ref = db.collection('classes').doc(appId).collection('studentData').doc(String(tId));
                                let tNotes = [];
                                if (tId === student.id) {
                                    tNotes = notes;
                                } else {
                                    const doc = await ref.get();
                                    if (doc.exists) tNotes = doc.data().counseling || [];
                                }
                                const newTNotes = tNotes.filter(n => n.id !== id);
                                batch.set(ref, { counseling: newTNotes }, { merge: true });
                                
                                const sIndex = updatedStudentsList.findIndex(s => s.id === tId);
                                if (sIndex >= 0) {
                                    updatedStudentsList[sIndex] = { ...updatedStudentsList[sIndex], counseling: newTNotes };
                                }
                            });
                            
                            await Promise.all(promises);
                            await batch.commit();
                            
                            setStudents(updatedStudentsList);
                            saveData('cls_students', updatedStudentsList);
                            setNotes(notes.filter(n => n.id !== id));
                            showToast("ê´€ë ¨ëœ ëª¨ë“  í•™ìƒì˜ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } catch (e) {
                            console.error("Batch delete failed", e);
                            showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                        }
                    }
                };

                openConfirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    if (hasRelated) {
                        setTimeout(() => {
                            openConfirm(
                                `ì´ ê¸°ë¡ì€ ${noteToDelete.relatedStudents.length}ëª…ì˜ ë‹¤ë¥¸ í•™ìƒë“¤ê³¼ í•¨ê»˜ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•¨ê»˜ ê¸°ë¡ëœ í•™ìƒë“¤ì˜ ê¸°ë¡ë„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œ ì‹œ í˜„ìž¬ í•™ìƒì˜ ê¸°ë¡ë§Œ ì‚­ì œë©ë‹ˆë‹¤)`,
                                deleteAll,
                                deleteSingle
                            );
                        }, 200);
                    } else {
                        deleteSingle();
                    }
                });
            };
            
            const startEditing = (note) => {
                setEditingNoteId(note.id);
                setEditNoteContent(note.content);
                setEditRelatedStudents(note.relatedStudents ? note.relatedStudents.filter(s => s.id !== student.id) : []);
            };

            const saveEditing = async () => {
                if (!editNoteContent.trim()) return;
                
                const originalNote = notes.find(n => n.id === editingNoteId);
                if (!originalNote) return;

                const finalRelated = [{ id: student.id, name: student.name }, ...editRelatedStudents];
                const updatedNote = {
                    ...originalNote,
                    content: editNoteContent.trim(),
                    relatedStudents: finalRelated.length > 1 ? finalRelated : null
                };

                // 1. í˜„ìž¬ í™”ë©´ì˜ notes ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (UI ë°˜ì‘ì„±)
                const newNotes = notes.map(n => n.id === editingNoteId ? updatedNote : n);
                setNotes(newNotes);

                // 2. ë™ê¸°í™” ëŒ€ìƒ í•™ìƒ ID ëª©ë¡ ê³„ì‚° (í˜„ìž¬ ì„¤ì •ëœ ê´€ë ¨ í•™ìƒë“¤ + ë³¸ì¸)
                const targetStudentIds = new Set(editRelatedStudents.map(s => s.id));
                targetStudentIds.add(student.id);

                // 3. ì œì™¸ëœ í•™ìƒ ID ëª©ë¡ ê³„ì‚° (ì›ëž˜ ìžˆì—ˆëŠ”ë° ë¹ ì§„ í•™ìƒë“¤)
                const originalRelatedIds = originalNote.relatedStudents ? originalNote.relatedStudents.map(s => s.id) : [];
                const removedIds = originalRelatedIds.filter(id => !targetStudentIds.has(id));

                if (isLocalMode) {
                    let updatedStudentsList = [...students];

                    // ì—…ë°ì´íŠ¸ ëŒ€ìƒ (ì¶”ê°€/ìˆ˜ì •)
                    targetStudentIds.forEach(tId => {
                        const tStudent = updatedStudentsList.find(s => s.id === tId);
                        if (tStudent) {
                            const tNotes = tStudent.counseling || [];
                            const noteIndex = tNotes.findIndex(n => n.id === editingNoteId);
                            let newTNotes;
                            if (noteIndex >= 0) {
                                newTNotes = [...tNotes];
                                newTNotes[noteIndex] = updatedNote;
                            } else {
                                newTNotes = [updatedNote, ...tNotes];
                            }
                            updatedStudentsList = updatedStudentsList.map(s => s.id === tId ? { ...s, counseling: newTNotes } : s);
                        }
                    });

                    // ì‚­ì œ ëŒ€ìƒ (ì œì™¸ëœ í•™ìƒ)
                    removedIds.forEach(rId => {
                        const rStudent = updatedStudentsList.find(s => s.id === rId);
                        if (rStudent) {
                            const rNotes = rStudent.counseling || [];
                            const newRNotes = rNotes.filter(n => n.id !== editingNoteId);
                            updatedStudentsList = updatedStudentsList.map(s => s.id === rId ? { ...s, counseling: newRNotes } : s);
                        }
                    });

                    setStudents(updatedStudentsList);
                    saveData('cls_students', updatedStudentsList);
                    showToast("ê¸°ë¡ì´ ìˆ˜ì • ë° ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else if (db && appId) {
                    try {
                        const promises = [];
                        targetStudentIds.forEach(tId => {
                            promises.push(db.collection('classes').doc(appId).collection('studentData').doc(String(tId)).get().then(doc => {
                                let tNotes = [];
                                if (doc.exists) {
                                    const data = doc.data();
                                    tNotes = data.counseling || [];
                                }
                                const noteIndex = tNotes.findIndex(n => n.id === editingNoteId);
                                if (noteIndex >= 0) tNotes[noteIndex] = updatedNote;
                                else tNotes = [updatedNote, ...tNotes];
                                return { ref: doc.ref, counseling: tNotes };
                            }));
                        });
                        removedIds.forEach(rId => {
                            promises.push(db.collection('classes').doc(appId).collection('studentData').doc(String(rId)).get().then(doc => {
                                if (doc.exists) {
                                    const data = doc.data();
                                    let rNotes = data.counseling || [];
                                    const newRNotes = rNotes.filter(n => n.id !== editingNoteId);
                                    return { ref: doc.ref, counseling: newRNotes };
                                }
                                return null;
                            }));
                        });
                        const results = await Promise.all(promises);
                        const batch = db.batch();
                        let updateCount = 0;
                        results.forEach(res => {
                            if (res) {
                                batch.set(res.ref, { counseling: res.counseling }, { merge: true });
                                updateCount++;
                            }
                        });
                        if (updateCount > 0) {
                            await batch.commit();
                            showToast("ê¸°ë¡ì´ ìˆ˜ì • ë° ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        }
                    } catch (e) {
                        console.error("ë™ê¸°í™” ì €ìž¥ ì‹¤íŒ¨:", e);
                        showToast("ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                    }
                }

                setEditingNoteId(null);
                setEditNoteContent("");
                setEditRelatedStudents([]);
            };

            const handleAddEditStudent = (s) => {
                if (!editRelatedStudents.some(rs => rs.id === s.id) && s.id !== student.id) {
                    setEditRelatedStudents([...editRelatedStudents, { id: s.id, name: s.name }]);
                }
                setEditSearchText("");
                setShowEditStudentDropdown(false);
            };

            const handleRemoveEditStudent = (id) => {
                setEditRelatedStudents(editRelatedStudents.filter(s => s.id !== id));
            };

            const handleStudentSelect = (name) => {
                const s = students.find(st => st.name === name);
                if (s && !selectedStudents.find(sel => sel.id === s.id)) {
                    setSelectedStudents(prev => [...prev, s]);
                }
            };
            
            const removeSelectedStudent = (id) => {
                setSelectedStudents(prev => prev.filter(s => s.id !== id));
            };

            const handleIntegratedSave = async (targetCategory) => {
                const category = targetCategory || 'ê´€ì°°';
                const content = notionContent.trim();
                const date = notionDate || dayjs().format('YYYY-MM-DD');

                if (!content) return showToast("ë‚´ìš©ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setNotionStatus('saving');
                setSaveProgress(0);

                let totalOps = 0;
                if (saveTargets.has('google_sheet')) totalOps += 1;
                if (saveTargets.has('notion_portfolio')) totalOps += 1;
                if (saveTargets.has('notion_record')) totalOps += selectedStudents.length;
                if (totalOps === 0) totalOps = 1;
                let completedOps = 0;
                const updateProgress = () => { completedOps++; setSaveProgress(Math.min(Math.round((completedOps / totalOps) * 100), 99)); };
                
                let tags = [];
                if (saveTargets.has('notion_record')) tags.push("ë…¸ì…˜(ê¸°ë¡)");
                if (saveTargets.has('notion_portfolio')) tags.push("ë…¸ì…˜(í¬í´)");
                if (saveTargets.has('google_sheet')) tags.push("êµ¬ê¸€ ì‹œíŠ¸");

                // [New] í•¨ê»˜ ê¸°ë¡ëœ í•™ìƒ ì •ë³´ ì €ìž¥
                const relatedStudents = selectedStudents.length > 1 
                    ? selectedStudents.map(s => ({ id: s.id, name: s.name })) 
                    : null;

                const newNote = { id: Date.now(), date: date, content: content, destTags: tags, relatedStudents: relatedStudents };
                const targetIds = selectedStudents.map(s => s.id);
                
                let updatedStudentsList = [...students];

                for (const targetId of targetIds) {
                    const studentObj = students.find(s => s.id === targetId);
                    if (!studentObj) continue;

                    let prevNotes = [];
                    // ðŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ë³´ì´ì§€ ì•ŠëŠ” í•˜ìœ„ ê¸ˆê³ (studentData)ì—ì„œ ì˜›ë‚  ê¸°ë¡ì„ ë¨¼ì € êº¼ë‚´ì˜µë‹ˆë‹¤.
                    if (!isLocalMode && db && appId) {
                        try {
                            const doc = await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).get();
                            if (doc.exists && doc.data().counseling) {
                                prevNotes = doc.data().counseling;
                            }
                        } catch (e) { console.error("ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e); }
                    } else {
                        prevNotes = studentObj.counseling || [];
                    }

                    const updatedNotes = [newNote, ...prevNotes];
                    let updatedStickers = studentObj.stickers || 0;
                    if (category === 'ì¹­ì°¬') updatedStickers += 1;

                    // ðŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ì˜›ë‚  ê¸°ë¡ê³¼ ìƒˆ ê¸°ë¡ì„ í•©ì³ì„œ ë‹¤ì‹œ ê¸ˆê³ ì— ì•ˆì „í•˜ê²Œ ë„£ìŠµë‹ˆë‹¤!
                    if (!isLocalMode && db && appId) {
                        await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).set({ counseling: updatedNotes }, { merge: true });
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, stickers: updatedStickers } : s);
                    } else {
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, counseling: updatedNotes, stickers: updatedStickers } : s);
                    }
                }

                setStudents(updatedStudentsList);
                if (!isLocalMode) saveData('cls_students', updatedStudentsList);
                else localStorage.setItem('cls_students', JSON.stringify(updatedStudentsList));

                if (targetIds.includes(student.id)) {
                    setNotes(prev => [newNote, ...prev]);
                    if (category === 'ì¹­ì°¬') {
                        setStickerCount(prev => prev + 1);
                        setShowButtonEffect(true); setTimeout(() => setShowButtonEffect(false), 800);
                        setStickerEffect(true); setTimeout(() => setStickerEffect(false), 200);
                        if (navigator.vibrate) navigator.vibrate(15);
                        if ((stickerCount + 1) % 5 === 0) { 
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                            if(showToast) showToast(`ðŸŽ‰ ë ˆë²¨ ì—…! Lv.${Math.floor((stickerCount + 1) / 5) + 1} ë‹¬ì„±!`);
                        } else { 
                            confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                        }
                    }
                }

                if (saveTargets.has('google_sheet')) {
                    let successCount = 0;
                    // ðŸŒŸ ì¤„ ì„¸ìš°ì§€ ì•Šê³ , ë°°ì—´ í†µì§¸ë¡œ ì „ì†¡!
                    if (await saveToGoogleSheet(selectedStudents, category, content, date)) {
                        successCount = selectedStudents.length;
                    }
                    updateProgress();
                    if (successCount > 0) {
                        setNotionStatus('success'); 
                        if (!keepContent) setNotionContent(''); 
                        setTimeout(() => setNotionStatus('idle'), 3000); 
                        showToast("âœ… ê¸°ë¡ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        if (closeAfterSave) onClose();
                    }
                }

                try {
                    const rawKey = localStorage.getItem('cls_notion_key') || "";
                    const personalKey = rawKey.replace(/["']/g, '').trim();
                    const targets = [];
                    if (saveTargets.has('notion_record')) targets.push('notion_record');
                    if (saveTargets.has('notion_portfolio')) targets.push('notion_portfolio');

                    for (const target of targets) {
                        const rawDbId = (target === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
                        const targetDbId = rawDbId.replace(/["']/g, '').trim();
                        if (!personalKey || !targetDbId) continue;

                        const bodyData = { category: category, content: content, personalKey: personalKey, personalDbId: targetDbId };
                        
                        if (target === 'notion_portfolio') {
    const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
    const ids = []; selectedStudents.forEach(s => { if (map[s.name]) ids.push(map[s.name]); });
    
    // ðŸŒŸ ì„ íƒëœ ì•„ì´ë“¤ì˜ ì´ë¦„ì„ ì‰¼í‘œë¡œ ëª¨ë‘ ì—°ê²°í•©ë‹ˆë‹¤. (ì˜ˆ: "ê¹€ì² ìˆ˜, ì´ì˜í¬, ë°•ì§€ë¯¼")
    const joinedNames = selectedStudents.map(s => s.name).join(', ');
    
    bodyData.mode = 'relation'; 
    bodyData.studentIds = ids;
    bodyData.studentName = joinedNames; // ë…¸ì…˜ì˜ 'ì œëª©' ë˜ëŠ” 'ì´ë¦„' ì¹¸ì— í•œ ë²ˆì— ì „ì†¡!
    
    await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData) });
    updateProgress();
} else {
    // [Fix] ë…¸ì…˜(ê¸°ë¡) ëª¨ë“œì¼ ë•Œ ì„ íƒëœ ëª¨ë“  í•™ìƒì— ëŒ€í•´ ê°œë³„ ì €ìž¥
    for (const s of selectedStudents) {
        const individualBody = { 
            ...bodyData, 
            mode: 'normal', 
            studentName: s.name, 
            date: dayjs(date).format('YYYY-MM-DD') 
        };
        await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(individualBody) });
        
        // ðŸŒŸ í•µì‹¬ í•´ê²°ì±…: ë…¸ì…˜ ì„œë²„ê°€ íŠ•ê²¨ë‚´ì§€ ëª»í•˜ê²Œ 1ëª… ì €ìž¥í•  ë•Œë§ˆë‹¤ 0.35ì´ˆ(350ms)ì”© ë¶€ë“œëŸ½ê²Œ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤!
        await new Promise(resolve => setTimeout(resolve, 350)); 
        updateProgress();
    }
}
                    }
                    setSaveProgress(100);
                    setNotionStatus('success'); if(typeof showToast !== 'undefined') showToast("âœ¨ ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì´ ì•ˆì „í•˜ê²Œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); if (!keepContent) setNotionContent(''); setTimeout(() => setNotionStatus('idle'), 3000);
                    showToast("âœ… ê¸°ë¡ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } catch (e) {
                    console.error(e); setNotionStatus('error'); setTimeout(() => setNotionStatus('idle'), 3000);
                }
            };
            
            const calculateStatsForPeriod = (startStr, endStr) => {
                let pTotal = 0, pDone = 0;
                const pMissed = {};
                const tagStats = {};
                let curr = dayjs(startStr);
                const end = dayjs(endStr);
                let classTotal = 0, classDone = 0;
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    
                    if (tasks.length > 0) {
                        pTotal += tasks.length;
                        tasks.forEach(t => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            if (!tagStats[tag]) tagStats[tag] = { sTotal: 0, sDone: 0, cTotal: 0, cDone: 0 };
                        });
                        tasks.forEach((t, idx) => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            const isDone = rec?.tasks ? rec.tasks[idx] : (rec?.done && !rec.tasks);
                            tagStats[tag].sTotal++;
                            if(isDone) {
                                pDone++;
                                tagStats[tag].sDone++;
                            } else {
                                pMissed[tag] = (pMissed[tag] || 0) + 1;
                            }
                        });
                        const recs = records[dStr] || {};
                        students.forEach(s => {
                            const r = recs[s.id];
                            classTotal += tasks.length;
                            tasks.forEach((t, idx) => {
                                const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                                tagStats[tag].cTotal++;
                                let taskDone = false;
                                if (r && (r.tasks ? r.tasks[idx] : r.done)) taskDone = true;
                                if (taskDone) { tagStats[tag].cDone++; classDone++; }
                            });
                        });
                    }
                    curr = curr.add(1, 'day');
                }
                
                const pRate = pTotal > 0 ? Math.round((pDone / pTotal) * 100) : 0;
                const classAvgRate = classTotal > 0 ? Math.round((classDone / classTotal) * 100) : 0;

                return { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats };
            };
            
            useEffect(() => {
                if (isOpen && student && students) {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                    
                    // Animation logic
                    const timer = setTimeout(() => {
                        setAnimatedWidths({ student: stats.pRate, class: stats.classAvgRate });
                    }, 100);
                    
                    return () => clearTimeout(timer);
                } else {
                    // Reset widths when modal closes for next open animation
                    setAnimatedWidths({ student: 0, class: 0 });
                }
            }, [isOpen, student, students, records, dailyTasks, reportStart, reportEnd]);
            
            // ... (generateReportContent ìƒëžµ ì—†ì´ ì›ë³¸ ìœ ì§€) ...
            const generateReportContent = async () => {
                if (isGenerating) return;
                setIsGenerating(true);
                try {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    const { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats } = stats;
                    setReportStats({ studentRate: pRate, classRate: classAvgRate, tagStats });
                    const pNotes = notes.filter(n => n.date >= reportStart && n.date <= reportEnd);
                    const missedList = Object.entries(pMissed).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]}(${x[1]}íšŒ)`);
                    const weakSubjects = [];
                    if (tagStats) {
                        Object.entries(tagStats).forEach(([tag, stat]) => {
                            const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                            const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                            if (cRate - sRate >= 15) weakSubjects.push(tag);
                        });
                    }
                    const weakSubjectsStr = weakSubjects.length > 0 ? weakSubjects.join(', ') : 'ì—†ìŒ';
                    if (apiKey) {
                        const isInsufficientData = pNotes.length < 2;
                        if(showToast) showToast("AIê°€ ë¦¬í¬íŠ¸ë¥¼ ìž‘ì„± ì¤‘ìž…ë‹ˆë‹¤...");
                        
                        // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™” ì²˜ë¦¬
                        const safeName = "[STUDENT_TOKEN]";
                        
                        // [ë³´ì•ˆ ê°•í™”] ëŒ€ìƒ í•™ìƒ ì™¸ì— ë‹¤ë¥¸ í•™ìƒë“¤ì˜ ì´ë¦„ë„ ëª¨ë‘ ìµëª…í™”
                        let safeNotesStr = pNotes.map(n => `[${n.date}] ${n.content}`).join('\n');
                        safeNotesStr = anonymizeText(safeNotesStr, student.name);
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                        
                        const prompt = `[ë³´ì•ˆ ê·œì¹™:ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëžŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìžˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]\n\në‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ë¡œì„œ í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³  í•™ìƒì—ê²Œ ë„ì›€ì„ ì¤„ ìˆ˜ ìžˆëŠ” ë‚´ìš©ìœ¼ë¡œ ì„±ìž¥ ë¦¬í¬íŠ¸ë¥¼ ìž‘ì„±í•©ë‹ˆë‹¤. [í•™ìƒ ì •ë³´] - ì´ë¦„: ${safeName}, ë¶„ì„ ê¸°ê°„: ${reportStart} ~ ${reportEnd}, ì„±ì‹¤ë„ ì§€í‘œ (ê³¼ì œ ìˆ˜í–‰ë¥ ): ${pRate}%, ë¶€ì¡±í•œ ê³¼ëª©: ${weakSubjectsStr}, ì¹­ì°¬ ìŠ¤í‹°ì»¤: ${stickerCount}ê°œ. [êµì‚¬ ê´€ì°° ê¸°ë¡] ${pNotes.length > 0 ? safeNotesStr : 'íŠ¹ì´ ê¸°ë¡ ì—†ìŒ'} ${isInsufficientData ? '[ê²½ê³ ] í˜„ìž¬ ì´ í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ì§§ê³  ê°„ê²°í•˜ê²Œ ìž‘ì„±í•˜ì„¸ìš”.' : ''}`;
                        
                        const aiText = await callGemini(apiKey, prompt, 0.2);
                        
                        // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                        const finalContent = deanonymizeText(aiText, student.name);
                        setTempComment(finalContent);
                    } else {
                        const tpl = `${student.name} í•™ìƒì€ ${reportStart}ë¶€í„° ${reportEnd}ê¹Œì§€ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í–ˆìŠµë‹ˆë‹¤.\n\nì´ ê¸°ê°„ ë™ì•ˆ ê³¼ì œ ìˆ˜í–‰ë¥ ì€ ${pRate}%ì´ë©°, ${missedList.length > 0 ? `ì£¼ë¡œ ${missedList.join(', ')} ê³¼ëª©ì—ì„œ ë³´ì™„ì´ í•„ìš”í•´ ë³´ìž…ë‹ˆë‹¤.` : 'ëª¨ë“  ê³¼ëª©ì„ í›Œë¥­í•˜ê²Œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.'}\n\nê°€ì •ì—ì„œë„ ë§Žì€ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;
                        setTempComment(tpl);
                    }
                } catch (e) {
                    if(showToast) showToast("ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handlePrepareReport = () => {
                const stats = calculateStatsForPeriod(reportStart, reportEnd);
                setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                const savedDraft = student.recordDrafts?.['growth_report'];
                if (savedDraft) {
                    setTempComment(savedDraft);
                } else {
                    setTempComment(`${student.name} í•™ìƒì€ í˜„ìž¬ ë ˆë²¨ ${level}ë¡œ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìžˆìŠµë‹ˆë‹¤.`);
                }
                setShowReportEdit(true);
            };
            
            const handleSaveReportDraft = () => onSaveRecordDraft(student.id, 'growth_report', tempComment);

            const handleDownloadReport = async () => {
                setShowReportEdit(false); setAiComment(tempComment); setIsGenerating(true);
                if(showToast) showToast("ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìžˆìŠµë‹ˆë‹¤...");
                await new Promise(resolve => setTimeout(resolve, 1000));
                try {
                    const canvas = await window.html2canvas(reportRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${student.name}_ì„±ìž¥ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ìž¥ ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handleCopyText = () => { navigator.clipboard.writeText(tempComment).then(() => { if(showToast) showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }); };

            const grassHistory = useMemo(() => {
                const start = dayjs(grassStart);
                const end = dayjs(grassEnd);
                const diff = end.diff(start, 'day') + 1;
                const history = [];
                for (let i = 0; i < diff; i++) {
                    const d = start.add(i, 'day');
                    const dStr = d.format('YYYY-MM-DD');
                    const dayOfWeek = d.day();
                    if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    let done = 0; let total = 0;
                    if (tasks.length > 0) {
                        total = tasks.length;
                        if (rec) {
                            tasks.forEach((_, idx) => {
                                if (rec.tasks && rec.tasks[idx]) done++;
                                else if (!rec.tasks && rec.done) done++;
                            });
                        }
                    } else { if (rec && rec.done) { total = 1; done = 1; } }
                    const ratio = total > 0 ? done / total : 0;
                    history.push({ date: dStr, ratio, count: done, total });
                }
                return history;
            }, [grassStart, grassEnd, dailyTasks, records, student.id]);

            const avgRate = useMemo(() => {
                const history = student.history || [];
                return history.length > 0 ? Math.round((history.reduce((acc, h) => acc + h.ratio, 0) / history.length) * 100) : 0;
            }, [student.history]);
            
            const missedTags = useMemo(() => {
                const counts = {};
                dates.forEach(date => {
                    const day = dayjs(date).day();
                    if (day === 0 || day === 6) return;

                    const tasks = dailyTasks[date];
                    const rec = records[date]?.[student.id];
                    if (tasks && tasks.length > 0) {
                        tasks.forEach((task, idx) => {
                            let isDone = false;
                            if (rec) { if (rec.tasks) isDone = !!rec.tasks[idx]; else isDone = !!rec.done; }
                            if (!isDone) {
                                const tag = typeof task === 'object' ? task.tag : 'ê¸°íƒ€';
                                counts[tag] = (counts[tag] || 0) + 1;
                            }
                        });
                    }
                });
                return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
            }, [student, records, dailyTasks, dates]);
            
            const reportHistoryData = useMemo(() => {
                const history = [];
                let curr = dayjs(reportStart);
                const end = dayjs(reportEnd);
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    // ...(ê°„ëžµí™”ëœ ìž”ë”” ë°ì´í„° ë¡œì§, ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ë Œë”ë§ì— ì‚¬ìš©ë¨)
                    history.push({ date: dStr, ratio: 0.8, count: 4, total: 5 });
                    curr = curr.add(1, 'day');
                }
                return history;
            }, [reportStart, reportEnd]); // reportHistory ìƒëžµëœ ë¡œì§ ì¶•ì†Œ

            const handleSaveAIAdvice = (adviceText) => {
                const newNote = { id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: `[AI ìƒë‹´]\n${adviceText}` };
                const newNotes = [newNote, ...notes];
                setNotes(newNotes);
                onSaveCounseling(student.id, newNotes, "AI ìƒë‹´ ë‚´ìš©ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleOpenCounselingAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowCounselingAI(true);
            };
            
            const handleOpenStudentRecordAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowStudentRecordAI(true);
            };
            
            const getPieStyle = (ratio) => {
                if (ratio <= 0) return { backgroundColor: '#f1f5f9' };
                if (ratio >= 1) return { backgroundColor: '#22c55e' };
                const percentage = ratio * 100;
                return { background: `conic-gradient(#4ade80 0% ${percentage}%, #f1f5f9 ${percentage}% 100%)` };
            };
            
            const getLevelColor = (lv) => {
                if (lv >= 5) return 'bg-orange-500';
                if (lv === 4) return 'bg-purple-500';
                if (lv === 3) return 'bg-indigo-500';
                if (lv === 2) return 'bg-blue-500';
                return 'bg-green-500';
            };
            
            const getLevelTextColor = (lv) => {
                if (lv >= 5) return 'text-orange-500';
                if (lv === 4) return 'text-purple-500';
                if (lv === 3) return 'text-indigo-600';
                if (lv === 2) return 'text-blue-500';
                return 'text-green-500';
            };

            const handleAddPhrase = () => {
                if (!tempComment.trim()) return showToast("ì €ìž¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, tempComment.trim()];
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
            };
            
            const handleApplyPhrase = (text) => {
                setTempComment(prev => prev + (prev ? "\n\n" : "") + text);
                setShowPhraseList(false);
            };

           const filteredNotes = notes.filter(n => {
                const matchDate = selectedDate ? n.date === selectedDate : true;
                // ðŸŒŸ í•µì‹¬: ê²€ìƒ‰ì–´(searchTerm)ê°€ 'ë‚´ìš©(content)'ì— ìžˆê±°ë‚˜ 'ë‚ ì§œ(date)'ì™€ ë˜‘ê°™ìœ¼ë©´ ë³´ì—¬ì¤˜!
                const matchText = searchTerm 
                    ? (n.content && n.content.toLowerCase().includes(searchTerm.toLowerCase())) || 
                      (n.date && n.date.includes(searchTerm)) 
                    : true;
                return matchDate && matchText;
            });
            
            const displayedNotes = isExpanded ? filteredNotes : filteredNotes.slice(0, 2);
            const hasMore = filteredNotes.length > 2;

            // [ì¶”ê°€ë¨] í™œë™ ìž”ë”” (ì˜¤ëŠ˜ ë‚ ì§œ ë° ì ‘ê³  íŽ´ê¸° ë¡œì§)
            const todayStr = dayjs().format('YYYY-MM-DD');
            const currentWeekGrass = grassHistory.filter(h => dayjs(h.date).isSame(dayjs(), 'week'));
            const defaultGrass = currentWeekGrass.length > 0 ? currentWeekGrass : grassHistory.slice(-5);
            const displayedGrass = isGrassExpanded ? grassHistory : defaultGrass;

            return (
                <div className="fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    {/* [ìˆ˜ì •ë¨] max-w-5xl, max-h-[85vh] ë¡œ í¬ê¸° ì¶•ì†Œ */}
                    <div ref={modalRef} className="bg-slate-50 w-full max-w-5xl rounded-3xl shadow-2xl p-4 md:p-6 max-h-[85vh] overflow-y-auto overflow-x-hidden custom-scroll flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header Container */}
                        <div className="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200 mb-6 flex-shrink-0">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-16 h-16 rounded-full bg-slate-50 border border-slate-200 overflow-hidden flex items-center justify-center shadow-sm flex-shrink-0">
                                        <span className="text-3xl">{student.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§'}</span>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                            {student.name}
                                            <span className="text-sm font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">{student.order}ë²ˆ</span>
                                        </div>
                                        <div className="text-sm font-bold text-indigo-500 mt-1">Level {level} <span className="text-slate-400 font-normal">| í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span></div>
                                    </div>
                                </div>
                                
                                {/* Header Action Buttons */}
                                <div className="flex items-center gap-2" id="export-hide-area">
                                    <button onClick={handleOpenCounselingAI} className="p-2 hover:bg-rose-50 text-rose-500 rounded-xl transition-colors border border-transparent hover:border-rose-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.heart} size={18}/> <span className="hidden md:inline">AI ìƒë‹´ì†Œ</span></button>
                                    <button onClick={handleOpenStudentRecordAI} className="p-2 hover:bg-blue-50 text-blue-500 rounded-xl transition-colors border border-transparent hover:border-blue-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.document} size={18}/> <span className="hidden md:inline">ì´í‰ ì´ˆì•ˆ</span></button>
                                    <button onClick={handlePrepareReport} disabled={isGenerating} className="p-2 hover:bg-indigo-50 text-indigo-600 rounded-xl transition-colors border border-transparent hover:border-indigo-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.edit} size={18}/> <span className="hidden md:inline">ë¦¬í¬íŠ¸ ìž‘ì„±</span></button>
                                    <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                    <button onClick={onClose} className="p-2 hover:bg-slate-100 text-slate-500 rounded-xl transition-colors"><Icon d={PATHS.x} size={20}/></button>
                                </div>
                            </div>
                        </div>

                        {/* Dashboard Grid Container */}
                        <div className="lg:grid lg:grid-cols-12 lg:gap-6 space-y-6 lg:space-y-0 flex-1">
                            
                            {/* LEFT COLUMN (5/12) */}
                            <div className="lg:col-span-5 space-y-6 flex flex-col">
                                
                                {/* Missed Tags */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                                    <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon d={PATHS.chart} size={16} className="text-indigo-500"/> ìžì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</h4>
                                    {missedTags.length > 0 ? (
                                        <div className="space-y-3">
                                            {missedTags.map(([tag, count], i) => {
                                                const maxCount = missedTags[0][1];
                                                const width = (count / maxCount) * 100;
                                                const rankColor = i === 0 ? 'bg-rose-500' : i === 1 ? 'bg-orange-400' : 'bg-amber-400';
                                                const barColor = i === 0 ? 'bg-rose-400' : i === 1 ? 'bg-orange-300' : 'bg-amber-300';
                                                const bgColor = i === 0 ? 'bg-rose-50' : i === 1 ? 'bg-orange-50' : 'bg-amber-50';
                                                return (
                                                    <div key={tag} className={`relative p-3 rounded-xl border border-slate-100 ${bgColor}`}>
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`w-5 h-5 rounded-lg flex items-center justify-center text-[10px] font-bold text-white shadow-sm ${rankColor}`}>{i+1}</span>
                                                                <span className="text-sm font-bold text-slate-700">{tag}</span>
                                                            </div>
                                                            <span className="text-xs font-bold text-slate-500">{count}íšŒ ë†“ì¹¨</span>
                                                        </div>
                                                        <div className="h-2.5 bg-white rounded-full overflow-hidden shadow-inner border border-slate-100">
                                                            <div className={`h-full rounded-full transition-all duration-1000 ${barColor}`} style={{ width: `${width}%` }}></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="text-center text-slate-400 text-sm py-6 bg-slate-50 rounded-xl border border-dashed border-slate-200">ë¯¸í¡í•œ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤! ðŸŽ‰</div>
                                    )}
                                </div>

                                {/* Class Average Comparison */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm cursor-pointer hover:border-indigo-300 transition-colors group" onClick={() => setShowDetailStats(!showDetailStats)}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.users} size={16} className="text-blue-500"/> í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                        <div className="flex items-center gap-1 text-xs font-bold text-slate-400 group-hover:text-indigo-500 transition-colors">
                                            <span>{showDetailStats ? 'ì ‘ê¸°' : 'ìžì„¸ížˆ ë³´ê¸°'}</span>
                                            <Icon d={showDetailStats ? PATHS.down : PATHS.right} size={14} />
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 relative overflow-hidden">
                                        <div className="flex items-center justify-between mb-4 relative z-10">
                                            <div className="flex flex-col">
                                                <span className="text-xs text-slate-500 font-bold mb-1">ì „ì²´ ìˆ˜í–‰ë¥  ë¹„êµ</span>
                                                <div className="flex items-baseline gap-1">
                                                    <span className={`text-2xl font-black ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span>
                                                    <span className="text-xs text-slate-400 font-medium">vs {reportStats.classRate}% (í•™ê¸‰)</span>
                                                </div>
                                            </div>
                                            <div className={`flex flex-col items-center justify-center w-14 h-14 rounded-2xl border-2 ${reportStats.studentRate >= reportStats.classRate ? 'bg-indigo-50 border-indigo-100 text-indigo-600' : 'bg-rose-50 border-rose-100 text-rose-500'}`}>
                                                <span className="text-[10px] font-bold opacity-70">GAP</span>
                                                <span className="text-lg font-black leading-none">
                                                    {reportStats.studentRate >= reportStats.classRate ? '+' : ''}{reportStats.studentRate - reportStats.classRate}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-3 relative z-10">
                                            <div className="relative">
                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1 px-1">
                                                    <span>ë‚˜ ({student.name})</span>
                                                </div>
                                                <div className="h-3 bg-white rounded-full overflow-hidden shadow-sm border border-slate-100">
                                                    <div className={`h-full ${getLevelColor(level)} transition-all duration-1000 relative`} style={{ width: `${animatedWidths.student}%` }}>
                                                        <div className="absolute top-0 right-0 bottom-0 w-1 bg-white/30"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="relative">
                                                <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-1 px-1">
                                                    <span>í•™ê¸‰ í‰ê· </span>
                                                </div>
                                                <div className="h-3 bg-white rounded-full overflow-hidden shadow-sm border border-slate-100">
                                                    <div className="h-full bg-slate-400 transition-all duration-1000 relative" style={{ width: `${animatedWidths.class}%` }}>
                                                        <div className="absolute top-0 right-0 bottom-0 w-1 bg-white/30"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {showDetailStats && reportStats.tagStats && (
                                        <div className="mt-4 pt-4 border-t border-slate-100 space-y-4 animate-fade-in" onClick={e => e.stopPropagation()}>
                                            <div className="flex justify-end mb-3">
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('bar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'bar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë§‰ëŒ€ ê·¸ëž˜í”„</button>
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('radar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'radar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°©ì‚¬í˜• ì°¨íŠ¸</button>
                                                </div>
                                            </div>
                                            {chartType === 'bar' ? (
                                                Object.entries(reportStats.tagStats)
                                                .filter(([tag, stat]) => stat.cDone > 0)
                                                .sort((a,b) => b[1].sTotal - a[1].sTotal).map(([tag, stat]) => {
                                                    const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                                                    const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                                                    const isLow = cRate - sRate >= 20;
                                                    const isHigh = sRate > cRate;
                                                    return (
                                                        <div key={tag} className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                            <div className="flex justify-between text-xs mb-2 font-bold text-slate-600">
                                                                <div className="flex items-center gap-1.5"><span className="bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-600">{tag}</span>{isHigh && <span className="text-[10px] text-orange-500 animate-pulse">í›Œë¥­í•´ìš”! ðŸŽ‰</span>}</div>
                                                                <div className="flex gap-3"><span className={isLow ? "text-rose-500" : getLevelTextColor(level)}>ë‚˜ {sRate}%</span><span className="text-slate-400">ë°˜ {cRate}%</span></div>
                                                            </div>
                                                            <div className="flex flex-col gap-1.5">
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className={`h-full ${isLow ? "bg-rose-500" : getLevelColor(level)}`} style={{ width: `${sRate}%` }}></div></div>
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className="h-full bg-slate-400" style={{ width: `${cRate}%` }}></div></div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            ) : <RadarChart data={reportStats.tagStats} />}
                                        </div>
                                    )}
                                </div>

                            </div>

                            {/* RIGHT COLUMN (7/12) */}
                            <div className="lg:col-span-7 space-y-6 flex flex-col h-full">

                                {/* Sticker Area */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <h4 className="text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><span className="text-lg">ðŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤</h4>
                                        <span className="text-xs text-slate-400 font-medium">ê¸ì •ì  ê°•í™”ì™€ ë³´ìƒ</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <Btn onClick={() => handleSticker(-1)} className="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 font-bold text-lg">-</Btn>
                                        <span className={`text-3xl font-black text-yellow-500 w-12 text-center transition-transform duration-200 ${stickerEffect ? 'scale-150 text-orange-500' : ''}`}>{stickerCount}</span>
                                        <Btn onClick={() => handleSticker(1)} className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold text-lg shadow-sm">+</Btn>
                                    </div>
                                </div>

                                {/* Records Area (Logs + Input) */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex flex-col flex-1">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 items-start">
                                            <span className="flex items-center gap-2 whitespace-nowrap"><Icon d={PATHS.document} size={16} className="text-green-500"/> êµì‚¬ ê´€ì°° ë° ì¹­ì°¬ ê¸°ë¡</span>
                                            <div className="flex flex-col sm:flex-row gap-1">
                                                {hasNotionConfig && <span className="w-fit text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />ë…¸ì…˜ ì—°ë™</span>}
                                                {hasGoogleSheetConfig && <span className="w-fit text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />êµ¬ê¸€ ì—°ë™</span>}
                                            </div>
                                        </h4>
                                    </div>

                                    {/* Unified Input Form */}
                                    <div className="flex flex-col gap-3 mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner">
                                        <div className="flex flex-wrap gap-1.5 mb-1 relative">
                                            {selectedStudents.map(s => (
                                                <span key={s.id} className="text-xs px-2.5 py-1 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                                    {s.name}
                                                    {s.id !== student.id && <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500 bg-indigo-100 rounded-full p-0.5"><Icon d={PATHS.x} size={10}/></button>}
                                                </span>
                                            ))}
                                        </div>

                                        {/* [New] ì €ìž¥ì†Œ ì„ íƒ íƒ­ UI */}
                                        {(hasNotionRecord || hasNotionPortfolio || hasGoogleSheet) ? (
                                            <div className="flex gap-1 bg-white p-1 rounded-xl border border-slate-200">
                                                {hasNotionRecord && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_record')) next.delete('notion_record'); else next.add('notion_record'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_record') ? 'bg-indigo-50 text-indigo-600 shadow-sm ring-1 ring-indigo-100' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“ ë…¸ì…˜(ê¸°ë¡)</button>}
                                                {hasNotionPortfolio && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_portfolio')) next.delete('notion_portfolio'); else next.add('notion_portfolio'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_portfolio') ? 'bg-amber-50 text-amber-600 shadow-sm ring-1 ring-amber-100' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“ ë…¸ì…˜(í¬í´)</button>}
                                                {hasGoogleSheet && <button onClick={() => { const next = new Set(saveTargets); if(next.has('google_sheet')) next.delete('google_sheet'); else next.add('google_sheet'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('google_sheet') ? 'bg-green-50 text-green-600 shadow-sm ring-1 ring-green-100' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>}
                                            </div>
                                        ) : (
                                            <div className="text-center text-xs text-slate-400 py-2 bg-slate-50 rounded-xl border border-slate-200 border-dashed">ì—°ë™ëœ ì™¸ë¶€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤ (ë¡œì»¬ì—ë§Œ ì €ìž¥ë©ë‹ˆë‹¤)</div>
                                        )}

                                        <div className="flex items-center gap-2 relative z-20">
                                            <div className="flex-1 relative">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <Icon d={PATHS.search} size={14} className="text-slate-400" />
                                                </div>
                                                <input 
                                                    placeholder="ë‹¤ë¥¸ í•™ìƒ í•¨ê»˜ íƒœê·¸í•˜ê¸°..." 
                                                    className="w-full p-2.5 pl-9 bg-white border border-slate-300 rounded-xl text-xs font-medium outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all shadow-sm" 
                                                    value={searchText}
                                                    onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }}
                                                    onFocus={() => setShowStudentDropdown(true)}
                                                    onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)}
                                                />
                                                {showStudentDropdown && (
                                                    <div className="absolute top-full left-0 w-full bg-white shadow-2xl border border-slate-200 rounded-xl z-50 max-h-48 overflow-y-auto mt-2 custom-scroll py-1 animate-fade-in">
                                                        <div className="px-3 py-1.5 text-[10px] font-bold text-slate-400 bg-slate-50 border-b border-slate-100 mb-1">í•™ìƒ ê²€ìƒ‰</div>
                                                        {students.filter(s => s.name.includes(searchText)).sort((a, b) => a.name.localeCompare(b.name)).map(s => (
                                                            <div 
                                                                key={s.id} 
                                                                className="px-3 py-2.5 text-xs text-slate-700 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center"
                                                                onMouseDown={() => { handleStudentSelect(s.name); setSearchText(""); }}
                                                            >
                                                                <span className="font-bold flex items-center gap-2"><span className="text-[10px] text-slate-400 font-normal">{s.order}ë²ˆ</span> {s.name}</span>
                                                                {selectedStudents.find(sel => sel.id === s.id) && <Icon d={PATHS.check} size={12} className="text-indigo-500 bg-indigo-100 rounded-full p-0.5"/>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-600 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 shadow-sm" />
                                        </div>
                                        
                                        <textarea 
                                            value={notionContent}
                                            onChange={(e) => setNotionContent(e.target.value)}
                                            className="w-full p-3.5 bg-white border border-slate-300 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 resize-none h-24 placeholder-slate-400 shadow-sm"
                                            placeholder="ê´€ì°°í•œ ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”..."
                                        />
                                        
                                        <div className="flex justify-end -mt-1">
                                            <label className="flex items-center gap-1.5 cursor-pointer select-none">
                                                <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5 text-indigo-600 rounded focus:ring-indigo-500" />
                                                <span className="text-[10px] text-slate-500 font-bold hover:text-slate-700">ì €ìž¥ í›„ ë‚´ìš© ìœ ì§€</span>
                                            </label>
                                        </div>
                                        
                                        {notionStatus === 'saving' ? (
                                            <div className="w-full bg-slate-100 rounded-xl h-12 flex items-center justify-center relative overflow-hidden shadow-inner">
                                                <div className="absolute left-0 top-0 h-full bg-indigo-100 transition-all duration-300 ease-out" style={{ width: `${saveProgress}%` }}></div>
                                                <div className="relative z-10 flex items-center gap-2 text-indigo-700 font-bold text-sm">
                                                    <Icon d={PATHS.spinner} className="animate-spin" />
                                                    <span>ì €ìž¥ ì¤‘... {saveProgress}%</span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex gap-2.5">
                                                <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} className="relative flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md whitespace-nowrap bg-rose-500 hover:bg-rose-600 active:scale-95">
                                                    ì¹­ì°¬í•˜ê¸° +1
                                                </button>
                                                <button onClick={() => handleIntegratedSave('ê´€ì°°')} className="flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md whitespace-nowrap bg-indigo-600 hover:bg-indigo-700 active:scale-95">
                                                    ê´€ì°° ê¸°ë¡ ì €ìž¥
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Logs Search & Accordion */}
                                    <div className="mb-4 flex gap-2 relative">
                                        
                                        {/* 1. í…ìŠ¤íŠ¸ ê²€ìƒ‰ì°½ */}
                                        <div className="relative flex-1">
                                            <Icon d={PATHS.search} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                                            <input
                                                type="text"
                                                value={searchTerm}
                                                onChange={e => setSearchTerm(e.target.value)}
                                                placeholder="ë‚´ìš© ë˜ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒ..."
                                                className="w-full pl-9 pr-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none transition-colors"
                                            />
                                        </div>
                                        
                                        {/* 2. ë‹¬ë ¥ ì—¬ëŠ” ë²„íŠ¼ */}
                                        <button
                                            onClick={() => setShowSearchCal(!showSearchCal)}
                                            className="p-2 border border-slate-200 bg-slate-50 rounded-xl hover:bg-indigo-50 text-slate-500 transition-colors"
                                            title="ë‹¬ë ¥ìœ¼ë¡œ ë‚ ì§œ ì°¾ê¸°"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </button>

                                        {/* 3. íŠ¹ì • ë‚ ì§œ ì„ íƒ ì‹œ ì·¨ì†Œ(X) ë²„íŠ¼ (í•„ìˆ˜ ë³µêµ¬!) */}
                                        {selectedDate && (
                                            <button onClick={() => setSelectedDate(null)} className="px-3 py-2 bg-indigo-50 border border-indigo-100 text-indigo-600 rounded-xl text-xs font-bold whitespace-nowrap flex items-center gap-1 hover:bg-indigo-100 transition-colors">
                                                {dayjs(selectedDate).format('MM/DD')} <Icon d={PATHS.x} size={12}/>
                                            </button>
                                        )}

                                        {/* 4. ë¯¸ë‹ˆ íŒì—… ë‹¬ë ¥ */}
                                        {showSearchCal && (
                                            <div className="absolute top-12 right-0 mt-1 bg-white border border-slate-100 shadow-2xl shadow-indigo-100/50 rounded-3xl p-4 z-50 w-72 animate-fade-in">
                                                <div className="flex justify-between items-center mb-4 px-1">
                                                    <button onClick={() => setCalMonth(calMonth.subtract(1, 'month'))} className="p-1.5 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors"><Icon d={PATHS.left} size={16} /></button>
                                                    <span className="font-extrabold text-sm text-slate-800">{calMonth.format('YYYYë…„ Mì›”')}</span>
                                                    <button onClick={() => setCalMonth(calMonth.add(1, 'month'))} className="p-1.5 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors"><Icon d={PATHS.right} size={16} /></button>
                                                </div>
                                                <div className="grid grid-cols-7 mb-2 text-center">
                                                    {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((d, i) => (
                                                        <div key={d} className={`text-[10px] font-bold pb-1 ${i === 0 ? 'text-red-400' : i === 6 ? 'text-blue-400' : 'text-slate-400'}`}>{d}</div>
                                                    ))}
                                                </div>
                                                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                                                    {Array.from({ length: calMonth.startOf('month').day() }).map((_, i) => <div key={`empty-${i}`} />)}
                                                    {Array.from({ length: calMonth.daysInMonth() }).map((_, i) => {
                                                        const dateStr = calMonth.date(i + 1).format('YYYY-MM-DD');
                                                        const hasRecord = recordDates.includes(dateStr); 
                                                        const isSelected = searchTerm === dateStr;
                                                        const isToday = dateStr === dayjs().format('YYYY-MM-DD');
                                                        
                                                        let cellClass = "aspect-square flex flex-col items-center justify-center rounded-full text-xs font-medium cursor-pointer transition-all duration-200 relative group";
                                                        if (isSelected) cellClass += " bg-indigo-600 text-white shadow-md shadow-indigo-200 font-bold transform scale-105 z-10";
                                                        else if (isToday) cellClass += " text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100";
                                                        else cellClass += " text-slate-600 hover:bg-slate-100";

                                                        return (
                                                            <button
                                                                key={i}
                                                                onClick={() => {
                                                                    setSearchTerm(dateStr); 
                                                                    setShowSearchCal(false); 
                                                                }}
                                                                className={cellClass}
                                                            >
                                                                <span>{i + 1}</span>
                                                                {hasRecord && !isSelected && <div className={`absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full ${isToday ? 'bg-indigo-400' : 'bg-blue-400'}`}></div>}
                                                                {isSelected && (
                                                                    <div className="absolute -top-0.5 -right-0.5 bg-white text-indigo-600 rounded-full p-[1px] shadow-sm animate-bounce-in z-20"><Icon d={PATHS.check} size={8} strokeWidth={4} /></div>
                                                                )}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 overflow-y-auto custom-scroll pr-1 max-h-[400px]">
                                        {displayedNotes.length > 0 ? (
    <div className="relative space-y-7 py-2">
        {Object.entries(displayedNotes.reduce((acc, note) => {
            if (!acc[note.date]) acc[note.date] = [];
            acc[note.date].push(note);
            return acc;
        }, {})).sort((a, b) => b[0].localeCompare(a[0])).map(([date, groupNotes], dateIndex, dateArray) => {
            
            const isLastDate = dateIndex === dateArray.length - 1;

            const isExpanded = expandedDates[date];
            const showExpandBtn = groupNotes.length > 2;
            const visibleNotes = showExpandBtn && !isExpanded ? groupNotes.slice(0, 2) : groupNotes;

            return (
                <div key={date} className="flex w-full">
                    
                    {/* ðŸ”µ 1. ë‚ ì§œ ì˜ì—­ (ì¢Œì¸¡) */}
                    <div className="w-12 flex flex-col items-end shrink-0 pt-1 pr-1.5">
                        <div className="text-xs font-bold text-slate-600 text-right leading-tight">
                            {dayjs(date).format('MM.DD')}
                            <br/>
                            <span className="text-[10px] text-slate-400">{dayjs(date).format('dddd')}</span>
                        </div>
                    </div>

                    {/* ðŸ”µ 2. íƒ€ìž„ë¼ì¸ ì˜ì—­ (ì¤‘ì•™) */}
                    <div className="relative w-3 flex flex-col items-center shrink-0 pt-1.5">
                        <div className="w-2 h-2 rounded-full bg-indigo-400 z-10 shadow-sm border-2 border-white"></div>
                        
                        {!isLastDate && (
                            <div className="absolute top-2.5 bottom-[-40px] w-[1.5px] bg-indigo-200"></div>
                        )}
                    </div>

                    {/* ðŸ”µ 3. ë‚´ìš© ì˜ì—­ (ìš°ì¸¡) */}
                    <div className="flex-1 pl-2 pr-2">
                        {visibleNotes.map((note, noteIndex) => {
                            const isLastVisible = noteIndex === visibleNotes.length - 1;
                            const isEditing = editingNoteId === note.id;

                            return (
                                <div key={note.id} className="flex flex-col">
                                    
                                    {isEditing ? (
                                        <div className="w-full bg-white border-2 border-indigo-400 rounded-xl p-3 shadow-md animate-fade-in mb-2">
                                            <div className="flex flex-wrap gap-1.5 mb-2">
                                                <span className="text-xs px-2.5 py-1 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                                    {student.name}
                                                </span>
                                                {editRelatedStudents.map(s => (
                                                    <span key={s.id} className="text-xs px-2.5 py-1 rounded-full flex items-center gap-1.5 border bg-white text-slate-600 border-slate-200 font-bold shadow-sm">
                                                        {s.name}
                                                        <button onClick={() => handleRemoveEditStudent(s.id)} className="hover:text-rose-500"><Icon d={PATHS.x} size={10}/></button>
                                                    </span>
                                                ))}
                                                <div className="relative">
                                                    <input 
                                                        placeholder="+ í•™ìƒ ì¶”ê°€" 
                                                        className="w-24 p-1 text-xs border-b border-slate-300 outline-none focus:border-indigo-500 bg-transparent"
                                                        value={editSearchText}
                                                        onChange={(e) => { setEditSearchText(e.target.value); setShowEditStudentDropdown(true); }}
                                                        onFocus={() => setShowEditStudentDropdown(true)}
                                                        onBlur={() => setTimeout(() => setShowEditStudentDropdown(false), 200)}
                                                    />
                                                    {showEditStudentDropdown && (
                                                        <div className="absolute top-full left-0 w-48 bg-white shadow-xl border border-slate-200 rounded-lg z-50 max-h-32 overflow-y-auto mt-1 custom-scroll">
                                                            {students.filter(s => s.name.includes(editSearchText) && s.id !== student.id && !editRelatedStudents.some(rs => rs.id === s.id)).map(s => (
                                                                <div key={s.id} className="px-3 py-2 text-xs hover:bg-indigo-50 cursor-pointer font-bold" onMouseDown={() => handleAddEditStudent(s)}>
                                                                    {s.name}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <textarea 
                                                value={editNoteContent}
                                                onChange={(e) => setEditNoteContent(e.target.value)}
                                                className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500 resize-none h-24 mb-2"
                                            />
                                            <div className="flex justify-end gap-2">
                                                <Btn onClick={() => { setEditingNoteId(null); setEditNoteContent(""); setEditRelatedStudents([]); }} className="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                                                <Btn onClick={saveEditing} className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 shadow-sm">ì €ìž¥</Btn>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="group w-full bg-white border border-slate-200 rounded-xl p-3 text-xs text-slate-700 shadow-sm hover:border-indigo-300 transition-colors">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex flex-wrap gap-1.5 flex-1 items-center">
                                                    {note.destTags && note.destTags.map((tag, idx) => {
                                                        let colorClass = "bg-white border-slate-200 text-slate-500";
                                                        if (tag === 'ë…¸ì…˜(ê¸°ë¡)') colorClass = "bg-blue-50 border-blue-100 text-blue-600";
                                                        else if (tag === 'ë…¸ì…˜(í¬í´)') colorClass = "bg-yellow-50 border-yellow-100 text-yellow-700";
                                                        else if (tag === 'êµ¬ê¸€ ì‹œíŠ¸') colorClass = "bg-green-50 border-green-100 text-green-600";
                                                        return <span key={idx} className={`px-1.5 py-0.5 border text-[8px] rounded-full font-bold shadow-sm ${colorClass}`}>{tag}</span>;
                                                    })}
                                                    {(() => {
                                                        const related = note.relatedStudents ? note.relatedStudents.filter(s => s.id !== student.id) : [];
                                                        if (related.length === 0) return null;
                                                        return (
                                                            <div className="flex items-center gap-1 flex-wrap">
                                                                <span className="text-[8px] text-slate-400">with</span>
                                                                {related.map((s, idx) => (
                                                                    <div key={idx} className="flex items-center">
                                                                        <span className="px-1.5 py-0.5 bg-slate-100 text-slate-600 text-[8px] rounded-full font-bold cursor-pointer hover:bg-slate-200 border border-slate-200" onClick={(e) => { e.stopPropagation(); onSwitchStudent(s.id); }}>
                                                                            {s.name}
                                                                        </span>
                                                                        {idx < related.length - 1 && <span className="text-[8px] text-slate-400 ml-0.5">,</span>}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 shrink-0 ml-2">
                                                    <button onClick={() => startEditing(note)} className="p-1 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors" title="ìˆ˜ì •">
                                                        <Icon d={PATHS.edit} size={14} />
                                                    </button>
                                                    <button onClick={() => handleDeleteNote(note.id)} className="p-1 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-md transition-colors" title="ì‚­ì œ">
                                                        <Icon d={PATHS.trash} size={14} />
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="whitespace-pre-wrap leading-relaxed">
                                                {note.content}
                                            </div>
                                        </div>
                                    )}

                                    {/* ë°•ìŠ¤ë“¤ ì‚¬ì´ ì¤‘ê°„ ì ì„  (í…Œë‘ë¦¬ì™€ ë™ì¼í•œ slate-200) */}
                                    {!isLastVisible && (
                                        <div className="flex justify-center w-full py-1">
                                            <div className="h-5 border-l-2 border-dashed border-slate-200"></div>
                                        </div>
                                    )}

                                </div>
                            );
                        })}
                        {showExpandBtn && (
                            <button 
                                onClick={() => setExpandedDates(prev => ({ ...prev, [date]: !prev[date] }))}
                                className="w-full py-2 text-xs font-bold text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors flex items-center justify-center gap-1 mt-2"
                            >
                                {isExpanded ? (
                                    <>ì ‘ê¸° <Icon d={PATHS.down} size={12} className="rotate-180" /></>
                                ) : (
                                    <>+{groupNotes.length - 2}ê°œ ë” ë³´ê¸° <Icon d={PATHS.down} size={12} /></>
                                )}
                            </button>
                        )}
                    </div>
                </div>
            );
        })}
    </div>
) : (
                                            <div className="h-32 flex flex-col items-center justify-center text-slate-400 text-sm gap-3 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                                                <Icon d={PATHS.document} size={24} className="opacity-30" />
                                                <span>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                            </div>
                                        )}
                                        {hasMore && (
                                            <button onClick={() => setIsExpanded(!isExpanded)} className="w-full py-3 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-3 shadow-sm">
                                                {isExpanded ? 'ì ‘ê¸°' : `ê³¼ê±° ê¸°ë¡ ${filteredNotes.length - 2}ê°œ ë” ë³´ê¸°`} 
                                                <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {/* [ìˆ˜ì •ë¨] Grass Chart Area - 5x5 ë‹¬ë ¥í˜• ë° ì˜¤ëŠ˜ ë‚ ì§œ í…Œë‘ë¦¬ ê°•ì¡° */}
                                <div className="bg-white p-6 border border-slate-100 rounded-3xl shadow-xl shadow-indigo-50/50 overflow-hidden">
                                    {/* [New] Grid Overlay êµ¬ì¡°ë¡œ ë³€ê²½í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¼ì´ë“œ êµ¬í˜„ */}
                                    <div className="grid grid-cols-1 grid-rows-1">
                                        
                                        {/* 1. ìƒì„¸ ë·° (Detail View) - ì˜¤ë¥¸ìª½ì—ì„œ ë“¤ì–´ì˜´ */}
                                        <div className={`col-start-1 row-start-1 w-full transition-all duration-300 ease-in-out transform ${isDetailViewOpen ? 'translate-x-0 opacity-100 visible' : 'translate-x-full opacity-0 invisible pointer-events-none'}`}>
                                            {(selectedGrassDate || cachedDetailDate) && (() => {
                                                const detailDate = selectedGrassDate || cachedDetailDate;
                                                return (
                                                    <>
                                                        <div className="flex items-center justify-between mb-6">
                                                            <button onClick={() => setIsDetailViewOpen(false)} className="p-2 hover:bg-slate-100 rounded-xl text-slate-500 transition-colors flex items-center gap-1 text-xs font-bold bg-slate-50 border border-slate-200 whitespace-nowrap">
                                                                <Icon d={PATHS.left} size={14} /> ëª©ë¡ìœ¼ë¡œ
                                                            </button>
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-8 h-8 rounded-full shadow-inner flex items-center justify-center relative overflow-hidden bg-slate-100" style={getPieStyle(grassHistory.find(h => h.date === detailDate)?.ratio || 0)}></div>
                                                                <span className="text-base font-extrabold text-slate-800 whitespace-nowrap">{dayjs(detailDate).format('Mì›” Dì¼ (ddd)')}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="space-y-6">
                                                            <div>
                                                                <div className="flex items-center gap-2 mb-3">
                                                                    <div className="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg"><Icon d={PATHS.check} size={14} strokeWidth={3} /></div>
                                                                    <h4 className="text-sm font-bold text-slate-700">ê³¼ì œ ìˆ˜í–‰ í˜„í™©</h4>
                                                                </div>
                                                                {(dailyTasks[detailDate] || []).length > 0 ? (
                                                                    <div className="space-y-2">
                                                                        {(dailyTasks[detailDate] || []).map((t, i) => {
                                                                            const title = typeof t === 'object' ? t.title : t;
                                                                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                                                                            const rec = records[detailDate]?.[student.id];
                                                                            const isDone = rec ? (rec.tasks ? rec.tasks[i] : rec.done) : false;
                                                                            return (
                                                                                <div key={i} className={`flex items-center justify-between p-3 rounded-2xl border transition-all ${isDone ? 'bg-indigo-50/50 border-indigo-100' : 'bg-white border-slate-100'}`}>
                                                                                    <div className="flex items-center gap-3 overflow-hidden w-full">
                                                                                        <div className={`w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 border transition-colors ${isDone ? 'bg-indigo-500 border-indigo-500 text-white' : 'bg-white border-slate-300'}`}>
                                                                                            {isDone && <Icon d={PATHS.check} size={12} strokeWidth={4} />}
                                                                                        </div>
                                                                                        <div className="flex flex-col min-w-0 flex-1">
                                                                                            <div className="flex items-center gap-1.5 mb-0.5"><span className="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded font-bold">{tag}</span></div>
                                                                                            <span className={`text-sm truncate ${isDone ? 'text-slate-700 font-bold' : 'text-slate-500'}`}>{title}</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                ) : (
                                                                    <div className="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-2xl border border-dashed border-slate-200 flex flex-col items-center gap-2"><span className="text-2xl opacity-50">ðŸ“­</span><span>ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</span></div>
                                                                )}
                                                            </div>
                                                            {notes.filter(n => n.date === detailDate).length > 0 && (
                                                                <div>
                                                                    <div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-yellow-100 text-yellow-600 rounded-lg"><Icon d={PATHS.edit} size={14} strokeWidth={3} /></div><h4 className="text-sm font-bold text-slate-700">ê´€ì°° ë° ìƒë‹´</h4></div>
                                                                    <div className="space-y-2">{notes.filter(n => n.date === detailDate).map(n => (<div key={n.id} className="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap shadow-sm relative overflow-hidden"><div className="absolute top-0 left-0 w-1 h-full bg-yellow-300"></div>{n.content}</div>))}</div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>

                                        {/* 2. ëª©ë¡ ë·° (List View) - ì™¼ìª½ìœ¼ë¡œ ë‚˜ê° */}
                                        <div className={`col-start-1 row-start-1 w-full transition-all duration-300 ease-in-out transform ${isDetailViewOpen ? '-translate-x-full opacity-0 invisible pointer-events-none' : 'translate-x-0 opacity-100 visible'}`}>
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 sm:gap-0">
                                                <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2 whitespace-nowrap">
                                                    <Icon d={PATHS.calendar} size={16} className="text-orange-500"/> í™œë™ ìž”ë”” 
                                                    <span className="text-indigo-600 font-extrabold text-xs bg-indigo-50 px-2 py-0.5 rounded-md whitespace-nowrap">{dayjs(grassStart).format('YYYYë…„ Mì›”')}</span>
                                                    <div className="relative ml-1 flex items-center">
                                                        <button onClick={(e) => { e.stopPropagation(); setShowThemePicker(!showThemePicker); }} className="p-1.5 hover:bg-slate-100 rounded-full transition-colors" title="ê°•ì¡° ìƒ‰ìƒ ë³€ê²½">
                                                            <div className={`w-4 h-4 rounded-full ${GRASS_THEMES[grassTheme].bg} border-2 ${GRASS_THEMES[grassTheme].border}`}></div>
                                                        </button>
                                                        {showThemePicker && (
                                                            <div className="absolute top-full left-0 mt-2 bg-white p-2 rounded-xl shadow-xl border border-slate-100 z-50 flex gap-1.5 animate-fade-in w-max" onClick={(e) => e.stopPropagation()}>
                                                                {Object.entries(GRASS_THEMES).map(([key, theme]) => (
                                                                    <button key={key} onClick={() => { setGrassTheme(key); localStorage.setItem('cls_grass_theme', key); setShowThemePicker(false); }} className={`w-6 h-6 rounded-full ${theme.bg} border-2 ${theme.border} hover:scale-110 transition-transform ring-1 ring-offset-1 ${grassTheme === key ? 'ring-slate-400' : 'ring-transparent'}`}></button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </h4>
                                                <div className="flex flex-col items-end sm:items-center gap-1 w-full sm:w-auto">
                                                    <div className="flex gap-1 bg-slate-100 p-1 rounded-lg w-full sm:w-auto justify-center sm:justify-start">
                                                        <button onClick={() => { const prev = dayjs(grassStart).subtract(1, 'month'); setGrassStart(prev.startOf('month').format('YYYY-MM-DD')); setGrassEnd(prev.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.left} size={12}/></button>
                                                        <button onClick={() => { const now = dayjs(); setGrassStart(now.startOf('month').format('YYYY-MM-DD')); setGrassEnd(now.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(false); setDateRangeAnim(true); setTimeout(() => setDateRangeAnim(false), 500); }} className="text-[10px] px-2.5 py-1 rounded-md font-bold text-slate-600 hover:bg-white shadow-sm transition-all whitespace-nowrap">ì´ë²ˆ ë‹¬</button>
                                                        <button onClick={() => { const next = dayjs(grassStart).add(1, 'month'); setGrassStart(next.startOf('month').format('YYYY-MM-DD')); setGrassEnd(next.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.right} size={12}/></button>
                                                        <button onClick={() => setIsCalendarOpen(true)} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all ml-1" title="ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={12}/></button>
                                                    </div>
                                                    <span className={`text-[10px] text-slate-400 font-medium transition-all duration-300 whitespace-nowrap ${dateRangeAnim ? 'text-indigo-600 font-bold scale-110' : ''}`}>{dayjs(grassStart).format('YY.MM.DD')} ~ {dayjs(grassEnd).format('YY.MM.DD')}</span>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-5 gap-y-6 gap-x-2 justify-items-center py-4 mt-2">
                                                {displayedGrass.map((h, i) => {
                                                    const isToday = h.date === todayStr;
                                                    const theme = GRASS_THEMES[grassTheme];
                                                    // [New] íˆ´íŒ ìœ„ì¹˜ ì¡°ì • (ê°€ìž¥ìžë¦¬ ìž˜ë¦¼ ë°©ì§€)
                                                    const colIndex = i % 5;
                                                    let tooltipPos = "left-1/2 -translate-x-1/2";
                                                    let arrowPos = "left-1/2 -translate-x-1/2";
                                                    if (colIndex === 0) { tooltipPos = "left-0"; arrowPos = "left-6"; }
                                                    else if (colIndex === 4) { tooltipPos = "right-0"; arrowPos = "right-6"; }

                                                    return (
                                                    <div key={i} onClick={() => { setSelectedGrassDate(h.date); setIsDetailViewOpen(true); }} className={`flex flex-col items-center gap-0.5 group relative cursor-pointer p-2 rounded-2xl transition-all duration-200 ease-out ${selectedGrassDate === h.date ? `${isToday ? theme.bg : 'bg-white'} border-2 ${isToday ? theme.border : 'border-indigo-100'} scale-100 md:scale-105 shadow-md z-20` : (isToday ? `${theme.bg} border-2 ${theme.border} shadow-md scale-100 md:scale-110 hover:scale-105 md:hover:scale-115 z-10` : 'hover:bg-slate-50 border-2 border-transparent hover:border-slate-100 hover:scale-110 hover:shadow-lg hover:z-30')}`}>
                                                        <div className={`w-12 h-12 rounded-full shadow-inner flex items-center justify-center relative overflow-hidden bg-slate-100 ${isToday ? `ring-4 ${theme.ring} ring-offset-2` : ''}`} style={getPieStyle(h.ratio)}></div>
                                                        <span className={`text-xs ${isToday ? `${theme.text} font-black` : selectedGrassDate === h.date ? 'text-slate-800 font-bold' : 'text-slate-500 font-medium'}`}>{dayjs(h.date).format('MM/DD')}</span>
                                                        <div className={`absolute bottom-full mb-2 z-50 w-max bg-slate-900 text-white rounded-xl px-3 py-2 shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-y-1 group-hover:translate-y-0 pointer-events-none flex items-center gap-3 ${tooltipPos}`}>
                                                            <span className="text-[10px] text-slate-400 font-medium whitespace-nowrap">{dayjs(h.date).format('YYYY.MM.DD (ddd)')}</span>
                                                            <div className="w-px h-3 bg-slate-700"></div>
                                                            <div className="flex items-center gap-2 justify-center whitespace-nowrap">
                                                                <div className={`w-2 h-2 rounded-full ${h.ratio === 1 ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]' : h.ratio > 0 ? 'bg-yellow-400' : 'bg-slate-600'}`}></div>
                                                                <span className="text-xs font-bold">{Math.round(h.ratio * 100)}%</span>
                                                                <span className="text-[10px] text-slate-500 font-medium">({h.count}/{h.total})</span>
                                                            </div>
                                                            <div className={`absolute top-full border-[6px] border-transparent border-t-slate-900 ${arrowPos}`}></div>
                                                        </div>
                                                    </div>
                                                )})}
                                            </div>
                                            {grassHistory.length > 5 && (
                                                <button onClick={() => setIsGrassExpanded(!isGrassExpanded)} className="w-full py-2 text-xs font-bold text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-4 shadow-sm">
                                                    {isGrassExpanded ? 'ì´ë²ˆ ì£¼ë§Œ ë³´ê¸°' : 'ì´ë²ˆ ë‹¬ ì „ì²´ ë³´ê¸°'}
                                                    <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isGrassExpanded ? 'rotate-180' : ''}`} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        {/* ìˆ¨ê²¨ì§„ ë¦¬í¬íŠ¸ ëª¨ë‹¬, AI ëª¨ë‹¬ ë“± ëª¨ë‘ ìœ ì§€ */}
                        <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                            <div ref={reportRef} className={`w-[800px] bg-white p-12 border border-slate-200 text-slate-800 ${reportFont === 'serif' ? 'font-serif' : reportFont === 'hand' ? 'font-hand' : reportFont === 'jua' ? 'font-jua' : reportFont === 'nanum' ? 'font-nanum' : reportFont === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                                <div className="text-center border-b-2 border-slate-800 pb-6 mb-8">
                                    <h1 className="text-4xl font-extrabold text-slate-900 mb-2">ðŸŒ± í•™ìŠµ ì„±ìž¥ ë¦¬í¬íŠ¸</h1>
                                    <p className="text-slate-500 text-lg">{dayjs().format('YY.MM.DD')}</p>
                                </div>
                                <div className="flex gap-8 mb-8">
                                    <div className="w-32 h-32 rounded-full bg-slate-100 border-4 border-slate-200 overflow-hidden flex items-center justify-center flex-shrink-0">
                                        <span className="text-6xl">{student.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§'}</span>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center">
                                        <div className="flex items-baseline gap-3 mb-2"><h2 className="text-3xl font-bold text-slate-800">{student.name}</h2><span className="text-xl text-slate-500">{student.order}ë²ˆ</span></div>
                                        <div className="flex gap-4"><span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-bold">Lv.{level}</span><span className="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span><span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg font-bold">ì¹­ì°¬ ìŠ¤í‹°ì»¤ {stickerCount}ê°œ</span></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-8 mb-8">
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ðŸ“Š í™œë™ ë¶„ì„</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center"><span className="text-slate-600">ìµœê·¼ 30ì¼ í™œë™</span><span className="font-bold text-indigo-600">{student.history.length}ì¼ ì¤‘ {student.history.filter(h=>h.ratio===1).length}ì¼ ì™„ë£Œ</span></div>
                                            <div><span className="text-slate-600 block mb-1">ìžì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</span>{missedTags.length > 0 ? (<div className="flex gap-2 flex-wrap">{missedTags.map(([t, c]) => <span key={t} className="text-xs bg-white border border-slate-200 px-2 py-1 rounded-md text-rose-500 font-bold">{t} ({c}íšŒ)</span>)}</div>) : <span className="text-sm text-green-600 font-bold">ì—†ìŒ (í›Œë¥­í•´ìš”!)</span>}</div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-100">
                                            <h4 className="text-sm font-bold text-slate-600 mb-2">ðŸ“Š í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                            <div className="space-y-2">
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">{student.name}</span><span className={`font-bold ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${getLevelColor(level)}`} style={{ width: `${reportStats.studentRate}%` }}></div></div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">í•™ê¸‰ í‰ê· </span><span className="font-bold text-slate-600">{reportStats.classRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-400" style={{ width: `${reportStats.classRate}%` }}></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ðŸ“ ì„ ìƒë‹˜ì˜ í•œë§ˆë””</h3>
                                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{aiComment || "ë¶„ì„ ì¤‘..."}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showCounselingAI && (
                            <CounselingAIModal isOpen={showCounselingAI} onClose={() => setShowCounselingAI(false)} student={student} students={students} apiKey={apiKey} showToast={showToast} onSave={handleSaveAIAdvice} notes={notes} />
                        )}

                        {showStudentRecordAI && (
                            <StudentRecordAIModal isOpen={showStudentRecordAI} onClose={() => setShowStudentRecordAI(false)} student={student} students={students} apiKey={apiKey} showToast={showToast} notes={notes} dailyTasks={dailyTasks} records={records} appConfig={appConfig} onSaveDraft={onSaveRecordDraft} />
                        )}

                        {showReportEdit && (
                            <div className="fixed inset-0 bg-black/50 z-[1700] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={() => setShowReportEdit(false)}>
                                <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon d={PATHS.edit} className="text-indigo-500" /> ë¦¬í¬íŠ¸ ìž‘ì„±</h3>
                                        <button onClick={() => setShowReportEdit(false)} className="p-2 hover:bg-slate-100 rounded-full"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                            <input type="date" value={reportStart} onChange={e=>setReportStart(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                            <span className="text-xs text-slate-400">~</span>
                                            <input type="date" value={reportEnd} onChange={e=>setReportEnd(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ìƒë‹´ ëª©ì  (Purpose)</label>
                                                <select value={reportPurpose} onChange={e=>setReportPurpose(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="regular">ðŸ“… ì •ê¸° ìƒë‹´ (ì„±ìž¥ ê³µìœ )</option><option value="issue">â¤ï¸ ìƒí™œ ì§€ë„ (ë¬¸ì œ ê°œì„ )</option><option value="study">ðŸ“š í•™ì—… ìƒë‹´ (ì„±ì  í–¥ìƒ)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ë¦¬í¬íŠ¸ ì–´ì¡° (Tone)</label>
                                                <select value={reportTone} onChange={e=>setReportTone(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="warm">ðŸ¥° ë”°ëœ»/ì¹­ì°¬ (ê¸°ë³¸)</option><option value="rational">ðŸ“Š ê°ê´€/ë¶„ì„</option><option value="coaching">ðŸ”¥ ì„±ìž¥/ì½”ì¹­</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ê¸€ê¼´ (Font)</label>
                                                <select value={reportFont} onChange={e=>setReportFont(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="sans">ê¸°ë³¸ ê³ ë”•</option><option value="nanum">ë‚˜ëˆ”ê³ ë”•</option><option value="nanum-bold">ë‚˜ëˆ”ê³ ë”• (Bold)</option><option value="serif">ë‚˜ëˆ”ëª…ì¡°</option><option value="jua">ì£¼ì•„ì²´</option><option value="hand">ê°œêµ¬ì²´ (ì†ê¸€ì”¨)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ì¤‘ì  ë¶„ì„ ë¶„ì•¼ (Focus)</label>
                                                <select value={reportFocus} onChange={e=>setReportFocus(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="comprehensive">ðŸ« í•™êµìƒí™œ ì¢…í•©</option><option value="study">ðŸ“ í•™ìŠµ íƒœë„</option><option value="relationship">ðŸ¤ êµìš° ê´€ê³„</option><option value="habit">â° ìƒí™œ ìŠµê´€</option></select>
                                            </div>
                                        </div>
                                        <Btn onClick={generateReportContent} disabled={isGenerating} className={`w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 ${apiKey ? 'bg-violet-100 text-violet-700 hover:bg-violet-200' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                                            {isGenerating ? 'ìž‘ì„± ì¤‘...' : apiKey ? 'âœ¨ AIë¡œ ë¦¬í¬íŠ¸ ìƒˆë¡œ ìž‘ì„±í•˜ê¸°' : 'ðŸ”„ ê¸°ê°„ ì„¤ì • ì ìš©í•˜ì—¬ ë‹¤ì‹œ ì“°ê¸°'}
                                        </Btn>
                                        {!apiKey && <div className="text-[10px] text-slate-400 mt-1 text-center">* ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ìž…ë ¥í•˜ë©´ AIê°€ ë” í’ì„±í•œ ë‚´ìš©ì„ ìž‘ì„±í•´ì¤ë‹ˆë‹¤.</div>}
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-end px-1">
                                            <div className="flex gap-2 items-center">
                                                <span className="text-xs font-bold text-slate-500">ë‚´ìš© íŽ¸ì§‘</span>
                                                <div className="relative">
                                                    <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                                        <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                                    </button>
                                                    {showPhraseList && (
                                                        <div className="absolute left-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                            <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                                <span className="text-xs font-bold text-slate-600">ì €ìž¥ëœ ë¬¸êµ¬</span>
                                                                <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">í˜„ìž¬ ë‚´ìš© ì €ìž¥</button>
                                                            </div>
                                                            <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                                {phrases.length > 0 ? phrases.map((p, i) => (
                                                                    <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                                        <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                                    </div>
                                                                )) : <div className="text-center text-slate-400 text-xs py-2">ì €ìž¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <button onClick={() => { let comment = `${student.name} í•™ìƒì€ í˜„ìž¬ ë ˆë²¨ ${level}ë¡œ, í‰ê·  ìˆ˜í–‰ë¥  ${avgRate}%ë¥¼ ê¸°ë¡í•˜ë©° ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ${missedTags.length > 0 ? `íŠ¹ížˆ ${missedTags.map(t=>t[0]).join(', ')} ê³¼ëª©ì— ì¡°ê¸ˆ ë” ê´€ì‹¬ì„ ê¸°ìš¸ì¸ë‹¤ë©´ ë”ìš± ì„±ìž¥í•  ìˆ˜ ìžˆì„ ê²ƒìž…ë‹ˆë‹¤.` : "ëª¨ë“  ê³¼ëª©ì—ì„œ ê³ ë¥´ê²Œ ìš°ìˆ˜í•œ ëª¨ìŠµì„ ë³´ì´ê³  ìžˆìŠµë‹ˆë‹¤."} ê°€ì •ì—ì„œë„ ë§Žì€ ì¹­ì°¬ê³¼ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`; setTempComment(comment); }} className="text-[10px] text-slate-400 hover:text-rose-500 underline">ì´ˆê¸°í™”</button>
                                        </div>
                                        <textarea className="w-full h-48 p-4 border border-slate-200 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none custom-scroll" value={tempComment} onChange={(e) => setTempComment(e.target.value)} placeholder="ë¦¬í¬íŠ¸ì— ë“¤ì–´ê°ˆ ë‚´ìš©ì„ ìž‘ì„±í•´ì£¼ì„¸ìš”." />
                                        <div className="flex gap-2">
                                            <Btn onClick={handleSaveReportDraft} className="flex-1 py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.check} /> ì´ˆì•ˆ ì €ìž¥</Btn>
                                            <Btn onClick={handleCopyText} className="flex-1 py-3 bg-white border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.copy} /> í…ìŠ¤íŠ¸ ë³µì‚¬</Btn>
                                            <Btn onClick={handleDownloadReport} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Icon d={PATHS.download} /> ì´ë¯¸ì§€ë¡œ ì €ìž¥</Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isCalendarOpen && (
                            <CalendarModal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} currentDate={grassStart} selectionMode="range" onSelectRange={(s, e) => { setGrassStart(s); setGrassEnd(e); }} records={records} appConfig={appConfig} groupsByDate={{}} mode="record" />
                        )}
                    </div>
                </div>
            );
        };
        const StudentRecordAIModal = ({ isOpen, onClose, student, students, apiKey, showToast, notes, dailyTasks, records, appConfig, onSaveDraft }) => {
            const [draft, setDraft] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [keywords, setKeywords] = useState("");
            const [recordType, setRecordType] = useState("behavior"); // behavior (í–‰ë°œ), subject (êµê³¼)
            const contentRef = useRef(null);
            const [semester, setSemester] = useState("1"); // 1, 2, all
            const [progress, setProgress] = useState(0);
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_behavior_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const textareaRef = useRef(null);
            const [showPromptSettings, setShowPromptSettings] = useState(false);
            const [behaviorTemplate, setBehaviorTemplate] = useState("");
            const [subjectTemplate, setSubjectTemplate] = useState("");

            const DEFAULT_BEHAVIOR_TEMPLATE = `{{security_rule}}

# Role
ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ìž ë‹´ìž„ êµì‚¬ìž…ë‹ˆë‹¤. í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³ , í•™ìƒì˜ ì „ì¸ì  ì„±ìž¥ì„ ë•ëŠ” 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬(ì´í‰)'ì„ ìž‘ì„±í•©ë‹ˆë‹¤.

# Strict Guidelines (ìž‘ì„± ì›ì¹™)
1. **Fact-Based**: ë°˜ë“œì‹œ ì œê³µëœ [êµì‚¬ ê´€ì°° ê¸°ë¡]ì— ìžˆëŠ” ë‚´ìš©ë§Œìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”.
2. **Data Validation**: ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ìž‘ì„±í•˜ê¸°ì— ì •ë³´ê°€ í˜„ì €ížˆ ë¶€ì¡±í•˜ë‹¤ë©´, ì–µì§€ë¡œ ë‚´ìš©ì„ ë§Œë“¤ì§€ ë§ê³  "ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì„ ë” ìž…ë ¥í•´ì£¼ì„¸ìš”."ë¼ê³ ë§Œ ì¶œë ¥í•˜ê³  ìž‘ì„±ì„ ì¤‘ë‹¨í•˜ì„¸ìš”.
3. **Subject**: ë¬¸ìž¥ì˜ ì£¼ì–´ëŠ” ë°˜ë“œì‹œ 'í•™ìƒ'ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (êµì‚¬ì˜ ê´€ì°°, ê²½í—˜, ê°ì •ì´ ì£¼ì–´ê°€ ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜)
4. **Tone**: ê³µì‹ ë¬¸ì„œ(ìƒí™œê¸°ë¡ë¶€)ì´ë¯€ë¡œ ì§€ë‚˜ì¹˜ê²Œ ë¬¸í•™ì ì¸ í‘œí˜„ì€ ìžì œí•˜ê³ , ëª…í™•í•˜ê³  ì •ì¤‘í•œ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
5. **Growth Focus**: ì „ë…„/ì „í•™ê¸°ì— ë¹„í•´ ì˜ì , ì¸ì§€ì , ì •ì„œì , í•™ìŠµì , ì‚¬íšŒë„ë•ì , ì‹ ì²´ì  ë¶€ë¶„ì—ì„œ ì–´ë–¤ ì„±ìž¥ì´ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ ë“œëŸ¬ë‚˜ë„ë¡ ê¸°ìˆ í•˜ì„¸ìš”.
{{length_constraint}}

# Writing Structure (ìž‘ì„± ìˆœì„œ)
ë‹¤ìŒ ìˆœì„œì™€ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í•˜ë‚˜ì˜ ì™„ì„±ëœ ê¸€ë¡œ ìž‘ì„±í•˜ì„¸ìš”.
1. **í•µì‹¬ íŠ¹ì„±**: ì „ì²´ ì£¼ì œì–´ê°€ ë ë§Œí•œ í•µì‹¬ íŠ¹ì„±ì„ ìˆ˜ì‹ì–´ë¡œ ì‚¬ìš©í•˜ì—¬ í•™ìƒì„ ì†Œê°œí•˜ëŠ” ì²« ë¬¸ìž¥. (ì˜ˆ: "ì„¬ê¸°ëŠ” ê²ƒì„ ê¸°ë»í•˜ëŠ” [STUDENT_TOKEN]ì´ëŠ”...")
2. **ì˜ì  ì„±ìž¥**: ì½”ëžŒë°ì˜¤ ì‹œê°„, í•˜ë‚˜ë‹˜ì„ ì•„ëŠ” ì§€ì‹ì—ì„œì˜ ì„±ìž¥ (ê¸°ë¡ì´ ìžˆì„ ê²½ìš°).
3. **ì§€ì  ì„±ìž¥**: êµê³¼ í•™ìŠµì—ì„œì˜ ì„±ìž¥, ìž¬ëŠ¥ê³¼ ì€ì‚¬.
4. **í•™ìŠµ íƒœë„**: ê¸°ìˆ , ì „ëžµì—ì„œì˜ ì„±ìž¥.
5. **ì •ì„œì  ë°œë‹¬**: ì •ì„œì  ì•ˆì •ì„±, ì¡°ì ˆ, í™œìš© ëŠ¥ë ¥.
6. **ì„±í’ˆ ë° í–‰ë™**: ë°°ë ¤, ë¦¬ë”ì‹­, êµìš° ê´€ê³„.
7. **ì œì–¸**: ë¶€ì¡±í•œ ë¶€ë¶„, ì—°ì•½í•œ ë¶€ë¶„ì— ëŒ€í•œ ì•„ì‰¬ì›€ê³¼ êµ¬ì²´ì ì¸ êµìœ¡ì  ì œì•ˆ.
8. **ê¸°ëŒ€**: í–¥í›„ í•˜ë‚˜ë‹˜ì´ í•˜ì‹¤ ë¶€ë¶„ì— ëŒ€í•œ ê¸°ëŒ€ì™€ ì¶•ë³µ.

# Input Data
- ì´ë¦„: {{name}}
- ì„±ì‹¤ì„±(ê³¼ì œ ìˆ˜í–‰ë¥ ): {{task_rate}}%
- ì¹­ì°¬ ìŠ¤í‹°ì»¤: {{sticker_count}}ê°œ
- í‚¤ì›Œë“œ: {{keywords}}

[êµì‚¬ ê´€ì°° ê¸°ë¡ (ê¸°ì´ˆ ìžë£Œ)]
{{records}}

{{insufficient_notice}}`;

            const DEFAULT_SUBJECT_TEMPLATE = `{{security_rule}}

# Role Definition
ì´ˆë“±í•™êµ êµì‚¬ë¡œì„œ 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©'ì„ ìž‘ì„±í•˜ë¼.

# Strict Guidelines
1. **Fact Only**: ì œê³µëœ ê´€ì°° ê¸°ë¡ì— ìžˆëŠ” ë‚´ìš©ë§Œ ì„œìˆ í•˜ë¼.
2. **No Hallucination**: í•™ìƒì´ íŠ¹ì • ê³¼ëª©ì„ ìž˜í–ˆëŠ”ì§€ ëª»í–ˆëŠ”ì§€ ê¸°ë¡ì— ì—†ë‹¤ë©´ ì–¸ê¸‰í•˜ì§€ ë§ˆë¼.
3. **ë°ì´í„° ë¶€ì¡± ì‹œ**: "íŠ¹ì´ ì‚¬í•­ ì—†ìŒ" ë˜ëŠ” ê³¼ì œ ìˆ˜í–‰ë¥ ë§Œ ì–¸ê¸‰í•˜ê³  ë§ˆë¬´ë¦¬í•˜ë¼.

[êµì‚¬ ê´€ì°° ê¸°ë¡]
{{records}}

ìœ„ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ, ê³¼í•™, ì˜ì–´ ë“± êµê³¼ ê´€ë ¨ ë‚´ìš©ì„ ìž‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì´ ì—†ëŠ” ê³¼ëª©ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.`;

            useEffect(() => {
                const savedBehavior = localStorage.getItem('cls_ai_prompt_behavior');
                const savedSubject = localStorage.getItem('cls_ai_prompt_subject');
                setBehaviorTemplate(savedBehavior || DEFAULT_BEHAVIOR_TEMPLATE);
                setSubjectTemplate(savedSubject || DEFAULT_SUBJECT_TEMPLATE);
            }, []);

            useEffect(() => {
                if (isOpen && student) {
                    const draftKey = `${recordType}_${semester}`;
                    const savedDraft = student.recordDrafts?.[draftKey] || "";
                    setDraft(savedDraft);
                }
            }, [isOpen, student, semester, recordType]);

            useEffect(() => {
                const today = dayjs();
                let sDate = today.startOf('year').format('YYYY-MM-DD');
                let eDate = today.endOf('year').format('YYYY-MM-DD');

                if (semester === '1') { 
                    if (appConfig?.sem1Start) sDate = appConfig.sem1Start;
                    if (appConfig?.sem1End) eDate = appConfig.sem1End;
                    else eDate = today.year() + '-07-31'; 
                } else if (semester === '2') { 
                    if (appConfig?.sem2Start) sDate = appConfig.sem2Start;
                    else sDate = today.year() + '-08-01';
                    if (appConfig?.sem2End) eDate = appConfig.sem2End;
                }
                setStartDate(sDate);
                setEndDate(eDate);
            }, [semester, appConfig]);

            const handleGenerate = async () => {
                setIsGenerating(true);
                setProgress(0);
                const timer = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 500);
                try {
                    // Simple stats calculation
                    let totalTasks = 0;
                    let doneTasks = 0;
                    // Iterate roughly through the year or just use what's available in records/dailyTasks
                    Object.keys(dailyTasks).forEach(date => {
                        if (date >= startDate && date <= endDate) {
                            const tasks = dailyTasks[date];
                            const rec = records[date]?.[student.id];
                            if (tasks && tasks.length > 0) {
                                totalTasks += tasks.length;
                                tasks.forEach((_, idx) => {
                                    if (rec && (rec.tasks?.[idx] || (rec.done && !rec.tasks))) doneTasks++;
                                });
                            }
                        }
                    });
                    const taskRate = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;

                    const validNotes = notes.filter(n => n.date >= startDate && n.date <= endDate);
                    const isInsufficient = validNotes.length < 2;

                    // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™”
                    const safeName = "[STUDENT_TOKEN]";
                    let safeNotesStr = validNotes.length > 0 ? validNotes.map(n => `- [${n.date}] ${n.content}`).join('\n') : 'ê¸°ë¡ ì—†ìŒ';
                    safeNotesStr = anonymizeText(safeNotesStr, student.name);
                    if (students) {
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                    }
                    const safeKeywords = anonymizeText(keywords || 'ì—†ìŒ', student.name);

                    let lengthConstraint = "";
                    if (semester === '1') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 450ìž ì´ë‚´ë¡œ ìž‘ì„±í•  ê²ƒ.";
                    } else if (semester === '2') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 550ìž ì´ë‚´ë¡œ ìž‘ì„±í•  ê²ƒ.";
                    }

                    const securityRule = "[ë³´ì•ˆ ê·œì¹™: ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëžŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìžˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]";

                    let prompt = (recordType === 'behavior' ? (behaviorTemplate || DEFAULT_BEHAVIOR_TEMPLATE) : (subjectTemplate || DEFAULT_SUBJECT_TEMPLATE));
                    
                    // ê³µí†µ ë³€ìˆ˜ ì¹˜í™˜
                    prompt = prompt.replace('{{security_rule}}', securityRule);
                    prompt = prompt.replace('{{name}}', safeName);
                    prompt = prompt.replace('{{task_rate}}', taskRate);
                    prompt = prompt.replace('{{sticker_count}}', student.stickers);
                    prompt = prompt.replace('{{keywords}}', safeKeywords);
                    prompt = prompt.replace('{{records}}', safeNotesStr);

                    // í–‰ë™íŠ¹ì„± ì „ìš© ë³€ìˆ˜ ì¹˜í™˜
                    if (recordType === 'behavior') { // í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ (ê¸°ë…êµ ëŒ€ì•ˆí•™êµ ìŠ¤íƒ€ì¼)
                        prompt = prompt.replace('{{length_constraint}}', lengthConstraint ? `6. **Length**: ${lengthConstraint}` : "");
                        prompt = prompt.replace('{{insufficient_notice}}', isInsufficient ? "ì£¼ì˜: ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ìœ„ ì›ì¹™ì— ë”°ë¼ 'ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬...' ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜, ìˆ˜í–‰ë¥  ë°ì´í„°ë§Œìœ¼ë¡œ ì•„ì£¼ ê°„ëžµí•˜ê²Œ ì‚¬ì‹¤ë§Œ ê¸°ìˆ í•˜ì„¸ìš”." : "ìœ„ ì›ì¹™ê³¼ ìˆœì„œì— ë§žì¶° ìž‘ì„±í•˜ì„¸ìš”.");
                    }

                    const text = await callGemini(apiKey, prompt, 0.1);
                    clearInterval(timer);
                    setProgress(100);
                    
                    // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                    const finalContent = deanonymizeText(text, student.name);
                    setDraft(finalContent);
                } catch (e) {
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    clearInterval(timer);
                    showToast("ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleAddPhrase = () => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                const textToSave = (textarea.value.substring(textarea.selectionStart, textarea.selectionEnd) || textarea.value).trim();
                if (!textToSave) return showToast("ì €ìž¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, textToSave];
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
            };
            const handleApplyPhrase = (text) => {
                setDraft(prev => prev + (prev ? " " : "") + text);
                setShowPhraseList(false);
            };

            const handleSave = () => {
                if (semester === 'all') {
                    showToast("ì „ì²´ í•™ê¸° ì´ˆì•ˆì€ ì €ìž¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 1í•™ê¸° ë˜ëŠ” 2í•™ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                const draftKey = `${recordType}_${semester}`;
                onSaveDraft(student.id, draftKey, draft);
            };

            const handleDownloadPdf = async () => {
                if (!contentRef.current) return;
                if (!window.jspdf) return showToast("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ìž…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(contentRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`${student.name}_${recordType === 'behavior' ? 'ì´í‰' : 'êµê³¼ë°œë‹¬'}_ì´ˆì•ˆ_${dayjs().format('YYYYMMDD')}.pdf`);
                    showToast("PDFë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ PDF ì €ìž¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    showToast("PDF ì €ìž¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            const handleSavePrompt = () => {
                if (recordType === 'behavior') {
                    localStorage.setItem('cls_ai_prompt_behavior', behaviorTemplate);
                } else {
                    localStorage.setItem('cls_ai_prompt_subject', subjectTemplate);
                }
                showToast("í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setShowPromptSettings(false);
            };

            const handleResetPrompt = () => {
                if (recordType === 'behavior') {
                    setBehaviorTemplate(DEFAULT_BEHAVIOR_TEMPLATE);
                    localStorage.removeItem('cls_ai_prompt_behavior');
                } else {
                    setSubjectTemplate(DEFAULT_SUBJECT_TEMPLATE);
                    localStorage.removeItem('cls_ai_prompt_subject');
                }
                showToast("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ“ AI ì´í‰ ì´ˆì•ˆ ìƒì„±">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                            <p className="font-bold mb-1">ðŸ’¡ ìƒí™œê¸°ë¡ë¶€ ì´ˆì•ˆì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">1ë…„ ë™ì•ˆì˜ ê³¼ì œ ìˆ˜í–‰, ìŠ¤í‹°ì»¤, ìƒë‹´ ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ AIê°€ ìž‘ì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì„ ìƒë‹˜ì˜ ê²€í† ì™€ ìˆ˜ì •ì„ ê±°ì³ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex flex-col gap-2">
                            <label className="text-xs font-bold text-slate-500">ì¶”ê°€ ê°•ì¡°í•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œ (ì„ íƒ)</label>
                            <input value={keywords} onChange={e => setKeywords(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-blue-500" placeholder="ì˜ˆ: ë´‰ì‚¬ì •ì‹ , ì°½ì˜ë ¥, ë…ì„œì™•..." />
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">í•™ê¸° ì„ íƒ:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setSemester('1')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '1' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>1í•™ê¸°</button>
                                <button onClick={() => setSemester('2')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '2' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>2í•™ê¸°</button>
                                <button onClick={() => setSemester('all')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === 'all' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ì „ì²´</button>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                             <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                             <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                             <span className="text-xs text-slate-400">~</span>
                             <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">ìƒì„± í•­ëª©:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setRecordType('behavior')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'behavior' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬</button>
                                <button onClick={() => setRecordType('subject')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'subject' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>êµê³¼ í•™ìŠµ ë°œë‹¬</button>
                            </div>
                        </div>

                        <div className="border-t border-slate-100 pt-2">
                            <button onClick={() => setShowPromptSettings(!showPromptSettings)} className="text-xs font-bold text-slate-400 flex items-center gap-1 hover:text-slate-600 transition-colors mb-2">
                                <Icon d={PATHS.settings} size={12} /> í”„ë¡¬í”„íŠ¸ ì„¤ì • {showPromptSettings ? 'ì ‘ê¸°' : 'ì—´ê¸°'}
                            </button>
                            {showPromptSettings && (
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fade-in space-y-2">
                                    <div className="flex justify-between items-center">
                                        <p className="text-[10px] text-slate-500 font-bold">ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ (ìžë™ ì¹˜í™˜)</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-1 text-[10px] text-slate-600 bg-white p-2 rounded border border-slate-100">
                                        <div><code>{`{{name}}`}</code> : í•™ìƒ ì´ë¦„ (ìµëª…)</div>
                                        <div><code>{`{{records}}`}</code> : ê´€ì°° ê¸°ë¡</div>
                                        <div><code>{`{{task_rate}}`}</code> : ê³¼ì œ ìˆ˜í–‰ë¥ </div>
                                        <div><code>{`{{sticker_count}}`}</code> : ìŠ¤í‹°ì»¤ ìˆ˜</div>
                                        <div><code>{`{{keywords}}`}</code> : í‚¤ì›Œë“œ</div>
                                        <div className="col-span-2 text-rose-500"><code>{`{{security_rule}}`}</code> : ë³´ì•ˆ ê·œì¹™ (í•„ìˆ˜)</div>
                                    </div>
                                    <textarea 
                                        value={recordType === 'behavior' ? behaviorTemplate : subjectTemplate} 
                                        onChange={(e) => recordType === 'behavior' ? setBehaviorTemplate(e.target.value) : setSubjectTemplate(e.target.value)} 
                                        className="w-full h-40 p-2 border border-slate-300 rounded-lg text-xs font-mono outline-none focus:border-indigo-500 resize-none custom-scroll" 
                                    />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={handleResetPrompt} className="px-3 py-1.5 bg-white border border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-50">ì´ˆê¸°í™”</button>
                                        <button onClick={handleSavePrompt} className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">ì €ìž¥</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <Btn onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2">
                            {isGenerating ? <><Icon d={PATHS.spinner} className="animate-spin" /> ìž‘ì„± ì¤‘... {Math.round(progress)}%</> : <><Icon d={PATHS.magic} /> ì´ˆì•ˆ ìƒì„±í•˜ê¸°</>}
                        </Btn>

                        {draft && (
                            <div ref={contentRef} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm animate-fade-in">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold text-slate-500">ìƒì„±ëœ ì´ˆì•ˆ</span>
                                    <div className="relative">
                                        <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                            <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                        </button>
                                        {showPhraseList && (
                                            <div className="absolute right-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                    <span className="text-xs font-bold text-slate-600">ì €ìž¥ëœ ë¬¸êµ¬</span>
                                                    <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">ì„ íƒ/ì „ì²´ ì €ìž¥</button>
                                                </div>
                                                <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                    {phrases.length > 0 ? phrases.map((p, i) => (
                                                        <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                            <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                            <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                        </div>
                                                    )) : <div className="text-center text-slate-400 text-xs py-2">ì €ìž¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-slate-100 text-[9px] text-slate-400 text-center">
                                                    * í…ìŠ¤íŠ¸ë¥¼ ë“œëž˜ê·¸í•˜ì—¬ ì„ íƒ í›„ ì €ìž¥í•˜ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ ì €ìž¥ë©ë‹ˆë‹¤.
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <textarea ref={textareaRef} value={draft} onChange={e => setDraft(e.target.value)} className="w-full h-48 text-sm leading-relaxed text-slate-700 outline-none resize-none custom-scroll" />
                                <div className="flex justify-end gap-2 border-t border-slate-100 pt-4 mt-2" data-html2canvas-ignore="true">
                                    <Btn onClick={handleDownloadPdf} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.download} size={14} /> PDF
                                    </Btn>
                                    <Btn onClick={() => { navigator.clipboard.writeText(draft); showToast("ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                    </Btn>
                                    <Btn onClick={handleSave} className="px-3 py-2 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1">
                                        <Icon d={PATHS.check} size={14} /> ì €ìž¥
                                    </Btn>
                                </div>
                            </div>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const CalendarModal = ({ isOpen, onClose, currentDate, onSelectDate, records, appConfig, groupsByDate, mode, selectionMode = 'single', onSelectRange, customDots }) => {
            const [viewDate, setViewDate] = useState(dayjs(currentDate));
            const [range, setRange] = useState({ start: null, end: null });
            const [blinkDate, setBlinkDate] = useState(null);
            const [tempSelected, setTempSelected] = useState(null);

            useEffect(() => { 
                if (isOpen) {
                    setViewDate(dayjs(currentDate)); 
                    if (selectionMode === 'range') setRange({ start: null, end: null });
                } 
            }, [isOpen, currentDate, selectionMode]);

            if (!isOpen) return null;
            const startDay = viewDate.startOf('month').day();
            const calendarDays = [...Array(startDay).fill(null), ...Array(viewDate.daysInMonth()).fill(0).map((_, i) => viewDate.date(i + 1))];
            
            const handleDateClick = (dateStr) => {
                const day = dayjs(dateStr).day();
                const isWeekend = day === 0 || day === 6;
                const isHoliday = !!HOLIDAYS[dateStr];
                const isVacation = (appConfig.vacations || []).some(v => dateStr >= v.start && dateStr <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && dateStr >= appConfig.vacationStart && dateStr <= appConfig.vacationEnd);
                
                if (!isWeekend && !isHoliday && !isVacation) {
                    if (selectionMode === 'single') {
                        setTempSelected(dateStr);
                        setTimeout(() => {
                            onSelectDate(dateStr);
                            onClose();
                        }, 400);
                    } else {
                        if (!range.start || (range.start && range.end)) {
                            setRange({ start: dateStr, end: null });
                        } else {
                            let start = range.start;
                            let end = dateStr;
                            if (dayjs(end).isBefore(dayjs(start))) [start, end] = [end, start];
                            setRange({ start, end });
                            if (onSelectRange) onSelectRange(start, end);
                            onClose();
                        }
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 z-[1500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm md:max-w-lg rounded-3xl shadow-2xl shadow-indigo-100/50 p-4 md:p-6 transform transition-all" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-extrabold text-slate-800 flex items-center gap-2">
                                <span className="text-2xl">ðŸ“…</span> 
                                {selectionMode === 'range' ? 'ê¸°ê°„ ì„ íƒ (ì‹œìž‘ì¼ â†’ ì¢…ë£Œì¼)' : 'ë‚ ì§œ ì„ íƒ'}
                            </h3>
                            <div className="flex items-center gap-2">
                                {selectionMode === 'single' && <button onClick={() => { 
                                    const today = getToday();
                                    setViewDate(dayjs(today));
                                    onSelectDate(today);
                                    setBlinkDate(today);
                                    setTimeout(() => setBlinkDate(null), 1500);
                                }} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 transition-colors">ì˜¤ëŠ˜</button>}
                                {selectionMode === 'range' && <button onClick={() => { if(onSelectRange) onSelectRange(currentDate, currentDate); onClose(); }} className="text-xs bg-rose-50 text-rose-500 px-3 py-1.5 rounded-full font-bold hover:bg-rose-100 transition-colors">ì´ˆê¸°í™”</button>}
                                <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} size={20} /></button>
                            </div>
                        </div>
                        <div className="flex justify-between items-center mb-6 px-2">
                            <button onClick={() => setViewDate(viewDate.subtract(1, 'month'))} className="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-800 transition-colors"><Icon d={PATHS.left} size={20} /></button>
                            <span className="text-lg font-extrabold text-slate-800 tracking-tight">{viewDate.format('YYYYë…„ Mì›”')}</span>
                            <button onClick={() => setViewDate(viewDate.add(1, 'month'))} className="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-800 transition-colors"><Icon d={PATHS.right} size={20} /></button>
                        </div>
                        <div className="grid grid-cols-7 mb-2 text-center">
                            {DAYS.map((d, i) => <div key={d} className={`text-xs font-bold pb-2 ${i === 0 ? 'text-red-400' : i === 6 ? 'text-blue-400' : 'text-slate-400'}`}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays.map((dateObj, idx) => { 
                                if (!dateObj) return <div key={idx} className="aspect-square"></div>; 
                                const dateStr = dateObj.format('YYYY-MM-DD'); 
                                const isToday = dateStr === getToday(); 
                                const dayOfWeek = dateObj.day(); 
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; 
                                const holidayName = HOLIDAYS[dateStr]; 
                                const isHoliday = !!holidayName; 
                                const isVacation = appConfig && ((appConfig.vacations || []).some(v => dateStr >= v.start && dateStr <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && dateStr >= appConfig.vacationStart && dateStr <= appConfig.vacationEnd));
                                const hasRecord = records && records[dateStr] && Object.values(records[dateStr]).some(r => r.done || (r.tasks && Object.values(r.tasks).some(t => t))); 
                                const hasGroup = groupsByDate && groupsByDate[dateStr] && groupsByDate[dateStr].length > 0; 
                                const hasCustomDot = customDots && customDots[dateStr];
                                
                                let showDot = false;
                                if (mode === 'group') showDot = hasGroup;
                                else if (mode === 'custom') showDot = hasCustomDot;
                                else showDot = hasRecord;
                                
                                let isSelected = false;
                                let isInRange = false;
                                if (selectionMode === 'single') {
                                    isSelected = dateStr === currentDate || dateStr === tempSelected;
                                } else {
                                    if (range.start === dateStr) isSelected = true;
                                    if (range.end === dateStr) isSelected = true;
                                    if (range.start && range.end && dateStr > range.start && dateStr < range.end) isInRange = true;
                                }

                                const isDisabled = isVacation || isWeekend || isHoliday;
                                const isBlinking = blinkDate === dateStr;
                                let cellClass = "aspect-square flex flex-col items-center justify-center rounded-full text-sm font-medium cursor-pointer transition-all duration-300 relative group";
                                
                                if (isSelected) cellClass += " bg-indigo-600 text-white shadow-lg shadow-indigo-200 font-bold transform scale-110 z-10";
                                else if (isInRange) cellClass += " bg-indigo-50 text-indigo-700 font-bold";
                                else if (isDisabled) cellClass += " text-slate-300 cursor-not-allowed bg-slate-50/50";
                                else if (isToday) cellClass += " text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100";
                                else cellClass += " text-slate-700 hover:bg-slate-100 active:scale-95";
                                
                                if (isBlinking) cellClass += " ring-4 ring-indigo-300 ring-offset-2 animate-blink-strong";
                                
                                return (
                                    <button key={idx} disabled={isDisabled} onClick={() => handleDateClick(dateStr)} className={cellClass}>
                                        <span>{dateObj.date()}</span>
                                        {isSelected && (
                                            <div className="absolute -top-1 -right-1 bg-white text-indigo-600 rounded-full p-[2px] shadow-sm animate-bounce-in z-20"><Icon d={PATHS.check} size={10} strokeWidth={4} /></div>
                                        )}
                                        {showDot && !isDisabled && !isSelected && !isInRange && (<div className={`w-1 h-1 rounded-full mt-0.5 ${isToday ? 'bg-indigo-400' : 'bg-blue-400'}`}></div>)}
                                        {isHoliday && !isVacation && <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 text-[8px] leading-none text-rose-400 font-bold whitespace-nowrap w-full text-center truncate px-1">{holidayName}</div>}
                                    </button>
                                ) 
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        const DateHeader = ({ date, setDate, onAdd, onReset, onCalendar, appConfig }) => {
            const isVacation = (appConfig.vacations || []).some(v => date >= v.start && date <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && date >= appConfig.vacationStart && date <= appConfig.vacationEnd);
            const isHoliday = !!HOLIDAYS[date];
            const holidayName = HOLIDAYS[date];
            
            // [New] D-Day Logic
            const today = dayjs().format('YYYY-MM-DD');
            let dDayLabel = null;
            
            // Check if today is already vacation
            const isTodayVacation = (appConfig.vacations || []).some(v => today >= v.start && today <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && today >= appConfig.vacationStart && today <= appConfig.vacationEnd);

            if (appConfig.dDayEnabled !== false && !isTodayVacation) {
                const allVacations = [...(appConfig.vacations || [])];
                if (appConfig.vacationStart && appConfig.vacationEnd) {
                    allVacations.push({ start: appConfig.vacationStart, end: appConfig.vacationEnd });
                }
                
                const nextVacation = allVacations
                    .filter(v => v.start > today)
                    .sort((a, b) => a.start.localeCompare(b.start))[0];
                
                if (nextVacation) {
                    const diff = dayjs(nextVacation.start).diff(dayjs(today), 'day');
                    if (diff > 0) {
                        dDayLabel = `ë°©í•™ê¹Œì§€ D-${diff}`;
                    }
                }
            }

            const moveDate = (direction) => { let nextDate = dayjs(date).add(direction, 'day'); let count = 0; while (count < 365) { const dStr = nextDate.format('YYYY-MM-DD'); const day = nextDate.day(); const isWknd = day === 0 || day === 6; const isHol = !!HOLIDAYS[dStr]; if (!isWknd && !isHol) break; nextDate = nextDate.add(direction, 'day'); count++; } setDate(nextDate.format('YYYY-MM-DD')); };
            return (
                <div className="flex flex-col items-center">
                    {(isVacation || isHoliday || dDayLabel) && (
                        <div className="flex gap-2 mb-2">
                            {isVacation && <div className="bg-orange-100 text-orange-600 text-xs font-bold px-3 py-1 rounded">ðŸ–ï¸ ë°©í•™ ê¸°ê°„ìž…ë‹ˆë‹¤</div>}
                            {isHoliday && <div className="bg-rose-100 text-rose-600 text-xs font-bold px-3 py-1 rounded">ðŸŽ‰ {holidayName}</div>}
                            {dDayLabel && !isVacation && <div className="bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1 rounded flex items-center gap-1"><span>â³</span> {dDayLabel}</div>}
                        </div>
                    )}
                    <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border w-fit mx-auto justify-center">{onAdd && <><Btn onClick={onAdd} className="text-notion-text p-1.5 rounded hover:bg-notion-bg-hover flex items-center justify-center"><Icon d={PATHS.plus} size={18} /></Btn><div className="w-px h-4 bg-notion-border"></div></>}<Btn onClick={() => moveDate(-1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18} /></Btn><div className="flex flex-col items-center cursor-pointer hover:bg-notion-bg-hover rounded px-3 py-1 transition-colors" onClick={onCalendar}><div className="text-base font-bold text-notion-text tracking-tight">{dayjs(date).format('YY.MM.DD')}</div><div className={`text-[10px] font-bold ${isHoliday || dayjs(date).day()===0 ? 'text-notion-red' : dayjs(date).day()===6 ? 'text-notion-blue' : 'text-notion-text-light'}`}>{dayjs(date).format('dddd')}</div></div><Btn onClick={() => moveDate(1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18} /></Btn>{onReset && <><div className="w-px h-4 bg-notion-border"></div><Btn onClick={(e) => { e.stopPropagation(); onReset(); }} className="p-1.5 text-notion-text-light hover:text-notion-red hover:bg-notion-bg-hover rounded"><Icon d={PATHS.trash} size={16} /></Btn></>}</div>
                </div>
            );
        };
        const TagSelector = ({ current, setTag, tags, onAdd, onEdit, onDelete }) => {
            const [showManager, setShowManager] = useState(false);
            const [newTagInput, setNewTagInput] = useState("");
            const [editingTag, setEditingTag] = useState(null);
            const [editTagValue, setEditTagValue] = useState("");
            const handleAdd = () => { if (newTagInput.trim()) { onAdd(newTagInput.trim()); setNewTagInput(""); } };
            const handleFinishEdit = () => { if (editingTag && editTagValue.trim() && editTagValue.trim() !== editingTag) onEdit(editingTag, editTagValue.trim()); setEditingTag(null); setEditTagValue(""); };
            return (
                <div className="mt-2"><div className="flex flex-wrap gap-1 items-center">{tags.map(t => <Btn key={t} onClick={() => setTag(t)} className={`px-2 py-1 text-xs rounded-lg border ${current === t ? 'bg-indigo-500 text-white border-indigo-500 shadow-sm hover:bg-indigo-500' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{t}</Btn>)}<Btn onClick={() => setShowManager(!showManager)} className={`p-1 rounded-full ${showManager ? 'bg-slate-200 text-slate-600' : 'text-slate-300 hover:text-slate-500'}`}><span className="text-sm">âš™ï¸</span></Btn></div>{showManager && (<div className="mt-2 p-3 bg-slate-50 rounded-xl border border-slate-200 animate-fade-in relative z-10"><div className="text-[10px] font-bold text-slate-400 mb-2">íƒœê·¸ ê´€ë¦¬</div><div className="flex flex-wrap gap-2 mb-2">{tags.map(tag => editingTag === tag ? (<div key={tag} className="flex items-center bg-white border border-indigo-300 rounded-lg overflow-hidden shadow-sm"><input value={editTagValue} onChange={e => setEditTagValue(e.target.value)} className="w-16 px-1 py-0.5 text-xs outline-none" autoFocus onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleFinishEdit() }} /><Btn onClick={handleFinishEdit} className="bg-indigo-100 text-indigo-600 px-1.5 py-0.5 hover:bg-indigo-200"><Icon d={PATHS.check} size={10} /></Btn><Btn onClick={() => setEditingTag(null)} className="bg-slate-100 text-slate-500 px-1.5 py-0.5 hover:bg-slate-200"><Icon d={PATHS.x} size={10} /></Btn></div>) : (<div key={tag} className="px-2 py-1 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 flex items-center gap-1 group"><span>{tag}</span><div className="flex gap-0.5 opacity-50 group-hover:opacity-100 transition-opacity"><Btn onClick={() => { setEditingTag(tag); setEditTagValue(tag); }} className="hover:text-indigo-500 p-0.5"><Icon d={PATHS.edit} size={10} /></Btn>{tag !== 'ê¸°íƒ€' && <Btn onClick={(e) => { e.preventDefault(); e.stopPropagation(); onDelete(tag); }} className="text-rose-500 hover:text-rose-700 p-0.5"><Icon d={PATHS.trash} size={10} /></Btn>}</div></div>))}</div><div className="flex gap-1"><input value={newTagInput} onChange={e => setNewTagInput(e.target.value)} className="flex-1 p-1.5 border rounded-lg text-xs outline-none focus:border-indigo-500" placeholder="ìƒˆ íƒœê·¸ ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleAdd() }} /><Btn onClick={handleAdd} className="bg-indigo-500 text-white px-3 rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn></div></div>)}</div>
            );
        };
        const TaskModal = ({ isOpen, onClose, date, dailyTasks, setDailyTasks, weeklyTasks, setWeeklyTasks, saveData, isLocalMode, showToast, tags, setTags, openConfirm }) => {
            const [tasks, setTempTasks] = useState([]); const [newTask, setNewTask] = useState(""); const [selectedTag, setSelectedTag] = useState("êµ­ì–´"); const [wTasks, setWTasks] = useState({}); const [wSelectedDays, setWSelectedDays] = useState([]); const [wNewTask, setWNewTask] = useState(""); const [wSelectedTag, setWSelectedTag] = useState("êµ­ì–´");
            const [dueDate, setDueDate] = useState(date); // ðŸŒŸ ì œì¶œì¼ ìƒíƒœ ì¶”ê°€
            
            useEffect(() => { if (isOpen) { setTempTasks((dailyTasks[date] || []).map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); const loadedWeekly = {}; Object.keys(weeklyTasks).forEach(k => loadedWeekly[k] = weeklyTasks[k].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); setWTasks(loadedWeekly); setDueDate(date); /* ðŸŒŸ ì—´ë¦´ ë•Œë§ˆë‹¤ í˜„ìž¬ ë‚ ì§œë¡œ ì´ˆê¸°í™” */ } }, [isOpen, dailyTasks, weeklyTasks, date]);
            const updateTags = (newTag) => { if (newTag && !tags.includes(newTag)) { const newTags = [...tags, newTag]; setTags(newTags); if (!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); } };
            const addTask = () => { 
                if (newTask && newTask.trim() !== "") { 
                    updateTags(selectedTag);
                    
                    // 1. ë‹¬ë ¥ ë‚ ì§œê°€ ì˜¤ëŠ˜(í˜„ìž¬ í™”ë©´)ê³¼ ê°™ì„ ë•Œ (ê¸°ì¡´ ë°©ì‹)
                    if (dueDate === date) {
                        if (tasks.length < 5) {
                            setTempTasks([...tasks, { title: newTask, tag: selectedTag }]); 
                            setNewTask(""); 
                        } else { showToast("ì˜¤ëŠ˜ ê³¼ì œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); }
                    } 
                    // 2. ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí–ˆì„ ë•Œ (ë¯¸ëž˜ë¡œ ë³´ë‚´ê¸°!)
                    else {
                        const targetTasks = dailyTasks[dueDate] || [];
                        if (targetTasks.length < 5) {
                            const updatedTasks = [...targetTasks, { title: newTask, tag: selectedTag }];
                            const newDaily = { ...dailyTasks, [dueDate]: updatedTasks };
                            setDailyTasks(newDaily);
                            
                            // ì•ˆì „í•˜ê²Œ ì €ìž¥í•˜ê¸°
                            localStorage.setItem('cls_daily_tasks', JSON.stringify(newDaily));
                            try { if (!isLocalMode) saveData('cls_daily_tasks', newDaily); } catch(e) {}
                            
                            showToast(`${dayjs(dueDate).format('MM/DD')} ìˆ™ì œê°€ ë“±ë¡ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            setNewTask("");
                            setDueDate(date); // ì¶”ê°€ í›„ ë‹¤ì‹œ ì›ëž˜ ë‚ ì§œë¡œ ë³µê·€
                        } else { showToast("ì„ íƒí•˜ì‹  ë‚ ì§œì— ì´ë¯¸ ê³¼ì œê°€ 5ê°œ ê½‰ ì°¼ìŠµë‹ˆë‹¤."); }
                    }
                } 
            };
            const removeTask = (idx) => setTempTasks(tasks.filter((_, i) => i !== idx));
            const saveAll = () => { 
                const newDaily = { ...dailyTasks, [date]: tasks }; 
                setDailyTasks(newDaily); 
                setWeeklyTasks(wTasks);
                setTags(tags); // íƒœê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸

                if (!isLocalMode) {
                    // [Fix] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬ ì €ìž¥ (ìµœì í™”: ë³€ê²½ëœ ë‚ ì§œë§Œ ì €ìž¥)
                    // saveTasksToFirestoreëŠ” App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìžˆìœ¼ë¯€ë¡œ propsë¡œ ì „ë‹¬ë°›ê±°ë‚˜ í•´ì•¼ í•¨.
                    // í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” TaskModalì´ App ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìžˆìœ¼ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, 
                    // saveDataë¥¼ í†µí•´ ìš°íšŒí•´ì•¼ í•˜ëŠ”ë°, saveDataëŠ” ì „ì²´ ì €ìž¥ì´ë¯€ë¡œ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìžˆìŒ.
                    // App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ í•¨ìˆ˜ì¸ saveTasksToFirestoreë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì • í•„ìš”.
                    // *TaskModalì´ App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìžˆìœ¼ë¯€ë¡œ saveTasksToFirestore ì ‘ê·¼ ê°€ëŠ¥*
                    // (ì•„ëž˜ App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModal ì •ì˜ ë¶€ë¶„ í™•ì¸ í•„ìš” - í˜„ìž¬ App ë‚´ë¶€ì— ì •ì˜ë¨)
                } 
                // *TaskModalì€ App ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ê°€ ì•„ë‹ˆë¼ ë³„ë„ ì»´í¬ë„ŒíŠ¸ìž„. propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.*
                // í•˜ì§€ë§Œ í˜„ìž¬ ì½”ë“œ êµ¬ì¡°ìƒ TaskModalì€ App ë‚´ë¶€ì—ì„œ ì •ì˜ëœ ê²ƒì´ ì•„ë‹ˆë¼ ë³„ë„ë¡œ ì •ì˜ë˜ì–´ ìžˆìŒ.
                // ë”°ë¼ì„œ saveTasksToFirestoreë¥¼ propsë¡œ ë„˜ê²¨ì£¼ê±°ë‚˜, saveDataê°€ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” saveDataë¥¼ í˜¸ì¶œí•˜ë˜, Appì˜ saveDataê°€ ë¶„ê¸° ì²˜ë¦¬í•˜ë„ë¡ í•¨.
                // ë‹¨, TaskModalì—ì„œ ìµœì í™”ë¥¼ ìœ„í•´ saveTasksToFirestoreë¥¼ ì§ì ‘ propìœ¼ë¡œ ë°›ëŠ” ê²ƒì´ ì¢‹ìŒ.
                // ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜, Appì—ì„œ TaskModalì— saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½ ì˜ˆì •.
                
                // [ìˆ˜ì •] TaskModalì€ App ì™¸ë¶€ ì»´í¬ë„ŒíŠ¸ì´ë¯€ë¡œ propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.
                // App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModalì„ ë¶€ë¥¼ ë•Œ saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ë„ë¡ ìˆ˜ì • í•„ìš”.
                // ì—¬ê¸°ì„œëŠ” propsë¡œ ë°›ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©.
                
                // (TaskModal propsì— saveTasksToFirestore ì¶”ê°€ í•„ìš”)
            };
            const toggleDay = (d) => setWSelectedDays(prev => prev.includes(d) ? prev.filter(x => x !== d) : [...prev, d]);
            const addWeeklyTask = () => { if (wNewTask && wSelectedDays.length > 0) { const newW = { ...wTasks }; wSelectedDays.forEach(d => { if ((newW[d] || []).length < 5) newW[d] = [...(newW[d] || []), { title: wNewTask, tag: wSelectedTag }]; }); setWTasks(newW); updateTags(wSelectedTag); setWNewTask(""); setWSelectedDays([]); showToast("ìš”ì¼ë³„ ê³¼ì œ ì¶”ê°€ë¨"); } };
            const removeWeeklyTask = (d, i) => setWTasks({ ...wTasks, [d]: wTasks[d].filter((_, idx) => idx !== i) });
            const handleTagAction = (action, ...args) => { if(action === 'add') updateTags(args[0]); else if(action === 'delete') { openConfirm(`'${args[0]}' íƒœê·¸ ì‚­ì œ?`, () => { const newTags = tags.filter(t => t !== args[0]); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); if(selectedTag === args[0]) setSelectedTag("ê¸°íƒ€"); if(wSelectedTag === args[0]) setWSelectedTag("ê¸°íƒ€"); }); } else if(action === 'edit') { const [oldT, newT] = args; if(newT && newT !== oldT){ const newTags = tags.map(t=>t===oldT?newT:t); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); showToast("íƒœê·¸ ìˆ˜ì •ë¨"); } } };

            // [New] ì €ìž¥ ë¡œì§ ìž¬ì •ì˜ (propsë¡œ ë°›ì€ í•¨ìˆ˜ ì‚¬ìš©)
            const handleSaveAll = () => {
                const newDaily = { ...dailyTasks, [date]: tasks };
                setDailyTasks(newDaily);
                setWeeklyTasks(wTasks);
                setTags(tags);

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°±ì—… (í•­ìƒ ìˆ˜í–‰)
                localStorage.setItem('cls_daily_tasks', JSON.stringify(newDaily));
                localStorage.setItem('cls_weekly_tasks', JSON.stringify(wTasks));
                localStorage.setItem('cls_tags', JSON.stringify(tags));

                if (!isLocalMode && props.saveTasksToFirestore) {
                    // í´ë¼ìš°ë“œ ëª¨ë“œ: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ìµœì í™” ì €ìž¥
                    props.saveTasksToFirestore({ 
                        dailyTasks: { [date]: tasks }, // ë³€ê²½ëœ ë‚ ì§œë§Œ
                        weeklyTasks: wTasks,
                        tags: tags
                    });
                } else if (isLocalMode) {
                    // ë¡œì»¬ ëª¨ë“œ: ì´ë¯¸ ìœ„ì—ì„œ ì €ìž¥í•¨ (saveData í˜¸ì¶œ ë¶ˆí•„ìš”)
                } else {
                    // Fallback (êµ¬ë²„ì „ í˜¸í™˜)
                    saveData('cls_daily_tasks', newDaily);
                    saveData('cls_weekly_tasks', wTasks);
                    saveData('cls_tags', tags);
                }
                onClose();
                showToast("ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ê³¼ì œ ì„¤ì •" icon={PATHS.edit} footer={<Btn onClick={handleSaveAll} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg hover:bg-slate-900">ëª¨ë“  ì„¤ì • ì €ìž¥ ë° ë‹«ê¸°</Btn>}><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-indigo-500 pl-3 flex justify-between"><span>ì˜¤ëŠ˜ì˜ ê³¼ì œ ({dayjs(date).format('YY.MM.DD')})</span><span className="text-xs font-normal text-slate-400">ìµœëŒ€ 5ê°œ</span></h4><div className="bg-slate-50 p-4 rounded-2xl border border-slate-100"><div className="flex flex-col mb-3"><div className="flex gap-2 items-center mb-2 w-full">
    <div className="flex items-center gap-1.5 shrink-0 bg-slate-100 px-3 py-2.5 rounded-xl border border-slate-200">
        <span className="text-xs font-extrabold text-slate-500 whitespace-nowrap">ì œì¶œì¼</span>
        <input 
            type="date" 
            value={dueDate} 
            onChange={e => setDueDate(e.target.value)} 
            className="text-sm font-bold text-slate-700 bg-transparent outline-none cursor-pointer" 
            title="ê³¼ì œ ì œì¶œì¼ ë³€ê²½" 
        />
    </div>
    <input 
        value={newTask} 
        onChange={e => setNewTask(e.target.value)} 
        className="flex-1 min-w-0 p-2.5 border border-slate-300 rounded-xl text-sm outline-none focus:border-indigo-500 shadow-sm" 
        placeholder="ì˜ˆ: ìˆ˜í•™ ìµíž˜ì±… í’€ì–´ì˜¤ê¸°" 
        onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addTask() }} 
    />
    <Btn 
        onClick={addTask} 
        className="shrink-0 bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-indigo-700 whitespace-nowrap"
    >
        ì¶”ê°€
    </Btn>
</div><TagSelector current={selectedTag} setTag={setSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><div className="flex items-center gap-2"><span className="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] rounded font-bold">{t.tag}</span><span className="text-sm font-medium text-slate-700">{t.title}</span></div><Btn onClick={() => removeTask(i)} className="text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div>))}{tasks.length === 0 && <div className="text-center text-slate-400 text-sm py-4">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div></section><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-green-500 pl-3"><span>ìš”ì¼ë³„ ê³ ì • ê³¼ì œ</span></h4><div className="bg-green-50/50 p-4 rounded-2xl border border-green-100"><div className="flex justify-between mb-3 bg-white p-1 rounded-xl border border-green-100">{[1, 2, 3, 4, 5].map(d => <Btn key={d} onClick={() => toggleDay(d)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${wSelectedDays.includes(d) ? 'bg-green-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>{DAYS[d]}</Btn>)}</div><div className="flex flex-col mb-6"><div className="flex gap-2 items-center mb-2 w-full"><input value={wNewTask} onChange={e => setWNewTask(e.target.value)} className="flex-1 min-w-0 p-2.5 border rounded-xl text-sm outline-none focus:border-green-500" placeholder="ê³¼ì œ ë‚´ìš©" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addWeeklyTask() }} /><Btn onClick={addWeeklyTask} className="shrink-0 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 whitespace-nowrap">ì¼ê´„ ì¶”ê°€</Btn></div><TagSelector current={wSelectedTag} setTag={setWSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="grid grid-cols-1 sm:grid-cols-5 gap-3">{[1, 2, 3, 4, 5].map(d => (<div key={d} className="bg-white p-3 rounded-xl border border-slate-200"><div className="text-center font-bold text-slate-500 text-xs mb-2 pb-1 border-b">{DAYS[d]}ìš”ì¼</div><div className="space-y-1 min-h-[60px]">{(wTasks[d] || []).map((t, i) => (<div key={i} className="flex justify-between items-start text-xs bg-slate-50 p-1.5 rounded group"><div className="flex flex-col"><span className="text-[9px] text-slate-400">{t.tag}</span><span className="break-all leading-tight">{t.title}</span></div><Btn onClick={() => removeWeeklyTask(d, i)} className="text-rose-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 ml-1">Ã—</Btn></div>))}</div></div>))}</div></div></section></BaseModal>
            );
        };
        
        const StickerAutomationView = ({ students, records, dailyTasks, saveData, isLocalMode, showToast, openConfirm, setStudents }) => {
            const [stickerDate, setStickerDate] = useState(getToday());
            const [stickerRate, setStickerRate] = useState(100);
            const [stickerAdd, setStickerAdd] = useState(1);
            const [previewCount, setPreviewCount] = useState(-1);

            const calculateQualified = () => {
                const tasks = dailyTasks[stickerDate] || [];
                if (tasks.length === 0) return [];
                
                return students.filter(s => {
                    const rec = records[stickerDate]?.[s.id];
                    let done = 0;
                    if (rec) {
                        tasks.forEach((_, idx) => {
                            if (rec.tasks && rec.tasks[idx]) done++;
                            else if (!rec.tasks && rec.done) done++;
                        });
                    }
                    const rate = (done / tasks.length) * 100;
                    return rate >= stickerRate;
                });
            };

            const handlePreviewStickers = () => {
                const qualified = calculateQualified();
                setPreviewCount(qualified.length);
            };

            const handleApplyStickers = () => {
                const qualified = calculateQualified();
                if (qualified.length === 0) {
                    showToast("ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                
                openConfirm(`${stickerDate} ê³¼ì œ ìˆ˜í–‰ë¥  ${stickerRate}% ì´ìƒì¸\n${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ ${stickerAdd}ê°œë¥¼ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                    const updatedStudents = students.map(s => {
                        if (qualified.find(q => q.id === s.id)) {
                            return { ...s, stickers: (s.stickers || 0) + stickerAdd };
                        }
                        return s;
                    });
                    setStudents(updatedStudents);
                    if(!isLocalMode) saveData('cls_students', updatedStudents);
                    showToast(`${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! ðŸŽ‰`);
                    setPreviewCount(-1);
                });
            };

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full flex flex-col"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ðŸŒŸ</div><h3 className="font-bold text-slate-800 text-lg flex items-center gap-2 mb-6 relative z-10"><span className="text-xl">ðŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤ ìžë™ ë¶€ì—¬</h3><div className="space-y-6 relative z-10 flex-1 flex flex-col justify-center"><div className="space-y-2"><label className="text-xs font-bold text-slate-500">ë‚ ì§œ ë° ê¸°ì¤€</label><div className="flex gap-2 items-center"><input type="date" value={stickerDate} onChange={e => { setStickerDate(e.target.value); setPreviewCount(-1); }} className="flex-1 p-2.5 border rounded-xl text-sm bg-slate-50 outline-none focus:border-indigo-500" /><select value={stickerRate} onChange={e => { setStickerRate(parseInt(e.target.value)); setPreviewCount(-1); }} className="p-2.5 border rounded-xl text-sm bg-slate-50 font-bold outline-none focus:border-indigo-500"><option value="100">100%</option><option value="80">80%â†‘</option><option value="50">50%â†‘</option></select></div></div><div className="space-y-2"><div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">ì§€ê¸‰ ê°œìˆ˜</label>{previewCount >= 0 && <span className="text-indigo-600 text-xs font-bold animate-fade-in">{previewCount}ëª… ëŒ€ìƒ</span>}</div><div className="flex items-center bg-slate-50 border rounded-xl overflow-hidden"><button onClick={() => setStickerAdd(Math.max(1, stickerAdd - 1))} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">-</button><span className="flex-1 text-center font-bold text-slate-700">{stickerAdd}ê°œ</span><button onClick={() => setStickerAdd(stickerAdd + 1)} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">+</button></div></div><div className="grid grid-cols-2 gap-3 pt-2"><Btn onClick={handlePreviewStickers} className="py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 text-sm">ëŒ€ìƒ í™•ì¸</Btn><Btn onClick={handleApplyStickers} className="py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 text-sm shadow-md">ì§€ê¸‰í•˜ê¸°</Btn></div></div></div>
            );
        };

        const MissingView = ({ students, records, dailyTasks }) => {
            const [filter, setFilter] = useState('today');
            
            const datesToCheck = useMemo(() => {
                const today = getToday();
                if (filter === 'today') return [today];
                return [
                    today,
                    dayjs().subtract(1, 'day').format('YYYY-MM-DD'),
                    dayjs().subtract(2, 'day').format('YYYY-MM-DD')
                ];
            }, [filter]);

            const missingData = useMemo(() => {
                const data = {};
                datesToCheck.forEach(date => {
                    const tasks = dailyTasks[date] || [];
                    if (tasks.length === 0) return;
                    
                    data[date] = tasks.map((task, idx) => {
                        const missingStudents = students.filter(s => {
                            const rec = records[date]?.[s.id];
                            if (rec && rec.tasks && rec.tasks[idx]) return false;
                            if (rec && !rec.tasks && rec.done) return false;
                            return true;
                        });
                        return { 
                            task: typeof task === 'object' ? task : { title: task, tag: 'ê¸°íƒ€' }, 
                            students: missingStudents 
                        };
                    }).filter(item => item.students.length > 0);
                });
                return data;
            }, [datesToCheck, dailyTasks, students, records]);

            const hasMissingData = Object.keys(missingData).some(date => missingData[date].length > 0);

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full">
                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">âš ï¸</div>
                    <div className="flex flex-wrap items-center gap-3 mb-6 relative z-10">
                        <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2"><span className="text-xl">âš ï¸</span> ê³¼ì œ ë¯¸ì œì¶œ ëª…ë‹¨</h3>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setFilter('today')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'today' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì˜¤ëŠ˜</button>
                            <button onClick={() => setFilter('recent3')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'recent3' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ìµœê·¼ 3ì¼</button>
                        </div>
                    </div>
                    <div className="relative z-10 space-y-4">
                        {!hasMissingData ? (
                            <div className="text-center py-6 text-slate-400 flex flex-col items-center bg-slate-50 rounded-xl border border-slate-200 border-dashed">
                                <Icon d={PATHS.check} size={32} className="mb-2 text-indigo-200"/>
                                <p className="text-sm">ë¯¸ì œì¶œ ë‚´ì—­ì´ ì—†ê±°ë‚˜ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. ðŸŽ‰</p>
                            </div>
                        ) : (
                            Object.entries(missingData).map(([date, items]) => {
                                if (items.length === 0) return null;
                                return (
                                    <div key={date} className="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                                        <div className="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-white/50">
                                            <h3 className="font-bold text-slate-700 flex items-center gap-2">ðŸ“… {dayjs(date).format('MMì›” DDì¼ (ddd)')}</h3>
                                            <span className="text-xs font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-lg border border-rose-100">ë¯¸ì œì¶œ {items.reduce((acc, curr) => acc + curr.students.length, 0)}ê±´</span>
                                        </div>
                                        <div className="divide-y divide-slate-200/50">
                                            {items.map((item, idx) => (
                                                <div key={idx} className="p-4">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-xs rounded-md font-bold">{item.task.tag}</span>
                                                        <span className="font-bold text-slate-700">{item.task.title}</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 mt-2">
                                                        {item.students.map(s => (
                                                            <span key={s.id} className="inline-flex items-center px-2.5 py-1 rounded-lg bg-white text-rose-600 text-xs font-bold border border-rose-100 shadow-sm">{s.order}. {s.name}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const ApiKeyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="Gemini API í‚¤ ë°œê¸‰ ë°©ë²•" icon={PATHS.key}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Googleì˜ <strong>Gemini API í‚¤</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ë¬´ë£Œ)</p>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-2">
                            <h4 className="font-bold text-slate-800">ðŸ”‘ ë°œê¸‰ ìˆœì„œ</h4>
                            <ol className="list-decimal pl-5 space-y-1">
                                <li>ì•„ëž˜ <strong>'Google AI Studio ë°”ë¡œê°€ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                <li>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</li>
                                <li>ì¢Œì¸¡ ìƒë‹¨ì˜ <strong>'Get API key'</strong> ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                                <li><strong>'Create API key'</strong>ë¥¼ í´ë¦­í•˜ì—¬ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
                                <li>ìƒì„±ëœ í‚¤(sk-...)ë¥¼ ë³µì‚¬í•˜ì—¬ ì´ ì•±ì˜ ì„¤ì • ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</li>
                            </ol>
                        </div>
                        <div className="flex justify-center">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2">
                                <Icon d={PATHS.link} size={16} /> Google AI Studio ë°”ë¡œê°€ê¸°
                            </a>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const NotionSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode, isPortfolioMode, setIsPortfolioMode, studentMap, setStudentMap, portfolioDbId, setPortfolioDbId }) => {
            const [apiKey, setApiKey] = useState("");
            const [dbId, setDbId] = useState("");
            const [saveLocally, setSaveLocally] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [isTesting, setIsTesting] = useState(false);
            const [testSuccess, setTestSuccess] = useState(false);
            const [manualInput, setManualInput] = useState("");
            const fileInputRef = useRef(null);
            const [activeTab, setActiveTab] = useState('record');

            useEffect(() => {
                if (isOpen) {
                    const savedKey = localStorage.getItem('cls_notion_key');
                    const savedDbId = localStorage.getItem('cls_notion_db_id');
                    
                    // [Fix] ì €ìž¥ëœ í‚¤/ID ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì œê±° (JSON.stringifyë¡œ ì¸í•´ ìƒê¸°ëŠ” ë¬¸ì œ í•´ê²°)
                    if (savedKey) {
                        setApiKey(savedKey.replace(/["']/g, '').trim());
                    }
                    if (savedDbId) {
                        setDbId(savedDbId.replace(/["']/g, '').trim());
                    }
                    
                    if (portfolioDbId && (portfolioDbId.includes('"') || portfolioDbId.includes("'"))) {
                        setPortfolioDbId(portfolioDbId.replace(/["']/g, '').trim());
                    }
                    if (savedKey || savedDbId) setSaveLocally(true);
                    
                    const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                    if (setIsPortfolioMode && savedMode !== isPortfolioMode) setIsPortfolioMode(savedMode);
                    setActiveTab(savedMode ? 'portfolio' : 'record');
                }
            }, [isOpen]);

            const handleTestConnection = async () => {
                const cleanKey = apiKey.replace(/["']/g, '').trim();
                if (!cleanKey) return showToast("API Keyë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");

                const cleanDbId = dbId.replace(/["']/g, '').trim();
                const cleanPortfolioId = portfolioDbId ? portfolioDbId.replace(/["']/g, '').trim() : "";
                
                const tests = [];
                if (cleanDbId) tests.push({ id: cleanDbId, mode: 'normal', label: 'ê¸°ë¡ ëª¨ë“œ' });
                if (cleanPortfolioId) tests.push({ id: cleanPortfolioId, mode: 'relation', label: 'í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ' });

                if (tests.length === 0) return showToast("Database IDë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");

                setIsTesting(true);
                setTestSuccess(false);
                
                let successCount = 0;
                let messages = [];

                for (const test of tests) {
                    try {
                        const response = await fetch('/api/save-notion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                personalKey: cleanKey, 
                                personalDbId: test.id,
                                testMode: true,
                                mode: test.mode
                            })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || data.message || "ì‹¤íŒ¨");
                        successCount++;
                        messages.push(`âœ… ${test.label}: ì„±ê³µ`);
                    } catch (e) {
                        messages.push(`âŒ ${test.label}: ${e.message}`);
                    }
                }

                setIsTesting(false);
                if (successCount > 0) {
                    setSaveLocally(true);
                    setTestSuccess(true);
                    setTimeout(() => setTestSuccess(false), 3000);
                }
                showToast(messages.join('\n'));
            };

            const handleSave = () => {
                const cleanKey = apiKey.replace(/["']/g, '').trim();
                const cleanDbId = dbId.replace(/["']/g, '').trim();
                const cleanPortfolioId = portfolioDbId ? portfolioDbId.replace(/["']/g, '').trim() : "";
                
                // [Fix] í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ëª…ì‹œì  ì €ìž¥
                localStorage.setItem('cls_portfolio_mode', isPortfolioMode);

                if (saveLocally) {
                    localStorage.setItem('cls_notion_key', cleanKey);
                    localStorage.setItem('cls_notion_db_id', cleanDbId);
                    if (cleanPortfolioId) localStorage.setItem('cls_notion_portfolio_db_id', cleanPortfolioId);

                    if (!isLocalMode && saveData) saveData({ 
                        cls_notion_key: cleanKey, 
                        cls_notion_db_id: cleanDbId,
                        cls_notion_portfolio_db_id: cleanPortfolioId,
                        cls_portfolio_mode: isPortfolioMode
                    });
                } else {
                    localStorage.removeItem('cls_notion_key');
                    localStorage.removeItem('cls_notion_db_id');
                    localStorage.removeItem('cls_notion_portfolio_db_id');
                    if (!isLocalMode && saveData) saveData({ cls_notion_key: "", cls_notion_db_id: "", cls_notion_portfolio_db_id: "" });
                }
                showToast("ë…¸ì…˜ ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            const handlePasteKey = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setApiKey(text);
                        showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const setTargetDbId = (val) => {
                const cleanVal = val.replace(/["']/g, '').trim();
                if (activeTab === 'portfolio') {
                    setPortfolioDbId(cleanVal);
                    localStorage.setItem('cls_notion_portfolio_db_id', cleanVal);
                } else {
                    setDbId(cleanVal);
                    localStorage.setItem('cls_notion_db_id', cleanVal);
                }
            };

            const extractAndSetDbId = (text) => {
                if (text.includes("notion.so")) {
                    const match = text.match(/([a-f0-9]{32})/);
                    if (match) {
                        setTargetDbId(match[1]);
                        return true;
                    }
                }
                setTargetDbId(text);
                return false;
            };

            const handlePasteDbId = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        if (extractAndSetDbId(text)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ë¶™ì—¬ë„£ì—ˆìŠµë‹ˆë‹¤.");
                        else showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const handlePortfolioToggle = (e) => {
                const checked = e.target.checked;
                if (setIsPortfolioMode) setIsPortfolioMode(checked);
                localStorage.setItem('cls_portfolio_mode', checked);
                if (showToast) showToast(checked ? "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œê°€ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤." : "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œê°€ ë¹„í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleFileUploadPortfolio = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const lines = text.split(/[\r\n]+/);
                    const newMap = { ...studentMap };
                    let count = 0;
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const parts = line.split(/[,:\t]+/).map(s => s.trim());
                        if (parts.length >= 2) {
                            const name = parts[0];
                            const id = parts[parts.length - 1];
                            if (name && id) { newMap[name] = id; count++; }
                        }
                    });
                    if (setStudentMap) setStudentMap(newMap);
                    localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                    if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
                    showToast(`${count}ëª…ì˜ ë°ì´í„°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleManualAdd = () => {
                if (!manualInput.trim()) return;
                const lines = manualInput.split(/[\r\n]+/);
                const newMap = { ...studentMap };
                let count = 0;
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/[:=,]+/).map(s => s.trim());
                    if (parts.length >= 2) {
                        const name = parts[0];
                        const id = parts[parts.length - 1];
                        if (name && id) { newMap[name] = id; count++; }
                    }
                });
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
                setManualInput("");
                showToast(`${count}ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            const handleDeleteItem = (name) => {
                const newMap = { ...studentMap };
                delete newMap[name];
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ““ Notion ì—°ë™ ì„¤ì •" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <p className="font-bold mb-1">ðŸ”‘ ê°œì¸ ë…¸ì…˜ ì—°ë™</p>
                            <p>ìž…ë ¥í•œ ì •ë³´ëŠ” ë¸Œë¼ìš°ì €(Local Storage)ì—ë§Œ ì €ìž¥ë˜ë©° ì„œë²„ì— ë³„ë„ë¡œ ì €ìž¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>

                        {showManual && (
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-slate-700 space-y-4 animate-fade-in">
                                <div>
                                    <h4 className="font-bold text-indigo-700 mb-2">ðŸš€ ë…¸ì…˜ ì—°ë™ 3ë‹¨ê³„ (ê³µí†µ)</h4>
                                    <ol className="list-decimal pl-4 space-y-1">
                                        <li><strong>í†µí•© ë§Œë“¤ê¸°:</strong> <a href="https://www.notion.so/my-integrations" target="_blank" className="text-blue-600 underline font-bold">ë…¸ì…˜ ë‚´ í†µí•©</a>ì—ì„œ 'ìƒˆ í†µí•©' ìƒì„± í›„ <strong>API Key</strong> ë³µì‚¬.</li>
                                        <li><strong>ì—°ê²°í•˜ê¸°:</strong> ì‚¬ìš©í•  ë…¸ì…˜ DB íŽ˜ì´ì§€ ìš°ì¸¡ ìƒë‹¨ <strong>[...] &gt; [ì—°ê²°]</strong>ì—ì„œ í†µí•© ì—°ê²°.</li>
                                        <li><strong>ID ì°¾ê¸°:</strong> DB íŽ˜ì´ì§€ URLì—ì„œ <strong>32ìžë¦¬ ID</strong> ë³µì‚¬.<br/><span className="text-[10px] text-slate-500 bg-white px-1 border rounded mt-1 inline-block">https://notion.so/.../<b>30a285...</b>?v=...</span></li>
                                    </ol>
                                </div>
                                
                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-2">ðŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ì†ì„± ì„¤ì • (í•„ìˆ˜)</h4>
                                    <p className="mb-2 text-slate-500">ë…¸ì…˜ DBì˜ ì†ì„± ì´ë¦„ê³¼ ìœ í˜•ì„ ì•„ëž˜ì™€ ë˜‘ê°™ì´ ë§žì¶°ì£¼ì„¸ìš”. (í´ë¦­í•˜ì—¬ ë³µì‚¬)</p>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <h5 className="font-bold text-slate-800 mb-2 border-b pb-1">âšª ê¸°ë³¸ ëª¨ë“œ (ê¸°ë¡ìš©)</h5>
                                            <ul className="space-y-1 text-slate-600">
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ì´ë¦„"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ì´ë¦„</button> (ì œëª©)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚ ì§œ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë‚ ì§œ</button> (ë‚ ì§œ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë¶„ë¥˜"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë¶„ë¥˜</button> (ì„ íƒ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚´ìš©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë‚´ìš©</button> (í…ìŠ¤íŠ¸)</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white p-3 rounded-lg border border-indigo-200 shadow-sm ring-1 ring-indigo-50">
                                            <h5 className="font-bold text-indigo-600 mb-2 border-b border-indigo-100 pb-1">ðŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ</h5>
                                            <ul className="space-y-1 text-slate-600">
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ì œëª©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ì œëª©</button> (ì œëª©)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ìƒì„±ì¼ì‹œ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ìƒì„±ì¼ì‹œ</button> (ë‚ ì§œ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë¶„ë¥˜"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ë¶„ë¥˜</button> (ì„ íƒ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚´ìš©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ë‚´ìš©</button> (í…ìŠ¤íŠ¸)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("í•™ìƒ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">í•™ìƒ</button> (ê´€ê³„í˜•)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-1">ðŸŒ Vercel ë°°í¬ìš© API ì½”ë“œ</h4>
                                    <p className="text-slate-500 mb-2">ì§ì ‘ ë°°í¬í•˜ì‹œëŠ” ê²½ìš° <code>api/save-notion.js</code> íŒŒì¼ì„ ìƒì„±í•˜ê³  ì•„ëž˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                                    <div className="relative group">
                                        <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white max-h-40 custom-scroll">
{`export default async function handler(req, res) {
    if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');
    let { personalKey, personalDbId, studentName, date, category, content, mode, studentIds, testMode } = req.body;

    const cleanKey = personalKey ? personalKey.replace(/["']/g, '').trim() : '';
    const cleanDbId = personalDbId ? personalDbId.toString().replace(/["']/g, '').trim() : '';

    if (!cleanKey || !cleanDbId) return res.status(400).json({ error: "ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });

    const titlePropertyName = (mode === 'relation') ? "ì œëª©" : "ì´ë¦„";
    let properties = {};
    const pageIcon = { type: "emoji", emoji: testMode ? "ðŸ§ª" : "ðŸ€" };

    if (testMode) {
        properties[titlePropertyName] = { "title": [{ "text": { "content": \`âœ… [\${titlePropertyName}] ì¹¸ ì—°ë™ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\` } }] };
    } else {
        if (mode === 'relation') {
            const summary = content ? (content.length > 15 ? content.substring(0, 15) + "..." : content) : "ìƒˆë¡œìš´ ê¸°ë¡";
            properties["ì œëª©"] = { "title": [{ "text": { "content": \`[\${category || "ê´€ì°°"}] \${summary}\` } }] };
            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };
            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };
            if (studentIds && studentIds.length > 0) properties["í•™ìƒ"] = { "relation": studentIds.map(id => ({ "id": id })) };
        } else {
            properties["ì´ë¦„"] = { "title": [{ "text": { "content": studentName || "í•™ìƒ" } }] };
            properties["ë‚ ì§œ"] = { "date": { "start": date || new Date().toISOString().split('T')[0] } };
            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };
            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };
        }
    }

    try {
        // ðŸŒŸ 1. ì„ ìƒë‹˜ì˜ êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸(ìš°ì²´êµ­) ì£¼ì†Œë¥¼ ìž…ë ¥í•˜ì„¸ìš”!
        const GAS_NOTION_PROXY_URL = "https://script.google.com/macros/s/AKfycbyhVCL0YnHhi_d9Je-8jzah_UK5cC4MZnrccsEbfG5VCQD8v66nqPAlZ9EcWbc7gL-nag/exec";

        // ðŸŒŸ 2. í•˜ì´íŒ¨ìŠ¤ ìš°ì²´êµ­ìœ¼ë¡œ ë°ì´í„° í¬ìž¥í•´ì„œ ì˜ê¸°
        const response = await fetch(GAS_NOTION_PROXY_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'text/plain;charset=utf-8' // ë¸Œë¼ìš°ì € ë³´ì•ˆ ê²€ì‚¬(CORS) í”„ë¦¬íŒ¨ìŠ¤!
            },
            body: JSON.stringify({
                appkey: "saysemin",
                apiKey: cleanKey,                           // ë§ˆìŠ¤í„°í‚¤ í¬ìž¥
                url: 'https://api.notion.com/v1/pages',     // ìµœì¢… ëª©ì ì§€
                method: 'POST',
                payload: {                                  // ì‹¤ì œ ë…¸ì…˜ì— ë“¤ì–´ê°ˆ ë°ì´í„° ë©ì–´ë¦¬
                    parent: { database_id: cleanDbId }, 
                    icon: pageIcon, 
                    properties: properties 
                }
            })
        });
        const data = await response.json();
        if (!response.ok) return res.status(response.status).json(data);
        res.status(200).json({ success: true });
    } catch (error) { res.status(500).json({ error: error.message }); }
}`}
                                        </div>
                                        <button onClick={() => { 
                                            const code = `export default async function handler(req, res) {\n    if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');\n    let { personalKey, personalDbId, studentName, date, category, content, mode, studentIds, testMode } = req.body;\n\n    const cleanKey = personalKey ? personalKey.replace(/["']/g, '').trim() : '';\n    const cleanDbId = personalDbId ? personalDbId.toString().replace(/["']/g, '').trim() : '';\n\n    if (!cleanKey || !cleanDbId) return res.status(400).json({ error: "ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });\n\n    const titlePropertyName = (mode === 'relation') ? "ì œëª©" : "ì´ë¦„";\n    let properties = {};\n    const pageIcon = { type: "emoji", emoji: testMode ? "ðŸ§ª" : "ðŸ€" };\n\n    if (testMode) {\n        properties[titlePropertyName] = { "title": [{ "text": { "content": \`âœ… [\${titlePropertyName}] ì¹¸ ì—°ë™ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\` } }] };\n    } else {\n        if (mode === 'relation') {\n            const summary = content ? (content.length > 15 ? content.substring(0, 15) + "..." : content) : "ìƒˆë¡œìš´ ê¸°ë¡";\n            properties["ì œëª©"] = { "title": [{ "text": { "content": \`[\${category || "ê´€ì°°"}] \${summary}\` } }] };\n            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };\n            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };\n            if (studentIds && studentIds.length > 0) properties["í•™ìƒ"] = { "relation": studentIds.map(id => ({ "id": id })) };\n        } else {\n            properties["ì´ë¦„"] = { "title": [{ "text": { "content": studentName || "í•™ìƒ" } }] };\n            properties["ë‚ ì§œ"] = { "date": { "start": date || new Date().toISOString().split('T')[0] } };\n            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };\n            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };\n        }\n    }\n\n    try {\n        // ðŸŒŸ 1. ì„ ìƒë‹˜ì˜ êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸(ìš°ì²´êµ­) ì£¼ì†Œë¥¼ ìž…ë ¥í•˜ì„¸ìš”!
        const GAS_NOTION_PROXY_URL = "https://script.google.com/macros/s/AKfycbyhVCL0YnHhi_d9Je-8jzah_UK5cC4MZnrccsEbfG5VCQD8v66nqPAlZ9EcWbc7gL-nag/exec";

        // ðŸŒŸ 2. í•˜ì´íŒ¨ìŠ¤ ìš°ì²´êµ­ìœ¼ë¡œ ë°ì´í„° í¬ìž¥í•´ì„œ ì˜ê¸°
        const response = await fetch(GAS_NOTION_PROXY_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'text/plain;charset=utf-8' // ë¸Œë¼ìš°ì € ë³´ì•ˆ ê²€ì‚¬(CORS) í”„ë¦¬íŒ¨ìŠ¤!
            },
            body: JSON.stringify({
                appkey: "saysemin",
                apiKey: cleanKey,                           // ì„ ìƒë‹˜ì˜ ë…¸ì…˜ ë§ˆìŠ¤í„°í‚¤
                url: 'https://api.notion.com/v1/pages',     // ë…¸ì…˜ì˜ ìµœì¢… ëª©ì ì§€ ì£¼ì†Œ
                method: 'POST',
                payload: {                                  // ì‹¤ì œ ë…¸ì…˜ì— ë“¤ì–´ê°ˆ ë°ì´í„° ë©ì–´ë¦¬
                    parent: { database_id: cleanDbId }, 
                    icon: pageIcon, 
                    properties: properties 
                }
            })
        });        const data = await response.json();\n        if (!response.ok) return res.status(response.status).json(data);\n        res.status(200).json({ success: true });\n    } catch (error) { res.status(500).json({ error: error.message }); }\n}`; 
                                            navigator.clipboard.writeText(code); 
                                            showToast("âœ… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                                        }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                            <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Notion API Key (Secret)</label>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="secret_..." />
                                    {apiKey && (
                                        <button onClick={() => setApiKey("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                            <Icon d={PATHS.x} size={14} />
                                        </button>
                                    )}
                                </div>
                                <Btn onClick={handlePasteKey} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                            </div>
                        </div>
                        
                        <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                            <button onClick={() => setActiveTab('record')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'record' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}>âšª ì¼ë°˜ ê¸°ë¡ ëª¨ë“œ</button>
                            <button onClick={() => setActiveTab('portfolio')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'portfolio' ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}>ðŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ</button>
                        </div>
                        
                        {activeTab === 'record' && (
                            <div className="space-y-2 animate-fade-in">
                                <label className="text-xs font-bold text-slate-500">ì¼ë°˜ ê¸°ë¡ìš© DB ID (ë‹¨ìˆœ ê¸°ë¡)</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type="text" value={dbId} onChange={e => { const val = e.target.value.replace(/"/g, ''); if(extractAndSetDbId(val)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤."); else setDbId(val); }} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="32ìžë¦¬ ID (URL ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)" />
                                        {dbId && (
                                            <button onClick={() => setDbId("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                                <Icon d={PATHS.x} size={14} />
                                            </button>
                                        )}
                                    </div>
                                    <Btn onClick={handlePasteDbId} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                                </div>
                                <p className="text-[10px] text-slate-400">í•™ìƒì˜ í™œë™ì„ ë‚ ì§œë³„ë¡œ ë‹¨ìˆœ ê¸°ë¡í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ìž…ë‹ˆë‹¤.</p>
                            </div>
                        )}

                        {activeTab === 'portfolio' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex items-center justify-between bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                                    <span className="text-xs font-bold text-indigo-700">í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ëŠ¥ í™œì„±í™”</span>
                                    <div className="relative">
                                        <input type="checkbox" className="sr-only" checked={isPortfolioMode} onChange={handlePortfolioToggle} />
                                        <div className={`w-9 h-5 rounded-full shadow-inner transition-colors ${isPortfolioMode ? 'bg-indigo-500' : 'bg-slate-300'}`}></div>
                                        <div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full shadow transition-transform ${isPortfolioMode ? 'translate-x-4' : ''}`}></div>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500">í¬íŠ¸í´ë¦¬ì˜¤ìš© DB ID (í•™ìƒê³¼ ì—°ê²°)</label>
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <input type="text" value={portfolioDbId} onChange={e => { const val = e.target.value.replace(/"/g, ''); if(extractAndSetDbId(val)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤."); else setPortfolioDbId(val); }} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="32ìžë¦¬ ID (URL ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)" />
                                            {portfolioDbId && (
                                                <button onClick={() => setPortfolioDbId("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                                    <Icon d={PATHS.x} size={14} />
                                                </button>
                                            )}
                                        </div>
                                        <Btn onClick={handlePasteDbId} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-4 animate-fade-in">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xs font-bold text-slate-600">ëª…ë‹¨ ê´€ë¦¬ (ì´ë¦„:ë…¸ì…˜ID)</h4>
                                    <Btn onClick={() => fileInputRef.current.click()} className="px-2 py-1 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50">ðŸ“‚ ì—‘ì…€(CSV) ì—…ë¡œë“œ</Btn>
                                    <input type="file" ref={fileInputRef} onChange={handleFileUploadPortfolio} className="hidden" accept=".csv,.txt" />
                                </div>
                                <div className="max-h-32 overflow-y-auto custom-scroll bg-white border border-slate-200 rounded-lg p-2 space-y-1">
                                    {studentMap && Object.keys(studentMap).length > 0 ? (
                                        Object.entries(studentMap).sort((a, b) => a[0].localeCompare(b[0])).map(([name, id]) => (
                                            <div key={name} className="flex justify-between items-center text-xs p-1 hover:bg-slate-50 rounded">
                                                <span className="font-bold text-slate-700">{name}</span>
                                                <div className="flex items-center gap-2"><span className="text-slate-400 font-mono text-[10px] truncate max-w-[100px]">{id}</span><button onClick={() => handleDeleteItem(name)} className="text-rose-400 hover:text-rose-600">Ã—</button></div>
                                            </div>
                                        ))
                                    ) : (<div className="text-center text-slate-400 text-xs py-4">ë“±ë¡ëœ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                </div>
                                <div className="flex gap-2">
                                    <textarea value={manualInput} onChange={e => setManualInput(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-indigo-500 resize-none" placeholder="ì´ë¦„:ID (ì—¬ëŸ¬ ëª…ì€ ì¤„ë°”ê¿ˆ)" rows="2" />
                                    <Btn onClick={handleManualAdd} className="px-3 bg-indigo-500 text-white rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn>
                                </div>
                            </div>
                            </div>
                        )}

                        <label className="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" checked={saveLocally} onChange={e => setSaveLocally(e.target.checked)} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                            <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— ì •ë³´ ì €ìž¥í•˜ê¸°</span>
                        </label>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTestConnection} disabled={isTesting} className={`flex-1 py-3 rounded-xl font-bold transition-colors ${testSuccess ? 'bg-green-500 text-white border border-green-500 hover:bg-green-600' : 'bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50'}`}>
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>í™•ì¸ ì¤‘...</> : testSuccess ? 'âœ… ì—°ë™ ì„±ê³µ!' : 'ðŸ”Œ ì—°ë™ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md transition-colors">ì„¤ì • ì €ìž¥í•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const GoogleSheetSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode }) => {
            const [url, setUrl] = useState("");
            const [isTesting, setIsTesting] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [testSuccess, setTestSuccess] = useState(false);
            const [saveLocally, setSaveLocally] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    let savedUrl = localStorage.getItem('cls_google_sheet_url') || "";
                    // ðŸŒŸ ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì°Œêº¼ê¸° 1ì°¨ ì œê±°
                    savedUrl = savedUrl.trim().replace(/^"|'|"$|'$/g, '');
                    setUrl(savedUrl);
                    if (savedUrl) setSaveLocally(true);
                }
            }, [isOpen]);

            const handleTestConnection = async () => {
                // ðŸŒŸ í…ŒìŠ¤íŠ¸í•  ë•Œë„ ì•ˆì „í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì „ì†¡
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                if (!cleanUrl) return showToast("URLì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsTesting(true);
                setTestSuccess(false);
                try {
                    await fetch(cleanUrl, {
                        method: "POST",
                        mode: 'no-cors',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ date: dayjs().format('YYYY-MM-DD HH:mm:ss'), name: "í…ŒìŠ¤íŠ¸", category: "ì—°ë™ í…ŒìŠ¤íŠ¸", content: "Google ì‹œíŠ¸ ì—°ë™ ì„±ê³µ!" })
                    });
                    showToast("âœ… ì „ì†¡ ì„±ê³µ! ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    setTestSuccess(true);
                    setTimeout(() => setTestSuccess(false), 3000);
                } catch (e) {
                    showToast("âŒ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
                    setTestSuccess(false);
                } finally {
                    setIsTesting(false);
                }
            };

            const handleSave = () => {
                // ðŸŒŸ ì˜êµ¬ ì €ìž¥í•  ë•Œ ì™„ë²½í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì €ìž¥
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                
                if (saveLocally) {
                    localStorage.setItem('cls_google_sheet_url', cleanUrl);
                    if (!isLocalMode && saveData) saveData('cls_google_sheet_url', cleanUrl);
                } else {
                    localStorage.removeItem('cls_google_sheet_url');
                    if (!isLocalMode && saveData) saveData('cls_google_sheet_url', "");
                }
                
                showToast("ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ“Š êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-green-50 p-4 rounded-xl border border-green-200 text-sm text-green-800">
                            <p className="font-bold mb-1">ðŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™</p>
                            <p>ê¸°ë¡ëœ ë°ì´í„°ë¥¼ êµ¬ê¸€ ì‹œíŠ¸ì— ìžë™ìœ¼ë¡œ í•œ ì¤„ì”© ì¶”ê°€í•©ë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>
                        {showManual && (
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-600 space-y-2 animate-fade-in">
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± &gt; <strong>í™•ìž¥ í”„ë¡œê·¸ëž¨ &gt; Apps Script</strong></li>
                                    <li>ì•„ëž˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸° &gt; ì €ìž¥
                                <div className="relative mt-2 mb-2 group">
                                    <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white">
{`function doPost(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);

    // ðŸŒŸ 1. ì—¬ëŸ¬ ëª…ì˜ ë°ì´í„°ê°€ í•œêº¼ë²ˆì— 'ë°°ì—´(ë°•ìŠ¤)'ë¡œ ë“¤ì–´ì˜¨ ê²½ìš° (ì´ˆê³ ì† ì¼ê´„ ì €ìž¥)
    if (Array.isArray(data)) {
      var rows = [];
      for (var i = 0; i < data.length; i++) {
        // [ì£¼ì˜] Aì—´:ë‚ ì§œ, Bì—´:ì´ë¦„, Cì—´:ë¶„ë¥˜, Dì—´:ë‚´ìš© ìˆœì„œìž…ë‹ˆë‹¤.
        rows.push([data[i].date, data[i].name, data[i].category, data[i].content]);
      }
      
      // êµ¬ê¸€ ì‹œíŠ¸ì˜ ë¹ˆ ì¤„ì„ ì°¾ì•„ì„œ, ì—¬ëŸ¬ ì¤„ì„ ë‹¨ 0.1ì´ˆ ë§Œì— í•œ ë²ˆì— ìŸì•„ë¶“ìŠµë‹ˆë‹¤!
      if (rows.length > 0) {
        sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
      }
    } 
    // ðŸŒŸ 2. ê¸°ì¡´ì²˜ëŸ¼ 1ëª… ë¶„ëŸ‰ì˜ ë°ì´í„°ë§Œ ë“¤ì–´ì˜¨ ê²½ìš° (ì•ˆì „ìž¥ì¹˜)
    else {
      sheet.appendRow([data.date, data.name, data.category, data.content]);
    }

    return ContentService.createTextOutput(JSON.stringify({"result": "success", "message": "ì´ˆê³ ì† ì €ìž¥ ì„±ê³µ!"}))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({"result": "error", "error": error.toString()}))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}`}
                                    </div>
                                    <button onClick={() => { const code = `function doPost(e) {\n  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();\n  var data = JSON.parse(e.postData.contents);\n  sheet.appendRow([data.date, data.name, data.category, data.content]);\n  return ContentService.createTextOutput("Success");\n}`; navigator.clipboard.writeText(code); showToast("âœ… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                        <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                    </button>
                                        </div>
                                    </li>
                                    <li><strong>ë°°í¬ &gt; ìƒˆ ë°°í¬</strong> (ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´ ë°˜ë“œì‹œ 'ìƒˆ ë²„ì „'ìœ¼ë¡œ ë°°í¬í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤!)</li>
                                    <li>ìœ í˜•: <strong>ì›¹ ì•±</strong> &gt; ì•¡ì„¸ìŠ¤ ê¶Œí•œ: <strong>ëª¨ë“  ì‚¬ìš©ìž</strong> (í•„ìˆ˜)</li>
                                    <li>ìƒì„±ëœ <strong>ì›¹ ì•± URL</strong>ì„ ì•„ëž˜ì— ìž…ë ¥í•˜ì„¸ìš”.</li>
                                </ol>
                            </div>
                        )}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Web App URL</label>
                            <div className="relative">
                                <input type="text" value={url} onChange={e => setUrl(e.target.value)} className="w-full p-3 pr-10 border rounded-xl text-sm outline-none focus:border-green-500 font-mono" placeholder="https://script.google.com/macros/s/..." />
                                {url && (
                                    <button onClick={() => setUrl("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                        <Icon d={PATHS.x} size={16} />
                                    </button>
                                )}
                            </div>
                        </div>
                        <label className="flex items-center gap-2 cursor-pointer select-none mt-4">
                            <input type="checkbox" checked={saveLocally} onChange={e => setSaveLocally(e.target.checked)} className="w-4 h-4 text-green-600 rounded focus:ring-green-500" />
                            <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— ì •ë³´ ì €ìž¥í•˜ê¸°</span>
                        </label>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTestConnection} disabled={isTesting} className={`flex-1 py-3 rounded-xl font-bold transition-colors ${testSuccess ? 'bg-green-500 text-white border border-green-500 hover:bg-green-600' : 'bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50'}`}>
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>í™•ì¸ ì¤‘...</> : testSuccess ? 'âœ… ì—°ë™ ì„±ê³µ!' : 'ðŸ”Œ ì—°ë™ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md transition-colors">ì„¤ì • ì €ìž¥í•˜ê¸°</Btn>
                        </div>

                    </div>
                </BaseModal>
            );
        };

        const ApiKeySetupModal = ({ isOpen, onClose, apiKey, setApiKey, saveData, isLocalMode, showToast, validateApiKey }) => {
            const [isChecking, setIsChecking] = useState(false);
            const [isSaved, setIsSaved] = useState(!!localStorage.getItem('cls_ai_key'));
            const [showHelp, setShowHelp] = useState(false);
            const [usage, setUsage] = useState(0);
            const [usageHistory, setUsageHistory] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setIsSaved(!!localStorage.getItem('cls_ai_key'));
                    setUsageHistory(JSON.parse(localStorage.getItem('cls_ai_usage_history') || '{}'));
                }
            }, [isOpen]);

            const handleCheck = async () => {
                setIsChecking(true);
                await validateApiKey();
                setIsChecking(false);
            };

            const handlePasteKey = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setApiKey(text);
                        showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const handleSaveToggle = (e) => {
                const checked = e.target.checked;
                setIsSaved(checked);
                if (checked) {
                    if(!isLocalMode) saveData('cls_ai_key', apiKey);
                    else localStorage.setItem('cls_ai_key', apiKey);
                } else {
                    if(!isLocalMode) saveData('cls_ai_key', "");
                    else localStorage.removeItem('cls_ai_key');
                }
            };

            const handleSaveAndClose = () => {
                if (isSaved) {
                    if(!isLocalMode) {
                        saveData('cls_ai_key', apiKey);
                        // [Fix] saveDataê°€ ë¬¸ìžì—´ì— ë”°ì˜´í‘œë¥¼ ì¶”ê°€í•˜ì—¬ ì €ìž¥í•˜ëŠ” ë¬¸ì œ ë°©ì§€ (ë®ì–´ì“°ê¸°)
                        localStorage.setItem('cls_ai_key', apiKey);
                    }
                    else localStorage.setItem('cls_ai_key', apiKey);
                    if(apiKey) showToast("API í‚¤ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    if(!isLocalMode) saveData('cls_ai_key', "");
                    else localStorage.removeItem('cls_ai_key');
                }
                onClose();
            };

            const renderUsageGraph = () => {
                const today = dayjs();
                const last7Days = Array.from({length: 7}, (_, i) => today.subtract(6 - i, 'day').format('YYYY-MM-DD'));
                const data = last7Days.map(d => ({ date: d, count: usageHistory[d] || 0 }));
                const maxCount = Math.max(...data.map(d => d.count), 5); // Minimum scale 5

                return (
                    <div className="mt-4 pt-4 border-t border-slate-100">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-slate-500">ìµœê·¼ 7ì¼ ì‚¬ìš©ëŸ‰</span>
                            <span className="text-[10px] text-slate-400">ì´ {usage}íšŒ</span>
                        </div>
                        <div className="flex items-end justify-between h-24 gap-2">
                            {data.map((d, i) => {
                                const height = Math.max((d.count / maxCount) * 100, 5); // Min height 5%
                                const isToday = d.date === today.format('YYYY-MM-DD');
                                return (
                                    <div key={i} className="flex flex-col items-center flex-1 gap-1 group relative">
                                        <div className="w-full bg-slate-100 rounded-t-md relative flex items-end justify-center overflow-hidden h-full">
                                            <div 
                                                className={`w-full transition-all duration-500 ease-out ${isToday ? 'bg-indigo-500' : 'bg-indigo-300 group-hover:bg-indigo-400'}`} 
                                                style={{ height: `${height}%` }}
                                            ></div>
                                            {d.count > 0 && (
                                                <span className="absolute bottom-1 text-[9px] font-bold text-white drop-shadow-md">{d.count}</span>
                                            )}
                                        </div>
                                        <span className={`text-[9px] ${isToday ? 'font-bold text-indigo-600' : 'text-slate-400'}`}>
                                            {dayjs(d.date).format('MM/DD')}
                                        </span>
                                        {d.count > 0 && (
                                            <div className="absolute bottom-full mb-1 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                                {d.count}íšŒ
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ¤– AI ì„¤ì •" icon={null}>
                    <ApiKeyHelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-bold mb-1">ðŸ”‘ Gemini API Key ì„¤ì •</p>
                                    <p>Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ìž…ë ¥í•˜ì„¸ìš”. (ë¬´ë£Œ)</p>
                                </div>
                                <div className="flex flex-col items-end">
                                    <span className="text-[10px] font-bold text-slate-400 mb-0.5">Model</span>
                                    <span className="text-[10px] bg-white border border-slate-200 px-2 py-1 rounded-lg text-indigo-600 font-bold font-mono">
                                        {GEMINI_MODEL_NAME}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <div className="flex justify-between items-center">
                                <label className="text-xs font-bold text-slate-500">API Key</label>
                                <button onClick={() => setShowHelp(true)} className="text-[10px] text-indigo-500 hover:underline flex items-center gap-0.5">í‚¤ ë°œê¸‰ ë°©ë²• <Icon d={PATHS.help} size={10} /></button>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <input type="password" autoComplete="new-password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="API Keyë¥¼ ìž…ë ¥í•˜ì„¸ìš”.." />
                                    {apiKey && (
                                        <button onClick={() => setApiKey("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                            <Icon d={PATHS.x} size={14} />
                                        </button>
                                    )}
                                </div>
                                <Btn onClick={handlePasteKey} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                                <Btn onClick={handleCheck} className="bg-indigo-600 text-white px-4 rounded-xl text-xs font-bold hover:bg-indigo-700 whitespace-nowrap">{isChecking ? 'í™•ì¸ ì¤‘...' : 'í™•ì¸'}</Btn>
                            </div>
                        </div>
                        
                        {renderUsageGraph()}

                        <div className="flex justify-between items-center pt-2">
                            <label className="flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" checked={isSaved} onChange={handleSaveToggle} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                                <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— í‚¤ ì €ìž¥í•˜ê¸°</span>
                            </label>
                        </div>
                        <Btn onClick={handleSaveAndClose} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 mt-4 shadow-md">ì €ìž¥ ë° ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ManualModal = ({ isOpen, onClose, content, onDownload }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ“˜ ì‚¬ìš© ì„¤ëª…ì„œ" icon={PATHS.book} maxWidth="max-w-3xl">
                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 h-[60vh] overflow-y-auto custom-scroll whitespace-pre-wrap text-sm leading-relaxed text-slate-700 font-mono select-text shadow-inner">
                        {content}
                    </div>
                    <div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
                        <Btn onClick={onDownload} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-md transition-transform active:scale-95">
                            <Icon d={PATHS.download} size={18} /> í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                        </Btn>
                        <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ClassToolsModal = ({ isOpen, onClose, students }) => {
            const [activeTab, setActiveTab] = useState('picker');
            const [pickedStudent, setPickedStudent] = useState(null);
            const [isPicking, setIsPicking] = useState(false);
            const [timerTime, setTimerTime] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => {
                if (isTimerRunning && timerTime > 0) {
                    timerRef.current = setInterval(() => setTimerTime(t => t - 1), 1000);
                } else {
                    clearInterval(timerRef.current);
                    if (timerTime === 0 && isTimerRunning) {
                        setIsTimerRunning(false);
                        confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#ef4444', '#f87171'] });
                    }
                }
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning, timerTime]);

            const handlePick = () => {
                if (students.length === 0) return;
                setIsPicking(true);
                let count = 0;
                const interval = setInterval(() => {
                    setPickedStudent(students[Math.floor(Math.random() * students.length)]);
                    count++;
                    if (count > 20) {
                        clearInterval(interval);
                        setIsPicking(false);
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                }, 100);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (s % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ§° í•™ê¸‰ ë„êµ¬ ìƒìž" icon={PATHS.settings} maxWidth="max-w-md">
                    <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                        <button onClick={() => setActiveTab('picker')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'picker' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ðŸŽ² ë°œí‘œìž ë½‘ê¸°</button>
                        <button onClick={() => setActiveTab('timer')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'timer' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>â±ï¸ íƒ€ì´ë¨¸</button>
                    </div>

                    {activeTab === 'picker' && (
                        <div className="flex flex-col items-center py-4 space-y-6">
                            <div className="text-4xl font-bold text-slate-800 h-20 flex items-center justify-center">{pickedStudent ? pickedStudent.name : <span className="text-slate-300 text-6xl">?</span>}</div>
                            <Btn onClick={handlePick} disabled={isPicking} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                {isPicking ? 'ë‘êµ¬ë‘êµ¬...' : 'ë°œí‘œìž ë½‘ê¸°!'}
                            </Btn>
                        </div>
                    )}

                    {activeTab === 'timer' && (
                        <div className="flex flex-col items-center py-2 space-y-6">
                            <div className={`text-7xl font-mono font-bold tabular-nums tracking-wider ${timerTime <= 10 && timerTime > 0 && isTimerRunning ? 'text-rose-500 animate-pulse' : 'text-slate-800'}`}>{formatTime(timerTime)}</div>
                            <div className="grid grid-cols-4 gap-2 w-full">
                                {[10, 60, 180, 300].map(sec => (
                                    <Btn key={sec} onClick={() => setTimerTime(t => t + sec)} className="py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200">+{sec < 60 ? sec + 'ì´ˆ' : sec / 60 + 'ë¶„'}</Btn>
                                ))}
                            </div>
                            <div className="flex gap-3 w-full">
                                <Btn onClick={() => { setIsTimerRunning(false); setTimerTime(0); }} className="flex-1 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ì´ˆê¸°í™”</Btn>
                                <Btn onClick={() => setIsTimerRunning(!isTimerRunning)} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md ${isTimerRunning ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'}`}>{isTimerRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œìž‘'}</Btn>
                            </div>
                        </div>
                    )}
                </BaseModal>
            );
        };

        const InstallGuideModal = ({ isOpen, onClose, onInstall, isIOS }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ“² ì•± ì„¤ì¹˜ ì•ˆë‚´" icon={PATHS.download} maxWidth="max-w-md">
                    <div className="space-y-6 text-center">
                        {/* ðŸ“¸ ìƒˆë¡œìš´ ì‚¬ì§„ ë²„íŠ¼ ì˜ì—­ ì‹œìž‘ */}
<div className="relative group mx-auto w-20 h-20 mb-3 cursor-pointer" onClick={(e) => e.stopPropagation()}>
    <div className="w-full h-full rounded-full overflow-hidden border-4 border-white shadow-md bg-slate-100 flex items-center justify-center">
        {selectedStudent?.photoUrl ? (
            <img src={selectedStudent.photoUrl} alt="í•™ìƒ ì‚¬ì§„" className="w-full h-full object-cover" />
        ) : (
            <Icon d={PATHS.user} className="text-slate-300" size={40} />
        )}
    </div>
    <label className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
        <span className="text-white text-xs font-bold">ì‚¬ì§„ ë³€ê²½</span>
        <input 
            type="file" 
            accept="image/*" 
            className="hidden" 
            onChange={(e) => handlePhotoUpload(e, selectedStudent?.id || student?.id)} 
        />
    </label>
</div>
{/* ðŸ“¸ ìƒˆë¡œìš´ ì‚¬ì§„ ë²„íŠ¼ ì˜ì—­ ë */}
                        <div className="space-y-2">
                            <h3 className="text-xl font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€í•´ë³´ì„¸ìš”!</h3>
                            <p className="text-sm text-slate-500 leading-relaxed">
                                ì•±ì„ ì„¤ì¹˜í•˜ë©´ ë” íŽ¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-left">
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">âš¡ï¸ ë¹ ë¥¸ ì‹¤í–‰</div><div className="text-xs text-slate-500">í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì ‘ì†í•˜ì„¸ìš”.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ðŸ–¥ï¸ ë„“ì€ í™”ë©´</div><div className="text-xs text-slate-500">ì£¼ì†Œì°½ ì—†ì´ ë„“ê²Œ ë´…ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ðŸ’¾ ì˜¤í”„ë¼ì¸</div><div className="text-xs text-slate-500">ì¸í„°ë„· ì—†ì´ë„ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ðŸ”„ ìžë™ ì—…ë°ì´íŠ¸</div><div className="text-xs text-slate-500">í•­ìƒ ìµœì‹  ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.</div></div>
                        </div>
                        
                        {isIOS ? (
                            <div className="bg-slate-100 p-4 rounded-xl text-left text-sm space-y-2 animate-fade-in">
                                <p className="font-bold text-slate-700 flex items-center gap-2">ðŸŽ ì•„ì´í°/ì•„ì´íŒ¨ë“œ ì„¤ì¹˜ ë°©ë²•</p>
                                <ol className="list-decimal pl-5 space-y-1 text-slate-600 text-xs">
                                    <li>ì‚¬íŒŒë¦¬(Safari) í•˜ë‹¨ì˜ <span className="font-bold text-blue-500">ê³µìœ (Share)</span> ë²„íŠ¼ í„°ì¹˜</li>
                                    <li>ë©”ë‰´ì—ì„œ <span className="font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€</span> ì„ íƒ</li>
                                    <li>ìš°ì¸¡ ìƒë‹¨ì˜ <span className="font-bold text-blue-500">ì¶”ê°€</span> ë²„íŠ¼ í„°ì¹˜</li>
                                </ol>
                            </div>
                        ) : (
                            <Btn onClick={onInstall} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <Icon d={PATHS.download} /> ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°
                            </Btn>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const DataCleanupModal = ({ isOpen, onClose, groupsByDate, records, setGroupsByDate, setRecords, saveData, isLocalMode, showToast, onBackup }) => {
            const [targetDate, setTargetDate] = useState(dayjs().subtract(1, 'year').format('YYYY-MM-DD'));
            
            const cleanupStats = useMemo(() => {
                let groupCount = 0;
                let recordCount = 0;
                
                Object.keys(groupsByDate).forEach(date => { if (date < targetDate) groupCount++; });
                Object.keys(records).forEach(date => { if (date < targetDate) recordCount++; });
                
                return { groupCount, recordCount };
            }, [groupsByDate, records, targetDate]);

            const handleCleanup = () => {
                if (cleanupStats.groupCount === 0 && cleanupStats.recordCount === 0) { showToast("ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                if (!confirm(`${targetDate} ì´ì „ì˜ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ëª¨ë‘  ê¸°ë¡: ${cleanupStats.groupCount}ê±´\n- í™œë™ ê¸°ë¡: ${cleanupStats.recordCount}ê±´\n\n(ì•ˆì „ì„ ìœ„í•´ í˜„ìž¬ ë°ì´í„°ê°€ ìžë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤)`)) return;

                // ìžë™ ë°±ì—… ì‹¤í–‰
                if (onBackup) onBackup();

                const newGroups = { ...groupsByDate };
                const newRecords = { ...records };
                const deletedGroupDates = [];
                const deletedRecordDates = [];
                Object.keys(newGroups).forEach(date => { if (date < targetDate) { delete newGroups[date]; deletedGroupDates.push(date); } });
                Object.keys(newRecords).forEach(date => { if (date < targetDate) { delete newRecords[date]; deletedRecordDates.push(date); } });

                setGroupsByDate(newGroups);
                setRecords(newRecords);
                
                if (!isLocalMode) {
                    // saveData({ cls_records: newRecords }); // [Fix] recordsëŠ” ë³„ë„ í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë¨ (ì‚­ì œëŠ” deleteRecordsFromFirestore ì‚¬ìš©)
                    // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ë¬¸ì„œ ì‚­ì œ
                    if (deletedGroupDates.length > 0) deleteGroupsFromFirestore(deletedGroupDates);
                    if (deletedRecordDates.length > 0) deleteRecordsFromFirestore(deletedRecordDates);
                }
                else { localStorage.setItem('cls_groups_date', JSON.stringify(newGroups)); localStorage.setItem('cls_records', JSON.stringify(newRecords)); }
                
                showToast("ë°ì´í„° ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ§¹ ë°ì´í„° ì •ë¦¬ ë„êµ¬" icon={PATHS.trash}>
                    <div className="space-y-4">
                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm text-orange-800"><p className="font-bold mb-1">âš ï¸ ì˜¤ëž˜ëœ ë°ì´í„° ì •ë¦¬</p><p className="text-xs opacity-80">ì €ìž¥ ìš©ëŸ‰ í™•ë³´ë¥¼ ìœ„í•´ ì˜¤ëž˜ëœ ê¸°ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤.<br/>ì‚­ì œ ê¸°ì¤€ì¼ ì´ì „ì˜ ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.</p></div>
                        <div className="flex flex-col gap-2"><label className="text-xs font-bold text-slate-500">ì‚­ì œ ê¸°ì¤€ì¼ (ì´ ë‚ ì§œ ì´ì „ ë°ì´í„° ì‚­ì œ)</label><input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-orange-500" /><div className="flex justify-end gap-2 mt-1"><button onClick={() => setTargetDate(dayjs().subtract(6, 'month').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">6ê°œì›” ì „</button><button onClick={() => setTargetDate(dayjs().subtract(1, 'year').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">1ë…„ ì „</button></div></div>
                        <div className="bg-white border border-slate-200 rounded-xl p-4 space-y-2">
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ëª¨ë‘  ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.groupCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  í™œë™ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.recordCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ê³¼ì œ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.taskCount}ê±´</span></div>
                        </div>
                        <Btn onClick={handleCleanup} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md flex items-center justify-center gap-2"><Icon d={PATHS.trash} /> ì •ë¦¬ ì‹œìž‘í•˜ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ResetOptionsModal = ({ isOpen, onClose, onReset }) => {
            const [selected, setSelected] = useState({
                students: true, records: true, groups: true, tasks: true, seats: true, roles: true
            });
            
            const options = [
                { id: 'students', label: 'í•™ìƒ ëª…ë‹¨', desc: 'ì´ë¦„, ì„±ë³„, ì‹¤ë ¥ ë“±' },
                { id: 'records', label: 'í™œë™ ê¸°ë¡', desc: 'ì²´í¬ë¦¬ìŠ¤íŠ¸, ìƒë‹´, ìŠ¤í‹°ì»¤' },
                { id: 'groups', label: 'ëª¨ë‘  ê¸°ë¡', desc: 'íŽ¸ì„± ì´ë ¥, ê¸°í”¼ ê´€ê³„' },
                { id: 'tasks', label: 'ê³¼ì œ ì„¤ì •', desc: 'ì˜¤ëŠ˜/ìš”ì¼ë³„ ê³¼ì œ, íƒœê·¸' },
                { id: 'seats', label: 'ìžë¦¬ ë°°ì¹˜', desc: 'í˜„ìž¬ ë°°ì¹˜, ì±…ìƒ êµ¬ì¡°' },
                { id: 'roles', label: 'ì—­í•  ì„¤ì •', desc: 'ì—­í•  ëª©ë¡, ì„¤ëª…' },
            ];

            const toggleAll = () => {
                const allSelected = Object.values(selected).every(v => v);
                const newVal = !allSelected;
                const newSelected = {};
                options.forEach(o => newSelected[o.id] = newVal);
                setSelected(newSelected);
            };

            const handleReset = () => {
                const items = Object.keys(selected).filter(k => selected[k]);
                if (items.length === 0) return;
                onReset(items);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”" icon={PATHS.trash} maxWidth="max-w-md">
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">âš ï¸ ì£¼ì˜: ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">ì´ˆê¸°í™”í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={toggleAll} className="text-xs font-bold text-slate-500 hover:text-indigo-600 transition-colors">
                                {Object.values(selected).every(v => v) ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}
                            </button>
                        </div>

                        <div className="space-y-2">
                            {options.map(opt => (
                                <label key={opt.id} className={`flex items-center p-3 rounded-xl border cursor-pointer transition-all ${selected[opt.id] ? 'bg-rose-50 border-rose-200' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                    <input type="checkbox" checked={selected[opt.id]} onChange={() => setSelected(prev => ({ ...prev, [opt.id]: !prev[opt.id] }))} className="w-4 h-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500" />
                                    <div className="ml-3 flex-1">
                                        <div className={`text-sm font-bold ${selected[opt.id] ? 'text-rose-700' : 'text-slate-700'}`}>{opt.label}</div>
                                        <div className="text-xs text-slate-400">{opt.desc}</div>
                                    </div>
                                </label>
                            ))}
                        </div>

                        <div className="flex gap-2 mt-4">
                            <Btn onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                            <Btn onClick={handleReset} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md">
                                ì„ íƒ í•­ëª© ì‚­ì œ
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSafetyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="AI ë°ì´í„° ë³´ì•ˆ ëª¨ë“œëž€?" icon={PATHS.help}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>í•™ìƒë“¤ì˜ ì†Œì¤‘í•œ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´, AIì—ê²Œ ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ì „ <strong>ì´ë¦„ì„ ìžë™ìœ¼ë¡œ ê°€ëª… ì²˜ë¦¬(ë§ˆìŠ¤í‚¹)</strong>í•˜ëŠ” ê¸°ëŠ¥ìž…ë‹ˆë‹¤.</p>
                        
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 className="font-bold text-slate-700 mb-2">ðŸ‘€ ìž‘ë™ ì˜ˆì‹œ</h4>
                            <div className="space-y-3">
                                <div>
                                    <div className="text-xs font-bold text-rose-500 mb-1">ì›ë³¸ ë°ì´í„° (ì„ ìƒë‹˜ í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-rose-100 text-xs text-slate-500">
                                        "<strong>ê¹€ì² ìˆ˜</strong> í•™ìƒì€ <strong>ì´ì˜í¬</strong> í•™ìƒê³¼ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                                <div className="flex justify-center"><Icon d={PATHS.down} size={16} className="text-slate-300"/></div>
                                <div>
                                    <div className="text-xs font-bold text-indigo-600 mb-1">ì „ì†¡ ë°ì´í„° (AIê°€ ë³´ëŠ” í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-indigo-100 text-xs text-slate-500">
                                        "<strong>[STUDENT_TOKEN]</strong> í•™ìƒì€ <strong>ê¸‰ìš°</strong>ì™€ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-indigo-800 text-xs">
                            <p className="font-bold mb-1">âœ¨ ê¸°ëŠ¥ì´ ì¼œì ¸ ìžˆìœ¼ë©´?</p>
                            <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ <strong>ì „ì†¡ ì „ í™•ì¸ ì°½</strong>ì´ ëœ¹ë‹ˆë‹¤. ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³€í™˜ë˜ì—ˆëŠ”ì§€ ëˆˆìœ¼ë¡œ ì§ì ‘ í™•ì¸í•˜ê³  ì „ì†¡í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSecurityCheckModal = ({ isOpen, onClose, prompt, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ”’ AI ì „ì†¡ ë°ì´í„° ë³´ì•ˆ í™•ì¸" icon={PATHS.lock} zIndex="z-[3000]">
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800">
                            <p className="font-bold mb-1">ðŸ›¡ï¸ ê°œì¸ì •ë³´ ë³´í˜¸ í•„í„° ìž‘ë™ ì¤‘</p>
                            <p className="text-xs opacity-80">AIì—ê²Œ ì „ì†¡ë˜ê¸° ì§ì „ì˜ ë°ì´í„°ìž…ë‹ˆë‹¤.<br/>í•™ìƒ ì´ë¦„ì´ <strong>[STUDENT_TOKEN]</strong> ë˜ëŠ” <strong>ê¸‰ìš°</strong>ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-[40vh] overflow-y-auto custom-scroll">
                            <p className="text-xs text-slate-600 whitespace-pre-wrap font-mono leading-relaxed">{prompt}</p>
                        </div>
                        <div className="flex justify-end gap-2">
                            <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì „ì†¡ ì·¨ì†Œ</Btn>
                            <Btn onClick={onConfirm} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center gap-2">
                                <Icon d={PATHS.send} size={16} /> ì „ì†¡í•˜ê¸°
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, students, setStudents, appConfig, setAppConfig, isLocalMode, saveData, showToast, openConfirm, handleResetAllData, onOpenSetup, onOpenNotionSetup, onOpenGoogleSheetSetup, onOpenApiKeySetup, records, groupsByDate, avoidancePairs, dailyTasks, weeklyTasks, tags, setRecords, setGroupsByDate, setAvoidancePairs, setDailyTasks, setWeeklyTasks, setTags, backupTimes, setBackupTimes, apiKey, setApiKey, mustPairs, setMustPairs, groupNames, setGroupNames, groupRoles, setGroupRoles, rolesList, setRolesList, roleDescriptions, setRoleDescriptions, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, db, appId, deferredPrompt, isIOS, isStandalone, onInstallApp, isDevMode, onDevModeClick, deleteTasksFromFirestore, onTestUpdate }) => {
            const [name, setName] = useState("");
            const [gender, setGender] = useState("M"); const [skill, setSkill] = useState(2); const [note, setNote] = useState(""); const [isLeader, setIsLeader] = useState(false);
            const fileRef = useRef(null); const jsonFileRef = useRef(null); const runnerImgRef = useRef(null); const cloudIconRef = useRef(null); const faviconRef = useRef(null);
            const [deleteTargetId, setDeleteTargetId] = useState(null); const [isDeletingAll, setIsDeletingAll] = useState(false); const [editingId, setEditingId] = useState(null); const [editData, setEditData] = useState({});
            const [isDeleteLocked, setIsDeleteLocked] = useState(true);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(() => localStorage.getItem('cls_auto_backup') === 'true'); const [showBackupHelp, setShowBackupHelp] = useState(false); const [isAdminMode, setIsAdminMode] = useState(false);
            const [adminClickCount, setAdminClickCount] = useState(0); const [ampm, setAmpm] = useState("PM"); const [hour, setHour] = useState("12"); const [minute, setMinute] = useState("00");
            const [newVacStart, setNewVacStart] = useState(""); const [newVacEnd, setNewVacEnd] = useState("");
            const [showFontList, setShowFontList] = useState(false);
            
            // ì½”ë“œ ì—…ë°ì´íŠ¸ ê´€ë ¨ ìƒíƒœ
            const [showCodeUpdater, setShowCodeUpdater] = useState(false);
            const [updateCodeInput, setUpdateCodeInput] = useState("");
            const [isUpdating, setIsUpdating] = useState(false);
            const [updateProgress, setUpdateProgress] = useState(0);
            const [updateStatus, setUpdateStatus] = useState("");
            const [remainingTime, setRemainingTime] = useState(3);
            const [aiUsage, setAiUsage] = useState(0);
            const [showManualModal, setShowManualModal] = useState(false);
            const [showStorageHelp, setShowStorageHelp] = useState(false);
            const [showCleanupModal, setShowCleanupModal] = useState(false);
            const [isDataManagementOpen, setIsDataManagementOpen] = useState(true);
            const [showFaviconHelp, setShowFaviconHelp] = useState(false);
            const [showResetOptions, setShowResetOptions] = useState(false);
            const [isStudentListOpen, setIsStudentListOpen] = useState(true);
            const [activeTab, setActiveTab] = useState('app');
            const prevTabRef = useRef(activeTab);
            const isGoogleSheetConnected = !!localStorage.getItem('cls_google_sheet_url');
            const [aiSafetyCheck, setAiSafetyCheck] = useState(() => localStorage.getItem('cls_ai_safety_check') === 'true');
            const [showAiSafetyHelp, setShowAiSafetyHelp] = useState(false);
            const [testAllSuccess, setTestAllSuccess] = useState(false);
            const [isTestingAll, setIsTestingAll] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState({
                ai: { status: 'idle', message: '' },
                notion_record: { status: 'idle', message: '' },
                notion_portfolio: { status: 'idle', message: '' },
                google: { status: 'idle', message: '' }
            });
            const [isSyncPanelOpen, setIsSyncPanelOpen] = useState(true);

            const handleTestAllConnections = async () => {
                const notionKey = localStorage.getItem('cls_notion_key');
                const notionDbId = localStorage.getItem('cls_notion_db_id');
                const notionPortId = localStorage.getItem('cls_notion_portfolio_db_id');
                const googleSheetUrl = localStorage.getItem('cls_google_sheet_url');
                const aiKey = localStorage.getItem('cls_ai_key');
                
                setIsTestingAll(true);
                setIsSyncPanelOpen(true);

                // ì´ˆê¸° ìƒíƒœ ì„¤ì •: ì„¤ì •ê°’ ìœ ë¬´ì— ë”°ë¼ pending ë˜ëŠ” error(ë¯¸ì„¤ì •) ì²˜ë¦¬
                setConnectionStatus({
                    ai: aiKey ? { status: 'pending', message: 'í…ŒìŠ¤íŠ¸ ì¤‘...' } : { status: 'error', message: 'ë¯¸ì„¤ì •' },
                    notion_record: (notionKey && notionDbId) ? { status: 'pending', message: 'í…ŒìŠ¤íŠ¸ ì¤‘...' } : { status: 'error', message: 'ë¯¸ì„¤ì •' },
                    notion_portfolio: (notionKey && notionPortId) ? { status: 'pending', message: 'í…ŒìŠ¤íŠ¸ ì¤‘...' } : { status: 'error', message: 'ë¯¸ì„¤ì •' },
                    google: googleSheetUrl ? { status: 'pending', message: 'í…ŒìŠ¤íŠ¸ ì¤‘...' } : { status: 'error', message: 'ë¯¸ì„¤ì •' }
                });

                const tests = [];
                if (aiKey) tests.push({ type: 'ai', name: 'AI (Gemini)', key: aiKey, id: 'ai' });
                if (notionKey && notionDbId) tests.push({ type: 'notion', name: 'ë…¸ì…˜(ê¸°ë¡)', id: 'notion_record', key: notionKey, dbId: notionDbId, mode: 'normal' });
                if (notionKey && notionPortId) tests.push({ type: 'notion', name: 'ë…¸ì…˜(í¬í´)', id: 'notion_portfolio', key: notionKey, dbId: notionPortId, mode: 'relation' });
                if (googleSheetUrl) tests.push({ type: 'google', name: 'êµ¬ê¸€ì‹œíŠ¸', id: 'google', url: googleSheetUrl });

                if (tests.length === 0) {
                    setIsTestingAll(false);
                    return showToast("ì €ìž¥ëœ ì—°ë™ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
                }

                let hasSuccess = false;
                let hasFailure = false;

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    let success = false;
                    let errorMsg = '';

                    try {
                        if (test.type === 'ai') {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${test.key}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                            });
                            if (response.ok) success = true;
                            else {
                                const data = await response.json();
                                errorMsg = data.error?.message || "API í˜¸ì¶œ ì‹¤íŒ¨";
                            }
                        } else if (test.type === 'notion') {
                            const cleanKey = test.key.replace(/["']/g, '').trim();
                            const cleanDbId = test.dbId.replace(/["']/g, '').trim();
                            const res = await fetch('/api/save-notion', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ personalKey: cleanKey, personalDbId: cleanDbId, testMode: true, mode: test.mode })
                            });
                            const data = await res.json();
                            if (res.ok) success = true;
                            else errorMsg = data.error || "ì—°ë™ ì‹¤íŒ¨";
                        } else if (test.type === 'google') {
                            const cleanUrl = test.url.trim().replace(/^"|'|"$|'$/g, '');
                            await fetch(cleanUrl, {
                                method: "POST",
                                mode: 'no-cors',
                                headers: { "Content-Type": "text/plain;charset=utf-8" },
                                body: JSON.stringify({ date: dayjs().format('YYYY-MM-DD HH:mm:ss'), name: "í…ŒìŠ¤íŠ¸", category: "ì—°ë™ í…ŒìŠ¤íŠ¸", content: "ì „ì²´ ì—°ë™ í…ŒìŠ¤íŠ¸" })
                            });
                            success = true;
                        }
                    } catch (e) {
                        success = false;
                        errorMsg = e.message;
                    }

                    setConnectionStatus(prev => ({
                        ...prev,
                        [test.id]: { status: success ? 'success' : 'error', message: success ? 'ì—°ë™ ì„±ê³µ' : errorMsg }
                    }));
                    if (success) hasSuccess = true;
                    else hasFailure = true;
                }

                setIsTestingAll(false);
                if (!hasFailure) {
                    setTimeout(() => setIsSyncPanelOpen(false), 2000);
                }

                if (hasSuccess) {
                    setTestAllSuccess(true);
                    setTimeout(() => setTestAllSuccess(false), 3000);
                }
            };

            const toggleAiSafetyCheck = () => {
                const newVal = !aiSafetyCheck;
                setAiSafetyCheck(newVal);
                localStorage.setItem('cls_ai_safety_check', newVal);
                showToast(newVal ? "AI ì „ì†¡ ì‹œ ë³´ì•ˆ í™•ì¸ ì°½ì´ í‘œì‹œë©ë‹ˆë‹¤." : "AI ì „ì†¡ ë³´ì•ˆ í™•ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getTabAnimationClass = () => {
                if (appConfig.tabAnimationEnabled === false) return '';
                const tabs = ['student', 'app', 'data'];
                const prevIdx = tabs.indexOf(prevTabRef.current);
                const currIdx = tabs.indexOf(activeTab);
                if (prevIdx === -1 || currIdx === -1 || prevIdx === currIdx) return 'animate-fade-in';
                return currIdx > prevIdx ? 'animate-slide-in-right' : 'animate-slide-in-left';
            };
            useEffect(() => { prevTabRef.current = activeTab; }, [activeTab]);
            
            const isNotionConnected = !!(localStorage.getItem('cls_notion_key') && localStorage.getItem('cls_notion_db_id'));
            const isAiConnected = !!apiKey;

            const dataUsage = useMemo(() => {
                const rawDetails = [
                    { label: 'í•™ìƒ ëª…ë‹¨', val: students, color: '#6366f1' }, // Indigo
                    { label: 'í™œë™ ê¸°ë¡', val: records, color: '#ec4899' }, // Pink
                    { label: 'ëª¨ë‘  ê¸°ë¡', val: groupsByDate, color: '#8b5cf6' }, // Violet
                    { label: 'ê³¼ì œ ëª©ë¡', val: dailyTasks, color: '#3b82f6' }, // Blue
                    { label: 'ëª¨ë‘  ì´ë¦„', val: groupNames, color: '#10b981' }, // Emerald
                    { label: 'ëª¨ë‘  ì—­í• ', val: groupRoles, color: '#f59e0b' }, // Amber
                    { label: 'ìžë¦¬ ë°°ì¹˜', val: seatAssignments, color: '#f97316' }, // Orange
                    { label: 'ê´€ê³„ ì„¤ì •', val: { avoidancePairs, mustPairs }, color: '#ef4444' }, // Red
                    { label: 'ì£¼ê°„/íƒœê·¸', val: { weeklyTasks, tags }, color: '#14b8a6' }, // Teal
                    { label: 'ì•± ì„¤ì •', val: appConfig, color: '#64748b' }, // Slate
                    { label: 'ê¸°íƒ€', val: { rolesList, roleDescriptions, seatConfig }, color: '#94a3b8' } // Slate-400
                ];

                const totalBytes = new Blob([JSON.stringify({
                    students, records, groupsByDate, avoidancePairs, mustPairs, 
                    dailyTasks, weeklyTasks, tags, appConfig, groupNames, 
                    groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig
                })]).size;

                // [Mod] ë¡œì»¬ ëª¨ë“œ: 5MB, í´ë¼ìš°ë“œ ëª¨ë“œ: 1MB ê¸°ì¤€
                const MAX_SIZE = isLocalMode ? 5242880 : 1048576; 
                const kb = (totalBytes / 1024).toFixed(1);
                const percent = ((totalBytes / MAX_SIZE) * 100).toFixed(1);
                
                // ìƒì„¸ ë¶„ì„ ì¶”ê°€
                const details = rawDetails.map(item => {
                    const itemBytes = new Blob([JSON.stringify(item.val)]).size;
                    return {
                        ...item,
                        bytes: itemBytes,
                        kb: (itemBytes / 1024).toFixed(1),
                        percent: totalBytes > 0 ? ((itemBytes / totalBytes) * 100) : 0
                    };
                }).sort((a, b) => b.bytes - a.bytes);

                return { kb, percent, bytes: totalBytes, isWarning: percent > 80, isCritical: percent > 95, details };
            }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig, isLocalMode]);

            const updateAppConfig = (updates) => {
                const newConfig = { ...appConfig, ...updates };
                setAppConfig(newConfig);
                saveData('cls_app_config', newConfig);
            };

            useEffect(() => { 
                if (isOpen) { 
                    setAiUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setNewVacStart("");
                    setNewVacEnd("");
                } 
            }, [isOpen]);

            const currentVacations = useMemo(() => {
                if (appConfig.vacations && appConfig.vacations.length > 0) return appConfig.vacations;
                if (appConfig.vacationStart && appConfig.vacationEnd) return [{ start: appConfig.vacationStart, end: appConfig.vacationEnd }];
                return [];
            }, [appConfig.vacations, appConfig.vacationStart, appConfig.vacationEnd]);

            const addVacation = () => {
                if (newVacStart && newVacEnd) {
                    if (newVacStart > newVacEnd) return showToast("ì¢…ë£Œì¼ì´ ì‹œìž‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    const newVacations = [...currentVacations, { start: newVacStart, end: newVacEnd }].sort((a, b) => a.start.localeCompare(b.start));
                    updateAppConfig({ vacations: newVacations });
                    setNewVacStart(""); setNewVacEnd("");
                } else { showToast("ì‹œìž‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); }
            };
            const removeVacation = (index) => { 
                const newVacations = currentVacations.filter((_, i) => i !== index);
                updateAppConfig({ vacations: newVacations });
            };

            const toggleAutoBackup = () => { const newValue = !autoBackupEnabled; setAutoBackupEnabled(newValue); localStorage.setItem('cls_auto_backup', newValue);
            showToast(newValue ? "ìžë™ ë°±ì—…ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ìžë™ ë°±ì—…ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤."); };
            
            const addBackupTime = () => { let h = parseInt(hour);
            if (ampm === "PM" && h !== 12) h += 12;
            if (ampm === "AM" && h === 12) h = 0; const timeStr = `${String(h).padStart(2, '0')}:${minute}`;
            if (!backupTimes.includes(timeStr) && backupTimes.length < 4) { const newTimes = [...backupTimes, timeStr].sort(); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes));
            } else if (backupTimes.includes(timeStr)) { showToast("ì´ë¯¸ ì„¤ì •ëœ ì‹œê°„ìž…ë‹ˆë‹¤."); } else if (backupTimes.length >= 4) { showToast("ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            } };
            const removeBackupTime = (time) => { const newTimes = backupTimes.filter(t => t !== time); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes)); };
            
            // ê´€ë¦¬ìž ëª¨ë“œ í† ê¸€
            const handleDataManagementClick = () => { 
                const newCount = adminClickCount + 1; 
                if(newCount >= 3) { 
                    setIsAdminMode(!isAdminMode);
                    showToast(!isAdminMode ? "ê´€ë¦¬ìž ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê´€ë¦¬ìž ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    setAdminClickCount(0);
                } else {
                    setAdminClickCount(newCount);
                }
            };

            const addTestData = () => { 
                const testData = [
                    { name: "ìœ ìž¬ì„", gender: "M" }, { name: "ì•„ì´ìœ ", gender: "F" }, { name: "ë°•ë³´ê²€", gender: "M" }, 
                    { name: "ê¹€ì—°ì•„", gender: "F" }, { name: "ì†í¥ë¯¼", gender: "M" }, { name: "ë´‰ì¤€í˜¸", gender: "M" }, 
                    { name: "ê¹€íƒœë¦¬", gender: "F" }, { name: "ê³µìœ ", gender: "M" }, { name: "ì†¡í˜œêµ", gender: "F" }, 
                    { name: "í˜„ë¹ˆ", gender: "M" }, { name: "ì†ì˜ˆì§„", gender: "F" }, { name: "ì´ì •ìž¬", gender: "M" }, 
                    { name: "ì „ì§€í˜„", gender: "F" }, { name: "ë§ˆë™ì„", gender: "M" }, { name: "ê¹€í˜œìˆ˜", gender: "F" }
                ];
                const newStudents = testData.map((d, i) => ({ id: Date.now() + i, name: d.name, order: students.length + i + 1, gender: d.gender, skill: (i % 3) + 1, note: "í…ŒìŠ¤íŠ¸ í•™ìƒ", leader: i % 5 === 0 }));
                const updatedStudents = [...students, ...newStudents]; 
                setStudents(updatedStudents); 
                if(!isLocalMode) saveData('cls_students', updatedStudents); 
                showToast("í…ŒìŠ¤íŠ¸ í•™ìƒ 15ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100); 
            };
            const addStudent = () => { if (name) { const updated = [...students, { id: Date.now(), name, order: students.length + 1, gender, skill, note, leader: isLeader }];
            setStudents(updated); if(!isLocalMode) saveData('cls_students', updated); setName(""); setNote(""); setIsLeader(false); setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100);
            } };
            const deleteStudent = (id) => { const n = students.filter(s => s.id !== id); setStudents(n); if(!isLocalMode) saveData('cls_students', n);
            };
            const startEdit = (student) => { setEditingId(student.id); setEditData({...student}); };
            const cancelEdit = () => { setEditingId(null); setEditData({}); };
            const saveEdit = () => { const updatedStudents = students.map(s => s.id === editingId ? editData : s); setStudents(updatedStudents);
            if(!isLocalMode) saveData('cls_students', updatedStudents); setEditingId(null); setEditData({}); showToast("í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); };
            const handleFileUpload = (e) => { const f = e.target.files[0];
            if (!f) return; const r = new FileReader(); r.onload = (ev) => { const lines = ev.target.result.split(/[\r\n]+/).filter(l => l.trim());
            const newStds = []; lines.forEach((l, i) => { const p = l.split(','); if (p[0]) newStds.push({ id: Date.now() + i, name: p[0].trim(), gender: (p[1] || 'M').trim(), skill: parseInt(p[2] || 2), note: (p[3] || "").trim(), order: students.length + i + 1, leader: false }); });
            if (newStds.length) { const u = [...students, ...newStds]; setStudents(u); if(!isLocalMode) saveData('cls_students', u); showToast(`${newStds.length}ëª… ì¶”ê°€ë¨`); } }; r.readAsText(f); };
            const handleDeleteAll = () => { setStudents([]); if(!isLocalMode) saveData('cls_students', []); setIsDeletingAll(false); setIsDeleteLocked(true); showToast("ì „ì²´ ì‚­ì œë¨"); };
            const getCleanHtmlCode = () => { const docClone = document.documentElement.cloneNode(true); const root = docClone.querySelector('#root'); if (root) root.innerHTML = '';
            const scripts = docClone.querySelectorAll('script'); scripts.forEach(s => { if (!s.hasAttribute('data-app-script')) s.remove(); }); const styles = docClone.querySelectorAll('style');
            styles.forEach(s => { if (!s.hasAttribute('data-app-style')) s.remove(); }); return "<!DOCTYPE html>\n" + docClone.outerHTML; };
            const handleDownloadHtml = () => { const html = getCleanHtmlCode(); const blob = new Blob([html], {type: "text/html"});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Checklist_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.html`; link.click(); };
            const handleCopyCode = () => { const htmlContent = getCleanHtmlCode(); const textarea = document.createElement("textarea"); textarea.value = htmlContent; document.body.appendChild(textarea); textarea.select();
            try { const successful = document.execCommand('copy'); if (successful) showToast("ì „ì²´ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); else showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } catch (err) { showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } finally { document.body.removeChild(textarea); } };
            
            const handleExportJson = async () => { 
                let exportStudents = [...students];
                let exportRecords = { ...records };
                let exportGroups = { ...groupsByDate };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì¼ ê²½ìš° ë¶„ì‚° ì €ìž¥ëœ ëª¨ë“  ë°ì´í„°(í•™ìƒìƒì„¸, ê¸°ë¡, ëª¨ë‘ )ë¥¼ ê°€ì ¸ì™€ì„œ ë³‘í•©
                if (!isLocalMode && db && appId) {
                    showToast("í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
                    try {
                        // 1. í•™ìƒ ê°œë³„ ë°ì´í„° (ìƒë‹´, ì´ˆì•ˆ)
                        const studentSnapshot = await db.collection('classes').doc(appId).collection('studentData').get();
                        const studentDataMap = {};
                        studentSnapshot.forEach(doc => { studentDataMap[doc.id] = doc.data(); });
                        
                        exportStudents = exportStudents.map(s => {
                            const extra = studentDataMap[String(s.id)];
                            return extra ? { ...s, ...extra } : s;
                        });

                        // 2. í™œë™ ê¸°ë¡ (Records)
                        const recordSnapshot = await db.collection('classes').doc(appId).collection('records').get();
                        recordSnapshot.forEach(doc => { 
                            exportRecords[doc.id] = doc.data(); 
                        });

                        // 3. ëª¨ë‘  ê¸°ë¡ (GroupResults)
                        const groupSnapshot = await db.collection('classes').doc(appId).collection('groupResults').get();
                        groupSnapshot.forEach(doc => { 
                            const data = doc.data();
                            exportGroups[doc.id] = data.list || data; 
                        });
                        
                        // 4. ê³¼ì œ ë°ì´í„° (Tasks)
                        const taskSnapshot = await db.collection('classes').doc(appId).collection('tasks').get();
                        taskSnapshot.forEach(doc => {
                            if (doc.id === 'settings') {
                                // settingsëŠ” ë³„ë„ ì²˜ë¦¬ ì•ˆí•¨ (stateì— ì´ë¯¸ ìžˆìŒ)
                            } else {
                                // exportDailyTasks[doc.id] = doc.data().list; // dailyTasks stateì— ì´ë¯¸ ë³‘í•©ë˜ì–´ ìžˆìŒ
                            }
                        });

                    } catch (e) {
                        console.error("Export fetch error:", e);
                        showToast("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ë°ì´í„°ê°€ ëˆ„ë½ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.");
                    }
                }

                const data = { 
                    version: appConfig.version, 
                    date: dayjs().format('YYYY-MM-DD HH:mm:ss'), 
                    students: exportStudents, 
                    records: exportRecords, 
                    groupsByDate: exportGroups, 
                    avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig 
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url;
                link.download = `Checklist_Data_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.json`; link.click(); showToast("ë°ì´í„°ê°€ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤."); 
            };
            
            const handleImportJson = (e) => { const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if(data.students) { setStudents(data.students);
            if(!isLocalMode) saveData('cls_students', data.students); } if(data.records) { setRecords(data.records); if(!isLocalMode) saveData('cls_records', data.records); } if(data.groupsByDate) { setGroupsByDate(data.groupsByDate); if(!isLocalMode) saveData('cls_groups_date', data.groupsByDate);
            } if(data.avoidancePairs) { setAvoidancePairs(data.avoidancePairs); if(!isLocalMode) saveData('cls_avoidance', data.avoidancePairs); } if(data.dailyTasks) { setDailyTasks(data.dailyTasks); if(!isLocalMode) saveData('cls_daily_tasks', data.dailyTasks); } if(data.weeklyTasks) { setWeeklyTasks(data.weeklyTasks);
            if(!isLocalMode) saveData('cls_weekly_tasks', data.weeklyTasks); } if(data.tags) { setTags(data.tags); if(!isLocalMode) saveData('cls_tags', data.tags); } 
            if(data.mustPairs) { setMustPairs(data.mustPairs); if(!isLocalMode) saveData('cls_mustPairs', data.mustPairs); }
            if(data.groupNames) { setGroupNames(data.groupNames); if(!isLocalMode) saveData('cls_group_names', data.groupNames); }
            if(data.groupRoles) { setGroupRoles(data.groupRoles); if(!isLocalMode) saveData('cls_group_roles', data.groupRoles); }
            if(data.rolesList) { setRolesList(data.rolesList); if(!isLocalMode) saveData('cls_roles_list', data.rolesList); }
            if(data.roleDescriptions) { setRoleDescriptions(data.roleDescriptions); if(!isLocalMode) saveData('cls_role_descriptions', data.roleDescriptions); }
            if(data.seatAssignments) { setSeatAssignments(data.seatAssignments); if(!isLocalMode) saveData('cls_seat_assignments', data.seatAssignments); }
            if(data.seatConfig) { setSeatConfig(data.seatConfig); if(!isLocalMode) saveData('cls_seat_config', data.seatConfig); }
            if(data.appConfig) { setAppConfig(data.appConfig); setCfg(data.appConfig); if(!isLocalMode) saveData('cls_app_config', data.appConfig);
            } showToast("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); } catch(err) { 
                logSystemEvent(`JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
                showToast("JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); } }; reader.readAsText(file); };
            
            const handleApplyCode = () => {
                let code = updateCodeInput.trim();
                if (!code) return showToast("ì½”ë“œë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setIsUpdating(true);
                setUpdateProgress(0);
                setUpdateStatus("ì½”ë“œ ë¶„ì„ ì¤‘...");
                setRemainingTime(3.0);

                const loaderHtml = `
                    <div id="temp-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#F5F5F7;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:sans-serif;">
                        <div style="font-size:40px;margin-bottom:20px;">ðŸš€</div>
                        <h2 style="color:#1e293b;margin-bottom:10px;">ì•±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ìž…ë‹ˆë‹¤...</h2>
                        <p style="color:#64748b;font-size:14px;">í™”ë©´ì´ ìž ì‹œ í•˜ì–—ê²Œ ë³´ì—¬ë„ ì •ìƒìž…ë‹ˆë‹¤.</p>
                        <div style="width:200px;height:4px;background:#cbd5e1;border-radius:4px;margin-top:20px;overflow:hidden;">
                            <div style="width:100%;height:100%;background:#3b82f6;animation:loaderAnim 1.5s infinite ease-in-out;"></div>
                        </div>
                        <style>@keyframes loaderAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }</style>
                    </div>
                `;
                
                if (code.includes("<body")) {
                    code = code.replace(/<body[^>]*>/, (match) => match + loaderHtml);
                } else {
                    code = loaderHtml + code;
                }

                let progress = 0;
                const totalSteps = 30; 
                
                const timer = setInterval(() => {
                    progress += 100 / totalSteps;
                    const currentProgress = Math.min(Math.round(progress), 100);
                    const timeLeft = Math.max(0, (3 - (progress / 100 * 3))).toFixed(1);

                    setUpdateProgress(currentProgress);
                    setRemainingTime(timeLeft);

                    if (currentProgress < 30) setUpdateStatus("ì½”ë“œ ë¬´ê²°ì„± ê²€ì‚¬ ì¤‘...");
                    else if (currentProgress < 60) setUpdateStatus("ë°ì´í„° ë°±ì—… í™•ì¸ ì¤‘...");
                    else if (currentProgress < 90) setUpdateStatus("ìƒˆë¡œìš´ í™˜ê²½ êµ¬ì„± ì¤‘...");
                    else setUpdateStatus("ì—…ë°ì´íŠ¸ ì ìš© ì¤€ë¹„ ì™„ë£Œ!");

                    if (progress >= 100) {
                        clearInterval(timer);
                        setTimeout(() => {
                            setUpdateStatus("í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤...");
                            try {
                                document.open();
                                document.write(code); 
                                document.close();
                            } catch (e) {
                                logSystemEvent(`ì½”ë“œ ì—…ë°ì´íŠ¸ ì ìš© ì‹¤íŒ¨: ${e.message}`, 'error');
                                setIsUpdating(false);
                                showToast("ì½”ë“œ ì ìš© ì‹¤íŒ¨: " + e.message);
                            }
                        }, 500);
                    }
                }, 100);
            };

            const handleSaveCodeFile = () => {
                logSystemEvent('ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ ì €ìž¥ ì‹œë„');
                if (!updateCodeInput.trim()) return showToast("ì½”ë“œë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                const blob = new Blob(["\ufeff" + updateCodeInput], {type: "text/html;charset=utf-8"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Checklist_Updated_${dayjs().format('YYYYMMDD')}.html`;
                link.click();
                showToast("ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getManualContent = () => `
================================================================
  ðŸ“˜ ë‹¤í–ˆë‚˜ìš”? ì‚¬ìš© ì„¤ëª…ì„œ (v${appConfig.version})
================================================================

ì•ˆë…•í•˜ì„¸ìš”, ì„ ìƒë‹˜! 
'ë‹¤í–ˆë‚˜ìš”?'ëŠ” í•™ê¸‰ ìš´ì˜ì„ ë” ì‰½ê³  ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë„ì™€ë“œë¦¬ëŠ” ë„êµ¬ìž…ë‹ˆë‹¤.
ì£¼ìš” ê¸°ëŠ¥ê³¼ ì‚¬ìš© íŒì„ ì•„ëž˜ì— ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.

----------------------------------------------------------------
1. ðŸ§‘â€ðŸŽ“ í•™ìƒ ê´€ë¦¬ (ê¸°ì´ˆ ê³µì‚¬)
----------------------------------------------------------------
- [ë“±ë¡]: ì„¤ì •(âš™ï¸) > í•™ìƒ ê´€ë¦¬ì—ì„œ ì´ë¦„ì„ ìž…ë ¥í•˜ê³  'ì¶”ê°€'ë¥¼ ëˆ„ë¥´ì„¸ìš”.
- [ì¼ê´„ ë“±ë¡]: ì—‘ì…€(CSV)ì´ë‚˜ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ëª…ë‹¨ì„ í•œ ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- [ì‚¬ì§„ ê´€ë¦¬]: 'ì‚¬ì§„ ì¼ê´„ ê´€ë¦¬' ë²„íŠ¼ìœ¼ë¡œ í•™ìƒë“¤ì˜ ì‚¬ì§„ì„ ì†ì‰½ê²Œ ë“±ë¡í•˜ì„¸ìš”.
- [ìˆ˜ì •/ì‚­ì œ]: í•™ìƒ ëª©ë¡ì—ì„œ ì—°í•„ ì•„ì´ì½˜(ìˆ˜ì •)ì´ë‚˜ íœ´ì§€í†µ ì•„ì´ì½˜(ì‚­ì œ)ì„ ëˆ„ë¥´ì„¸ìš”.
- [íŒ]: í•™ìƒì—ê²Œ 'ë¦¬ë”(ðŸ‘‘)' ì†ì„±ì„ ì£¼ë©´ ëª¨ë‘  íŽ¸ì„± ì‹œ ê° ì¡°ì— ê³¨ê³ ë£¨ ë°°ì¹˜ë©ë‹ˆë‹¤.

----------------------------------------------------------------
2. ðŸ“ ê¸°ë¡ ëª¨ë“œ (ë§¤ì¼ ì“°ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸)
----------------------------------------------------------------
- [ì²´í¬]: í•™ìƒ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ê³¼ì œ ì œì¶œ/ì™„ë£Œ ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤.
- [ì„¸ë¶€ ê³¼ì œ]: 'ê³¼ì œ ì„¤ì •(+)' ë²„íŠ¼ì„ ëˆŒëŸ¬ 'ì¼ê¸°', 'ë…ì„œë¡' ë“± ì—¬ëŸ¬ ê³¼ì œë¥¼ ë“±ë¡í•˜ì„¸ìš”.
- [ë¹ ë¥¸ ê¸°ë¡]: í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼(âœï¸)ì„ ëˆŒëŸ¬ ì–¸ì œ ì–´ë””ì„œë“  ê´€ì°° ê¸°ë¡ì„ ë‚¨ê¸°ì„¸ìš”.
- [í•™ê¸‰ ìŠ¤í† ë¦¬]: í•˜ë£¨ ê¸°ë¡ì´ ëë‚˜ë©´ 'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. 
  AIê°€ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ íŒíƒ€ì§€, ë™í™”, SF ë“± ë‹¤ì–‘í•œ ìž¥ë¥´ì˜ ì´ì•¼ê¸°ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

----------------------------------------------------------------
3. ðŸ§© ëª¨ë‘  & ìžë¦¬ ë°°ì¹˜ (AI ë¹„ì„œ)
----------------------------------------------------------------
- [AI íŽ¸ì„±]: ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”, ê¸°í”¼ ê´€ê³„ ë“±ì„ ê³ ë ¤í•´ AIê°€ ìµœì ì˜ ëª¨ë‘ ì„ ì§œì¤ë‹ˆë‹¤.
- [ìˆ˜ë™ ì¡°ì •]: ë§ˆìš°ìŠ¤ë¡œ í•™ìƒì„ ë“œëž˜ê·¸í•˜ì—¬ ë‹¤ë¥¸ ëª¨ë‘ ìœ¼ë¡œ ì‰½ê²Œ ì˜®ê¸¸ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- [ìžë¦¬ ë°°ì¹˜]: íŽ¸ì„±ëœ ëª¨ë‘ ì„ ë°”íƒ•ìœ¼ë¡œ êµì‹¤ ìžë¦¬ ë°°ì¹˜ë„ê¹Œì§€ í•œ ë²ˆì— í•´ê²°í•˜ì„¸ìš”.
- [ì—­í•  ë¶„ë‹´]: 'ëª¨ë‘  ë„êµ¬'ì—ì„œ ë‚˜ëˆ”ì´, ì´ë„ë¯¸ ë“± ì—­í• ì„ ìžë™ìœ¼ë¡œ ë°°ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- [ìžì „ê³¼ ê³µì „]: ëª¨ë‘  êµ¬ì„±ì›ì€ ìœ ì§€í•œ ì±„ ìžë¦¬ë§Œ íšŒì „ì‹œí‚¤ëŠ” ê¸°ëŠ¥ë„ ì§€ì›í•©ë‹ˆë‹¤.

----------------------------------------------------------------
4. ðŸ“Š í†µê³„ & ìƒë‹´ (ë°ì´í„° ê¸°ë°˜ ì§€ë„)
----------------------------------------------------------------
- [ëª…ì˜ˆì˜ ì „ë‹¹]: ì„±ì‹¤í•˜ê²Œ ì°¸ì—¬í•œ í•™ìƒë“¤ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”.
- [í™œë™ ìž”ë””]: í•™ìƒë³„ 30ì¼ê°„ì˜ í™œë™ ê¸°ë¡ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.
- [AI ì£¼ê°„ ë¸Œë¦¬í•‘]: ì´ë²ˆ ì£¼ ìš°ë¦¬ ë°˜ ë¶„ìœ„ê¸°ê°€ ì–´ë• ëŠ”ì§€ AIê°€ ìš”ì•½í•´ì¤ë‹ˆë‹¤.
- [í•™ìƒ ì¸ì‚¬ì´íŠ¸]: í•™ìƒ ì´ë¦„ì„ ë”ë¸” í´ë¦­í•˜ë©´ ê°œë³„ ìƒë‹´ ê¸°ë¡, ì„±ìž¥ ë¦¬í¬íŠ¸, 
  í•™ê¸‰ í‰ê·  ë¹„êµ ê·¸ëž˜í”„ ë“±ì„ ë³¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- [AI ì€ìƒ˜ìƒë‹´ì†Œ]: í•™ìƒ ì§€ë„ ê³ ë¯¼ì´ ìžˆì„ ë•Œ AIì—ê²Œ ì¡°ì–¸ì„ êµ¬í•´ë³´ì„¸ìš”.
- [ì´í‰ ì´ˆì•ˆ]: 1ë…„ê°„ì˜ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ìƒí™œê¸°ë¡ë¶€(í–‰ë°œ, êµê³¼) ì´ˆì•ˆì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.

----------------------------------------------------------------
5. ðŸ”— ì™¸ë¶€ ì—°ë™ & ë°ì´í„° ê´€ë¦¬
----------------------------------------------------------------
- [ë…¸ì…˜ ì—°ë™]: ê¸°ë¡ì„ ê°œì¸ ë…¸ì…˜ íŽ˜ì´ì§€ì— ìžë™ìœ¼ë¡œ ì €ìž¥í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
  (ê¸°ë¡ ëª¨ë“œ / í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì§€ì›)
- [êµ¬ê¸€ ì‹œíŠ¸]: ê¸°ë¡ ë°ì´í„°ë¥¼ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ì‹¤ì‹œê°„ ì „ì†¡í•©ë‹ˆë‹¤.
- [ìžë™ ë°±ì—…]: ì„¤ì • > ë°ì´í„° ê´€ë¦¬ì—ì„œ ìžë™ ë°±ì—… ì‹œê°„ì„ ì„¤ì •í•˜ë©´ ì•ˆì‹¬ìž…ë‹ˆë‹¤.
- [ë°ì´í„° ì •ë¦¬]: ì˜¤ëž˜ëœ ê¸°ë¡ì„ ì •ë¦¬í•˜ì—¬ ì•± ì†ë„ë¥¼ ìµœì í™”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

----------------------------------------------------------------
6. ðŸ§° í•™ê¸‰ ë„êµ¬ ìƒìž
----------------------------------------------------------------
- [ë°œí‘œìž ë½‘ê¸°]: ë¬´ìž‘ìœ„ë¡œ ë°œí‘œìžë¥¼ ì„ ì •í•  ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.
- [íƒ€ì´ë¨¸]: ìˆ˜ì—… ì‹œê°„ ê´€ë¦¬ì— ìœ ìš©í•œ íƒ€ì´ë¨¸ ê¸°ëŠ¥ì´ ë‚´ìž¥ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.

----------------------------------------------------------------
ðŸ’¡ ë¬¸ì˜ ë° ì œì•ˆ: spk@smca.or.kr
================================================================
`.trim();

            const handleDownloadManualFile = () => {
                const content = getManualContent();
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Classroom_Checklist_Manual_v${appConfig.version}.txt`;
                link.click();
                showToast("ì‚¬ìš© ì„¤ëª…ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };


            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title={<><span onClick={onDevModeClick} className="cursor-default">âš™ï¸</span> <span onClick={handleDataManagementClick} className="cursor-default select-none">ì„¤ì •</span></>} icon={null} maxWidth="max-w-6xl">
                    <HelpModal isOpen={showBackupHelp} onClose={()=>setShowBackupHelp(false)} />
                    <ManualModal isOpen={showManualModal} onClose={() => setShowManualModal(false)} content={getManualContent()} onDownload={handleDownloadManualFile} />
                    
                    {isUpdating && (
                        <div className="fixed inset-0 z-[9999] bg-slate-900/90 flex flex-col items-center justify-center text-white backdrop-blur-sm animate-fade-in">
                            <div className="w-full max-w-md p-8 bg-slate-800 rounded-3xl shadow-2xl border border-slate-700 text-center">
                                <div className="mb-6 animate-bounce text-4xl">ðŸš€</div>
                                <h3 className="text-2xl font-bold mb-2">ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘</h3>
                                <p className="text-slate-400 text-sm mb-6">{updateStatus}</p>
                                <div className="relative h-4 bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div className="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 ease-out" style={{ width: `${updateProgress}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs font-mono text-slate-300 mb-4">
                                    <span>{updateProgress}%</span>
                                    <span>ë‚¨ì€ ì‹œê°„: {remainingTime}ì´ˆ</span>
                                </div>
                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-yellow-200 text-xs text-left">
                                    âš ï¸ <strong>ì£¼ì˜:</strong> ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ë©´ ìž ì‹œ <strong>í™”ë©´ì´ í•˜ì–—ê²Œ ë³€í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤</strong>. <br/>
                                    ì´ëŠ” ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì •ìƒì ì¸ ê³¼ì •ìž…ë‹ˆë‹¤. ë‹¹í™©í•˜ì§€ ë§ê³  3~5ì´ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
                                </div>
                            </div>
                        </div>
                    )}

                    {/* [Fix] í™”ë©´ ë°°ìœ¨ì— ë”°ë¼ ëª¨ë‹¬ ë†’ì´ ìžë™ ì¡°ì ˆ (í™”ë©´ ìž˜ë¦¼ ë°©ì§€) */}
                    <div className="flex flex-col md:flex-row gap-6" style={{ 
                        height: `${Math.min(65, 65 * (100 / (appConfig.uiScale || 100)))}vh` 
                    }}>
                        <div className="w-full md:w-40 flex-shrink-0 flex flex-row md:flex-col gap-1 md:gap-2 bg-slate-50 md:bg-transparent p-1 md:p-0 rounded-xl">
                            <button onClick={() => setActiveTab('student')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'student' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ðŸ‘¤ í•™ìƒ ê´€ë¦¬</button>
                            <button onClick={() => setActiveTab('app')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'app' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ðŸ“± ì•± ì„¤ì •</button>
                            <button onClick={() => setActiveTab('data')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'data' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ðŸ’¾ ë°ì´í„° ê´€ë¦¬</button>
                        </div>

                        <div className={`flex-1 overflow-y-auto custom-scroll pr-2 space-y-6 pb-10 ${getTabAnimationClass()}`} key={activeTab}>
                            {activeTab === 'student' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5 cursor-default select-none">
                                            <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ§‘â€ðŸŽ“</div> 
                                            í•™ìƒ ëª…ë‹¨ ê´€ë¦¬
                                        </h4>
                                        
                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6">
                                            <div className="flex justify-between items-center mb-4">
                                                <h5 className="text-sm font-bold text-slate-700">ìƒˆ í•™ìƒ ë“±ë¡</h5>
                                            <div className="flex items-center">
                                                <Btn onClick={() => fileRef.current.click()} className="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 flex items-center gap-1 font-bold" title="CSV/TXT ì—…ë¡œë“œ"> <Icon d={PATHS.upload} size={14} /> <span>CSV ì—…ë¡œë“œ</span> </Btn>
                                                <input type="file" ref={fileRef} onChange={handleFileUpload} className="hidden" accept=".csv,.txt" />
                                            </div>
                                        </div>
                                <div className="flex flex-wrap gap-2 items-center">
                                    <input value={name} onChange={e => setName(e.target.value)} className="h-10 p-2.5 border rounded-xl text-sm w-24 sm:w-32" placeholder="ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <select value={gender} onChange={e => setGender(e.target.value)} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select>
                                    <select value={skill} onChange={e => setSkill(parseInt(e.target.value))} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select>
                                    <input value={note} onChange={e => setNote(e.target.value)} className="h-10 flex-1 p-2.5 border rounded-xl text-sm min-w-[100px]" placeholder="ë¹„ê³ " onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <button onClick={() => setIsLeader(!isLeader)} className={`h-10 px-3 border rounded-xl text-lg ${isLeader ? 'bg-yellow-100 border-yellow-300 text-yellow-600' : 'bg-white border-slate-200 text-slate-300'}`} title="ë¦¬ë”(ì´ë„ë¯¸)">ðŸ‘‘</button>
                                    <Btn onClick={addStudent} className="h-10 bg-indigo-600 text-white px-4 rounded-xl font-bold hover:bg-indigo-700 text-sm whitespace-nowrap">ì¶”ê°€</Btn>
                                </div>
                                    </div>
                            
                                    <div className={`flex flex-col transition-all duration-300 ${isStudentListOpen ? 'h-[500px]' : 'h-auto'}`}>
                                        <div className="flex justify-between items-center mb-3 flex-shrink-0 cursor-pointer select-none" onClick={() => setIsStudentListOpen(!isStudentListOpen)}>
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2 text-sm">
                                                <span className="text-lg">ðŸ“‹</span> ë“±ë¡ëœ í•™ìƒ ({students.length}ëª…)
                                                <Icon d={isStudentListOpen ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                            </h4>
                                            <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                                                <Btn onClick={addTestData} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:bg-indigo-100 transition-colors whitespace-nowrap">í…ŒìŠ¤íŠ¸ ëª…ë‹¨</Btn>
                                                {isDeleteLocked ? (
                                                    <Btn onClick={() => setIsDeleteLocked(false)} className="text-xs bg-slate-100 text-slate-400 p-1.5 rounded-lg font-bold flex items-center justify-center hover:bg-slate-200 transition-colors" title="ìž ê¸ˆ í•´ì œ"><Icon d={PATHS.lock} size={14} /></Btn>
                                                ) : (
                                                    isDeletingAll ?
                                                    <div className="flex gap-2"><Btn onClick={handleDeleteAll} className="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg animate-pulse whitespace-nowrap">í™•ì¸</Btn><Btn onClick={() => { setIsDeletingAll(false); setIsDeleteLocked(true); }} className="text-xs bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg whitespace-nowrap">ì·¨ì†Œ</Btn></div> : 
                                                    <Btn onClick={() => setIsDeletingAll(true)} className="text-xs bg-rose-100 text-rose-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 whitespace-nowrap"><Icon d={PATHS.trash} size={12} /> ì „ì²´ ì‚­ì œ</Btn>
                                                )}
                                            </div>
                                        </div>
                            
                                        {isStudentListOpen && (
                                            <div id="student-list" className="flex-1 overflow-y-auto custom-scroll bg-slate-50 p-2 rounded-xl border border-slate-200 shadow-inner space-y-1 animate-fade-in">
                                            {students.map(s => (
                                    <div key={s.id} className="flex justify-between items-center p-2.5 bg-white rounded-lg border border-slate-100 text-sm group min-h-[46px]">
                                        {editingId === s.id ? (
                                            <div className="flex gap-1 flex-1 items-center animate-fade-in w-full">
                                                <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-1 flex items-center justify-center">
                                                    <span className="text-sm">{editData.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§'}</span>
                                                </div>
                                                <span className="text-indigo-500 font-bold w-6 text-center">{s.order}.</span> <input value={editData.name} onChange={e=>setEditData({...editData, name: e.target.value})} className="p-1 border rounded w-20 text-xs" /> <select value={editData.gender} onChange={e=>setEditData({...editData, gender: e.target.value})} className="p-1 border rounded w-12 text-xs"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select> <select value={editData.skill} onChange={e=>setEditData({...editData, skill: parseInt(e.target.value)})} className="p-1 border rounded w-12 text-xs"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select> <input value={editData.note} onChange={e=>setEditData({...editData, note: e.target.value})} className="flex-1 p-1 border rounded text-xs min-w-[50px]" placeholder="ë¹„ê³ " /> <button onClick={() => setEditData({...editData, leader: !editData.leader})} className={`p-1 border rounded text-xs ${editData.leader ? 'bg-yellow-100 border-yellow-300' : 'bg-slate-50'}`}>ðŸ‘‘</button> <Btn onClick={saveEdit} className="bg-indigo-500 text-white px-2 py-1 rounded text-xs font-bold">ì €ìž¥</Btn> <Btn onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-2 py-1 rounded text-xs">ì·¨ì†Œ</Btn> </div>
                                        ) : (
                                            <> 
                                                <div className="flex flex-col">
                                                    <span className="font-medium text-slate-700 flex items-center">
                                                        <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-2 flex items-center justify-center">
                                                            <span className="text-sm">{s.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§'}</span>
                                                        </div>
                                                        <span className="text-indigo-500 font-bold w-6 inline-block">{s.order}.</span> 
                                                        {s.name} 
                                                        <span className="text-xs text-slate-400 ml-1">({s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}/{['í•˜','ì¤‘','ìƒ'][s.skill-1]})</span>
                                                        {s.leader && <span className="ml-1 text-xs text-yellow-500" title="ë¦¬ë”">ðŸ‘‘</span>}
                                                    </span>
                                                    {s.note && <span className="text-xs text-slate-400 ml-7 truncate max-w-[200px]">{s.note}</span>}
                                                </div> 
                                                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"> <Btn onClick={() => startEdit(s)} className="text-slate-300 hover:text-indigo-500 p-1"><Icon d={PATHS.edit} size={16} /></Btn> {deleteTargetId === s.id ?
                                                (<div className="flex gap-1 animate-fade-in"><Btn onClick={(e) => { e.stopPropagation(); deleteStudent(s.id); setDeleteTargetId(null); }} className="bg-rose-500 text-white text-[10px] px-2 py-1 rounded font-bold">ì‚­ì œ</Btn><Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(null); }} className="bg-slate-200 text-slate-600 text-[10px] px-2 py-1 rounded font-bold">ì·¨ì†Œ</Btn></div>) : (<Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(s.id); }} className="text-slate-300 hover:text-rose-500 p-1"><Icon d={PATHS.trash} size={16} /></Btn>)} </div> 
                                            </>
                                        )}
                                    </div>
                                ))}
                                            </div>
                                        )}
                                    </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'app' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5 cursor-default select-none">
                                            <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ“±</div> 
                                            ì•± ê¸°ë³¸ ì„¤ì •
                                            <div className="flex flex-col gap-1 ml-auto">
                                                {isAdminMode && <span className="w-fit text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">ê´€ë¦¬ìž</span>}
                                                {isDevMode && <span className="w-fit text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-full">ê°œë°œìž</span>}
                                            </div>
                                        </h4>

                                {(!isStandalone && (deferredPrompt || isIOS)) && (
                                    <div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-5 rounded-2xl text-white shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4 animate-fade-in mb-6 relative overflow-hidden group cursor-pointer mx-1" onClick={onInstallApp}>
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-white/20 transition-all"></div>
                                        <div className="flex items-center gap-4 relative z-10">
                                            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                                <span className="text-2xl">ðŸ“²</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-lg">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê³  ë” íŽ¸í•˜ê²Œ!</span>
                                                <span className="text-xs text-indigo-100 font-medium">ì˜¤í”„ë¼ì¸ ì‚¬ìš© â€¢ ì „ì²´ í™”ë©´ â€¢ ë¹ ë¥¸ ì‹¤í–‰</span>
                                            </div>
                                        </div>
                                        <Btn className="bg-white text-indigo-600 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-indigo-50 shadow-md whitespace-nowrap relative z-10 transition-transform active:scale-95">
                                            {isIOS ? "ì„¤ì¹˜ ë°©ë²• ë³´ê¸°" : "í™ˆ í™”ë©´ì— ì¶”ê°€"}
                                        </Btn>
                                    </div>
                                )}

                                    <div className={`grid gap-4 ${isDevMode ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>
                                        {isDevMode && (
                                            <div className="space-y-4 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ðŸ› ï¸ ê°œë°œìž ì„¤ì •</h4>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-indigo-300 transition-colors">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-xs font-bold text-slate-600">ì•Œë¦¼ ë°©ì‹</span>
                                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'modal' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType !== 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>íŒì—…</button>
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'toast' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType === 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°°ë„ˆ</button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-100">
                                                            <Btn onClick={onTestUpdate} className="py-2 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ðŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</Btn>
                                                            <Btn onClick={() => { localStorage.setItem('cls_last_version', 'v0.0.0'); showToast("ë²„ì „ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."); }} className="py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold hover:bg-slate-200">ðŸ”„ ë²„ì „ ì´ˆê¸°í™”</Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ðŸŽ¨ ì•„ì´ì½˜ ì„¤ì •</h4>
                                                    <div className="grid grid-cols-3 gap-2 bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-indigo-300 transition-colors">
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative">
                                                        <button onClick={(e) => { e.stopPropagation(); setShowFaviconHelp(!showFaviconHelp); }} className="absolute top-1 right-1 text-slate-300 hover:text-indigo-500 transition-colors"><Icon d={PATHS.help} size={12} /></button>
                                                        {showFaviconHelp && (
                                                            <div className="absolute top-6 right-1 w-48 bg-slate-800/95 backdrop-blur text-white text-[10px] p-3 rounded-xl shadow-xl z-20 text-left leading-relaxed animate-fade-in border border-slate-700" onClick={() => setShowFaviconHelp(false)}>
                                                                <p className="font-bold mb-1 text-indigo-300">ðŸ’¡ ì•„ì´ì½˜ ì—…ë¡œë“œ ê°€ì´ë“œ</p>
                                                                <ul className="list-disc pl-3 space-y-1 opacity-90">
                                                                    <li>ì ìš©: ë¸Œë¼ìš°ì € íƒ­, í™ˆ í™”ë©´(PWA)</li>
                                                                    <li>ë¹„ìœ¨: 1:1 ì •ì‚¬ê°í˜• (í•„ìˆ˜)</li>
                                                                    <li>í¬ê¸°: 192px ì´ìƒ ê¶Œìž¥</li>
                                                                    <li>ë°°ê²½: íˆ¬ëª…(PNG) ê¶Œìž¥</li>
                                                                    <li>ìš©ëŸ‰: ê°€ê¸‰ì  ìž‘ê²Œ (ë¡œë”© ì†ë„)</li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                        <div className="flex gap-2 items-end mb-1 mt-1">
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">ë¸Œë¼ìš°ì €</span>
                                                                <div className="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100">
                                                                    {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-lg">ðŸ“</span>}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">iOS í™ˆ</span>
                                                                <div className="relative w-10 h-12 bg-gradient-to-b from-sky-300 to-sky-500 rounded-md flex flex-col items-center justify-center shadow-inner border border-slate-200 overflow-hidden pt-0.5">
                                                                    <div className="w-6 h-6 bg-white rounded-[6px] flex items-center justify-center overflow-hidden shadow-sm mb-0.5">
                                                                        {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-sm">ðŸ“</span>}
                                                                    </div>
                                                                    <span className="text-[4px] text-white font-medium drop-shadow-md truncate max-w-[36px] px-0.5">{appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?"}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={faviconRef} onChange={(e) => { 
                                                                const f = e.target.files[0]; 
                                                                if (f) { 
                                                                    const r = new FileReader(); 
                                                                    r.onload = (ev) => { 
                                                                        const newIcon = ev.target.result; 
                                                                        updateAppConfig({ favicon: newIcon });
                                                                        openConfirm("ì•± ì•„ì´ì½˜ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në³€ê²½ëœ ì•„ì´ì½˜ì„ í™ˆ í™”ë©´ì— ì ìš©í•˜ë ¤ë©´,\nê¸°ì¡´ ì•±ì„ ì‚­ì œí•˜ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n(í™•ì¸ì„ ëˆ„ë¥´ë©´ ì„¤ì¹˜ ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤)", () => onInstallApp()); 
                                                                    }; 
                                                                    r.readAsDataURL(f); 
                                                                } 
                                                            }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => faviconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ë³€ê²½</Btn>
                                                            <Btn onClick={() => openConfirm("ì•± ì•„ì´ì½˜ì„ ê¸°ë³¸ê°’(ðŸ“)ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => updateAppConfig({ favicon: null }))} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-full h-full object-cover" /> : <span className="text-xl">{appConfig.runner}</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={runnerImgRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ runner: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => runnerImgRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ëŸ¬ë„ˆ</Btn>
                                                            <Btn onClick={() => updateAppConfig({ runner: "ðŸƒ" })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-full h-full object-contain" /> : <span className="text-xl">â˜ï¸</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={cloudIconRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ cloudIcon: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => cloudIconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">êµ¬ë¦„</Btn>
                                                            <Btn onClick={() => updateAppConfig({ cloudIcon: null })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 gap-2">
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 flex-shrink-0"><Icon d={PATHS.edit} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ê¸°ë¡ ëª¨ë“œ ì œëª©</label>
                                                <input value={appConfig.recordTitle} onChange={e => updateAppConfig({ recordTitle: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ë‹¤í–ˆë‚˜ìš”!?" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-500 flex-shrink-0"><Icon d={PATHS.check} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ì™„ë£Œ ë©”ì‹œì§€</label>
                                                <input value={appConfig.recordMsg} onChange={e => updateAppConfig({ recordMsg: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ðŸŽ‰" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-500 flex-shrink-0"><Icon d={PATHS.users} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ìžì „ê³¼ ê³µì „ ì•Œë¦¼ ìš”ì¼</label>
                                                <select value={appConfig.rotationDay !== undefined ? appConfig.rotationDay : 5} onChange={e => updateAppConfig({ rotationDay: parseInt(e.target.value) })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent cursor-pointer">
                                                    <option value={1}>ì›”ìš”ì¼</option>
                                                    <option value={2}>í™”ìš”ì¼</option>
                                                    <option value={3}>ìˆ˜ìš”ì¼</option>
                                                    <option value={4}>ëª©ìš”ì¼</option>
                                                    <option value={5}>ê¸ˆìš”ì¼</option>
                                                    <option value={6}>í† ìš”ì¼</option>
                                                    <option value={0}>ì¼ìš”ì¼</option>
                                                    <option value={-1}>ì‚¬ìš© ì•ˆ í•¨</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 flex-shrink-0"><Icon d={PATHS.users} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">í•™ê¸‰ëª… (íŒŒì¼ ì €ìž¥ìš©)</label>
                                                <input value={appConfig.className || ""} onChange={e => updateAppConfig({ className: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ì˜ˆ: 3í•™ë…„ 2ë°˜" />
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="h-full group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸŽ¨</div> í™”ë©´ ë° ì†Œë¦¬ ì„¤ì •</h4>
                                        <div className="flex flex-col gap-4">
                                            <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors relative">
                                            <div className="flex items-center gap-2 mb-2">
                                                <Icon d={PATHS.document} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">ì•± í°íŠ¸</span>
                                            </div>
                                            <button 
                                                onClick={() => setShowFontList(!showFontList)} 
                                                className={`w-full p-2 border rounded-lg text-xs bg-slate-50 outline-none focus:border-indigo-500 font-bold text-slate-700 flex justify-between items-center ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}
                                            >
                                                <span className="truncate">
                                                {
                                                    appConfig.font === 'sans' ? 'ê¸°ë³¸ ê³ ë”•' :
                                                    appConfig.font === 'nanum' ? 'ë‚˜ëˆ”ê³ ë”•' :
                                                    appConfig.font === 'nanum-bold' ? 'ë‚˜ëˆ”ê³ ë”• (Bold)' :
                                                    appConfig.font === 'serif' ? 'ë‚˜ëˆ”ëª…ì¡°' :
                                                    appConfig.font === 'jua' ? 'ì£¼ì•„ì²´' :
                                                    appConfig.font === 'hand' ? 'ê°œêµ¬ì²´' : 'ê¸°ë³¸ ê³ ë”•'
                                                }
                                                </span>
                                                <Icon d={PATHS.down} size={12} className="text-slate-400 flex-shrink-0" />
                                            </button>
                                            {showFontList && (
                                                <>
                                                    <div className="fixed inset-0 z-[60]" onClick={() => setShowFontList(false)}></div>
                                                    <div className="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl z-[70] overflow-hidden max-h-60 overflow-y-auto custom-scroll">
                                                        {[
                                                            { id: 'sans', label: 'ê¸°ë³¸ ê³ ë”•', cls: 'font-sans' },
                                                            { id: 'nanum', label: 'ë‚˜ëˆ”ê³ ë”•', cls: 'font-nanum' },
                                                            { id: 'nanum-bold', label: 'ë‚˜ëˆ”ê³ ë”• (Bold)', cls: 'font-nanum font-bold' },
                                                            { id: 'serif', label: 'ë‚˜ëˆ”ëª…ì¡°', cls: 'font-serif' },
                                                            { id: 'jua', label: 'ì£¼ì•„ì²´', cls: 'font-jua' },
                                                            { id: 'hand', label: 'ê°œêµ¬ì²´', cls: 'font-hand' },
                                                        ].map(f => (
                                                            <button 
                                                                key={f.id}
                                                                onClick={() => { updateAppConfig({ font: f.id }); setShowFontList(false); }}
                                                                className={`w-full text-left px-3 py-2.5 text-xs hover:bg-indigo-50 transition-colors border-b border-slate-50 last:border-0 ${f.cls} ${appConfig.font === f.id ? 'bg-indigo-50 text-indigo-600' : 'text-slate-700'}`}
                                                            >
                                                                {f.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                            <div className="grid grid-cols-2 gap-2">
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.animationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ animationEnabled: !(appConfig.animationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.play} size={16} className={appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.animationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>í™”ë©´ ì „í™˜</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.animationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.animationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.animationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.tabAnimationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ tabAnimationEnabled: !(appConfig.tabAnimationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.right} size={16} className={appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>íƒ­ íš¨ê³¼</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.tabAnimationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.tabAnimationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.tabAnimationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.autoBatchRename ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ autoBatchRename: !appConfig.autoBatchRename })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.copy} size={16} className={appConfig.autoBatchRename ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.autoBatchRename ? "text-indigo-700" : "text-slate-500"}`}>ëª¨ë‘  ì´ë¦„ ì¼ê´„ ë³€ê²½</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.autoBatchRename ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.autoBatchRename ? "í™•ì¸ ìƒëžµ" : "í•­ìƒ í™•ì¸"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.autoBatchRename ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.autoBatchRename && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.showClassStoryButton ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ showClassStoryButton: !appConfig.showClassStoryButton })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.book} size={16} className={appConfig.showClassStoryButton ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.showClassStoryButton ? "text-indigo-700" : "text-slate-500"}`}>í•™ê¸‰ ì´ì•¼ê¸° ë²„íŠ¼</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.showClassStoryButton ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.showClassStoryButton ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.showClassStoryButton ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.showClassStoryButton && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.dDayEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ dDayEnabled: !(appConfig.dDayEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.calendar} size={16} className={appConfig.dDayEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.dDayEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>D-Day í‘œì‹œ</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.dDayEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.dDayEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.dDayEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.dDayEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.magic} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í”Œë¡œíŒ… ë²„íŠ¼ ìžë™ ìˆ¨ê¹€</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] font-bold ${appConfig.floatingButtonAutoHide !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.floatingButtonAutoHide !== false ? "ON" : "OFF"}</span>
                                                <div onClick={() => updateAppConfig({ floatingButtonAutoHide: !(appConfig.floatingButtonAutoHide !== false) })} className={`w-8 h-5 flex items-center rounded-full p-1 cursor-pointer transition-colors ${appConfig.floatingButtonAutoHide !== false ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-3 h-3 rounded-full shadow-md transform transition-transform ${appConfig.floatingButtonAutoHide !== false ? 'translate-x-3' : ''}`}></div></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.edit} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í”Œë¡œíŒ… ë²„íŠ¼ í¬ê¸°</span>
                                            </div>
                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                {['small', 'medium', 'large', 'xlarge'].map(size => (
                                                    <button key={size} onClick={() => updateAppConfig({ floatingButtonSize: size })} className={`flex-1 whitespace-nowrap px-1 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.floatingButtonSize === size ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                                        {size === 'small' ? 'ìž‘ê²Œ' : size === 'medium' ? 'ë³´í†µ' : size === 'large' ? 'í¬ê²Œ' : 'ë” í¬ê²Œ'}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.search} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í™”ë©´ ë°°ìœ¨ (UI Scale)</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold text-indigo-600">{appConfig.uiScale || 100}%</span>
                                                {(appConfig.uiScale !== 100) && (
                                                    <button 
                                                        onClick={() => updateAppConfig({ uiScale: 100 })}
                                                        className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full hover:bg-slate-200 transition-colors font-bold"
                                                    >ì´ˆê¸°í™”</button>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <input type="range" min="80" max="200" step="5" value={appConfig.uiScale || 100} onChange={(e) => updateAppConfig({ uiScale: parseInt(e.target.value) })} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                            <div className="flex justify-between gap-1">
                                                {[100, 110, 125, 150].map(scale => (
                                                    <button 
                                                        key={scale} 
                                                        onClick={() => updateAppConfig({ uiScale: scale })}
                                                        className={`flex-1 py-1 text-[10px] font-bold rounded border transition-all ${appConfig.uiScale === scale ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-slate-50 text-slate-500 border-transparent hover:bg-slate-100'}`}
                                                    >
                                                        {scale}%
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    </div>

                                    <div className="h-full group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ–ï¸</div> ë°©í•™ ê¸°ê°„ ì„¤ì •</h4>
                                        <div className="h-full flex flex-col">
                                        <div className="space-y-3 flex-1">
                                            {currentVacations.length > 0 ? (
                                                <div className="space-y-2 max-h-32 overflow-y-auto custom-scroll pr-1">
                                                    {currentVacations.map((v, i) => (
                                                        <div key={i} className="flex items-center justify-between bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm group hover:border-indigo-200 transition-colors">
                                                            <div className="flex items-center gap-2">
                                                                <span className="w-5 h-5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[10px] font-bold">{i+1}</span>
                                                                <span className="font-bold text-slate-600 text-xs">{dayjs(v.start).format('YY.MM.DD')} ~ {dayjs(v.end).format('YY.MM.DD')}</span>
                                                            </div>
                                                            <button onClick={() => removeVacation(i)} className="text-slate-300 hover:text-rose-500 p-1 hover:bg-rose-50 rounded transition-colors"><Icon d={PATHS.trash} size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (<div className="text-center text-slate-400 text-xs py-4 border-2 border-dashed border-slate-200 rounded-lg bg-white/50">ë“±ë¡ëœ ë°©í•™ ê¸°ê°„ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                            
                                            <div className="pt-3 border-t border-slate-200">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-2">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì‹œìž‘ì¼</span>
                                                        <input type="date" value={newVacStart} onChange={e => setNewVacStart(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì¢…ë£Œì¼</span>
                                                        <input type="date" value={newVacEnd} onChange={e => setNewVacEnd(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                </div>
                                                <Btn onClick={addVacation} className="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 text-xs shadow-sm flex items-center justify-center gap-1 transition-transform active:scale-95">
                                                    <Icon d={PATHS.plus} size={14} /> ê¸°ê°„ ì¶”ê°€í•˜ê¸°
                                                </Btn>
                                            </div>
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-2 flex items-center gap-1">
                                            <Icon d={PATHS.help} size={10} /> ë°©í•™ ê¸°ê°„ì—ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒì´ ì œí•œë©ë‹ˆë‹¤.
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'data' && (
                                <div className="space-y-6 animate-fade-in">
                                    
                                    {/* [1ë‹¨] ì—°ë™ ë° ìš©ëŸ‰ ë¶„ì„ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full group">
                                            <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5">
                                                <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ”—</div> 
                                                ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™
                                                <div className="flex flex-col gap-1 ml-auto">
                                                    {isAdminMode && <span className="w-fit text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">ê´€ë¦¬ìž</span>}
                                                    {isDevMode && <span className="w-fit text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-full">ê°œë°œìž</span>}
                                                </div>
                                            </h4>
                                            <div className="grid grid-cols-3 gap-2">
                                                <Btn onClick={onOpenNotionSetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isNotionConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`} title="ë…¸ì…˜ ì—°ë™">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isNotionConnected ? 'bg-green-100' : 'bg-slate-100'}`}><span className="text-lg">N</span></div>
                                                    <span className={`text-xs font-bold ${isNotionConnected ? 'text-green-700' : 'text-slate-600'}`}>ë…¸ì…˜ ì—°ë™</span>
                                                    {isNotionConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenApiKeySetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isAiConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`}>
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isAiConnected ? 'bg-green-100' : 'bg-slate-100'}`}><Icon d={PATHS.bot} size={18} className={isAiConnected ? "text-green-700" : "text-slate-500"} /></div>
                                                    <span className={`text-xs font-bold ${isAiConnected ? 'text-green-700' : 'text-slate-600'}`}>AI ì„¤ì •</span>
                                                    {isAiConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenGoogleSheetSetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isGoogleSheetConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`} title="êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isGoogleSheetConnected ? 'bg-green-100' : 'bg-slate-100'}`}><span className="text-lg">ðŸ“Š</span></div>
                                                    <span className={`text-xs font-bold ${isGoogleSheetConnected ? 'text-green-700' : 'text-slate-600'}`}>êµ¬ê¸€ ì‹œíŠ¸</span>
                                                    {isGoogleSheetConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                            </div>
                                            
                                            {/* ðŸŒŸ ì „ì²´ ì—°ë™ ìƒíƒœ ì ê²€ íŒ¨ë„ (ì´ë™ë¨) */}
                                            <div id="sync-test-panel" className="mt-4 p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner transition-all">
                                                <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsSyncPanelOpen(!isSyncPanelOpen)}>
                                                    <div className="flex items-center gap-2">
                                                        <h4 className="font-bold text-slate-700 flex items-center gap-2 text-xs">
                                                            <span className="text-base">ðŸ”„</span> ì—°ë™ ìƒíƒœ ì ê²€
                                                        </h4>
                                                        <Icon d={isSyncPanelOpen ? PATHS.down : PATHS.right} size={14} className="text-slate-400" />
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleTestAllConnections();
                                                        }}
                                                        disabled={isTestingAll}
                                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-colors shadow-sm whitespace-nowrap ${isTestingAll ? 'bg-slate-100 text-slate-400' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-100'}`}
                                                    >
                                                        {isTestingAll ? 'ì ê²€ ì¤‘...' : 'ì „ì²´ ì ê²€'}
                                                    </button>
                                                </div>
                                                {isSyncPanelOpen && (
                                                <div className="space-y-1.5 mt-3 animate-fade-in">
                                                    {[
                                                        { id: 'ai', label: 'AI (Gemini)' },
                                                        { id: 'notion_record', label: 'ë…¸ì…˜ (ê¸°ë¡)' },
                                                        { id: 'notion_portfolio', label: 'ë…¸ì…˜ (í¬í´)' },
                                                        { id: 'google', label: 'êµ¬ê¸€ ì‹œíŠ¸' }
                                                    ].map(item => {
                                                        const status = connectionStatus[item.id];
                                                        const isError = status.status === 'error';
                                                        const isSuccess = status.status === 'success';
                                                        const isPending = status.status === 'pending';
                                                        
                                                        return (
                                                            <div key={item.id} className={`flex flex-col p-2 rounded-lg border transition-colors ${isSuccess ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                                                <div className="flex items-center justify-between">
                                                                    <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-600">{item.label}</span></div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={`text-[10px] font-bold ${isError ? 'text-rose-500' : isSuccess ? 'text-emerald-600' : 'text-slate-400'}`}>
                                                                            {isPending ? 'í™•ì¸ ì¤‘...' : isSuccess ? 'ì—°ë™ ì„±ê³µ' : isError ? 'ì—°ë™ ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                                                        </span>
                                                                        <div className="w-4 h-4 flex items-center justify-center text-xs">
                                                                            {isPending ? 'â³' : isSuccess ? 'âœ…' : isError ? 'âŒ' : 'âšª'}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {isError && status.message && (
                                                                    <div className="text-[10px] text-rose-500 mt-1 bg-rose-50 p-1.5 rounded border border-rose-100 break-all">
                                                                        {status.message}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                )}
                                            </div>

                                            {isDevMode && (
                                                <div className="mt-3 pt-3 border-t border-slate-200 animate-fade-in">
                                                    <div className="flex gap-2">
                                                        <Btn onClick={toggleAiSafetyCheck} className={`flex-1 py-2.5 border rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${aiSafetyCheck ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                            <Icon d={aiSafetyCheck ? PATHS.check : PATHS.lock} size={14} />
                                                            AI ì „ì†¡ ë°ì´í„° í™•ì¸ {aiSafetyCheck ? 'ON' : 'OFF'}
                                                        </Btn>
                                                        <Btn onClick={() => setShowAiSafetyHelp(true)} className="px-3 bg-slate-100 text-slate-500 rounded-xl hover:bg-slate-200" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16} /></Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full group">
                                            <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ“Š</div> ë°ì´í„° ìš©ëŸ‰ ë¶„ì„</h4>
                                            <div className="p-4 rounded-2xl border transition-colors shadow-sm bg-slate-50 border-slate-200">
                                                <div className="flex gap-3">
                                                    <div className={`w-3 h-3 rounded-full shadow-sm mt-1.5 flex-shrink-0 ${isLocalMode ? 'bg-slate-400' : 'bg-green-500 animate-pulse'}`}></div>
                                                    <div className="flex-1 flex flex-col">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-1 cursor-pointer hover:opacity-80" onClick={(e) => { e.stopPropagation(); setShowStorageHelp(!showStorageHelp); }}>
                                                                <span className={`font-bold text-sm ${isLocalMode ? 'text-slate-600' : 'text-green-700'}`}>{isLocalMode ? "ë¡œì»¬ ì €ìž¥ì†Œ" : "í´ë¼ìš°ë“œ ë™ê¸°í™”"}</span>
                                                                <Icon d={showStorageHelp ? PATHS.down : PATHS.right} size={24} className="text-slate-400 hover:text-indigo-500 transition-colors" />
                                                            </div>
                                                            {isLocalMode ? <Btn onClick={() => { onClose(); onOpenSetup(); }} className="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-50">ì—°ê²°</Btn> : <Btn onClick={() => { openConfirm("ì—°ê²° í•´ì œ?", () => { localStorage.removeItem('checklist_config'); window.location.reload(); }) }} className="text-xs bg-white border border-rose-200 text-rose-500 px-3 py-1.5 rounded-lg font-bold hover:bg-rose-50">í•´ì œ</Btn>}
                                                        </div>
                                                        <div className="flex items-center gap-1.5 mt-2">
                                                            <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${isLocalMode ? 'bg-slate-200' : 'bg-green-200/50'}`}>
                                                                <div className={`h-full rounded-full transition-all duration-500 ${dataUsage.isCritical ? 'bg-rose-500' : dataUsage.isWarning ? 'bg-orange-500' : (isLocalMode ? 'bg-slate-500' : 'bg-green-500')}`} style={{ width: `${Math.min(dataUsage.percent, 100)}%` }}></div>
                                                            </div>
                                                            <span className={`text-[10px] font-mono ${dataUsage.isCritical ? 'text-rose-600 font-bold' : (isLocalMode ? 'text-slate-500' : 'text-green-600 font-bold')}`}>{dataUsage.percent}% ({dataUsage.kb}KB)</span>
                                                        </div>
                                                        
                                                        {showStorageHelp && (
    <div className="mt-3 p-4 bg-slate-100 rounded-2xl border border-slate-200 text-[10px] text-slate-600 leading-relaxed animate-fade-in select-text cursor-auto" onClick={e=>e.stopPropagation()}>
        <div className="flex flex-col gap-4">
            <div className="flex flex-col sm:flex-row gap-4 items-center">
                {/* ë„ë„› ì°¨íŠ¸ */}
                <div className="relative flex items-center justify-center flex-shrink-0" style={{ width: 120, height: 120 }}>
                    <svg width="120" height="120" viewBox="0 0 120 120" className="transform -rotate-90">
                        {(() => {
                            let acc = 0;
                            const r = 45; const c = 2 * Math.PI * r;
                            return dataUsage.details.map((d, i) => {
                                const val = d.percent;
                                const dash = `${(val / 100) * c} ${c}`;
                                const off = -((acc / 100) * c);
                                acc += val;
                                return <circle key={i} cx="60" cy="60" r={r} fill="transparent" stroke={d.color} strokeWidth="20" strokeDasharray={dash} strokeDashoffset={off} />;
                            });
                        })()}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span className="text-[9px] font-bold text-slate-400">Total</span>
                        <span className="text-xs font-black text-slate-700">{dataUsage.kb}KB</span>
                    </div>
                </div>

                {/* ìƒì„¸ ë¦¬ìŠ¤íŠ¸ */}
                <div className="flex-1 w-full space-y-1.5">
                    <p className="font-bold mb-2 text-indigo-600 flex justify-between items-center"><span>ðŸ“Š ìƒì„¸ ë¶„ì„</span></p>
                    <div className="grid grid-cols-1 gap-1.5 max-h-40 overflow-y-auto custom-scroll pr-1">
                        {dataUsage.details.map((d, i) => (
                            <div key={i} className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: d.color }}></div>
                                <span className="flex-1 truncate font-medium text-slate-600">{d.label}</span>
                                <span className="font-mono text-slate-500">{d.percent.toFixed(1)}%</span>
                                <span className="font-mono text-slate-400 w-12 text-right">{d.kb}KB</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            <div className="border-t border-slate-200 pt-3">
                {isLocalMode ? (
                    <div className="text-center py-2">
                        <p className="font-bold mb-1 text-slate-700">ðŸ’¾ ë¡œì»¬ ì €ìž¥ì†Œ ëª¨ë“œ</p>
                        <p className="text-slate-500">í˜„ìž¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ìž¥ ì¤‘ìž…ë‹ˆë‹¤. ë°ì´í„° ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•´ì£¼ì„¸ìš”.</p>
                    </div>
                ) : (
                    <>
                        <p className="font-bold mb-2 text-slate-700 text-[10px] flex items-center justify-center gap-1"><span>ðŸ—ï¸</span> ë°ì´í„° ê´€ë¦¬ êµ¬ì¡°ë„</p>
                        <div className="bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <div className="bg-white border-2 border-orange-200 rounded-lg p-2 mb-2 relative shadow-sm">
                                <div className="absolute -top-2 left-2 bg-orange-100 text-orange-700 text-[9px] px-1.5 rounded font-bold">ë©”ì¸ ë°ì´í„°</div>
                                <div className="flex justify-between items-center mt-1">
                                    <span className="text-slate-600 font-bold">ê¸°ë³¸ ì„¤ì •, í•™ìƒ ëª…ë‹¨</span>
                                    <span className="text-[9px] text-rose-500 font-bold bg-rose-50 px-1 rounded">1MB ì œí•œ âš ï¸</span>
                                </div>
                            </div>
                            <div className="flex justify-center my-1 relative z-10"><Icon d={PATHS.down} size={16} className="text-slate-300 bg-slate-50 rounded-full p-0.5" /></div>
                            <div className="grid grid-cols-4 gap-1 mt-2">
                                <div className="bg-white border-2 border-pink-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-pink-100 text-pink-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê³¼ì œ</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>í• ì¼</div>
                                    <div className="text-[7px] text-pink-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-blue-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ëª¨ë‘ </div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>íŽ¸ì„±</div>
                                    <div className="text-[7px] text-blue-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-purple-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-purple-100 text-purple-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">í™œë™</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>ì²´í¬</div>
                                    <div className="text-[7px] text-purple-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-green-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-green-100 text-green-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê°œë³„</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ìƒë‹´<br/>ìƒê¸°ë¶€</div>
                                    <div className="text-[7px] text-green-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    </div>
)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* [2ë‹¨] ë°±ì—…/ë³µì› ë° ì •ë¦¬/ì´ˆê¸°í™” */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full flex flex-col justify-between group">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-green-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ’¾</div> ë°ì´í„° ë°±ì—… ë° ë³µì›</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={handleExportJson} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center"><Icon d={PATHS.upload} size={18} className="text-blue-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë°±ì—…</span>
                                                    </Btn>
                                                    <Btn onClick={()=>jsonFileRef.current.click()} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center"><Icon d={PATHS.download} size={18} className="text-green-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë³µì›</span>
                                                    </Btn>
                                                    <input type="file" ref={jsonFileRef} onChange={handleImportJson} className="hidden" accept=".json" />
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-2 p-4 bg-indigo-50/50 border border-indigo-100 rounded-2xl">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2"><span className="text-xs font-bold text-indigo-800">ìžë™ ë°±ì—… ì„¤ì •</span><Btn onClick={() => setShowBackupHelp(!showBackupHelp)} className="text-indigo-400 hover:text-indigo-600"><Icon d={PATHS.help} size={16}/></Btn></div>
                                                    <div onClick={toggleAutoBackup} className={`w-10 h-6 flex items-center rounded-full p-1 cursor-pointer transition-colors ${autoBackupEnabled ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${autoBackupEnabled ? 'translate-x-4' : ''}`}></div></div>
                                                </div>
                                                {autoBackupEnabled && (
                                                    <div className="mt-2 pt-2 border-t border-slate-100 animate-fade-in">
                                                        <div className="flex flex-wrap gap-2 mb-2">{backupTimes.map(t => (<div key={t} className="flex items-center bg-white border border-indigo-100 px-2 py-1 rounded-lg text-xs font-bold text-indigo-700 shadow-sm">{t} <button onClick={()=>removeBackupTime(t)} className="ml-2 text-indigo-300 hover:text-rose-500">Ã—</button></div>))}</div>
                                                        {backupTimes.length < 4 && (<div className="flex gap-2 items-center"><div className="flex border border-slate-300 rounded-lg overflow-hidden bg-white"><select value={ampm} onChange={e=>setAmpm(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600"><option value="AM">ì˜¤ì „</option><option value="PM">ì˜¤í›„</option></select><div className="border-l border-slate-200"></div><select value={hour} onChange={e=>setHour(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i + 1).map(h => (<option key={h} value={h}>{h}ì‹œ</option>))}</select><div className="border-l border-slate-200"></div><select value={minute} onChange={e=>setMinute(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i * 5).map(m => (<option key={m} value={String(m).padStart(2, '0')}>{String(m).padStart(2, '0')}ë¶„</option>))}</select></div><button onClick={addBackupTime} className="bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-600 shadow-sm">ì¶”ê°€</button></div>)}
                                                    </div>
                                                )}
                                                {showBackupHelp && <div className="text-[10px] text-slate-500 mt-1 leading-relaxed bg-white p-2 rounded-lg border border-slate-100 animate-fade-in">ì§€ì •ëœ ì‹œê°„ì— ë¸Œë¼ìš°ì €ë¥¼ ì—´ì–´ë‘ë©´ ìžë™ìœ¼ë¡œ ë°±ì—… íŒŒì¼(json)ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. (ìµœëŒ€ 4ê°œ ì„¤ì • ê°€ëŠ¥)</div>}
                                            </div>
                                        </div>

                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full flex flex-col justify-between group">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-rose-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ðŸ§¹</div> ë°ì´í„° ê´€ë¦¬ ë° ì´ˆê¸°í™”</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={() => setShowCleanupModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-rose-50 flex items-center justify-center"><Icon d={PATHS.trash} size={18} className="text-rose-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ì •ë¦¬</span>
                                                    </Btn>
                                                    <Btn onClick={() => setShowManualModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center"><Icon d={PATHS.book} size={18} className="text-orange-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ì‚¬ìš© ì„¤ëª…ì„œ</span>
                                                    </Btn>
                                                </div>
                                            </div>
                                            <Btn onClick={() => setShowResetOptions(true)} className="w-full py-3 bg-white border-2 border-rose-100 text-rose-500 rounded-xl font-bold hover:bg-rose-50 transition-colors text-sm flex items-center justify-center gap-2 shadow-sm"><Icon d={PATHS.trash} size={18} /> ë°ì´í„° ì´ˆê¸°í™”</Btn>
                                        </div>
                                    </div>

                                    {/* [3ë‹¨] ê´€ë¦¬ìž ë©”ë‰´ */}
                                    {isAdminMode && (
                                        <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm animate-fade-in mt-2">
                                            <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><span className="text-lg">ðŸ‘‘</span> ê´€ë¦¬ìž ë©”ë‰´</h4>
                                            <div className="grid grid-cols-2 gap-3 mb-4">
                                                <Btn onClick={handleDownloadHtml} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.download} size={16} className="text-indigo-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">íŒŒì¼ë¡œ ì €ìž¥</span>
                                                </Btn>
                                                <Btn onClick={handleCopyCode} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.code} size={16} className="text-slate-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">ì½”ë“œ ë³µì‚¬</span>
                                                </Btn>
                                            </div>
                                            <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden shadow-inner">
                                                <div className="flex justify-between items-center py-3 px-4 cursor-pointer hover:bg-slate-100 transition-colors select-none" onClick={() => setShowCodeUpdater(!showCodeUpdater)}>
                                                    <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">ðŸ› ï¸ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ</h3>
                                                    <Icon d={showCodeUpdater ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                                </div>
                                                
                                                {showCodeUpdater && (
                                                    <div className="p-4 pt-2 animate-fade-in space-y-3 border-t border-slate-200 bg-white">
                                                        <p className="text-xs text-slate-500 mt-2 font-bold flex items-center gap-1"><Icon d={PATHS.document} size={12}/> ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                                                        <textarea value={updateCodeInput} onChange={(e) => setUpdateCodeInput(e.target.value)} className="w-full h-32 p-3 rounded-xl bg-slate-50 text-slate-700 text-xs font-mono border border-slate-300 focus:border-indigo-500 outline-none custom-scroll shadow-inner" placeholder="<!DOCTYPE html>..."/>
                                                        <div className="grid grid-cols-2 gap-3 mt-2">
                                                            <Btn onClick={handleApplyCode} className="py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-xs transition-colors">ì¦‰ì‹œ ì‹¤í–‰ (ë¯¸ë¦¬ë³´ê¸°)</Btn>
                                                            <Btn onClick={handleSaveCodeFile} className="py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md text-xs transition-colors">íŒŒì¼ë¡œ ì €ìž¥ (ê¶Œìž¥)</Btn>
                                                        </div>
                                                        <p className="text-[10px] text-orange-500 text-center font-bold bg-orange-50 p-2 rounded-lg mt-2">* ì¦‰ì‹œ ì‹¤í–‰ ì‹œ ë°ì´í„° ì•ˆì „ì„ ìœ„í•´ ê°€ê¸‰ì  ìžë™ ë°±ì—… ì„¤ì • í›„ ì§„í–‰í•˜ì„¸ìš”.</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            <DataCleanupModal isOpen={showCleanupModal} onClose={() => setShowCleanupModal(false)} groupsByDate={groupsByDate} records={records} setGroupsByDate={setGroupsByDate} setRecords={setRecords} saveData={saveData} isLocalMode={isLocalMode} showToast={showToast} onBackup={handleExportJson} />
                        </div>
                    </div>
                    <AiSafetyHelpModal isOpen={showAiSafetyHelp} onClose={() => setShowAiSafetyHelp(false)} />
                    <ResetOptionsModal isOpen={showResetOptions} onClose={() => setShowResetOptions(false)} onReset={handleResetAllData} />
                </BaseModal>
            );
        };

        const BalanceVisualizer = ({ groups, students, groupNames, date }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const [detailGroup, setDetailGroup] = useState(null);

            if (!groups || groups.length === 0) return null;
            return (
                <>
                    <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-auto transition-all duration-300">
                        <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsExpanded(!isExpanded)}>
                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.chart} size={18} className="text-indigo-500" /> ëª¨ë‘  ë¶„ì„ ê²°ê³¼ <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</span></h4>
                            <Icon d={isExpanded ? PATHS.down : PATHS.right} size={20} className="text-slate-400" />
                        </div>
                        {isExpanded && (
                            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 animate-fade-in">
                                {groups.map((g, i) => {
                                    if (g.length === 0) return null;
                                    const m = g.filter(s => s.gender === 'M'); const f = g.filter(s => s.gender === 'F');
                                    const high = g.filter(s => s.skill === 3); const mid = g.filter(s => s.skill === 2); const low = g.filter(s => s.skill === 1);
                                    const avgSkill = g.reduce((acc, s) => acc + s.skill, 0) / g.length;
                                    const groupName = groupNames[date]?.[i] || `${i + 1}ëª¨ë‘ `;
                                    const leader = g.find(s => s.leader);
                                    return (
                                        <div key={i} onClick={() => setDetailGroup({ index: i, students: g, name: groupName })} className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer group">
                                            <div className="flex justify-between items-center mb-3"><span className="font-bold text-slate-700 text-base truncate" title={groupName}>{groupName}</span><span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full font-bold">{g.length}ëª…</span></div>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span className="text-blue-500">ë‚¨ {m.length}</span><span className="text-pink-500">ì—¬ {f.length}</span></div>
                                                    <div className="w-full bg-slate-100 rounded-xl overflow-hidden flex text-[10px] leading-tight min-h-[24px]">
                                                        {m.length > 0 && <div style={{ width: `${(m.length/g.length)*100}%` }} className="bg-blue-400 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{m.map(s => <span key={s.id}>{s.name}{s.leader && 'ðŸ‘‘'}</span>)}</div>}
                                                        {f.length > 0 && <div style={{ width: `${(f.length/g.length)*100}%` }} className="bg-pink-400 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{f.map(s => <span key={s.id}>{s.name}{s.leader && 'ðŸ‘‘'}</span>)}</div>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span>ì‹¤ë ¥ ë¶„í¬ (í‰ê·  {avgSkill.toFixed(1)})</span></div>
                                                    <div className="w-full bg-slate-100 rounded-xl overflow-hidden flex text-[10px] leading-tight min-h-[24px]">
                                                        {low.length > 0 && <div style={{ width: `${(low.length/g.length)*100}%` }} className="bg-slate-300 text-slate-700 p-1 flex flex-wrap gap-1 justify-center items-center content-center">{low.map(s => <span key={s.id}>{s.name}{s.leader && 'ðŸ‘‘'}</span>)}</div>}
                                                        {mid.length > 0 && <div style={{ width: `${(mid.length/g.length)*100}%` }} className="bg-indigo-300 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{mid.map(s => <span key={s.id}>{s.name}{s.leader && 'ðŸ‘‘'}</span>)}</div>}
                                                        {high.length > 0 && <div style={{ width: `${(high.length/g.length)*100}%` }} className="bg-indigo-500 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{high.map(s => <span key={s.id}>{s.name}{s.leader && 'ðŸ‘‘'}</span>)}</div>}
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-0.5"><span>í•˜ {low.length}</span><span>ì¤‘ {mid.length}</span><span>ìƒ {high.length}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    {detailGroup && (
                        <BaseModal isOpen={!!detailGroup} onClose={() => setDetailGroup(null)} title={`${detailGroup.name} ìƒì„¸ ì •ë³´`} icon={PATHS.chart}>
                            <div className="space-y-6">
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200"><h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">ðŸ‘« ì„±ë³„ êµ¬ì„±</h4><div className="grid grid-cols-2 gap-4"><div className="bg-white p-3 rounded-xl border border-blue-100"><div className="text-xs font-bold text-blue-500 mb-2">ë‚¨í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='M').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='M').map(s => (<span key={s.id} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='M').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div><div className="bg-white p-3 rounded-xl border border-pink-100"><div className="text-xs font-bold text-pink-500 mb-2">ì—¬í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='F').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='F').map(s => (<span key={s.id} className="text-xs bg-pink-50 text-pink-700 px-2 py-1 rounded border border-pink-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='F').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div></div></div>
                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                                    <div className="flex justify-between items-end mb-4">
                                        <h4 className="font-bold text-slate-700 flex items-center gap-2">ðŸ“Š ì‹¤ë ¥ ë¶„í¬</h4>
                                        <span className="text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">í‰ê·  {(detailGroup.students.reduce((a,b)=>a+b.skill,0) / detailGroup.students.length).toFixed(1)}</span>
                                    </div>
                                    <div className="h-4 w-full bg-white rounded-full overflow-hidden flex mb-4 border border-slate-100 shadow-inner">
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===3).length/detailGroup.students.length)*100}%` }} className="bg-indigo-500 h-full transition-all duration-500" title="ìƒ"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===2).length/detailGroup.students.length)*100}%` }} className="bg-indigo-300 h-full transition-all duration-500" title="ì¤‘"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===1).length/detailGroup.students.length)*100}%` }} className="bg-slate-300 h-full transition-all duration-500" title="í•˜"></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-white p-3 rounded-xl border border-indigo-100 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-600 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ìƒ</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===3).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===3).map(s => <span key={s.id} className="text-[11px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===3).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-indigo-50 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-400 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ì¤‘</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===2).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===2).map(s => <span key={s.id} className="text-[11px] bg-indigo-50/50 text-indigo-600 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===2).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-slate-500 border-b border-slate-100 pb-1 flex justify-between items-center"><span>í•˜</span> <span className="bg-slate-100 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===1).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===1).map(s => <span key={s.id} className="text-[11px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===1).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </BaseModal>
                    )}
                </>
            );
        };

        const ProgressBar = ({ progress, appConfig }) => (
            <div className="w-full max-w-xl mx-auto px-6 mt-1 mb-3">
                <div className="flex justify-between text-xs font-bold text-slate-400 mb-6">
                    <span>Start</span>
                    <span className={progress===100?"text-indigo-600 animate-bounce":"text-slate-600"}>
                        {progress===100?appConfig.recordMsg:`${Math.round(progress)}%`}
                    </span>
                </div>
                <div className="relative h-1.5 bg-slate-200 rounded-full shadow-inner">
                    <div className="absolute left-0 top-0 h-full bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full transition-all duration-700 ease-out" style={{ width: `${progress}%` }}>
                        <div className="absolute -right-4 -top-5 w-8 h-8 bg-white rounded-full shadow-md border border-slate-50 flex items-center justify-center transform transition-transform hover:scale-110 z-10 cursor-pointer">
                            <span className="text-lg filter drop-shadow-sm select-none">
                                {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-5 h-5 object-contain"/> : appConfig.runner}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        );
        
        const RecordView = ({ students, records, dailyTasks, date, toggleCheck, appConfig, stats, onLongPress }) => {
            const getStreakBadge = (studentId) => {
                const s = stats.students.find(st => st.id === studentId);
                if(!s) return null;
                if(s.streak >= 30) return "ðŸŒŸ";
                if(s.streak >= 7) return "ðŸ”¥";
                if(s.streak >= 3) return "ðŸŒ±";
                return null;
            };
            
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);

            const handleTouchStart = (id) => {
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    if (navigator.vibrate) navigator.vibrate(15);
                    onLongPress(id);
                }, 1000);
            };

            const handleTouchEnd = () => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
            };

            return (
                <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const rec = records[date]?.[s.id] || { done: false, tasks: {} };
                        const currentTasks = dailyTasks[date] || [];
                        const isDone = rec.done;
                        const showPhoto = false;

                        return (
                            <div key={s.id} 
                                onMouseDown={() => handleTouchStart(s.id)} 
                                onMouseUp={handleTouchEnd} 
                                onMouseLeave={handleTouchEnd}
                                onTouchStart={() => handleTouchStart(s.id)} 
                                onTouchEnd={handleTouchEnd}
                                onClick={() => { if (!isLongPress.current) toggleCheck(s.id); }}
                                onDoubleClick={(e) => { e.preventDefault(); onLongPress(s.id); }}
                                className={`group relative flex flex-col bg-white rounded-md border transition-all duration-200 cursor-pointer overflow-hidden hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                {showPhoto ? (
                                    <div className="w-full aspect-[4/3] bg-gray-50 relative border-b border-notion-border">
                                        <img src={s.photo} className="w-full h-full object-cover" alt={s.name} />
                                        {isDone && <div className="absolute inset-0 bg-notion-blue/20 flex items-center justify-center backdrop-blur-[1px] transition-all"><div className="bg-notion-blue text-white rounded-full p-1.5 shadow-md"><Icon d={PATHS.check} size={20} /></div></div>}
                                    </div>
                                ) : (
                                    <div className={`h-1 w-full transition-colors duration-200 ${isDone ? 'bg-notion-blue' : 'bg-transparent'}`}></div>
                                )}
                                <div className="p-3 flex flex-col h-full min-h-[100px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex flex-col">
                                            <span className="text-sm font-bold text-notion-text flex items-center gap-1">
                                                {s.name} <span className="text-xs">{getStreakBadge(s.id)}</span>
                                            </span>
                                            <div className="flex items-center gap-2 mt-0.5">
                                                <span className="text-[10px] text-notion-text-light">{s.order}ë²ˆ</span>
                                                <div className="flex gap-0.5">
                                                    {stats.students.find(st => st.id === s.id)?.history.slice(-5).map((h, i) => (<div key={i} className={`w-1.5 h-1.5 rounded-full ${h.ratio === 1 ? 'bg-green-400' : h.ratio > 0 ? 'bg-yellow-400' : 'bg-slate-200'}`} title={`${h.date}: ${Math.round(h.ratio * 100)}%`}></div>))}
                                                </div>
                                            </div>
                                        </div>
                                        <div className={`transition-all duration-200 ${isDone ? 'text-notion-blue opacity-100' : 'text-notion-border opacity-0 group-hover:opacity-100'} ${showPhoto ? 'hidden' : ''}`}>
                                            <Icon d={PATHS.check} size={16} />
                                        </div>
                                    </div>
                                    {currentTasks.length > 0 ? (
                                        <div className="space-y-1 mt-1 flex-1">
                                            {currentTasks.map((t, idx) => {
                                                const taskDone = rec.tasks?.[idx];
                                                return (
                                                    <div key={idx} onClick={(e) => { e.stopPropagation(); toggleCheck(s.id, idx); }} className="flex items-center gap-2 p-1 rounded hover:bg-notion-bg-alt group/task transition-colors">
                                                        <div className={`w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${taskDone ? 'bg-notion-blue border-notion-blue text-white' : 'border-notion-border bg-white group-hover/task:border-notion-text-light'}`}>
                                                            {taskDone && <Icon d={PATHS.check} size={10} />}
                                                        </div>
                                                        <span className={`text-xs truncate flex-1 ${taskDone ? 'text-notion-text-light line-through' : 'text-notion-text'}`}>
                                                            {typeof t === 'object' ? t.title : t}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center">
                                            {isDone ? <span className="text-xs text-notion-blue font-medium bg-blue-50 px-2 py-1 rounded">ì™„ë£Œ</span> : <span className="text-xs text-notion-text-light bg-notion-bg-alt px-2 py-1 rounded">ë¯¸ì™„ë£Œ</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SimpleView = ({ students, simpleChecks, toggleCheck, onLongPress }) => {
            return (
                <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const isDone = simpleChecks[s.id];
                        return (
                            <div key={s.id} onClick={() => toggleCheck(s.id)} onDoubleClick={(e) => { if(onLongPress) { e.preventDefault(); onLongPress(s.id); } }} className={`group relative flex flex-col items-center justify-center p-6 bg-white rounded-md border transition-all duration-200 cursor-pointer hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                <div className={`text-xl font-bold mb-1 ${isDone ? 'text-notion-blue' : 'text-notion-text'}`}>{s.name}</div>
                                <div className="text-xs text-notion-text-light">{s.order}ë²ˆ</div>
                                {isDone && <div className="absolute top-2 right-2 text-notion-blue"><Icon d={PATHS.check} size={16} /></div>}
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        let UPDATE_NOTES = [
            { version: "ë¡œë”© ì¤‘...", date: "", changes: ["ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ìž…ë‹ˆë‹¤."] }
        ];

        const UpdateNotesModal = ({ isOpen, onClose, showToast, notes }) => {
            const [expandedGroups, setExpandedGroups] = useState({ 0: true });
            const [showMajorOnly, setShowMajorOnly] = useState(false);
            const [selectedNote, setSelectedNote] = useState(null);
            
            const currentNotes = notes || UPDATE_NOTES;

            const filteredNotes = useMemo(() => {
                return showMajorOnly 
                    ? currentNotes.filter(note => {
                        if (note.version.endsWith('.0')) return true;
                        const content = (note.list || note.changes || []).join(' ');
                        return content.includes('ì¶”ê°€') || content.includes('ê¸°ëŠ¥') || content.includes('ê°•í™”') || content.includes('ê°œì„ ');
                    })
                    : currentNotes;
            }, [showMajorOnly, currentNotes]);
            
            const groups = useMemo(() => {
                const result = [];
                let lastGroup = null;

                filteredNotes.forEach(item => {
                    const key = item.version.split('.').slice(0, 2).join('.');
                    if (!lastGroup || lastGroup.key !== key) {
                        lastGroup = { key, items: [] };
                        result.push(lastGroup);
                    }
                    lastGroup.items.push(item);
                });
                return result;
            }, [filteredNotes]);
            
            useEffect(() => { if (isOpen) setExpandedGroups({ 0: true }); }, [isOpen]);

            if (!isOpen) return null;
            
            const handleCopyEmail = () => {
                navigator.clipboard.writeText("spk@smca.or.kr");
                if (showToast) showToast("ì´ë©”ì¼ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            };

            const toggleGroup = (index) => {
                setExpandedGroups(prev => ({ ...prev, [index]: !prev[index] }));
            };

            const navigateNote = (direction) => {
                if (!selectedNote) return;
                const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < filteredNotes.length) {
                    setSelectedNote(filteredNotes[newIndex]);
                }
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—…ë°ì´íŠ¸ ë…¸íŠ¸" icon={PATHS.list} footer={
                    <div onClick={handleCopyEmail} className="block w-full py-2 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-center text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 cursor-pointer hover:bg-indigo-100 transition-colors select-none active:scale-95">
                        <div className="flex items-center gap-2"><span>ðŸ’¡</span> ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆí•˜ê¸° <span className="text-indigo-300 hidden sm:inline">|</span></div>
                        <div className="flex items-center gap-1"><span className="underline decoration-indigo-300 underline-offset-4">spk@smca.or.kr</span><span className="text-xs font-normal text-indigo-400 no-underline">(í´ë¦­í•˜ì—¬ ë³µì‚¬)</span></div>
                    </div>
                }>
                    <div className="flex justify-end mb-3 px-1">
                        <label className="flex items-center gap-2 cursor-pointer select-none group">
                            <span className="text-xs font-bold text-slate-500 group-hover:text-indigo-600 transition-colors">ì£¼ìš” ë³€ê²½ ì‚¬í•­ë§Œ ë³´ê¸°</span>
                            <div className={`w-9 h-5 rounded-full p-1 transition-colors duration-300 ${showMajorOnly ? 'bg-indigo-500' : 'bg-slate-200'}`}>
                                <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform duration-300 ${showMajorOnly ? 'translate-x-4' : ''}`}></div>
                            </div>
                            <input type="checkbox" checked={showMajorOnly} onChange={e => setShowMajorOnly(e.target.checked)} className="hidden" />
                        </label>
                    </div>
                    <div className="space-y-3">
                        {groups.length > 0 ? groups.map((group, groupIndex) => {
                            const isExpanded = !!expandedGroups[groupIndex];
                            return (
                                <div key={group.key} className="border border-slate-200 rounded-xl overflow-hidden bg-white">
                                    <div 
                                        className="px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors select-none bg-slate-50/50"
                                        onClick={() => toggleGroup(groupIndex)}
                                    >
                                        <h4 className="font-bold text-slate-700 text-base flex items-center gap-2">
                                            {group.key}.x 
                                            <span className="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100">
                                                {group.items.length}ê°œ ì—…ë°ì´íŠ¸
                                            </span>
                                        </h4>
                                        <Icon d={PATHS.down} size={16} className={`text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                    
                                    {isExpanded && (
                                        <div className="px-4 pb-4 pt-2 space-y-6 border-t border-slate-100">
                                            {group.items.map((update, i) => (
                                                <div key={i} className="relative pl-4 border-l-2 border-slate-200">
                                                    <div className={`absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full ${groupIndex === 0 && i === 0 ? 'bg-indigo-500 ring-4 ring-indigo-100' : 'bg-slate-300'}`}></div>
                                                    <div className="flex justify-between items-baseline mb-2 cursor-pointer group/title" onClick={() => setSelectedNote(update)}>
                                                        <h5 className={`font-bold text-sm flex items-center gap-2 ${groupIndex === 0 && i === 0 ? 'text-indigo-600' : 'text-slate-700'} group-hover/title:text-indigo-500 transition-colors`}>
                                                            {update.version}
                                                            {groupIndex === 0 && i === 0 && <span className="bg-rose-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">NEW</span>}
                                                            <Icon d={PATHS.right} size={12} className="opacity-0 group-hover/title:opacity-100 transition-opacity text-slate-400 -ml-1" />
                                                        </h5>
                                                    </div>
                                                    <ul className="space-y-1">
                                                        {(update.list || update.changes).map((change, j) => (
                                                            <li key={j} className="text-sm text-slate-600 flex items-start gap-2">
                                                                <span className="text-slate-400 mt-1.5 text-[6px]">â—</span>
                                                                <span className="flex-1 leading-relaxed">{change}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : <div className="text-center text-slate-400 py-8 text-sm">í•´ë‹¹í•˜ëŠ” ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                    {selectedNote && (() => {
                        const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                        return (
                            <div className="fixed inset-0 z-[2000] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                                <div className="absolute inset-0 bg-black/30 backdrop-blur-sm animate-fade-in" onClick={() => setSelectedNote(null)}></div>
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative z-10 animate-pop-up border border-slate-200 flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold text-indigo-600">{selectedNote.version}</h3>
                                        </div>
                                        <button onClick={() => setSelectedNote(null)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                                        <div className="space-y-3">
                                            {(selectedNote.list || selectedNote.changes).map((change, i) => (
                                                <div key={i} className="flex gap-3 text-sm text-slate-700 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <span className="text-indigo-500 font-bold mt-0.5">v</span>
                                                    <span>{change}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-slate-100">
                                        <div className="flex justify-between items-center gap-2">
                                            <Btn onClick={() => navigateNote(-1)} disabled={currentIndex === 0} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                <Icon d={PATHS.left} size={16} /> ì´ì „
                                            </Btn>
                                            <Btn onClick={() => setSelectedNote(null)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm">
                                                í™•ì¸
                                            </Btn>
                                            <Btn onClick={() => navigateNote(1)} disabled={currentIndex === filteredNotes.length - 1} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                ë‹¤ìŒ <Icon d={PATHS.right} size={16} />
                                            </Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </BaseModal>
            );
        };

        const SeatChart = ({ students, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, saveData, isLocalMode, showToast, openConfirm, groups, onGroupsChange, groupNumber, groupMethod, roleMap, onOpenStudentInfo }) => {
            const [isLayoutMode, setIsLayoutMode] = useState(false);
            const [selectedSeat, setSelectedSeat] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const seatChartRef = useRef(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const clickRef = useRef({ key: null, count: 0, lastTime: 0 });

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // [í•µì‹¬ ìˆ˜ì • 1] ë“œëž˜ê·¸ ì‹œìž‘: ë°ì´í„°ë¥¼ window ê°ì²´ì— ì§ì ‘ ì €ìž¥ (ê°€ìž¥ í™•ì‹¤í•œ ë°©ë²•)
            const handleDragStart = (e, studentId, fromSeat) => {
                if (isLayoutMode) { e.preventDefault(); return; }
                
                console.log("Drag Start:", studentId, fromSeat); // ë””ë²„ê¹…ìš©

                // ì „ì—­ ë³€ìˆ˜ì— ì €ìž¥ (ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ê³¼ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë¨)
                window.__dragData = { studentId, fromSeat };
                
                // ë°ì´í„° ì „ì†¡ ì„¤ì •
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromSeat }));
                
                const target = e.currentTarget;
                // ìŠ¤íƒ€ì¼ ì ìš© (ë¹„ë™ê¸°)
                requestAnimationFrame(() => {
                    target.classList.add("dragging");
                    document.body.classList.add('is-dragging-seat');
                });
            };

            const handleDragEnd = (e) => {
                console.log("Drag End");
                e.currentTarget.classList.remove("dragging");
                document.body.classList.remove('is-dragging-seat');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
                window.__dragData = null; // ì´ˆê¸°í™”
            };

            // [í•µì‹¬ ìˆ˜ì • 2] ë“œëž˜ê·¸ ì˜¤ë²„: ë¬´ì¡°ê±´ í—ˆìš© (preventDefault í•„ìˆ˜)
            const handleDragOver = (e) => {
                e.preventDefault(); // ì´ê²Œ ì—†ìœ¼ë©´ Dropì´ ì•ˆë¨
                e.stopPropagation();
                if (!isLayoutMode) {
                    e.dataTransfer.dropEffect = "move";
                    if (!e.currentTarget.classList.contains("drag-over")) {
                        e.currentTarget.classList.add("drag-over");
                    }
                }
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove("drag-over");
            };

            // [í•µì‹¬ ìˆ˜ì • 3] ë“œë¡­ ë¡œì§: ì „ì—­ ë°ì´í„° ìš°ì„  ì‚¬ìš©
            const handleDrop = (e, r, c) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-seat');
                
                if (isLayoutMode) return;

                try {
                    // 1ìˆœìœ„: window ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    let data = window.__dragData;
                    
                    // 2ìˆœìœ„: dataTransferì—ì„œ íŒŒì‹± (ë°±ì—…)
                    if (!data) {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    }

                    console.log("Drop Data Received:", data); // ë””ë²„ê¹…ìš©

                    if (!data || !data.studentId) {
                        console.error("No drag data found");
                        return;
                    }

                    const { studentId, fromSeat } = data;
                    const toSeat = `${r}-${c}`;
                    
                    // ê°™ì€ ìžë¦¬ë©´ ë¬´ì‹œ
                    if (fromSeat === toSeat) return;
                    // ë¹„í™œì„± ì¢Œì„ì´ë©´ ë¬´ì‹œ
                    if ((seatConfig.disabledSeats || []).includes(toSeat)) return;

                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[toSeat]; // ë„ì°©ì§€ì— ìžˆëŠ” í•™ìƒ

                    // ë¡œì§ A: ê¸°ì¡´ ìžë¦¬ì—ì„œ ì œê±° (ëŒ€ê¸°ëª…ë‹¨ì—ì„œ ì™”ìœ¼ë©´ fromSeatëŠ” nullì´ë¼ ë¬´ì‹œë¨)
                    if (fromSeat) delete newAssignments[fromSeat];

                    // ë¡œì§ B: ë„ì°©ì§€ì— í•™ìƒ ë°°ì¹˜
                    newAssignments[toSeat] = studentId;

                    // ë¡œì§ C: êµí™˜ (Swap) - ë„ì°©ì§€ì— í•™ìƒì´ ìžˆì—ˆê³ , ì¶œë°œì§€ê°€ ì¢Œì„ì¸ ê²½ìš°
                    if (targetStudentId && fromSeat) {
                        newAssignments[fromSeat] = targetStudentId;
                    }
                    // ë„ì°©ì§€ì— í•™ìƒì´ ìžˆì—ˆëŠ”ë° ì¶œë°œì§€ê°€ ëŒ€ê¸°ëª…ë‹¨ì´ë©´? -> ë„ì°©ì§€ í•™ìƒì€ ê·¸ëƒ¥ ë®ì–´ì”Œì›Œì§ (ìžë™ìœ¼ë¡œ ëŒ€ê¸°ëª…ë‹¨ìœ¼ë¡œ ê°)

                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    
                } catch (err) {
                    console.error("Drop Error:", err);
                    if(showToast) showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                } finally {
                    window.__dragData = null; // ì •ë¦¬
                }
            };

            // ... (handleSeatClick, handleStudentClick, handleRightClick ë“± ë‚˜ë¨¸ì§€ í•¨ìˆ˜ëŠ” ê¸°ì¡´ ìœ ì§€) ...
            // ì½”ë“œê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ ìœ„ ë“œëž˜ê·¸ ë¡œì§ ì´ì™¸ì˜ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.
            // ì•„ëž˜ëŠ” ë Œë”ë§ ë¶€ë¶„ìž…ë‹ˆë‹¤.

            // (Helper í•¨ìˆ˜ë“¤ ìƒëžµ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš© - ìœ„ìª½ ì½”ë“œ ì°¸ê³ í•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”)
            // handleSeatClick, handleStudentClick, handleLoadGroups, handleSaveSeatsToGroups, 
            // handleRightClick, unassignedStudents, handleDownloadImage ë“±...
            
            // íŽ¸ì˜ë¥¼ ìœ„í•´ ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ ë“œë¦¬ëŠ” ëŒ€ì‹ , 
            // ìœ„ì—ì„œ ìˆ˜ì •í•œ handleDragStart, handleDragOver, handleDrop í•¨ìˆ˜ë§Œ 
            // ê¸°ì¡´ SeatChart ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ë®ì–´ì“°ì…”ë„ ë©ë‹ˆë‹¤. 
            // í•˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ í•˜ê¸° ìœ„í•´ SeatChart ë‚´ë¶€ ë Œë”ë§ ë¶€ë¶„(return)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.

            /* ========== [ë Œë”ë§ ë¶€ë¶„ ì²´í¬ í¬ì¸íŠ¸] ========== */
            /* ëŒ€ê¸° ëª…ë‹¨ ë Œë”ë§ ë¶€ë¶„ì—ì„œ 
               draggable="true"
               onDragStart={(e) => handleDragStart(e, s.id, null)} 
               ì´ ë¶€ë¶„ì´ í•µì‹¬ìž…ë‹ˆë‹¤. fromSeat ì¸ìžì— 'null'ì„ ë„˜ê¸°ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            */

            const handleSeatClick = (r, c) => {
                const seatKey = `${r}-${c}`;
                if (isLayoutMode) {
                    const disabled = seatConfig.disabledSeats || [];
                    let newDisabled;
                    if (disabled.includes(seatKey)) newDisabled = disabled.filter(k => k !== seatKey);
                    else {
                        if (seatAssignments[seatKey]) {
                            const newAssignments = { ...seatAssignments };
                            delete newAssignments[seatKey];
                            setSeatAssignments(newAssignments);
                            if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        }
                        newDisabled = [...disabled, seatKey];
                    }
                    const newConfig = { ...seatConfig, disabledSeats: newDisabled };
                    setSeatConfig(newConfig);
                    if (!isLocalMode) saveData('cls_seat_config', newConfig);
                    return;
                }

                if ((seatConfig.disabledSeats || []).includes(seatKey)) return;

                // [New] íŠ¸ë¦¬í”Œ í´ë¦­ ê°ì§€ (ëª¨ë°”ì¼ ìš°í´ë¦­ ëŒ€ì²´)
                const now = Date.now();
                if (clickRef.current.key === seatKey && (now - clickRef.current.lastTime < 500)) {
                    clickRef.current.count += 1;
                } else {
                    clickRef.current.key = seatKey;
                    clickRef.current.count = 1;
                }
                clickRef.current.lastTime = now;

                if (clickRef.current.count === 3) {
                    if (seatAssignments[seatKey]) {
                        const newAssignments = { ...seatAssignments };
                        delete newAssignments[seatKey];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        if (selectedSeat === seatKey) setSelectedSeat(null);
                        if(showToast) showToast("ëŒ€ê¸° ëª…ë‹¨ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    clickRef.current.count = 0;
                    return;
                }

                if (selectedStudentId) {
                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[seatKey];
                    
                    const oldSeat = Object.keys(newAssignments).find(k => newAssignments[k] === selectedStudentId);
                    
                    if (oldSeat) delete newAssignments[oldSeat];
                    newAssignments[seatKey] = selectedStudentId;
                    
                    if (targetStudentId && oldSeat) {
                        newAssignments[oldSeat] = targetStudentId;
                    }
                    
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedStudentId(null);
                    setSelectedSeat(null);
                    return;
                }

                if (selectedSeat === seatKey) setSelectedSeat(null);
                else {
                    if (selectedSeat && seatAssignments[selectedSeat]) {
                        const sourceStudentId = seatAssignments[selectedSeat];
                        const targetStudentId = seatAssignments[seatKey];
                        const newAssignments = { ...seatAssignments };
                        newAssignments[seatKey] = sourceStudentId;
                        if (targetStudentId) newAssignments[selectedSeat] = targetStudentId;
                        else delete newAssignments[selectedSeat];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        setSelectedSeat(null);
                    } else setSelectedSeat(seatKey);
                }
            };

            const handleStudentClick = (studentId) => {
                if (selectedSeat) {
                    const newAssignments = { ...seatAssignments };
                    const currentSeat = Object.keys(newAssignments).find(k => newAssignments[k] === studentId);
                    const targetStudentId = newAssignments[selectedSeat];
                    if (currentSeat) {
                        if (targetStudentId) newAssignments[currentSeat] = targetStudentId;
                        else delete newAssignments[currentSeat];
                    }
                    newAssignments[selectedSeat] = studentId;
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedSeat(null);
                    setSelectedStudentId(null);
                } else {
                    const currentSeat = Object.keys(seatAssignments).find(k => seatAssignments[k] === studentId);
                    if (currentSeat) {
                        if (selectedSeat === currentSeat) setSelectedSeat(null);
                        else setSelectedSeat(currentSeat);
                        setSelectedStudentId(null);
                    } else {
                        setSelectedStudentId(prev => prev === studentId ? null : studentId);
                    }
                }
            };

            const handleLoadGroups = () => {
                if (!groups || groups.length === 0) return showToast("íŽ¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                openConfirm("ëª¨ë‘  ê²°ê³¼ë¥¼ ìžë¦¬ ë°°ì¹˜ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë°°ì¹˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤)", () => {
                    const newAssignments = {};
                    const flatStudents = groups.flat().filter(s => s && s.id);
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    showToast("ëª¨ë‘  ê²°ê³¼ê°€ ìžë¦¬ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleSaveSeatsToGroups = () => {
                const assignedIds = Object.values(seatAssignments);
                if (assignedIds.length === 0) return showToast("ë°°ì¹˜ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                
                openConfirm("í˜„ìž¬ ìžë¦¬ ë°°ì¹˜ë¥¼ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ìž¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ëª¨ë‘ ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)", () => {
                    const sortedAssignments = [];
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if (seatAssignments[key]) sortedAssignments.push(seatAssignments[key]);
                        }
                    }
                    const currentStudents = sortedAssignments.map(id => students.find(s => s.id === id)).filter(s => s).map(s => ({
                        id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order
                    }));
                    const newGroups = [];
                    let chunkSize = groupMethod === 'size' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    for (let i = 0; i < currentStudents.length; i += chunkSize) {
                        newGroups.push(currentStudents.slice(i, i + chunkSize));
                    }
                    onGroupsChange(newGroups);
                    showToast("ìžë¦¬ ë°°ì¹˜ê°€ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleRightClick = (e, seatKey) => {
                e.preventDefault();
                e.stopPropagation();
                if (isLayoutMode) return;
                
                if (seatAssignments[seatKey]) {
                    const newAssignments = { ...seatAssignments };
                    delete newAssignments[seatKey];
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    if (selectedSeat === seatKey) setSelectedSeat(null);
                }
            };

            const unassignedStudents = students.filter(s => !Object.values(seatAssignments).includes(s.id));

            const handleDownloadImage = async () => {
                if (!seatChartRef.current) return;
                try {
                    const canvas = await window.html2canvas(seatChartRef.current, {
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        onclone: (doc) => {
                            const waitingList = doc.getElementById('seat-waiting-list');
                            if (waitingList) waitingList.style.display = 'none';
                        }
                    });
                    const link = document.createElement('a');
                    link.download = `ìžë¦¬ë°°ì¹˜ë„_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    if(showToast) showToast("ìžë¦¬ ë°°ì¹˜ë„ê°€ ì´ë¯¸ì§€ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ìžë¦¬ ë°°ì¹˜ë„ ì´ë¯¸ì§€ ì €ìž¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ìž¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm select-none">
                    <div className="flex flex-col mb-4">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><span className="text-xl">ðŸª‘</span> ìžë¦¬ ë°°ì¹˜ë„</h3>
                            <div className="flex items-center gap-2">
                                <Btn onClick={handleDownloadImage} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ìž¥"><Icon d={PATHS.download} size={18} /></Btn>
                                <Btn onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`p-1.5 rounded-lg transition-colors ${isSettingsOpen ? 'bg-slate-100 text-slate-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                    <Icon d={isSettingsOpen ? PATHS.right : PATHS.left} size={16} />
                                </Btn>
                                <Btn onClick={() => setIsCollapsed(!isCollapsed)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg">
                                    <Icon d={PATHS.down} size={18} className={`transition-transform duration-200 ${!isCollapsed ? 'rotate-180' : ''}`} />
                                </Btn>
                            </div>
                        </div>
                        {isSettingsOpen && !isCollapsed && (
                            <div className="mt-3 pt-3 border-t border-slate-100 flex flex-wrap items-center gap-2 justify-end animate-fade-in">
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.rows - 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">í–‰ {seatConfig.rows}</span><button onClick={() => { const n = Math.min(10, seatConfig.rows + 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.cols - 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">ì—´ {seatConfig.cols}</span><button onClick={() => { const n = Math.min(10, seatConfig.cols + 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <label className={`flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded-lg border transition-colors ${isLayoutMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-500'}`}><input type="checkbox" checked={isLayoutMode} onChange={e => setIsLayoutMode(e.target.checked)} className="hidden" /><span className="text-xs font-bold">êµ¬ì¡° íŽ¸ì§‘</span></label>
                                <div className="flex gap-1"><Btn onClick={handleLoadGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì ìš©</Btn><Btn onClick={handleSaveSeatsToGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì„¤ì •</Btn><Btn onClick={() => openConfirm("ìžë¦¬ ë°°ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { setSeatAssignments({}); if(!isLocalMode) saveData('cls_seat_assignments', {}); })} className="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-200">ì´ˆê¸°í™”</Btn></div>
                            </div>
                        )}
                    </div>{!isCollapsed && (<div className="flex flex-col lg:flex-row gap-6" ref={seatChartRef}><div className="flex-1 overflow-auto custom-scroll bg-slate-50/50 rounded-2xl p-4 border border-slate-100 flex flex-col items-center"><div className="w-48 h-6 bg-slate-200 rounded-b-lg mb-6 flex items-center justify-center text-[10px] font-bold text-slate-500 shadow-inner">êµíƒ</div><div className="grid gap-2 md:gap-3 w-full max-w-6xl" style={{ gridTemplateColumns: `repeat(${seatConfig.cols}, minmax(${isMobile ? '60px' : '90px'}, 1fr))` }}>{Array.from({ length: seatConfig.rows }).map((_, r) => Array.from({ length: seatConfig.cols }).map((_, c) => { const seatKey = `${r}-${c}`; const studentId = seatAssignments[seatKey]; 
                    const student = students.find(s => s.id === studentId); 
                    const isDisabled = (seatConfig.disabledSeats || []).includes(seatKey); 
                    const isSelected = selectedSeat === seatKey; 
                    const role = student ? roleMap[student.id] : null; 
                    // [ì¤‘ìš”] onDrop ì´ë²¤íŠ¸ê°€ seat-cell DIVì— ê±¸ë ¤ìžˆìŒ
                    return (<div key={seatKey} onClick={() => handleSeatClick(r, c)} onDragOver={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragEnter={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragLeave={!isLayoutMode && !isDisabled ? handleDragLeave : undefined} onDrop={!isLayoutMode && !isDisabled ? (e) => handleDrop(e, r, c) : undefined} className={`seat-cell h-20 md:h-28 rounded-xl border-2 flex flex-col items-center justify-center p-1 transition-all duration-200 ease-in-out relative group ${isLayoutMode ? (isDisabled ? 'bg-slate-100 border-slate-200 cursor-pointer hover:bg-slate-200' : 'bg-white border-indigo-200 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50') : (isDisabled ? 'opacity-0 pointer-events-none' : (student ? (student.gender === 'M' ? 'bg-blue-50/30 border-blue-200' : 'bg-pink-50/30 border-pink-200') : 'bg-white border-slate-200 border-dashed hover:border-indigo-300'))} ${isSelected ? 'ring-4 ring-indigo-400 ring-offset-2 z-10 border-indigo-500' : ''}`}>{!isLayoutMode && student && (<div draggable="true" onDragStart={(e) => handleDragStart(e, student.id, seatKey)} onDragEnd={handleDragEnd} onClick={(e) => { e.stopPropagation(); handleStudentClick(student.id); }} onDoubleClick={(e) => { e.stopPropagation(); onOpenStudentInfo(student.id); }} onContextMenu={(e) => handleRightClick(e, seatKey)} className="w-full h-full flex flex-col items-center justify-center cursor-grab active:cursor-grabbing seat-node animate-bounce-in touch-none"><div className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-lg shadow-sm mb-1 overflow-hidden pointer-events-none">{(student.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§')}</div><span className="text-sm font-bold text-slate-700 w-full text-center leading-tight break-keep px-0.5 pointer-events-none">{student.name}</span>{role && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded-full mt-1 font-bold truncate max-w-full pointer-events-none">{role}</span>}</div>)}{isLayoutMode && !isDisabled && <span className="text-indigo-200 text-xs">{r+1}-{c+1}</span>}</div>); }))}</div></div>
                <div id="seat-waiting-list" className="lg:w-72 bg-slate-50 rounded-2xl border border-slate-200 p-4 flex flex-col h-auto min-h-[200px] md:min-h-[400px] flex-shrink-0">
                    <h4 className="font-bold text-slate-600 mb-2 text-xs flex justify-between items-center">
                        <span>ëŒ€ê¸° ëª…ë‹¨</span>
                        <span className="bg-slate-200 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-full">{unassignedStudents.length}</span>
                    </h4>
                    <div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 content-start p-1">
                        {unassignedStudents.map(s => (
                            <div key={s.id} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, null)} onDragEnd={handleDragEnd} onClick={() => handleStudentClick(s.id)} onDoubleClick={() => onOpenStudentInfo(s.id)} className={`student-card bg-white p-1 rounded-lg border-2 shadow-sm flex flex-col items-center justify-center gap-1 aspect-square cursor-grab active:cursor-grabbing transition-all duration-200 touch-none ${selectedStudentId === s.id ? 'border-blue-600 ring-4 ring-blue-100 bg-blue-50 z-10' : 'border-slate-200 hover:border-indigo-300 hover:shadow-md'}`}>
                                <div className="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-lg shadow-sm overflow-hidden pointer-events-none">{(s.gender === 'M' ? 'ðŸ‘¦' : 'ðŸ‘§')}</div>
                                <span className="text-sm font-bold text-slate-700 truncate w-full text-center pointer-events-none">{s.name}</span>
                            </div>
                        ))}
                    </div></div></div>)}
                </div>
            );
        };

        const PartnerAnalysisModal = ({ isOpen, onClose, groupsByDate }) => {
                const [searchTerm, setSearchTerm] = useState("");
                const [minCount, setMinCount] = useState(2);
                const [startDate, setStartDate] = useState("");
                const [endDate, setEndDate] = useState("");
                
                useEffect(() => {
                    if (isOpen) {
                        setSearchTerm("");
                        setMinCount(2);
                        const dates = Object.keys(groupsByDate).sort();
                        if (dates.length > 0) {
                            setStartDate(dates[0]);
                            setEndDate(dates[dates.length - 1]);
                        } else {
                            const today = dayjs().format('YYYY-MM-DD');
                            setStartDate(today);
                            setEndDate(today);
                        }
                    }
                }, [isOpen, groupsByDate]);

            const pairCounts = useMemo(() => {
                const counts = {};
                const lastSeenIndex = {};
                const sortedDates = Object.keys(groupsByDate).sort().filter(d => {
                    if (startDate && d < startDate) return false;
                    if (endDate && d > endDate) return false;
                    return true;
                });
                const totalDates = sortedDates.length;

                sortedDates.forEach((date, dateIdx) => {
                    const groups = groupsByDate[date];
                    if (!Array.isArray(groups)) return;
                    groups.forEach(group => {
                        if (!Array.isArray(group)) return;
                        for (let i = 0; i < group.length; i++) {
                            for (let j = i + 1; j < group.length; j++) {
                                if (!group[i] || !group[j]) continue;
                                const names = [group[i].name, group[j].name].sort();
                                const key = names.join(' & ');
                                
                                if (!counts[key]) counts[key] = { count: 0, dates: [] };

                                const lastIdx = lastSeenIndex[key];
                                // ì—°ì†ë˜ì§€ ì•Šì€ ë‚ ì§œì— ë§Œë‚¬ì„ ë•Œë§Œ ì¹´ìš´íŠ¸ ì¦ê°€ (ì—°ì†ëœ ê¸°ê°„ì€ 1íšŒë¡œ ê°„ì£¼)
                                if (lastIdx === undefined || dateIdx - lastIdx > 1) {
                                    counts[key].count += 1;
                                }
                                counts[key].dates.push(date);
                                lastSeenIndex[key] = dateIdx;
                            }
                        }
                    });
                });
                return Object.entries(counts)
                    .filter(([_, data]) => data.count >= 2)
                    .map(([key, data]) => ({ 
                        pair: key, 
                        count: data.count, 
                        dates: data.dates,
                        isRecent: lastSeenIndex[key] === totalDates - 1 
                    }))
                    .sort((a, b) => {
                        if (a.isRecent !== b.isRecent) return a.isRecent ? -1 : 1;
                        return b.count - a.count;
                    });
            }, [groupsByDate, startDate, endDate]);

            const formatDateRanges = (dates) => {
                if (!dates || dates.length === 0) return "";
                const sorted = [...dates].sort();
                const ranges = [];
                let start = sorted[0];
                let prev = sorted[0];
                
                for (let i = 1; i < sorted.length; i++) {
                    const curr = sorted[i];
                    const diff = dayjs(curr).diff(dayjs(prev), 'day');
                    if (diff > 1) {
                        const sFmt = dayjs(start).format('MM/DD');
                        const pFmt = dayjs(prev).format('MM/DD');
                        ranges.push(start === prev ? sFmt : `${sFmt}~${pFmt}`);
                        start = curr;
                    }
                    prev = curr;
                }
                const sFmt = dayjs(start).format('MM/DD');
                const pFmt = dayjs(prev).format('MM/DD');
                ranges.push(start === prev ? sFmt : `${sFmt}~${pFmt}`);
                
                return ranges.join(', ');
            };

                const filteredCounts = useMemo(() => {
                    let result = pairCounts;
                    if (minCount > 2) result = result.filter(item => item.count >= minCount);
                    if (searchTerm.trim()) result = result.filter(item => item.pair.includes(searchTerm));
                    return result;
                }, [pairCounts, searchTerm, minCount]);

                if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„">
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-700">
                            <p className="font-bold mb-1">ðŸ“Š ì¤‘ë³µ ì§ê¿ í˜„í™©</p>
                            <p>í•¨ê»˜ ëª¨ë‘  í™œë™ì„ í•œ íšŸìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. (2íšŒ ì´ìƒ)<br/><span className="text-xs opacity-80">* ì—°ì†ëœ ê¸°ê°„(ì˜ˆ: 2ì£¼ê°„ ê°™ì€ ëª¨ë‘ )ì€ 1íšŒë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</span></p>
                        </div>
                        
                        <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200">
                             <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                             <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500 flex-1"/>
                             <span className="text-xs text-slate-400">~</span>
                             <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500 flex-1"/>
                        </div>
                            
                            <div className="flex gap-2 bg-slate-100 p-1 rounded-xl">
                                {[2, 3, 4].map(count => (
                                    <button 
                                        key={count} 
                                        onClick={() => setMinCount(count)}
                                        className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${minCount === count ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                    >
                                        {count}íšŒ ì´ìƒ{count === 2 ? " (ì „ì²´)" : ""}
                                    </button>
                                ))}
                            </div>

                            <div className="relative">
                                <Icon d={PATHS.search} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                                <input 
                                    type="text" 
                                    value={searchTerm} 
                                    onChange={(e) => setSearchTerm(e.target.value)} 
                                    placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰..." 
                                    className="w-full pl-9 pr-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none transition-colors"
                                />
                            </div>

                        <div className="max-h-[60vh] overflow-y-auto custom-scroll space-y-2">
                                {filteredCounts.length > 0 ? filteredCounts.map((item, i) => (
                                <div key={i} className="flex flex-col p-3 bg-white border border-slate-200 rounded-xl">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <div className="flex items-center gap-1">
                                                {item.pair.split(' & ').map((name, idx) => (
                                                    <React.Fragment key={idx}>
                                                        {idx > 0 && <span className="text-slate-300">&</span>}
                                                        <span 
                                                            className="font-bold text-slate-700 text-sm hover:text-indigo-600 hover:underline cursor-pointer transition-colors"
                                                            onClick={() => setSearchTerm(name)}
                                                            title={`'${name}' í•™ìƒìœ¼ë¡œ ê²€ìƒ‰`}
                                                        >
                                                            {name}
                                                        </span>
                                                    </React.Fragment>
                                                ))}
                                            </div>
                                            {item.isRecent && <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded font-bold">ìµœê·¼</span>}
                                        </div>
                                        <span className={`px-2 py-1 rounded-lg text-xs font-bold ${item.count >= 4 ? 'bg-rose-100 text-rose-600' : item.count === 3 ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-600'}`}>{item.count}íšŒ</span>
                                    </div>
                                    <div className="text-[10px] text-slate-400 mt-1 pl-1">
                                        ðŸ“… {formatDateRanges(item.dates)}
                                    </div>
                                </div>
                                )) : (<div className="text-center text-slate-400 py-8 text-sm">{searchTerm ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." : "ì¤‘ë³µëœ ì§ê¿ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."}</div>)}
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const GroupResetModal = ({ isOpen, onClose, onReset }) => {
            const [duration, setDuration] = useState(1);
            
            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ðŸ§¹ ëª¨ë‘  ì´ˆê¸°í™” ì˜µì…˜" icon={PATHS.trash} maxWidth="max-w-sm">
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">âš ï¸ ëª¨ë‘  íŽ¸ì„± ê²°ê³¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">ì‚­ì œí•  ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br/>(ê¸°í”¼ ê´€ê³„, í•„ìˆ˜ ì§ê¿ ë“± ê´€ê³„ ì„¤ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)</p>
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">ì´ˆê¸°í™” ê¸°ê°„ (ì˜¤ëŠ˜ë¶€í„°)</label>
                            <div className="grid grid-cols-1 gap-2">
                                {[1, 7, 14, 21, 28].map(d => (
                                    <button key={d} onClick={() => setDuration(d)} className={`flex items-center justify-between p-3 rounded-xl border transition-all ${duration === d ? 'bg-rose-50 border-rose-200 ring-1 ring-rose-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                        <span className={`text-sm font-bold ${duration === d ? 'text-rose-700' : 'text-slate-600'}`}>{d === 1 ? 'ì˜¤ëŠ˜ í•˜ë£¨ (1ì¼)' : `${d/7}ì£¼ (${d}ì¼)`}</span>
                                        {duration === d && <Icon d={PATHS.check} size={16} className="text-rose-500" />}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex gap-2 mt-4">
                            <Btn onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                            <Btn onClick={() => onReset(duration)} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md">ì‚­ì œí•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const SetupModal = ({ isOpen, onClose, showToast, onConnect }) => {
            const [inputConfig, setInputConfig] = useState(""); 
            const [authId, setAuthId] = useState(""); 
            const [authPw, setAuthPw] = useState("");
            const [rememberMe, setRememberMe] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [isTesting, setIsTesting] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    const sId = localStorage.getItem('cls_fb_id');
                    const sPw = localStorage.getItem('cls_fb_pw');
                    const sCfg = localStorage.getItem('cls_fb_config');
                    if (sId || sPw || sCfg) {
                        setAuthId(sId || "");
                        setAuthPw(sPw || "");
                        setInputConfig(sCfg || "");
                        setRememberMe(true);
                    }
                }
            }, [isOpen]);
            
            const parseConfig = (input) => {
                if (!input) return null;
                try {
                    let clean = input.trim();
                    clean = clean.replace(/\/\*[\s\S]*?\*\//g, '');
                    clean = clean.replace(/([^\\:]|^)\/\/.*$/gm, '$1');
                    clean = clean.replace(/(?:^|[\s\r\n]+)(?:export\s+)?(?:const|let|var)\s+\w+\s*=\s*/, '');
                    clean = clean.replace(/;+\s*$/, '');
                    try { return JSON.parse(clean); } catch (e) { return new Function("return " + clean)(); }
                } catch (e) { return null; }
            };

            const handleConnect = async () => { 
                if(!authId || !authPw) { showToast("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”."); return; } 
                const config = parseConfig(inputConfig);

                if (!config || !config.projectId) { showToast("ì˜¬ë°”ë¥¸ ì„¤ì • ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤ (projectId ëˆ„ë½)."); return; }

                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    await firebase.auth().signInWithEmailAndPassword(authId, authPw); 
                    if (rememberMe) { localStorage.setItem('cls_fb_id', authId); localStorage.setItem('cls_fb_pw', authPw); localStorage.setItem('cls_fb_config', inputConfig); } 
                    else { localStorage.removeItem('cls_fb_id'); localStorage.removeItem('cls_fb_pw'); localStorage.removeItem('cls_fb_config'); }
                    onConnect(config); 
                } catch (e) { 
                    let errMsg = "ì—°ê²° ì‹¤íŒ¨: " + e.message;
                    if(e.code && e.code.includes('auth')) errMsg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
                    showToast(errMsg); logSystemEvent(errMsg, 'error');
                } 
            };

            const handleTest = async () => {
                if(!authId || !authPw) { showToast("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                const config = parseConfig(inputConfig);

                if (!config || !config.projectId) { showToast("ì˜¬ë°”ë¥¸ ì„¤ì • ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤ (projectId ëˆ„ë½)."); return; }

                setIsTesting(true);
                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    await firebase.auth().signInWithEmailAndPassword(authId, authPw);
                    showToast("âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ! (ë¡œê·¸ì¸ í™•ì¸ë¨)");
                } catch (e) {
                    let errMsg = "ì—°ê²° ì‹¤íŒ¨: " + e.message;
                    if(e.code && e.code.includes('auth')) errMsg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
                    showToast(errMsg);
                } finally {
                    setIsTesting(false);
                }
            };

            const handlePasteConfig = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setInputConfig(text);
                        showToast("ì„¤ì • ì½”ë“œê°€ ë¶™ì—¬ë„£ì–´ì¡ŒìŠµë‹ˆë‹¤.");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="â›…ï¸ Firebase ì—°ê²° ì„¤ì •" icon={null}>
                    <div className="flex justify-end mb-2">
                        <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                            <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                        </button>
                    </div>
                    {showManual && (
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-600 space-y-4 animate-fade-in mb-4 max-h-60 overflow-y-auto custom-scroll">
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">1. í”„ë¡œì íŠ¸ ìƒì„± ë° ì„¤ì •</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li><a href="https://console.firebase.google.com/" target="_blank" className="text-blue-600 underline">Firebase Console</a> ì ‘ì† &gt; í”„ë¡œì íŠ¸ ì¶”ê°€</li>
                                    <li>ì•± ì¶”ê°€(Web, &lt;/&gt; ì•„ì´ì½˜) &gt; ì•± ë‹‰ë„¤ìž„ ìž…ë ¥ &gt; ì•± ë“±ë¡</li>
                                    <li><code>const firebaseConfig = ...</code> ì½”ë“œ ì „ì²´ ë³µì‚¬</li>
                                    <li>ì•„ëž˜ <strong>'ì„¤ì • ì½”ë“œ ë¶™ì—¬ë„£ê¸°'</strong> ì¹¸ì— ë¶™ì—¬ë„£ê¸°</li>
                                </ol>
                            </div>
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">2. ì¸ì¦(ë¡œê·¸ì¸) ì„¤ì •</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>ì¢Œì¸¡ ë©”ë‰´ <strong>Build &gt; Authentication</strong> &gt; Get started</li>
                                    <li><strong>Sign-in method</strong> &gt; <strong>Email/Password</strong> &gt; ì‚¬ìš© ì„¤ì •(Enable) &gt; ì €ìž¥</li>
                                    <li><strong>Users</strong> íƒ­ &gt; Add user &gt; ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ìƒì„±</li>
                                    <li>ìƒì„±í•œ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•„ëž˜ ìž…ë ¥ì°½ì— ìž…ë ¥</li>
                                </ol>
                            </div>
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">3. ë°ì´í„°ë² ì´ìŠ¤(Firestore) ë° ë³´ì•ˆ ê·œì¹™</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>ì¢Œì¸¡ ë©”ë‰´ <strong>Build &gt; Firestore Database</strong> &gt; Create database</li>
                                    <li><strong>Rules</strong> íƒ­ í´ë¦­ &gt; ì•„ëž˜ ì½”ë“œë¡œ êµì²´ &gt; <strong>Publish</strong></li>
                                    <li>(ì£¼ì˜) ì½”ë“œ ë‚´ <code>'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”'</code> ë¶€ë¶„ì€ <strong>Authentication &gt; Users</strong> íƒ­ì—ì„œ ë°©ê¸ˆ ìƒì„±í•œ ì´ë©”ì¼ì˜ <strong>User UID</strong> ê°’ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (UIDì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë³µì‚¬ ì•„ì´ì½˜ì´ ëœ¹ë‹ˆë‹¤)</li>
                                </ol>
                                <div className="relative mt-2 group">
                                    <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white">
{`rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // ëª¨ë“  ë¬¸ì„œ({document=**})ì— ëŒ€í•˜ì—¬\n    match /{document=**} {\n      \n      // 1. ë°˜ë“œì‹œ ë¡œê·¸ì¸ì´ ë˜ì–´ ìžˆì–´ì•¼ í•˜ë©°\n      // 2. ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžì˜ UIDê°€ ì‚¬ìš©ìžë‹˜ì˜ UIDì™€ ì¼ì¹˜í•  ë•Œë§Œ ëª¨ë“  ì½ê¸°/ì“°ê¸°ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.\n      allow read, write: if request.auth != null && request.auth.uid == 'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”';\n      \n    }\n  }\n}`}
                                    </div>
                                    <button onClick={() => { const code = "rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // ëª¨ë“  ë¬¸ì„œ({document=**})ì— ëŒ€í•˜ì—¬\n    match /{document=**} {\n      \n      // 1. ë°˜ë“œì‹œ ë¡œê·¸ì¸ì´ ë˜ì–´ ìžˆì–´ì•¼ í•˜ë©°\n      // 2. ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžì˜ UIDê°€ ì‚¬ìš©ìžë‹˜ì˜ UIDì™€ ì¼ì¹˜í•  ë•Œë§Œ ëª¨ë“  ì½ê¸°/ì“°ê¸°ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.\n      allow read, write: if request.auth != null && request.auth.uid == 'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”';\n      \n    }\n  }\n}"; navigator.clipboard.writeText(code); showToast("âœ… ê·œì¹™ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                        <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="flex flex-col gap-3 mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="text-xs font-bold text-slate-500 mb-1">Firebase ì¸ì¦ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)</div><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ì´ë©”ì¼ (ID)" value={authId} onChange={e => setAuthId(e.target.value)} /><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" value={authPw} onChange={e => setAuthPw(e.target.value)} /></div><div className="relative"><textarea className="w-full h-40 p-3 border rounded-xl text-xs font-mono bg-white outline-none custom-scroll" placeholder={`// Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì • ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "project-id.firebaseapp.com",
  projectId: "project-id",
  storageBucket: "project-id.firebasestorage.app",
  messagingSenderId: "...",
  appId: "..."
};`} value={inputConfig} onChange={e => setInputConfig(e.target.value)} /><button onClick={handlePasteConfig} className="absolute top-3 right-3 bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 px-2.5 py-1.5 rounded-lg text-[10px] font-bold transition-all shadow-sm flex items-center gap-1">ë¶™ì—¬ë„£ê¸°</button></div><div className="flex items-center gap-2 mt-2 px-1"><label className="flex items-center gap-2 cursor-pointer select-none group"><div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${rememberMe ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300 group-hover:border-indigo-400'}`}>{rememberMe && <Icon d={PATHS.check} size={14} className="text-white" />}</div><input type="checkbox" className="hidden" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)} /><span className="text-sm font-bold text-slate-600 group-hover:text-indigo-600 transition-colors">ë¡œê·¸ì¸ ì •ë³´ ì €ìž¥</span></label></div><div className="flex gap-2 mt-5"><Btn onClick={onClose} className="px-4 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl">ì·¨ì†Œ</Btn><Btn onClick={handleTest} disabled={isTesting} className="flex-1 py-3 bg-white border border-indigo-200 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 flex items-center justify-center gap-2">{isTesting ? <><Icon d={PATHS.spinner} className="animate-spin" size={16}/> í™•ì¸ ì¤‘...</> : 'ì—°ê²° í…ŒìŠ¤íŠ¸'}</Btn><Btn onClick={handleConnect} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">ì—°ê²°í•˜ê¸°</Btn></div></BaseModal>
            );
        };
        const GlobalRecordModal = ({ isOpen, onClose, students, setStudents, saveData, isLocalMode, showToast, buttonPos, appConfig, db, appId }) => {
    if (!isOpen) return null;
    
    // [New] ì—°ë™ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ê°’ ì„¤ì •
    const [hasNotionRecord, setHasNotionRecord] = React.useState(false);
    const [hasNotionPortfolio, setHasNotionPortfolio] = React.useState(false);
    const [hasGoogleSheet, setHasGoogleSheet] = React.useState(false);

    const [saveTargets, setSaveTargets] = React.useState(() => {
        const key = localStorage.getItem('cls_notion_key');
        const dbId = localStorage.getItem('cls_notion_db_id');
        const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
        const sheetUrl = localStorage.getItem('cls_google_sheet_url');
        const isPortMode = localStorage.getItem('cls_portfolio_mode') === 'true';

        const targets = new Set();
        if (isPortMode && key && portDbId) targets.add('notion_portfolio');
        if (key && dbId) targets.add('notion_record');
        if (sheetUrl) targets.add('google_sheet');
        return targets;
    });

    const [selectedStudents, setSelectedStudents] = React.useState([]);
    const [notionDate, setNotionDate] = React.useState(dayjs().format('YYYY-MM-DD'));
    const [notionContent, setNotionContent] = React.useState('');
    const [keepContent, setKeepContent] = React.useState(false);
    const [closeAfterSave, setCloseAfterSave] = React.useState(false);
    const [notionStatus, setNotionStatus] = React.useState('idle');
    const [hasNotionConfig, setHasNotionConfig] = React.useState(false);
    const [hasGoogleSheetConfig, setHasGoogleSheetConfig] = React.useState(false);
    const modalRef = React.useRef(null);
    const textareaRef = React.useRef(null);
    const [saveProgress, setSaveProgress] = React.useState(0);
    const [viewMode, setViewMode] = React.useState('grid');
    const [searchText, setSearchText] = React.useState("");
    const [showStudentDropdown, setShowStudentDropdown] = React.useState(false);

    const handleSelectAll = () => {
        if (selectedStudents.length === students.length) {
            setSelectedStudents([]);
        } else {
            setSelectedStudents([...students]);
        }
    };

    const handleStudentSelect = (student) => {
        if (student && !selectedStudents.some(sel => sel.id === student.id)) {
            setSelectedStudents(prev => [...prev, student]);
        }
    };
    const removeSelectedStudent = (id) => setSelectedStudents(prev => prev.filter(s => s.id !== id));

    const toggleStudentSelection = (student) => {
        setSelectedStudents(prev => {
            const isSelected = prev.some(s => s.id === student.id);
            if (isSelected) {
                return prev.filter(s => s.id !== student.id);
            } else {
                return [...prev, student];
            }
        });
    };

    React.useEffect(() => {
        if (isOpen) {
            const key = localStorage.getItem('cls_notion_key');
            const dbId = localStorage.getItem('cls_notion_db_id');
            const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
            const sheetUrl = localStorage.getItem('cls_google_sheet_url');
            
            const rec = !!(key && dbId);
            const port = !!(key && portDbId);
            const sheet = !!sheetUrl;

            setHasNotionRecord(rec);
            setHasNotionPortfolio(port);
            setHasGoogleSheet(sheet);
            setHasNotionConfig(rec || port);
            setHasGoogleSheetConfig(sheet);

            // [Fix] ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì €ìž¥ëœ ì„¤ì •ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ì ìš© (ìƒíƒœ ì´ˆê¸°í™” ë°©ì§€)
            const savedPref = localStorage.getItem('cls_save_targets_pref');
            if (savedPref) {
                try {
                    const savedSet = new Set(JSON.parse(savedPref));
                    setSaveTargets(savedSet);
                } catch (e) {}
            }
        }
    }, [isOpen]);

    // [New] ì €ìž¥ì†Œ ì„ íƒ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ìž¥
    React.useEffect(() => {
        localStorage.setItem('cls_save_targets_pref', JSON.stringify([...saveTargets]));
    }, [saveTargets]);

    const handleIntegratedSave = async (category) => {
                if (selectedStudents.length === 0) return showToast("í•™ìƒì„ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                const content = notionContent.trim();
                if (!content) return showToast("ë‚´ìš©ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setNotionStatus('saving');
                setSaveProgress(0);

                let totalOps = 0;
                if (saveTargets.has('google_sheet')) totalOps += 1;
                if (saveTargets.has('notion_portfolio')) totalOps += 1;
                if (saveTargets.has('notion_record')) totalOps += selectedStudents.length;
                if (totalOps === 0) totalOps = 1;
                let completedOps = 0;
                const updateProgress = () => { completedOps++; setSaveProgress(Math.min(Math.round((completedOps / totalOps) * 100), 99)); };

                const date = notionDate || dayjs().format('YYYY-MM-DD');
                
                let tags = [];
                if (saveTargets.has('notion_record')) tags.push("ë…¸ì…˜(ê¸°ë¡)");
                if (saveTargets.has('notion_portfolio')) tags.push("ë…¸ì…˜(í¬í´)");
                if (saveTargets.has('google_sheet')) tags.push("êµ¬ê¸€ ì‹œíŠ¸");

                // [New] í•¨ê»˜ ê¸°ë¡ëœ í•™ìƒ ì •ë³´ ì €ìž¥
                const relatedStudents = selectedStudents.length > 1 
                    ? selectedStudents.map(s => ({ id: s.id, name: s.name })) 
                    : null;

                const newNote = { id: Date.now(), date: date, content: content, destTags: tags, relatedStudents: relatedStudents };
                const targetIds = selectedStudents.map(s => s.id);
                
                let updatedStudentsList = [...students];

                for (const targetId of targetIds) {
                    const studentObj = students.find(s => s.id === targetId);
                    if (!studentObj) continue;

                    let prevNotes = [];
                    // ðŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ì—¬ê¸°ì„œë„ ê³¼ê±° ê¸°ë¡ì„ êº¼ë‚´ì˜µë‹ˆë‹¤!
                    if (!isLocalMode && db && appId) {
                        try {
                            const doc = await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).get();
                            if (doc.exists && doc.data().counseling) {
                                prevNotes = doc.data().counseling;
                            }
                        } catch (e) { console.error("ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e); }
                    } else {
                        prevNotes = studentObj.counseling || [];
                    }

                    const updatedNotes = [newNote, ...prevNotes];
                    let updatedStickers = studentObj.stickers || 0;
                    if (category === 'ì¹­ì°¬') updatedStickers += 1;

                    if (!isLocalMode && db && appId) {
                        await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).set({ counseling: updatedNotes }, { merge: true });
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, stickers: updatedStickers } : s);
                    } else {
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, counseling: updatedNotes, stickers: updatedStickers } : s);
                    }
                }

                setStudents(updatedStudentsList);
                if (!isLocalMode) saveData('cls_students', updatedStudentsList);
                else localStorage.setItem('cls_students', JSON.stringify(updatedStudentsList));

                if (saveTargets.has('google_sheet')) {
                    let successCount = 0;
                    // ðŸŒŸ ì¤„ ì„¸ìš°ì§€ ì•Šê³ , ë°°ì—´ í†µì§¸ë¡œ ì „ì†¡!
                    if (await saveToGoogleSheet(selectedStudents, category, content, date)) {
                        successCount = selectedStudents.length;
                    }
                    updateProgress();
                    if (successCount > 0) {
                        setNotionStatus('success'); if (!keepContent) setNotionContent(''); 
                        setTimeout(() => setNotionStatus('idle'), 3000); 
                    }
                }

                try {
                    const rawKey = localStorage.getItem('cls_notion_key') || "";
                    const personalKey = rawKey.replace(/["']/g, '').trim();
                    const targets = [];
                    if (saveTargets.has('notion_record')) targets.push('notion_record');
                    if (saveTargets.has('notion_portfolio')) targets.push('notion_portfolio');

                    for (const target of targets) {
                        const rawDbId = (target === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
                        const targetDbId = rawDbId.replace(/["']/g, '').trim();
                        if (!personalKey || !targetDbId) continue;

                        const bodyData = { category: category, content: content, personalKey: personalKey, personalDbId: targetDbId };
                        
                        if (target === 'notion_portfolio') {
                            const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
                            const ids = []; 
                            const missingNames = [];
                            selectedStudents.forEach(s => { 
                                if (map[s.name]) ids.push(map[s.name]); 
                                else missingNames.push(s.name);
                            });
                            if (missingNames.length > 0) {
                                showToast(`âš ï¸ ë…¸ì…˜ ID ë¯¸ì„¤ì • í•™ìƒ ì œì™¸: ${missingNames.join(', ')}`);
                            }
                            const joinedNames = selectedStudents.map(s => s.name).join(', ');
                            bodyData.mode = 'relation'; 
                            bodyData.studentIds = ids;
                            bodyData.studentName = joinedNames;
                            const res = await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData) });
                            if (!res.ok) {
                                const errData = await res.json();
                                throw new Error(errData.error || "ë…¸ì…˜ ì €ìž¥ ì‹¤íŒ¨");
                            }
                            updateProgress();
                        } else {
                            // [Fix] ë…¸ì…˜(ê¸°ë¡) ëª¨ë“œì¼ ë•Œ ì„ íƒëœ ëª¨ë“  í•™ìƒì— ëŒ€í•´ ê°œë³„ ì €ìž¥
                            for (const s of selectedStudents) {
                                const individualBody = { 
                                    ...bodyData, 
                                    mode: 'normal', 
                                    studentName: s.name, 
                                    date: dayjs(date).format('YYYY-MM-DD') 
                                };
                                const res = await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(individualBody) });
                                if (!res.ok) {
                                    const errData = await res.json();
                                    throw new Error(errData.error || "ë…¸ì…˜ ì €ìž¥ ì‹¤íŒ¨");
                                }
                                updateProgress();
                            }
                        }
                    }
                    setSaveProgress(100);
                    setNotionStatus('success'); if (!keepContent) setNotionContent(''); setTimeout(() => setNotionStatus('idle'), 3000);
                    showToast("âœ… ê¸°ë¡ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    if (closeAfterSave) onClose();
                } catch (e) {
                    console.error(e); setNotionStatus('error'); setTimeout(() => setNotionStatus('idle'), 3000);
                    showToast(`âŒ ${e.message}`);
                }
            };

    return (
        <div className="fixed inset-0 bg-black/50 z-[2000] p-4 backdrop-blur-sm animate-fade-in flex items-center justify-center" onClick={onClose}>
            <div ref={modalRef} className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col animate-expand-from" onClick={e => e.stopPropagation()}>
                <div className="bg-slate-50 p-5 border-b border-slate-200 flex justify-between items-center">
                    <h3 className="font-bold text-slate-800 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 items-start">
                        <span className="flex items-center gap-2 whitespace-nowrap"><Icon d={PATHS.document} size={18} className="text-indigo-500"/> ë¹ ë¥¸ ê¸°ë¡</span>
                        <div className="flex flex-col sm:flex-row gap-1">
                            {hasNotionConfig && <span className="w-fit text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />ë…¸ì…˜ ì—°ë™</span>}
                            {hasGoogleSheetConfig && <span className="w-fit text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />êµ¬ê¸€ ì—°ë™</span>}
                        </div>
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full text-slate-400"><Icon d={PATHS.x} /></button>
                </div>
                
                {/* [New] ì €ìž¥ì†Œ ì„ íƒ íƒ­ UI */}
                <div className="px-5 pt-4">
                    {(hasNotionRecord || hasNotionPortfolio || hasGoogleSheet) ? (
                        <div className="flex gap-1 bg-slate-100 p-1 rounded-xl border border-slate-200">
                            {hasNotionRecord && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_record')) next.delete('notion_record'); else next.add('notion_record'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_record') ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“ ë…¸ì…˜(ê¸°ë¡)</button>}
                            {hasNotionPortfolio && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_portfolio')) next.delete('notion_portfolio'); else next.add('notion_portfolio'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_portfolio') ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“ ë…¸ì…˜(í¬í´)</button>}
                            {hasGoogleSheet && <button onClick={() => { const next = new Set(saveTargets); if(next.has('google_sheet')) next.delete('google_sheet'); else next.add('google_sheet'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('google_sheet') ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ðŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>}
                        </div>
                    ) : (
                        <div className="text-center text-xs text-slate-400 py-2 bg-slate-50 rounded-xl border border-slate-200 border-dashed">ì—°ë™ëœ ì™¸ë¶€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤ (ë¡œì»¬ì—ë§Œ ì €ìž¥ë©ë‹ˆë‹¤)</div>
                    )}
                </div>

                <div className="p-5 flex flex-col gap-4">
                    <div className="flex justify-between items-center">
                        <button onClick={handleSelectAll} className="flex items-center gap-2 text-xs font-bold text-slate-600 hover:text-indigo-600 transition-colors">
                            <div className={`w-4 h-4 rounded border-2 flex items-center justify-center ${selectedStudents.length === students.length ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>
                                {selectedStudents.length === students.length && <Icon d={PATHS.check} size={10} className="text-white" strokeWidth={3}/>}
                            </div>
                            <span>{selectedStudents.length === students.length ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'} ({selectedStudents.length}/{students.length})</span>
                        </button>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setViewMode('list')} className={`p-1.5 rounded-md transition-all ${viewMode === 'list' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`} title="ë¦¬ìŠ¤íŠ¸ ë³´ê¸°">
                                <Icon d={PATHS.list} size={16} />
                            </button>
                            <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded-md transition-all ${viewMode === 'grid' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`} title="ë°”ë‘‘íŒ ë³´ê¸°">
                                <Icon d={PATHS.grid} size={16} />
                            </button>
                        </div>
                    </div>

                    {viewMode === 'grid' ? (
                        <div className="w-full overflow-y-auto max-h-[200px] custom-scroll p-1 -mx-1 grid grid-cols-4 sm:grid-cols-5 gap-2">
                            {students.map(student => {
                                const isSelected = selectedStudents.some(s => s.id === student.id);
                                return (
                                    <div
                                        key={student.id}
                                        onClick={() => toggleStudentSelection(student)}
                                        className={`cursor-pointer rounded-lg border transition-all select-none ${isSelected ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-200' : 'border-slate-200 bg-white hover:bg-slate-50'} flex flex-col items-center justify-center p-2 aspect-square text-center`}
                                    >{/* ðŸ“¸ í•™ìƒ ì‚¬ì§„ ì˜ì—­ */}
    <div className="flex flex-col items-center mb-1 relative group w-full" onClick={(e) => e.stopPropagation()}>
        <div className="w-10 h-10 rounded-full overflow-hidden border border-slate-200 bg-white flex items-center justify-center mx-auto shadow-sm">
            {student.photoUrl ? (
                <img src={student.photoUrl} alt="ì‚¬ì§„" className="w-full h-full object-cover" />
            ) : (
                <span className="text-xs text-slate-300 font-bold">ì‚¬ì§„</span>
            )}
        </div>
        <label className="absolute inset-0 w-10 h-10 mx-auto flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
            <span className="text-white text-[9px] font-bold">ë³€ê²½</span>
            <input type="file" accept="image/*" className="hidden" onChange={(e) => handlePhotoUpload(e, student.id)} />
        </label>
    </div>
    {/* ðŸ“¸ í•™ìƒ ì‚¬ì§„ ì˜ì—­ ì‹œìž‘ */}
        <div className="flex flex-col items-center mb-1 relative group w-full" onClick={(e) => e.stopPropagation()}>
            {/* ì‚¬ì§„ì´ ë“¤ì–´ê°ˆ ë™ê·¸ëž€ í…Œë‘ë¦¬ */}
            <div className="w-12 h-12 rounded-full overflow-hidden border-2 border-slate-100 bg-slate-50 flex items-center justify-center mx-auto shadow-sm">
                {student.photoUrl ? (
                    <img src={student.photoUrl} alt="ì‚¬ì§„" className="w-full h-full object-cover" />
                ) : (
                    <span className="text-[10px] text-slate-400 font-bold">ì‚¬ì§„</span>
                )}
            </div>
            
            {/* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë‚˜íƒ€ë‚˜ëŠ” ê¹Œë§Œìƒ‰ ë°˜íˆ¬ëª… 'ë³€ê²½' ë²„íŠ¼ */}
            <label className="absolute inset-0 w-12 h-12 mx-auto flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                <span className="text-white text-[10px] font-bold">ë³€ê²½</span>
                {/* ìˆ¨ê²¨ì§„ ì§„ì§œ ì—…ë¡œë“œ ìŠ¤ìœ„ì¹˜ */}
                <input 
                    type="file" 
                    accept="image/*" 
                    className="hidden" 
                    onChange={(e) => handlePhotoUpload(e, student.id)} 
                />
            </label>
        </div>
        {/* ðŸ“¸ í•™ìƒ ì‚¬ì§„ ì˜ì—­ ë */}
                                        <span className="font-bold text-sm text-slate-700">{student.name}</span>
                                        <span className="text-xs text-slate-400">#{student.order}</span>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="relative">
                            <div className="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl flex flex-wrap gap-1.5 items-center min-h-[42px]">
                                {selectedStudents.map(s => (
                                    <span key={s.id} className="text-xs px-2.5 py-1.5 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                        {s.name} <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500"><Icon d={PATHS.x} size={10}/></button>
                                    </span>
                                ))}
                                <input 
                                    placeholder={selectedStudents.length > 0 ? "" : "í•™ìƒ ê²€ìƒ‰..."}
                                    className="flex-1 min-w-[80px] bg-transparent text-xs font-medium outline-none py-1" 
                                    value={searchText} 
                                    onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }} 
                                    onFocus={() => setShowStudentDropdown(true)} 
                                    onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)} 
                                />
                            </div>
                            {showStudentDropdown && (
                                <div className="absolute top-full left-0 w-full bg-white shadow-xl border border-slate-200 rounded-xl z-50 max-h-48 overflow-y-auto mt-1 custom-scroll py-1">
                                    {students.filter(s => s.name.includes(searchText)).map(s => {
                                        const isSelected = selectedStudents.some(sel => sel.id === s.id);
                                        return (
                                        <div key={s.id} className={`px-3 py-2 text-xs cursor-pointer font-bold flex justify-between items-center ${isSelected ? 'bg-indigo-50 text-indigo-600' : 'hover:bg-slate-50 text-slate-700'}`} onMouseDown={() => { toggleStudentSelection(s); setSearchText(""); }}>
                                            <span>{s.order}ë²ˆ {s.name}</span>
                                            {isSelected && <Icon d={PATHS.check} size={14} />}
                                        </div>
                                        );
                                    })}
                                    {students.filter(s => s.name.includes(searchText)).length === 0 && (
                                        <div className="px-3 py-2 text-xs text-slate-400 text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-600 outline-none" />
                    <textarea ref={textareaRef} value={notionContent} onChange={(e) => setNotionContent(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none min-h-[7rem] max-h-[40vh] outline-none overflow-y-auto custom-scroll" placeholder="ê´€ì°° ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”..." rows={1} />
                    <div className="flex justify-end -mt-2 gap-3">
                        <label className="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5" />
                            <span className="text-[10px] text-slate-500 font-bold">ë‚´ìš© ìœ ì§€</span>
                        </label>
                        <label className="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" checked={closeAfterSave} onChange={e => setCloseAfterSave(e.target.checked)} className="w-3.5 h-3.5" />
                            <span className="text-[10px] text-slate-500 font-bold">ìžë™ ë‹«ê¸°</span>
                        </label>
                    </div>
                    {notionStatus === 'saving' ? (
                        <div className="w-full bg-slate-100 rounded-xl h-12 flex items-center justify-center relative overflow-hidden shadow-inner">
                            <div className="absolute left-0 top-0 h-full bg-indigo-100 transition-all duration-300 ease-out" style={{ width: `${saveProgress}%` }}></div>
                            <div className="relative z-10 flex items-center gap-2 text-indigo-700 font-bold text-sm">
                                <Icon d={PATHS.spinner} className="animate-spin" />
                                <span>ì €ìž¥ ì¤‘... {saveProgress}%</span>
                            </div>
                        </div>
                    ) : (
                        <div className="flex gap-2.5">
                            <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-md whitespace-nowrap">ì¹­ì°¬í•˜ê¸° +1</button>
                            <button onClick={() => handleIntegratedSave('ê´€ì°°')} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md whitespace-nowrap">ê´€ì°° ê¸°ë¡ ì €ìž¥</button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

        const AllRecordsModal = ({ isOpen, onClose, students, appConfig, onLoadAllData }) => {
            const [sortOrder, setSortOrder] = useState('desc');
            const [selectedDate, setSelectedDate] = useState(null);
            const [showCalendar, setShowCalendar] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [isLoadingData, setIsLoadingData] = useState(false);

            const allRecords = useMemo(() => {
                const combined = [];
                students.forEach(student => {
                    if (student.counseling && Array.isArray(student.counseling)) {
                        student.counseling.forEach(note => {
                            combined.push({
                                ...note,
                                studentName: student.name,
                                studentId: student.id,
                                studentOrder: student.order,
                                studentGender: student.gender
                            });
                        });
                    }
                });
                return combined;
            }, [students]);

            const datesWithData = useMemo(() => {
                const dates = {};
                allRecords.forEach(r => dates[r.date] = true);
                return dates;
            }, [allRecords]);

            const filteredRecords = useMemo(() => {
                let filtered = allRecords;
                if (selectedDate) {
                    filtered = filtered.filter(r => r.date === selectedDate);
                }
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    filtered = filtered.filter(r => 
                        r.content.toLowerCase().includes(lower) || 
                        r.studentName.toLowerCase().includes(lower)
                    );
                }
                return filtered.sort((a, b) => {
                    if (sortOrder === 'desc') return b.date.localeCompare(a.date) || b.id - a.id;
                    return a.date.localeCompare(b.date) || a.id - b.id;
                });
            }, [allRecords, selectedDate, sortOrder, searchTerm]);

            // Group by date for timeline view
            const groupedRecords = useMemo(() => {
                const groups = {};
                filteredRecords.forEach(record => {
                    if (!groups[record.date]) groups[record.date] = [];
                    groups[record.date].push(record);
                });
                return groups;
            }, [filteredRecords]);

            const sortedDates = useMemo(() => {
                return Object.keys(groupedRecords).sort((a, b) => {
                    return sortOrder === 'desc' ? b.localeCompare(a) : a.localeCompare(b);
                });
            }, [groupedRecords, sortOrder]);

            const handleLoadData = async () => {
                if (isLoadingData) return;
                setIsLoadingData(true);
                try {
                    if (onLoadAllData) await onLoadAllData();
                } catch (e) {
                    console.error(e);
                } finally {
                    setIsLoadingData(false);
                }
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì „ì²´ ê´€ì°°/ì¹­ì°¬ ê¸°ë¡" icon={PATHS.list} maxWidth="max-w-4xl">
                    <div className="flex flex-col h-[70vh]">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-200">
                            <div className="flex items-center gap-2 w-full sm:w-auto flex-wrap">
                                <div className="relative flex-1 sm:flex-none">
                                    <Icon d={PATHS.search} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                                    <input 
                                        type="text" 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        placeholder="ì´ë¦„, ë‚´ìš© ê²€ìƒ‰..." 
                                        className="w-full sm:w-48 pl-9 pr-3 py-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-indigo-500 bg-white"
                                    />
                                </div>
                                <button 
                                    onClick={() => setShowCalendar(true)}
                                    className={`px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 whitespace-nowrap transition-colors ${selectedDate ? 'bg-indigo-100 text-indigo-700 border border-indigo-200' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                >
                                    <Icon d={PATHS.calendar} size={14} />
                                    {selectedDate ? dayjs(selectedDate).format('MM/DD') : 'ë‚ ì§œ ì„ íƒ'}
                                </button>
                                <button 
                                    onClick={handleLoadData}
                                    className={`px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 whitespace-nowrap transition-colors bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 ${isLoadingData ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    disabled={isLoadingData}
                                    title="í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°"
                                >
                                    {isLoadingData ? <Icon d={PATHS.spinner} size={14} className="animate-spin" /> : <Icon d={PATHS.download} size={14} />}
                                    <span className="hidden sm:inline">ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                                </button>
                                {selectedDate && (
                                    <button onClick={() => setSelectedDate(null)} className="p-2 bg-white border border-slate-200 hover:bg-slate-50 rounded-lg text-slate-400 transition-colors">
                                        <Icon d={PATHS.x} size={14} />
                                    </button>
                                )}
                            </div>
                            <div className="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end">
                                <span className="text-xs font-bold text-slate-500">ì´ {filteredRecords.length}ê±´</span>
                                <div className="flex bg-white rounded-lg p-1 border border-slate-200">
                                    <button onClick={() => setSortOrder('desc')} className={`px-3 py-1 rounded-md text-[10px] font-bold transition-all ${sortOrder === 'desc' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ìµœì‹ ìˆœ</button>
                                    <button onClick={() => setSortOrder('asc')} className={`px-3 py-1 rounded-md text-[10px] font-bold transition-all ${sortOrder === 'asc' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ì˜¤ëž˜ëœìˆœ</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scroll pr-2 pl-1">
                            {sortedDates.length > 0 ? (
                                <div className="space-y-8 pb-4">
                                    {sortedDates.map((date, dateIndex) => (
                                        <div key={date} className="relative pl-6 sm:pl-8">
                                            {/* Timeline Line */}
                                            <div className="absolute left-[9px] sm:left-[11px] top-7 bottom-[-32px] w-[2px] bg-slate-100 last:bottom-auto"></div>
                                            {dateIndex === sortedDates.length - 1 && <div className="absolute left-[9px] sm:left-[11px] top-7 bottom-0 w-[2px] bg-slate-100"></div>}

                                            {/* Date Header */}
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="absolute left-0 top-1 w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-indigo-50 border-2 border-indigo-100 flex items-center justify-center z-10">
                                                    <div className="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-indigo-500"></div>
                                                </div>
                                                <span className="text-sm font-bold text-slate-700 bg-slate-100 px-3 py-1 rounded-lg border border-slate-200">
                                                    {dayjs(date).format('YYYYë…„ Mì›” Dì¼ (ddd)')}
                                                </span>
                                            </div>

                                            {/* Records for this date */}
                                            <div className="space-y-3">
                                                {groupedRecords[date].map((record) => (
                                                    <div key={`${record.id}-${record.studentId}`} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:border-indigo-300 transition-all group relative">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${record.studentGender === 'M' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-pink-50 text-pink-600 border-pink-100'}`}>
                                                                    {record.studentName.slice(0, 1)}
                                                                </div>
                                                                <div>
                                                                    <div className="flex items-center gap-1.5">
                                                                        <span className="font-bold text-slate-700 text-sm">{record.studentName}</span>
                                                                        <span className="text-[10px] font-normal text-slate-400 bg-slate-50 px-1.5 rounded-full">#{record.studentOrder}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-1">
                                                                {record.destTags && record.destTags.map((tag, idx) => {
                                                                    let colorClass = "bg-slate-50 text-slate-500 border-slate-100";
                                                                    if (tag === 'ë…¸ì…˜(ê¸°ë¡)') colorClass = "bg-blue-50 text-blue-600 border-blue-100";
                                                                    else if (tag === 'ë…¸ì…˜(í¬í´)') colorClass = "bg-yellow-50 text-yellow-700 border-yellow-100";
                                                                    else if (tag === 'êµ¬ê¸€ ì‹œíŠ¸') colorClass = "bg-green-50 text-green-600 border-green-100";
                                                                    return <span key={idx} className={`text-[9px] px-1.5 py-0.5 rounded border font-bold ${colorClass}`}>{tag}</span>;
                                                                })}
                                            </div>
                                        </div>
                                                        
                                                        <div className="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed pl-10">
                                                            {record.content}
                                            </div>

                                                        {record.relatedStudents && record.relatedStudents.length > 1 && (
                                                            <div className="mt-3 pt-2 border-t border-slate-50 flex flex-wrap gap-1 pl-10">
                                                                <span className="text-[10px] text-slate-400 flex items-center gap-1 mr-1">í•¨ê»˜í•œ ì¹œêµ¬:</span>
                                                                {record.relatedStudents.filter(s => s.id !== record.studentId).map(s => (
                                                                    <span key={s.id} className="text-[10px] bg-slate-50 text-slate-500 px-1.5 py-0.5 rounded border border-slate-100">{s.name}</span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-3 border-2 border-dashed border-slate-100 rounded-2xl bg-slate-50/50">
                                    <Icon d={PATHS.list} size={32} className="opacity-20" />
                                    <span className="text-sm font-medium">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {showCalendar && (
                        <CalendarModal 
                            isOpen={showCalendar} 
                            onClose={() => setShowCalendar(false)} 
                            currentDate={selectedDate || dayjs().format('YYYY-MM-DD')}
                            onSelectDate={(date) => { setSelectedDate(date); setShowCalendar(false); }}
                            customDots={datesWithData}
                            mode="custom"
                            appConfig={appConfig}
                        />
                    )}
                </BaseModal>
            );
        };
// --- [ì—¬ê¸°ê¹Œì§€ ë³µì‚¬] ---
        const App = () => {
            const [forceRender, setForceRender] = useState(0); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ìš© ìŠ¤ìœ„ì¹˜
            const CURRENT_VERSION = UPDATE_NOTES[0].version; // ë¬´ì¡°ê±´ jsonì˜ ì²«ë²ˆì§¸(ìµœì‹ )ë¥¼ ë‚´ ë²„ì „ìœ¼ë¡œ ì¸ì‹!
            const updateDate = UPDATE_NOTES[0].date;

            // [Service Worker Update Logic] 
    const [newVersionAvailable, setNewVersionAvailable] = useState(false); 
    const [waitingWorker, setWaitingWorker] = useState(null);

    const handleCloseUpdate = (type) => {
        let snoozeUntil;
        if (type === 'today') {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            snoozeUntil = tomorrow.getTime();
        } else {
            snoozeUntil = new Date().getTime() + 600000;
        }
        localStorage.setItem('cls_update_snooze', snoozeUntil.toString());
        setNewVersionAvailable(false);
    };

    const handleUpdateApp = async () => {
            // ðŸŒŸ 1. "ë‚˜ ì´ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œí–ˆì–´!"ë¼ê³  í°ì— ì˜êµ¬ ë„ìž¥ ì°ê¸° (ë°°ë„ˆ ì•ˆ ëœ¨ê²Œ í•˜ëŠ” í•µì‹¬!)
            const latestVersion = Array.isArray(UPDATE_NOTES) ? UPDATE_NOTES[0].version : UPDATE_NOTES.version;
            localStorage.setItem('cls_last_version', latestVersion);

            // ðŸŒŸ 2. ë¸Œë¼ìš°ì € ìºì‹œ(ì˜›ë‚  ì°Œêº¼ê¸° íŒŒì¼ë“¤) ì™„ë²½í•˜ê²Œ í­íŒŒ
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                } catch (e) { console.error("ìºì‹œ ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ðŸŒŸ 3. ê³ ì§‘ë¶€ë¦¬ëŠ” ì˜›ë‚  ì„œë¹„ìŠ¤ ì›Œì»¤(ì•± ê´€ë¦¬ìž) ê°•ì œ í•´ê³ ! (ê°€ìž¥ í™•ì‹¤í•œ ì‹¤ì œ ì—…ë°ì´íŠ¸ ë°©ë²•)
            if (navigator.serviceWorker) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister(); 
                    }
                } catch (e) { console.error("SW ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ðŸŒŸ 4. ì°Œêº¼ê¸° í•˜ë‚˜ ì—†ëŠ” ì•„ì£¼ ê¹¨ë—í•œ ì£¼ì†Œë¡œ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?clear=' + new Date().getTime();
        };

    useEffect(() => { 
        const checkUpdateFile = () => {
            fetch(`/update.json?t=${new Date().getTime()}`)
                .then(res => res.json())
                .then(data => {
                    // ë°ì´í„° ì•ˆì „í•˜ê²Œ ë°°ì—´ë¡œ ë§Œë“¤ê¸°
                    let fetchedNotes = Array.isArray(data) ? data : [data];
                    UPDATE_NOTES = fetchedNotes;
                    
                    // í™”ë©´ ë Œë”ë§ ìŠ¤ìœ„ì¹˜ (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìž‘ë™í•˜ë„ë¡ ë°©ì–´)
                    if (typeof setForceRender === 'function') setForceRender(prev => prev + 1);
                    if (typeof setIsLoaded === 'function') setIsLoaded(true);

                    // ðŸŒŸ ë¬´í•œ ì•Œë¦¼ ë°©ì§€ì˜ í•µì‹¬!
                    const latestVersion = fetchedNotes[0].version;
                    const lastVersion = localStorage.getItem('cls_last_version');
                    
                    // í•¸ë“œí°ì— ì°ížŒ ë„ìž¥(lastVersion)ê³¼ jsonì˜ ìµœì‹  ë²„ì „(latestVersion)ì´ ê°™ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ! (ë°°ë„ˆ ì•ˆ ëœ¸)
                    if (lastVersion === latestVersion) return;

                    // ìŠ¤ëˆ„ì¦ˆ(ë‚˜ì¤‘ì— ë³´ê¸°) ê¸°ëŠ¥ í™•ì¸
                    const snoozeTime = localStorage.getItem('cls_update_snooze');
                    const now = new Date().getTime();
                    if (snoozeTime && now < parseInt(snoozeTime, 10)) return;

                    // ë„ìž¥ë„ ë‹¤ë¥´ê³ , ìŠ¤ëˆ„ì¦ˆë„ ì•„ë‹ˆë©´ ë¹„ë¡œì†Œ ë°°ë„ˆ ë„ì›€
                    setNewVersionAvailable(true);
                })
                .catch(err => console.log("ì—…ë°ì´íŠ¸ íŒŒì¼ í™•ì¸ ë¶ˆê°€:", err));
        };

        checkUpdateFile();

        if ('serviceWorker' in navigator) { 
            navigator.serviceWorker.register('./sw.js').then(registration => { 
                if (registration.waiting) { 
                    setWaitingWorker(registration.waiting); 
                    setNewVersionAvailable(true); 
                } 
                registration.addEventListener('updatefound', () => { 
                    const newWorker = registration.installing; 
                    newWorker.addEventListener('statechange', () => { 
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) { 
                            setWaitingWorker(newWorker); 
                            setNewVersionAvailable(true); 
                        } 
                    }); 
                }); 
                setInterval(() => {
                    registration.update(); 
                    checkUpdateFile();     
                }, 600000);
            }); 

            let refreshing = false; 
            navigator.serviceWorker.addEventListener('controllerchange', () => { 
                if (!refreshing) { 
                    window.location.reload(); 
                    refreshing = true; 
                } 
            }); 
        } 
    }, []);

            const [mode, setMode] = useState("record");
            const [date, setDate] = useState(getToday());

            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ì‹œìž‘ --- */
            const [isPortfolioMode, setIsPortfolioMode] = React.useState(false);
            const [studentMap, setStudentMap] = React.useState({});
            const [portfolioDbId, setPortfolioDbId] = React.useState('');

            // ì´ˆê¸° ì‹¤í–‰ì‹œ ì €ìž¥ëœ í¬íŠ¸í´ë¦¬ì˜¤ ID ë¶ˆëŸ¬ì˜¤ê¸°
            React.useEffect(() => {
                const saved = localStorage.getItem('cls_notion_portfolio_db_id');
                if (saved) setPortfolioDbId(saved);
                
                // [Fix] ì•± ì‹œìž‘ ì‹œ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ë¡œë“œ
                const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                setIsPortfolioMode(savedMode);
            }, []);

            React.useEffect(() => {
              try {
                const saved = localStorage.getItem('cls_student_map');
                if (saved) setStudentMap(JSON.parse(saved));
              } catch (e) {}
            }, []);
            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ë --- */

            const [students, setStudents] = useState([]);
            // ðŸŒŸ ImgBB ì—°ë™ ìƒíƒœ (ì‚¬ì§„ ê¸°ëŠ¥)
    const [imgbbApiKey, setImgbbApiKey] = useState("");
    const [showImgbbModal, setShowImgbbModal] = useState(false);
    const [tempImgbbKey, setTempImgbbKey] = useState("");

    // ðŸŒŸ ì•± ì‹¤í–‰ ì‹œ ë‚´ Firebaseì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸° (Compat ë²„ì „ ë§žì¶¤ ì½”ë“œ)
    useEffect(() => {
        const fetchApiKey = async () => {
            try {
                if (!db) return;
                const docRef = db.collection("settings").doc("imgbb");
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    setImgbbApiKey(docSnap.data().apiKey || "");
                }
            } catch (error) {
                console.error("API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:", error);
            }
        };
        fetchApiKey();
    }, []);
            const [records, setRecords] = useState({});
            const [simpleChecks, setSimpleChecks] = useState({});
            const [groupsByDate, setGroupsByDate] = useState({});
            const [avoidancePairs, setAvoidancePairs] = useState([]);
            const [dailyTasks, setDailyTasks] = useState({});
            const [weeklyTasks, setWeeklyTasks] = useState({ 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cls_ai_key') || "");
            const [isApiKeyValid, setIsApiKeyValid] = useState(false);
            const [tags, setTags] = useState(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
            const [backupTimes, setBackupTimes] = useState(() => {
                const saved = localStorage.getItem('cls_backup_times');
                return saved ? JSON.parse(saved) : ['12:00', '14:50'];
            });
            const [lockedIds, setLockedIds] = useState([]);
            const [groupNames, setGroupNames] = useState({});
            const [groupRoles, setGroupRoles] = useState({});
            const [rolesList, setRolesList] = useState(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
            const [roleDescriptions, setRoleDescriptions] = useState(DEFAULT_ROLE_DESCRIPTIONS);
            const [seatAssignments, setSeatAssignments] = useState({});
            const [seatConfig, setSeatConfig] = useState({ rows: 5, cols: 5, disabledSeats: ['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4'] });
            const [groupDuration, setGroupDuration] = useState(1);
            const [historyDuration, setHistoryDuration] = useState(14);
            const [isDevMode, setIsDevMode] = useState(() => localStorage.getItem('cls_dev_mode') === 'true');
            const [gearClickCount, setGearClickCount] = useState(0);
            const gearClickTimer = useRef(null);
            
            const [p1, setP1] = useState(""); const [p2, setP2] = useState("");
            const [groupMethod, setGroupMethod] = useState('count'); const [groupNumber, setGroupNumber] = useState(4);
            const [useGender, setUseGender] = useState(true); const [useSkill, setUseSkill] = useState(true);
            const [isGenerating, setIsGenerating] = useState(false); const [isAvoidanceVisible, setIsAvoidanceVisible] = useState(false);
            const [useLeader, setUseLeader] = useState(false);
            const [useHistory, setUseHistory] = useState(false); 
            const [useRecentAvoid, setUseRecentAvoid] = useState(false);
            const [mustPairs, setMustPairs] = useState([]); 
            const [pairTab, setPairTab] = useState('avoid'); 
            const [showRoleHelp, setShowRoleHelp] = useState(false);
            const [isGroupToolsOpen, setIsGroupToolsOpen] = useState(window.innerWidth >= 768);
            const [useAI, setUseAI] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("");
            const [aiReason, setAiReason] = useState(null);

            const [honorPeriod, setHonorPeriod] = useState('weekly'); const [helpPeriod, setHelpPeriod] = useState('weekly');
            const [honorTag, setHonorTag] = useState('ì „ì²´'); const [helpTag, setHelpTag] = useState('ì „ì²´'); const [grassStudentId, setGrassStudentId] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isSettingOpen, setIsSettingOpen] = useState(false); const [isSetupOpen, setIsSetupOpen] = useState(false); const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [isRangeCalendarOpen, setIsRangeCalendarOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: "", onConfirm: null, onCancel: null }); const [toastMessage, setToastMessage] = useState(null); const [toastAction, setToastAction] = useState(null);
            const [isNotionSetupOpen, setIsNotionSetupOpen] = useState(false);
            const [isApiKeySetupOpen, setIsApiKeySetupOpen] = useState(false);
            const [isGoogleSheetSetupOpen, setIsGoogleSheetSetupOpen] = useState(false);
            const [isLoadGroupCalendarOpen, setIsLoadGroupCalendarOpen] = useState(false);
            // ðŸŒŸ íŠœí† ë¦¬ì–¼ ìƒíƒœ ê´€ë¦¬
    const [showTutorial, setShowTutorial] = useState(false);
    const [tutorialStep, setTutorialStep] = useState(0);

    const tutorialSlides = [
        { emoji: 'ðŸ‘‹', title: 'ì„ ìƒë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!', desc: 'í‡´ê·¼ ì‹œê°„ì„ ì•žë‹¹ê²¨ ì¤„ ìŠ¤ë§ˆíŠ¸í•œ í•™ê¸‰ ê²½ì˜ ë„êµ¬ìž…ë‹ˆë‹¤. ë†€ë¼ìš´ í•µì‹¬ ê¸°ëŠ¥ì„ ë¹ ë¥´ê²Œ ì•Œì•„ë³¼ê¹Œìš”?' },
        { emoji: 'âš¡', title: 'ë¹ ë¥¸ ë‹¤ì¤‘ ê¸°ë¡', desc: 'ìš°ì¸¡ í•˜ë‹¨ì˜ [ë¹ ë¥¸ ê¸°ë¡ íŽœ] ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. í•œ ë²ˆì— ì—¬ëŸ¬ ëª…ì˜ ê´€ì°°/ì¹­ì°¬ ê¸°ë¡ì„ ìˆœì‹ê°„ì— ë‚¨ê¸¸ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.' },
        { emoji: 'ðŸš€', title: 'ì´ˆê³ ì† ì™¸ë¶€ ì—°ë™ (ëˆ„ë½ 0%)', desc: 'ìž…ë ¥í•œ ê¸°ë¡ì€ êµ¬ê¸€ ì‹œíŠ¸ì™€ ë…¸ì…˜ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. ìˆ˜ì‹­ ëª…ì„ ì„ íƒí•´ë„ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°•ìŠ¤(Batch)ë¡œ ë¬¶ì–´ 0.1ì´ˆ ë§Œì— ì•ˆì „í•˜ê³  ë¹ ë¥´ê²Œ ì¼ê´„ ì „ì†¡í•©ë‹ˆë‹¤.' },
        { emoji: 'ðŸ¤–', title: 'ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ AI ìƒë‹´ì†Œ', desc: 'í•™ìƒ ì´ë¦„í‘œë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ ì¸ì‚¬ì´íŠ¸ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. [AI ìƒë‹´ì†Œ]ì˜ í†±ë‹ˆë°”í€´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ABA, PDC, ê°ì •ì½”ì¹­ ë“± ë§žì¶¤í˜• ì „ë¬¸ê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ë°”ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.' },
        { emoji: 'ðŸ“Š', title: 'í´ë¦­ í•œ ë²ˆì— ìƒê¸°ë¶€ ì´ˆì•ˆ ì™„ì„±', desc: 'ê¸°ë¡ì´ ìŒ“ì´ë©´ [AI ì´í‰ ì´ˆì•ˆ] íƒ­ì„ í™œìš©í•´ ë³´ì„¸ìš”. í–‰ë°œ, êµê³¼ ë“± ìžë™ ì¶”ì²œ í…œí”Œë¦¿ì— ë§žì¶° í•™ìƒì˜ ì¢…í•© ì˜ê²¬ ì´ˆì•ˆì„ ëšë”± ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.' }
    ];
            const [appConfig, setAppConfig] = useState({ recordTitle: "ë‹¤í–ˆë‚˜ìš”!?", recordMsg: "ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ðŸŽ‰", simpleTitle: "ë‹¨ìˆœ í™•ì¸í‘œ", simpleMsg: "í™•ì¸ ì™„ë£Œ! ðŸ‘Œ", runner: "ðŸƒ", version: CURRENT_VERSION, vacationStart: "", vacationEnd: "", cloudIcon: null, font: 'sans', favicon: null, animationEnabled: true, tabAnimationEnabled: true, updateNotificationType: 'toast', floatingButtonSize: 'medium', uiScale: 100, showClassStoryButton: false });
            const [isLocalMode, setIsLocalMode] = useState(true); const [db, setDb] = useState(null); const [appId, setAppId] = useState("");
            const [editingGroupIdx, setEditingGroupIdx] = useState(null);
            const [editingGroupName, setEditingGroupName] = useState("");
            const lastBackupTime = useRef("");
            const [editingRoleTarget, setEditingRoleTarget] = useState(null);
            const [isLoading, setIsLoading] = useState(true); 
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [showLongLoading, setShowLongLoading] = useState(false);
            const [showOfflineModal, setShowOfflineModal] = useState(false);
            const [autoCloseTimer, setAutoCloseTimer] = useState(3);
            const [showUpdateNotes, setShowUpdateNotes] = useState(false);

            useEffect(() => {
                const scale = appConfig.uiScale || 100;
                const scaleFactor = scale / 100;
                
                // [Fix] Firefox ë“± zoom ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ëŒ€ì‘ ë° ë†’ì´ ë³´ì • ë¡œì§ ê°œì„ 
                const isZoomSupported = 'zoom' in document.documentElement.style;
                
                if (isZoomSupported) {
                    document.body.style.zoom = scale + '%';
                    document.body.style.setProperty('--ui-scale', scaleFactor);
                    
                    // í™”ë©´ ë°°ìœ¨ í™•ëŒ€ ì‹œ ë·°í¬íŠ¸ ë†’ì´ ë³´ì • (ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€)
                    const root = document.getElementById('root');
                    if (root) {
                        const adjustedHeight = 100 / scaleFactor;
                        root.style.height = `${adjustedHeight}vh`;
                    }
                } else {
                    // zoom ë¯¸ì§€ì› ì‹œ ë°°ìœ¨ ì„¤ì • ë¬´ì‹œ (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€)
                    document.body.style.zoom = '';
                    document.body.style.removeProperty('--ui-scale');
                    const root = document.getElementById('root');
                    if (root) root.style.height = '';
                }

                // [Fix] í™”ë©´ ë°°ìœ¨ ë³€ê²½ ì‹œ í”Œë¡œíŒ… ë²„íŠ¼ ìœ„ì¹˜ ìž¬ì¡°ì • (í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” í˜„ìƒ ë°©ì§€)
                setButtonPos(prev => {
                    const screenW = window.innerWidth;
                    const screenH = window.innerHeight;
                    const btnSize = 80; // ë²„íŠ¼ í¬ê¸° + ì—¬ìœ  ê³µê°„
                    
                    // Effective screen size in zoomed coordinates
                    const effectiveW = screenW / scaleFactor;
                    const effectiveH = screenH / scaleFactor;

                    let newX = prev.x;
                    let newY = prev.y;
                    
                    if (newX > effectiveW - btnSize) newX = effectiveW - btnSize;
                    if (newY > effectiveH - btnSize) newY = effectiveH - btnSize;
                    
                    return { x: Math.max(10, newX), y: Math.max(10, newY) };
                });
            }, [appConfig.uiScale]);

            // [New] í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ í”Œë¡œíŒ… ë²„íŠ¼ ìœ„ì¹˜ ë³´ì • (Resize Event)
            useEffect(() => {
                const handleResize = () => {
                    setButtonPos(prev => {
                        const scaleFactor = (appConfig.uiScale || 100) / 100;
                        const screenW = window.innerWidth;
                        const screenH = window.innerHeight;
                        const btnSize = 80; 

                        const effectiveW = screenW / scaleFactor;
                        const effectiveH = screenH / scaleFactor;

                        let newX = prev.x;
                        let newY = prev.y;

                        if (newX > effectiveW - btnSize) newX = effectiveW - btnSize;
                        if (newY > effectiveH - btnSize) newY = effectiveH - btnSize;

                        return { x: Math.max(10, newX), y: Math.max(10, newY) };
                    });
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [appConfig.uiScale]);

            // [New] ë²„ì „ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ ìžë™ í‘œì‹œ
            useEffect(() => {
                // [Fix] ì´ˆê¸° ë¡œë”© ìƒíƒœ("ë¡œë”© ì¤‘...")ì¼ ë•ŒëŠ” ë²„ì „ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ë°©ì–´ ì½”ë“œ ì¶”ê°€
                if (CURRENT_VERSION === "ë¡œë”© ì¤‘...") return;

                const lastVersion = localStorage.getItem('cls_last_version');
                if (lastVersion !== CURRENT_VERSION) {
                    //setShowUpdateNotes(true);
                    localStorage.setItem('cls_last_version', CURRENT_VERSION);
                }
            }, [CURRENT_VERSION]);

            const [isRoleEditOpen, setIsRoleEditOpen] = useState(false);
            const [isGroupPanelOpen, setIsGroupPanelOpen] = useState(window.innerWidth >= 768);
            const [formationClickCount, setFormationClickCount] = useState(0);
            const [showAiHelp, setShowAiHelp] = useState(false);
            const formationClickTimer = useRef(null);
            const groupsRef = useRef(null);
            const draggedGroupItemRef = useRef(null);
            const [showWeeklyBriefing, setShowWeeklyBriefing] = useState(false);
            const [showBriefingHelp, setShowBriefingHelp] = useState(false);
            const [aiContent, setAiContent] = useState("");
            const [generationProgress, setGenerationProgress] = useState(0);
            const [briefingStart, setBriefingStart] = useState(dayjs().subtract(4, 'day').format('YYYY-MM-DD'));
            const [briefingEnd, setBriefingEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [briefingTone, setBriefingTone] = useState('encouraging');
            const briefingRef = useRef(null);
            const [showClassStory, setShowClassStory] = useState(false);
            const [showStoryHelp, setShowStoryHelp] = useState(false);
            const [storyGenre, setStoryGenre] = useState('school');
            const [isToolsOpen, setIsToolsOpen] = useState(false);
            const [showAvoidanceLines, setShowAvoidanceLines] = useState(false);
            const [focusedGroupIdx, setFocusedGroupIdx] = useState(null);
            const [showPartnerAnalysis, setShowPartnerAnalysis] = useState(false);
            const [expandedGroupCards, setExpandedGroupCards] = useState({});
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);
            const [isStandalone, setIsStandalone] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [showGlobalRecord, setShowGlobalRecord] = React.useState(false);
            const [showGroupResetModal, setShowGroupResetModal] = useState(false);
            const [aiCheckState, setAiCheckState] = useState({ isOpen: false, prompt: "", resolve: null, reject: null });
            const [hideRotationBanner, setHideRotationBanner] = useState(false);
            const [showAllRecords, setShowAllRecords] = useState(false);

            useEffect(() => {
                window.triggerAiSecurityCheck = (prompt) => {
                    return new Promise((resolve, reject) => {
                        setAiCheckState({ isOpen: true, prompt, resolve, reject });
                    });
                };
            }, []);

            const isRotationDay = useMemo(() => {
                const today = dayjs();
                const targetDay = appConfig.rotationDay !== undefined ? parseInt(appConfig.rotationDay) : 5;
                return targetDay !== -1 && today.day() === targetDay && date === today.format('YYYY-MM-DD');
            }, [appConfig.rotationDay, date]);

            const handleAiCheckConfirm = () => {
                if (aiCheckState.resolve) aiCheckState.resolve(true);
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            const handleAiCheckCancel = () => {
                if (aiCheckState.reject) aiCheckState.reject(new Error("ì‚¬ìš©ìžì— ì˜í•´ ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            // [New] Floating Button Drag Logic
            const [buttonPos, setButtonPos] = useState({ x: window.innerWidth - 80, y: window.innerHeight - 80 });
            const [isDraggingButton, setIsDraggingButton] = useState(false);
            const dragOffset = useRef({ x: 0, y: 0 });
            const isDragGesture = useRef(false);
            const [isButtonIdle, setIsButtonIdle] = useState(false);
            const buttonIdleTimer = useRef(null);
            const [isHidden, setIsHidden] = useState(false);
            const hideTimer = useRef(null);

            const resetButtonIdleTimer = () => {
                setIsButtonIdle(false);
                if (buttonIdleTimer.current) clearTimeout(buttonIdleTimer.current);
                buttonIdleTimer.current = setTimeout(() => setIsButtonIdle(true), 5000);
            };

            useEffect(() => {
                resetButtonIdleTimer();
                return () => clearTimeout(buttonIdleTimer.current);
            }, []);

            useEffect(() => {
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);
                
                if (appConfig.floatingButtonAutoHide === false) return;

                const scaleFactor = (appConfig.uiScale || 100) / 100;
                const screenWidth = window.innerWidth / scaleFactor;

                const isLeft = buttonPos.x < 40;
                const isRight = buttonPos.x > screenWidth - 96;

                if (isLeft || isRight) {
                    hideTimer.current = setTimeout(() => {
                        setIsHidden(true);
                    }, 3000);
                }
            }, [buttonPos, appConfig.floatingButtonAutoHide, appConfig.uiScale]);

            const handleButtonDragStart = (e) => {
                resetButtonIdleTimer();
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                dragOffset.current = { x: clientX - buttonPos.x, y: clientY - buttonPos.y };
                isDragGesture.current = false;
                const startX = clientX;
                const startY = clientY;
                
                // [New] Track current position for snap logic
                let currentX = buttonPos.x;
                let currentY = buttonPos.y;

                const handleMove = (moveEvent) => {
                    const moveX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const moveY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    
                    if (!isDragGesture.current) {
                        const dist = Math.hypot(moveX - startX, moveY - startY);
                        if (dist > 5) {
                            isDragGesture.current = true;
                            setIsDraggingButton(true);
                        }
                    }

                    if (isDragGesture.current) {
                        if (moveEvent.cancelable) moveEvent.preventDefault();
                        let newX = moveX - dragOffset.current.x;
                        let newY = moveY - dragOffset.current.y;
                        newX = Math.max(10, Math.min(window.innerWidth - 70, newX));
                        newY = Math.max(10, Math.min(window.innerHeight - 70, newY));
                        currentX = newX;
                        currentY = newY;
                        setButtonPos({ x: newX, y: newY });
                    }
                };

                const handleUp = () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleUp);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', handleUp);
                    setIsDraggingButton(false);
                    
                    if (isDragGesture.current) {
                        const screenWidth = window.innerWidth;
                        const btnSize = appConfig.floatingButtonSize || 'medium';
                        const radius = btnSize === 'small' ? 20 : btnSize === 'large' ? 32 : btnSize === 'xlarge' ? 40 : 28;
                        const btnCenter = currentX + radius;
                        const snapMargin = 24;
                        let finalX = currentX;
                        
                        if (window.innerWidth >= 768) {
                            // [Mod] ë°ìŠ¤í¬íƒ‘: ê°€ìž¥ìžë¦¬ ê·¼ì²˜(100px)ì— ê°”ì„ ë•Œë§Œ ìžì„ íš¨ê³¼ ì ìš©
                            const snapThreshold = 100;
                            if (currentX < snapThreshold) finalX = snapMargin;
                            else if (currentX > screenWidth - (radius * 2) - snapThreshold) finalX = screenWidth - (radius * 2) - snapMargin;
                            else {
                                setButtonPos({ x: currentX, y: currentY });
                                return; // ì¤‘ê°„ì— ë†“ìœ¼ë©´ ìžìœ  ë°°ì¹˜
                            }
                        } else {
                            // ëª¨ë°”ì¼: í•­ìƒ ê°€ìž¥ ê°€ê¹Œìš´ ë²½ìœ¼ë¡œ ì´ë™
                            if (btnCenter < screenWidth / 2) finalX = snapMargin;
                            else finalX = screenWidth - (radius * 2) - snapMargin;
                        }
                        
                        setButtonPos({ x: finalX, y: currentY });
                    }
                };

                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleUp);
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleUp);
            };

            // [Fix] onSnapshot ë‚´ë¶€ì—ì„œ ìµœì‹  students ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Ref
            const studentsRef = useRef(students);
            useEffect(() => { studentsRef.current = students; }, [students]);

            useEffect(() => {
                if (isLoading) {
                    const timer = setInterval(() => {
                        setLoadingProgress(prev => {
                            if (prev >= 95) return prev;
                            return prev + Math.random() * 5;
                        });
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [isLoading]);

            useEffect(() => {
                let timer;
                if (isLoading) {
                    timer = setTimeout(() => setShowLongLoading(true), 7000); // 7ì´ˆ í›„ ë²„íŠ¼ í‘œì‹œ
                }
                return () => clearTimeout(timer);
            }, [isLoading]);

            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                
                const userAgent = window.navigator.userAgent.toLowerCase();
                setIsIOS(/iphone|ipad|ipod/.test(userAgent));
                setIsStandalone(window.matchMedia('(display-mode: standalone)').matches);

                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallApp = () => {
                setShowInstallGuide(true);
            };

            const confirmInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') { setDeferredPrompt(null); setShowInstallGuide(false); }
                } else if (!isIOS) {
                    setToastMessage("ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆê±°ë‚˜ ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ìž…ë‹ˆë‹¤.");
                }
            };

            const handleGearClick = (e) => {
                e.stopPropagation();
                if (gearClickTimer.current) clearTimeout(gearClickTimer.current);
                const newCount = gearClickCount + 1;
                setGearClickCount(newCount);
                
                if (newCount >= 3) {
                    const newMode = !isDevMode;
                    setIsDevMode(newMode);
                    localStorage.setItem('cls_dev_mode', newMode);
                    setToastMessage(newMode ? "ê°œë°œìž ëª¨ë“œ ON: AI ì „ì†¡ ë‚´ìš©ì„ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." : "ê°œë°œìž ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setGearClickCount(0);
                } else {
                    gearClickTimer.current = setTimeout(() => setGearClickCount(0), 500);
                }
            };

            useEffect(() => {
                const updateIcons = async () => {
                    const defaultSvg = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“</text></svg>";
                    const iconSrc = appConfig.favicon || defaultSvg;
                    
                    // [Fix] ë¸Œë¼ìš°ì € ìºì‹œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ìž¬ìƒì„±
                    const existingFavicon = document.getElementById('app-favicon');
                    if (existingFavicon) existingFavicon.remove();
                    const newFavicon = document.createElement('link');
                    newFavicon.id = 'app-favicon';
                    newFavicon.rel = 'icon';
                    newFavicon.href = iconSrc;
                    document.head.appendChild(newFavicon);

                    // [iOS í˜¸í™˜ì„±] ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì„œ PNGë¡œ ë³€í™˜ (í°ìƒ‰ ë°°ê²½ ì¶”ê°€)
                    const getPngDataUrl = (src) => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = 192; canvas.height = 192;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = "#ffffff"; // iOSëŠ” íˆ¬ëª… ë°°ê²½ì„ ê²€ê²Œ ì²˜ë¦¬í•˜ë¯€ë¡œ í°ìƒ‰ ë°°ê²½ í•„ìˆ˜
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0, 192, 192);
                                resolve(canvas.toDataURL('image/png'));
                            };
                            img.onerror = () => resolve(src); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
                            img.src = src;
                        });
                    };

                    let pngIcon = iconSrc;
                    if (iconSrc.startsWith('data:image')) {
                        try { pngIcon = await getPngDataUrl(iconSrc); } catch (e) { console.error(e); }
                    }

                    // [Fix] ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ìž¬ìƒì„± (ë¸Œë¼ìš°ì € ì¸ì‹ ê°•ì œ)
            const existingAppleLinks = document.querySelectorAll('link[rel*="apple-touch-icon"]');
                    existingAppleLinks.forEach(el => el.remove());
                    const appleIconLink = document.createElement('link');
                    appleIconLink.rel = 'apple-touch-icon';
                    document.head.appendChild(appleIconLink);
                    appleIconLink.href = pngIcon;

                    const manifest = {
                        name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        short_name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        start_url: "./index.html",
                        display: "standalone",
                        background_color: "#ffffff",
                        theme_color: "#ffffff",
                        icons: [ { src: pngIcon, sizes: "192x192", type: "image/png" }, { src: pngIcon, sizes: "512x512", type: "image/png" } ]
                    };
                    
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    
                    const existingManifest = document.getElementById('app-manifest');
                    if (existingManifest) {
                        URL.revokeObjectURL(existingManifest.href);
                        existingManifest.remove();
                    }
                    const manifestLink = document.createElement('link');
                    manifestLink.id = 'app-manifest';
                    manifestLink.rel = 'manifest';
                    document.head.appendChild(manifestLink);
                    manifestLink.href = manifestURL;
                };
                updateIcons();
            }, [appConfig.favicon, appConfig.recordTitle]);

            // [Fix] ë¹„ë™ê¸° ë¡œì§(setTimeout) ë‚´ì—ì„œ ìµœì‹  ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Refs ì¶”ê°€
            const groupsByDateRef = useRef(groupsByDate);
            const groupRolesRef = useRef(groupRoles);
            useEffect(() => { groupsByDateRef.current = groupsByDate; }, [groupsByDate]);
            useEffect(() => { groupRolesRef.current = groupRoles; }, [groupRoles]);

            // [New] ë°ì´í„° ë³µêµ¬(Hydration) í•¨ìˆ˜: IDë§Œ ìžˆëŠ” ëª¨ë‘  ë°ì´í„°ì— í•™ìƒ ìƒì„¸ ì •ë³´ë¥¼ ì±„ì›Œë„£ìŒ
            const hydrateGroups = (groupsData, studentsList) => {
                if (!groupsData) return {};
                const newGroups = { ...groupsData }; // ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬
                Object.keys(groupsData).forEach(date => {
                    if (Array.isArray(groupsData[date])) {
                        newGroups[date] = groupsData[date].map(groupItem => {
                            // [Fix] Firestore Nested Array ì§€ì›: { list: [...] } í˜•íƒœë¼ë©´ ë°°ì—´ë¡œ ë³€í™˜
                            let group = groupItem;
                            if (!Array.isArray(groupItem) && groupItem && groupItem.list && Array.isArray(groupItem.list)) {
                                group = groupItem.list;
                            }
                            
                            if (!Array.isArray(group)) return []; // [Safety] ë°°ì—´ì´ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜í•˜ì—¬ ì•± ë©ˆì¶¤(Crash) ë°©ì§€

                            return group.map(s => {
                                const id = (typeof s === 'object' && s !== null) ? s.id : s;
                                // [Fix] ID íƒ€ìž… ë¶ˆì¼ì¹˜ ë°©ì§€ ë° ì´ë¦„ ë§¤ì¹­ Fallback ì¶”ê°€ (ë¬¸ìžì—´/ìˆ«ìž ë¹„êµ)
                                let fullStudent = studentsList.find(st => String(st.id) === String(id));
                                if (!fullStudent && typeof s === 'object' && s.name) {
                                    fullStudent = studentsList.find(st => st.name === s.name);
                                }
                                // [Fix] í•™ìƒ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°ì²´(s)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©, IDë§Œ ìžˆë‹¤ë©´ ê¸°ë³¸ ê°ì²´ ìƒì„±
                                return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                            });
                        });
                    }
                });
                return newGroups;
            };

            // [New] í•™ìƒ ê°œë³„ ë°ì´í„°(ìƒë‹´ê¸°ë¡, ì´ˆì•ˆ) ì €ìž¥ í•¨ìˆ˜
            const saveStudentDataToFirestore = async (studentId, data) => {
                if (isLocalMode || !db || !appId) return;
                try {
                    await db.collection('classes').doc(appId).collection('studentData').doc(String(studentId)).set(data, { merge: true });
                } catch (e) {
                    console.error("í•™ìƒ ê°œë³„ ë°ì´í„° ì €ìž¥ ì‹¤íŒ¨:", e);
                    logSystemEvent(`í•™ìƒ ë°ì´í„° ì €ìž¥ ì‹¤íŒ¨(${studentId}): ${e.message}`, 'error');
                    setToastMessage("ë°ì´í„° ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ìž¥ í•¨ìˆ˜ (1MB ì œí•œ íšŒí”¼ìš©)
            const saveGroupsToFirestore = async (groupsMap) => {
            if (isLocalMode || !db || !appId) return;
            const batch = db.batch();
            Object.entries(groupsMap).forEach(([date, groups]) => {
                const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                // ðŸŒŸ Firestore ì¤‘ì²© ë°°ì—´(Nested Array) ì—ëŸ¬ ë°©ì§€: ì•ˆìª½ ë°°ì—´ì„ { list: [...] } í˜•íƒœë¡œ ê°ì‹¸ì¤ë‹ˆë‹¤!
                const cleanGroups = groups.map(g => ({
                    list: g.map(s => ({ id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order }))
                }));
                batch.set(ref, { list: cleanGroups });
            });
            try {
                await batch.commit();
            } catch (e) {
                console.error(e);
                setToastMessage("ëª¨ë‘  ì €ìž¥ ì‹¤íŒ¨: " + e.message);
            }
        };
            
            // [New] ê³¼ì œ ë°ì´í„°(Daily, Weekly, Tags) ì €ìž¥ í•¨ìˆ˜
            const saveTasksToFirestore = async (data) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                
                if (data.dailyTasks) {
                    Object.entries(data.dailyTasks).forEach(([date, tasks]) => {
                        const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                        batch.set(ref, { list: tasks }); // Overwrite list for that date
                    });
                }
                
                if (data.weeklyTasks) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { weekly: data.weeklyTasks }, { merge: true });
                }
                if (data.tags) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { tags: data.tags }, { merge: true });
                }

                try { await batch.commit(); } 
                catch (e) { console.error(e); setToastMessage("ê³¼ì œ ì €ìž¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ìž¥ í•¨ìˆ˜
            const saveRecordsToFirestore = async (recordsMap) => {
                if (isLocalMode || !db || !appId) return;
                const entries = Object.entries(recordsMap);
                const chunkSize = 450; // Firestore ë°°ì¹˜ ì œí•œ(500) ê³ ë ¤
                try {
                    for (let i = 0; i < entries.length; i += chunkSize) {
                        const batch = db.batch();
                        const chunk = entries.slice(i, i + chunkSize);
                        chunk.forEach(([date, data]) => {
                            const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                            batch.set(ref, data);
                        });
                        await batch.commit();
                    }
                } catch (e) { console.error(e); setToastMessage("ê¸°ë¡ ì €ìž¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteRecordsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteGroupsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); }
                catch (e) { console.error(e); }
            };
            
            // [New] ê³¼ì œ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
            const deleteTasksFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            const handleRangeSelect = (start, end) => {
                setDate(start);
                const diff = dayjs(end).diff(dayjs(start), 'day') + 1;
                setGroupDuration(diff);
            };

            useEffect(() => {
                // Mobile Drag Drop Polyfill Init
                if (window.MobileDragDrop) {
                    window.MobileDragDrop.polyfill({ dragImageTranslateOverride: window.MobileDragDrop.scrollBehaviourDragImageTranslateOverride });
                }
            }, []);

            useEffect(() => { setAiReason(null); setFocusedGroupIdx(null); }, [date]);
// ðŸ“¸ ImgBB ì‚¬ì§„ ì—…ë¡œë“œ í•¨ìˆ˜ (ì„ ìƒë‹˜ ì½”ë“œ ë§žì¶¤í˜•)
    const handlePhotoUpload = async (event, studentId) => {
        const imageFile = event.target.files[0];
        if (!imageFile) return;

        if (!imgbbApiKey) {
            alert("ì‚¬ì§„ì„ ì €ìž¥í•˜ë ¤ë©´ ë¨¼ì € ImgBB API í‚¤ë¥¼ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. ì„¤ì • ì°½ì„ ë„ì›Œë“œë¦´ê²Œìš”!");
            setTempImgbbKey("");
            setShowImgbbModal(true);
            return;
        }

        try {
            const formData = new FormData();
            formData.append("image", imageFile);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: "POST",
                body: formData,
            });
            const data = await response.json();

            if (data.success) {
                const photoURL = data.data.url;
                
                // 1. í™”ë©´ì˜ í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
                const updatedStudents = students.map(s => 
                    s.id === studentId ? { ...s, photoUrl: photoURL } : s
                );
                setStudents(updatedStudents);
                
                // 2. ì„ ìƒë‹˜ì˜ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì €ìž¥ (ë¡œì»¬ + Firebase)
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode && typeof saveStudentDataToFirestore === 'function') {
                    saveStudentDataToFirestore(studentId, { photoUrl: photoURL });
                }
                
                setToastMessage("ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ðŸŽ‰");
            } else {
                throw new Error("ImgBB ì—…ë¡œë“œ ì‹¤íŒ¨");
            }
        } catch (error) {
            console.error("ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
            alert("ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ê°€ ìž˜ëª»ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
    };
            const handleSaveCounseling = (studentId, note, msg) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage(msg || "ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveStickers = (studentId, count) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
            };

            const validateApiKey = async () => {
                if (!apiKey) return setToastMessage("API í‚¤ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if (response.ok) {
                        setIsApiKeyValid(true);
                        setToastMessage(`ìœ íš¨í•œ API í‚¤ìž…ë‹ˆë‹¤. (${GEMINI_MODEL_NAME})`);
                        logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì„±ê³µ (${GEMINI_MODEL_NAME})`);
                    } else {
                        setIsApiKeyValid(false);
                        const data = await response.json();
                        setToastMessage("í‚¤ ì˜¤ë¥˜: " + (data.error?.message || "ì•Œ ìˆ˜ ì—†ìŒ"));
                    }
                } catch (e) {
                    setIsApiKeyValid(false);
                    logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì˜¤ë¥˜: " + e.message);
                }
            };

            const callGemini = async (apiKey, prompt) => {
                if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || response.statusText);
                    updateAiUsage();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) {
                    logSystemEvent(`AI ìš”ì²­ ì‹¤íŒ¨: ${e.message}`, 'error');
                    throw new Error("AI ìš”ì²­ ì‹¤íŒ¨: " + e.message);
                }
            };

            const handleDownloadGroupsImage = async () => {
                if (!groupsRef.current) return;
                const originalBtnText = isGenerating; 
                setIsGenerating(true); 
                try {
                    const canvas = await window.html2canvas(groupsRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `ëª¨ë‘ íŽ¸ì„±_${dayjs(date).format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setToastMessage("ëª¨ë‘  íŽ¸ì„± ê²°ê³¼ê°€ ì´ë¯¸ì§€ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ëª¨ë‘  íŽ¸ì„± ì´ë¯¸ì§€ ì €ìž¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì´ë¯¸ì§€ ì €ìž¥ ì‹¤íŒ¨: " + e.message); 
                } 
                finally { setIsGenerating(false); }
            };

        const handleCopyAiReport = () => {
            if (!aiReason) return;
            navigator.clipboard.writeText(aiReason);
            setToastMessage("ë¦¬í¬íŠ¸ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        const handleSaveAiReport = () => {
            if (!aiReason) return;
            const blob = new Blob([aiReason], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `AI_ëª¨ë‘ íŽ¸ì„±_ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.txt`;
            link.click();
            setToastMessage("ë¦¬í¬íŠ¸ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

            const handleExportDrafts = () => {
                logSystemEvent('ì´í‰ ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸° ì‹œë„');
                let content = "";
                let count = 0;
                const sortedStudents = [...students].sort((a, b) => a.order - b.order);

                sortedStudents.forEach(s => {
                    if (s.recordDrafts && Object.keys(s.recordDrafts).length > 0) {
                        content += `##################################################\n`;
                        content += `# ${s.order}ë²ˆ ${s.name}\n`;
                        content += `##################################################\n\n`;
                        
                        const drafts = Object.entries(s.recordDrafts).sort((a, b) => a[0].localeCompare(b[0]));
                        
                        drafts.forEach(([key, text]) => {
                            if (!text) return;
                            const [type, semester] = key.split('_');
                            let typeName = type;
                            if (type === 'behavior') typeName = 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬';
                            else if (type === 'subject') typeName = 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©';
                            
                            const semesterName = semester === 'all' ? 'ì „ì²´' : `${semester}í•™ê¸°`;
                            
                            content += `[${typeName} - ${semesterName}]\n`;
                            content += `${text}\n\n`;
                            content += `--------------------------------------------------\n\n`;
                        });
                        content += `\n`;
                        count++;
                    }
                });

                if (count === 0) {
                    setToastMessage("ì €ìž¥ëœ í–‰ë°œ ì´ˆì•ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `ì´í‰ì´ˆì•ˆ_ì¼ê´„ë‚´ë³´ë‚´ê¸°_${dayjs().format('YYYYMMDD')}.txt`;
                link.click();
                setToastMessage(`${count}ëª…ì˜ ì´ˆì•ˆì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ìž¥í–ˆìŠµë‹ˆë‹¤.`);
            };

            const handleSaveStickerWithNote = (studentId, count, note) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage("ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRecordDraft = (studentId, draftKey, draftText) => {
                const updatedStudents = students.map(s => {
                    if (s.id === studentId) {
                        const newDrafts = { ...(s.recordDrafts || {}), [draftKey]: draftText };
                        return { ...s, recordDrafts: newDrafts };
                    }
                    return s;
                });
                setStudents(updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { recordDrafts: updatedStudents.find(s=>s.id===studentId).recordDrafts });
                setToastMessage("ì´ˆì•ˆì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const exportData = useCallback(() => { const data = { version: appConfig.version, date: dayjs().format('YYYY-MM-DD HH:mm:ss'), students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Checklist_Backup_${dayjs().format('YYYYMMDD_HHmm')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); setToastMessage("ìžë™ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig]);
            
            useEffect(() => { const checkTime = () => { const isEnabled = localStorage.getItem('cls_auto_backup') === 'true'; if (!isEnabled) return; const now = dayjs(); const nowStr = now.format('HH:mm'); if (backupTimes.includes(nowStr) && lastBackupTime.current !== nowStr) { lastBackupTime.current = nowStr; exportData(); } }; const interval = setInterval(checkTime, 10000); return () => clearInterval(interval); }, [exportData, backupTimes]);
            
            const handleGrassTitleClick = () => {
                setToastMessage("í™œë™ ìž”ë””ìž…ë‹ˆë‹¤.");
            };

            // [New] ëª¨ë‘  ë°ì´í„° ì‹¤ì‹œê°„ ë³µêµ¬ (Hydration) ë° ë™ê¸°í™”
            const groups = useMemo(() => {
                const currentGroups = groupsByDate[date] || [];
                if (!Array.isArray(currentGroups)) return [];
                
                return currentGroups.map(group => {
                    if (!Array.isArray(group)) return [];
                    return group.map(s => {
                        if (!s) return null;
                        // í•™ìƒ ëª©ë¡ì—ì„œ ìµœì‹  ì •ë³´ ì°¾ê¸° (ID ê¸°ë°˜ ë§¤í•‘)
                        const id = (typeof s === 'object') ? s.id : s;
                        // [Fix] í™”ë©´ í‘œì‹œ ì‹œì—ë„ ID íƒ€ìž… ë¶ˆì¼ì¹˜ ë°©ì§€
                        let fullStudent = students.find(st => String(st.id) === String(id));
                        if (!fullStudent && typeof s === 'object' && s.name) {
                            fullStudent = students.find(st => st.name === s.name);
                        }
                        // ìµœì‹  ì •ë³´ê°€ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ì •ë³´ ì‚¬ìš©í•˜ë˜ í•„ìˆ˜ í•„ë“œ ê¸°ë³¸ê°’ ë³´ìž¥
                        return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                    }).filter(s => s !== null);
                });
            }, [groupsByDate, date, students]);

            const progress = students.length ? (students.filter(s => records[date]?.[s.id]?.done).length / students.length) * 100 : 0;
            const classAvgSkill = useMemo(() => students.length > 0 ? students.reduce((a, s) => a + s.skill, 0) / students.length : 0, [students]);
            const openConfirm = (message, onConfirm, onCancel = null) => { setConfirmModal({ isOpen: true, message: message, onConfirm: onConfirm, onCancel: onCancel }); };

           useEffect(() => {
                const savedConfig = safeLocalStorage.getItem('checklist_config');
                
                // [New] ìºì‹œ ìš°ì„  ë¡œë”© (Offline-First): ë¡œì»¬ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì„œ ë¡œë”© í™”ë©´ ì¦‰ì‹œ ì œê±°
                const ls = (k) => safeLocalStorage.getItem(k);
                try {
                    if (ls('cls_students')) setStudents(JSON.parse(ls('cls_students')));
                    if (ls('cls_records')) setRecords(JSON.parse(ls('cls_records')));
                    if (ls('cls_groups_date')) setGroupsByDate(JSON.parse(ls('cls_groups_date')));
                    if (ls('cls_avoidance')) setAvoidancePairs(JSON.parse(ls('cls_avoidance')));
                    if (ls('cls_mustPairs')) setMustPairs(JSON.parse(ls('cls_mustPairs')) || []);
                    if (ls('cls_app_config')) setAppConfig({ ...JSON.parse(ls('cls_app_config')), version: CURRENT_VERSION });
                    if (ls('cls_daily_tasks')) setDailyTasks(JSON.parse(ls('cls_daily_tasks')));
                    if (ls('cls_weekly_tasks')) setWeeklyTasks(JSON.parse(ls('cls_weekly_tasks')));
                    if (ls('cls_tags')) setTags(JSON.parse(ls('cls_tags')));
                    if (ls('cls_group_names')) setGroupNames(JSON.parse(ls('cls_group_names')));
                    if (ls('cls_group_roles')) setGroupRoles(JSON.parse(ls('cls_group_roles')));
                    if (ls('cls_roles_list')) setRolesList(JSON.parse(ls('cls_roles_list')));
                    if (ls('cls_role_descriptions')) setRoleDescriptions(JSON.parse(ls('cls_role_descriptions')));
                    if (ls('cls_seat_assignments')) setSeatAssignments(JSON.parse(ls('cls_seat_assignments')));
                    if (ls('cls_seat_config')) setSeatConfig(JSON.parse(ls('cls_seat_config')));
                    if (ls('cls_ai_key')) setApiKey(ls('cls_ai_key'));
                } catch (e) { console.error("Cache load error", e); }
                
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        
                        const firestore = firebase.firestore();
                        setDb(firestore);
                        setAppId(config.projectId);
                        setIsLocalMode(false);

                        logSystemEvent(`Firebase ì—°ê²° ì‹œë„: ${config.projectId}`);
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                logSystemEvent(`Firebase ë¡œê·¸ì¸ ì„±ê³µ: ${user.email}`);
                                firestore.collection('artifacts').doc(config.projectId).collection('public').doc('data').onSnapshot(doc => {
                                    if (doc.exists) {
                                        const d = doc.data();
                                        if (d.students) setStudents(d.students);
                                        if (d.records) setRecords(prev => ({ ...d.records, ...prev })); // [Fix] ë©”ì¸ ë¬¸ì„œ ê¸°ë¡ì€ í•˜ìœ„ í˜¸í™˜ìš©ìœ¼ë¡œ ë¡œë“œí•˜ë˜, ë¡œì»¬/í•˜ìœ„ì»¬ë ‰ì…˜ ë°ì´í„° ìš°ì„ 
                                        if (d.groupsByDate) {
                                            // [Fix] d.studentsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìžˆì„ ê²½ìš° ë¡œì»¬ ìµœì‹  ìƒíƒœ(studentsRef)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µêµ¬ ì‹œë„
                                            // ë¡œì»¬ ìƒíƒœì™€ ì„œë²„ ìƒíƒœë¥¼ ë³‘í•©í•˜ì—¬ ìµœëŒ€í•œ ë§Žì€ í•™ìƒ ì •ë³´ë¥¼ í™•ë³´
                                            const serverStudents = d.students || [];
                                            const localStudents = studentsRef.current || [];
                                            const mergedStudents = [...localStudents];
                                            serverStudents.forEach(s => {
                                                if (!mergedStudents.find(ls => String(ls.id) === String(s.id))) {
                                                    mergedStudents.push(s);
                                                }
                                            });

                                            // [Fix] ëª¨ë‘  ë°ì´í„° ë™ê¸°í™” ì‹œ ë¡œì»¬ ë°ì´í„° ìœ ì‹¤ ë°©ì§€ (ë°©ê¸ˆ ìƒì„±í•œ ë°ì´í„° ë³´í˜¸)
                                            const serverGroups = d.groupsByDate || {};
                                            const localGroups = groupsByDateRef.current || {};
                                            const mergedGroups = { ...serverGroups };

                                            // ë¡œì»¬ì—ë§Œ ìžˆê³  ì„œë²„ì— ì—†ëŠ”(ë¹„ì–´ìžˆëŠ”) ë‚ ì§œì˜ ë°ì´í„°ëŠ” ë¡œì»¬ ë°ì´í„° ìœ ì§€ (ë°©ê¸ˆ íŽ¸ì„±í•œ ê²½ìš°)
                                            Object.keys(localGroups).forEach(date => {
                                                if (localGroups[date] && localGroups[date].length > 0) {
                                                    // ì„œë²„ ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜ ë¹ˆ ë°°ì—´ì¸ ê²½ìš° ë¡œì»¬ ë°ì´í„° ì‚¬ìš©
                                                    if (!serverGroups[date] || serverGroups[date].length === 0) {
                                                        mergedGroups[date] = localGroups[date];
                                                    }
                                                }
                                            });

                                            const hydrated = hydrateGroups(mergedGroups, mergedStudents);
                                            setGroupsByDate(hydrated);
                                        }
                                        if (d.avoidance) setAvoidancePairs(d.avoidance);
                                        if (d.mustPairs) setMustPairs(d.mustPairs);
                    if (d.config) setAppConfig({ ...d.config, version: CURRENT_VERSION });
                                        if (d.dailyTasks) setDailyTasks(d.dailyTasks);
                                        if (d.weeklyTasks) setWeeklyTasks(d.weeklyTasks);
                                        if (d.tags) setTags(d.tags);
                                        if (d.groupNames) setGroupNames(d.groupNames);
                                        if (d.groupRoles) setGroupRoles(d.groupRoles);
                                        if (d.rolesList) setRolesList(d.rolesList);

                                        // [New] AI Key ë° Notion ì„¤ì • ìžë™ ë™ê¸°í™”
                                        if (d.aiKey) {
                                            setApiKey(d.aiKey);
                                            localStorage.setItem('cls_ai_key', d.aiKey);
                                        }
                                        if (d.notionKey) localStorage.setItem('cls_notion_key', d.notionKey);
                                        if (d.notionDbId) localStorage.setItem('cls_notion_db_id', d.notionDbId);
                                        // [Fix] snake_case í‚¤ ì§€ì› ë° í¬íŠ¸í´ë¦¬ì˜¤ ID ë¡œë”©
                                        if (d.notion_key) localStorage.setItem('cls_notion_key', d.notion_key);
                                        if (d.notion_db_id) localStorage.setItem('cls_notion_db_id', d.notion_db_id);
                                        if (d.notion_portfolio_db_id) { localStorage.setItem('cls_notion_portfolio_db_id', d.notion_portfolio_db_id); setPortfolioDbId(d.notion_portfolio_db_id); }
                                        if (d.studentMap) { setStudentMap(d.studentMap); localStorage.setItem('cls_student_map', JSON.stringify(d.studentMap)); }
                                        if (d.portfolio_mode !== undefined) { 
                                            setIsPortfolioMode(d.portfolio_mode); 
                                            localStorage.setItem('cls_portfolio_mode', d.portfolio_mode); 
                                        }
                                        
                                        // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                                        setIsLoading(false);
                                        if (!localStorage.getItem('cls_intro_shown')) {
                                            setShowOfflineModal(true);
                                            setAutoCloseTimer(3);
                                            localStorage.setItem('cls_intro_shown', 'true');
                                        }
                                    } else {
                                        // [Fix] ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš°ì—ë„ ë¡œë”© í•´ì œ (ë¬´í•œ ë¡œë”© ë°©ì§€)
                                        setIsLoading(false);
                                    }
                                }, (error) => {
                                    logSystemEvent(`Firestore ìŠ¤ëƒ…ìƒ· ì—ëŸ¬: ${error.message}`, 'error');
                                    setIsLoading(false); // [Fix] ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© í•´ì œ
                                    setToastMessage("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: " + error.message);
                                });

                                // [New] ëª¨ë‘  ê²°ê³¼ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('groupResults').onSnapshot(snapshot => {
                                    const newGroups = {};
                                    snapshot.docs.forEach(doc => {
                                        newGroups[doc.id] = doc.data().list;
                                    });
                                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì„œë²„ ë°ì´í„° ìš°ì„ )
                                    setGroupsByDate(prev => hydrateGroups({ ...prev, ...newGroups }, studentsRef.current));
                                });

                                // [New] í™œë™ ê¸°ë¡ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('records').onSnapshot(snapshot => {
                                    setRecords(prev => {
                                        const next = { ...prev };
                                        snapshot.docChanges().forEach(change => {
                                            if (change.type === 'added' || change.type === 'modified') next[change.doc.id] = change.doc.data();
                                            if (change.type === 'removed') delete next[change.doc.id];
                                        });
                                        return next;
                                    });
                                });
                                
                                // [New] ê³¼ì œ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
                                firestore.collection('classes').doc(config.projectId).collection('tasks').onSnapshot(snapshot => {
                                    snapshot.docChanges().forEach(change => {
                                        if (change.doc.id === 'settings') {
                                            const data = change.doc.data();
                                            if (data.weekly) setWeeklyTasks(data.weekly);
                                            if (data.tags) setTags(data.tags);
                                        } else {
                                            if (change.type === 'removed') {
                                                setDailyTasks(prev => {
                                                    const next = { ...prev };
                                                    delete next[change.doc.id];
                                                    return next;
                                                });
                                            } else {
                                                setDailyTasks(prev => ({ ...prev, [change.doc.id]: change.doc.data().list }));
                                            }
                                        }
                                    });
                                });
                            } else {
                                logSystemEvent('Firebase ë¡œê·¸ì¸ ìƒíƒœ ì•„ë‹˜', 'warning');
                                setIsLoading(false);
                            }
                        });
                    } catch (e) { logSystemEvent(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${e.message}`, 'error'); setIsLocalMode(true); setIsLoading(false); }
                } else {
                    // ë¡œì»¬ ëª¨ë“œ (ìœ„ì—ì„œ ì´ë¯¸ ë¡œë“œí•¨)
                    
                    // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                    setIsLoading(false);
                    if (!localStorage.getItem('cls_intro_shown')) {
                        setShowOfflineModal(true);
                        setAutoCloseTimer(3);
                        localStorage.setItem('cls_intro_shown', 'true');
                    }
                }
            }, []);

            useEffect(() => {
                let timer;
                if (showOfflineModal && autoCloseTimer > 0) {
                    timer = setTimeout(() => setAutoCloseTimer(p => p - 1), 1000);
                } else if (showOfflineModal && autoCloseTimer === 0) {
                    setShowOfflineModal(false);
                }
                return () => clearTimeout(timer);
            }, [showOfflineModal, autoCloseTimer]);
            
            useEffect(() => { if (mode === 'record') { const dayOfWeek = dayjs(date).day(); if ((!dailyTasks[date] || dailyTasks[date].length === 0) && weeklyTasks[dayOfWeek]?.length > 0) { const tasksToAdd = weeklyTasks[dayOfWeek].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t); const newDailyTasks = { ...dailyTasks, [date]: tasksToAdd }; setDailyTasks(newDailyTasks); if (isLocalMode) saveData('cls_daily_tasks', newDailyTasks); } } }, [date, mode, weeklyTasks]);
            
            // [Fix] saveData í•¨ìˆ˜ ê°œì„ : ë‹¨ì¼ í‚¤/ê°’ ì €ìž¥ë¿ë§Œ ì•„ë‹ˆë¼ ê°ì²´ í˜•íƒœì˜ ì¼ê´„ ì €ìž¥(Batch) ì§€ì›
            const saveData = async (keyOrData, value) => {
                const updates = (typeof keyOrData === 'object') ? keyOrData : { [keyOrData]: value };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì—¬ë„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í•­ìƒ ìºì‹œ(ë°±ì—…) ì €ìž¥ (ë¹ ë¥¸ ë¡œë”© ë° ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
                Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));

                if (isLocalMode) {
                    Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));
                    return;
                }
                
                if (db && appId) {
                    try {
                        const payload = {};
                        const batch = db.batch(); // ë°°ì¹˜ ì“°ê¸° ì‚¬ìš©
                        
                        for (const [k, v] of Object.entries(updates)) {
                            if (k === 'cls_groups_date') continue; // [New] ëª¨ë‘  ë°ì´í„°ëŠ” ë©”ì¸ ë¬¸ì„œì—ì„œ ì œì™¸ (1MB ì œí•œ íšŒí”¼)
                            if (k === 'cls_records') { saveRecordsToFirestore(v); continue; } // [New] ê¸°ë¡ ë°ì´í„°ëŠ” í•˜ìœ„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë¶„ë¦¬
                            if (k === 'cls_daily_tasks') { saveTasksToFirestore({ dailyTasks: v }); continue; } // [New] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬
                            if (k === 'cls_weekly_tasks') { saveTasksToFirestore({ weeklyTasks: v }); continue; }
                            if (k === 'cls_tags') { saveTasksToFirestore({ tags: v }); continue; }
                            if (k === 'cls_student_map') { payload['studentMap'] = JSON.parse(JSON.stringify(v)); continue; }
                            const field = k.replace('cls_', '').replace('app_', '').replace('_date', 'ByDate');
                            const cleanData = JSON.parse(JSON.stringify(v));
                            
                            // [Fix] Firestore Nested Array ì˜¤ë¥˜ í•´ê²°: ëª¨ë‘  ë°ì´í„° ì €ìž¥ ì‹œ ë‚´ë¶€ ë°°ì—´ì„ ê°ì²´ë¡œ ëž˜í•‘
                            if (k === 'cls_groups_date') {
                                const wrappedData = {};
                                Object.keys(cleanData).forEach(d => {
                                    if (Array.isArray(cleanData[d])) {
                                        // [[s1, s2], [s3]] -> [{list: [s1, s2]}, {list: [s3]}]
                                        wrappedData[d] = cleanData[d].map(g => (Array.isArray(g) ? { list: g } : g));
                                    } else {
                                        wrappedData[d] = cleanData[d];
                                    }
                                });
                                payload[field] = wrappedData;
                            } else if (k === 'cls_students') {
                                // [New] í•™ìƒ ë°ì´í„° ì €ìž¥ ì‹œ ìƒë‹´ê¸°ë¡/ì´ˆì•ˆ ë¶„ë¦¬ ì €ìž¥ (ìš©ëŸ‰ ìµœì í™”)
                                const lightStudents = cleanData.map(s => {
                                    // ìƒë‹´ ê¸°ë¡ê³¼ ì´ˆì•ˆì´ ìžˆë‹¤ë©´ ê°œë³„ ë¬¸ì„œë¡œ ì €ìž¥
                                    if ((s.counseling && s.counseling.length > 0) || (s.recordDrafts && Object.keys(s.recordDrafts).length > 0)) {
                                        const studentRef = db.collection('classes').doc(appId).collection('studentData').doc(String(s.id));
                                        const studentData = {};
                                        if (s.counseling) studentData.counseling = s.counseling;
                                        if (s.recordDrafts) studentData.recordDrafts = s.recordDrafts;
                                        batch.set(studentRef, studentData, { merge: true });
                                    }
                                    // ë©”ì¸ ë¬¸ì„œì—ëŠ” ë¬´ê±°ìš´ ë°ì´í„° ì œì™¸
                                    const { counseling, recordDrafts, ...rest } = s;
                                    return rest;
                                });
                                payload[field] = lightStudents;
                            } else {
                                payload[field] = cleanData;
                            }
                        }
                        // ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ í•œ ë²ˆì— ì €ìž¥ (Atomic Update)
                        const mainRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                        batch.set(mainRef, payload, { merge: true });
                        await batch.commit();
                    } catch (e) {
                        logSystemEvent(`Firebase ì €ìž¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                        console.error(e);
                        setToastMessage(`ì €ìž¥ ì‹¤íŒ¨: ${e.message}`);
                    }
                }
            };
            
            const useDeepEffect = (fn, deps) => { const isFirst = useRef(true);
            useEffect(() => { if (isFirst.current) { isFirst.current = false; return; } fn(); }, deps); };
            
            useDeepEffect(() => { if (isLocalMode) saveData('cls_groups_date', groupsByDate); }, [groupsByDate]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_students', students); }, [students]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_records', records); }, [records]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_avoidance', avoidancePairs); }, [avoidancePairs]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_mustPairs', mustPairs); }, [mustPairs]); 
            useDeepEffect(() => { if (isLocalMode) saveData('cls_app_config', appConfig); }, [appConfig]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_daily_tasks', dailyTasks); }, [dailyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_weekly_tasks', weeklyTasks); }, [weeklyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_names', groupNames); }, [groupNames]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_roles', groupRoles); }, [groupRoles]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_roles_list', rolesList); }, [rolesList]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_role_descriptions', roleDescriptions); }, [roleDescriptions]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_assignments', seatAssignments); }, [seatAssignments]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_config', seatConfig); }, [seatConfig]);

            const toggleCheck = (id, taskIndex = null) => { 
                if (navigator.vibrate) navigator.vibrate(15);

                if (mode === 'simple') { const newDone = !simpleChecks[id];
            setSimpleChecks({ ...simpleChecks, [id]: newDone }); if (newDone) confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#6366f1', '#8b5cf6'] });
            return; } const currentRec = records[date]?.[id] || { done: false, tasks: {} }; const currentTasks = dailyTasks[date] || [];
            let newRec; if (taskIndex !== null) { const newTasksStatus = { ...currentRec.tasks, [taskIndex]: !currentRec.tasks?.[taskIndex] };
            const allDone = currentTasks.length > 0 && currentTasks.every((_, idx) => newTasksStatus[idx]); newRec = { ...currentRec, tasks: newTasksStatus, done: allDone };
            } else { const newDone = !currentRec.done; const newTasksStatus = {};
            if (currentTasks.length > 0) currentTasks.forEach((_, idx) => newTasksStatus[idx] = newDone); newRec = { ...currentRec, done: newDone, tasks: newTasksStatus };
            } const newRecords = { ...records, [date]: { ...records[date], [id]: newRec } }; setRecords(newRecords); if (!isLocalMode) saveRecordsToFirestore({ [date]: newRecords[date] });
            if (newRec.done) confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } }); };
            
            const resetDateRecord = () => { openConfirm(`${date} ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => { const newRecords = { ...records }; delete newRecords[date]; setRecords(newRecords); if (!isLocalMode) deleteRecordsFromFirestore([date]); setToastMessage("ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); });
            };
            
            const toggleLock = (studentId) => { setLockedIds(prev => prev.includes(studentId) ? prev.filter(id => id !== studentId) : [...prev, studentId]); };
            
            const applyPreset = (type) => {
                if (type === 'coop') { 
                    setUseGender(true);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'peer') { 
                    setUseGender(false);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                } else if (type === 'project') { 
                    setUseGender(true);
                    setUseSkill(false); setUseLeader(true); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'random') { 
                    setUseGender(false);
                    setUseSkill(false); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                }
                setToastMessage(`'${type === 'coop' ? 'í˜‘ë™ í•™ìŠµ' : type === 'peer' ? 'ë˜ëž˜ êµìˆ˜' : type === 'project' ? 'í”„ë¡œì íŠ¸' : 'ëžœë¤'}' í”„ë¦¬ì…‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            // [New] ì—­í•  ê³„ì‚° í—¬í¼ í•¨ìˆ˜
            const calculateRoles = (groupsToAssign) => {
                const activeRoles = rolesList.length > 0 ? rolesList : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                const rolesForDate = {};
                groupsToAssign.forEach((group, gIdx) => {
                    rolesForDate[gIdx] = {};
                    for (let sIdx = 0; sIdx < group.length; sIdx++) {
                        const myRoles = [];
                        activeRoles.forEach((r, rIdx) => { 
                            if (rIdx % group.length === sIdx) myRoles.push(r); 
                        });
                        rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                    }
                });
                return rolesForDate;
            };

            // [New] ëª¨ë‘  ë³€ê²½ ì‹œ ì—­í•  ì—…ë°ì´íŠ¸ í—¬í¼
            const updateRolesIfActive = (newGroups) => {
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                }
            };

            // [New] ëª¨ë‘  ê²°ê³¼ë¥¼ ìžë¦¬ ë°°ì¹˜ì— ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
            const syncSeatsWithGroups = (groupsToSync) => {
                try {
                    const newAssignments = {};
                    if (!groupsToSync || !Array.isArray(groupsToSync)) return;
                    const flatStudents = groupsToSync.flat().filter(s => s && s.id);
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                } catch (e) {
                    console.error("Sync seats error:", e);
                    setToastMessage("ìžë¦¬ ë°°ì¹˜ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜: " + e.message);
                }
            };

            const sanitizeStudent = (s) => {
                if (!s) return null;
                return { id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order };
            };
            
            const generateGroups = async () => {
                if (students.length === 0) return setToastMessage("í•™ìƒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");

                if (useAI) {
                    if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                    setIsGenerating(true);
                    try {
                        const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(students.length / groupNumber);
                        
                        // [ë³´ì•ˆ] í•™ìƒ ëª…ë‹¨ ìµëª…í™” (í•™ìƒ1, í•™ìƒ2...)
                        const anonymizedMap = {};
                        const studentListStr = students.map((s, i) => {
                            const anonName = `í•™ìƒ${i+1}`;
                            anonymizedMap[anonName] = s;
                            const info = [`${s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}`, `ì‹¤ë ¥${['í•˜','ì¤‘','ìƒ'][s.skill-1]}`];
                            if (s.leader) info.push('ë¦¬ë”');
                            return `${anonName}(${info.join(', ')})`;
                        }).join(', ');

                        const constraints = [];
                        if (avoidancePairs.length > 0) {
                            const avoidStr = avoidancePairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (avoidStr) constraints.push(`- ê¸°í”¼ ê´€ê³„(ê°™ì€ ëª¨ë‘  ê¸ˆì§€): ${avoidStr}`);
                        }
                        if (mustPairs.length > 0) {
                            const mustStr = mustPairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (mustStr) constraints.push(`- í•„ìˆ˜ ì§ê¿(ê°™ì€ ëª¨ë‘  í•„ìˆ˜): ${mustStr}`);
                        }
                        
                        // [New] useHistory ì˜µì…˜ ì ìš©
                        if (useHistory) {
                            const recentDates = Object.keys(groupsByDate).sort().reverse().slice(0, historyDuration);
                            if (recentDates.length > 0) {
                                const historyStr = recentDates.map(d => {
                                    const grps = groupsByDate[d] || [];
                                    return `- ${d}: ${grps.map(g => `[${g.map(s => {
                                        const idx = students.findIndex(st => st.id === s.id);
                                        return idx >= 0 ? `í•™ìƒ${idx+1}` : "ë¯¸í™•ì¸";
                                    }).join(',')}]`).join(', ')}`;
                                }).join('\n');
                                constraints.push(`- ì´ì „ ëª¨ë‘  êµ¬ì„±ê³¼ ìµœëŒ€í•œ ê²¹ì¹˜ì§€ ì•Šê²Œ íŽ¸ì„±í•´ì£¼ì„¸ìš” (ìµœê·¼ ê¸°ë¡ ì°¸ê³ ):\n${historyStr}`);
                            }
                        }
                        if (useRecentAvoid) constraints.push("- ì§ì „ ëª¨ë‘ ì—ì„œ ê°™ì€ ì¡°ì˜€ë˜ í•™ìƒë“¤ì€ ê°€ê¸‰ì  ë–¨ì–´ëœ¨ë ¤ ì£¼ì„¸ìš”.");
                        
                        const userRequest = aiPrompt || "ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”ë¥¼ ê³¨ê³ ë£¨ ì„žì–´ì„œ ê· í˜• ìžˆê²Œ íŽ¸ì„±í•´ì¤˜.";
                        
                        // [ë³´ì•ˆ] ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸ ë‚´ ì‹¤ëª… ìµëª…í™” (í•™ìƒNìœ¼ë¡œ ì¹˜í™˜)
                        let safeUserRequest = userRequest;
                        const sortedStudentsForMasking = [...students].sort((a, b) => b.name.length - a.name.length);
                        sortedStudentsForMasking.forEach(s => {
                            const originalIndex = students.findIndex(st => st.id === s.id);
                            if (originalIndex === -1) return;
                            const anonName = `í•™ìƒ${originalIndex + 1}`;
                            safeUserRequest = safeUserRequest.replaceAll(s.name, anonName);
                            if (s.name.length >= 3) safeUserRequest = safeUserRequest.replaceAll(s.name.substring(1), anonName);
                        });

                        const prompt = `
                            ë‹¹ì‹ ì€ í•™ê¸‰ ê²½ì˜ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒë“¤ì„ ${targetGroupCount}ê°œì˜ ëª¨ë‘ ìœ¼ë¡œ íŽ¸ì„±í•´ì£¼ì„¸ìš”.
                            
                            [í•™ìƒ ëª…ë‹¨]
                            ${studentListStr}

                            [ì œì•½ ì¡°ê±´]
                            - ëª¨ë“  í•™ìƒì€ ì •í™•ížˆ í•œ ê°œì˜ ëª¨ë‘ ì—ë§Œ ì†í•´ì•¼ í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°°ì • ê¸ˆì§€)
                            ${constraints.join('\n')}
                            
                            [ì‚¬ìš©ìž ìš”ì²­]
                            "${safeUserRequest}"

                            [ì‘ë‹µ í˜•ì‹]
                            - ê²°ê³¼ëŠ” ë°˜ë“œì‹œ **JSON ê°ì²´**ë¡œ ìž‘ì„±í•˜ì„¸ìš”.
                            - í˜•ì‹: { 
                                "groups": [["ì´ë¦„1", "ì´ë¦„2"], ...], 
                                "reason": "## 1. í•µì‹¬ íŽ¸ì„± ì „ëžµ\\n(ì „ëžµ ì„¤ëª…)\\n\\n## 2. ê· í˜• ë° êµ¬ì„± ë¶„ì„\\n(ì„±ë³„/ì‹¤ë ¥/ë¦¬ë” ë¶„í¬ ë“±)\\n\\n## 3. íŠ¹ì´ì‚¬í•­ ë° ê¸°ëŒ€íš¨ê³¼\\n(ë°˜ì˜ëœ ì œì•½ì¡°ê±´ ë° êµìœ¡ì  íš¨ê³¼)" 
                            }
                            - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json)ì´ë‚˜ ë¶€ê°€ì ì¸ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
                        `;

                        const text = await callGemini(apiKey, prompt);
                        const jsonStr = text.replace(/```json|```/g, "").trim();
                        let result;
                        try {
                            result = JSON.parse(jsonStr);
                        } catch (e) {
                            // í˜¹ì‹œ ë°°ì—´ë¡œë§Œ ì™”ì„ ê²½ìš°ì— ëŒ€í•œ ë°©ì–´ ì½”ë“œ
                            if (Array.isArray(JSON.parse(jsonStr))) {
                                result = { groups: JSON.parse(jsonStr), reason: "AIê°€ ìµœì ì˜ ì¡°í•©ìœ¼ë¡œ íŽ¸ì„±í–ˆìŠµë‹ˆë‹¤." };
                            } else {
                                throw e;
                            }
                        }
                        
                        const aiGroups = result.groups;
                        setAiReason(result.reason);

                        const mappedGroups = aiGroups.map(g => g.map(n => { 
                            const clean = n.split('(')[0].trim();
                            const s = anonymizedMap[clean];
                            return s ? sanitizeStudent(s) : { id: Math.random(), name: "ë¯¸í™•ì¸", gender: 'M', skill: 1, order: 0 };
                        }));

                        logSystemEvent('AI ëª¨ë‘  íŽ¸ì„± ì„±ê³µ');
                        
                        const newGroupsData = { ...groupsByDate }; // [Fix] ë°ì´í„° ì‚­ì œ ë¡œì§ ì œê±°
                        const newGroupRoles = { ...groupRoles };
                        const hasActiveRoles = groupRoles[date] && Object.keys(groupRoles[date]).length > 0;
                        const groupsToSave = {};
                        
                        let savedCount = 0;
                        let dayOffset = 0;
                        while(savedCount < groupDuration) {
                            const targetD = dayjs(date).add(dayOffset, 'day');
                            if (targetD.day() !== 0 && targetD.day() !== 6) {
                                const d = targetD.format('YYYY-MM-DD');
                                newGroupsData[d] = mappedGroups;
                                groupsToSave[d] = mappedGroups;
                                if (hasActiveRoles) newGroupRoles[d] = calculateRoles(mappedGroups);
                                savedCount++;
                            }
                            dayOffset++;
                        }
                        
                        setGroupsByDate(newGroupsData);
                        if (!isLocalMode) saveGroupsToFirestore(groupsToSave);
                        
                        if (hasActiveRoles) {
                            setGroupRoles(newGroupRoles);
                            if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                        }

                        syncSeatsWithGroups(mappedGroups);
                        setToastMessage(`AI ëª¨ë‘  íŽ¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)`);
                        if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                    } catch (e) {
                        logSystemEvent(`AI ëª¨ë‘  íŽ¸ì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                        setToastMessage("AI íŽ¸ì„± ì‹¤íŒ¨: " + e.message);
                    } finally {
                        setIsGenerating(false);
                    }
                    return;
                }

                // [Fix] setTimeout ì œê±°: ìžë¦¬ ë°°ì¹˜ë„ ë²„íŠ¼ì²˜ëŸ¼ ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ì•ˆì •ì„± í™•ë³´
                  try {
                    // ìµœì‹  ìƒíƒœ ì°¸ì¡° (Ref ì‚¬ìš© ë¶ˆí•„ìš”, ë™ê¸° ì‹¤í–‰ì´ë¯€ë¡œ í˜„ìž¬ state ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€)
                    const currentGroupsByDate = groupsByDate;
                    const currentGroupRoles = groupRoles;
                    const currentStudents = students;

                    const currentGroups = currentGroupsByDate[date] || [];
                    const lockedMap = new Map();
                    const lockedStudentIds = new Set(lockedIds);
                    
                    if (currentGroups.length > 0) {
                        currentGroups.forEach((group, gIdx) => {
                            group.forEach(s => { if (lockedStudentIds.has(s.id)) lockedMap.set(s.id, gIdx); });
                        });
                    } else {
                        // í˜„ìž¬ ë‚ ì§œì— ëª¨ë‘ ì´ ì—†ìœ¼ë©´ ê³¼ê±° ê¸°ë¡ì—ì„œ ê³ ì • í•™ìƒì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ìœ ì§€ (ê³ ì • í•™ìƒ ê¸°ëŠ¥ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse();
                        for (const d of sortedDates) {
                            const grps = currentGroupsByDate[d];
                            if (grps) {
                                grps.forEach((group, gIdx) => {
                                    group.forEach(s => { if (lockedStudentIds.has(s.id) && !lockedMap.has(s.id)) lockedMap.set(s.id, gIdx); });
                                });
                            }
                        }
                    }

                    const unlockedStudents = currentStudents.filter(s => !lockedStudentIds.has(s.id));
                    const lockedStudents = currentStudents.filter(s => lockedStudentIds.has(s.id));
                    const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    
                    const historyPairs = new Map();
                    if (useHistory) {
                        // ìµœê·¼ ê¸°ë¡ì¼ìˆ˜ë¡ ê°€ì¤‘ì¹˜ë¥¼ ë†’ê²Œ ë¶€ì—¬ (ì—°ì† ë°°ì • ë°©ì§€ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse().slice(0, historyDuration);
                        sortedDates.forEach((d, idx) => {
                            const weight = Math.max(1, 5 - Math.floor(idx / 2)); // 5, 5, 4, 4, 3, 3...
                            (currentGroupsByDate[d] || []).forEach(g => {
                                for(let i=0; i<g.length; i++) {
                                    for(let j=i+1; j<g.length; j++) {
                                        const k = [g[i].id, g[j].id].sort().join('-');
                                        historyPairs.set(k, (historyPairs.get(k) || 0) + weight);
                                    }
                                }
                            });
                        });
                    }
                    
                    const recentPairsSet = new Set();
                    if (useRecentAvoid) {
                        const sortedDates = Object.keys(currentGroupsByDate).filter(d => d < date).sort().reverse();
                        if (sortedDates.length > 0) {
                            const lastDate = sortedDates[0];
                            const lastGroups = currentGroupsByDate[lastDate] || [];
                            lastGroups.forEach(g => {
                                if (!Array.isArray(g)) return;
                                for(let i=0; i<g.length; i++) {
                                    for(let j=i+1; j<g.length; j++) {
                                        if (g[i] && g[j]) recentPairsSet.add([g[i].id, g[j].id].sort().join('-'));
                                    }
                                }
                            });
                        }
                    }

                    const clusters = [];
                    const visited = new Set();
                    const adj = {};
                    mustPairs.forEach(p => {
                        const n1 = currentStudents.find(s=>s.name === p.p1)?.id;
                        const n2 = currentStudents.find(s=>s.name === p.p2)?.id;
                        if(n1 && n2) {
                            if(!adj[n1]) adj[n1] = []; if(!adj[n2]) adj[n2] = [];
                            adj[n1].push(n2); adj[n2].push(n1);
                        }
                    });

                    unlockedStudents.forEach(s => {
                        if(visited.has(s.id)) return;
                        const cluster = [];
                        const q = [s.id];
                        visited.add(s.id);
                        while(q.length > 0) {
                            const curr = q.pop();
                            const studentObj = currentStudents.find(st => st.id === curr);
                            if(studentObj) cluster.push(studentObj);
                            (adj[curr] || []).forEach(neighbor => {
                                if(!visited.has(neighbor) && !lockedStudentIds.has(neighbor)) {
                                    visited.add(neighbor);
                                    q.push(neighbor);
                                }
                            });
                        }
                        clusters.push(cluster);
                    });
                    let bestGroups = null;
                    let maxScore = -Infinity;

                    for(let iter=0; iter < 300; iter++) {
                        let groups = Array.from({ length: targetGroupCount }, () => []);
                        let nextLockedGroupIdx = 0;
                        lockedStudents.forEach(s => {
                            let gIdx = lockedMap.get(s.id);
                            // ê³ ì • ìœ„ì¹˜ê°€ ì—†ê±°ë‚˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìˆœì°¨ ë°°ì • (í•œ ê³³ì— ëª°ë¦¬ëŠ” ê²ƒ ë°©ì§€)
                            if (gIdx === undefined || gIdx >= targetGroupCount) {
                                gIdx = nextLockedGroupIdx % targetGroupCount;
                                nextLockedGroupIdx++;
                            }
                            groups[gIdx].push(s);
                        });
                        const shuffledClusters = [...clusters].sort(() => Math.random() - 0.5);

                        if (useLeader) {
                            const leaderClusters = shuffledClusters.filter(c => c.some(s => s.leader));
                            const normalClusters = shuffledClusters.filter(c => !c.some(s => s.leader));
                            
                            leaderClusters.forEach(cluster => {
                                let minLeaders = Infinity, targetIdx = 0;
                                groups.forEach((g, i) => {
                                    const lCount = g.filter(s => s.leader).length;
                                    if(lCount < minLeaders) { minLeaders = lCount; targetIdx = i; }
                                });
                                groups[targetIdx].push(...cluster);
                            });
                            normalClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        } else {
                            shuffledClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        }

                        let score = 0;
                        let valid = true;
                        
                        if (useSkill) {
                            const groupAverages = groups.map(g => g.length > 0 ? g.reduce((a, b) => a + b.skill, 0) / g.length : 0);
                            const validAverages = groupAverages.filter(avg => avg > 0);
                            if (validAverages.length > 1) {
                                const totalAverage = validAverages.reduce((a, b) => a + b, 0) / validAverages.length;
                                const variance = validAverages.reduce((a, b) => a + Math.pow(b - totalAverage, 2), 0) / validAverages.length;
                                score -= variance * 500; // Higher penalty for variance to enforce balance
                            }
                        }

                        groups.forEach(g => {
                            if (useGender) {
                                const m = g.filter(s => s.gender === 'M').length;
                                const f = g.length - m;
                                score -= Math.abs(m - f) * 10;
                            }
                            for(let i=0; i<g.length; i++) {
                                for(let j=i+1; j<g.length; j++) {
                                    const n1 = g[i].name, n2 = g[j].name;
                                    if(avoidancePairs.some(p => (p.p1===n1 && p.p2===n2) || (p.p1===n2 && p.p2===n1))) {
                                        score -= 10000; valid = false;
                                    }
                                    if(useHistory) {
                                        const key = [g[i].id, g[j].id].sort().join('-');
                                        const histScore = historyPairs.get(key) || 0;
                                        score -= histScore * 30; // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê¸°ë°˜ íŽ˜ë„í‹°
                                    }
                                    if(useRecentAvoid) {
                                        const key = [g[i].id, g[j].id].sort().join('-');
                                        if (recentPairsSet.has(key)) score -= 5000; // ê°•ë ¥í•œ íŽ˜ë„í‹°
                                    }
                                }
                            }
                        });
                        if (valid && score > maxScore) {
                            maxScore = score;
                            bestGroups = JSON.parse(JSON.stringify(groups)); 
                        }
                    }

                    const rawGroups = bestGroups || Array.from({ length: targetGroupCount }, () => []);
                    const finalGroups = rawGroups.map(g => g.map(s => sanitizeStudent(s)).filter(s => s !== null));
                    
                    // [New] Manual Reason Generation
                    const activeConditions = [];
                    if (useGender) activeConditions.push("ì„±ë³„");
                    if (useSkill) activeConditions.push("ì‹¤ë ¥");
                    if (useLeader) activeConditions.push("ë¦¬ë”");
                    if (useHistory) activeConditions.push("ì´ì „ ê¸°ë¡");
                    if (useRecentAvoid) activeConditions.push("ìµœê·¼ ì§ê¿ í”¼í•˜ê¸°");
                    if (avoidancePairs.length > 0) activeConditions.push("ê¸°í”¼ ê´€ê³„");
                    if (mustPairs.length > 0) activeConditions.push("í•„ìˆ˜ ì§ê¿");
                    const reasonText = activeConditions.length > 0 ? `ì„ íƒí•˜ì‹  ì¡°ê±´(${activeConditions.join(', ')})ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ì•Œê³ ë¦¬ì¦˜ì´ ìµœì ì˜ ì¡°í•©ì„ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.` : "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ì´ ë¬´ìž‘ìœ„ë¡œ ì„žì–´ì„œ íŽ¸ì„±í–ˆìŠµë‹ˆë‹¤.";
                    setAiReason(reasonText);

                    if(finalGroups.flat().length === 0) {
                         const plainGroups = Array.from({ length: targetGroupCount }, () => []);
                         currentStudents.forEach((s, i) => plainGroups[i % targetGroupCount].push(sanitizeStudent(s)));
                         
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const groupsToSave = {};
                         let savedCount = 0;
                         let dayOffset = 0;
                         while(savedCount < groupDuration) {
                             const targetD = dayjs(date).add(dayOffset, 'day');
                             if (targetD.day() !== 0 && targetD.day() !== 6) {
                                 const d = targetD.format('YYYY-MM-DD');
                                 newGroupsData[d] = plainGroups.map(g => g.map(s => ({...s}))); 
                                 groupsToSave[d] = newGroupsData[d];
                                 savedCount++;
                             }
                             dayOffset++;
                         }
                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0) {
                             const newRolesForDate = calculateRoles(plainGroups);
                             const newGroupRoles = { ...currentGroupRoles, [date]: newRolesForDate };
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }
                         
                         syncSeatsWithGroups(plainGroups);
                    } else {
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const newGroupRoles = { ...currentGroupRoles };
                         const hasActiveRoles = currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0;
                         const groupsToSave = {};

                         let savedCount = 0;
                         let dayOffset = 0;
                         while(savedCount < groupDuration) {
                             const targetD = dayjs(date).add(dayOffset, 'day');
                             if (targetD.day() !== 0 && targetD.day() !== 6) {
                                 const d = targetD.format('YYYY-MM-DD');
                                 newGroupsData[d] = finalGroups.map(g => g.map(s => ({...s})));
                                 groupsToSave[d] = newGroupsData[d];
                                 if (hasActiveRoles) newGroupRoles[d] = calculateRoles(finalGroups);
                                 savedCount++;
                             }
                             dayOffset++;
                         }

                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (hasActiveRoles) {
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }

                         syncSeatsWithGroups(finalGroups);
                    }
                    setToastMessage(`ëª¨ë‘  íŽ¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)` + (useHistory ? " (ìµœê·¼ ê¸°ë¡ ë°˜ì˜ë¨)" : ""));
                  } catch (e) {
                    logSystemEvent(`ëª¨ë‘  íŽ¸ì„± ì˜¤ë¥˜: ${e.message}`, 'error');
                    setToastMessage("íŽ¸ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                  } finally {
                    if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                  }
            };

            const rotateCurrentGroups = () => { 
                if (!groups || groups.length < 2) return setToastMessage("íšŒì „í•  ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const rotateArray = (arr) => {
                    if (arr.length < 2) return arr;
                    const last = arr[arr.length - 1];
                    const rest = arr.slice(0, arr.length - 1);
                    return [last, ...rest];
                };

                const newGroups = groups.map((_, i) => { const srcIdx = (i - 1 + groups.length) % groups.length; return rotateArray(groups[srcIdx]).map(s => sanitizeStudent(s)); });
                const newGroupsData = { ...groupsByDate, [date]: newGroups }; setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
                
                syncSeatsWithGroups(newGroups);
                setToastMessage("ìžì „ê³¼ ê³µì „(íšŒì „)ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            };

            const handleGroupNameSave = (groupIndex, newName) => {
                const oldName = groupNames[date]?.[groupIndex] || `${groupIndex+1}ëª¨ë‘ `;
                if (!newName || newName.trim() === "" || newName === oldName) {
                    setEditingGroupIdx(null);
                    return;
                }

                const currentGroupMembers = groups[groupIndex].map(s => s.id).sort().join(',');
                const sameMemberGroups = [];
                
                Object.entries(groupsByDate).forEach(([d, dateGroups]) => {
                    if (d === date) return;
                    if (!Array.isArray(dateGroups)) return;
                    
                    dateGroups.forEach((g, gIdx) => {
                        if (!Array.isArray(g)) return;
                        const members = g.map(s => (s.id || s)).sort().join(',');
                        if (members === currentGroupMembers) {
                            sameMemberGroups.push({ date: d, index: gIdx });
                        }
                    });
                });

                const prevGroupNames = { ...groupNames }; // Undoë¥¼ ìœ„í•œ ì´ì „ ìƒíƒœ ì €ìž¥

                const update = (applyAll) => {
                    const newNames = { ...groupNames };
                    if (!newNames[date]) newNames[date] = {};
                    newNames[date][groupIndex] = newName;

                    if (applyAll) {
                        sameMemberGroups.forEach(({ date: d, index: i }) => {
                            if (!newNames[d]) newNames[d] = { ...(groupNames[d] || {}) }; // ë¶ˆë³€ì„± ìœ ì§€ë¥¼ ìœ„í•´ ë³µì‚¬
                            else newNames[d] = { ...newNames[d] };
                            newNames[d][i] = newName;
                        });
                        setToastMessage(`${sameMemberGroups.length}ê°œì˜ ê³¼ê±° ëª¨ë‘  ì´ë¦„ë„ í•¨ê»˜ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        setToastAction({
                            label: "ë˜ëŒë¦¬ê¸°",
                            onClick: () => {
                                setGroupNames(prevGroupNames);
                                if (!isLocalMode) saveData('cls_group_names', prevGroupNames);
                                setToastMessage("ë³€ê²½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                setToastAction(null);
                            }
                        });
                    }
                    setGroupNames(newNames);
                    if (!isLocalMode) saveData('cls_group_names', newNames);
                    setEditingGroupIdx(null);
                };

                if (sameMemberGroups.length > 0) {
                    if (appConfig.autoBatchRename) {
                        update(true);
                    } else {
                        openConfirm(
                            `ê³¼ê±° ê¸°ë¡ ì¤‘ ë™ì¼í•œ êµ¬ì„±ì›ì˜ ëª¨ë‘ ì´ ${sameMemberGroups.length}ê°œ ìžˆìŠµë‹ˆë‹¤.\nì´ë¦„ì„ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œ ì‹œ í˜„ìž¬ ëª¨ë‘ ë§Œ ë³€ê²½ë©ë‹ˆë‹¤)`,
                            () => update(true),
                            () => update(false)
                        );
                    }
                } else {
                    update(false);
                }
            };

            const handleRoleChange = (groupIdx, studentIdx, newRole) => {
                const newRoles = { ...groupRoles };
                if (!newRoles[date]) newRoles[date] = {};
                if (!newRoles[date][groupIdx]) newRoles[date][groupIdx] = {};
                
                if (newRole) newRoles[date][groupIdx][studentIdx] = newRole;
                else if (newRoles[date][groupIdx]) delete newRoles[date][groupIdx][studentIdx];
                
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setEditingRoleTarget(null);
            };
            
            const handleGroupReset = (duration) => {
                const datesToDelete = [];
                for (let i = 0; i < duration; i++) {
                    datesToDelete.push(dayjs(date).add(i, 'day').format('YYYY-MM-DD'));
                }

                const newGroups = { ...groupsByDate };
                const newRoles = { ...groupRoles };
                
                datesToDelete.forEach(d => {
                    delete newGroups[d];
                    delete newRoles[d];
                });

                setGroupsByDate(newGroups);
                setGroupRoles(newRoles);
                setSeatAssignments({});

                const updates = { cls_groups_date: newGroups, cls_group_roles: newRoles, cls_seat_assignments: {} };

                if (!isLocalMode) {
                    saveData(updates);
                    deleteGroupsFromFirestore(datesToDelete);
                } else {
                    saveData(updates);
                }

                setToastMessage(`${duration}ì¼ê°„ì˜ ëª¨ë‘  ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                setShowGroupResetModal(false);
            };

            const handleDragStart = (e, studentId, fromGroupIdx) => { 
                draggedGroupItemRef.current = { studentId, fromGroupIdx };
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromGroupIdx }));
                e.dataTransfer.effectAllowed = "move";
                const target = e.currentTarget;
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        target.classList.add("dragging");
                        document.body.classList.add('is-dragging-group');
                    }, 0);
                });
            };
            const handleDragEnd = (e) => { 
                e.currentTarget.classList.remove("dragging"); 
                document.body.classList.remove('is-dragging-group');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over")); 
                draggedGroupItemRef.current = null;
            };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; e.currentTarget.classList.add("drag-over"); };
            const handleDragLeave = (e) => { 
                if (e.currentTarget.contains(e.relatedTarget)) return;
                e.currentTarget.classList.remove("drag-over"); 
            };
            
            const handleDrop = (e, toGroupIdx) => { 
                e.preventDefault(); 
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-group');
                
                let data = draggedGroupItemRef.current;
                if (!data) {
                    try {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    } catch (err) { console.error("Drop failed", err); }
                }

                if (!data || !data.studentId) return;
                const { studentId, fromGroupIdx } = data;

                if (fromGroupIdx === toGroupIdx) return;
                
                // 1. í˜„ìž¬ ë‚ ì§œ ë³€ê²½
                const currentGroups = [...(groupsByDate[date] || [])]; 
                const student = currentGroups[fromGroupIdx].find(s => s.id === studentId); 
                if (!student) return;
                
                currentGroups[fromGroupIdx] = currentGroups[fromGroupIdx].filter(s => s.id !== studentId); 
                currentGroups[toGroupIdx] = [...currentGroups[toGroupIdx], sanitizeStudent(student)]; 
                
                const newGroupsData = { ...groupsByDate, [date]: currentGroups }; 
                const groupsToSave = { [date]: currentGroups };
                const rolesToSave = {};

                // 2. ì´í›„ ë‚ ì§œ ë™ê¸°í™” (Sync to future dates)
                const futureDates = Object.keys(groupsByDate).filter(d => d > date).sort();
                let syncCount = 0;

                futureDates.forEach(fDate => {
                    const fGroups = [...(groupsByDate[fDate] || [])];
                    // ëŒ€ìƒ ëª¨ë‘  ì¸ë±ìŠ¤ê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
                    if (fGroups.length <= toGroupIdx) return;

                    // í•´ë‹¹ ë‚ ì§œì—ì„œ í•™ìƒ ì°¾ê¸°
                    let fFromIdx = -1;
                    let fStudent = null;
                    fGroups.forEach((g, idx) => {
                        const found = g.find(s => s.id === studentId);
                        if (found) { fFromIdx = idx; fStudent = found; }
                    });

                    // í•™ìƒì´ ì¡´ìž¬í•˜ê³ , ì´ë¯¸ ëª©í‘œ ëª¨ë‘ ì— ìžˆì§€ ì•Šë‹¤ë©´ ì´ë™
                    if (fStudent && fFromIdx !== -1 && fFromIdx !== toGroupIdx) {
                        fGroups[fFromIdx] = fGroups[fFromIdx].filter(s => s.id !== studentId);
                        fGroups[toGroupIdx] = [...fGroups[toGroupIdx], sanitizeStudent(fStudent)];
                        
                        newGroupsData[fDate] = fGroups;
                        groupsToSave[fDate] = fGroups;
                        syncCount++;

                        // ì—­í• ì´ í™œì„±í™”ë˜ì–´ ìžˆë‹¤ë©´ ì—­í• ë„ ìž¬ê³„ì‚° (êµ¬ì„±ì›ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ)
                        if (groupRoles[fDate] && Object.keys(groupRoles[fDate]).length > 0) {
                             rolesToSave[fDate] = calculateRoles(fGroups);
                        }
                    }
                });

                setGroupsByDate(newGroupsData);
                
                // í˜„ìž¬ ë‚ ì§œ ì—­í•  ì—…ë°ì´íŠ¸
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    rolesToSave[date] = calculateRoles(currentGroups);
                }
                
                const updates = { cls_groups_date: newGroupsData };
                if (Object.keys(rolesToSave).length > 0) {
                    const newGroupRoles = { ...groupRoles, ...rolesToSave };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }

                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore(groupsToSave);
                } else {
                    saveData(updates);
                }
                syncSeatsWithGroups(currentGroups);
                
                if (syncCount > 0) {
                    showToast(`ì´ë™ ì™„ë£Œ (ì´í›„ ${syncCount}ì¼ê°„ì˜ ê¸°ë¡ë„ ë³€ê²½ë¨)`);
                }
            };

            const handleAssignRoles = () => {
                const currentGroups = groupsByDate[date] || [];
                if (currentGroups.length === 0) return setToastMessage("íŽ¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const newRolesForDate = calculateRoles(currentGroups);
                const newRoles = { ...groupRoles, [date]: newRolesForDate };
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ëª¨ë‘  ì—­í• ì´ ìžë¦¬ì— ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleClearRoles = () => {
                const newRoles = { ...groupRoles };
                delete newRoles[date];
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ì—­í•  ë°°ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRoles = (newRoles) => {
                setRolesList(newRoles);
                if (!isLocalMode) saveData('cls_roles_list', newRoles);
                setToastMessage("ì—­í•  ëª©ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setIsRoleEditOpen(false);
                
                // í˜„ìž¬ ì—­í•  ë°°ì • ì¤‘ì´ë¼ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const currentGroups = groupsByDate[date] || [];
                    if (currentGroups.length > 0) {
                        // ìž„ì‹œë¡œ rolesList ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì§ì ‘ ì „ë‹¬
                        const activeRoles = newRoles.length > 0 ? newRoles : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        const rolesForDate = {};
                        currentGroups.forEach((group, gIdx) => {
                            rolesForDate[gIdx] = {};
                            for (let sIdx = 0; sIdx < group.length; sIdx++) {
                                const myRoles = [];
                                activeRoles.forEach((r, rIdx) => { 
                                    if (rIdx % group.length === sIdx) myRoles.push(r); 
                                });
                                rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                            }
                        });
                        const newGroupRoles = { ...groupRoles, [date]: rolesForDate };
                        setGroupRoles(newGroupRoles);
                        if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                    }
                }
            };

            const handleSaveRoleDescriptions = (newDesc) => {
                setRoleDescriptions(newDesc);
                if (!isLocalMode) saveData('cls_role_descriptions', newDesc);
            };

            const handleGroupsChange = (newGroups) => {
                // ë°ì´í„° í¬ê¸° ìµœì í™”ë¥¼ ìœ„í•´ ì‚¬ì§„ ë“± ë¶ˆí•„ìš”í•œ ì •ë³´ ì œê±°
                const newGroupsData = { ...groupsByDate, [date]: newGroups };
                setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
            };

            const loadGroupsFromDate = (targetDate) => {
                if (groupsByDate[targetDate] && groupsByDate[targetDate].length > 0) {
                    openConfirm(`${dayjs(targetDate).format('YYYY-MM-DD')}ì˜ ëª¨ë‘  íŽ¸ì„±ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                        const lastGroups = JSON.parse(JSON.stringify(groupsByDate[targetDate]));
                        const newGroupsData = { ...groupsByDate, [date]: lastGroups };
                        setGroupsByDate(newGroupsData);
                        
                        const updates = { cls_groups_date: newGroupsData };
                        const groupsToSave = { [date]: lastGroups };
                        
                        if (groupRoles[targetDate]) {
                            const newRoles = { ...groupRoles, [date]: JSON.parse(JSON.stringify(groupRoles[targetDate])) };
                            setGroupRoles(newRoles);
                            updates['cls_group_roles'] = newRoles;
                        }

                        if (!isLocalMode) {
                            saveData(updates);
                            saveGroupsToFirestore(groupsToSave);
                        } else {
                            saveData(updates);
                        }
                        
                        const hydratedLastGroups = hydrateGroups({ [date]: lastGroups }, students)[date];
                        syncSeatsWithGroups(hydratedLastGroups);
                        setToastMessage(`${dayjs(targetDate).format('MM/DD')} ëª¨ë‘ ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    });
                } else {
                    setToastMessage("í•´ë‹¹ ë‚ ì§œì— ëª¨ë‘  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            };

            const loadLastGroups = () => {
                const dates = Object.keys(groupsByDate).sort().reverse();
                const lastDate = dates.find(d => d < date && groupsByDate[d] && groupsByDate[d].length > 0);
                
                if (lastDate) {
                    loadGroupsFromDate(lastDate);
                } else {
                    setToastMessage("ì´ì „ ëª¨ë‘  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            };

            const roleMap = useMemo(() => {
                const map = {};
                const currentGroups = groupsByDate[date] || [];
                const currentRoles = groupRoles[date] || {};
                currentGroups.forEach((g, gIdx) => {
                    g.forEach((s, sIdx) => {
                        const role = currentRoles[gIdx]?.[sIdx] || currentRoles[gIdx]?.[s.id];
                        if (role) map[s.id] = role;
                    });
                });
                return map;
            }, [groupsByDate, groupRoles, date]);

            const stats = useMemo(() => { const dates = Object.keys(records).sort(); const isWithinPeriod = (dStr, period) => { const d = dayjs(dStr); const now = dayjs(); if (period === 'weekly') return d.isAfter(now.subtract(7, 'day')) && d.isBefore(now.add(1, 'day')); if (period === 'monthly') return d.isAfter(now.subtract(30, 'day')) && d.isBefore(now.add(1, 'day')); return true; }; const calcStatsForStudent = (s, period, tag) => { let doneCount = 0; let totalCount = 0; for(let i=34; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const dayIdx = dayjs(d).day(); if(dayIdx===0 || dayIdx===6) continue; if (!isWithinPeriod(d, period)) continue; const dayRecord = records[d]; const dayTasks = dailyTasks[d] || []; if (tag === 'ì „ì²´') { if (dayRecord) 
            { const tasksForDay = dailyTasks[d] || []; if (tasksForDay.length > 0) { totalCount += tasksForDay.length; const sRec = dayRecord[s.id]; if (sRec) { tasksForDay.forEach((_, idx) => { if (sRec.tasks && sRec.tasks[idx]) doneCount++; else if (!sRec.tasks && sRec.done) doneCount++; }); } } else { totalCount++;
            if (dayRecord[s.id]?.done) doneCount++; } } } else { const tagTasks = dayTasks.filter(t => (typeof t === 'object' ? t.tag : 'ê¸°íƒ€') === tag);
            if (tagTasks.length > 0) { totalCount += tagTasks.length; tagTasks.forEach((t, idx) => { const originalIdx = dayTasks.indexOf(t); const isTaskDone = dayRecord?.[s.id]?.done || dayRecord?.[s.id]?.tasks?.[originalIdx]; if(isTaskDone) doneCount++; });
            } } } return { count: doneCount, total: totalCount, rate: totalCount > 0 ?
            (doneCount / totalCount) * 100 : 0 }; }; const computedStudents = students.map(s => { let count = 0, currentStreak = 0; const history = []; const datesSorted = Object.keys(records).sort(); for(let i=29; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const dayIdx = dayjs(d).day(); if(dayIdx===0 || dayIdx===6) continue; let dailyDoneCount = 0; let dailyTotalCount = 0; const dayTasks = dailyTasks[d] || []; const dayRecord = records[d]; if(dayTasks.length > 0) { dailyTotalCount = dayTasks.length; if(dayRecord && dayRecord[s.id]) { dayTasks.forEach((_, idx) => { if(dayRecord[s.id].tasks && dayRecord[s.id].tasks[idx]) dailyDoneCount++; else if(!dayRecord[s.id].tasks && dayRecord[s.id].done) dailyDoneCount++; }); } } else { if(dayRecord && dayRecord[s.id]?.done) { dailyTotalCount = 1; dailyDoneCount = 1; } } const 
            ratio = dailyTotalCount > 0 ? dailyDoneCount / dailyTotalCount : 0; history.push({ date: d, ratio: ratio, count: dailyDoneCount, total: dailyTotalCount, done: dailyDoneCount === dailyTotalCount && dailyTotalCount > 0 }); if(ratio === 1) count++; } for(let i=0; i<365;
            i++) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const rec = records[d]?.[s.id]; let isDoneDay = false;
            if(rec) { if(rec.tasks) { if(rec.done) isDoneDay = true; } else if(rec.done) { isDoneDay = true; } } if(isDoneDay) currentStreak++;
            else if(i===0 && !isDoneDay) continue; else break; } const honorStats = calcStatsForStudent(s, honorPeriod, honorTag); const helpStats = calcStatsForStudent(s, helpPeriod, helpTag);
            return { ...s, count, streak: currentStreak, history, honorStats, helpStats }; }); const top5 = [...computedStudents].sort((a,b) => b.honorStats.count - a.honorStats.count).slice(0, 5);
            const bottom5 = [...computedStudents].sort((a,b) => a.helpStats.rate - b.helpStats.rate).slice(0, 5); return { students: computedStudents, top5, bottom5 };
            }, [students, records, dailyTasks, honorPeriod, honorTag, helpPeriod, helpTag]);
            
            const handleFirebaseConnect = (config) => { localStorage.setItem('checklist_config', JSON.stringify(config)); setIsSetupOpen(false);
            setToastMessage("ì—°ê²° ì •ë³´ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤."); setTimeout(() => window.location.reload(), 1500); };
            
            const handleResetAllData = (selectedItems) => { 
                openConfirm("ì„ íƒí•œ í•­ëª©ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    const updates = {};
                    
                    if (selectedItems.includes('students')) {
                        setStudents([]);
                        updates['cls_students'] = [];
                    }
                    if (selectedItems.includes('records')) {
                        setRecords({});
                        setSimpleChecks({});
                        updates['cls_records'] = {};

                        // [New] í•™ìƒ ëª…ë‹¨ì€ ìœ ì§€í•˜ë©´ì„œ ê¸°ë¡ë§Œ ì‚­ì œí•˜ëŠ” ê²½ìš°: ìƒë‹´ ê¸°ë¡ê³¼ ìŠ¤í‹°ì»¤ë„ ì´ˆê¸°í™”
                        if (!selectedItems.includes('students')) {
                            const resetStudents = students.map(s => ({ ...s, counseling: [], stickers: 0 }));
                            setStudents(resetStudents);
                            updates['cls_students'] = resetStudents;
                        }
                    }
                    if (selectedItems.includes('groups')) {
                        setGroupsByDate({});
                        setGroupNames({});
                        setGroupRoles({});
                        setAvoidancePairs([]);
                        setMustPairs([]);
                        updates['cls_groups_date'] = {};
                        updates['cls_group_names'] = {};
                        updates['cls_group_roles'] = {};
                        updates['cls_avoidance'] = [];
                        updates['cls_mustPairs'] = [];
                    }
                    if (selectedItems.includes('tasks')) {
                        setDailyTasks({});
                        setWeeklyTasks({0:[],1:[],2:[],3:[],4:[],5:[],6:[]});
                        setTags(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
                        updates['cls_daily_tasks'] = {};
                        updates['cls_weekly_tasks'] = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
                        updates['cls_tags'] = ['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€'];
                    }
                    if (selectedItems.includes('seats')) {
                        setSeatAssignments({});
                        setSeatConfig({rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']});
                        updates['cls_seat_assignments'] = {};
                        updates['cls_seat_config'] = {rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']};
                    }
                    if (selectedItems.includes('roles')) {
                        setRolesList(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
                        setRoleDescriptions(DEFAULT_ROLE_DESCRIPTIONS);
                        updates['cls_roles_list'] = ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        updates['cls_role_descriptions'] = DEFAULT_ROLE_DESCRIPTIONS;
                    }

                    if (!isLocalMode) {
                        saveData(updates);
                        if (db && appId) {
                            if (selectedItems.includes('students')) {
                                db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                            if (selectedItems.includes('records')) {
                                db.collection('classes').doc(appId).collection('records').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });

                                // [New] ìƒë‹´ ê¸°ë¡ í•„ë“œ ì‚­ì œ (í•™ìƒ ëª…ë‹¨ ìœ ì§€ ì‹œ)
                                if (!selectedItems.includes('students')) {
                                    db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                        const batch = db.batch();
                                        snapshot.docs.forEach(doc => {
                                            batch.update(doc.ref, { counseling: firebase.firestore.FieldValue.delete() });
                                        });
                                        batch.commit();
                                    });
                                }
                            }
                            if (selectedItems.includes('groups')) {
                                db.collection('classes').doc(appId).collection('groupResults').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                        }
                    } else {
                        saveData(updates);
                    }
                    setToastMessage("ì„ íƒí•œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                });
            };

            const handleFormationTitleClick = () => {
                if (formationClickTimer.current) clearTimeout(formationClickTimer.current);
                const newCount = formationClickCount + 1;
                setFormationClickCount(newCount);
                
                if (newCount >= 3) {
                    onOpenApiKeySetup();
                    setToastMessage("AI ì„¤ì • ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.");
                    setFormationClickCount(0);
                } else {
                    formationClickTimer.current = setTimeout(() => setFormationClickCount(0), 500);
                }
            };

            const handleGenerateBriefing = async () => {
                if (!apiKey) {
                    setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                setIsGenerating(true);
                setAiContent(""); 
                setShowWeeklyBriefing(true);
                setGenerationProgress(0);

                const timer = setInterval(() => {
                    setGenerationProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 300);

                try {
                    // ì„ íƒëœ ê¸°ê°„ ë°ì´í„° ì§‘ê³„
                    let curr = dayjs(briefingStart);
                    const end = dayjs(briefingEnd);
                    const targetDates = [];
                    while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                        targetDates.push(curr.format('YYYY-MM-DD'));
                        curr = curr.add(1, 'day');
                    }
                    const summary = targetDates.reverse().map(d => {
                        const tasks = dailyTasks[d] || [];
                        const recs = records[d] || {};
                        const total = students.length * (tasks.length || 1);
                        let done = 0;
                        students.forEach(s => {
                            const r = recs[s.id];
                            if(r) {
                                if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                                else if(r.done) done++;
                            }
                        });
                        return `${d}: ìˆ˜í–‰ë¥  ${total > 0 ? Math.round(done/total*100) : 0}%`;
                    }).join('\n');

                    let toneDesc = "ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ ë¹„ì„œì²˜ëŸ¼";
                    if (briefingTone === 'encouraging') toneDesc = "ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'analytical') toneDesc = "ê°ê´€ì ì´ê³  ë¶„ì„ì ì¸ ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'concise') toneDesc = "í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ì–´ì¡°ë¡œ";

                    const prompt = `
                        ${briefingStart}ë¶€í„° ${briefingEnd}ê¹Œì§€ì˜ í•™ê¸‰ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ ì„ ìƒë‹˜ì„ ìœ„í•œ 'ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ ë¸Œë¦¬í•‘'ì„ ìž‘ì„±í•´ì£¼ì„¸ìš”.

                        [ë°ì´í„° ìš”ì•½]
                        ${summary}

                        [ë¶„ì„ ìš”ì²­ì‚¬í•­]
                        1. **í•™ìŠµ íë¦„ ë¶„ì„**: ë‹¨ìˆœ ìˆ˜í–‰ë¥  ë‚˜ì—´ì´ ì•„ë‹Œ, ì£¼ê°„ í•™ìŠµ íë¦„ì˜ ë³€í™”ì™€ íŠ¹ì´ì ì„ íŒŒì•…í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì£¼ì´ˆ ëŒ€ë¹„ ì£¼ë§ì˜ ë³€í™”, íŠ¹ì • ìš”ì¼ì˜ ì €ì¡°í•¨ ë“±)
                        2. **ê´€ì‹¬ í•„ìš” ì˜ì—­**: ìˆ˜í–‰ë¥ ì´ ê¸‰ê²©ížˆ ë–¨ì–´ì§€ê±°ë‚˜ ì§€ì†ì ìœ¼ë¡œ ì €ì¡°í•œ ë¶€ë¶„ì´ ìžˆë‹¤ë©´ ì›ì¸ì„ ì¶”ë¡ í•˜ê³  ì–¸ê¸‰í•´ì£¼ì„¸ìš”.
                        3. **ë‹¤ìŒ ì£¼ ì „ëžµ**: ë¶„ì„ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì£¼ í•™ê¸‰ ìš´ì˜ì— ì ìš©í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ 'ì›í¬ì¸íŠ¸ ë ˆìŠ¨'ì´ë‚˜ 'ë¯¸ì…˜'ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
                        4. **ì–´ì¡°**: ${toneDesc} ìž‘ì„±í•´ì£¼ì„¸ìš”.
                        5. **í˜•ì‹**: ê°€ë…ì„± ì¢‹ê²Œ ì†Œì œëª©ì„ í™œìš©í•˜ì—¬ êµ¬ì¡°í™”í•˜ê³ , 400ìž ë‚´ì™¸ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    clearInterval(timer);
                    setGenerationProgress(100);
                    setAiContent(text);
                } catch (e) {
                    clearInterval(timer);
                    setShowWeeklyBriefing(false);
                    setToastMessage("ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleDownloadBriefingPdf = async () => {
                if (!briefingRef.current) return;
                if (!window.jspdf) return setToastMessage("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ìž…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(briefingRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`ì£¼ê°„ë¸Œë¦¬í•‘_${dayjs().format('YYYYMMDD')}.pdf`);
                    setToastMessage("PDFë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { setToastMessage("PDF ì €ìž¥ ì‹¤íŒ¨: " + e.message); }
            };

            const handleGenerateStory = async () => {
                if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsGenerating(true);
                try {
                    const tasks = dailyTasks[date] || [];
                    const recs = records[date] || {};
                    const total = students.length * (tasks.length || 1);
                    let done = 0;
                    students.forEach(s => {
                        const r = recs[s.id];
                        if(r) {
                            if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                            else if(r.done) done++;
                        }
                    });
                    const rate = total > 0 ? Math.round(done/total*100) : 0;
                    
                    let genrePrompt = "ì˜¤ëŠ˜ í•˜ë£¨ ìš°ë¦¬ ë°˜ì˜ ì†Œì†Œí•œ ì¼ìƒì„ ë‹´ì€ ë”°ëœ»í•œ í•™ê¸‰ ì¼ê¸°";
                    let rolePrompt = "ìˆœìˆ˜í•˜ê³  ë°ì€ ì´ˆë“±í•™ìƒë“¤";
                    
                    if (storyGenre === 'growth') { genrePrompt = "ì–´ë ¤ì›€ì„ ì´ê²¨ë‚´ê³  í•œ ë¼˜ ë” ì„±ìž¥í•˜ëŠ” ê°ë™ì ì¸ ì´ì•¼ê¸°"; rolePrompt = "ë…¸ë ¥í•˜ëŠ” ë©‹ì§„ í•™ìƒë“¤"; }
                    else if (storyGenre === 'friendship') { genrePrompt = "ì¹œêµ¬ë¥¼ ë°°ë ¤í•˜ê³  ì„œë¡œ ë•ëŠ” ì•„ë¦„ë‹¤ìš´ ìš°ì • ì´ì•¼ê¸°"; rolePrompt = "ë§ˆìŒì”¨ ì°©í•œ ì¹œêµ¬ë“¤"; }
                    else if (storyGenre === 'funny') { genrePrompt = "ì½ìœ¼ë©´ ì›ƒìŒì´ ë‚˜ì˜¤ëŠ” ìœ ì¾Œí•˜ê³  ìž¬ì¹˜ ìžˆëŠ” ì´ì•¼ê¸°"; rolePrompt = "ê°œêµ¬ìŸì´ ì¹œêµ¬ë“¤"; }
                    else if (storyGenre === 'lesson') { genrePrompt = "ì˜¤ëŠ˜ì˜ í™œë™ì„ í†µí•´ ì‚¶ì˜ ì§€í˜œë¥¼ ë°°ìš°ëŠ” êµí›ˆì ì¸ ì´ì•¼ê¸°"; rolePrompt = "ì§€í˜œë¡œìš´ í•™ìƒë“¤"; }

                    const prompt = `
                        ì˜¤ëŠ˜ ìš°ë¦¬ ë°˜ì˜ í•˜ë£¨ í™œë™ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì´ˆë“±í•™ìƒë“¤ì—ê²Œ ìœ ìµí•˜ê³  ìž¬ë¯¸ìžˆëŠ” ${genrePrompt}ë¥¼ ì°½ìž‘í•´ì£¼ì„¸ìš”.

                        [ì˜¤ëŠ˜ì˜ í™œë™ ë°ì´í„°]
                        - ë‚ ì§œ: ${date}
                        - ê³¼ì œ ìˆ˜í–‰ë¥ : ${rate}% (ì´ ìˆ˜ì¹˜ëŠ” ì˜¤ëŠ˜ í•˜ë£¨ ì•„ì´ë“¤ì´ ì–¼ë§ˆë‚˜ ì„±ì‹¤í–ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤)
                        - ì¹­ì°¬ ìŠ¤í‹°ì»¤: ì˜¤ëŠ˜ ì „ì²´ ì§€ê¸‰ëœ ìŠ¤í‹°ì»¤ ìˆ˜ (ì•„ì´ë“¤ì˜ ë…¸ë ¥ì— ëŒ€í•œ ë³´ìƒ)

                        [ìŠ¤í† ë¦¬í…”ë§ ê°€ì´ë“œ]
                        1. **ë¶„ìœ„ê¸°**: ìžê·¹ì ì´ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¸ íŒíƒ€ì§€ ìš”ì†Œ(ë§ˆë²•, ëª¬ìŠ¤í„° ë“±)ëŠ” ë°°ì œí•˜ê³ , í˜„ì‹¤ì ì¸ í•™êµ ìƒí™œì„ ë°°ê²½ìœ¼ë¡œ ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•´ì£¼ì„¸ìš”.
                        2. **ì „ê°œ**: 'ì•„ì¹¨ì˜ ì‹œìž‘ - ê³¼ì œ(ë¯¸ì…˜) ìˆ˜í–‰ ê³¼ì •ì—ì„œì˜ ì—í”¼ì†Œë“œ - ì„œë¡œ ë•ëŠ” ëª¨ìŠµ - í•˜ë£¨ì˜ ë³´ëžŒì°¬ ë§ˆë¬´ë¦¬'ì˜ íë¦„ìœ¼ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.
                        3. **ìºë¦­í„°**: í•™ìƒë“¤ì„ ${rolePrompt}ë¡œ ë¬˜ì‚¬í•˜ë˜, ì‹¤ëª… ëŒ€ì‹  'ìš°ë¦¬ ë°˜ ì¹œêµ¬ë“¤', 'ëª‡ëª‡ ì•„ì´ë“¤' ë“±ìœ¼ë¡œ ì§€ì¹­í•˜ì—¬ ëˆ„êµ¬ë‚˜ ê³µê°í•  ìˆ˜ ìžˆê²Œ í•´ì£¼ì„¸ìš”.
                        4. **ë©”ì‹œì§€**: ê²°ê³¼ë³´ë‹¤ëŠ” ê³¼ì •ì„ ì¹­ì°¬í•˜ê³ , ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¦ê±°ì›€ì„ ê°•ì¡°í•˜ë©° ë‚´ì¼ í•™êµ ì˜¤ëŠ” ê²ƒì´ ê¸°ëŒ€ë˜ë„ë¡ í¬ë§ì ì¸ ë©”ì‹œì§€ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”.
                        5. **ë¬¸ì²´**: ì´ˆë“±í•™ìƒì´ ì½ê¸° íŽ¸í•œ ì¹œì ˆí•˜ê³  ë¶€ë“œëŸ¬ìš´ ë¬¸ì²´(í•´ìš”ì²´)ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                        6. **ë¶„ëŸ‰**: 500ìž ë‚´ì™¸ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    setAiContent(text);
                } catch (e) {
                    logSystemEvent(`í•™ê¸‰ ì´ì•¼ê¸° ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleLoadAllData = async () => {
                if (isLocalMode) {
                    setToastMessage("ë¡œì»¬ ëª¨ë“œì—ì„œëŠ” ì´ë¯¸ ëª¨ë“  ë°ì´í„°ê°€ ë¡œë“œë˜ì–´ ìžˆìŠµë‹ˆë‹¤.");
                    return;
                }
                if (!db || !appId) return;

                try {
                    setToastMessage("í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
                    const studentSnapshot = await db.collection('classes').doc(appId).collection('studentData').get();
                    const studentDataMap = {};
                    studentSnapshot.forEach(doc => { studentDataMap[doc.id] = doc.data(); });

                    const updatedStudents = students.map(s => {
                        const extra = studentDataMap[String(s.id)];
                        return extra ? { ...s, ...extra } : s;
                    });
                    
                    setStudents(updatedStudents);
                    setToastMessage("ì „ì²´ ê¸°ë¡ ë¡œë“œ ì™„ë£Œ!");
                } catch (e) {
                    console.error(e);
                    setToastMessage("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                    throw e;
                }
            };

            const handleForceLocalMode = () => {
                setIsLocalMode(true);
                setIsLoading(false);
                setToastMessage("ë¡œì»¬ ëª¨ë“œë¡œ ê°•ì œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const moveDateSkipWeekend = (direction) => {
                let nextDate = dayjs(date).add(direction, 'day');
                while (nextDate.day() === 0 || nextDate.day() === 6) {
                    nextDate = nextDate.add(direction, 'day');
                }
                setDate(nextDate.format('YYYY-MM-DD'));
            };

            if (isLoading) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-slate-50 space-y-6 p-8">
                        <div className="text-6xl animate-bounce mb-2">â³</div>
                        <div className="text-center space-y-2">
                            <div className="text-2xl font-bold text-slate-800">ì•±ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘ìž…ë‹ˆë‹¤...</div>
                            <div className="text-sm text-slate-500 font-medium">ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ê³  ìžˆì–´ìš”.</div>
                        </div>
                        
                        <div className="w-full max-w-xs space-y-2">
                            <div className="h-3 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-300 ease-out" style={{ width: `${loadingProgress}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs font-bold text-slate-400">
                                <span>Loading...</span>
                                <span>{Math.round(loadingProgress)}%</span>
                            </div>
                        </div>

                        {showLongLoading && (
                            <div className="animate-fade-in flex flex-col items-center gap-3 mt-4 pt-4 border-t border-slate-200 w-full max-w-xs">
                                <p className="text-xs text-rose-500 font-bold text-center">
                                    ë¡œë”©ì´ ì§€ì—°ë˜ê³  ìžˆìŠµë‹ˆë‹¤.<br/>(ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” ì¼ì‹œì  ì˜¤ë¥˜)
                                </p>
                                <div className="flex gap-2 w-full">
                                    <button onClick={() => window.location.reload()} className="flex-1 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 shadow-sm text-sm transition-transform active:scale-95">
                                        ìƒˆë¡œê³ ì¹¨
                                    </button>
                                    <button onClick={handleForceLocalMode} className="flex-1 px-4 py-2.5 bg-slate-100 border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-200 shadow-sm text-sm transition-transform active:scale-95">
                                        ê°•ì œ ë¡œì»¬ ëª¨ë“œ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`flex flex-col min-h-screen bg-slate-50 text-slate-900 ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                    <header className="bg-white border-b border-notion-border z-20 sticky top-0"><div className="px-4 py-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-3"><div className="flex items-center gap-6"><div className="flex items-center gap-2"><div className="p-1.5 bg-notion-bg-alt text-notion-text rounded border border-notion-border"><Icon d={PATHS.list} size={18}/></div><h1 className="text-base font-bold text-notion-text">{appConfig.recordTitle}</h1><button 
    onClick={() => { setShowTutorial(true); setTutorialStep(0); }} 
    className="ml-2 w-7 h-7 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-200 transition-colors shadow-sm ring-1 ring-indigo-100" 
    title="ì‚¬ìš© ì„¤ëª…ì„œ ë³´ê¸°"
>
    ðŸ’¡
</button>{!isLocalMode && <div className="animate-fade-in" title="í´ë¼ìš°ë“œ ì—°ê²°ë¨">{appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-6 h-6 object-contain" alt="cloud"/> : <span className="text-xl">â˜ï¸</span>}</div>}</div><div className="hidden md:flex gap-1">{[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (<button key={m.id} onClick={()=>setMode(m.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-sm font-medium transition-all ${mode===m.id?'bg-notion-bg-hover text-notion-text':'text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text'}`}><Icon d={m.icon} size={14}/><span>{m.label}</span></button>))}</div></div>
                    <div className="flex items-center gap-2 absolute right-4 top-3 md:relative md:top-auto md:right-auto">
                        <button onClick={()=>setIsToolsOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>ðŸ§°</span><span className="text-sm font-medium">ë„êµ¬</span></button>
                        <button onClick={()=>setIsSettingOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>âš™ï¸</span><span className="text-sm font-medium">ì„¤ì •</span></button>
                    </div>
                    </div>{(mode === 'record' || mode === 'group') && (<div className="bg-white border-b border-notion-border pt-2 pb-2 flex justify-center"><div className="w-full max-w-2xl px-4 flex flex-col gap-2">{mode === 'record' ? <><DateHeader date={date} setDate={setDate} onAdd={()=>setIsTaskModalOpen(true)} onReset={resetDateRecord} onCalendar={()=>setIsCalendarOpen(true)} appConfig={appConfig}/> <ProgressBar progress={progress} appConfig={appConfig} /></> : <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border mx-auto w-fit justify-center cursor-pointer"
><Btn onClick={()=>moveDateSkipWeekend(-1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18}/></Btn><div className="flex flex-col items-center px-3" onClick={()=>setIsCalendarOpen(true)}><div className="text-base font-bold text-notion-text">{dayjs(date).format('YY.MM.DD')}</div><div className="text-[10px] font-bold text-notion-text-light">{dayjs(date).format('dddd')}</div></div><Btn onClick={()=>moveDateSkipWeekend(1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18}/></Btn></div>}</div></div>)}</header>
                    <main className="flex-1 flex flex-col p-4 md:p-6 pb-20 md:pb-6 bg-white"
                    >
                        <div key={date} className="flex-1">
                            {mode === 'record' && (
                                <>
                                    <div className="flex justify-end mb-4 items-center gap-2">
                                        <Btn onClick={() => setShowAllRecords(true)} className="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm transition-colors">
                                            <Icon d={PATHS.history} size={16} /> ì „ì²´ ê¸°ë¡ ë³´ê¸°
                                        </Btn>
                                        {appConfig.showClassStoryButton && (
                                            <>
                                                <Btn onClick={() => { if(!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”."); setAiContent(""); setShowClassStory(true); }} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                                    <Icon d={PATHS.book} size={16} /> ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸° ë³´ê¸°
                                                </Btn>
                                                <button onClick={() => setShowStoryHelp(true)} className="text-notion-text-light hover:text-notion-text p-1 rounded hover:bg-notion-bg-hover transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={18} /></button>
                                            </>
                                        )}
                                    </div>
                                    <RecordView students={students} records={records} dailyTasks={dailyTasks} date={date} toggleCheck={toggleCheck} appConfig={appConfig} stats={stats} onLongPress={(id) => setGrassStudentId(id)} />
                                </>
                            )}
                            {mode === 'simple' && <SimpleView students={students} simpleChecks={simpleChecks} toggleCheck={toggleCheck} onLongPress={(id) => setGrassStudentId(id)} />}
                            {mode === 'group' && (
                                <div className="w-full md:h-full h-auto flex flex-col md:flex-row gap-6 pb-4 md:overflow-hidden">
                                    <div className={`md:w-1/3 lg:w-1/4 space-y-4 md:h-full h-auto md:overflow-y-auto custom-scroll transition-all duration-300 ${isGroupPanelOpen ? 'block' : 'hidden'}`}>
                                        {isRotationDay && !hideRotationBanner && (
                                            <div className="bg-gradient-to-r from-amber-100 to-yellow-50 p-4 rounded-2xl border border-amber-200 shadow-sm animate-bounce-in relative overflow-hidden">
                                                <button onClick={() => setHideRotationBanner(true)} className="absolute top-2 right-2 text-amber-400 hover:text-amber-600 p-1"><Icon d={PATHS.x} size={14}/></button>
                                                <div className="absolute -right-2 -top-2 text-4xl opacity-20 pointer-events-none">ðŸ”„</div>
                                                <h4 className="font-bold text-amber-800 text-sm mb-1 flex items-center gap-2">
                                                    <span>ðŸ””</span> ì˜¤ëŠ˜ì€ ëª¨ë‘  íšŒì „í•˜ëŠ” ë‚ !
                                                </h4>
                                                <p className="text-xs text-amber-700 mb-3 opacity-90">ì„¤ì •ëœ ìš”ì¼ìž…ë‹ˆë‹¤. ìžì „ê³¼ ê³µì „ì„ ì‹¤í–‰í• ê¹Œìš”?</p>
                                                <Btn onClick={rotateCurrentGroups} className="w-full py-2 bg-amber-500 text-white rounded-xl font-bold text-xs shadow-md hover:bg-amber-600 flex items-center justify-center gap-1 transition-transform active:scale-95"><Icon d={PATHS.check} size={14}/> ì§€ê¸ˆ íšŒì „í•˜ê¸°</Btn>
                                            </div>
                                        )}
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 onClick={handleFormationTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-default select-none"><span className="text-xl">ðŸ§©</span> íŽ¸ì„±</h3>
                                                <Btn onClick={()=>setIsAvoidanceVisible(!isAvoidanceVisible)} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${isAvoidanceVisible ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}><Icon d={PATHS.users} size={14}/> <span>ê´€ê³„ ì„¤ì •</span>{(avoidancePairs.length + mustPairs.length) > 0 && <span className="bg-indigo-500 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-0.5">{avoidancePairs.length + mustPairs.length}</span>}</Btn>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <Btn onClick={() => applyPreset('coop')} className={`flex-col py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${useGender && useSkill && useHistory ? 'bg-indigo-600 text-white shadow-md' : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'}`}>í˜‘ë™ í•™ìŠµ<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì‹¤ë ¥/ì„±ë³„/ê²¹ì¹¨ë°©ì§€</span></Btn>
                                                <Btn onClick={() => applyPreset('peer')} className={`flex-col py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${!useGender && useSkill && !useHistory ? 'bg-green-600 text-white shadow-md' : 'bg-green-50 text-green-700 hover:bg-green-100'}`}>ë˜ëž˜ êµìˆ˜<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì‹¤ë ¥(ìƒ+í•˜) ë§¤ì¹­</span></Btn>
                                                <Btn onClick={() => applyPreset('project')} className={`flex-col py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${useLeader ? 'bg-purple-600 text-white shadow-md' : 'bg-purple-50 text-purple-700 hover:bg-purple-100'}`}>í”„ë¡œì íŠ¸<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ë¦¬ë” ë¶„ì‚° ë°°ì¹˜</span></Btn>
                                                <Btn onClick={() => applyPreset('random')} className={`flex-col py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${!useGender && !useSkill && !useLeader ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>ì™„ì „ ëžœë¤<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì¡°ê±´ ì—†ì´ ì„žê¸°</span></Btn>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useGender ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useGender} onChange={e=>setUseGender(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useGender ? 'text-indigo-700' : 'text-slate-400'}`}>ì„±ë³„ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useSkill ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useSkill} onChange={e=>setUseSkill(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useSkill ? 'text-indigo-700' : 'text-slate-400'}`}>ì‹¤ë ¥ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useLeader ? 'bg-purple-50 border-purple-200 ring-1 ring-purple-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useLeader} onChange={e=>setUseLeader(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useLeader ? 'text-purple-700' : 'text-slate-400'}`}>ðŸ‘‘ ë¦¬ë” ë¶„ì‚°</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useHistory ? 'bg-orange-50 border-orange-200 ring-1 ring-orange-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useHistory} onChange={e=>setUseHistory(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useHistory ? 'text-orange-700' : 'text-slate-400'}`}>ðŸ”„ ê²¹ì¹¨ ë°©ì§€</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useRecentAvoid ? 'bg-rose-50 border-rose-200 ring-1 ring-rose-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useRecentAvoid} onChange={e=>setUseRecentAvoid(e.target.checked)} className="hidden"/><span className={`text-xs font-bold whitespace-nowrap ${useRecentAvoid ? 'text-rose-700' : 'text-slate-400'}`}>ðŸ’” ìµœê·¼ ì§ê¿ í”¼í•˜ê¸°</span></label>
                                                {useHistory && (
                                                    <div className="col-span-2 flex items-center justify-center gap-2 bg-orange-50/50 p-2 rounded-lg border border-orange-100 animate-fade-in">
                                                        <span className="text-[10px] font-bold text-orange-600">ìµœê·¼</span>
                                                        <input type="number" value={historyDuration} onChange={e=>setHistoryDuration(Math.max(1, parseInt(e.target.value) || 1))} className="w-10 p-1 text-center text-xs border border-orange-200 rounded bg-white font-bold text-orange-700 outline-none focus:ring-1 focus:ring-orange-300" />
                                                        <span className="text-[10px] font-bold text-orange-600">ì¼ê°„ì˜ ê¸°ë¡ ì°¸ê³ </span>
                                                    </div>
                                                )}
                                            </div>
                                            {isAvoidanceVisible && (
                                                <div className="mb-6 animate-fade-in bg-slate-50 p-3 rounded-xl">
                                                    <div className="flex bg-white rounded-lg p-1 mb-3 border">
                                                        <button onClick={()=>setPairTab('avoid')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-1 ${pairTab==='avoid'?'bg-rose-50 text-rose-600 shadow-sm ring-1 ring-rose-100':'text-slate-400 hover:bg-slate-50'}`}><span>ðŸš« ê¸°í”¼ ê´€ê³„</span>{avoidancePairs.length > 0 && <span className={`text-[9px] px-1.5 rounded-full ${pairTab==='avoid'?'bg-rose-200 text-rose-700':'bg-slate-200 text-slate-500'}`}>{avoidancePairs.length}</span>}</button>
                                                        <button onClick={()=>setPairTab('must')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-1 ${pairTab==='must'?'bg-green-50 text-green-600 shadow-sm ring-1 ring-green-100':'text-slate-400 hover:bg-slate-50'}`}><span>ðŸ¤ í•„ìˆ˜ ì§ê¿</span>{mustPairs.length > 0 && <span className={`text-[9px] px-1.5 rounded-full ${pairTab==='must'?'bg-green-200 text-green-700':'bg-slate-200 text-slate-500'}`}>{mustPairs.length}</span>}</button>
                                                    </div>
                                                    <div className="flex gap-2 mb-2">
                                                        <select value={p1} onChange={e=>setP1(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500"><option value="">í•™ìƒ1</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <select value={p2} onChange={e=>setP2(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500"><option value="">í•™ìƒ2</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <Btn onClick={()=>{ if(p1&&p2&&p1!==p2){ if(pairTab==='avoid') { const newPairs = [...avoidancePairs,{p1,p2,id:Date.now()}]; setAvoidancePairs(newPairs); if(!isLocalMode) saveData('cls_avoidance', newPairs); } else { const newPairs = [...mustPairs,{p1,p2,id:Date.now()}]; setMustPairs(newPairs); if(!isLocalMode) saveData('cls_mustPairs', newPairs); } setP1(""); setP2(""); } }} className={`text-white px-3 rounded-lg shadow-sm font-bold text-lg ${pairTab==='avoid'?'bg-rose-500 hover:bg-rose-600':'bg-green-500 hover:bg-green-600'}`}>+</Btn>
                                                    </div>
                                                    <div className="flex flex-col gap-2 max-h-40 overflow-y-auto custom-scroll bg-white rounded-lg border border-slate-100 p-2">
                                                        {(pairTab === 'avoid' ? avoidancePairs : mustPairs).length === 0 && <div className="text-center text-xs text-slate-400 py-4">ë“±ë¡ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                        {pairTab === 'avoid' ? avoidancePairs.map(p=>(
                                                            <div key={p.id} className="flex justify-between items-center text-xs bg-rose-50 text-rose-700 px-3 py-2 rounded-lg border border-rose-100">
                                                                <span className="font-bold flex items-center gap-2"><Icon d={PATHS.users} size={12}/> {p.p1} <span className="text-rose-400">â‰ </span> {p.p2}</span>
                                                                <button onClick={()=>{ const newPairs = avoidancePairs.filter(x=>x.id!==p.id); setAvoidancePairs(newPairs); if(!isLocalMode) saveData('cls_avoidance', newPairs); }} className="text-rose-400 hover:text-rose-600 bg-white rounded-full p-0.5"><Icon d={PATHS.x} size={12}/></button>
                                                            </div>
                                                        )) : mustPairs.map(p=>(
                                                            <div key={p.id} className="flex justify-between items-center text-xs bg-green-50 text-green-700 px-3 py-2 rounded-lg border border-green-100">
                                                                <span className="font-bold flex items-center gap-2"><Icon d={PATHS.heart} size={12}/> {p.p1} <span className="text-green-400">=</span> {p.p2}</span>
                                                                <button onClick={()=>{ const newPairs = mustPairs.filter(x=>x.id!==p.id); setMustPairs(newPairs); if(!isLocalMode) saveData('cls_mustPairs', newPairs); }} className="text-green-400 hover:text-green-600 bg-white rounded-full p-0.5"><Icon d={PATHS.x} size={12}/></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-rose-100">
                                                        <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${showAvoidanceLines ? 'bg-rose-100 border-rose-200 text-rose-700' : 'bg-white border-slate-200 text-slate-400'}`}><input type="checkbox" checked={showAvoidanceLines} onChange={e=>setShowAvoidanceLines(e.target.checked)} className="hidden"/><span className="text-xs font-bold">ðŸš« ê¸°í”¼ ê´€ê³„ ì‹œê°í™”</span></label>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="pt-4 border-t mt-4 border-slate-100">
                                                <div className={`flex items-center p-2 rounded-xl border transition-all mb-2 ${!apiKey ? 'bg-slate-50 border-slate-200' : useAI ? 'bg-violet-50 border-violet-200 ring-1 ring-violet-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                    <label className={`flex items-center flex-1 cursor-pointer ${!apiKey ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                                        <div className={`w-4 h-4 rounded-full border flex items-center justify-center mr-2 ${useAI ? 'bg-violet-500 border-violet-500' : 'border-slate-300'}`}>{useAI && <Icon d={PATHS.check} size={10} className="text-white"/>}</div>
                                                        <span className={`text-sm font-bold flex-1 ${useAI ? 'text-violet-700' : 'text-slate-500'}`}>AI ëª¨ë‘  íŽ¸ì„±</span>
                                                        <input type="checkbox" checked={useAI} onChange={e => { if(!apiKey) { setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”."); return; } setUseAI(e.target.checked); }} className="hidden" disabled={!apiKey} />
                                                    </label>
                                                    <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowAiHelp(true); }} className="text-slate-400 hover:text-violet-600 p-2 rounded-full hover:bg-white/50 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16}/></button>
                                                </div>
                                                {useAI && (
                                                <div className="animate-fade-in space-y-2 relative">
                                                        <textarea value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)} className="w-full p-2 border rounded-xl text-xs outline-none focus:border-violet-500 resize-none bg-violet-50/30" placeholder="ì˜ˆ: ë‚¨ë…€ ì„žê³  ìˆ˜í•™ ìž˜í•˜ëŠ” ì¹œêµ¬ ê³¨ê³ ë£¨ ë„£ì–´ì¤˜" rows="2"></textarea>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="space-y-3 mt-4 pt-4 border-t border-slate-100">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs font-bold text-slate-500 flex items-center gap-1">ðŸ“… ìœ ì§€ ê¸°ê°„</span>
                                                    <div className="flex items-center gap-1">
                                                        <select value={groupDuration} onChange={e=>setGroupDuration(parseInt(e.target.value))} className="p-1.5 border rounded-lg text-xs bg-white outline-none font-bold text-slate-700 focus:border-indigo-500 w-24">
                                                            <option value={1}>1ì¼</option>
                                                            <option value={7}>1ì£¼</option>
                                                            <option value={14}>2ì£¼</option>
                                                            <option value={21}>3ì£¼</option>
                                                            <option value={28}>4ì£¼</option>
                                                            {![1, 7, 14, 21, 28].includes(groupDuration) && <option value={groupDuration}>{groupDuration}ì¼</option>}
                                                        </select>
                                                        <Btn onClick={() => setIsRangeCalendarOpen(true)} className="p-1.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200" title="ë‹¬ë ¥ì—ì„œ ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={14}/></Btn>
                                                        {groupDuration > 1 && <Btn onClick={() => setGroupDuration(1)} className="p-1.5 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-100" title="ê¸°ê°„ ì´ˆê¸°í™”"><Icon d={PATHS.x} size={14}/></Btn>}
                                                    </div>
                                                </div>
                                                <div className="text-[10px] text-slate-400 text-right mt-1 font-mono">
                                                    {dayjs(date).format('MM/DD')} ~ {dayjs(date).add(groupDuration-1, 'day').format('MM/DD')} ({groupDuration}ì¼)
                                                </div>
                                                <div className="flex bg-slate-100 p-1 rounded-lg"><Btn onClick={()=>setGroupMethod('count')} className={`flex-1 py-1.5 text-[11px] sm:text-xs font-bold rounded-md whitespace-nowrap ${groupMethod==='count'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ëª¨ë‘  ìˆ˜ ê¸°ì¤€</Btn><Btn onClick={()=>setGroupMethod('size')} className={`flex-1 py-1.5 text-[11px] sm:text-xs font-bold rounded-md whitespace-nowrap ${groupMethod==='size'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ì¸ì› ìˆ˜ ê¸°ì¤€</Btn></div>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={groupNumber} onChange={e=>setGroupNumber(parseInt(e.target.value))} className="flex-1 p-2 border rounded-lg text-center font-bold" min="1" max="20"/>
                                                    <span className="text-sm text-slate-500 shrink-0">{groupMethod==='count'?'ê°œ':'ëª…'}</span>
                                                    <Btn onClick={generateGroups} disabled={isGenerating} className={`w-auto px-4 py-2 rounded-lg font-bold shadow-md text-sm whitespace-nowrap flex items-center gap-2 transition-all ${isGenerating ? 'bg-slate-400 text-slate-100 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}>
                                                        {isGenerating ? (
                                                            <>
                                                                <Icon d={PATHS.spinner} className="animate-spin" size={14} />
                                                                <span>íŽ¸ì„± ì¤‘...</span>
                                                            </>
                                                        ) : (useAI ? 'AI íŽ¸ì„±' : 'ëª¨ë‘  íŽ¸ì„±')}
                                                    </Btn>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 mt-2">
                                                    <Btn onClick={rotateCurrentGroups} className={`py-2.5 border rounded-xl font-bold transition-all relative overflow-hidden ${isRotationDay ? 'bg-amber-50 border-amber-300 text-amber-700 shadow-md ring-2 ring-amber-100' : 'bg-white border-slate-300 text-slate-700'}`}>{isRotationDay && <span className="absolute top-0 right-0 w-2 h-2 bg-amber-500 rounded-full animate-ping"></span>}ìžì „ê³¼ ê³µì „</Btn>
                                                    <Btn onClick={() => setShowGroupResetModal(true)} className="py-2.5 bg-white border border-rose-200 text-rose-500 rounded-xl font-bold">ì´ˆê¸°í™”</Btn>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 transition-all">
                                            <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsGroupToolsOpen(!isGroupToolsOpen)}>
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                                    <span className="text-xl">ðŸ› ï¸</span> ëª¨ë‘  ë„êµ¬
                                                    <button onClick={(e) => { e.stopPropagation(); setShowRoleHelp(true); }} className="text-slate-400 hover:text-indigo-500"><Icon d={PATHS.help} size={16} /></button>
                                                </h3>
                                                <Icon d={isGroupToolsOpen ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                            </div>
                                            {isGroupToolsOpen && (
                                                <div className="mt-4 grid grid-cols-1 gap-2 animate-fade-in">
                                                    <label className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                        <span className={`text-sm font-bold ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'text-indigo-700' : 'text-slate-500'}`}>ëª¨ë‘  ì—­í•  ìžë™ ë¶„ë‹´</span>
                                                        <div className={`w-10 h-6 flex items-center rounded-full p-1 transition-colors ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'translate-x-4' : ''}`}></div></div>
                                                        <input type="checkbox" checked={!!(groupRoles[date] && Object.keys(groupRoles[date]).length > 0)} onChange={(e) => { if(e.target.checked) handleAssignRoles(); else openConfirm("ì—­í•  ë°°ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", handleClearRoles); }} className="hidden" />
                                                    </label>
                                                    <div className="flex gap-2">
                                                        <Btn onClick={() => setIsRoleEditOpen(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-xs sm:text-sm whitespace-nowrap">ì—­í•  ëª©ë¡ ìˆ˜ì •</Btn>
                                                        <Btn onClick={() => setShowPartnerAnalysis(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-xs sm:text-sm whitespace-nowrap">ðŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„</Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className={`flex flex-col md:h-full h-auto gap-4 md:overflow-y-auto custom-scroll pb-10 transition-all duration-300 ${isGroupPanelOpen ? 'md:w-2/3 lg:w-3/4' : 'md:w-full'}`}>
                                        <div id="groups-container" className={`bg-white rounded-2xl border border-slate-200 flex flex-col relative transition-all duration-300 h-auto`}>
                                            <div className="flex justify-between items-center px-4 py-3 border-b border-slate-200 flex-shrink-0 bg-white rounded-t-2xl md:sticky md:top-0 z-10">
                                                <div className="flex items-center gap-2 w-full">
                                                    <Btn onClick={() => setIsGroupPanelOpen(!isGroupPanelOpen)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500">
                                                        <Icon d={isGroupPanelOpen ? PATHS.left : PATHS.right} />
                                                    </Btn>
                                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">ðŸ“… {date} ëª¨ë‘  ({groups.length}ê°œ)</h3>
                                                    {groups.length > 0 && <Btn onClick={handleDownloadGroupsImage} className="ml-auto p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ìž¥"><Icon d={PATHS.download} size={18} /></Btn>}
                                                </div>
                                            </div>
                                            <GroupOverlay groups={groups} avoidancePairs={avoidancePairs} isVisible={showAvoidanceLines} focusedGroupIdx={focusedGroupIdx} />
                                            <div className="p-4" ref={groupsRef}>
                                                {groups.length > 0 ? (
                                                    <div className="flex flex-wrap gap-4 pb-4 items-start">
                                                        {groups.map((g, i) => {
                                                            const groupAvgSkill = g.length > 0 ? g.reduce((a, s) => a + s.skill, 0) / g.length : 0;
                                                            const isSkillImbalanced = g.length > 0 && Math.abs(groupAvgSkill - classAvgSkill) > 0.5;
                                                            const isExpanded = expandedGroupCards[i];
                                                            const MAX_VISIBLE = 2;
                                                            const visibleStudents = (g.length > MAX_VISIBLE && !isExpanded) ? g.slice(0, MAX_VISIBLE) : g;
                                                            const hiddenCount = g.length - MAX_VISIBLE;
                                                            
                                                            // í‰ê·  ì ìˆ˜ ì‹œê°í™” ê³„ì‚°
                                                            const avgScore = groupAvgSkill;
                                                            const scorePercent = ((avgScore - 1) / 2) * 100; // 1~3ì  -> 0~100%
                                                            let scoreColor = "bg-slate-400";
                                                            if (avgScore >= 2.5) scoreColor = "bg-indigo-500";
                                                            else if (avgScore >= 1.8) scoreColor = "bg-indigo-400";
                                                            else scoreColor = "bg-slate-400";

                                                            return (
                                                            <div key={i} className={`group-card bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-4 transition-all hover:shadow-md flex flex-col w-full sm:w-auto flex-grow ${focusedGroupIdx === i ? 'ring-2 ring-rose-400 shadow-md' : ''}`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, i)} onClick={() => setFocusedGroupIdx(prev => prev === i ? null : i)}>
                                                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-50">
                                                                    {editingGroupIdx === i ? (
                                                                        <div className="flex items-center gap-1 w-full max-w-[150px]">
                                                                            <input 
                                                                                className="font-bold text-lg text-slate-800 bg-white border border-indigo-200 rounded px-1 outline-none w-full focus:ring-2 focus:ring-indigo-200"
                                                                                value={editingGroupName}
                                                                                onChange={(e) => setEditingGroupName(e.target.value)}
                                                                                placeholder={`${i+1}ëª¨ë‘ `}
                                                                                autoFocus
                                                                                onKeyDown={(e) => {
                                                                                    if(e.key === 'Enter') {
                                                                                        handleGroupNameSave(i, editingGroupName);
                                                                                    }
                                                                                }}
                                                                                onBlur={() => {
                                                                                    handleGroupNameSave(i, editingGroupName);
                                                                                }}
                                                                            />
                                                                            <Btn onClick={() => handleGroupNameSave(i, editingGroupName)} className="p-1 bg-indigo-100 text-indigo-600 rounded hover:bg-indigo-200"><Icon d={PATHS.check} size={14} /></Btn>
                                                                        </div>
                                                                    ) : (
                                                                        <div className="flex items-center gap-2 group/title">
                                                                            <span className="font-bold text-lg text-slate-800 truncate max-w-[120px]" title={groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}>{groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}</span>
                                                                            <Btn onClick={() => { setEditingGroupIdx(i); setEditingGroupName(groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `); }} className="p-1 text-slate-300 hover:text-indigo-500 transition-colors"><Icon d={PATHS.edit} size={14} /></Btn>
                                                                        </div>
                                                                    )}
                                                                    <div className="flex items-center gap-1">
                                                                        {isSkillImbalanced && (
                                                                            <div className="text-orange-500 flex items-center animate-pulse" title={`ì‹¤ë ¥ ë¶ˆê· í˜• ê²½ê³  (ëª¨ë‘  í‰ê·  ${groupAvgSkill.toFixed(1)} vs ì „ì²´ ${classAvgSkill.toFixed(1)})`}>
                                                                                <Icon d={PATHS.warning} size={16} />
                                                                            </div>
                                                                        )}
                                                                        <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full">{g.length}ëª…</span>
                                                                    </div>
                                                                </div>
                                                                <div className="mb-3 px-1">
                                                                    <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-1"><span>í‰ê·  ì‹¤ë ¥</span><span>{avgScore.toFixed(1)} / 3.0</span></div>
                                                                    <div className="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${scoreColor} transition-all duration-500`} style={{ width: `${Math.max(5, scorePercent)}%` }}></div></div>
                                                                </div>
                                                                <div className="flex flex-col gap-2 flex-1">
                                                                    {visibleStudents.map((s, sIdx) => {
                                                                        const isLocked = lockedIds.includes(s.id);
                                                                        // ìžë¦¬(Index) ê¸°ì¤€ ì—­í•  ì¡°íšŒ (ì—†ìœ¼ë©´ í•™ìƒ ID ê¸°ì¤€ ë ˆê±°ì‹œ ë°ì´í„° ì¡°íšŒ ì‹œë„)
                                                                        const role = groupRoles[date]?.[i]?.[sIdx] || groupRoles[date]?.[i]?.[s.id];
                                                                        return (
                                                                            <div key={s.id} data-student-name={s.name} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, i)} onDragEnd={handleDragEnd} className={`flex items-center justify-between p-2 rounded-2xl border transition-all cursor-grab active:cursor-grabbing touch-none ${s.gender === 'M' ? 'bg-blue-50/50 border-blue-100 hover:bg-blue-50' : 'bg-pink-50/50 border-pink-100 hover:bg-pink-50'} ${isLocked ? 'ring-2 ring-indigo-400 shadow-sm' : ''}`}>
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full ${s.gender==='M'?'bg-blue-200 text-blue-700':'bg-pink-200 text-pink-700'}`}>{s.order}</span>
                                                                                    <span className="text-sm font-bold text-slate-700 whitespace-nowrap">{s.name}</span>
                                                                                    {s.leader && <span className="text-xs" title="ë¦¬ë”">ðŸ‘‘</span>}
                                                                                    <span onClick={(e) => { e.stopPropagation(); setEditingRoleTarget({ gIdx: i, sIdx, currentRole: role }); }} className={`text-[10px] px-1.5 py-0.5 rounded border cursor-pointer hover:bg-indigo-50 transition-colors ${role ? 'bg-white/80 border-slate-200 text-slate-600' : 'bg-slate-50 border-dashed border-slate-300 text-slate-300 hover:text-indigo-400 hover:border-indigo-300'}`} title="ì—­í•  ìˆ˜ì •">{role || "+"}</span>
                                                                                </div>
                                                                                <button onClick={(e) => { e.stopPropagation(); toggleLock(s.id); }} className={`p-1 rounded-full hover:bg-white/50 transition-colors ${isLocked ? 'text-indigo-500' : 'text-slate-300 hover:text-slate-400'}`} title={isLocked ? "ê³ ì • í•´ì œ" : "ê³ ì •í•˜ê¸°"}>
                                                                                    <Icon d={isLocked ? PATHS.lock : PATHS.unlock} size={12} />
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                    {g.length > MAX_VISIBLE && (
                                                                        <button 
                                                                            onClick={(e) => { e.stopPropagation(); setExpandedGroupCards(prev => ({...prev, [i]: !prev[i]})); }}
                                                                            className="w-full py-2 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors flex items-center justify-center gap-1 mt-1"
                                                                        >
                                                                            {isExpanded ? <>ì ‘ê¸° <Icon d={PATHS.down} size={12} className="rotate-180"/></> : <>+{hiddenCount}ëª… ë” ë³´ê¸° <Icon d={PATHS.down} size={12}/></>}
                                                                        </button>
                                                                    )}
                                                                    {g.length === 0 && (
                                                                        <div className="flex-1 flex items-center justify-center text-slate-300 text-xs border-2 border-dashed border-slate-100 rounded-xl min-h-[60px]">ë¹ˆ ëª¨ë‘ </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ); })}
                                                    </div>
                                                ) : (
                                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-4">
                                                        <Icon d={PATHS.users} size={48} className="opacity-20"/>
                                                        <p>íŽ¸ì„±ëœ ëª¨ë‘  ì—†ìŒ</p>
                                                        <div className="flex gap-2">
                                                            <Btn onClick={loadLastGroups} className="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 shadow-sm flex items-center gap-2 transition-all active:scale-95">
                                                                <Icon d={PATHS.history} size={16}/> ì§€ë‚œ ëª¨ë‘ 
                                                            </Btn>
                                                            <Btn onClick={() => setIsLoadGroupCalendarOpen(true)} className="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 shadow-sm flex items-center gap-2 transition-all active:scale-95">
                                                                <Icon d={PATHS.calendar} size={16}/> ë‚ ì§œ ì„ íƒ
                                                            </Btn>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        {groups.length > 0 && (
                                            <div className="h-auto flex-shrink-0 transition-all duration-300">
                                                {aiReason && (
                                                    <div className="bg-violet-50 p-4 rounded-2xl border border-violet-100 mb-4 animate-fade-in relative shadow-sm">
                                                        <button onClick={() => setAiReason(null)} className="absolute top-2 right-2 text-violet-300 hover:text-violet-500 p-1"><Icon d={PATHS.x} size={14}/></button>
                                                        <h4 className="font-bold text-violet-700 mb-2 flex items-center gap-2 text-sm"><Icon d={PATHS.magic} size={16}/> {useAI ? "AI íŽ¸ì„± ë¦¬í¬íŠ¸" : "íŽ¸ì„± ê²°ê³¼ ë¦¬í¬íŠ¸"}</h4>
                                                        <p className="text-xs text-violet-800 leading-relaxed whitespace-pre-wrap mb-3">{aiReason}</p>
                                                        <div className="flex justify-end gap-2 border-t border-violet-200/50 pt-3">
                                                            <Btn onClick={generateGroups} disabled={isGenerating} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm">
                                                                {isGenerating ? <Icon d={PATHS.spinner} size={12} className="animate-spin"/> : <Icon d={PATHS.magic} size={12}/>} ë‹¤ì‹œ íŽ¸ì„±
                                                            </Btn>
                                                            <div className="w-px h-6 bg-violet-200 mx-1"></div>
                                                            <Btn onClick={handleCopyAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.copy} size={12}/> ë³µì‚¬</Btn>
                                                            <Btn onClick={handleSaveAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.download} size={12}/> ì €ìž¥</Btn>
                                                        </div>
                                                    </div>
                                                )}
                                                <BalanceVisualizer groups={groups} students={students} groupNames={groupNames} date={date} />
                                            </div>
                                        )}
                                        <SeatChart students={students} seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments} seatConfig={seatConfig} setSeatConfig={setSeatConfig} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} groups={groups} onGroupsChange={handleGroupsChange} groupNumber={groupNumber} groupMethod={groupMethod} roleMap={roleMap} onOpenStudentInfo={(id) => setGrassStudentId(id)} />
                                    </div>
                                </div>
                            )}
                            {mode === 'stats' && (
                                <div className="max-w-5xl mx-auto space-y-6 animate-fade-in pb-10">
                                <div className="flex justify-end items-center gap-2">
                                    <Btn onClick={() => setShowWeeklyBriefing(true)} disabled={isGenerating} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'} ${isGenerating ? 'opacity-50' : ''}`}>
                                        <Icon d={PATHS.magic} size={16} /> AI ì£¼ê°„ ë¸Œë¦¬í•‘
                                    </Btn>
                                    <button onClick={(e) => { e.stopPropagation(); setShowBriefingHelp(true); }} className="text-slate-400 hover:text-indigo-500 p-2 rounded-full hover:bg-slate-100 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={20} /></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ðŸ†</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ðŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><div className="flex items-center gap-2"><div className="relative"><select value={honorTag} onChange={(e) => setHonorTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={honorPeriod} onChange={setHonorPeriod} /></div></div></div><div className="space-y-3">{stats.top5.map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-yellow-50/50 rounded-xl border border-yellow-100"><div className="flex items-center gap-3"><span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${i===0?'bg-yellow-500 text-white':i===1?'bg-slate-400 text-white':i===2?'bg-orange-400 text-white':'bg-slate-200 text-slate-500'}`}>{i+1}</span><span className="font-bold text-slate-700">{s.name}</span></div><span className="font-bold text-indigo-600">{s.honorStats.count}íšŒ</span></div>))}{stats.top5.length === 0 && <div className="text-center text-slate-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div>
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ðŸ“£</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ðŸ“£ ë„ì›€ì´ í•„ìš”í•´ìš”</h3><div className="flex items-center gap-2"><div className="relative"><select value={helpTag} onChange={(e) => setHelpTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={helpPeriod} onChange={setHelpPeriod} /></div></div></div><div className="space-y-3">{stats.bottom5.filter(s => s.helpStats.rate < 100).map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-rose-50/50 rounded-xl border border-rose-100"><div className="flex items-center gap-3"><span className="font-bold text-slate-700">{s.name}</span></div><div className="flex items-center gap-2"><div className="w-24 h-2 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-rose-400" style={{width:`${s.helpStats.rate}%`}}></div></div><span className="font-bold text-rose-500 text-sm">{Math.round(s.helpStats.rate)}%</span></div></div>))}{stats.bottom5.filter(s => s.helpStats.rate < 100).length === 0 && <div className="text-center text-slate-400 py-4">ëª¨ë‘ ìž˜í•˜ê³  ìžˆì–´ìš”! ðŸŽ‰</div>}</div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <MissingView students={students} records={records} dailyTasks={dailyTasks} />
                                    <StickerAutomationView students={students} records={records} dailyTasks={dailyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} setStudents={setStudents} />
                                </div>
                                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden mt-6">
                                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ðŸŒ±</div>
                                    <div className="flex justify-between items-center mb-6 relative z-10">
                                        <h3 onClick={handleGrassTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-pointer select-none"><span className="text-xl">ðŸŒ±</span> í™œë™ ìž”ë”” (30ì¼)</h3>
                                        <Btn onClick={handleExportDrafts} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1 shadow-sm transition-transform active:scale-95">
                                            <Icon d={PATHS.upload} size={14} /> ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸°
                                        </Btn>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 relative z-10">{stats.students.map(s => (<div key={s.id} onClick={() => setGrassStudentId(s.id)} className="flex items-center gap-3 p-2 bg-slate-50 border border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 hover:shadow-sm transition-all group"><div className="w-8 h-8 rounded-full bg-white border flex items-center justify-center font-bold text-xs text-slate-500 overflow-hidden">{s.photo ? <img src={s.photo} className="w-full h-full object-cover" alt={s.name} /> : s.order}</div><div className="flex flex-col min-w-0"><span className="text-sm font-bold text-slate-700 truncate">{s.name}</span><div className="flex gap-0.5 mt-1">{s.history.slice(0,5).map((h,i) => (<div key={i} className="w-2 h-2 rounded-full" style={h.ratio > 0 ? { background: `conic-gradient(#4ade80 0% ${h.ratio*100}%, #e2e8f0 ${h.ratio*100}% 100%)` } : { backgroundColor: '#e2e8f0' }}></div>))}</div></div></div>))}</div>
                                </div>
                                </div>
                            )}
                        </div>
                        <footer onClick={() => setShowUpdateNotes(true)} className="md:hidden text-center py-3 text-[10px] text-slate-400 cursor-pointer hover:text-indigo-500 transition-colors bg-slate-50 border-t border-slate-200 -mx-4 mt-4">{CURRENT_VERSION} | spk </footer>
                    </main>
                    <footer onClick={() => setShowUpdateNotes(true)} className="hidden md:block text-center py-2 text-xs text-slate-400 bg-slate-50 hover:bg-slate-100 border-t border-slate-200 cursor-pointer hover:text-indigo-500 transition-colors">{CURRENT_VERSION} | Visual Studio Code With Gemini</footer>
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-30 pb-safe">
                        <div className="flex justify-around items-center h-14">
                            {[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (
                                <button key={m.id} onClick={()=>setMode(m.id)} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mode===m.id ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                    <div className={`p-1 rounded-xl transition-all ${mode===m.id ? 'bg-indigo-50 transform -translate-y-1' : ''}`}><Icon d={m.icon} size={20} strokeWidth={mode===m.id?2.5:2} /></div>
                                    <span className={`text-[10px] font-bold mt-0.5 ${mode===m.id ? 'text-indigo-600' : 'text-slate-400'}`}>{m.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        message={confirmModal.message} 
                        onConfirm={() => { 
                            const action = confirmModal.onConfirm;
                            setConfirmModal({isOpen:false, message:"", onConfirm:null}); 
                            if(action) action();
                        }} 
                        onCancel={() => {
                            const action = confirmModal.onCancel;
                            setConfirmModal({isOpen:false, message:"", onConfirm:null, onCancel:null});
                            if(action) action();
                        }} 
                    />
                    {appConfig.updateNotificationType === 'toast' ? (
                        <UpdateNotificationToast
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    ) : (
                        <UpdateNotificationModal
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    )}
                    {/* ðŸŒŸ íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ì°½ */}
            {showTutorial && (
                <div className="fixed inset-0 bg-black/60 z-[6000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-pop-up flex flex-col">
                        {/* ìƒë‹¨ í”„ë¡œê·¸ë ˆìŠ¤ ë°” */}
                        <div className="flex gap-1 p-4 bg-slate-50 border-b border-slate-100">
                            {tutorialSlides.map((_, idx) => (
                                <div key={idx} className={`h-1.5 flex-1 rounded-full transition-colors duration-300 ${idx <= tutorialStep ? 'bg-indigo-500' : 'bg-slate-200'}`} />
                            ))}
                        </div>
                        
                        {/* ìŠ¬ë¼ì´ë“œ ë‚´ìš© */}
                        <div className="p-8 text-center flex-1 flex flex-col justify-center min-h-[250px]">
                            <div className="text-6xl mb-4 animate-bounce">{tutorialSlides[tutorialStep].emoji}</div>
                            <h3 className="text-xl font-black text-slate-800 mb-3 break-keep">{tutorialSlides[tutorialStep].title}</h3>
                            <p className="text-slate-600 text-sm leading-relaxed break-keep">{tutorialSlides[tutorialStep].desc}</p>
                        </div>
                        
                        {/* í•˜ë‹¨ ë²„íŠ¼ */}
                        <div className="p-4 bg-slate-50 flex items-center justify-between border-t border-slate-100">
                            <button 
                                onClick={() => setShowTutorial(false)} 
                                className="text-slate-400 hover:text-slate-600 text-sm font-bold px-3 py-2"
                            >
                                ê±´ë„ˆë›°ê¸°
                            </button>
                            <div className="flex gap-2">
                                {tutorialStep > 0 && (
                                    <button 
                                        onClick={() => setTutorialStep(prev => prev - 1)} 
                                        className="px-4 py-2 rounded-xl bg-white text-slate-600 font-bold border border-slate-200 hover:bg-slate-50 shadow-sm"
                                    >
                                        ì´ì „
                                    </button>
                                )}
                                {tutorialStep < tutorialSlides.length - 1 ? (
                                    <button 
                                        onClick={() => setTutorialStep(prev => prev + 1)} 
                                        className="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-md transition-colors"
                                    >
                                        ë‹¤ìŒ
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => setShowTutorial(false)} 
                                        className="px-6 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold hover:from-indigo-700 hover:to-purple-700 shadow-md transition-all transform hover:scale-105"
                                    >
                                        ì‹œìž‘í•˜ê¸°!
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}
                    <Toast message={toastMessage} action={toastAction} onClose={()=>{ setToastMessage(null); setToastAction(null); }} />
                    <StatsGrassModal 
                        isOpen={!!grassStudentId} 
                        onClose={()=>setGrassStudentId(null)} 
                        student={stats.students.find(s=>s.id===grassStudentId)} 
                        students={students}
                        records={records} 
                        dates={Object.keys(records).sort()} 
                        dailyTasks={dailyTasks} 
                        onSaveCounseling={handleSaveCounseling} 
                        onSaveStickers={handleSaveStickers} 
                        onSaveStickerWithNote={handleSaveStickerWithNote} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        appConfig={appConfig} 
                        apiKey={apiKey} 
                        onSaveRecordDraft={handleSaveRecordDraft}
                        isLocalMode={isLocalMode}
                        db={db}
                        appId={appId}
                        isPortfolioMode={isPortfolioMode}
                        setStudents={setStudents}
                        saveData={saveData}
                        onSwitchStudent={(id) => setGrassStudentId(id)} />
                    <SettingsModal 
                        isOpen={isSettingOpen} 
                        onClose={()=>setIsSettingOpen(false)} 
                        students={students} 
                        setStudents={setStudents} 
                        appConfig={appConfig} 
                        setAppConfig={setAppConfig} 
                        isLocalMode={isLocalMode} 
                        saveData={saveData} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        handleResetAllData={handleResetAllData} 
                        onOpenSetup={() => setIsSetupOpen(true)}
                        onOpenNotionSetup={() => setIsNotionSetupOpen(true)}
                        onOpenGoogleSheetSetup={() => setIsGoogleSheetSetupOpen(true)}
                        onOpenApiKeySetup={() => setIsApiKeySetupOpen(true)}
                        records={records} 
                        groupsByDate={groupsByDate} 
                        avoidancePairs={avoidancePairs} 
                        dailyTasks={dailyTasks} 
                        weeklyTasks={weeklyTasks} 
                        tags={tags} 
                        setRecords={setRecords} 
                        setGroupsByDate={setGroupsByDate} 
                        setAvoidancePairs={setAvoidancePairs} 
                        setDailyTasks={setDailyTasks} 
                        setWeeklyTasks={setWeeklyTasks} 
                        setTags={setTags} 
                        backupTimes={backupTimes} 
                        setBackupTimes={setBackupTimes} 
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                        mustPairs={mustPairs} setMustPairs={setMustPairs}
                        groupNames={groupNames} setGroupNames={setGroupNames}
                        groupRoles={groupRoles} setGroupRoles={setGroupRoles}
                        rolesList={rolesList} setRolesList={setRolesList}
                        roleDescriptions={roleDescriptions} setRoleDescriptions={setRoleDescriptions}
                        seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments}
                        seatConfig={seatConfig} setSeatConfig={setSeatConfig}
                        db={db}
                        appId={appId}
                        deferredPrompt={deferredPrompt}
                        isIOS={isIOS}
                        isStandalone={isStandalone}
                        onInstallApp={handleInstallApp}
                        isDevMode={isDevMode}
                        onDevModeClick={handleGearClick}
                        onTestUpdate={() => setNewVersionAvailable(true)}
                    />
                    <NotionSetupModal isOpen={isNotionSetupOpen} onClose={() => setIsNotionSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} isPortfolioMode={isPortfolioMode} setIsPortfolioMode={setIsPortfolioMode} studentMap={studentMap} setStudentMap={setStudentMap} portfolioDbId={portfolioDbId} setPortfolioDbId={setPortfolioDbId} />
                    <AllRecordsModal isOpen={showAllRecords} onClose={() => setShowAllRecords(false)} students={students} appConfig={appConfig} onLoadAllData={handleLoadAllData} />
                    <GoogleSheetSetupModal isOpen={isGoogleSheetSetupOpen} onClose={() => setIsGoogleSheetSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} />
                    <ApiKeySetupModal isOpen={isApiKeySetupOpen} onClose={() => setIsApiKeySetupOpen(false)} apiKey={apiKey} setApiKey={setApiKey} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} validateApiKey={validateApiKey} />
                    <InstallGuideModal isOpen={showInstallGuide} onClose={() => setShowInstallGuide(false)} onInstall={confirmInstall} isIOS={isIOS} />
                    <TaskModal isOpen={isTaskModalOpen} onClose={()=>setIsTaskModalOpen(false)} date={date} dailyTasks={dailyTasks} setDailyTasks={setDailyTasks} weeklyTasks={weeklyTasks} setWeeklyTasks={setWeeklyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} tags={tags} setTags={setTags} openConfirm={openConfirm} />
                    <CalendarModal isOpen={isCalendarOpen} onClose={()=>setIsCalendarOpen(false)} currentDate={date} onSelectDate={setDate} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <CalendarModal isOpen={isRangeCalendarOpen} onClose={()=>setIsRangeCalendarOpen(false)} currentDate={date} selectionMode="range" onSelectRange={handleRangeSelect} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <CalendarModal isOpen={isLoadGroupCalendarOpen} onClose={()=>setIsLoadGroupCalendarOpen(false)} currentDate={date} onSelectDate={loadGroupsFromDate} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode="group" />
                    <RoleHelpModal isOpen={showRoleHelp} onClose={()=>setShowRoleHelp(false)} roleDescriptions={roleDescriptions} />
                    <RoleEditModal isOpen={isRoleEditOpen} onClose={() => setIsRoleEditOpen(false)} roles={rolesList} onSave={handleSaveRoles} roleDescriptions={roleDescriptions} onSaveDescriptions={handleSaveRoleDescriptions} />
                    <RoleSelectModal isOpen={!!editingRoleTarget} onClose={() => setEditingRoleTarget(null)} roles={rolesList} currentRole={editingRoleTarget?.currentRole} onSelect={(newRole) => handleRoleChange(editingRoleTarget.gIdx, editingRoleTarget.sIdx, newRole)} />
                    <PartnerAnalysisModal isOpen={showPartnerAnalysis} onClose={()=>setShowPartnerAnalysis(false)} groupsByDate={groupsByDate} />
                    <GroupResetModal isOpen={showGroupResetModal} onClose={() => setShowGroupResetModal(false)} onReset={handleGroupReset} />
                    <ClassToolsModal isOpen={isToolsOpen} onClose={() => setIsToolsOpen(false)} students={students} />
                    <BaseModal isOpen={showAiHelp} onClose={()=>setShowAiHelp(false)} title="AI ëª¨ë‘  íŽ¸ì„± ë„ì›€ë§" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">
                            <p><strong>ì‚¬ìš© ë°©ë²•:</strong><br/>ì›í•˜ëŠ” ëª¨ë‘  êµ¬ì„± ì¡°ê±´ì„ ìžìœ ë¡­ê²Œ ìž…ë ¥í•˜ì„¸ìš”.</p>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <strong>ðŸ’¡ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ</strong>
                                <ul className="list-disc pl-4 mt-2 space-y-1">
                                    <li>ë‚¨ë…€ ì„±ë¹„ë¥¼ ë¹„ìŠ·í•˜ê²Œ ë§žì¶°ì¤˜</li>
                                    <li>ë¦¬ë”(ì´ë„ë¯¸)ê°€ ê° ëª¨ë‘ ì— í•œ ëª…ì”© ë“¤ì–´ê°€ê²Œ í•´ì¤˜</li>
                                    <li>ìˆ˜í•™ ì‹¤ë ¥ì´ ìƒ/ì¤‘/í•˜ ê³¨ê³ ë£¨ ì„žì´ê²Œ í•´ì¤˜</li>
                                    <li>íŠ¹ì • í•™ìƒ(ì˜ˆ: ì² ìˆ˜, ì˜í¬)ì€ ê°™ì€ ëª¨ë‘ ì´ ë˜ì§€ ì•Šê²Œ í•´ì¤˜</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Weekly Briefing Modal */}
                    <BaseModal isOpen={showWeeklyBriefing} onClose={() => setShowWeeklyBriefing(false)} title="ðŸ“Š AI ì£¼ê°„ ë¸Œë¦¬í•‘" icon={PATHS.magic}>
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                        <input type="date" value={briefingStart} onChange={e=>setBriefingStart(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                        <span className="text-xs text-slate-400">~</span>
                                        <input type="date" value={briefingEnd} onChange={e=>setBriefingEnd(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¸Œë¦¬í•‘ ì–´ì¡°:</span>
                                        <div className="flex bg-white rounded-lg border border-slate-200 p-1 flex-1">
                                            <button onClick={()=>setBriefingTone('encouraging')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='encouraging'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ðŸ¥° ê²©ë ¤</button>
                                            <button onClick={()=>setBriefingTone('analytical')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='analytical'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ðŸ“Š ë¶„ì„</button>
                                            <button onClick={()=>setBriefingTone('concise')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='concise'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>âš¡ ê°„ê²°</button>
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateBriefing} className="w-full py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ë¸Œë¦¬í•‘ ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-4">
                                    <div className="w-full max-w-xs bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div className="bg-indigo-500 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${generationProgress}%` }}></div>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm font-bold text-indigo-600">
                                        <Icon d={PATHS.spinner} size={16} className="animate-spin"/>
                                        <span>ë°ì´í„° ë¶„ì„ ì¤‘... {Math.round(generationProgress)}%</span>
                                    </div>
                                </div>
                            ) : aiContent && (
                                <div ref={briefingRef} className="bg-slate-50 p-6 rounded-2xl border border-slate-200 leading-relaxed whitespace-pre-wrap text-slate-700">
                                    {aiContent || "ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={() => setAiContent("")} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ë‹¤ì‹œ í•˜ê¸°</Btn>
                                        <Btn onClick={handleDownloadBriefingPdf} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.download} size={16} /> PDF
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.copy} size={16} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowWeeklyBriefing(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Briefing Help Modal */}
                    <BaseModal isOpen={showBriefingHelp} onClose={() => setShowBriefingHelp(false)} title="AI ì£¼ê°„ ë¸Œë¦¬í•‘ì´ëž€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì„ íƒí•œ ê¸°ê°„ ë™ì•ˆì˜ í•™ê¸‰ ê¸°ë¡(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ì„ ë¶„ì„í•˜ì—¬ <strong>í•™ê¸‰ ìš´ì˜ì— ë„ì›€ì´ ë˜ëŠ” ì¸ì‚¬ì´íŠ¸</strong>ë¥¼ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ìž…ë‹ˆë‹¤.</p>
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <h4 className="font-bold text-indigo-700 mb-2">âœ¨ ì£¼ìš” ê¸°ëŠ¥ ë° í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>ê¸°ê°„ ì„¤ì •:</strong> ì›í•˜ëŠ” ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ê°„, ì›”ê°„, ë˜ëŠ” íŠ¹ì • ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>í•™ìŠµ ë¶„ìœ„ê¸° íŒŒì•…:</strong> ì „ì²´ì ì¸ ê³¼ì œ ìˆ˜í–‰ë¥  ì¶”ì„¸ë¥¼ í†µí•´ í•™ê¸‰ ë¶„ìœ„ê¸°ê°€ ì–´ë–»ê²Œ ë³€í™”í•˜ê³  ìžˆëŠ”ì§€ í•œëˆˆì— ì•Œ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>ë§žì¶¤í˜• ì¡°ì–¸:</strong> ë°ì´í„° ë¶„ì„ì„ í†µí•´ ì„ ìƒë‹˜ì—ê²Œ í•„ìš”í•œ ê²©ë ¤ì™€ êµ¬ì²´ì ì¸ í•™ê¸‰ ìš´ì˜ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ðŸ“– ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°" icon={PATHS.book} zIndex="z-[2000]">
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 space-y-3">
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold text-purple-700">ìž¥ë¥´ ì„ íƒ:</span>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                            {[
                                                {id:'school', emoji:'ðŸ«', label:'í•™êµ'},
                                                {id:'growth', emoji:'ðŸŒ±', label:'ì„±ìž¥'},
                                                {id:'friendship', emoji:'ðŸ¤', label:'ìš°ì •'},
                                                {id:'funny', emoji:'ðŸ˜„', label:'ìœ ë¨¸'},
                                                {id:'lesson', emoji:'ðŸ’¡', label:'êµí›ˆ'}
                                            ].map(g => (
                                                <button key={g.id} onClick={()=>setStoryGenre(g.id)} className={`flex flex-col items-center justify-center py-3 rounded-xl border-2 transition-all ${storyGenre===g.id?'bg-purple-50 border-purple-500 text-purple-700 shadow-md scale-105':'bg-white border-transparent hover:bg-purple-50 hover:border-purple-200 text-slate-500'}`}>
                                                    <span className="text-2xl mb-1">{g.emoji}</span>
                                                    <span className="text-xs font-bold">{g.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateStory} className="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold hover:shadow-lg transition-all text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ì´ì•¼ê¸° ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìžˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : aiContent && (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2 flex-wrap">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={handleGenerateStory} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200 flex items-center gap-1">
                                            <Icon d={PATHS.magic} size={14} /> ë‹¤ì‹œ ì“°ê¸°
                                        </Btn>
                                        <Btn onClick={() => setAiContent("")} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">
                                            ë‹¤ë¥¸ ìž¥ë¥´ë¡œ
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ìŠ¤í† ë¦¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-1">
                                            <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowClassStory(false)} className="px-3 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ðŸ° í•™ê¸‰ ì„¸ê³„ê´€ ìŠ¤í† ë¦¬" icon={PATHS.book}>
                        <div className="space-y-4">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ëª¨í—˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìžˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                <Btn onClick={handleGenerateStory} disabled={isGenerating} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200">ë‹¤ì‹œ ì“°ê¸°</Btn>
                                <Btn onClick={() => setShowClassStory(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>
                    
                    {/* Story Help Modal */}
                    <BaseModal isOpen={showStoryHelp} onClose={() => setShowStoryHelp(false)} title="ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°ëž€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì˜¤ëŠ˜ í•˜ë£¨ ìš°ë¦¬ ë°˜ì˜ í™œë™ ë°ì´í„°(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ <strong>ë”°ëœ»í•œ í•™ê¸‰ ì´ì•¼ê¸°</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ê¸°ëŠ¥ìž…ë‹ˆë‹¤.</p>
                            
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-slate-700 mb-2">ðŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
                                <ol className="list-decimal pl-5 space-y-1">
                                    <li>ì˜¤ëŠ˜ì˜ ê³¼ì œ ì²´í¬ì™€ ìŠ¤í‹°ì»¤ ì§€ê¸‰ì„ ì™„ë£Œí•©ë‹ˆë‹¤.</li>
                                    <li><strong>'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ìŠ¤í† ë¦¬ ë³´ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                                    <li>AIê°€ ìž‘ì„±í•œ ìš°ë¦¬ ë°˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ í•¨ê»˜ ì½ìŠµë‹ˆë‹¤.</li>
                                </ol>
                            </div>

                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <h4 className="font-bold text-purple-700 mb-2">âœ¨ í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li>í•˜êµ ì‹œê°„ì— ì•„ì´ë“¤ê³¼ í•¨ê»˜ ì½ìœ¼ë©° í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•´ìš”.</li>
                                    <li>ê³¼ì œ ìˆ˜í–‰ë¥ ì´ ë†’ìœ¼ë©´ 'ì„±ì·¨ê° ìžˆëŠ” ì´ì•¼ê¸°'ê°€, ë‚®ìœ¼ë©´ 'ê²©ë ¤ì˜ ì´ì•¼ê¸°'ê°€ ë‚˜ì˜µë‹ˆë‹¤.</li>
                                    <li>ì•„ì´ë“¤ì´ í•˜ë£¨ë¥¼ ë˜ëŒì•„ë³´ê³  ë‚´ì¼ì„ ê¸°ëŒ€í•˜ê²Œ ë„ì™€ì¤ë‹ˆë‹¤.</li>
                                </ul>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h4 className="font-bold text-slate-700 mb-2">ðŸ“œ ì´ì•¼ê¸° ì˜ˆì‹œ</h4>
                                <p className="italic text-slate-500 text-xs bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">
                                    "ì˜¤ëŠ˜ ìš°ë¦¬ 3í•™ë…„ 2ë°˜ ì¹œêµ¬ë“¤ì€ 'ìˆ˜í•™ ìµíž˜ì±…'ì´ë¼ëŠ” ìž‘ì€ ë„ì „ì„ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤. ì²˜ìŒì—ëŠ” ì–´ë ¤ì›Œí•˜ëŠ” ì¹œêµ¬ë“¤ë„ ìžˆì—ˆì§€ë§Œ, ì„œë¡œ ë•ê³  ê²©ë ¤í•˜ë©° 95%ì˜ ê³¼ì œ ë‹¬ì„±ë¥ ì„ ê¸°ë¡í–ˆë‹µë‹ˆë‹¤! ì˜¤ëŠ˜ ìš°ë¦¬ê°€ í•¨ê»˜ ëª¨ì€ ì¹­ì°¬ ìŠ¤í‹°ì»¤ëŠ” ì´ 15ê°œ! ì¹œêµ¬ë“¤ì€ ë¿Œë“¯í•œ ë§ˆìŒì„ ì•ˆê³ , ë‚´ì¼ ë˜ ë§Œë‚  ì¦ê±°ìš´ í•™êµ ìƒí™œì„ ê¸°ëŒ€í•˜ë©° ì§‘ìœ¼ë¡œ í–¥í–ˆìŠµë‹ˆë‹¤."
                                </p>
                            </div>
                        </div>
                    </BaseModal>
                    
                        <SetupModal 
                        isOpen={isSetupOpen} 
                        onClose={() => setIsSetupOpen(false)} 
                        showToast={setToastMessage} 
                        onConnect={handleFirebaseConnect} 
                    />
                    <BaseModal isOpen={showOfflineModal} onClose={() => setShowOfflineModal(false)} title="ì¤€ë¹„ ì™„ë£Œ!" icon={PATHS.check}>
                        <div className="text-center space-y-4 py-4">
                            <div className="text-6xl animate-bounce">ðŸ‘Œ</div>
                            <h3 className="text-lg font-bold text-slate-800">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</h3>
                            <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-sm text-indigo-700">
                                ì´ì œ ì¸í„°ë„·ì„ ëŠì–´ë„ ë©ë‹ˆë‹¤.<br/>(ìƒˆë¡œê³ ì¹¨ ê¸ˆì§€)
                            </div>
                        </div>
                        <Btn onClick={() => setShowOfflineModal(false)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mt-2">
                            í™•ì¸ ({autoCloseTimer}ì´ˆ í›„ ë‹«íž˜)
                        </Btn>
                    </BaseModal>
                    <UpdateNotesModal isOpen={showUpdateNotes} onClose={() => setShowUpdateNotes(false)} showToast={setToastMessage} notes={UPDATE_NOTES} />
                    {showGlobalRecord && (
                        <GlobalRecordModal isOpen={showGlobalRecord} onClose={()=>setShowGlobalRecord(false)} students={students} setStudents={setStudents} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} buttonPos={buttonPos} appConfig={appConfig} db={db} appId={appId} />
                    )}
                    <AiSecurityCheckModal isOpen={aiCheckState.isOpen} onClose={handleAiCheckCancel} prompt={aiCheckState.prompt} onConfirm={handleAiCheckConfirm} />
                    <button 
                        onMouseEnter={() => { setIsHidden(false); if(hideTimer.current) clearTimeout(hideTimer.current); }}
                        onMouseDown={handleButtonDragStart}
                        onTouchStart={handleButtonDragStart}
                        onDoubleClick={() => {
                            setButtonPos({ x: window.innerWidth - 80, y: window.innerHeight - 80 });
                            setIsHidden(false);
                        }}
                        onClick={() => { if (!isDragGesture.current) { setShowGlobalRecord(true); resetButtonIdleTimer(); } }}
                        style={{ 
                            left: buttonPos.x, 
                            top: buttonPos.y,
                            transform: isHidden ? (buttonPos.x < window.innerWidth / 2 ? 'translateX(-50px)' : 'translateX(50px)') : 'none'
                        }}
                        className={`fixed z-[1500] ${appConfig.floatingButtonSize === 'small' ? 'w-10 h-10' : appConfig.floatingButtonSize === 'large' ? 'w-16 h-16' : appConfig.floatingButtonSize === 'xlarge' ? 'w-20 h-20' : 'w-14 h-14'} bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center group ${isDraggingButton ? '' : 'transition-all duration-300 hover:bg-indigo-700 hover:scale-105'} ${isHidden ? 'opacity-50' : (isButtonIdle ? 'opacity-30 hover:opacity-100' : 'opacity-100')}`}
                        title="ë¹ ë¥¸ ê´€ì°° ê¸°ë¡"
                    >
                        <Icon d={PATHS.edit} size={appConfig.floatingButtonSize === 'small' ? 20 : appConfig.floatingButtonSize === 'large' ? 28 : appConfig.floatingButtonSize === 'xlarge' ? 36 : 24} />
                        <span className={`absolute bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none ${buttonPos.x < window.innerWidth / 2 ? 'left-full ml-3' : 'right-full mr-3'}`}>ë¹ ë¥¸ ê¸°ë¡</span>
                    </button>
                </div>
            );
        };

        const SwitchToggle = ({ value, onChange }) => (
                <>
                    <div className="md:hidden relative">
                        <select value={value} onChange={(e) => onChange(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">
                            <option value="weekly">ì£¼ê°„</option>
                            <option value="monthly">ì›”ê°„</option>
                            <option value="all">ì „ì²´</option>
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d={PATHS.down} size={12} /></div>
                    </div>
                    <div className="hidden md:flex bg-slate-100 p-1 rounded-xl shadow-inner">
                        <button onClick={() => onChange('weekly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'weekly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì£¼ê°„</button>
                        <button onClick={() => onChange('monthly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'monthly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì›”ê°„</button>
                        <button onClick={() => onChange('all')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'all' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì „ì²´</button>
                    </div>
                </>
        );

        const RoleSelectModal = ({ isOpen, onClose, roles, currentRole, onSelect }) => {
            const [selected, setSelected] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    if (currentRole) {
                        setSelected(currentRole.split(',').map(r => r.trim()).filter(r => r));
                    } else {
                        setSelected([]);
                    }
                }
            }, [isOpen, currentRole]);

            const toggle = (role) => {
                setSelected(prev => prev.includes(role) ? prev.filter(r => r !== role) : [...prev, role]);
            };

            const handleSave = () => {
                onSelect(selected.length > 0 ? selected.join(', ') : null);
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ì„ íƒ (ì¤‘ë³µ ê°€ëŠ¥)" icon={PATHS.users} maxWidth="max-w-xs" footer={
                    <Btn onClick={handleSave} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">ì €ìž¥í•˜ê¸°</Btn>
                }>
                    <div className="grid grid-cols-1 gap-2 max-h-[50vh] overflow-y-auto custom-scroll pr-1">
                        {roles.map((role, i) => {
                            const isSelected = selected.includes(role);
                            return (
                                <button key={i} onClick={() => toggle(role)} className={`p-3 rounded-xl border text-sm font-bold transition-all flex justify-between items-center ${isSelected ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                    <span>{role}</span>
                                    {isSelected && <Icon d={PATHS.check} size={16} />}
                                </button>
                            );
                        })}
                    </div>
                </BaseModal>
            );
        };

        const RoleEditModal = ({ isOpen, onClose, roles, onSave, roleDescriptions, onSaveDescriptions }) => {
            const [tempRoles, setTempRoles] = useState([]);
            const [newRole, setNewRole] = useState("");
            const [editingRole, setEditingRole] = useState(null);
            const [editTitle, setEditTitle] = useState("");
            const [editDesc, setEditDesc] = useState("");

            useEffect(() => { if (isOpen) setTempRoles([...roles]); }, [isOpen, roles]);

            const handleAdd = () => {
                if (newRole.trim()) {
                    setTempRoles([...tempRoles, newRole.trim()]);
                    setNewRole("");
                }
            };

            const handleDelete = (index) => {
                setTempRoles(tempRoles.filter((_, i) => i !== index));
            };

            const handleMove = (index, direction) => {
                const newRoles = [...tempRoles];
                const targetIndex = index + direction;
                if (targetIndex >= 0 && targetIndex < newRoles.length) {
                    [newRoles[index], newRoles[targetIndex]] = [newRoles[targetIndex], newRoles[index]];
                    setTempRoles(newRoles);
                }
            };

            const startEditDesc = (role) => {
                const descData = roleDescriptions[role] || { title: `${role}ì˜ ì—­í• `, desc: [] };
                setEditingRole(role);
                setEditTitle(descData.title);
                setEditDesc(descData.desc.join('\n'));
            };

            const saveDesc = () => {
                const newDescList = editDesc.split('\n').map(l => l.trim()).filter(l => l);
                const newDescriptions = {
                    ...roleDescriptions,
                    [editingRole]: { title: editTitle, desc: newDescList }
                };
                onSaveDescriptions(newDescriptions);
                setEditingRole(null);
            };

            const restoreDefault = () => {
                const def = DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                if (def) {
                    setEditTitle(def.title);
                    setEditDesc(def.desc.join('\n'));
                }
            };

            if (editingRole) {
                const hasDefault = !!DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                return (
                    <BaseModal isOpen={isOpen} onClose={() => setEditingRole(null)} title={`${editingRole} ì„¤ëª… íŽ¸ì§‘`} icon={PATHS.edit} footer={
                        <div className="flex gap-2">
                            <Btn onClick={() => setEditingRole(null)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">ì·¨ì†Œ</Btn>
                            <Btn onClick={saveDesc} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">ì €ìž¥</Btn>
                        </div>
                    }>
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between items-center mb-1">
                                    <label className="text-xs font-bold text-slate-500">ì—­í•  íƒ€ì´í‹€</label>
                                    {hasDefault && <Btn onClick={restoreDefault} className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded hover:bg-slate-200">ê¸°ë³¸ê°’ ë³µì›</Btn>}
                                </div>
                                <input value={editTitle} onChange={e => setEditTitle(e.target.value)} className="w-full p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ì˜ˆ: ì¹œêµ¬ë“¤ì„ ë„ì™€ì£¼ëŠ” ë‚˜ëˆ”ì´!" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ìƒì„¸ ì„¤ëª… (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                                <textarea value={editDesc} onChange={e => setEditDesc(e.target.value)} className="w-full h-32 p-2 border rounded-xl text-sm resize-none outline-none focus:border-indigo-500" placeholder="í•  ì¼ì„ í•œ ì¤„ì”© ìž…ë ¥í•˜ì„¸ìš”." />
                            </div>
                        </div>
                    </BaseModal>
                );
            }

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ëª©ë¡ íŽ¸ì§‘" icon={PATHS.edit} footer={<Btn onClick={() => onSave(tempRoles)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">ì €ìž¥í•˜ê¸°</Btn>}>
                    <div className="flex gap-2 mb-4"><input value={newRole} onChange={(e) => setNewRole(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.nativeEvent.isComposing && handleAdd()} className="flex-1 p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ìƒˆ ì—­í•  ì´ë¦„" /><Btn onClick={handleAdd} className="bg-indigo-50 text-indigo-600 px-4 rounded-xl font-bold hover:bg-indigo-100">ì¶”ê°€</Btn></div>
                    <div className="space-y-2 max-h-[300px] overflow-y-auto custom-scroll pr-1">{tempRoles.map((role, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-200"><span className="font-bold text-slate-700 text-sm">{i + 1}. {role}</span><div className="flex items-center gap-1"><Btn onClick={() => startEditDesc(role)} className="p-1 text-indigo-400 hover:text-indigo-600" title="ì„¤ëª… ìˆ˜ì •"><Icon d={PATHS.document} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleMove(i, -1)} disabled={i === 0} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} className="rotate-180" size={16} /></Btn><Btn onClick={() => handleMove(i, 1)} disabled={i === tempRoles.length - 1} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleDelete(i)} className="p-1 text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div></div>))}</div>
                    <p className="text-xs text-slate-400 mt-2 text-center">* ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ëª¨ë‘ ì›ì—ê²Œ ë°°ì •ë©ë‹ˆë‹¤.</p>
                </BaseModal>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

<!----comment node----><whale-quicksearch translate="no" style="visibility: visible;"></whale-quicksearch><!----comment node----><whale-quicksearch translate="no" style="visibility: visible;"></whale-quicksearch></body></html>
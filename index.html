<!DOCTYPE html>
<html lang="ko"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤í–ˆë‚˜ìš”?</title>
    
    <meta property="og:title" content="ë‹¤í–ˆë‚˜ìš”!?">
    <meta property="og:description" content="ìš°ë¦¬ ë°˜ ìˆ™ì œ í™•ì¸ ë° í•™ê¸‰ ê²½ì˜ ë„êµ¬">
    
    <link rel="icon" id="app-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/ko.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" data-app-script="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" data-app-script="true"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css" data-app-style="true">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Jua&family=Nanum+Gothic:wght@400;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">

    <script data-app-script="true">
        dayjs.locale('ko');
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: { 50: '#F7F7F5', 100: '#E9E9E7', 500: '#37352F', 600: '#2F2F2F', 700: '#191711' },
                        notion: {
                            bg: '#FFFFFF',
                            'bg-hover': '#F1F1EF',
                            'bg-alt': '#F7F7F5',
                            text: '#37352F',
                            'text-light': 'rgba(55, 53, 47, 0.65)',
                            border: '#E9E9E7',
                            red: '#E03E3E',
                            blue: '#0B6E99',
                            green: '#0F7B6C',
                            orange: '#D9730D',
                            yellow: '#DFAB01',
                            purple: '#6940A5',
                            pink: '#AD1A72',
                        }
                    },
                    fontFamily: { 
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Helvetica', '"Apple Color Emoji"', 'Arial', 'sans-serif', '"Segoe UI Emoji"', '"Segoe UI Symbol"'],
                        serif: ['Lyon-Text', 'Georgia', 'YuMincho', '"Yu Mincho"', '"Hiragino Mincho ProN"', '"Hiragino Mincho Pro"', '"Songti SC"', '"Shimsong"', 'serif'],
                        hand: ['"Gaegu"', 'cursive'],
                        jua: ['"Jua"', 'sans-serif'],
                        nanum: ['"Nanum Gothic"', 'sans-serif'],
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pop-up': 'popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'modal-enter': 'modalEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'expand-from': 'expandFrom 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        bounceIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        fadeIn: { 'from': { opacity: 0 }, 'to': { opacity: 1 } },
                        popUp: { 'from': { transform: 'translate(-50%, -40%) scale(0.9)', opacity: 0 }, 'to': { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 } },
                        modalEnter: { '0%': { opacity: 0, transform: 'scale(0.95) translateY(10px)' }, '100%': { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        slideInRight: { '0%': { transform: 'translateX(20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInLeft: { '0%': { transform: 'translateX(-20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        expandFrom: { '0%': { transform: 'scale(0)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        slideInDown: { '0%': { transform: 'translate(-50%, -100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                    }
                }
            }
        }
    </script>
    <style data-app-style="true">
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .dragging { opacity: 0.5; transform: scale(0.98); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .drag-over { background-color: #eff6ff; border-color: #3b82f6 !important; border-width: 2px !important; transform: scale(1.02); box-shadow: 0 0 0 2px #3b82f6; z-index: 10; }
        .seat-cell { position: relative; }
        .seat-cell.drag-over::after {
            content: '+';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #22c55e;
            font-size: 3rem;
            font-weight: 800;
            border-radius: 0.75rem;
            pointer-events: none;
            z-index: 50;
            border: 2px dashed #22c55e;
        }
        body.is-dragging-seat .seat-cell * { pointer-events: none !important; }
        body.is-dragging-seat .student-card { pointer-events: none !important; opacity: 0.5; }
        body.is-dragging-seat img { pointer-events: none !important; }
        body.is-dragging-group .group-card * { pointer-events: none !important; }
        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ëª¨ë“  ìì‹ ìš”ì†Œì˜ ì´ë²¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ì—¬ ë“œë¡­ ì˜ì—­ ê°ì§€ìœ¨ì„ ë†’ì„ */
        body.is-dragging-seat * {
            cursor: grabbing !important;
        }
        body.is-dragging-seat .student-card,
        body.is-dragging-seat .seat-cell * {
            pointer-events: none !important;
        }
/* ë“œë¡­ ê°€ëŠ¥í•œ ì˜ì—­(ì¢Œì„)ì€ ì´ë²¤íŠ¸ ë°›ê¸° í—ˆìš© */
        body.is-dragging-seat .seat-cell {
            pointer-events: auto !important;
        }
    </style>
</head>
<body class="bg-white text-[#37352F] select-none">
    <div id="root" class="h-screen flex flex-col overflow-hidden"></div>

    <script type="text/babel" data-app-script="true">
        const safeLocalStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { return window._memStore ? window._memStore[key] : null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { if (!window._memStore) window._memStore = {}; window._memStore[key] = value; }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } 
                catch (e) { if (window._memStore) delete window._memStore[key]; }
            }
        };
        
        const updateAiUsage = () => {
            const current = parseInt(localStorage.getItem('cls_ai_usage') || '0');
            localStorage.setItem('cls_ai_usage', current + 1);
        };

        const logSystemEvent = (message, type = 'info') => {
            try {
                const logs = JSON.parse(localStorage.getItem('cls_system_logs') || '[]');
                const newLog = {
                    time: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                    type,
                    message: (message instanceof Error) ? message.toString() : (typeof message === 'object' ? JSON.stringify(message) : String(message))
                };
                const updatedLogs = [newLog, ...logs].slice(0, 100); // Keep last 100 logs
                localStorage.setItem('cls_system_logs', JSON.stringify(updatedLogs));
            } catch (e) { console.error("System log write failure:", e); }
        };

        const GEMINI_MODEL_NAME = "gemini-2.5-flash-lite";
        // [New] Gemini í˜¸ì¶œ í•¨ìˆ˜ (ë¦¬í¬íŠ¸ ìƒì„±ìš©)
        const callGemini = async (apiKey, prompt, temperature = 0.7) => {
            // ğŸ”’ [ë³´ì•ˆ ì ê²€] ì‹¤ì œ AIì—ê²Œ ì „ì†¡ë˜ëŠ” ë‚´ìš©ì„ ì½˜ì†”ì°½ì— ì¶œë ¥í•©ë‹ˆë‹¤.
            // F12(ê°œë°œì ë„êµ¬) > Console íƒ­ì—ì„œ í•™ìƒ ì´ë¦„ì´ [STUDENT_TOKEN]ìœ¼ë¡œ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            console.log("ğŸš€ [Gemini ì „ì†¡ í”„ë¡¬í”„íŠ¸ í™•ì¸]", prompt);

            // [New] ê°œë°œì ëª¨ë“œ ë˜ëŠ” ë³´ì•ˆ í™•ì¸ ëª¨ë“œì¼ ê²½ìš° ì „ì†¡ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì‚¬ìš©ì í™•ì¸ìš©)
            if (localStorage.getItem('cls_ai_safety_check') === 'true') {
                if (window.triggerAiSecurityCheck) {
                    await window.triggerAiSecurityCheck(prompt);
                } else {
                    const msg = `[ğŸ”’ ë³´ì•ˆ í™•ì¸: AI ì „ì†¡ ë°ì´í„°]\n\n${prompt.substring(0, 300)}...\n\n(ì´ë¦„ì´ [STUDENT_TOKEN] ë˜ëŠ” 'ê¸‰ìš°' ë“±ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)\n\nì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (!confirm(msg)) throw new Error("ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }

            if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: temperature }
                    }),
                    referrerPolicy: "no-referrer"
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || response.statusText);
                updateAiUsage();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (e) {
                logSystemEvent(e, 'error');
                if (e.message.includes('Failed to fetch')) throw new Error("ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ (CORS ë˜ëŠ” ì¸í„°ë„· ë¬¸ì œ)");
                throw e;
            }
        };

        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        // ğŸŒŸ ë”°ì˜´í‘œ ì¤‘ë³µ ë°©ì§€ ë° ì „ì†¡ ìµœì í™” ë²„ì „
        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        const saveToGoogleSheet = async (studentName, category, recordContent, recordDate) => {
            let url = localStorage.getItem('cls_google_sheet_url');
            // ğŸŒŸ í•µì‹¬: ì°Œêº¼ê¸°ë¡œ ë“¤ì–´ê°„ í°ë”°ì˜´í‘œ, ì‘ì€ë”°ì˜´í‘œë¥¼ ì—¬ê¸°ì„œ ê°•ì œë¡œ ëœ¯ì–´ëƒ…ë‹ˆë‹¤!
            if (url) url = url.trim().replace(/^"|'|"$|'$/g, '');
            
            if (!url) {
                alert("ì„¤ì • > ë°ì´í„° ê´€ë¦¬ > ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì—ì„œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
            }
            try {
                const dateStr = recordDate ? dayjs(recordDate).format('YYYY-MM-DD') + ' ' + dayjs().format('HH:mm:ss') : dayjs().format('YYYY-MM-DD HH:mm:ss');
                
                const clean = (val) => String(val || "").replace(/^"|"$/g, '');

                const payload = {
                    date: clean(dateStr),
                    name: clean(studentName),
                    category: clean(category),
                    content: clean(recordContent)
                };

                await fetch(url, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (e) {
                console.error(e); alert("êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì‹¤íŒ¨: " + e.message); return false;
            }
        };

        // [New] ìµëª…í™” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const anonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            let processed = text;
            processed = processed.replaceAll(studentName, '[STUDENT_TOKEN]');
            if (studentName.length >= 3) {
                const nameOnly = studentName.substring(1);
                processed = processed.replaceAll(nameOnly, '[STUDENT_TOKEN]');
            }
            return processed;
        };

        const deanonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            // [Safety] AIê°€ ì‹¤ìˆ˜ë¡œ ì‹¤ëª…ì„ í¬í•¨í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¨¼ì € ìµëª…í™” í† í°ìœ¼ë¡œ ë³€í™˜
            const safeText = anonymizeText(text, studentName);
            return safeText.replaceAll('[STUDENT_TOKEN]', studentName).replaceAll('í•´ë‹¹ í•™ìƒ', studentName);
        };

        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const getToday = () => dayjs().format('YYYY-MM-DD');
        const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        const HOLIDAYS = {
            '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚  ì—°íœ´', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚  ì—°íœ´', '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-06-03': 'ì§€ë°©ì„ ê±°', '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-09-24': 'ì¶”ì„ ì—°íœ´', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„ ì—°íœ´', '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-10-09': 'í•œê¸€ë‚ ', '2026-12-25': 'ì„±íƒ„ì ˆ'
        };
        
        const PATHS = {
            calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
            check: "M20 6 9 17l-5-5", users: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
            chart: "M3 3v18h18 M18 17V9 M13 17V5 M8 17v-3", plus: "M12 5v14 M5 12h14", trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            left: "M15 18 L9 12 L15 6", right: "M9 18 L15 12 L9 6", upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12", download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            bot: "M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M12 8v4 M4 12v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6 M9 16a2 2 0 0 1-2-2v-1 M15 16a2 2 0 0 0 2-2v-1 M12 16v-4",
            list: "M8 6h13 M8 12h13 M8 18h13 M3 6h.01 M3 12h.01 M3 18h.01", code: "M16 18l6-6-6-6 M8 6l-6 6 6 6", edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
            cloud: "M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.17 0-.335.01-.497.027C16.48 6.965 13.812 5 10.5 5 6.358 5 3 8.358 3 12.5c0 3.23 2.063 6.008 5.006 7",
            grid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z", trophy: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M2 12h20",
            warning: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01",
            lock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 10 0v4",
            unlock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 9.9-1",
            x: "M18 6L6 18M6 6l12 12", help: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-1-5h2v2h-2v-2zm2-1.645V14h-2v-1.5a1 1 0 0 1 1-1 1.5 1.5 0 1 0-1.471-1.794l-1.962-.393A3.501 3.501 0 1 1 13 13.355z",
            settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.01a2 2 0 0 1-2 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2.78a2 2 0 0 1-2-2v-.01a2 2 0 0 1-2-2z",
            down: "M6 9l6 6 6-6", sun: "M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z",
            crown: "M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14v2H5v-2z", 
            link: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71", document: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8",
            copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z",
            spinner: "M21 12a9 9 0 1 1-6.219-8.56", mic: "M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v4 M8 23h8",
            magic: "M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34 M18 2l4 4 M15.5 4.5l3 3 M10 10l8-8", book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            send: "M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z", search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
            key: "M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4",
            speaker: "M11 5L6 9H2v6h4l5 4V5z M19.07 4.93a10 10 0 0 1 0 14.14 M15.54 8.46a5 5 0 0 1 0 7.07",
            mute: "M11 5L6 9H2v6h4l5 4V5z M23 9l-6 6 M17 9l6 6",
            play: "M5 3l14 9-14 9V3z"
        };

        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Btn = ({ onClick, className, children, ...props }) => (
            <button onClick={onClick} className={`transition-colors duration-100 active:opacity-70 flex items-center justify-center rounded hover:bg-notion-bg-hover ${className}`} {...props}>{children}</button>
        );
        const BaseModal = ({ isOpen, onClose, title, icon, children, footer, maxWidth = "max-w-2xl", zIndex = "z-50", onTitleClick }) => {
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                document.body.style.overflow = 'hidden';
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                    document.body.style.overflow = '';
                };
            }, [isOpen, onClose]);

            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 bg-black/40 ${zIndex} flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in`} onClick={onClose}>
                    <div 
                        className={`bg-white w-full ${maxWidth} rounded-xl shadow-xl border border-notion-border p-6 h-auto max-h-[85vh] flex flex-col animate-modal-enter`} 
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 className={`text-lg font-bold flex items-center gap-2 text-notion-text ${onTitleClick ? 'cursor-pointer select-none' : ''}`} onClick={onTitleClick}>{icon ? <Icon d={icon} className="text-notion-text" /> : null} {title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-notion-bg-hover rounded text-notion-text-light"><Icon d={PATHS.x} /></button>
                        </div>
                        <div className="overflow-y-auto custom-scroll flex-1 pr-2 space-y-6 overscroll-contain">{children}</div>
                        {footer && <div className="pt-4 border-t mt-4 flex-shrink-0">{footer}</div>}
                    </div>
                </div>
            );
        };
        const Toast = ({ message, onClose }) => {
            const onCloseRef = useRef(onClose);
            useEffect(() => { onCloseRef.current = onClose; }, [onClose]);
            useEffect(() => { if (!message) return; const timer = setTimeout(() => onCloseRef.current(), 2000); return () => clearTimeout(timer); }, [message]);
            if (!message) return null;
            return <div className="fixed top-10 left-1/2 transform -translate-x-1/2 z-[3000] animate-pop-up pointer-events-none"><div className="bg-[#37352F] text-white px-4 py-2 rounded shadow-lg flex items-center gap-2 backdrop-blur-md min-w-[200px] justify-center"><Icon d={PATHS.check} size={16} className="text-white" /><span className="font-medium text-sm text-center">{message}</span></div></div>;
        };
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
            useEffect(() => {
                if (isOpen) { document.body.style.overflow = 'hidden'; }
                return () => { document.body.style.overflow = ''; };
            }, [isOpen]);

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 z-[2500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div 
                        className="bg-white rounded-xl shadow-xl border border-notion-border p-6 w-full max-w-sm animate-modal-enter relative"
                    >
                        <button onClick={onCancel} className="absolute top-4 right-4 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                            <Icon d={PATHS.x} size={18} />
                        </button>
                        <div className="flex items-center gap-2 mb-4 text-notion-text font-bold"><Icon d={PATHS.warning} /> í™•ì¸</div><p className="text-notion-text mb-6 text-sm whitespace-pre-wrap">{message}</p><div className="flex gap-3"><Btn onClick={onCancel} className="flex-1 py-2 bg-white text-slate-600 rounded border border-slate-200 font-medium hover:bg-slate-100 hover:border-slate-300 transition-colors">ì·¨ì†Œ</Btn><Btn onClick={onConfirm} className="flex-1 py-2 bg-notion-red text-white rounded font-medium hover:bg-red-600 shadow-sm transition-colors">í™•ì¸</Btn></div></div></div>
            );
        };
        const UpdateNotificationModal = ({ isOpen, onUpdate, onClose }) => {
            if (!isOpen) return null;
            
            // ğŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const latestUpdate = UPDATE_NOTES[0];
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed inset-0 bg-black/50 z-[3000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center animate-bounce-in relative overflow-hidden border border-white/50">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors z-20">
                            <Icon d={PATHS.x} size={20} />
                        </button>
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        
                        <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner ring-4 ring-indigo-50/50">
                            <span className="text-4xl animate-pulse drop-shadow-sm select-none">ğŸš€</span>
                        </div>
                        <h3 className="text-xl font-extrabold text-slate-800 mb-1">ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ!</h3>
                        <p className="text-xs text-slate-500 mb-4">ì›í™œí•œ ì‚¬ìš©ì„ ìœ„í•´ ì•±ì„ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.</p>
                        
                        {/* ğŸŒŸ ì—¬ê¸°ì— ìµœì‹  ì—…ë°ì´íŠ¸ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ */}
                        <div className="text-left bg-slate-50 p-4 rounded-xl border border-slate-100 mb-5">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded-md">
                                    {latestUpdate.version}
                                </span>
                                <span className="text-[10px] text-slate-400 font-medium">{latestUpdate.date || "ìµœì‹  ì—…ë°ì´íŠ¸"}</span>
                            </div>
                            <ul className="text-[11px] text-slate-600 space-y-1.5">
                                {changes.slice(0, 3).map((item, index) => (
                                    <li key={index} className="flex items-start gap-1.5">
                                        <span className="text-indigo-400 mt-0.5">â€¢</span>
                                        <span className="leading-tight">{item}</span>
                                    </li>
                                ))}
                                {changes.length > 3 && (
                                    <li className="text-slate-400 pl-3 pt-1 font-medium">...ì™¸ {changes.length - 3}ê±´</li>
                                )}
                            </ul>
                        </div>

                        <div className="flex flex-col gap-2">
                            <button onClick={onUpdate} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <span>âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨)</span>
                            </button>
                            <div className="flex gap-2">
                                <button onClick={() => onClose('today')} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</button>
                                <button onClick={() => onClose()} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const UpdateNotificationToast = ({ isOpen, onUpdate, onClose }) => {
            const timerRef = useRef(null);
            
            useEffect(() => {
                if (isOpen) {
                    timerRef.current = setTimeout(onClose, 8000); // í…ìŠ¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆë„ë¡ 8ì´ˆ ìœ ì§€
                }
                return () => clearTimeout(timerRef.current);
            }, [isOpen, onClose]);
            
            const handleMouseEnter = () => clearTimeout(timerRef.current);
            const handleMouseLeave = () => { 
                if (isOpen) timerRef.current = setTimeout(onClose, 8000); 
            };
            
            if (!isOpen) return null;

            // ğŸŒŸ í•µì‹¬: ì—¬ëŸ¬ ë²„ì „ì˜ ê¸°ë¡ì´ ìˆì–´ë„ ë¬´ì¡°ê±´ [0]ë²ˆì§¸(ê°€ì¥ ìµœì‹ ) ë°ì´í„°ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤!
            const latestUpdate = UPDATE_NOTES[0] || {};
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[3000] w-full max-w-sm px-4 animate-[slideInDown_0.5s_cubic-bezier(0.16,1,0.3,1)]" 
                     onMouseEnter={handleMouseEnter} 
                     onMouseLeave={handleMouseLeave} 
                     onTouchStart={handleMouseEnter} 
                     onTouchEnd={handleMouseLeave}>
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-4 border border-indigo-100 flex flex-col gap-3 ring-1 ring-black/5 relative">
                        
                        <button onClick={() => onClose()} className="absolute top-2 right-2 p-1 text-slate-300 hover:text-slate-500 rounded-full hover:bg-slate-100 transition-colors z-10">
                            <Icon d={PATHS.x} size={14} />
                        </button>

                        <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm mt-0.5">
                                <span className="text-lg animate-pulse">ğŸš€</span>
                            </div>
                            
                            <div className="flex-1 min-w-0">
                                <h4 className="font-bold text-slate-800 text-sm flex items-center gap-2 mb-2">
                                    ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ! 
                                    <span className="bg-indigo-100 text-indigo-600 text-[10px] px-1.5 py-0.5 rounded font-bold">{latestUpdate.version}</span>
                                </h4>
                                
                                {/* ğŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ë‚´ìš© ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */}
                                <ul className="text-[11px] text-slate-600 space-y-1.5 max-h-[150px] overflow-y-auto custom-scroll pr-2">
                                    {changes.map((item, index) => (
                                        <li key={index} className="flex items-start gap-1.5">
                                            <span className="text-indigo-400 mt-0.5">â€¢</span>
                                            <span className="leading-tight break-keep">{item}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-1 pt-3 border-t border-slate-100">
                            <button onClick={() => onClose('today')} className="flex-1 py-2 text-slate-500 text-[11px] font-bold bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors">
                                ì˜¤ëŠ˜ í•˜ë£¨ ìˆ¨ê¹€
                            </button>
                            <button onClick={onUpdate} className="flex-1 py-2 bg-indigo-600 text-white text-[11px] font-bold rounded-xl hover:bg-indigo-700 shadow-sm active:scale-95 transition-all">
                                âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸
                            </button>
                        </div>
                        
                    </div>
                </div>
            );
        };
        const HelpModal = ({ isOpen, onClose }) => {
            if(!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ìë™ ë°±ì—… ë„ì›€ë§" icon={PATHS.help}><div className="space-y-4 text-sm text-slate-600 leading-relaxed"><div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><h4 className="font-bold text-indigo-700 mb-2">ğŸš€ ê¸°ëŠ¥ ì†Œê°œ</h4><p>ì„¤ì •ëœ ì‹œê°„ì— í˜„ì¬ ì•±ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ <strong>JSON íŒŒì¼</strong>ë¡œ ìë™ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. ë§Œì•½ì˜ ì‚¬íƒœì— ëŒ€ë¹„í•´ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”.</p></div><div className="space-y-2"><h4 className="font-bold text-slate-800">âš ï¸ í•„ìˆ˜ ì£¼ì˜ì‚¬í•­</h4><ul className="list-disc pl-5 space-y-1"><li><strong>ì•±ì´ ì¼œì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:</strong> ì´ ê¸°ëŠ¥ì€ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì‘ë™í•˜ë¯€ë¡œ, í•´ë‹¹ ì‹œê°„ì— ì´ ì›¹í˜ì´ì§€ê°€ ì—´ë ¤ ìˆì–´ì•¼ë§Œ ì‘ë™í•©ë‹ˆë‹¤. ì»´í“¨í„°ê°€ êº¼ì ¸ ìˆê±°ë‚˜ íƒ­ì„ ë‹«ìœ¼ë©´ ë°±ì—…ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li><strong>íŒì—… ì°¨ë‹¨ í•´ì œ:</strong> ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ 'ìë™ ë‹¤ìš´ë¡œë“œ' ë˜ëŠ” 'íŒì—…'ì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li><strong>ì €ì¥ ìœ„ì¹˜:</strong> ë³´ì•ˆìƒ ì›¹ì‚¬ì´íŠ¸ê°€ ë°”íƒ•í™”ë©´ ë“± ì €ì¥ ìœ„ì¹˜ë¥¼ ê°•ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì˜ 'ë‹¤ìš´ë¡œë“œ í´ë”'ì— ì €ì¥ë©ë‹ˆë‹¤. (ì„¤ì •ì—ì„œ 'ë‹¤ìš´ë¡œë“œ ì „ì— ì €ì¥ ìœ„ì¹˜ í™•ì¸'ì„ ì¼œë‘ì‹œë©´ ë§¤ë²ˆ ìœ„ì¹˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</li></ul></div></div></BaseModal>
            );
        }

        const DEFAULT_ROLE_DESCRIPTIONS = {
            'ë‚˜ëˆ”ì´': { title: 'ìš°ë¦¬ ëª¨ë‘ ì„ ìœ„í•´ ì„¬ê²¨ì£¼ëŠ” ë‚˜ëˆ”ì´!', desc: ['ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ë‚˜ëˆ ì¤˜ìš”!', 'ì¹œêµ¬ë“¤ì´ í™œë™ì„ ì˜ í•  ìˆ˜ ìˆê²Œ ì±™ê²¨ì¤˜ìš”', 'ì„ ìƒë‹˜ì˜ ë§ì„ ëª¨ë‘  ì¹œêµ¬ë“¤ì—ê²Œ ì „ë‹¬í•´ìš”'] },
            'ë§ºìŒì´': { title: 'ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ì •ë¦¬í•´ì£¼ëŠ” ë§ºìŒì´!', desc: ['ì¹œêµ¬ë“¤ì˜ í™œë™ì§€ë¥¼ ì„ ìƒë‹˜ì—ê²Œ ì œì¶œí•´ìš”', 'ë‚¨ì€ í™œë™ì‹œê°„ì„ ì¹œêµ¬ë“¤ì—ê²Œ ì•Œë ¤ì¤˜ìš”'] },
            'ì±™ê¹€ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì˜¤ëŠ” ì±™ê¹€ì´', desc: ['ëª¨ë‘ ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì™€ìš”', '4êµì‹œê¹Œì§€ ì•Œë¦¼ì¥ì„ ì“¸ ìˆ˜ ìˆê²Œ ë„ì™€ì¤˜ìš”'] },
            'ê¹”ë”ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì •ë¦¬í•˜ëŠ” ê¹”ë”ì´!', desc: ['í’€ê³¼ ê°€ìœ„ë¥¼ ì •ë¦¬í•´ìš”', 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì œìë¦¬ì— ë‚˜ë‘¬ìš”'] }
        };

        const RoleHelpModal = ({ isOpen, onClose, roleDescriptions }) => {
            if (!isOpen) return null;
            const descriptions = roleDescriptions || DEFAULT_ROLE_DESCRIPTIONS;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ì„¤ëª…" icon={PATHS.help}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {Object.entries(descriptions).map(([role, info]) => (
                            <div key={role} className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-2 mb-2"><span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold">{role}</span><h4 className="font-bold text-slate-700 text-sm">{info.title}</h4></div>
                                <ul className="list-disc pl-4 space-y-1">{info.desc.map((d, i) => (<li key={i} className="text-xs text-slate-600">{d}</li>))}</ul>
                            </div>
                        ))}
                    </div>
                </BaseModal>
            );
        };

        const GroupOverlay = ({ groups, avoidancePairs, isVisible, focusedGroupIdx }) => {
            const [lines, setLines] = useState([]);
            
            useEffect(() => {
                const shouldShow = isVisible || focusedGroupIdx !== null;
                if (!shouldShow) { setLines([]); return; }
                
                const updateLines = () => {
                    const newLines = [];
                    const container = document.getElementById('groups-container');
                    if (!container) return;
                    const containerRect = container.getBoundingClientRect();

                    let targetPairs = avoidancePairs;
                    if (focusedGroupIdx !== null && groups[focusedGroupIdx]) {
                        const memberNames = new Set(groups[focusedGroupIdx].map(s => s.name));
                        targetPairs = avoidancePairs.filter(p => memberNames.has(p.p1) || memberNames.has(p.p2));
                    }

                    targetPairs.forEach(pair => {
                        const el1 = document.querySelector(`[data-student-name="${pair.p1}"]`);
                        const el2 = document.querySelector(`[data-student-name="${pair.p2}"]`);
                        
                        if (el1 && el2) {
                            const r1 = el1.getBoundingClientRect();
                            const r2 = el2.getBoundingClientRect();
                            const x1 = r1.left + r1.width / 2 - containerRect.left;
                            const y1 = r1.top + r1.height / 2 - containerRect.top;
                            const x2 = r2.left + r2.width / 2 - containerRect.left;
                            const y2 = r2.top + r2.height / 2 - containerRect.top;
                            newLines.push({ x1, y1, x2, y2, id: pair.id });
                        }
                    });
                    setLines(newLines);
                };

                updateLines();
                window.addEventListener('resize', updateLines);
                const timer = setTimeout(updateLines, 500); 
                return () => { window.removeEventListener('resize', updateLines); clearTimeout(timer); };
            }, [groups, avoidancePairs, isVisible, focusedGroupIdx]);

            if (!isVisible && focusedGroupIdx === null) return null;
            return (
                <svg className="absolute inset-0 w-full h-full pointer-events-none z-50" style={{ overflow: 'visible' }}>
                    {lines.map(line => <line key={line.id} x1={line.x1} y1={line.y1} x2={line.x2} y2={line.y2} stroke="#ef4444" strokeWidth="2" strokeDasharray="5,5" opacity="0.6" />)}
                </svg>
            );
        };

        const RadarChart = ({ data }) => {
            const tags = Object.entries(data).filter(([_, stat]) => stat.cDone > 0).map(([tag]) => tag);
            if (tags.length < 3) return <div className="text-center text-xs text-slate-400 py-8 bg-slate-50 rounded-xl border border-slate-100 border-dashed">ë°©ì‚¬í˜• ì°¨íŠ¸ëŠ” ê³¼ëª©ì´ 3ê°œ ì´ìƒì¼ ë•Œ í‘œì‹œë©ë‹ˆë‹¤.<br/>(í˜„ì¬ {tags.length}ê°œ)</div>;

            const size = 220;
            const center = size / 2;
            const radius = 70;
            const angleStep = (Math.PI * 2) / tags.length;

            const getCoordinates = (value, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const r = (value / 100) * radius;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                return [x, y];
            };

            const studentPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            const classPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.cTotal > 0 ? (stat.cDone / stat.cTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            return (
                <div className="flex flex-col items-center py-2">
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible">
                        {[20, 40, 60, 80, 100].map((level, idx) => (
                            <polygon key={idx} points={tags.map((_, i) => getCoordinates(level, i).join(',')).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 2" />
                        ))}
                        {tags.map((tag, i) => {
                            const [lx, ly] = getCoordinates(100, i);
                            const [tx, ty] = getCoordinates(120, i);
                            return (
                                <g key={i}>
                                    <line x1={center} y1={center} x2={lx} y2={ly} stroke="#e2e8f0" strokeWidth="1" />
                                    <text x={tx} y={ty} textAnchor="middle" dominantBaseline="middle" fontSize="10" fill="#64748b" className="font-bold">{tag}</text>
                                </g>
                            );
                        })}
                        <polygon points={classPoints} fill="rgba(148, 163, 184, 0.3)" stroke="#94a3b8" strokeWidth="2" />
                        <polygon points={studentPoints} fill="rgba(99, 102, 241, 0.3)" stroke="#6366f1" strokeWidth="4" />
                        {tags.map((tag, i) => {
                             const stat = data[tag];
                             const sRate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                             const [sx, sy] = getCoordinates(sRate, i);
                             return <circle key={`s-${i}`} cx={sx} cy={sy} r="3" fill="#6366f1" />;
                        })}
                    </svg>
                    <div className="flex gap-4 mt-2 text-[10px]">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-indigo-500"></div><span className="text-slate-600 font-bold">ë‚˜</span></div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-slate-400"></div><span className="text-slate-400 font-bold">í•™ê¸‰ í‰ê· </span></div>
                    </div>
                </div>
            );
        };

        const StatsGrassModal = ({ isOpen, onClose, student, students, records, dates, dailyTasks, onSaveCounseling, onSaveStickers, onSaveStickerWithNote, showToast, openConfirm, appConfig, apiKey, onSaveRecordDraft, isLocalMode, db, appId, setStudents, saveData, isPortfolioMode }) => {
            if (!isOpen || !student || !student.history) return null;
            useEffect(() => {
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                document.body.style.overflow = 'hidden';
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                    document.body.style.overflow = '';
                };
            }, [onClose]);

            const [notes, setNotes] = useState([]);
            const [stickerCount, setStickerCount] = useState(student.stickers || 0);
            const [selectedDate, setSelectedDate] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [showSearchCal, setShowSearchCal] = useState(false);
            const [calMonth, setCalMonth] = useState(dayjs());
            const recordDates = Array.from(new Set(notes.map(n => n.date))); // ê¸°ë¡ì´ ìˆëŠ” ë‚ ì§œë§Œ ì™ì™ ë½‘ê¸°
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editNoteContent, setEditNoteContent] = useState("");
            const [aiComment, setAiComment] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [showReportEdit, setShowReportEdit] = useState(false);
            const [reportStart, setReportStart] = useState(dayjs().subtract(1, 'month').format('YYYY-MM-DD'));
            const [reportEnd, setReportEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [tempComment, setTempComment] = useState("");
            const [reportTone, setReportTone] = useState('warm');
            const [reportFont, setReportFont] = useState('sans');
            const [reportFocus, setReportFocus] = useState('comprehensive');
            const [reportPurpose, setReportPurpose] = useState('regular');
            const [showCounselingAI, setShowCounselingAI] = useState(false);
            const [reportStats, setReportStats] = useState({ studentRate: 0, classRate: 0, tagStats: {} });
            const [showDetailStats, setShowDetailStats] = useState(false);
            const [showStudentRecordAI, setShowStudentRecordAI] = useState(false);
            const modalRef = useRef(null);
            const reportRef = useRef(null);
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_report_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const [chartType, setChartType] = useState('bar');
            const [grassStart, setGrassStart] = useState(dayjs().startOf('month').format('YYYY-MM-DD'));
            const [grassEnd, setGrassEnd] = useState(dayjs().endOf('month').format('YYYY-MM-DD'));
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [stickerEffect, setStickerEffect] = useState(false);
            const [showButtonEffect, setShowButtonEffect] = useState(false);
            const [keepContent, setKeepContent] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);
            const [isGrassExpanded, setIsGrassExpanded] = useState(false); // [ì¶”ê°€ë¨] í™œë™ ì”ë”” ì ‘ê³  í´ê¸° ìƒíƒœ
            const [saveTarget, setSaveTarget] = useState(isPortfolioMode ? 'notion_portfolio' : 'notion_record'); // [New] ì €ì¥ ëŒ€ìƒ ì„ íƒ ìƒíƒœ
            
            const [notionDate, setNotionDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [notionContent, setNotionContent] = useState('');
            const [notionCategory, setNotionCategory] = useState('ê´€ì°°');
            const [searchText, setSearchText] = useState("");
            const [selectedStudents, setSelectedStudents] = useState([]);
            const [searchQuery, setSearchQuery] = useState("");
            const [showStudentDropdown, setShowStudentDropdown] = useState(false);
            const [notionStatus, setNotionStatus] = useState('idle');
            const [hasNotionConfig, setHasNotionConfig] = useState(false);
            
            useEffect(() => {
                if (isOpen) {
                    const key = localStorage.getItem('cls_notion_key');
                    const dbId = localStorage.getItem('cls_notion_db_id');
                    setHasNotionConfig(!!(key && dbId));
                }
            }, [isOpen]);

            useEffect(() => {
                if (isOpen && isPortfolioMode && student) {
                    setSearchText("");
                    setSelectedStudents([student]);
                }
            }, [isOpen, isPortfolioMode, student]);

            useEffect(() => { 
                if (!student) return;
                setStickerCount(student.stickers || 0);
                if (!isLocalMode && db && appId) {
                    const unsubscribe = db.collection('classes').doc(appId).collection('studentData').doc(String(student.id))
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                if (data.counseling) setNotes(data.counseling);
                            }
                        }, err => console.error("ê°œë³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));
                    return () => unsubscribe();
                } else {
                    const data = student.counseling;
                    if (Array.isArray(data)) setNotes(data);
                    else if (data) setNotes([{ id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: data }]);
                    else setNotes([]);
                }
                setAiComment("");
                setSelectedStudents([student]);
                setNotionDate(dayjs().format('YYYY-MM-DD'));
                setNotionContent('');
                setNotionCategory('ê´€ì°°');
                setNotionStatus('idle');

                const key = localStorage.getItem('cls_notion_key');
                const dbId = localStorage.getItem('cls_notion_db_id');
                setHasNotionConfig(!!(key && dbId));
            }, [student, isLocalMode, db, appId]);

            useEffect(() => {
                setNotionDate(selectedDate || dayjs().format('YYYY-MM-DD'));
            }, [selectedDate]);

            const level = Math.floor(stickerCount / 5) + 1;
            
            const handleSticker = (delta) => { 
                const newCount = Math.max(0, stickerCount + delta);
                setStickerCount(newCount); 
                onSaveStickers(student.id, newCount); 
                if(delta > 0) {
                    setStickerEffect(true);
                    setTimeout(() => setStickerEffect(false), 200);
                    if (navigator.vibrate) navigator.vibrate(15);
                    if (newCount % 5 === 0) { 
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                        if(showToast) showToast(`ğŸ‰ ë ˆë²¨ ì—…! Lv.${Math.floor(newCount / 5) + 1} ë‹¬ì„±!`);
                    }
                    else { 
                        confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                    }
                }
            };
            
            const handleDeleteNote = (id) => {
                openConfirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    const newNotes = notes.filter(n => n.id !== id);
                    setNotes(newNotes);
                    onSaveCounseling(student.id, newNotes, "ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };
            
            const startEditing = (note) => {
                setEditingNoteId(note.id);
                setEditNoteContent(note.content);
            };

            const saveEditing = () => {
                if (!editNoteContent.trim()) return;
                const newNotes = notes.map(n => n.id === editingNoteId ? { ...n, content: editNoteContent.trim() } : n);
                setNotes(newNotes);
                onSaveCounseling(student.id, newNotes, "ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setEditingNoteId(null);
                setEditNoteContent("");
            };

            const handleStudentSelect = (name) => {
                const s = students.find(st => st.name === name);
                if (s && !selectedStudents.find(sel => sel.id === s.id)) {
                    setSelectedStudents(prev => [...prev, s]);
                }
            };
            
            const removeSelectedStudent = (id) => {
                setSelectedStudents(prev => prev.filter(s => s.id !== id));
            };

            const handleIntegratedSave = async (targetCategory) => {
                const category = targetCategory || 'ê´€ì°°';
                const content = notionContent.trim();
                const date = notionDate || dayjs().format('YYYY-MM-DD');

                if (!content) return showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setNotionStatus('saving');
                
                // ğŸŒŸ ë…¸ì…˜ê³¼ êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì—¬ë¶€ë¥¼ ê°ê° í™•ì¸í•´ì„œ ë°°ì§€ë¥¼ ì „ë¶€ ì±™ê¹ë‹ˆë‹¤!
                let tags = [];
                if (typeof saveTarget !== 'undefined') {
                    if (saveTarget === 'notion_record') tags.push("ë…¸ì…˜(ê¸°ë¡)");
                    if (saveTarget === 'notion_portfolio') tags.push("ë…¸ì…˜(í¬í´)");
                }
                // êµ¬ê¸€ ì‹œíŠ¸ ì£¼ì†Œê°€ ì €ì¥ë˜ì–´ ìˆë‹¤ë©´ êµ¬ê¸€ ì‹œíŠ¸ ë°°ì§€ë„ ì¶”ê°€!
                if (localStorage.getItem('cls_google_sheet_url')) {
                    tags.push("êµ¬ê¸€ ì‹œíŠ¸");
                }

                // destTag(ë‹¨ì¼) ëŒ€ì‹  destTags(ë°°ì—´)ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                const newNote = { id: Date.now(), date: date, content: content, destTags: tags };
                const targetIds = selectedStudents.map(s => s.id);
                
                const updatedStudents = students.map(s => {
                    if (targetIds.includes(s.id)) {
                        const prevNotes = s.counseling || [];
                        const updatedNotes = [newNote, ...prevNotes];
                        let updatedStickers = s.stickers || 0;
                        if (category === 'ì¹­ì°¬') updatedStickers += 1;
                        return { ...s, counseling: updatedNotes, stickers: updatedStickers };
                    }
                    return s;
                });
                
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);

                if (targetIds.includes(student.id)) {
                    setNotes(prev => [newNote, ...prev]);
                    if (category === 'ì¹­ì°¬') {
                        setStickerCount(prev => prev + 1);
                        setShowButtonEffect(true);
                        setTimeout(() => setShowButtonEffect(false), 800);
                        
                        setStickerEffect(true);
                        setTimeout(() => setStickerEffect(false), 200);
                        if (navigator.vibrate) navigator.vibrate(15);
                        const newCount = stickerCount + 1;
                        if (newCount % 5 === 0) { 
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                            if(showToast) showToast(`ğŸ‰ ë ˆë²¨ ì—…! Lv.${Math.floor(newCount / 5) + 1} ë‹¬ì„±!`);
                        } else { 
                            confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                        }
                    }
                }

                // [New] êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ë¶„ê¸° (ë¡œì»¬ ì €ì¥ í›„ ì‹¤í–‰)
                if (saveTarget === 'google_sheet') {
                    let successCount = 0;
                    for (const s of selectedStudents) {
                        const success = await saveToGoogleSheet(s.name, category, content, date);
                        if (success) successCount++;
                    }
                    if (successCount > 0) {
                        setNotionStatus('success'); 
                        if (!keepContent) setNotionContent(''); 
                        setTimeout(() => setNotionStatus('idle'), 3000); 
                        showToast("ê¸°ë¡ ì €ì¥ ë° êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì™„ë£Œ!");
                    } else { 
                        setNotionStatus('idle'); 
                        showToast("ê¸°ë¡ì€ ì €ì¥ë˜ì—ˆìœ¼ë‚˜ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    return;
                }

                try {
                    const rawKey = localStorage.getItem('cls_notion_key') || "";
                    const personalKey = rawKey.replace(/["']/g, '').trim();
                    const rawDbId = (saveTarget === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
                    const targetDbId = rawDbId.replace(/["']/g, '').trim();
                    
                    if (!personalKey || !targetDbId) {
                        setNotionStatus('idle');
                        return; // ë…¸ì…˜ ì •ë³´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ í†µê³¼ (ì•±ì—ëŠ” ì´ë¯¸ ì €ì¥ë¨)
                    }

                    const bodyData = {
                        category: category,
                        content: content,
                        personalKey: personalKey,
                        personalDbId: targetDbId
                    };
                    
                    if (saveTarget === 'notion_portfolio') {
                        const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
                        const ids = [];
                        selectedStudents.forEach(s => {
                            const notionId = map[s.name];
                            if (notionId) ids.push(notionId);
                        });
                        bodyData.mode = 'relation';
                        bodyData.studentIds = ids;
                    } else {
                        bodyData.mode = 'normal';
                        bodyData.studentName = student.name || "ì´ë¦„ ì—†ìŒ";
                        bodyData.date = dayjs(date).format('YYYY-MM-DD');
                    }

                    const response = await fetch('/api/save-notion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bodyData)
                    });
                    if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
                    
                    setNotionStatus('success');
                    if (!keepContent) setNotionContent('');
                    setTimeout(() => setNotionStatus('idle'), 3000);
                } catch (e) {
                    console.error(e);
                    setNotionStatus('error');
                    setTimeout(() => setNotionStatus('idle'), 3000);
                }
            };
            
            const calculateStatsForPeriod = (startStr, endStr) => {
                let pTotal = 0, pDone = 0;
                const pMissed = {};
                const tagStats = {};
                let curr = dayjs(startStr);
                const end = dayjs(endStr);
                let classTotal = 0, classDone = 0;
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    
                    if (tasks.length > 0) {
                        pTotal += tasks.length;
                        tasks.forEach(t => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            if (!tagStats[tag]) tagStats[tag] = { sTotal: 0, sDone: 0, cTotal: 0, cDone: 0 };
                        });
                        tasks.forEach((t, idx) => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            const isDone = rec?.tasks ? rec.tasks[idx] : (rec?.done && !rec.tasks);
                            tagStats[tag].sTotal++;
                            if(isDone) {
                                pDone++;
                                tagStats[tag].sDone++;
                            } else {
                                pMissed[tag] = (pMissed[tag] || 0) + 1;
                            }
                        });
                        const recs = records[dStr] || {};
                        students.forEach(s => {
                            const r = recs[s.id];
                            classTotal += tasks.length;
                            tasks.forEach((t, idx) => {
                                const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                                tagStats[tag].cTotal++;
                                let taskDone = false;
                                if (r && (r.tasks ? r.tasks[idx] : r.done)) taskDone = true;
                                if (taskDone) { tagStats[tag].cDone++; classDone++; }
                            });
                        });
                    }
                    curr = curr.add(1, 'day');
                }
                
                const pRate = pTotal > 0 ? Math.round((pDone / pTotal) * 100) : 0;
                const classAvgRate = classTotal > 0 ? Math.round((classDone / classTotal) * 100) : 0;

                return { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats };
            };
            
            useEffect(() => {
                if (isOpen && student && students) {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                }
            }, [isOpen, student, students, records, dailyTasks, reportStart, reportEnd]);
            
            // ... (generateReportContent ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€) ...
            const generateReportContent = async () => {
                if (isGenerating) return;
                setIsGenerating(true);
                try {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    const { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats } = stats;
                    setReportStats({ studentRate: pRate, classRate: classAvgRate, tagStats });
                    const pNotes = notes.filter(n => n.date >= reportStart && n.date <= reportEnd);
                    const missedList = Object.entries(pMissed).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]}(${x[1]}íšŒ)`);
                    const weakSubjects = [];
                    if (tagStats) {
                        Object.entries(tagStats).forEach(([tag, stat]) => {
                            const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                            const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                            if (cRate - sRate >= 15) weakSubjects.push(tag);
                        });
                    }
                    const weakSubjectsStr = weakSubjects.length > 0 ? weakSubjects.join(', ') : 'ì—†ìŒ';
                    if (apiKey) {
                        const isInsufficientData = pNotes.length < 2;
                        if(showToast) showToast("AIê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...");
                        
                        // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™” ì²˜ë¦¬
                        const safeName = "[STUDENT_TOKEN]";
                        
                        // [ë³´ì•ˆ ê°•í™”] ëŒ€ìƒ í•™ìƒ ì™¸ì— ë‹¤ë¥¸ í•™ìƒë“¤ì˜ ì´ë¦„ë„ ëª¨ë‘ ìµëª…í™”
                        let safeNotesStr = pNotes.map(n => `[${n.date}] ${n.content}`).join('\n');
                        safeNotesStr = anonymizeText(safeNotesStr, student.name);
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                        
                        const prompt = `[ë³´ì•ˆ ê·œì¹™: ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]\n\në‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ë¡œì„œ í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³  í•™ìƒì—ê²Œ ë„ì›€ì„ ì¤„ ìˆ˜ ìˆëŠ” ë‚´ìš©ìœ¼ë¡œ ì„±ì¥ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. [í•™ìƒ ì •ë³´] - ì´ë¦„: ${safeName}, ë¶„ì„ ê¸°ê°„: ${reportStart} ~ ${reportEnd}, ì„±ì‹¤ë„ ì§€í‘œ (ê³¼ì œ ìˆ˜í–‰ë¥ ): ${pRate}%, ë¶€ì¡±í•œ ê³¼ëª©: ${weakSubjectsStr}, ì¹­ì°¬ ìŠ¤í‹°ì»¤: ${stickerCount}ê°œ. [êµì‚¬ ê´€ì°° ê¸°ë¡] ${pNotes.length > 0 ? safeNotesStr : 'íŠ¹ì´ ê¸°ë¡ ì—†ìŒ'} ${isInsufficientData ? '[ê²½ê³ ] í˜„ì¬ ì´ í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ì§§ê³  ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.' : ''}`;
                        
                        const aiText = await callGemini(apiKey, prompt, 0.2);
                        
                        // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                        const finalContent = deanonymizeText(aiText, student.name);
                        setTempComment(finalContent);
                    } else {
                        const tpl = `${student.name} í•™ìƒì€ ${reportStart}ë¶€í„° ${reportEnd}ê¹Œì§€ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í–ˆìŠµë‹ˆë‹¤.\n\nì´ ê¸°ê°„ ë™ì•ˆ ê³¼ì œ ìˆ˜í–‰ë¥ ì€ ${pRate}%ì´ë©°, ${missedList.length > 0 ? `ì£¼ë¡œ ${missedList.join(', ')} ê³¼ëª©ì—ì„œ ë³´ì™„ì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.` : 'ëª¨ë“  ê³¼ëª©ì„ í›Œë¥­í•˜ê²Œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.'}\n\nê°€ì •ì—ì„œë„ ë§ì€ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;
                        setTempComment(tpl);
                    }
                } catch (e) {
                    if(showToast) showToast("ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handlePrepareReport = () => {
                const stats = calculateStatsForPeriod(reportStart, reportEnd);
                setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                const savedDraft = student.recordDrafts?.['growth_report'];
                if (savedDraft) {
                    setTempComment(savedDraft);
                } else {
                    setTempComment(`${student.name} í•™ìƒì€ í˜„ì¬ ë ˆë²¨ ${level}ë¡œ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.`);
                }
                setShowReportEdit(true);
            };
            
            const handleSaveReportDraft = () => onSaveRecordDraft(student.id, 'growth_report', tempComment);

            const handleDownloadReport = async () => {
                setShowReportEdit(false); setAiComment(tempComment); setIsGenerating(true);
                if(showToast) showToast("ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
                await new Promise(resolve => setTimeout(resolve, 1000));
                try {
                    const canvas = await window.html2canvas(reportRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${student.name}_ì„±ì¥ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handleCopyText = () => { navigator.clipboard.writeText(tempComment).then(() => { if(showToast) showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }); };

            const grassHistory = useMemo(() => {
                const start = dayjs(grassStart);
                const end = dayjs(grassEnd);
                const diff = end.diff(start, 'day') + 1;
                const history = [];
                for (let i = 0; i < diff; i++) {
                    const d = start.add(i, 'day');
                    const dStr = d.format('YYYY-MM-DD');
                    const dayOfWeek = d.day();
                    if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    let done = 0; let total = 0;
                    if (tasks.length > 0) {
                        total = tasks.length;
                        if (rec) {
                            tasks.forEach((_, idx) => {
                                if (rec.tasks && rec.tasks[idx]) done++;
                                else if (!rec.tasks && rec.done) done++;
                            });
                        }
                    } else { if (rec && rec.done) { total = 1; done = 1; } }
                    const ratio = total > 0 ? done / total : 0;
                    history.push({ date: dStr, ratio, count: done, total });
                }
                return history;
            }, [grassStart, grassEnd, dailyTasks, records, student.id]);

            const avgRate = useMemo(() => {
                const history = student.history || [];
                return history.length > 0 ? Math.round((history.reduce((acc, h) => acc + h.ratio, 0) / history.length) * 100) : 0;
            }, [student.history]);
            
            const missedTags = useMemo(() => {
                const counts = {};
                dates.forEach(date => {
                    const tasks = dailyTasks[date];
                    const rec = records[date]?.[student.id];
                    if (tasks && tasks.length > 0) {
                        tasks.forEach((task, idx) => {
                            let isDone = false;
                            if (rec) { if (rec.tasks) isDone = !!rec.tasks[idx]; else isDone = !!rec.done; }
                            if (!isDone) {
                                const tag = typeof task === 'object' ? task.tag : 'ê¸°íƒ€';
                                counts[tag] = (counts[tag] || 0) + 1;
                            }
                        });
                    }
                });
                return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
            }, [student, records, dailyTasks, dates]);
            
            const reportHistoryData = useMemo(() => {
                const history = [];
                let curr = dayjs(reportStart);
                const end = dayjs(reportEnd);
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    // ...(ê°„ëµí™”ëœ ì”ë”” ë°ì´í„° ë¡œì§, ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ë Œë”ë§ì— ì‚¬ìš©ë¨)
                    history.push({ date: dStr, ratio: 0.8, count: 4, total: 5 });
                    curr = curr.add(1, 'day');
                }
                return history;
            }, [reportStart, reportEnd]); // reportHistory ìƒëµëœ ë¡œì§ ì¶•ì†Œ

            const handleSaveAIAdvice = (adviceText) => {
                const newNote = { id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: `[AI ìƒë‹´]\n${adviceText}` };
                const newNotes = [newNote, ...notes];
                setNotes(newNotes);
                onSaveCounseling(student.id, newNotes, "AI ìƒë‹´ ë‚´ìš©ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleOpenCounselingAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowCounselingAI(true);
            };
            
            const handleOpenStudentRecordAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowStudentRecordAI(true);
            };
            
            const getPieStyle = (ratio) => {
                if (ratio <= 0) return { backgroundColor: '#f1f5f9' };
                if (ratio >= 1) return { backgroundColor: '#22c55e' };
                const percentage = ratio * 100;
                return { background: `conic-gradient(#4ade80 0% ${percentage}%, #f1f5f9 ${percentage}% 100%)` };
            };
            
            const getLevelColor = (lv) => {
                if (lv >= 5) return 'bg-orange-500';
                if (lv === 4) return 'bg-purple-500';
                if (lv === 3) return 'bg-indigo-500';
                if (lv === 2) return 'bg-blue-500';
                return 'bg-green-500';
            };
            
            const getLevelTextColor = (lv) => {
                if (lv >= 5) return 'text-orange-500';
                if (lv === 4) return 'text-purple-500';
                if (lv === 3) return 'text-indigo-600';
                if (lv === 2) return 'text-blue-500';
                return 'text-green-500';
            };

            const handleAddPhrase = () => {
                if (!tempComment.trim()) return showToast("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, tempComment.trim()];
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
            };
            
            const handleApplyPhrase = (text) => {
                setTempComment(prev => prev + (prev ? "\n\n" : "") + text);
                setShowPhraseList(false);
            };

           const filteredNotes = notes.filter(n => {
                const matchDate = selectedDate ? n.date === selectedDate : true;
                // ğŸŒŸ í•µì‹¬: ê²€ìƒ‰ì–´(searchTerm)ê°€ 'ë‚´ìš©(content)'ì— ìˆê±°ë‚˜ 'ë‚ ì§œ(date)'ì™€ ë˜‘ê°™ìœ¼ë©´ ë³´ì—¬ì¤˜!
                const matchText = searchTerm 
                    ? (n.content && n.content.toLowerCase().includes(searchTerm.toLowerCase())) || 
                      (n.date && n.date.includes(searchTerm)) 
                    : true;
                return matchDate && matchText;
            });
            
            const displayedNotes = isExpanded ? filteredNotes : filteredNotes.slice(0, 2);
            const hasMore = filteredNotes.length > 2;

            // [ì¶”ê°€ë¨] í™œë™ ì”ë”” (ì˜¤ëŠ˜ ë‚ ì§œ ë° ì ‘ê³  í´ê¸° ë¡œì§)
            const todayStr = dayjs().format('YYYY-MM-DD');
            const currentWeekGrass = grassHistory.filter(h => dayjs(h.date).isSame(dayjs(), 'week'));
            const defaultGrass = currentWeekGrass.length > 0 ? currentWeekGrass : grassHistory.slice(-5);
            const displayedGrass = isGrassExpanded ? grassHistory : defaultGrass;

            return (
                <div className="fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    {/* [ìˆ˜ì •ë¨] max-w-5xl, max-h-[85vh] ë¡œ í¬ê¸° ì¶•ì†Œ */}
                    <div ref={modalRef} className="bg-slate-50 w-full max-w-5xl rounded-3xl shadow-2xl p-4 md:p-6 max-h-[85vh] overflow-y-auto overflow-x-hidden custom-scroll flex flex-col overscroll-contain" onClick={e => e.stopPropagation()}>
                        {/* Header Container */}
                        <div className="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200 mb-6 flex-shrink-0">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-16 h-16 rounded-full bg-slate-50 border border-slate-200 overflow-hidden flex items-center justify-center shadow-sm flex-shrink-0">
                                        <span className="text-3xl">{student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                            {student.name}
                                            <span className="text-sm font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">{student.order}ë²ˆ</span>
                                        </div>
                                        <div className="text-sm font-bold text-indigo-500 mt-1">Level {level} <span className="text-slate-400 font-normal">| í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span></div>
                                    </div>
                                </div>
                                
                                {/* Header Action Buttons */}
                                <div className="flex items-center gap-2" id="export-hide-area">
                                    <button onClick={handleOpenCounselingAI} className="p-2 hover:bg-rose-50 text-rose-500 rounded-xl transition-colors border border-transparent hover:border-rose-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.heart} size={18}/> <span className="hidden md:inline">AI ìƒë‹´ì†Œ</span></button>
                                    <button onClick={handleOpenStudentRecordAI} className="p-2 hover:bg-blue-50 text-blue-500 rounded-xl transition-colors border border-transparent hover:border-blue-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.document} size={18}/> <span className="hidden md:inline">ì´í‰ ì´ˆì•ˆ</span></button>
                                    <button onClick={handlePrepareReport} disabled={isGenerating} className="p-2 hover:bg-indigo-50 text-indigo-600 rounded-xl transition-colors border border-transparent hover:border-indigo-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.edit} size={18}/> <span className="hidden md:inline">ë¦¬í¬íŠ¸ ì‘ì„±</span></button>
                                    <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                    <button onClick={onClose} className="p-2 hover:bg-slate-100 text-slate-500 rounded-xl transition-colors"><Icon d={PATHS.x} size={20}/></button>
                                </div>
                            </div>
                        </div>

                        {/* Dashboard Grid Container */}
                        <div className="lg:grid lg:grid-cols-12 lg:gap-6 space-y-6 lg:space-y-0 flex-1">
                            
                            {/* LEFT COLUMN (5/12) */}
                            <div className="lg:col-span-5 space-y-6 flex flex-col">
                                
                                {/* Missed Tags */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                                    <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon d={PATHS.chart} size={16} className="text-indigo-500"/> ìì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</h4>
                                    {missedTags.length > 0 ? (
                                        <div className="space-y-3">
                                            {missedTags.map(([tag, count], i) => (
                                                <div key={tag} className="flex justify-between items-center p-2.5 bg-slate-50 rounded-xl border border-slate-100">
                                                    <span className="flex items-center gap-2">
                                                        <span className={`w-5 h-5 rounded-full flex items-center justify-center text-xs text-white font-bold ${i===0?'bg-rose-500':i===1?'bg-orange-400':'bg-yellow-400'}`}>{i+1}</span>
                                                        <span className="text-slate-700 font-bold text-sm">{tag}</span>
                                                    </span>
                                                    <span className="text-rose-500 font-bold text-sm">{count}íšŒ ë¯¸í¡</span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center text-slate-400 text-sm py-6 bg-slate-50 rounded-xl border border-dashed border-slate-200">ë¯¸í¡í•œ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</div>
                                    )}
                                </div>

                                {/* Class Average Comparison */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm cursor-pointer hover:border-indigo-300 transition-colors group" onClick={() => setShowDetailStats(!showDetailStats)}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.users} size={16} className="text-blue-500"/> í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                        <div className="flex items-center gap-1 text-xs font-bold text-slate-400 group-hover:text-indigo-500 transition-colors">
                                            <span>{showDetailStats ? 'ì ‘ê¸°' : 'ìì„¸íˆ ë³´ê¸°'}</span>
                                            <Icon d={showDetailStats ? PATHS.down : PATHS.right} size={14} />
                                        </div>
                                    </div>
                                    <div className="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div>
                                            <div className="flex justify-between text-xs mb-1.5"><span className="font-bold text-slate-600">{student.name}</span><span className={`font-black ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span></div>
                                            <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner"><div className={`h-full ${getLevelColor(level)} transition-all duration-1000`} style={{ width: `${reportStats.studentRate}%` }}></div></div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-xs mb-1.5"><span className="font-bold text-slate-600">í•™ê¸‰ í‰ê· </span><span className="font-black text-slate-500">{reportStats.classRate}%</span></div>
                                            <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-slate-400 transition-all duration-1000" style={{ width: `${reportStats.classRate}%` }}></div></div>
                                        </div>
                                    </div>

                                    {showDetailStats && reportStats.tagStats && (
                                        <div className="mt-4 pt-4 border-t border-slate-100 space-y-4 animate-fade-in" onClick={e => e.stopPropagation()}>
                                            <div className="flex justify-end mb-3">
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('bar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'bar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë§‰ëŒ€ ê·¸ë˜í”„</button>
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('radar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'radar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°©ì‚¬í˜• ì°¨íŠ¸</button>
                                                </div>
                                            </div>
                                            {chartType === 'bar' ? (
                                                Object.entries(reportStats.tagStats)
                                                .filter(([tag, stat]) => stat.cDone > 0)
                                                .sort((a,b) => b[1].sTotal - a[1].sTotal).map(([tag, stat]) => {
                                                    const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                                                    const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                                                    const isLow = cRate - sRate >= 20;
                                                    const isHigh = sRate > cRate;
                                                    return (
                                                        <div key={tag} className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                            <div className="flex justify-between text-xs mb-2 font-bold text-slate-600">
                                                                <div className="flex items-center gap-1.5"><span className="bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-600">{tag}</span>{isHigh && <span className="text-[10px] text-orange-500 animate-pulse">í›Œë¥­í•´ìš”! ğŸ‰</span>}</div>
                                                                <div className="flex gap-3"><span className={isLow ? "text-rose-500" : getLevelTextColor(level)}>ë‚˜ {sRate}%</span><span className="text-slate-400">ë°˜ {cRate}%</span></div>
                                                            </div>
                                                            <div className="flex flex-col gap-1.5">
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className={`h-full ${isLow ? "bg-rose-500" : getLevelColor(level)}`} style={{ width: `${sRate}%` }}></div></div>
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className="h-full bg-slate-400" style={{ width: `${cRate}%` }}></div></div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            ) : <RadarChart data={reportStats.tagStats} />}
                                        </div>
                                    )}
                                </div>

                            </div>

                            {/* RIGHT COLUMN (7/12) */}
                            <div className="lg:col-span-7 space-y-6 flex flex-col h-full">

                                {/* Sticker Area */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <h4 className="text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><span className="text-lg">ğŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤</h4>
                                        <span className="text-xs text-slate-400 font-medium">ê¸ì •ì  ê°•í™”ì™€ ë³´ìƒ</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <Btn onClick={() => handleSticker(-1)} className="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 font-bold text-lg">-</Btn>
                                        <span className={`text-3xl font-black text-yellow-500 w-12 text-center transition-transform duration-200 ${stickerEffect ? 'scale-150 text-orange-500' : ''}`}>{stickerCount}</span>
                                        <Btn onClick={() => handleSticker(1)} className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold text-lg shadow-sm">+</Btn>
                                    </div>
                                </div>

                                {/* Records Area (Logs + Input) */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex flex-col flex-1">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                            <Icon d={PATHS.document} size={16} className="text-green-500"/> êµì‚¬ ê´€ì°° ë° ì¹­ì°¬ ê¸°ë¡
                                            {hasNotionConfig && <span className="text-[10px] text-green-600 font-bold ml-1 bg-green-50 border border-green-200 px-2 py-0.5 rounded-full">ë…¸ì…˜ ì—°ë™ë¨</span>}
                                        </h4>
                                    </div>

                                    {/* Unified Input Form */}
                                    <div className="flex flex-col gap-3 mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner">
                                        {saveTarget === 'notion_portfolio' && (
                                            <div className="flex flex-wrap gap-1.5 mb-1 relative">
                                                {selectedStudents.map(s => (
                                                    <span key={s.id} className="text-xs px-2.5 py-1 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                                        {s.name}
                                                        {s.id !== student.id && <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500 bg-indigo-100 rounded-full p-0.5"><Icon d={PATHS.x} size={10}/></button>}
                                                    </span>
                                                ))}
                                            </div>
                                        )}

                                        {/* [New] ì €ì¥ì†Œ ì„ íƒ íƒ­ UI */}
                                        <div className="flex gap-1 bg-white p-1 rounded-xl border border-slate-200">
                                            <button onClick={() => setSaveTarget('notion_record')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'notion_record' ? 'bg-indigo-50 text-indigo-600 shadow-sm ring-1 ring-indigo-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(ê¸°ë¡)</button>
                                            <button onClick={() => setSaveTarget('notion_portfolio')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'notion_portfolio' ? 'bg-amber-50 text-amber-600 shadow-sm ring-1 ring-amber-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(í¬í´)</button>
                                            <button onClick={() => setSaveTarget('google_sheet')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'google_sheet' ? 'bg-green-50 text-green-600 shadow-sm ring-1 ring-green-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>
                                        </div>

                                        <div className="flex items-center gap-2 relative z-20">
                                            {saveTarget === 'notion_portfolio' && (
                                                <div className="flex-1 relative">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <Icon d={PATHS.search} size={14} className="text-slate-400" />
                                                    </div>
                                                    <input 
                                                        placeholder="ë‹¤ë¥¸ í•™ìƒ í•¨ê»˜ íƒœê·¸í•˜ê¸°..." 
                                                        className="w-full p-2.5 pl-9 bg-white border border-slate-300 rounded-xl text-xs font-medium outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all shadow-sm" 
                                                        value={searchText}
                                                        onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }}
                                                        onFocus={() => setShowStudentDropdown(true)}
                                                        onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)}
                                                    />
                                                    {showStudentDropdown && (
                                                        <div className="absolute top-full left-0 w-full bg-white shadow-2xl border border-slate-200 rounded-xl z-50 max-h-48 overflow-y-auto mt-2 custom-scroll py-1 animate-fade-in">
                                                            <div className="px-3 py-1.5 text-[10px] font-bold text-slate-400 bg-slate-50 border-b border-slate-100 mb-1">í•™ìƒ ê²€ìƒ‰</div>
                                                            {students.filter(s => s.name.includes(searchText)).sort((a, b) => a.name.localeCompare(b.name)).map(s => (
                                                                <div 
                                                                    key={s.id} 
                                                                    className="px-3 py-2.5 text-xs text-slate-700 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center"
                                                                    onMouseDown={() => { handleStudentSelect(s.name); setSearchText(""); }}
                                                                >
                                                                    <span className="font-bold flex items-center gap-2"><span className="text-[10px] text-slate-400 font-normal">{s.order}ë²ˆ</span> {s.name}</span>
                                                                    {selectedStudents.find(sel => sel.id === s.id) && <Icon d={PATHS.check} size={12} className="text-indigo-500 bg-indigo-100 rounded-full p-0.5"/>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-600 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 shadow-sm" />
                                        </div>
                                        
                                        <textarea 
                                            value={notionContent}
                                            onChange={(e) => setNotionContent(e.target.value)}
                                            className="w-full p-3.5 bg-white border border-slate-300 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 resize-none h-24 placeholder-slate-400 shadow-sm"
                                            placeholder="ê´€ì°°í•œ ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                        />
                                        
                                        <div className="flex justify-end -mt-1">
                                            <label className="flex items-center gap-1.5 cursor-pointer select-none">
                                                <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5 text-indigo-600 rounded focus:ring-indigo-500" />
                                                <span className="text-[10px] text-slate-500 font-bold hover:text-slate-700">ì €ì¥ í›„ ë‚´ìš© ìœ ì§€</span>
                                            </label>
                                        </div>
                                        
                                        <div className="flex gap-2.5">
                                            <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} disabled={notionStatus === 'saving'} className={`relative flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md ${notionStatus === 'saving' ? 'bg-rose-300' : 'bg-rose-500 hover:bg-rose-600 active:scale-95'}`}>
                                                ì¹­ì°¬í•˜ê¸° +1
                                            </button>
                                            <button onClick={() => handleIntegratedSave('ê´€ì°°')} disabled={notionStatus === 'saving'} className={`flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md ${notionStatus === 'saving' ? 'bg-indigo-300' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                                                ê´€ì°° ê¸°ë¡ ì €ì¥
                                            </button>
                                        </div>
                                        {notionStatus === 'success' && <div className="text-center text-xs text-green-600 font-bold animate-fade-in bg-green-50 py-1.5 rounded-lg border border-green-200">âœ… ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>}
                                    </div>

                                    {/* Logs Search & Accordion */}
                                    <div className="mb-4 flex gap-2 relative">
                                        
                                        {/* 1. í…ìŠ¤íŠ¸ ê²€ìƒ‰ì°½ */}
                                        <div className="relative flex-1">
                                            <Icon d={PATHS.search} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                                            <input
                                                type="text"
                                                value={searchTerm}
                                                onChange={e => setSearchTerm(e.target.value)}
                                                placeholder="ë‚´ìš© ë˜ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒ..."
                                                className="w-full pl-9 pr-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none transition-colors"
                                            />
                                        </div>
                                        
                                        {/* 2. ë‹¬ë ¥ ì—¬ëŠ” ë²„íŠ¼ */}
                                        <button
                                            onClick={() => setShowSearchCal(!showSearchCal)}
                                            className="p-2 border border-slate-200 bg-slate-50 rounded-xl hover:bg-indigo-50 text-slate-500 transition-colors"
                                            title="ë‹¬ë ¥ìœ¼ë¡œ ë‚ ì§œ ì°¾ê¸°"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </button>

                                        {/* 3. íŠ¹ì • ë‚ ì§œ ì„ íƒ ì‹œ ì·¨ì†Œ(X) ë²„íŠ¼ (í•„ìˆ˜ ë³µêµ¬!) */}
                                        {selectedDate && (
                                            <button onClick={() => setSelectedDate(null)} className="px-3 py-2 bg-indigo-50 border border-indigo-100 text-indigo-600 rounded-xl text-xs font-bold whitespace-nowrap flex items-center gap-1 hover:bg-indigo-100 transition-colors">
                                                {dayjs(selectedDate).format('MM/DD')} <Icon d={PATHS.x} size={12}/>
                                            </button>
                                        )}

                                        {/* 4. ë¯¸ë‹ˆ íŒì—… ë‹¬ë ¥ */}
                                        {showSearchCal && (
                                            <div className="absolute top-12 right-0 mt-1 bg-white border border-slate-200 shadow-2xl rounded-xl p-4 z-50 w-64 animate-fade-in">
                                                <div className="flex justify-between items-center mb-3">
                                                    <button onClick={() => setCalMonth(calMonth.subtract(1, 'month'))} className="p-1 hover:bg-slate-100 rounded-lg text-slate-500">&lt;</button>
                                                    <span className="font-bold text-sm text-slate-700">{calMonth.format('YYYYë…„ MMì›”')}</span>
                                                    <button onClick={() => setCalMonth(calMonth.add(1, 'month'))} className="p-1 hover:bg-slate-100 rounded-lg text-slate-500">&gt;</button>
                                                </div>
                                                <div className="grid grid-cols-7 gap-1 text-center text-[11px] mb-2 font-bold text-slate-400">
                                                    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                                                </div>
                                                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                                                    {Array.from({ length: calMonth.startOf('month').day() }).map((_, i) => <div key={`empty-${i}`} />)}
                                                    {Array.from({ length: calMonth.daysInMonth() }).map((_, i) => {
                                                        const dateStr = calMonth.date(i + 1).format('YYYY-MM-DD');
                                                        const hasRecord = recordDates.includes(dateStr); 
                                                        const isSelected = searchTerm === dateStr;
                                                        return (
                                                            <button
                                                                key={i}
                                                                onClick={() => {
                                                                    setSearchTerm(dateStr); 
                                                                    setShowSearchCal(false); 
                                                                }}
                                                                className={`relative p-1.5 rounded-lg hover:bg-indigo-50 transition-colors ${isSelected ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-slate-600'}`}
                                                            >
                                                                <span>{i + 1}</span>
                                                                {hasRecord && <div className="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 bg-indigo-500 rounded-full"></div>}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1 max-h-[400px]">
                                        {displayedNotes.length > 0 ? displayedNotes.map(n => (
                                            <div key={n.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm group hover:border-indigo-200 transition-colors">
                                                {editingNoteId === n.id ? (
                                                    <div className="flex flex-col gap-3">
                                                        <textarea value={editNoteContent} onChange={(e) => setEditNoteContent(e.target.value)} className="w-full p-3 border border-indigo-300 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-100 resize-none bg-indigo-50/30" rows="3" />
                                                        <div className="flex justify-end gap-2">
                                                            <Btn onClick={() => setEditingNoteId(null)} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                                                            <Btn onClick={saveEditing} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold shadow-md hover:bg-indigo-700">ì €ì¥</Btn>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-1.5 flex-wrap">
                                                                <span className="text-[10px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-2 py-1 rounded-md">{n.date}</span>
                                                                
                                                                {/* 1. ì˜ˆì „ ê¸°ë¡ í˜¸í™˜ìš© (ë‹¨ì¼ ë°°ì§€) */}
                                                                {n.destTag && !n.destTags && (
                                                                    <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded border shadow-sm ${n.destTag.includes('ë…¸ì…˜') ? (n.destTag.includes('í¬í´') ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100') : 'bg-green-50 text-green-600 border-green-100'}`}>
                                                                        {n.destTag}
                                                                    </span>
                                                                )}

                                                                {/* 2. ìƒˆë¡œìš´ ê¸°ë¡ìš© (ì—¬ëŸ¬ ê°œì˜ ë°°ì§€ë¥¼ ë‚˜ë€íˆ í‘œì‹œ) */}
                                                                {n.destTags && n.destTags.map((tag, idx) => (
                                                                    <span key={idx} className={`text-[9px] font-bold px-1.5 py-0.5 rounded border shadow-sm ${tag.includes('ë…¸ì…˜') ? (tag.includes('í¬í´') ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100') : 'bg-green-50 text-green-600 border-green-100'}`}>
                                                                        {tag}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={() => startEditing(n)} className="text-slate-400 hover:text-indigo-600 p-1 bg-slate-50 hover:bg-indigo-50 rounded"><Icon d={PATHS.edit} size={14}/></button>
                                                                <button onClick={() => handleDeleteNote(n.id)} className="text-slate-400 hover:text-rose-600 p-1 bg-slate-50 hover:bg-rose-50 rounded"><Icon d={PATHS.x} size={14}/></button>
                                                            </div>
                                                        </div>
                                                        <p className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed font-medium">{n.content}</p>
                                                    </>
                                                )}
                                            </div>
                                        )) : (
                                            <div className="h-32 flex flex-col items-center justify-center text-slate-400 text-sm gap-3 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                                                <Icon d={PATHS.document} size={24} className="opacity-30" />
                                                <span>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                            </div>
                                        )}
                                        {hasMore && (
                                            <button onClick={() => setIsExpanded(!isExpanded)} className="w-full py-3 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-3 shadow-sm">
                                                {isExpanded ? 'ì ‘ê¸°' : `ê³¼ê±° ê¸°ë¡ ${filteredNotes.length - 2}ê°œ ë” ë³´ê¸°`} 
                                                <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {/* [ìˆ˜ì •ë¨] Grass Chart Area - 5x5 ë‹¬ë ¥í˜• ë° ì˜¤ëŠ˜ ë‚ ì§œ í…Œë‘ë¦¬ ê°•ì¡° */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                            <Icon d={PATHS.calendar} size={16} className="text-orange-500"/> í™œë™ ì”ë””
                                        </h4>
                                        <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                                            <button onClick={() => { const prev = dayjs(grassStart).subtract(1, 'month'); setGrassStart(prev.startOf('month').format('YYYY-MM-DD')); setGrassEnd(prev.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.left} size={12}/></button>
                                            <button onClick={() => { const now = dayjs(); setGrassStart(now.startOf('month').format('YYYY-MM-DD')); setGrassEnd(now.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(false); }} className="text-[10px] px-2.5 py-1 rounded-md font-bold text-slate-600 hover:bg-white shadow-sm transition-all">ì´ë²ˆ ë‹¬</button>
                                            <button onClick={() => { const next = dayjs(grassStart).add(1, 'month'); setGrassStart(next.startOf('month').format('YYYY-MM-DD')); setGrassEnd(next.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.right} size={12}/></button>
                                            <button onClick={() => setIsCalendarOpen(true)} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all ml-1" title="ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={12}/></button>
                                        </div>
                                    </div>
                                    
                                    {/* 5x5 ê·¸ë¦¬ë“œ êµ¬ì¡° ì ìš© */}
                                    <div className="grid grid-cols-5 gap-y-4 gap-x-2 justify-items-center py-2 mt-2">
                                        {displayedGrass.map((h, i) => {
                                            const isToday = h.date === todayStr;
                                            return (
                                            <div key={i} onClick={() => setSelectedDate(selectedDate === h.date ? null : h.date)} className={`flex flex-col items-center gap-1.5 group relative cursor-pointer p-1.5 rounded-xl transition-all ${selectedDate === h.date ? 'bg-indigo-50 ring-2 ring-indigo-200 scale-105 shadow-sm' : 'hover:bg-slate-50 border border-transparent hover:border-slate-100'} ${isToday ? 'scale-110 z-10' : ''}`}>
                                                <div className={`w-10 h-10 rounded-full shadow-inner flex items-center justify-center relative overflow-hidden bg-slate-100 ${isToday ? 'ring-2 ring-green-500 ring-offset-2' : ''}`} style={getPieStyle(h.ratio)}></div>
                                                <span className={`text-[10px] ${isToday ? 'text-rose-600 font-extrabold' : selectedDate === h.date ? 'text-indigo-700 font-bold' : 'text-slate-500 font-medium'}`}>{dayjs(h.date).format('MM/DD')}</span>
                                                <div className="absolute bottom-full mb-2 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10 transition-all shadow-lg transform translate-y-1 group-hover:translate-y-0">
                                                    {h.date} {Math.round(h.ratio * 100)}% ({h.count}/{h.total})
                                                    <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>

                                    {/* ì ‘ê³  í´ê¸° êº½ì‡  ë²„íŠ¼ */}
                                    {grassHistory.length > 5 && (
                                        <button onClick={() => setIsGrassExpanded(!isGrassExpanded)} className="w-full py-2 text-xs font-bold text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-4 shadow-sm">
                                            {isGrassExpanded ? 'ì´ë²ˆ ì£¼ë§Œ ë³´ê¸°' : 'ì´ë²ˆ ë‹¬ ì „ì²´ ë³´ê¸°'}
                                            <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isGrassExpanded ? 'rotate-180' : ''}`} />
                                        </button>
                                    )}
                                </div>

                            </div>
                        </div>

                        {/* ìˆ¨ê²¨ì§„ ë¦¬í¬íŠ¸ ëª¨ë‹¬, AI ëª¨ë‹¬ ë“± ëª¨ë‘ ìœ ì§€ */}
                        <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                            <div ref={reportRef} className={`w-[800px] bg-white p-12 border border-slate-200 text-slate-800 ${reportFont === 'serif' ? 'font-serif' : reportFont === 'hand' ? 'font-hand' : reportFont === 'jua' ? 'font-jua' : reportFont === 'nanum' ? 'font-nanum' : reportFont === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                                <div className="text-center border-b-2 border-slate-800 pb-6 mb-8">
                                    <h1 className="text-4xl font-extrabold text-slate-900 mb-2">ğŸŒ± í•™ìŠµ ì„±ì¥ ë¦¬í¬íŠ¸</h1>
                                    <p className="text-slate-500 text-lg">{dayjs().format('YY.MM.DD')}</p>
                                </div>
                                <div className="flex gap-8 mb-8">
                                    <div className="w-32 h-32 rounded-full bg-slate-100 border-4 border-slate-200 overflow-hidden flex items-center justify-center flex-shrink-0">
                                        <span className="text-6xl">{student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center">
                                        <div className="flex items-baseline gap-3 mb-2"><h2 className="text-3xl font-bold text-slate-800">{student.name}</h2><span className="text-xl text-slate-500">{student.order}ë²ˆ</span></div>
                                        <div className="flex gap-4"><span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-bold">Lv.{level}</span><span className="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span><span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg font-bold">ì¹­ì°¬ ìŠ¤í‹°ì»¤ {stickerCount}ê°œ</span></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-8 mb-8">
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ğŸ“Š í™œë™ ë¶„ì„</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center"><span className="text-slate-600">ìµœê·¼ 30ì¼ í™œë™</span><span className="font-bold text-indigo-600">{student.history.length}ì¼ ì¤‘ {student.history.filter(h=>h.ratio===1).length}ì¼ ì™„ë£Œ</span></div>
                                            <div><span className="text-slate-600 block mb-1">ìì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</span>{missedTags.length > 0 ? (<div className="flex gap-2 flex-wrap">{missedTags.map(([t, c]) => <span key={t} className="text-xs bg-white border border-slate-200 px-2 py-1 rounded-md text-rose-500 font-bold">{t} ({c}íšŒ)</span>)}</div>) : <span className="text-sm text-green-600 font-bold">ì—†ìŒ (í›Œë¥­í•´ìš”!)</span>}</div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-100">
                                            <h4 className="text-sm font-bold text-slate-600 mb-2">ğŸ“Š í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                            <div className="space-y-2">
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">{student.name}</span><span className={`font-bold ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${getLevelColor(level)}`} style={{ width: `${reportStats.studentRate}%` }}></div></div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">í•™ê¸‰ í‰ê· </span><span className="font-bold text-slate-600">{reportStats.classRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-400" style={{ width: `${reportStats.classRate}%` }}></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ğŸ“ ì„ ìƒë‹˜ì˜ í•œë§ˆë””</h3>
                                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{aiComment || "ë¶„ì„ ì¤‘..."}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showCounselingAI && (
                            <CounselingAIModal isOpen={showCounselingAI} onClose={() => setShowCounselingAI(false)} student={student} apiKey={apiKey} showToast={showToast} onSave={handleSaveAIAdvice} notes={notes} />
                        )}

                        {showStudentRecordAI && (
                            <StudentRecordAIModal isOpen={showStudentRecordAI} onClose={() => setShowStudentRecordAI(false)} student={student} students={students} apiKey={apiKey} showToast={showToast} notes={notes} dailyTasks={dailyTasks} records={records} appConfig={appConfig} onSaveDraft={onSaveRecordDraft} />
                        )}

                        {showReportEdit && (
                            <div className="fixed inset-0 bg-black/50 z-[1700] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={() => setShowReportEdit(false)}>
                                <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon d={PATHS.edit} className="text-indigo-500" /> ë¦¬í¬íŠ¸ ì‘ì„±</h3>
                                        <button onClick={() => setShowReportEdit(false)} className="p-2 hover:bg-slate-100 rounded-full"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                            <input type="date" value={reportStart} onChange={e=>setReportStart(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                            <span className="text-xs text-slate-400">~</span>
                                            <input type="date" value={reportEnd} onChange={e=>setReportEnd(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ìƒë‹´ ëª©ì  (Purpose)</label>
                                                <select value={reportPurpose} onChange={e=>setReportPurpose(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="regular">ğŸ“… ì •ê¸° ìƒë‹´ (ì„±ì¥ ê³µìœ )</option><option value="issue">â¤ï¸ ìƒí™œ ì§€ë„ (ë¬¸ì œ ê°œì„ )</option><option value="study">ğŸ“š í•™ì—… ìƒë‹´ (ì„±ì  í–¥ìƒ)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ë¦¬í¬íŠ¸ ì–´ì¡° (Tone)</label>
                                                <select value={reportTone} onChange={e=>setReportTone(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="warm">ğŸ¥° ë”°ëœ»/ì¹­ì°¬ (ê¸°ë³¸)</option><option value="rational">ğŸ“Š ê°ê´€/ë¶„ì„</option><option value="coaching">ğŸ”¥ ì„±ì¥/ì½”ì¹­</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ê¸€ê¼´ (Font)</label>
                                                <select value={reportFont} onChange={e=>setReportFont(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="sans">ê¸°ë³¸ ê³ ë”•</option><option value="nanum">ë‚˜ëˆ”ê³ ë”•</option><option value="nanum-bold">ë‚˜ëˆ”ê³ ë”• (Bold)</option><option value="serif">ë‚˜ëˆ”ëª…ì¡°</option><option value="jua">ì£¼ì•„ì²´</option><option value="hand">ê°œêµ¬ì²´ (ì†ê¸€ì”¨)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ì¤‘ì  ë¶„ì„ ë¶„ì•¼ (Focus)</label>
                                                <select value={reportFocus} onChange={e=>setReportFocus(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="comprehensive">ğŸ« í•™êµìƒí™œ ì¢…í•©</option><option value="study">ğŸ“ í•™ìŠµ íƒœë„</option><option value="relationship">ğŸ¤ êµìš° ê´€ê³„</option><option value="habit">â° ìƒí™œ ìŠµê´€</option></select>
                                            </div>
                                        </div>
                                        <Btn onClick={generateReportContent} disabled={isGenerating} className={`w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 ${apiKey ? 'bg-violet-100 text-violet-700 hover:bg-violet-200' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                                            {isGenerating ? 'ì‘ì„± ì¤‘...' : apiKey ? 'âœ¨ AIë¡œ ë¦¬í¬íŠ¸ ìƒˆë¡œ ì‘ì„±í•˜ê¸°' : 'ğŸ”„ ê¸°ê°„ ì„¤ì • ì ìš©í•˜ì—¬ ë‹¤ì‹œ ì“°ê¸°'}
                                        </Btn>
                                        {!apiKey && <div className="text-[10px] text-slate-400 mt-1 text-center">* ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë” í’ì„±í•œ ë‚´ìš©ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.</div>}
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-end px-1">
                                            <div className="flex gap-2 items-center">
                                                <span className="text-xs font-bold text-slate-500">ë‚´ìš© í¸ì§‘</span>
                                                <div className="relative">
                                                    <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                                        <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                                    </button>
                                                    {showPhraseList && (
                                                        <div className="absolute left-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                            <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                                <span className="text-xs font-bold text-slate-600">ì €ì¥ëœ ë¬¸êµ¬</span>
                                                                <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
                                                            </div>
                                                            <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                                {phrases.length > 0 ? phrases.map((p, i) => (
                                                                    <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                                        <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                                    </div>
                                                                )) : <div className="text-center text-slate-400 text-xs py-2">ì €ì¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <button onClick={() => { let comment = `${student.name} í•™ìƒì€ í˜„ì¬ ë ˆë²¨ ${level}ë¡œ, í‰ê·  ìˆ˜í–‰ë¥  ${avgRate}%ë¥¼ ê¸°ë¡í•˜ë©° ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ${missedTags.length > 0 ? `íŠ¹íˆ ${missedTags.map(t=>t[0]).join(', ')} ê³¼ëª©ì— ì¡°ê¸ˆ ë” ê´€ì‹¬ì„ ê¸°ìš¸ì¸ë‹¤ë©´ ë”ìš± ì„±ì¥í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.` : "ëª¨ë“  ê³¼ëª©ì—ì„œ ê³ ë¥´ê²Œ ìš°ìˆ˜í•œ ëª¨ìŠµì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤."} ê°€ì •ì—ì„œë„ ë§ì€ ì¹­ì°¬ê³¼ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`; setTempComment(comment); }} className="text-[10px] text-slate-400 hover:text-rose-500 underline">ì´ˆê¸°í™”</button>
                                        </div>
                                        <textarea className="w-full h-48 p-4 border border-slate-200 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none custom-scroll" value={tempComment} onChange={(e) => setTempComment(e.target.value)} placeholder="ë¦¬í¬íŠ¸ì— ë“¤ì–´ê°ˆ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." />
                                        <div className="flex gap-2">
                                            <Btn onClick={handleSaveReportDraft} className="flex-1 py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.check} /> ì´ˆì•ˆ ì €ì¥</Btn>
                                            <Btn onClick={handleCopyText} className="flex-1 py-3 bg-white border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.copy} /> í…ìŠ¤íŠ¸ ë³µì‚¬</Btn>
                                            <Btn onClick={handleDownloadReport} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Icon d={PATHS.download} /> ì´ë¯¸ì§€ë¡œ ì €ì¥</Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isCalendarOpen && (
                            <CalendarModal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} currentDate={grassStart} selectionMode="range" onSelectRange={(s, e) => { setGrassStart(s); setGrassEnd(e); }} records={records} appConfig={appConfig} groupsByDate={{}} mode="record" />
                        )}
                    </div>
                </div>
            );
        };
        const StudentRecordAIModal = ({ isOpen, onClose, student, students, apiKey, showToast, notes, dailyTasks, records, appConfig, onSaveDraft }) => {
            const [draft, setDraft] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [keywords, setKeywords] = useState("");
            const [recordType, setRecordType] = useState("behavior"); // behavior (í–‰ë°œ), subject (êµê³¼)
            const contentRef = useRef(null);
            const [semester, setSemester] = useState("1"); // 1, 2, all
            const [progress, setProgress] = useState(0);
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_behavior_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const textareaRef = useRef(null);

            useEffect(() => {
                if (isOpen && student) {
                    const draftKey = `${recordType}_${semester}`;
                    const savedDraft = student.recordDrafts?.[draftKey] || "";
                    setDraft(savedDraft);
                }
            }, [isOpen, student, semester, recordType]);

            useEffect(() => {
                const today = dayjs();
                let sDate = today.startOf('year').format('YYYY-MM-DD');
                let eDate = today.endOf('year').format('YYYY-MM-DD');

                if (semester === '1') { 
                    if (appConfig?.sem1Start) sDate = appConfig.sem1Start;
                    if (appConfig?.sem1End) eDate = appConfig.sem1End;
                    else eDate = today.year() + '-07-31'; 
                } else if (semester === '2') { 
                    if (appConfig?.sem2Start) sDate = appConfig.sem2Start;
                    else sDate = today.year() + '-08-01';
                    if (appConfig?.sem2End) eDate = appConfig.sem2End;
                }
                setStartDate(sDate);
                setEndDate(eDate);
            }, [semester, appConfig]);

            const handleGenerate = async () => {
                setIsGenerating(true);
                setProgress(0);
                const timer = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 500);
                try {
                    // Simple stats calculation
                    let totalTasks = 0;
                    let doneTasks = 0;
                    // Iterate roughly through the year or just use what's available in records/dailyTasks
                    Object.keys(dailyTasks).forEach(date => {
                        if (date >= startDate && date <= endDate) {
                            const tasks = dailyTasks[date];
                            const rec = records[date]?.[student.id];
                            if (tasks && tasks.length > 0) {
                                totalTasks += tasks.length;
                                tasks.forEach((_, idx) => {
                                    if (rec && (rec.tasks?.[idx] || (rec.done && !rec.tasks))) doneTasks++;
                                });
                            }
                        }
                    });
                    const taskRate = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;

                    const validNotes = notes.filter(n => n.date >= startDate && n.date <= endDate);
                    const isInsufficient = validNotes.length < 2;

                    // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™”
                    const safeName = "[STUDENT_TOKEN]";
                    let safeNotesStr = validNotes.length > 0 ? validNotes.map(n => `- [${n.date}] ${n.content}`).join('\n') : 'ê¸°ë¡ ì—†ìŒ';
                    safeNotesStr = anonymizeText(safeNotesStr, student.name);
                    if (students) {
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                    }
                    const safeKeywords = anonymizeText(keywords || 'ì—†ìŒ', student.name);

                    let lengthConstraint = "";
                    if (semester === '1') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 450ì ì´ë‚´ë¡œ ì‘ì„±í•  ê²ƒ.";
                    } else if (semester === '2') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 550ì ì´ë‚´ë¡œ ì‘ì„±í•  ê²ƒ.";
                    }

                    const securityRule = "[ë³´ì•ˆ ê·œì¹™: ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]";

                    let prompt = "";
                    if (recordType === 'behavior') { // í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ (ê¸°ë…êµ ëŒ€ì•ˆí•™êµ ìŠ¤íƒ€ì¼)
                        prompt = `
                            ${securityRule}

                            # Role
                            ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ì ë‹´ì„ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³ , í•™ìƒì˜ ì „ì¸ì  ì„±ì¥ì„ ë•ëŠ” 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬(ì´í‰)'ì„ ì‘ì„±í•©ë‹ˆë‹¤.

                            # Strict Guidelines (ì‘ì„± ì›ì¹™)
                            1. **Fact-Based**: ë°˜ë“œì‹œ ì œê³µëœ [êµì‚¬ ê´€ì°° ê¸°ë¡]ì— ìˆëŠ” ë‚´ìš©ë§Œìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”.
                            2. **Data Validation**: ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ì‘ì„±í•˜ê¸°ì— ì •ë³´ê°€ í˜„ì €íˆ ë¶€ì¡±í•˜ë‹¤ë©´, ì–µì§€ë¡œ ë‚´ìš©ì„ ë§Œë“¤ì§€ ë§ê³  "ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì„ ë” ì…ë ¥í•´ì£¼ì„¸ìš”."ë¼ê³ ë§Œ ì¶œë ¥í•˜ê³  ì‘ì„±ì„ ì¤‘ë‹¨í•˜ì„¸ìš”.
                            3. **Subject**: ë¬¸ì¥ì˜ ì£¼ì–´ëŠ” ë°˜ë“œì‹œ 'í•™ìƒ'ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (êµì‚¬ì˜ ê´€ì°°, ê²½í—˜, ê°ì •ì´ ì£¼ì–´ê°€ ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜)
                            4. **Tone**: ê³µì‹ ë¬¸ì„œ(ìƒí™œê¸°ë¡ë¶€)ì´ë¯€ë¡œ ì§€ë‚˜ì¹˜ê²Œ ë¬¸í•™ì ì¸ í‘œí˜„ì€ ìì œí•˜ê³ , ëª…í™•í•˜ê³  ì •ì¤‘í•œ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                            5. **Growth Focus**: ì „ë…„/ì „í•™ê¸°ì— ë¹„í•´ ì˜ì , ì¸ì§€ì , ì •ì„œì , í•™ìŠµì , ì‚¬íšŒë„ë•ì , ì‹ ì²´ì  ë¶€ë¶„ì—ì„œ ì–´ë–¤ ì„±ì¥ì´ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ ë“œëŸ¬ë‚˜ë„ë¡ ê¸°ìˆ í•˜ì„¸ìš”.

                            # Writing Structure (ì‘ì„± ìˆœì„œ)
                            ë‹¤ìŒ ìˆœì„œì™€ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í•˜ë‚˜ì˜ ì™„ì„±ëœ ê¸€ë¡œ ì‘ì„±í•˜ì„¸ìš”.
                            1. **í•µì‹¬ íŠ¹ì„±**: ì „ì²´ ì£¼ì œì–´ê°€ ë ë§Œí•œ í•µì‹¬ íŠ¹ì„±ì„ ìˆ˜ì‹ì–´ë¡œ ì‚¬ìš©í•˜ì—¬ í•™ìƒì„ ì†Œê°œí•˜ëŠ” ì²« ë¬¸ì¥. (ì˜ˆ: "ì„¬ê¸°ëŠ” ê²ƒì„ ê¸°ë»í•˜ëŠ” [STUDENT_TOKEN]ì´ëŠ”...")
                            2. **ì˜ì  ì„±ì¥**: ì½”ëŒë°ì˜¤ ì‹œê°„, í•˜ë‚˜ë‹˜ì„ ì•„ëŠ” ì§€ì‹ì—ì„œì˜ ì„±ì¥ (ê¸°ë¡ì´ ìˆì„ ê²½ìš°).
                            3. **ì§€ì  ì„±ì¥**: êµê³¼ í•™ìŠµì—ì„œì˜ ì„±ì¥, ì¬ëŠ¥ê³¼ ì€ì‚¬.
                            4. **í•™ìŠµ íƒœë„**: ê¸°ìˆ , ì „ëµì—ì„œì˜ ì„±ì¥.
                            5. **ì •ì„œì  ë°œë‹¬**: ì •ì„œì  ì•ˆì •ì„±, ì¡°ì ˆ, í™œìš© ëŠ¥ë ¥.
                            6. **ì„±í’ˆ ë° í–‰ë™**: ë°°ë ¤, ë¦¬ë”ì‹­, êµìš° ê´€ê³„.
                            7. **ì œì–¸**: ë¶€ì¡±í•œ ë¶€ë¶„, ì—°ì•½í•œ ë¶€ë¶„ì— ëŒ€í•œ ì•„ì‰¬ì›€ê³¼ êµ¬ì²´ì ì¸ êµìœ¡ì  ì œì•ˆ.
                            8. **ê¸°ëŒ€**: í–¥í›„ í•˜ë‚˜ë‹˜ì´ í•˜ì‹¤ ë¶€ë¶„ì— ëŒ€í•œ ê¸°ëŒ€ì™€ ì¶•ë³µ.
                            
                            # Input Data
                            - ì´ë¦„: ${safeName}
                            - ì„±ì‹¤ì„±(ê³¼ì œ ìˆ˜í–‰ë¥ ): ${taskRate}%
                            - ì¹­ì°¬ ìŠ¤í‹°ì»¤: ${student.stickers}ê°œ
                            - í‚¤ì›Œë“œ: ${safeKeywords}
                            
                            [êµì‚¬ ê´€ì°° ê¸°ë¡ (ê¸°ì´ˆ ìë£Œ)]
                            ${safeNotesStr}

                            ${isInsufficient ? "ì£¼ì˜: ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ìœ„ ì›ì¹™ì— ë”°ë¼ 'ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬...' ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜, ìˆ˜í–‰ë¥  ë°ì´í„°ë§Œìœ¼ë¡œ ì•„ì£¼ ê°„ëµí•˜ê²Œ ì‚¬ì‹¤ë§Œ ê¸°ìˆ í•˜ì„¸ìš”." : "ìœ„ ì›ì¹™ê³¼ ìˆœì„œì— ë§ì¶° ì‘ì„±í•˜ì„¸ìš”."}
                        `;
                    } else {
                        prompt = `
                            ${securityRule}

                            # Role Definition
                            ì´ˆë“±í•™êµ êµì‚¬ë¡œì„œ 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©'ì„ ì‘ì„±í•˜ë¼.

                            # Strict Guidelines
                            1. **Fact Only**: ì œê³µëœ ê´€ì°° ê¸°ë¡ì— ìˆëŠ” ë‚´ìš©ë§Œ ì„œìˆ í•˜ë¼.
                            2. **No Hallucination**: í•™ìƒì´ íŠ¹ì • ê³¼ëª©ì„ ì˜í–ˆëŠ”ì§€ ëª»í–ˆëŠ”ì§€ ê¸°ë¡ì— ì—†ë‹¤ë©´ ì–¸ê¸‰í•˜ì§€ ë§ˆë¼.
                            3. **ë°ì´í„° ë¶€ì¡± ì‹œ**: "íŠ¹ì´ ì‚¬í•­ ì—†ìŒ" ë˜ëŠ” ê³¼ì œ ìˆ˜í–‰ë¥ ë§Œ ì–¸ê¸‰í•˜ê³  ë§ˆë¬´ë¦¬í•˜ë¼.

                            [êµì‚¬ ê´€ì°° ê¸°ë¡]
                            ${safeNotesStr}
                            
                            ìœ„ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ, ê³¼í•™, ì˜ì–´ ë“± êµê³¼ ê´€ë ¨ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì´ ì—†ëŠ” ê³¼ëª©ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.
                        `;
                    }

                    const text = await callGemini(apiKey, prompt, 0.1);
                    clearInterval(timer);
                    setProgress(100);
                    
                    // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                    const finalContent = deanonymizeText(text, student.name);
                    setDraft(finalContent);
                } catch (e) {
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    clearInterval(timer);
                    showToast("ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleAddPhrase = () => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                const textToSave = (textarea.value.substring(textarea.selectionStart, textarea.selectionEnd) || textarea.value).trim();
                if (!textToSave) return showToast("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, textToSave];
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
            };
            const handleApplyPhrase = (text) => {
                setDraft(prev => prev + (prev ? " " : "") + text);
                setShowPhraseList(false);
            };

            const handleSave = () => {
                if (semester === 'all') {
                    showToast("ì „ì²´ í•™ê¸° ì´ˆì•ˆì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 1í•™ê¸° ë˜ëŠ” 2í•™ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                const draftKey = `${recordType}_${semester}`;
                onSaveDraft(student.id, draftKey, draft);
            };

            const handleDownloadPdf = async () => {
                if (!contentRef.current) return;
                if (!window.jspdf) return showToast("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(contentRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`${student.name}_${recordType === 'behavior' ? 'ì´í‰' : 'êµê³¼ë°œë‹¬'}_ì´ˆì•ˆ_${dayjs().format('YYYYMMDD')}.pdf`);
                    showToast("PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ PDF ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    showToast("PDF ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“ AI ì´í‰ ì´ˆì•ˆ ìƒì„±">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                            <p className="font-bold mb-1">ğŸ’¡ ìƒí™œê¸°ë¡ë¶€ ì´ˆì•ˆì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">1ë…„ ë™ì•ˆì˜ ê³¼ì œ ìˆ˜í–‰, ìŠ¤í‹°ì»¤, ìƒë‹´ ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ AIê°€ ì‘ì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì„ ìƒë‹˜ì˜ ê²€í† ì™€ ìˆ˜ì •ì„ ê±°ì³ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex flex-col gap-2">
                            <label className="text-xs font-bold text-slate-500">ì¶”ê°€ ê°•ì¡°í•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œ (ì„ íƒ)</label>
                            <input value={keywords} onChange={e => setKeywords(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-blue-500" placeholder="ì˜ˆ: ë´‰ì‚¬ì •ì‹ , ì°½ì˜ë ¥, ë…ì„œì™•..." />
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">í•™ê¸° ì„ íƒ:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setSemester('1')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '1' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>1í•™ê¸°</button>
                                <button onClick={() => setSemester('2')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '2' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>2í•™ê¸°</button>
                                <button onClick={() => setSemester('all')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === 'all' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ì „ì²´</button>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                             <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                             <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                             <span className="text-xs text-slate-400">~</span>
                             <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">ìƒì„± í•­ëª©:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setRecordType('behavior')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'behavior' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬</button>
                                <button onClick={() => setRecordType('subject')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'subject' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>êµê³¼ í•™ìŠµ ë°œë‹¬</button>
                            </div>
                        </div>

                        <Btn onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2">
                            {isGenerating ? <><Icon d={PATHS.spinner} className="animate-spin" /> ì‘ì„± ì¤‘... {Math.round(progress)}%</> : <><Icon d={PATHS.magic} /> ì´ˆì•ˆ ìƒì„±í•˜ê¸°</>}
                        </Btn>

                        {draft && (
                            <div ref={contentRef} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm animate-fade-in">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold text-slate-500">ìƒì„±ëœ ì´ˆì•ˆ</span>
                                    <div className="relative">
                                        <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                            <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                        </button>
                                        {showPhraseList && (
                                            <div className="absolute right-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                    <span className="text-xs font-bold text-slate-600">ì €ì¥ëœ ë¬¸êµ¬</span>
                                                    <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">ì„ íƒ/ì „ì²´ ì €ì¥</button>
                                                </div>
                                                <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                    {phrases.length > 0 ? phrases.map((p, i) => (
                                                        <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                            <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                            <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                        </div>
                                                    )) : <div className="text-center text-slate-400 text-xs py-2">ì €ì¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-slate-100 text-[9px] text-slate-400 text-center">
                                                    * í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ í›„ ì €ì¥í•˜ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <textarea ref={textareaRef} value={draft} onChange={e => setDraft(e.target.value)} className="w-full h-48 text-sm leading-relaxed text-slate-700 outline-none resize-none custom-scroll" />
                                <div className="flex justify-end gap-2 border-t border-slate-100 pt-4 mt-2" data-html2canvas-ignore="true">
                                    <Btn onClick={handleDownloadPdf} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.download} size={14} /> PDF
                                    </Btn>
                                    <Btn onClick={() => { navigator.clipboard.writeText(draft); showToast("ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                    </Btn>
                                    <Btn onClick={handleSave} className="px-3 py-2 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1">
                                        <Icon d={PATHS.check} size={14} /> ì €ì¥
                                    </Btn>
                                </div>
                            </div>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const CalendarModal = ({ isOpen, onClose, currentDate, onSelectDate, records, appConfig, groupsByDate, mode, selectionMode = 'single', onSelectRange }) => {
            const [viewDate, setViewDate] = useState(dayjs(currentDate));
            const [range, setRange] = useState({ start: null, end: null });

            useEffect(() => { 
                if (isOpen) {
                    setViewDate(dayjs(currentDate)); 
                    if (selectionMode === 'range') setRange({ start: null, end: null });
                    document.body.style.overflow = 'hidden';
                } 
                return () => { document.body.style.overflow = ''; };
            }, [isOpen, currentDate, selectionMode]);

            if (!isOpen) return null;
            const startDay = viewDate.startOf('month').day();
            const calendarDays = [...Array(startDay).fill(null), ...Array(viewDate.daysInMonth()).fill(0).map((_, i) => viewDate.date(i + 1))];
            
            const handleDateClick = (dateStr) => {
                const day = dayjs(dateStr).day();
                const isWeekend = day === 0 || day === 6;
                const isHoliday = !!HOLIDAYS[dateStr];
                if (!isWeekend && !isHoliday) {
                    if (selectionMode === 'single') {
                        onSelectDate(dateStr);
                        onClose();
                    } else {
                        if (!range.start || (range.start && range.end)) {
                            setRange({ start: dateStr, end: null });
                        } else {
                            let start = range.start;
                            let end = dateStr;
                            if (dayjs(end).isBefore(dayjs(start))) [start, end] = [end, start];
                            setRange({ start, end });
                            if (onSelectRange) onSelectRange(start, end);
                            onClose();
                        }
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[1500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon d={PATHS.calendar} className="text-indigo-500" /> 
                                {selectionMode === 'range' ? 'ê¸°ê°„ ì„ íƒ (ì‹œì‘ì¼ â†’ ì¢…ë£Œì¼)' : 'ë‚ ì§œ ì„ íƒ'}
                            </h3>
                            <div className="flex items-center gap-2">
                                {selectionMode === 'single' && <Btn onClick={() => { onSelectDate(getToday()); onClose(); }} className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-200">ì˜¤ëŠ˜</Btn>}
                                {selectionMode === 'range' && <Btn onClick={() => { if(onSelectRange) onSelectRange(currentDate, currentDate); onClose(); }} className="text-xs bg-rose-50 text-rose-500 px-3 py-1.5 rounded-full font-bold hover:bg-rose-100">ê¸°ê°„ ì´ˆê¸°í™” (1ì¼)</Btn>}
                                <button onClick={onClose} className="p-1.5 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} size={20} /></button>
                            </div>
                        </div>
                        <div className="flex justify-between items-center mb-4 px-2">
                            <Btn onClick={() => setViewDate(viewDate.subtract(1, 'month'))} className="p-2 hover:bg-slate-100 rounded-full"><Icon d={PATHS.left} size={18} /></Btn>
                            <span className="font-bold text-lg text-slate-700">{viewDate.format('YY.MM')}</span>
                            <Btn onClick={() => setViewDate(viewDate.add(1, 'month'))} className="p-2 hover:bg-slate-100 rounded-full"><Icon d={PATHS.right} size={18} /></Btn>
                        </div>
                        <div className="grid grid-cols-7 mb-2 text-center">
                            {DAYS.map((d, i) => <div key={d} className={`text-xs font-bold py-1 ${i === 0 ? 'text-rose-500' : i === 6 ? 'text-blue-500' : 'text-slate-400'}`}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {calendarDays.map((dateObj, idx) => { 
                                if (!dateObj) return <div key={idx} className="aspect-square"></div>; 
                                const dateStr = dateObj.format('YYYY-MM-DD'); 
                                const isToday = dateStr === getToday(); 
                                const dayOfWeek = dateObj.day(); 
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; 
                                const holidayName = HOLIDAYS[dateStr]; 
                                const isHoliday = !!holidayName; 
                                const isVacation = (appConfig.vacations || []).some(v => dateStr >= v.start && dateStr <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && dateStr >= appConfig.vacationStart && dateStr <= appConfig.vacationEnd);
                                const hasRecord = records[dateStr] && Object.values(records[dateStr]).some(r => r.done || (r.tasks && Object.values(r.tasks).some(t => t))); 
                                const hasGroup = groupsByDate && groupsByDate[dateStr] && groupsByDate[dateStr].length > 0; 
                                const showDot = mode === 'group' ? hasGroup : hasRecord; 
                                
                                let isSelected = false;
                                let isInRange = false;
                                if (selectionMode === 'single') {
                                    isSelected = dateStr === currentDate;
                                } else {
                                    if (range.start === dateStr) isSelected = true;
                                    if (range.end === dateStr) isSelected = true;
                                    if (range.start && range.end && dateStr > range.start && dateStr < range.end) isInRange = true;
                                }

                                let bgClass = 'hover:bg-slate-100 text-slate-700'; 
                                if (isSelected) bgClass = 'bg-indigo-600 text-white shadow-md scale-105'; 
                                else if (isInRange) bgClass = 'bg-indigo-100 text-indigo-700';
                                else if (isVacation || isWeekend || isHoliday) bgClass = 'bg-slate-200 cursor-not-allowed'; 
                                else bgClass = 'hover:bg-indigo-50 cursor-pointer'; 
                                
                                let textClass = ''; 
                                if (isSelected) textClass = 'text-white'; 
                                else if (isInRange) textClass = 'text-indigo-700 font-bold';
                                else if (isVacation) textClass = 'text-slate-400'; 
                                else { 
                                    if (isHoliday || dayOfWeek === 0) textClass = 'text-rose-500'; 
                                    else if (dayOfWeek === 6) textClass = 'text-blue-500'; 
                                    else textClass = 'text-slate-700'; 
                                } 
                                
                                return (
                                    <button key={idx} disabled={isVacation || isWeekend || isHoliday} onClick={() => handleDateClick(dateStr)} className={`aspect-square rounded-xl flex flex-col items-center justify-center relative transition-all ${bgClass} ${isToday && !isSelected && !isInRange ? 'border-2 border-indigo-200' : ''}`}>
                                        <span className={`text-sm font-bold ${textClass}`}>{dateObj.date()}</span>
                                        {showDot && !isWeekend && !isHoliday && !isVacation && !isInRange && !isSelected && (<div className={`w-1.5 h-1.5 rounded-full mt-1 ${isSelected ? 'bg-white/70' : 'bg-blue-500'}`}></div>)}
                                        {isHoliday && !isVacation && <div className="text-[8px] leading-none mt-0.5 truncate max-w-full px-0.5 text-rose-500">{holidayName}</div>}
                                    </button>
                                ) 
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        const DateHeader = ({ date, setDate, onAdd, onReset, onCalendar, appConfig }) => {
            const isVacation = (appConfig.vacations || []).some(v => date >= v.start && date <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && date >= appConfig.vacationStart && date <= appConfig.vacationEnd);
            const isHoliday = !!HOLIDAYS[date];
            const holidayName = HOLIDAYS[date];
            const moveDate = (direction) => { let nextDate = dayjs(date).add(direction, 'day'); let count = 0; while (count < 365) { const dStr = nextDate.format('YYYY-MM-DD'); const day = nextDate.day(); const isWknd = day === 0 || day === 6; const isHol = !!HOLIDAYS[dStr]; if (!isWknd && !isHol) break; nextDate = nextDate.add(direction, 'day'); count++; } setDate(nextDate.format('YYYY-MM-DD')); };
            return (
                <div className="flex flex-col items-center">
                    {(isVacation || isHoliday) && (
                        <div className="flex gap-2 mb-2">
                            {isVacation && <div className="bg-orange-100 text-orange-600 text-xs font-bold px-3 py-1 rounded">ğŸ–ï¸ ë°©í•™ ê¸°ê°„ì…ë‹ˆë‹¤</div>}
                            {isHoliday && <div className="bg-rose-100 text-rose-600 text-xs font-bold px-3 py-1 rounded">ğŸ‰ {holidayName}</div>}
                        </div>
                    )}
                    <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border w-fit mx-auto justify-center">{onAdd && <><Btn onClick={onAdd} className="text-notion-text p-1.5 rounded hover:bg-notion-bg-hover flex items-center justify-center"><Icon d={PATHS.plus} size={18} /></Btn><div className="w-px h-4 bg-notion-border"></div></>}<Btn onClick={() => moveDate(-1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18} /></Btn><div className="flex flex-col items-center cursor-pointer hover:bg-notion-bg-hover rounded px-3 py-1 transition-colors" onClick={onCalendar}><div className="text-base font-bold text-notion-text tracking-tight">{dayjs(date).format('YY.MM.DD')}</div><div className={`text-[10px] font-bold ${isHoliday || dayjs(date).day()===0 ? 'text-notion-red' : dayjs(date).day()===6 ? 'text-notion-blue' : 'text-notion-text-light'}`}>{dayjs(date).format('dddd')}</div></div><Btn onClick={() => moveDate(1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18} /></Btn>{onReset && <><div className="w-px h-4 bg-notion-border"></div><Btn onClick={(e) => { e.stopPropagation(); onReset(); }} className="p-1.5 text-notion-text-light hover:text-notion-red hover:bg-notion-bg-hover rounded"><Icon d={PATHS.trash} size={16} /></Btn></>}</div>
                </div>
            );
        };
        const TagSelector = ({ current, setTag, tags, onAdd, onEdit, onDelete }) => {
            const [showManager, setShowManager] = useState(false);
            const [newTagInput, setNewTagInput] = useState("");
            const [editingTag, setEditingTag] = useState(null);
            const [editTagValue, setEditTagValue] = useState("");
            const handleAdd = () => { if (newTagInput.trim()) { onAdd(newTagInput.trim()); setNewTagInput(""); } };
            const handleFinishEdit = () => { if (editingTag && editTagValue.trim() && editTagValue.trim() !== editingTag) onEdit(editingTag, editTagValue.trim()); setEditingTag(null); setEditTagValue(""); };
            return (
                <div className="mt-2"><div className="flex flex-wrap gap-1 items-center">{tags.map(t => <Btn key={t} onClick={() => setTag(t)} className={`px-2 py-1 text-xs rounded-lg border ${current === t ? 'bg-indigo-500 text-white border-indigo-500 shadow-sm hover:bg-indigo-500' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{t}</Btn>)}<Btn onClick={() => setShowManager(!showManager)} className={`p-1 rounded-full ${showManager ? 'bg-slate-200 text-slate-600' : 'text-slate-300 hover:text-slate-500'}`}><span className="text-sm">âš™ï¸</span></Btn></div>{showManager && (<div className="mt-2 p-3 bg-slate-50 rounded-xl border border-slate-200 animate-fade-in relative z-10"><div className="text-[10px] font-bold text-slate-400 mb-2">íƒœê·¸ ê´€ë¦¬</div><div className="flex flex-wrap gap-2 mb-2">{tags.map(tag => editingTag === tag ? (<div key={tag} className="flex items-center bg-white border border-indigo-300 rounded-lg overflow-hidden shadow-sm"><input value={editTagValue} onChange={e => setEditTagValue(e.target.value)} className="w-16 px-1 py-0.5 text-xs outline-none" autoFocus onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleFinishEdit() }} /><Btn onClick={handleFinishEdit} className="bg-indigo-100 text-indigo-600 px-1.5 py-0.5 hover:bg-indigo-200"><Icon d={PATHS.check} size={10} /></Btn><Btn onClick={() => setEditingTag(null)} className="bg-slate-100 text-slate-500 px-1.5 py-0.5 hover:bg-slate-200"><Icon d={PATHS.x} size={10} /></Btn></div>) : (<div key={tag} className="px-2 py-1 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 flex items-center gap-1 group"><span>{tag}</span><div className="flex gap-0.5 opacity-50 group-hover:opacity-100 transition-opacity"><Btn onClick={() => { setEditingTag(tag); setEditTagValue(tag); }} className="hover:text-indigo-500 p-0.5"><Icon d={PATHS.edit} size={10} /></Btn>{tag !== 'ê¸°íƒ€' && <Btn onClick={(e) => { e.preventDefault(); e.stopPropagation(); onDelete(tag); }} className="text-rose-500 hover:text-rose-700 p-0.5"><Icon d={PATHS.trash} size={10} /></Btn>}</div></div>))}</div><div className="flex gap-1"><input value={newTagInput} onChange={e => setNewTagInput(e.target.value)} className="flex-1 p-1.5 border rounded-lg text-xs outline-none focus:border-indigo-500" placeholder="ìƒˆ íƒœê·¸ ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleAdd() }} /><Btn onClick={handleAdd} className="bg-indigo-500 text-white px-3 rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn></div></div>)}</div>
            );
        };
        const TaskModal = ({ isOpen, onClose, date, dailyTasks, setDailyTasks, weeklyTasks, setWeeklyTasks, saveData, isLocalMode, showToast, tags, setTags, openConfirm }) => {
            const [tasks, setTempTasks] = useState([]); const [newTask, setNewTask] = useState(""); const [selectedTag, setSelectedTag] = useState("êµ­ì–´"); const [wTasks, setWTasks] = useState({}); const [wSelectedDays, setWSelectedDays] = useState([]); const [wNewTask, setWNewTask] = useState(""); const [wSelectedTag, setWSelectedTag] = useState("êµ­ì–´");
            useEffect(() => { if (isOpen) { setTempTasks((dailyTasks[date] || []).map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); const loadedWeekly = {}; Object.keys(weeklyTasks).forEach(k => loadedWeekly[k] = weeklyTasks[k].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); setWTasks(loadedWeekly); } }, [isOpen, dailyTasks, weeklyTasks, date]);
            const updateTags = (newTag) => { if (newTag && !tags.includes(newTag)) { const newTags = [...tags, newTag]; setTags(newTags); if (!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); } };
            const addTask = () => { if (newTask && tasks.length < 5) { setTempTasks([...tasks, { title: newTask, tag: selectedTag }]); updateTags(selectedTag); setNewTask(""); } };
            const removeTask = (idx) => setTempTasks(tasks.filter((_, i) => i !== idx));
            const saveAll = () => { 
                const newDaily = { ...dailyTasks, [date]: tasks }; 
                setDailyTasks(newDaily); 
                setWeeklyTasks(wTasks);
                setTags(tags); // íƒœê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸

                if (!isLocalMode) {
                    // [Fix] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬ ì €ì¥ (ìµœì í™”: ë³€ê²½ëœ ë‚ ì§œë§Œ ì €ì¥)
                    // saveTasksToFirestoreëŠ” App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ propsë¡œ ì „ë‹¬ë°›ê±°ë‚˜ í•´ì•¼ í•¨.
                    // í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” TaskModalì´ App ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, 
                    // saveDataë¥¼ í†µí•´ ìš°íšŒí•´ì•¼ í•˜ëŠ”ë°, saveDataëŠ” ì „ì²´ ì €ì¥ì´ë¯€ë¡œ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ.
                    // App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ í•¨ìˆ˜ì¸ saveTasksToFirestoreë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì • í•„ìš”.
                    // *TaskModalì´ App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ saveTasksToFirestore ì ‘ê·¼ ê°€ëŠ¥*
                    // (ì•„ë˜ App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModal ì •ì˜ ë¶€ë¶„ í™•ì¸ í•„ìš” - í˜„ì¬ App ë‚´ë¶€ì— ì •ì˜ë¨)
                } 
                // *TaskModalì€ App ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ê°€ ì•„ë‹ˆë¼ ë³„ë„ ì»´í¬ë„ŒíŠ¸ì„. propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.*
                // í•˜ì§€ë§Œ í˜„ì¬ ì½”ë“œ êµ¬ì¡°ìƒ TaskModalì€ App ë‚´ë¶€ì—ì„œ ì •ì˜ëœ ê²ƒì´ ì•„ë‹ˆë¼ ë³„ë„ë¡œ ì •ì˜ë˜ì–´ ìˆìŒ.
                // ë”°ë¼ì„œ saveTasksToFirestoreë¥¼ propsë¡œ ë„˜ê²¨ì£¼ê±°ë‚˜, saveDataê°€ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” saveDataë¥¼ í˜¸ì¶œí•˜ë˜, Appì˜ saveDataê°€ ë¶„ê¸° ì²˜ë¦¬í•˜ë„ë¡ í•¨.
                // ë‹¨, TaskModalì—ì„œ ìµœì í™”ë¥¼ ìœ„í•´ saveTasksToFirestoreë¥¼ ì§ì ‘ propìœ¼ë¡œ ë°›ëŠ” ê²ƒì´ ì¢‹ìŒ.
                // ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜, Appì—ì„œ TaskModalì— saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½ ì˜ˆì •.
                
                // [ìˆ˜ì •] TaskModalì€ App ì™¸ë¶€ ì»´í¬ë„ŒíŠ¸ì´ë¯€ë¡œ propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.
                // App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModalì„ ë¶€ë¥¼ ë•Œ saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ë„ë¡ ìˆ˜ì • í•„ìš”.
                // ì—¬ê¸°ì„œëŠ” propsë¡œ ë°›ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©.
                
                // (TaskModal propsì— saveTasksToFirestore ì¶”ê°€ í•„ìš”)
            };
            const toggleDay = (d) => setWSelectedDays(prev => prev.includes(d) ? prev.filter(x => x !== d) : [...prev, d]);
            const addWeeklyTask = () => { if (wNewTask && wSelectedDays.length > 0) { const newW = { ...wTasks }; wSelectedDays.forEach(d => { if ((newW[d] || []).length < 5) newW[d] = [...(newW[d] || []), { title: wNewTask, tag: wSelectedTag }]; }); setWTasks(newW); updateTags(wSelectedTag); setWNewTask(""); setWSelectedDays([]); showToast("ìš”ì¼ë³„ ê³¼ì œ ì¶”ê°€ë¨"); } };
            const removeWeeklyTask = (d, i) => setWTasks({ ...wTasks, [d]: wTasks[d].filter((_, idx) => idx !== i) });
            const handleTagAction = (action, ...args) => { if(action === 'add') updateTags(args[0]); else if(action === 'delete') { openConfirm(`'${args[0]}' íƒœê·¸ ì‚­ì œ?`, () => { const newTags = tags.filter(t => t !== args[0]); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); if(selectedTag === args[0]) setSelectedTag("ê¸°íƒ€"); if(wSelectedTag === args[0]) setWSelectedTag("ê¸°íƒ€"); }); } else if(action === 'edit') { const [oldT, newT] = args; if(newT && newT !== oldT){ const newTags = tags.map(t=>t===oldT?newT:t); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); showToast("íƒœê·¸ ìˆ˜ì •ë¨"); } } };

            // [New] ì €ì¥ ë¡œì§ ì¬ì •ì˜ (propsë¡œ ë°›ì€ í•¨ìˆ˜ ì‚¬ìš©)
            const handleSaveAll = () => {
                const newDaily = { ...dailyTasks, [date]: tasks };
                setDailyTasks(newDaily);
                setWeeklyTasks(wTasks);
                setTags(tags);

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°±ì—… (í•­ìƒ ìˆ˜í–‰)
                localStorage.setItem('cls_daily_tasks', JSON.stringify(newDaily));
                localStorage.setItem('cls_weekly_tasks', JSON.stringify(wTasks));
                localStorage.setItem('cls_tags', JSON.stringify(tags));

                if (!isLocalMode && props.saveTasksToFirestore) {
                    // í´ë¼ìš°ë“œ ëª¨ë“œ: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ìµœì í™” ì €ì¥
                    props.saveTasksToFirestore({ 
                        dailyTasks: { [date]: tasks }, // ë³€ê²½ëœ ë‚ ì§œë§Œ
                        weeklyTasks: wTasks,
                        tags: tags
                    });
                } else if (isLocalMode) {
                    // ë¡œì»¬ ëª¨ë“œ: ì´ë¯¸ ìœ„ì—ì„œ ì €ì¥í•¨ (saveData í˜¸ì¶œ ë¶ˆí•„ìš”)
                } else {
                    // Fallback (êµ¬ë²„ì „ í˜¸í™˜)
                    saveData('cls_daily_tasks', newDaily);
                    saveData('cls_weekly_tasks', wTasks);
                    saveData('cls_tags', tags);
                }
                onClose();
                showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ê³¼ì œ ì„¤ì •" icon={PATHS.edit} footer={<Btn onClick={handleSaveAll} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg hover:bg-slate-900">ëª¨ë“  ì„¤ì • ì €ì¥ ë° ë‹«ê¸°</Btn>}><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-indigo-500 pl-3 flex justify-between"><span>ì˜¤ëŠ˜ì˜ ê³¼ì œ ({dayjs(date).format('YY.MM.DD')})</span><span className="text-xs font-normal text-slate-400">ìµœëŒ€ 5ê°œ</span></h4><div className="bg-slate-50 p-4 rounded-2xl border border-slate-100"><div className="flex flex-col mb-3"><div className="flex gap-2 items-center mb-2 w-full"><input value={newTask} onChange={e => setNewTask(e.target.value)} className="flex-1 min-w-0 p-2.5 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ì˜ˆ: ì¼ê¸° ì“°ê¸°" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addTask() }} /><Btn onClick={addTask} className="shrink-0 bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-indigo-700 whitespace-nowrap">ì¶”ê°€</Btn></div><TagSelector current={selectedTag} setTag={setSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><div className="flex items-center gap-2"><span className="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] rounded font-bold">{t.tag}</span><span className="text-sm font-medium text-slate-700">{t.title}</span></div><Btn onClick={() => removeTask(i)} className="text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div>))}{tasks.length === 0 && <div className="text-center text-slate-400 text-sm py-4">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div></section><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-green-500 pl-3"><span>ìš”ì¼ë³„ ê³ ì • ê³¼ì œ</span></h4><div className="bg-green-50/50 p-4 rounded-2xl border border-green-100"><div className="flex justify-between mb-3 bg-white p-1 rounded-xl border border-green-100">{[1, 2, 3, 4, 5].map(d => <Btn key={d} onClick={() => toggleDay(d)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${wSelectedDays.includes(d) ? 'bg-green-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>{DAYS[d]}</Btn>)}</div><div className="flex flex-col mb-6"><div className="flex gap-2 items-center mb-2 w-full"><input value={wNewTask} onChange={e => setWNewTask(e.target.value)} className="flex-1 min-w-0 p-2.5 border rounded-xl text-sm outline-none focus:border-green-500" placeholder="ê³¼ì œ ë‚´ìš©" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addWeeklyTask() }} /><Btn onClick={addWeeklyTask} className="shrink-0 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 whitespace-nowrap">ì¼ê´„ ì¶”ê°€</Btn></div><TagSelector current={wSelectedTag} setTag={setWSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="grid grid-cols-1 sm:grid-cols-5 gap-3">{[1, 2, 3, 4, 5].map(d => (<div key={d} className="bg-white p-3 rounded-xl border border-slate-200"><div className="text-center font-bold text-slate-500 text-xs mb-2 pb-1 border-b">{DAYS[d]}ìš”ì¼</div><div className="space-y-1 min-h-[60px]">{(wTasks[d] || []).map((t, i) => (<div key={i} className="flex justify-between items-start text-xs bg-slate-50 p-1.5 rounded group"><div className="flex flex-col"><span className="text-[9px] text-slate-400">{t.tag}</span><span className="break-all leading-tight">{t.title}</span></div><Btn onClick={() => removeWeeklyTask(d, i)} className="text-rose-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 ml-1">Ã—</Btn></div>))}</div></div>))}</div></div></section></BaseModal>
            );
        };
        
        const StickerAutomationView = ({ students, records, dailyTasks, saveData, isLocalMode, showToast, openConfirm, setStudents }) => {
            const [stickerDate, setStickerDate] = useState(getToday());
            const [stickerRate, setStickerRate] = useState(100);
            const [stickerAdd, setStickerAdd] = useState(1);
            const [previewCount, setPreviewCount] = useState(-1);

            const calculateQualified = () => {
                const tasks = dailyTasks[stickerDate] || [];
                if (tasks.length === 0) return [];
                
                return students.filter(s => {
                    const rec = records[stickerDate]?.[s.id];
                    let done = 0;
                    if (rec) {
                        tasks.forEach((_, idx) => {
                            if (rec.tasks && rec.tasks[idx]) done++;
                            else if (!rec.tasks && rec.done) done++;
                        });
                    }
                    const rate = (done / tasks.length) * 100;
                    return rate >= stickerRate;
                });
            };

            const handlePreviewStickers = () => {
                const qualified = calculateQualified();
                setPreviewCount(qualified.length);
            };

            const handleApplyStickers = () => {
                const qualified = calculateQualified();
                if (qualified.length === 0) {
                    showToast("ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                
                openConfirm(`${stickerDate} ê³¼ì œ ìˆ˜í–‰ë¥  ${stickerRate}% ì´ìƒì¸\n${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ ${stickerAdd}ê°œë¥¼ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                    const updatedStudents = students.map(s => {
                        if (qualified.find(q => q.id === s.id)) {
                            return { ...s, stickers: (s.stickers || 0) + stickerAdd };
                        }
                        return s;
                    });
                    setStudents(updatedStudents);
                    if(!isLocalMode) saveData('cls_students', updatedStudents);
                    showToast(`${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`);
                    setPreviewCount(-1);
                });
            };

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full flex flex-col"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸŒŸ</div><h3 className="font-bold text-slate-800 text-lg flex items-center gap-2 mb-6 relative z-10"><span className="text-xl">ğŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤ ìë™ ë¶€ì—¬</h3><div className="space-y-6 relative z-10 flex-1 flex flex-col justify-center"><div className="space-y-2"><label className="text-xs font-bold text-slate-500">ë‚ ì§œ ë° ê¸°ì¤€</label><div className="flex gap-2 items-center"><input type="date" value={stickerDate} onChange={e => { setStickerDate(e.target.value); setPreviewCount(-1); }} className="flex-1 p-2.5 border rounded-xl text-sm bg-slate-50 outline-none focus:border-indigo-500" /><select value={stickerRate} onChange={e => { setStickerRate(parseInt(e.target.value)); setPreviewCount(-1); }} className="p-2.5 border rounded-xl text-sm bg-slate-50 font-bold outline-none focus:border-indigo-500"><option value="100">100%</option><option value="80">80%â†‘</option><option value="50">50%â†‘</option></select></div></div><div className="space-y-2"><div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">ì§€ê¸‰ ê°œìˆ˜</label>{previewCount >= 0 && <span className="text-indigo-600 text-xs font-bold animate-fade-in">{previewCount}ëª… ëŒ€ìƒ</span>}</div><div className="flex items-center bg-slate-50 border rounded-xl overflow-hidden"><button onClick={() => setStickerAdd(Math.max(1, stickerAdd - 1))} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">-</button><span className="flex-1 text-center font-bold text-slate-700">{stickerAdd}ê°œ</span><button onClick={() => setStickerAdd(stickerAdd + 1)} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">+</button></div></div><div className="grid grid-cols-2 gap-3 pt-2"><Btn onClick={handlePreviewStickers} className="py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 text-sm">ëŒ€ìƒ í™•ì¸</Btn><Btn onClick={handleApplyStickers} className="py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 text-sm shadow-md">ì§€ê¸‰í•˜ê¸°</Btn></div></div></div>
            );
        };

        const MissingView = ({ students, records, dailyTasks }) => {
            const [filter, setFilter] = useState('today');
            
            const datesToCheck = useMemo(() => {
                const today = getToday();
                if (filter === 'today') return [today];
                return [
                    today,
                    dayjs().subtract(1, 'day').format('YYYY-MM-DD'),
                    dayjs().subtract(2, 'day').format('YYYY-MM-DD')
                ];
            }, [filter]);

            const missingData = useMemo(() => {
                const data = {};
                datesToCheck.forEach(date => {
                    const tasks = dailyTasks[date] || [];
                    if (tasks.length === 0) return;
                    
                    data[date] = tasks.map((task, idx) => {
                        const missingStudents = students.filter(s => {
                            const rec = records[date]?.[s.id];
                            if (rec && rec.tasks && rec.tasks[idx]) return false;
                            if (rec && !rec.tasks && rec.done) return false;
                            return true;
                        });
                        return { 
                            task: typeof task === 'object' ? task : { title: task, tag: 'ê¸°íƒ€' }, 
                            students: missingStudents 
                        };
                    }).filter(item => item.students.length > 0);
                });
                return data;
            }, [datesToCheck, dailyTasks, students, records]);

            const hasMissingData = Object.keys(missingData).some(date => missingData[date].length > 0);

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full">
                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">âš ï¸</div>
                    <div className="flex flex-wrap items-center gap-3 mb-6 relative z-10">
                        <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2"><span className="text-xl">âš ï¸</span> ê³¼ì œ ë¯¸ì œì¶œ ëª…ë‹¨</h3>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setFilter('today')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'today' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì˜¤ëŠ˜</button>
                            <button onClick={() => setFilter('recent3')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'recent3' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ìµœê·¼ 3ì¼</button>
                        </div>
                    </div>
                    <div className="relative z-10 space-y-4">
                        {!hasMissingData ? (
                            <div className="text-center py-6 text-slate-400 flex flex-col items-center bg-slate-50 rounded-xl border border-slate-200 border-dashed">
                                <Icon d={PATHS.check} size={32} className="mb-2 text-indigo-200"/>
                                <p className="text-sm">ë¯¸ì œì¶œ ë‚´ì—­ì´ ì—†ê±°ë‚˜ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ‰</p>
                            </div>
                        ) : (
                            Object.entries(missingData).map(([date, items]) => {
                                if (items.length === 0) return null;
                                return (
                                    <div key={date} className="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                                        <div className="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-white/50">
                                            <h3 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“… {dayjs(date).format('MMì›” DDì¼ (ddd)')}</h3>
                                            <span className="text-xs font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-lg border border-rose-100">ë¯¸ì œì¶œ {items.reduce((acc, curr) => acc + curr.students.length, 0)}ê±´</span>
                                        </div>
                                        <div className="divide-y divide-slate-200/50">
                                            {items.map((item, idx) => (
                                                <div key={idx} className="p-4">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-xs rounded-md font-bold">{item.task.tag}</span>
                                                        <span className="font-bold text-slate-700">{item.task.title}</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 mt-2">
                                                        {item.students.map(s => (
                                                            <span key={s.id} className="inline-flex items-center px-2.5 py-1 rounded-lg bg-white text-rose-600 text-xs font-bold border border-rose-100 shadow-sm">{s.order}. {s.name}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const ApiKeyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="Gemini API í‚¤ ë°œê¸‰ ë°©ë²•" icon={PATHS.key}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Googleì˜ <strong>Gemini API í‚¤</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ë¬´ë£Œ)</p>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-2">
                            <h4 className="font-bold text-slate-800">ğŸ”‘ ë°œê¸‰ ìˆœì„œ</h4>
                            <ol className="list-decimal pl-5 space-y-1">
                                <li>ì•„ë˜ <strong>'Google AI Studio ë°”ë¡œê°€ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                <li>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</li>
                                <li>ì¢Œì¸¡ ìƒë‹¨ì˜ <strong>'Get API key'</strong> ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                                <li><strong>'Create API key'</strong>ë¥¼ í´ë¦­í•˜ì—¬ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
                                <li>ìƒì„±ëœ í‚¤(sk-...)ë¥¼ ë³µì‚¬í•˜ì—¬ ì´ ì•±ì˜ ì„¤ì • ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</li>
                            </ol>
                        </div>
                        <div className="flex justify-center">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2">
                                <Icon d={PATHS.link} size={16} /> Google AI Studio ë°”ë¡œê°€ê¸°
                            </a>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const NotionSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode, isPortfolioMode, setIsPortfolioMode, studentMap, setStudentMap, portfolioDbId, setPortfolioDbId }) => {
            const [apiKey, setApiKey] = useState("");
            const [dbId, setDbId] = useState("");
            const [saveLocally, setSaveLocally] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [isTesting, setIsTesting] = useState(false);
            const [manualInput, setManualInput] = useState("");
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    const savedKey = localStorage.getItem('cls_notion_key');
                    const savedDbId = localStorage.getItem('cls_notion_db_id');
                    
                    // [Fix] ì €ì¥ëœ í‚¤/ID ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì œê±° (JSON.stringifyë¡œ ì¸í•´ ìƒê¸°ëŠ” ë¬¸ì œ í•´ê²°)
                    if (savedKey) {
                        setApiKey(savedKey.replace(/["']/g, '').trim());
                    }
                    if (savedDbId) {
                        setDbId(savedDbId.replace(/["']/g, '').trim());
                    }
                    
                    if (portfolioDbId && (portfolioDbId.includes('"') || portfolioDbId.includes("'"))) {
                        setPortfolioDbId(portfolioDbId.replace(/["']/g, '').trim());
                    }
                    if (savedKey || savedDbId) setSaveLocally(true);
                    
                    const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                    if (setIsPortfolioMode && savedMode !== isPortfolioMode) setIsPortfolioMode(savedMode);
                }
            }, [isOpen]);

            const handleTestConnection = async () => {
                const targetId = isPortfolioMode ? portfolioDbId : dbId;
                if (!apiKey || !targetId) return showToast("API Keyì™€ Database IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsTesting(true);
                try {
                    const response = await fetch('/api/save-notion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            personalKey: apiKey.replace(/["']/g, '').trim(), 
                            personalDbId: targetId.replace(/["']/g, '').trim(),
                            testMode: true,
                            mode: isPortfolioMode ? 'relation' : 'normal'
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || "ì—°ë™ ì‹¤íŒ¨");
                    const msg = "âœ… ë…¸ì…˜ ì—°ë™ì— ì™„ë²½í•˜ê²Œ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!";
                    showToast(msg);
                    setSaveLocally(true);
                } catch (e) {
                    showToast("âŒ " + e.message);
                } finally {
                    setIsTesting(false);
                }
            };

            const handleSave = () => {
                const cleanKey = apiKey.replace(/["']/g, '').trim();
                const cleanDbId = dbId.replace(/["']/g, '').trim();
                const cleanPortfolioId = portfolioDbId ? portfolioDbId.replace(/["']/g, '').trim() : "";
                
                // [Fix] í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ëª…ì‹œì  ì €ì¥
                localStorage.setItem('cls_portfolio_mode', isPortfolioMode);

                if (saveLocally) {
                    localStorage.setItem('cls_notion_key', cleanKey);
                    localStorage.setItem('cls_notion_db_id', cleanDbId);
                    if (cleanPortfolioId) localStorage.setItem('cls_notion_portfolio_db_id', cleanPortfolioId);

                    if (!isLocalMode && saveData) saveData({ 
                        cls_notion_key: cleanKey, 
                        cls_notion_db_id: cleanDbId,
                        cls_notion_portfolio_db_id: cleanPortfolioId,
                        cls_portfolio_mode: isPortfolioMode
                    });
                } else {
                    localStorage.removeItem('cls_notion_key');
                    localStorage.removeItem('cls_notion_db_id');
                    localStorage.removeItem('cls_notion_portfolio_db_id');
                    if (!isLocalMode && saveData) saveData({ cls_notion_key: "", cls_notion_db_id: "", cls_notion_portfolio_db_id: "" });
                }
                showToast("ë…¸ì…˜ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            const handlePasteKey = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setApiKey(text);
                        showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const setTargetDbId = (val) => {
                const cleanVal = val.replace(/["']/g, '').trim();
                if (isPortfolioMode) {
                    setPortfolioDbId(cleanVal);
                    localStorage.setItem('cls_notion_portfolio_db_id', cleanVal);
                } else {
                    setDbId(cleanVal);
                    localStorage.setItem('cls_notion_db_id', cleanVal);
                }
            };

            const extractAndSetDbId = (text) => {
                if (text.includes("notion.so")) {
                    const match = text.match(/([a-f0-9]{32})/);
                    if (match) {
                        setTargetDbId(match[1]);
                        return true;
                    }
                }
                setTargetDbId(text);
                return false;
            };

            const handlePasteDbId = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        if (extractAndSetDbId(text)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ë¶™ì—¬ë„£ì—ˆìŠµë‹ˆë‹¤.");
                        else showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const handlePortfolioToggle = (e) => {
                const checked = e.target.checked;
                if (setIsPortfolioMode) setIsPortfolioMode(checked);
                localStorage.setItem('cls_portfolio_mode', checked);
                if (showToast) showToast(checked ? "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œê°€ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê¸°ë¡ëª¨ë“œê°€ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleFileUploadPortfolio = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const lines = text.split(/[\r\n]+/);
                    const newMap = { ...studentMap };
                    let count = 0;
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const parts = line.split(/[,:\t]+/).map(s => s.trim());
                        if (parts.length >= 2) {
                            const name = parts[0];
                            const id = parts[parts.length - 1];
                            if (name && id) { newMap[name] = id; count++; }
                        }
                    });
                    if (setStudentMap) setStudentMap(newMap);
                    localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                    showToast(`${count}ëª…ì˜ ë°ì´í„°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleManualAdd = () => {
                if (!manualInput.trim()) return;
                const lines = manualInput.split(/[\r\n]+/);
                const newMap = { ...studentMap };
                let count = 0;
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/[:=,]+/).map(s => s.trim());
                    if (parts.length >= 2) {
                        const name = parts[0];
                        const id = parts[parts.length - 1];
                        if (name && id) { newMap[name] = id; count++; }
                    }
                });
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                setManualInput("");
                showToast(`${count}ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            const handleDeleteItem = (name) => {
                const newMap = { ...studentMap };
                delete newMap[name];
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ““ Notion ì—°ë™ ì„¤ì •" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <p className="font-bold mb-1">ğŸ”‘ ê°œì¸ ë…¸ì…˜ ì—°ë™</p>
                            <p>ì…ë ¥í•œ ì •ë³´ëŠ” ë¸Œë¼ìš°ì €(Local Storage)ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ì— ë³„ë„ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>

                        {showManual && (
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-slate-700 space-y-4 animate-fade-in">
                                <div>
                                    <h4 className="font-bold text-indigo-700 mb-2">ğŸš€ ë…¸ì…˜ ì—°ë™ 3ë‹¨ê³„ (ê³µí†µ)</h4>
                                    <ol className="list-decimal pl-4 space-y-1">
                                        <li><strong>í†µí•© ë§Œë“¤ê¸°:</strong> <a href="https://www.notion.so/my-integrations" target="_blank" className="text-blue-600 underline font-bold">ë…¸ì…˜ ë‚´ í†µí•©</a>ì—ì„œ 'ìƒˆ í†µí•©' ìƒì„± í›„ <strong>API Key</strong> ë³µì‚¬.</li>
                                        <li><strong>ì—°ê²°í•˜ê¸°:</strong> ì‚¬ìš©í•  ë…¸ì…˜ DB í˜ì´ì§€ ìš°ì¸¡ ìƒë‹¨ <strong>[...] &gt; [ì—°ê²°]</strong>ì—ì„œ í†µí•© ì—°ê²°.</li>
                                        <li><strong>ID ì°¾ê¸°:</strong> DB í˜ì´ì§€ URLì—ì„œ <strong>32ìë¦¬ ID</strong> ë³µì‚¬.<br/><span className="text-[10px] text-slate-500 bg-white px-1 border rounded mt-1 inline-block">https://notion.so/.../<b>30a285...</b>?v=...</span></li>
                                    </ol>
                                </div>
                                
                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-2">ğŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ì†ì„± ì„¤ì • (í•„ìˆ˜)</h4>
                                    <p className="mb-2 text-slate-500">ë…¸ì…˜ DBì˜ ì†ì„± ì´ë¦„ê³¼ ìœ í˜•ì„ ì•„ë˜ì™€ ë˜‘ê°™ì´ ë§ì¶°ì£¼ì„¸ìš”.</p>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <h5 className="font-bold text-slate-800 mb-2 border-b pb-1">âšª ê¸°ë³¸ ëª¨ë“œ (ê¸°ë¡ìš©)</h5>
                                            <ul className="list-disc pl-4 space-y-1 text-slate-600">
                                                <li><strong>ì´ë¦„</strong> (ì œëª©)</li>
                                                <li><strong>ë‚ ì§œ</strong> (ë‚ ì§œ)</li>
                                                <li><strong>êµ¬ë¶„</strong> (ì„ íƒ) : ì¹­ì°¬, ê´€ì°° ë“±</li>
                                                <li><strong>ë‚´ìš©</strong> (í…ìŠ¤íŠ¸)</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white p-3 rounded-lg border border-indigo-200 shadow-sm ring-1 ring-indigo-50">
                                            <h5 className="font-bold text-indigo-600 mb-2 border-b border-indigo-100 pb-1">ğŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ</h5>
                                            <ul className="list-disc pl-4 space-y-1 text-slate-600">
                                                <li><strong>ì´ë¦„</strong> (ì œëª©) : ìë™ ìƒì„±ë¨</li>
                                                <li><strong>ìƒì„±ì¼ì‹œ</strong> (ë‚ ì§œ) : ì‹œê°„ í¬í•¨</li>
                                                <li><strong>êµ¬ë¶„</strong> (ì„ íƒ)</li>
                                                <li><strong>ë‚´ìš©</strong> (í…ìŠ¤íŠ¸)</li>
                                                <li><strong>í•™ìƒ</strong> (ê´€ê³„í˜•) : í•™ìƒ DBì™€ ì—°ê²°</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-1">ğŸŒ ê°œë°œì ì°¸ê³  (Vercel)</h4>
                                    <p className="text-slate-500">ì´ ì•±ì€ <code>api/save-notion.js</code>ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ Vercel ë°°í¬ í™˜ê²½ì—ì„œë§Œ ë…¸ì…˜ ì €ì¥ì´ ì‘ë™í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        )}

                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Notion API Key (Secret)</label>
                            <div className="flex gap-2">
                                <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="flex-1 p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="secret_..." />
                                <Btn onClick={handlePasteKey} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">{isPortfolioMode ? "ğŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ìš© DB ID (í•™ìƒê³¼ ì—°ê²°)" : "âšª ì¼ë°˜ ê¸°ë¡ìš© DB ID (ë‹¨ìˆœ ê¸°ë¡)"}</label>
                            <div className="flex gap-2">
                                <input type="text" value={isPortfolioMode ? portfolioDbId : dbId} onChange={e => { const val = e.target.value.replace(/"/g, ''); if(extractAndSetDbId(val)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤."); }} className="flex-1 p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="32ìë¦¬ ID (URL ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)" />
                                <Btn onClick={handlePasteDbId} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                            </div>
                        </div>
                        
                        <div className="pt-4 border-t border-slate-200">
                            <label className="flex items-center justify-between cursor-pointer select-none">
                                <span className="text-sm font-bold text-slate-700">{isPortfolioMode ? "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ" : "ê¸°ë¡ ëª¨ë“œ (ê¸°ë³¸)"}</span>
                                <div className="relative">
                                    <input type="checkbox" className="sr-only" checked={isPortfolioMode} onChange={handlePortfolioToggle} />
                                    <div className={`w-10 h-6 rounded-full shadow-inner transition-colors ${isPortfolioMode ? 'bg-indigo-500' : 'bg-slate-300'}`}></div>
                                    <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${isPortfolioMode ? 'translate-x-4' : ''}`}></div>
                                </div>
                            </label>
                            <p className="text-xs text-slate-500 mt-1">í•™ìƒ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ì—°ê²°ëœ ë…¸ì…˜ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
                        </div>

                        {isPortfolioMode && (
                            <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-4 animate-fade-in">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xs font-bold text-slate-600">ëª…ë‹¨ ê´€ë¦¬ (ì´ë¦„:ë…¸ì…˜ID)</h4>
                                    <Btn onClick={() => fileInputRef.current.click()} className="px-2 py-1 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50">ğŸ“‚ ì—‘ì…€(CSV) ì—…ë¡œë“œ</Btn>
                                    <input type="file" ref={fileInputRef} onChange={handleFileUploadPortfolio} className="hidden" accept=".csv,.txt" />
                                </div>
                                <div className="max-h-32 overflow-y-auto custom-scroll bg-white border border-slate-200 rounded-lg p-2 space-y-1">
                                    {studentMap && Object.keys(studentMap).length > 0 ? (
                                        Object.entries(studentMap).sort((a, b) => a[0].localeCompare(b[0])).map(([name, id]) => (
                                            <div key={name} className="flex justify-between items-center text-xs p-1 hover:bg-slate-50 rounded">
                                                <span className="font-bold text-slate-700">{name}</span>
                                                <div className="flex items-center gap-2"><span className="text-slate-400 font-mono text-[10px] truncate max-w-[100px]">{id}</span><button onClick={() => handleDeleteItem(name)} className="text-rose-400 hover:text-rose-600">Ã—</button></div>
                                            </div>
                                        ))
                                    ) : (<div className="text-center text-slate-400 text-xs py-4">ë“±ë¡ëœ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                </div>
                                <div className="flex gap-2">
                                    <textarea value={manualInput} onChange={e => setManualInput(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-indigo-500 resize-none" placeholder="ì´ë¦„:ID (ì—¬ëŸ¬ ëª…ì€ ì¤„ë°”ê¿ˆ)" rows="2" />
                                    <Btn onClick={handleManualAdd} className="px-3 bg-indigo-500 text-white rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn>
                                </div>
                            </div>
                        )}

                        <label className="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" checked={saveLocally} onChange={e => setSaveLocally(e.target.checked)} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                            <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— ì •ë³´ ì €ì¥í•˜ê¸°</span>
                        </label>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTestConnection} disabled={isTesting} className="flex-1 py-3 bg-white border border-indigo-200 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition-colors">
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>í™•ì¸ ì¤‘...</> : 'ğŸ”Œ ì—°ë™ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md transition-colors">ì„¤ì • ì €ì¥í•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const GoogleSheetSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode }) => {
            const [url, setUrl] = useState("");
            const [isTesting, setIsTesting] = useState(false);
            const [showManual, setShowManual] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    let savedUrl = localStorage.getItem('cls_google_sheet_url') || "";
                    // ğŸŒŸ ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì°Œêº¼ê¸° 1ì°¨ ì œê±°
                    savedUrl = savedUrl.trim().replace(/^"|'|"$|'$/g, '');
                    setUrl(savedUrl);
                }
            }, [isOpen]);

            const handleTest = async () => {
                // ğŸŒŸ í…ŒìŠ¤íŠ¸í•  ë•Œë„ ì•ˆì „í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì „ì†¡
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                if (!cleanUrl) return showToast("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsTesting(true);
                try {
                    await fetch(cleanUrl, {
                        method: "POST",
                        mode: 'no-cors',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ date: dayjs().format('YYYY-MM-DD HH:mm:ss'), name: "í…ŒìŠ¤íŠ¸", category: "ì—°ë™ í…ŒìŠ¤íŠ¸", content: "Google ì‹œíŠ¸ ì—°ë™ ì„±ê³µ!" })
                    });
                    showToast("âœ… ì „ì†¡ ì„±ê³µ! ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                } catch (e) {
                    showToast("âŒ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsTesting(false);
                }
            };

            const handleSave = () => {
                // ğŸŒŸ ì˜êµ¬ ì €ì¥í•  ë•Œ ì™„ë²½í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì €ì¥
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                localStorage.setItem('cls_google_sheet_url', cleanUrl);
                if (!isLocalMode && saveData) saveData('cls_google_sheet_url', cleanUrl);
                showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-green-50 p-4 rounded-xl border border-green-200 text-sm text-green-800">
                            <p className="font-bold mb-1">ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™</p>
                            <p>ê¸°ë¡ëœ ë°ì´í„°ë¥¼ êµ¬ê¸€ ì‹œíŠ¸ì— ìë™ìœ¼ë¡œ í•œ ì¤„ì”© ì¶”ê°€í•©ë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>
                        {showManual && (
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-600 space-y-2 animate-fade-in">
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± &gt; <strong>í™•ì¥ í”„ë¡œê·¸ë¨ &gt; Apps Script</strong></li>
                                    <li>ì•„ë˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸° &gt; ì €ì¥
                                        <div className="bg-white p-2 border rounded mt-1 font-mono text-[10px] select-all cursor-pointer" onClick={(e) => { navigator.clipboard.writeText(e.target.innerText); showToast("ì½”ë“œ ë³µì‚¬ë¨"); }}>
{`function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  sheet.appendRow([data.date, data.name, data.category, data.content]);
  return ContentService.createTextOutput("Success");
}`}
                                        </div>
                                    </li>
                                    <li><strong>ë°°í¬ &gt; ìƒˆ ë°°í¬</strong> (ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´ ë°˜ë“œì‹œ 'ìƒˆ ë²„ì „'ìœ¼ë¡œ ë°°í¬í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤!)</li>
                                    <li>ìœ í˜•: <strong>ì›¹ ì•±</strong> &gt; ì•¡ì„¸ìŠ¤ ê¶Œí•œ: <strong>ëª¨ë“  ì‚¬ìš©ì</strong> (í•„ìˆ˜)</li>
                                    <li>ìƒì„±ëœ <strong>ì›¹ ì•± URL</strong>ì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.</li>
                                </ol>
                            </div>
                        )}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Web App URL</label>
                            <input type="text" value={url} onChange={e => setUrl(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-green-500 font-mono" placeholder="https://script.google.com/macros/s/..." />
                        </div>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTest} disabled={isTesting} className="flex-1 py-3 bg-white border border-green-200 text-green-600 rounded-xl font-bold hover:bg-green-50 transition-colors">
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>ì „ì†¡ ì¤‘...</> : 'ğŸ”Œ ì „ì†¡ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md transition-colors">ì„¤ì • ì €ì¥í•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const ApiKeySetupModal = ({ isOpen, onClose, apiKey, setApiKey, saveData, isLocalMode, showToast, validateApiKey }) => {
            const [isChecking, setIsChecking] = useState(false);
            const [isSaved, setIsSaved] = useState(!!localStorage.getItem('cls_ai_key'));
            const [showHelp, setShowHelp] = useState(false);
            const [usage, setUsage] = useState(0);

            useEffect(() => {
                if (isOpen) {
                    setUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setIsSaved(!!localStorage.getItem('cls_ai_key'));
                }
            }, [isOpen]);

            const handleCheck = async () => {
                setIsChecking(true);
                await validateApiKey();
                setIsChecking(false);
            };

            const handleSaveToggle = (e) => {
                const checked = e.target.checked;
                setIsSaved(checked);
                if (checked) {
                    if(!isLocalMode) saveData('cls_ai_key', apiKey);
                    else localStorage.setItem('cls_ai_key', apiKey);
                } else {
                    if(!isLocalMode) saveData('cls_ai_key', "");
                    else localStorage.removeItem('cls_ai_key');
                }
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ¤– AI ì„¤ì •" icon={null}>
                    <ApiKeyHelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <p className="font-bold mb-1">ğŸ”‘ Gemini API Key ì„¤ì •</p>
                            <p>Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë¬´ë£Œ)</p>
                        </div>
                        <div className="space-y-2">
                            <div className="flex justify-between items-center">
                                <label className="text-xs font-bold text-slate-500">API Key</label>
                                <button onClick={() => setShowHelp(true)} className="text-[10px] text-indigo-500 hover:underline flex items-center gap-0.5">í‚¤ ë°œê¸‰ ë°©ë²• <Icon d={PATHS.help} size={10} /></button>
                            </div>
                            <div className="flex gap-2">
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="flex-1 p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="sk-..." />
                                <Btn onClick={handleCheck} className="bg-indigo-600 text-white px-4 rounded-xl text-xs font-bold hover:bg-indigo-700 whitespace-nowrap">{isChecking ? 'í™•ì¸ ì¤‘...' : 'í™•ì¸'}</Btn>
                            </div>
                        </div>
                        <div className="flex justify-between items-center pt-2">
                            <label className="flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" checked={isSaved} onChange={handleSaveToggle} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                                <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— í‚¤ ì €ì¥í•˜ê¸°</span>
                            </label>
                            <div className="text-xs text-slate-400">ì‚¬ìš©ëŸ‰: {usage}íšŒ</div>
                        </div>
                        <Btn onClick={onClose} className="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 mt-4">ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ManualModal = ({ isOpen, onClose, content, onDownload }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“˜ ì‚¬ìš© ì„¤ëª…ì„œ" icon={PATHS.book} maxWidth="max-w-3xl">
                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 h-[60vh] overflow-y-auto custom-scroll whitespace-pre-wrap text-sm leading-relaxed text-slate-700 font-mono select-text shadow-inner">
                        {content}
                    </div>
                    <div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
                        <Btn onClick={onDownload} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-md transition-transform active:scale-95">
                            <Icon d={PATHS.download} size={18} /> í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                        </Btn>
                        <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ClassToolsModal = ({ isOpen, onClose, students }) => {
            const [activeTab, setActiveTab] = useState('picker');
            const [pickedStudent, setPickedStudent] = useState(null);
            const [isPicking, setIsPicking] = useState(false);
            const [timerTime, setTimerTime] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => {
                if (isTimerRunning && timerTime > 0) {
                    timerRef.current = setInterval(() => setTimerTime(t => t - 1), 1000);
                } else {
                    clearInterval(timerRef.current);
                    if (timerTime === 0 && isTimerRunning) {
                        setIsTimerRunning(false);
                        confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#ef4444', '#f87171'] });
                    }
                }
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning, timerTime]);

            const handlePick = () => {
                if (students.length === 0) return;
                setIsPicking(true);
                let count = 0;
                const interval = setInterval(() => {
                    setPickedStudent(students[Math.floor(Math.random() * students.length)]);
                    count++;
                    if (count > 20) {
                        clearInterval(interval);
                        setIsPicking(false);
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                }, 100);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (s % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ§° í•™ê¸‰ ë„êµ¬ ìƒì" icon={PATHS.settings} maxWidth="max-w-md">
                    <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                        <button onClick={() => setActiveTab('picker')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'picker' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ğŸ² ë°œí‘œì ë½‘ê¸°</button>
                        <button onClick={() => setActiveTab('timer')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'timer' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>â±ï¸ íƒ€ì´ë¨¸</button>
                    </div>

                    {activeTab === 'picker' && (
                        <div className="flex flex-col items-center py-4 space-y-6">
                            <div className="text-4xl font-bold text-slate-800 h-20 flex items-center justify-center">{pickedStudent ? pickedStudent.name : <span className="text-slate-300 text-6xl">?</span>}</div>
                            <Btn onClick={handlePick} disabled={isPicking} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                {isPicking ? 'ë‘êµ¬ë‘êµ¬...' : 'ë°œí‘œì ë½‘ê¸°!'}
                            </Btn>
                        </div>
                    )}

                    {activeTab === 'timer' && (
                        <div className="flex flex-col items-center py-2 space-y-6">
                            <div className={`text-7xl font-mono font-bold tabular-nums tracking-wider ${timerTime <= 10 && timerTime > 0 && isTimerRunning ? 'text-rose-500 animate-pulse' : 'text-slate-800'}`}>{formatTime(timerTime)}</div>
                            <div className="grid grid-cols-4 gap-2 w-full">
                                {[10, 60, 180, 300].map(sec => (
                                    <Btn key={sec} onClick={() => setTimerTime(t => t + sec)} className="py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200">+{sec < 60 ? sec + 'ì´ˆ' : sec / 60 + 'ë¶„'}</Btn>
                                ))}
                            </div>
                            <div className="flex gap-3 w-full">
                                <Btn onClick={() => { setIsTimerRunning(false); setTimerTime(0); }} className="flex-1 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ì´ˆê¸°í™”</Btn>
                                <Btn onClick={() => setIsTimerRunning(!isTimerRunning)} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md ${isTimerRunning ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'}`}>{isTimerRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}</Btn>
                            </div>
                        </div>
                    )}
                </BaseModal>
            );
        };

        const InstallGuideModal = ({ isOpen, onClose, onInstall, isIOS }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“² ì•± ì„¤ì¹˜ ì•ˆë‚´" icon={PATHS.download} maxWidth="max-w-md">
                    <div className="space-y-6 text-center">
                        <div className="w-20 h-20 bg-indigo-100 rounded-3xl mx-auto flex items-center justify-center shadow-inner">
                            <span className="text-4xl">ğŸ“±</span>
                        </div>
                        <div className="space-y-2">
                            <h3 className="text-xl font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€í•´ë³´ì„¸ìš”!</h3>
                            <p className="text-sm text-slate-500 leading-relaxed">
                                ì•±ì„ ì„¤ì¹˜í•˜ë©´ ë” í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-left">
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">âš¡ï¸ ë¹ ë¥¸ ì‹¤í–‰</div><div className="text-xs text-slate-500">í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì ‘ì†í•˜ì„¸ìš”.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ–¥ï¸ ë„“ì€ í™”ë©´</div><div className="text-xs text-slate-500">ì£¼ì†Œì°½ ì—†ì´ ë„“ê²Œ ë´…ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ’¾ ì˜¤í”„ë¼ì¸</div><div className="text-xs text-slate-500">ì¸í„°ë„· ì—†ì´ë„ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ”„ ìë™ ì—…ë°ì´íŠ¸</div><div className="text-xs text-slate-500">í•­ìƒ ìµœì‹  ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.</div></div>
                        </div>
                        
                        {isIOS ? (
                            <div className="bg-slate-100 p-4 rounded-xl text-left text-sm space-y-2 animate-fade-in">
                                <p className="font-bold text-slate-700 flex items-center gap-2">ğŸ ì•„ì´í°/ì•„ì´íŒ¨ë“œ ì„¤ì¹˜ ë°©ë²•</p>
                                <ol className="list-decimal pl-5 space-y-1 text-slate-600 text-xs">
                                    <li>ì‚¬íŒŒë¦¬(Safari) í•˜ë‹¨ì˜ <span className="font-bold text-blue-500">ê³µìœ (Share)</span> ë²„íŠ¼ í„°ì¹˜</li>
                                    <li>ë©”ë‰´ì—ì„œ <span className="font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€</span> ì„ íƒ</li>
                                    <li>ìš°ì¸¡ ìƒë‹¨ì˜ <span className="font-bold text-blue-500">ì¶”ê°€</span> ë²„íŠ¼ í„°ì¹˜</li>
                                </ol>
                            </div>
                        ) : (
                            <Btn onClick={onInstall} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <Icon d={PATHS.download} /> ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°
                            </Btn>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const DataCleanupModal = ({ isOpen, onClose, groupsByDate, records, setGroupsByDate, setRecords, saveData, isLocalMode, showToast, onBackup }) => {
            const [targetDate, setTargetDate] = useState(dayjs().subtract(1, 'year').format('YYYY-MM-DD'));
            
            const cleanupStats = useMemo(() => {
                let groupCount = 0;
                let recordCount = 0;
                
                Object.keys(groupsByDate).forEach(date => { if (date < targetDate) groupCount++; });
                Object.keys(records).forEach(date => { if (date < targetDate) recordCount++; });
                
                return { groupCount, recordCount };
            }, [groupsByDate, records, targetDate]);

            const handleCleanup = () => {
                if (cleanupStats.groupCount === 0 && cleanupStats.recordCount === 0) { showToast("ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                if (!confirm(`${targetDate} ì´ì „ì˜ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ëª¨ë‘  ê¸°ë¡: ${cleanupStats.groupCount}ê±´\n- í™œë™ ê¸°ë¡: ${cleanupStats.recordCount}ê±´\n\n(ì•ˆì „ì„ ìœ„í•´ í˜„ì¬ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤)`)) return;

                // ìë™ ë°±ì—… ì‹¤í–‰
                if (onBackup) onBackup();

                const newGroups = { ...groupsByDate };
                const newRecords = { ...records };
                const deletedGroupDates = [];
                const deletedRecordDates = [];
                Object.keys(newGroups).forEach(date => { if (date < targetDate) { delete newGroups[date]; deletedGroupDates.push(date); } });
                Object.keys(newRecords).forEach(date => { if (date < targetDate) { delete newRecords[date]; deletedRecordDates.push(date); } });

                setGroupsByDate(newGroups);
                setRecords(newRecords);
                
                if (!isLocalMode) {
                    // saveData({ cls_records: newRecords }); // [Fix] recordsëŠ” ë³„ë„ í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë¨ (ì‚­ì œëŠ” deleteRecordsFromFirestore ì‚¬ìš©)
                    // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ë¬¸ì„œ ì‚­ì œ
                    if (deletedGroupDates.length > 0) deleteGroupsFromFirestore(deletedGroupDates);
                    if (deletedRecordDates.length > 0) deleteRecordsFromFirestore(deletedRecordDates);
                }
                else { localStorage.setItem('cls_groups_date', JSON.stringify(newGroups)); localStorage.setItem('cls_records', JSON.stringify(newRecords)); }
                
                showToast("ë°ì´í„° ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ§¹ ë°ì´í„° ì •ë¦¬ ë„êµ¬" icon={PATHS.trash}>
                    <div className="space-y-4">
                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm text-orange-800"><p className="font-bold mb-1">âš ï¸ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬</p><p className="text-xs opacity-80">ì €ì¥ ìš©ëŸ‰ í™•ë³´ë¥¼ ìœ„í•´ ì˜¤ë˜ëœ ê¸°ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤.<br/>ì‚­ì œ ê¸°ì¤€ì¼ ì´ì „ì˜ ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.</p></div>
                        <div className="flex flex-col gap-2"><label className="text-xs font-bold text-slate-500">ì‚­ì œ ê¸°ì¤€ì¼ (ì´ ë‚ ì§œ ì´ì „ ë°ì´í„° ì‚­ì œ)</label><input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-orange-500" /><div className="flex justify-end gap-2 mt-1"><button onClick={() => setTargetDate(dayjs().subtract(6, 'month').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">6ê°œì›” ì „</button><button onClick={() => setTargetDate(dayjs().subtract(1, 'year').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">1ë…„ ì „</button></div></div>
                        <div className="bg-white border border-slate-200 rounded-xl p-4 space-y-2">
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ëª¨ë‘  ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.groupCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  í™œë™ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.recordCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ê³¼ì œ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.taskCount}ê±´</span></div>
                        </div>
                        <Btn onClick={handleCleanup} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md flex items-center justify-center gap-2"><Icon d={PATHS.trash} /> ì •ë¦¬ ì‹œì‘í•˜ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ResetOptionsModal = ({ isOpen, onClose, onReset }) => {
            const [selected, setSelected] = useState({
                students: true, records: true, groups: true, tasks: true, seats: true, roles: true
            });
            
            const options = [
                { id: 'students', label: 'í•™ìƒ ëª…ë‹¨', desc: 'ì´ë¦„, ì„±ë³„, ì‹¤ë ¥ ë“±' },
                { id: 'records', label: 'í™œë™ ê¸°ë¡', desc: 'ì²´í¬ë¦¬ìŠ¤íŠ¸, ìƒë‹´, ìŠ¤í‹°ì»¤' },
                { id: 'groups', label: 'ëª¨ë‘  ê¸°ë¡', desc: 'í¸ì„± ì´ë ¥, ê¸°í”¼ ê´€ê³„' },
                { id: 'tasks', label: 'ê³¼ì œ ì„¤ì •', desc: 'ì˜¤ëŠ˜/ìš”ì¼ë³„ ê³¼ì œ, íƒœê·¸' },
                { id: 'seats', label: 'ìë¦¬ ë°°ì¹˜', desc: 'í˜„ì¬ ë°°ì¹˜, ì±…ìƒ êµ¬ì¡°' },
                { id: 'roles', label: 'ì—­í•  ì„¤ì •', desc: 'ì—­í•  ëª©ë¡, ì„¤ëª…' },
            ];

            const toggleAll = () => {
                const allSelected = Object.values(selected).every(v => v);
                const newVal = !allSelected;
                const newSelected = {};
                options.forEach(o => newSelected[o.id] = newVal);
                setSelected(newSelected);
            };

            const handleReset = () => {
                const items = Object.keys(selected).filter(k => selected[k]);
                if (items.length === 0) return;
                onReset(items);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”" icon={PATHS.trash} maxWidth="max-w-md">
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">âš ï¸ ì£¼ì˜: ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">ì´ˆê¸°í™”í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={toggleAll} className="text-xs font-bold text-slate-500 hover:text-indigo-600 transition-colors">
                                {Object.values(selected).every(v => v) ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}
                            </button>
                        </div>

                        <div className="space-y-2">
                            {options.map(opt => (
                                <label key={opt.id} className={`flex items-center p-3 rounded-xl border cursor-pointer transition-all ${selected[opt.id] ? 'bg-rose-50 border-rose-200' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                    <input type="checkbox" checked={selected[opt.id]} onChange={() => setSelected(prev => ({ ...prev, [opt.id]: !prev[opt.id] }))} className="w-4 h-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500" />
                                    <div className="ml-3 flex-1">
                                        <div className={`text-sm font-bold ${selected[opt.id] ? 'text-rose-700' : 'text-slate-700'}`}>{opt.label}</div>
                                        <div className="text-xs text-slate-400">{opt.desc}</div>
                                    </div>
                                </label>
                            ))}
                        </div>

                        <div className="flex gap-2 mt-4">
                            <Btn onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                            <Btn onClick={handleReset} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md">
                                ì„ íƒ í•­ëª© ì‚­ì œ
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSafetyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="AI ë°ì´í„° ë³´ì•ˆ ëª¨ë“œë€?" icon={PATHS.help}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>í•™ìƒë“¤ì˜ ì†Œì¤‘í•œ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´, AIì—ê²Œ ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ì „ <strong>ì´ë¦„ì„ ìë™ìœ¼ë¡œ ê°€ëª… ì²˜ë¦¬(ë§ˆìŠ¤í‚¹)</strong>í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                        
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 className="font-bold text-slate-700 mb-2">ğŸ‘€ ì‘ë™ ì˜ˆì‹œ</h4>
                            <div className="space-y-3">
                                <div>
                                    <div className="text-xs font-bold text-rose-500 mb-1">ì›ë³¸ ë°ì´í„° (ì„ ìƒë‹˜ í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-rose-100 text-xs text-slate-500">
                                        "<strong>ê¹€ì² ìˆ˜</strong> í•™ìƒì€ <strong>ì´ì˜í¬</strong> í•™ìƒê³¼ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                                <div className="flex justify-center"><Icon d={PATHS.down} size={16} className="text-slate-300"/></div>
                                <div>
                                    <div className="text-xs font-bold text-indigo-600 mb-1">ì „ì†¡ ë°ì´í„° (AIê°€ ë³´ëŠ” í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-indigo-100 text-xs text-slate-500">
                                        "<strong>[STUDENT_TOKEN]</strong> í•™ìƒì€ <strong>ê¸‰ìš°</strong>ì™€ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-indigo-800 text-xs">
                            <p className="font-bold mb-1">âœ¨ ê¸°ëŠ¥ì´ ì¼œì ¸ ìˆìœ¼ë©´?</p>
                            <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ <strong>ì „ì†¡ ì „ í™•ì¸ ì°½</strong>ì´ ëœ¹ë‹ˆë‹¤. ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³€í™˜ë˜ì—ˆëŠ”ì§€ ëˆˆìœ¼ë¡œ ì§ì ‘ í™•ì¸í•˜ê³  ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSecurityCheckModal = ({ isOpen, onClose, prompt, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ”’ AI ì „ì†¡ ë°ì´í„° ë³´ì•ˆ í™•ì¸" icon={PATHS.lock} zIndex="z-[3000]">
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800">
                            <p className="font-bold mb-1">ğŸ›¡ï¸ ê°œì¸ì •ë³´ ë³´í˜¸ í•„í„° ì‘ë™ ì¤‘</p>
                            <p className="text-xs opacity-80">AIì—ê²Œ ì „ì†¡ë˜ê¸° ì§ì „ì˜ ë°ì´í„°ì…ë‹ˆë‹¤.<br/>í•™ìƒ ì´ë¦„ì´ <strong>[STUDENT_TOKEN]</strong> ë˜ëŠ” <strong>ê¸‰ìš°</strong>ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-[40vh] overflow-y-auto custom-scroll">
                            <p className="text-xs text-slate-600 whitespace-pre-wrap font-mono leading-relaxed">{prompt}</p>
                        </div>
                        <div className="flex justify-end gap-2">
                            <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì „ì†¡ ì·¨ì†Œ</Btn>
                            <Btn onClick={onConfirm} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center gap-2">
                                <Icon d={PATHS.send} size={16} /> ì „ì†¡í•˜ê¸°
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, students, setStudents, appConfig, setAppConfig, isLocalMode, saveData, showToast, openConfirm, handleResetAllData, onOpenSetup, onOpenNotionSetup, onOpenGoogleSheetSetup, onOpenApiKeySetup, records, groupsByDate, avoidancePairs, dailyTasks, weeklyTasks, tags, setRecords, setGroupsByDate, setAvoidancePairs, setDailyTasks, setWeeklyTasks, setTags, backupTimes, setBackupTimes, apiKey, setApiKey, mustPairs, setMustPairs, groupNames, setGroupNames, groupRoles, setGroupRoles, rolesList, setRolesList, roleDescriptions, setRoleDescriptions, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, db, appId, deferredPrompt, isIOS, isStandalone, onInstallApp, isDevMode, onDevModeClick, deleteTasksFromFirestore, onTestUpdate }) => {
            const [name, setName] = useState("");
            const [gender, setGender] = useState("M"); const [skill, setSkill] = useState(2); const [note, setNote] = useState(""); const [isLeader, setIsLeader] = useState(false);
            const fileRef = useRef(null); const jsonFileRef = useRef(null); const runnerImgRef = useRef(null); const cloudIconRef = useRef(null); const faviconRef = useRef(null);
            const [deleteTargetId, setDeleteTargetId] = useState(null); const [isDeletingAll, setIsDeletingAll] = useState(false); const [editingId, setEditingId] = useState(null); const [editData, setEditData] = useState({});
            const [isDeleteLocked, setIsDeleteLocked] = useState(true);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(() => localStorage.getItem('cls_auto_backup') === 'true'); const [showBackupHelp, setShowBackupHelp] = useState(false); const [isAdminMode, setIsAdminMode] = useState(false);
            const [adminClickCount, setAdminClickCount] = useState(0); const [ampm, setAmpm] = useState("PM"); const [hour, setHour] = useState("12"); const [minute, setMinute] = useState("00");
            const [newVacStart, setNewVacStart] = useState(""); const [newVacEnd, setNewVacEnd] = useState("");
            const [showFontList, setShowFontList] = useState(false);
            
            // ì½”ë“œ ì—…ë°ì´íŠ¸ ê´€ë ¨ ìƒíƒœ
            const [showCodeUpdater, setShowCodeUpdater] = useState(false);
            const [updateCodeInput, setUpdateCodeInput] = useState("");
            const [isUpdating, setIsUpdating] = useState(false);
            const [updateProgress, setUpdateProgress] = useState(0);
            const [updateStatus, setUpdateStatus] = useState("");
            const [remainingTime, setRemainingTime] = useState(3);
            const [aiUsage, setAiUsage] = useState(0);
            const [showManualModal, setShowManualModal] = useState(false);
            const [showStorageHelp, setShowStorageHelp] = useState(false);
            const [showCleanupModal, setShowCleanupModal] = useState(false);
            const [isDataManagementOpen, setIsDataManagementOpen] = useState(true);
            const [showFaviconHelp, setShowFaviconHelp] = useState(false);
            const [showResetOptions, setShowResetOptions] = useState(false);
            const [isStudentListOpen, setIsStudentListOpen] = useState(true);
            const [activeTab, setActiveTab] = useState('app');
            const prevTabRef = useRef(activeTab);
            const isGoogleSheetConnected = !!localStorage.getItem('cls_google_sheet_url');
            const [aiSafetyCheck, setAiSafetyCheck] = useState(() => localStorage.getItem('cls_ai_safety_check') === 'true');
            const [showAiSafetyHelp, setShowAiSafetyHelp] = useState(false);

            const toggleAiSafetyCheck = () => {
                const newVal = !aiSafetyCheck;
                setAiSafetyCheck(newVal);
                localStorage.setItem('cls_ai_safety_check', newVal);
                showToast(newVal ? "AI ì „ì†¡ ì‹œ ë³´ì•ˆ í™•ì¸ ì°½ì´ í‘œì‹œë©ë‹ˆë‹¤." : "AI ì „ì†¡ ë³´ì•ˆ í™•ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getTabAnimationClass = () => {
                if (appConfig.tabAnimationEnabled === false) return '';
                const tabs = ['student', 'app', 'data'];
                const prevIdx = tabs.indexOf(prevTabRef.current);
                const currIdx = tabs.indexOf(activeTab);
                if (prevIdx === -1 || currIdx === -1 || prevIdx === currIdx) return 'animate-fade-in';
                return currIdx > prevIdx ? 'animate-slide-in-right' : 'animate-slide-in-left';
            };
            useEffect(() => { prevTabRef.current = activeTab; }, [activeTab]);
            
            const isNotionConnected = !!(localStorage.getItem('cls_notion_key') && localStorage.getItem('cls_notion_db_id'));
            const isAiConnected = !!apiKey;

            const dataUsage = useMemo(() => {
                const data = {
                    students, records, groupsByDate, avoidancePairs, mustPairs, 
                    dailyTasks, weeklyTasks, tags, appConfig, groupNames, 
                    groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig
                };
                const json = JSON.stringify(data);
                const bytes = new Blob([json]).size;
                // [Mod] ë¡œì»¬ ëª¨ë“œ: 5MB, í´ë¼ìš°ë“œ ëª¨ë“œ: 1MB ê¸°ì¤€
                const MAX_SIZE = isLocalMode ? 5242880 : 1048576; 
                const kb = (bytes / 1024).toFixed(1);
                const percent = ((bytes / MAX_SIZE) * 100).toFixed(1);
                
                // ìƒì„¸ ë¶„ì„ ì¶”ê°€
                const details = [
                    { label: 'í•™ìƒ ëª…ë‹¨', val: students },
                    { label: 'í™œë™ ê¸°ë¡', val: records },
                    { label: 'ëª¨ë‘  ê¸°ë¡', val: groupsByDate },
                    { label: 'ê³¼ì œ ëª©ë¡', val: dailyTasks },
                    { label: 'ëª¨ë‘  ì´ë¦„', val: groupNames },
                    { label: 'ëª¨ë‘  ì—­í• ', val: groupRoles },
                    { label: 'ìë¦¬ ë°°ì¹˜', val: seatAssignments },
                    { label: 'ê¸°íƒ€ ì„¤ì •', val: { avoidancePairs, mustPairs, weeklyTasks, tags, appConfig, rolesList, roleDescriptions, seatConfig } }
                ].map(item => {
                    const itemBytes = new Blob([JSON.stringify(item.val)]).size;
                    return {
                        label: item.label,
                        bytes: itemBytes,
                        kb: (itemBytes / 1024).toFixed(1),
                        percent: bytes > 0 ? ((itemBytes / bytes) * 100).toFixed(1) : 0
                    };
                }).sort((a, b) => b.bytes - a.bytes);

                return { kb, percent, bytes, isWarning: percent > 80, isCritical: percent > 95, details };
            }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig, isLocalMode]);

            const updateAppConfig = (updates) => {
                const newConfig = { ...appConfig, ...updates };
                setAppConfig(newConfig);
                saveData('cls_app_config', newConfig);
            };

            useEffect(() => { 
                if (isOpen) { 
                    setAiUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setNewVacStart("");
                    setNewVacEnd("");
                } 
            }, [isOpen]);

            const currentVacations = useMemo(() => {
                if (appConfig.vacations && appConfig.vacations.length > 0) return appConfig.vacations;
                if (appConfig.vacationStart && appConfig.vacationEnd) return [{ start: appConfig.vacationStart, end: appConfig.vacationEnd }];
                return [];
            }, [appConfig.vacations, appConfig.vacationStart, appConfig.vacationEnd]);

            const addVacation = () => {
                if (newVacStart && newVacEnd) {
                    if (newVacStart > newVacEnd) return showToast("ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    const newVacations = [...currentVacations, { start: newVacStart, end: newVacEnd }].sort((a, b) => a.start.localeCompare(b.start));
                    updateAppConfig({ vacations: newVacations });
                    setNewVacStart(""); setNewVacEnd("");
                } else { showToast("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); }
            };
            const removeVacation = (index) => { 
                const newVacations = currentVacations.filter((_, i) => i !== index);
                updateAppConfig({ vacations: newVacations });
            };

            const toggleAutoBackup = () => { const newValue = !autoBackupEnabled; setAutoBackupEnabled(newValue); localStorage.setItem('cls_auto_backup', newValue);
            showToast(newValue ? "ìë™ ë°±ì—…ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ìë™ ë°±ì—…ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤."); };
            
            const addBackupTime = () => { let h = parseInt(hour);
            if (ampm === "PM" && h !== 12) h += 12;
            if (ampm === "AM" && h === 12) h = 0; const timeStr = `${String(h).padStart(2, '0')}:${minute}`;
            if (!backupTimes.includes(timeStr) && backupTimes.length < 4) { const newTimes = [...backupTimes, timeStr].sort(); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes));
            } else if (backupTimes.includes(timeStr)) { showToast("ì´ë¯¸ ì„¤ì •ëœ ì‹œê°„ì…ë‹ˆë‹¤."); } else if (backupTimes.length >= 4) { showToast("ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            } };
            const removeBackupTime = (time) => { const newTimes = backupTimes.filter(t => t !== time); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes)); };
            
            // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
            const handleDataManagementClick = () => { 
                const newCount = adminClickCount + 1; 
                if(newCount >= 3) { 
                    setIsAdminMode(!isAdminMode);
                    showToast(!isAdminMode ? "ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    setAdminClickCount(0);
                } else {
                    setAdminClickCount(newCount);
                }
            };

            const addTestData = () => { 
                const testData = [
                    { name: "ìœ ì¬ì„", gender: "M" }, { name: "ì•„ì´ìœ ", gender: "F" }, { name: "ë°•ë³´ê²€", gender: "M" }, 
                    { name: "ê¹€ì—°ì•„", gender: "F" }, { name: "ì†í¥ë¯¼", gender: "M" }, { name: "ë´‰ì¤€í˜¸", gender: "M" }, 
                    { name: "ê¹€íƒœë¦¬", gender: "F" }, { name: "ê³µìœ ", gender: "M" }, { name: "ì†¡í˜œêµ", gender: "F" }, 
                    { name: "í˜„ë¹ˆ", gender: "M" }, { name: "ì†ì˜ˆì§„", gender: "F" }, { name: "ì´ì •ì¬", gender: "M" }, 
                    { name: "ì „ì§€í˜„", gender: "F" }, { name: "ë§ˆë™ì„", gender: "M" }, { name: "ê¹€í˜œìˆ˜", gender: "F" }
                ];
                const newStudents = testData.map((d, i) => ({ id: Date.now() + i, name: d.name, order: students.length + i + 1, gender: d.gender, skill: (i % 3) + 1, note: "í…ŒìŠ¤íŠ¸ í•™ìƒ", leader: i % 5 === 0 }));
                const updatedStudents = [...students, ...newStudents]; 
                setStudents(updatedStudents); 
                if(!isLocalMode) saveData('cls_students', updatedStudents); 
                showToast("í…ŒìŠ¤íŠ¸ í•™ìƒ 15ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100); 
            };
            const addStudent = () => { if (name) { const updated = [...students, { id: Date.now(), name, order: students.length + 1, gender, skill, note, leader: isLeader }];
            setStudents(updated); if(!isLocalMode) saveData('cls_students', updated); setName(""); setNote(""); setIsLeader(false); setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100);
            } };
            const deleteStudent = (id) => { const n = students.filter(s => s.id !== id); setStudents(n); if(!isLocalMode) saveData('cls_students', n);
            };
            const startEdit = (student) => { setEditingId(student.id); setEditData({...student}); };
            const cancelEdit = () => { setEditingId(null); setEditData({}); };
            const saveEdit = () => { const updatedStudents = students.map(s => s.id === editingId ? editData : s); setStudents(updatedStudents);
            if(!isLocalMode) saveData('cls_students', updatedStudents); setEditingId(null); setEditData({}); showToast("í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); };
            const handleFileUpload = (e) => { const f = e.target.files[0];
            if (!f) return; const r = new FileReader(); r.onload = (ev) => { const lines = ev.target.result.split(/[\r\n]+/).filter(l => l.trim());
            const newStds = []; lines.forEach((l, i) => { const p = l.split(','); if (p[0]) newStds.push({ id: Date.now() + i, name: p[0].trim(), gender: (p[1] || 'M').trim(), skill: parseInt(p[2] || 2), note: (p[3] || "").trim(), order: students.length + i + 1, leader: false }); });
            if (newStds.length) { const u = [...students, ...newStds]; setStudents(u); if(!isLocalMode) saveData('cls_students', u); showToast(`${newStds.length}ëª… ì¶”ê°€ë¨`); } }; r.readAsText(f); };
            const handleDeleteAll = () => { setStudents([]); if(!isLocalMode) saveData('cls_students', []); setIsDeletingAll(false); setIsDeleteLocked(true); showToast("ì „ì²´ ì‚­ì œë¨"); };
            const getCleanHtmlCode = () => { const docClone = document.documentElement.cloneNode(true); const root = docClone.querySelector('#root'); if (root) root.innerHTML = '';
            const scripts = docClone.querySelectorAll('script'); scripts.forEach(s => { if (!s.hasAttribute('data-app-script')) s.remove(); }); const styles = docClone.querySelectorAll('style');
            styles.forEach(s => { if (!s.hasAttribute('data-app-style')) s.remove(); }); return "<!DOCTYPE html>\n" + docClone.outerHTML; };
            const handleDownloadHtml = () => { const html = getCleanHtmlCode(); const blob = new Blob([html], {type: "text/html"});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Checklist_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.html`; link.click(); };
            const handleCopyCode = () => { const htmlContent = getCleanHtmlCode(); const textarea = document.createElement("textarea"); textarea.value = htmlContent; document.body.appendChild(textarea); textarea.select();
            try { const successful = document.execCommand('copy'); if (successful) showToast("ì „ì²´ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); else showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } catch (err) { showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } finally { document.body.removeChild(textarea); } };
            
            const handleExportJson = async () => { 
                let exportStudents = [...students];
                let exportRecords = { ...records };
                let exportGroups = { ...groupsByDate };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì¼ ê²½ìš° ë¶„ì‚° ì €ì¥ëœ ëª¨ë“  ë°ì´í„°(í•™ìƒìƒì„¸, ê¸°ë¡, ëª¨ë‘ )ë¥¼ ê°€ì ¸ì™€ì„œ ë³‘í•©
                if (!isLocalMode && db && appId) {
                    showToast("í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
                    try {
                        // 1. í•™ìƒ ê°œë³„ ë°ì´í„° (ìƒë‹´, ì´ˆì•ˆ)
                        const studentSnapshot = await db.collection('classes').doc(appId).collection('studentData').get();
                        const studentDataMap = {};
                        studentSnapshot.forEach(doc => { studentDataMap[doc.id] = doc.data(); });
                        
                        exportStudents = exportStudents.map(s => {
                            const extra = studentDataMap[String(s.id)];
                            return extra ? { ...s, ...extra } : s;
                        });

                        // 2. í™œë™ ê¸°ë¡ (Records)
                        const recordSnapshot = await db.collection('classes').doc(appId).collection('records').get();
                        recordSnapshot.forEach(doc => { 
                            exportRecords[doc.id] = doc.data(); 
                        });

                        // 3. ëª¨ë‘  ê¸°ë¡ (GroupResults)
                        const groupSnapshot = await db.collection('classes').doc(appId).collection('groupResults').get();
                        groupSnapshot.forEach(doc => { 
                            const data = doc.data();
                            exportGroups[doc.id] = data.list || data; 
                        });
                        
                        // 4. ê³¼ì œ ë°ì´í„° (Tasks)
                        const taskSnapshot = await db.collection('classes').doc(appId).collection('tasks').get();
                        taskSnapshot.forEach(doc => {
                            if (doc.id === 'settings') {
                                // settingsëŠ” ë³„ë„ ì²˜ë¦¬ ì•ˆí•¨ (stateì— ì´ë¯¸ ìˆìŒ)
                            } else {
                                // exportDailyTasks[doc.id] = doc.data().list; // dailyTasks stateì— ì´ë¯¸ ë³‘í•©ë˜ì–´ ìˆìŒ
                            }
                        });

                    } catch (e) {
                        console.error("Export fetch error:", e);
                        showToast("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ë°ì´í„°ê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    }
                }

                const data = { 
                    version: appConfig.version, 
                    date: dayjs().format('YYYY-MM-DD HH:mm:ss'), 
                    students: exportStudents, 
                    records: exportRecords, 
                    groupsByDate: exportGroups, 
                    avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig 
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url;
                link.download = `Checklist_Data_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.json`; link.click(); showToast("ë°ì´í„°ê°€ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤."); 
            };
            
            const handleImportJson = (e) => { const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if(data.students) { setStudents(data.students);
            if(!isLocalMode) saveData('cls_students', data.students); } if(data.records) { setRecords(data.records); if(!isLocalMode) saveData('cls_records', data.records); } if(data.groupsByDate) { setGroupsByDate(data.groupsByDate); if(!isLocalMode) saveData('cls_groups_date', data.groupsByDate);
            } if(data.avoidancePairs) { setAvoidancePairs(data.avoidancePairs); if(!isLocalMode) saveData('cls_avoidance', data.avoidancePairs); } if(data.dailyTasks) { setDailyTasks(data.dailyTasks); if(!isLocalMode) saveData('cls_daily_tasks', data.dailyTasks); } if(data.weeklyTasks) { setWeeklyTasks(data.weeklyTasks);
            if(!isLocalMode) saveData('cls_weekly_tasks', data.weeklyTasks); } if(data.tags) { setTags(data.tags); if(!isLocalMode) saveData('cls_tags', data.tags); } 
            if(data.mustPairs) { setMustPairs(data.mustPairs); if(!isLocalMode) saveData('cls_mustPairs', data.mustPairs); }
            if(data.groupNames) { setGroupNames(data.groupNames); if(!isLocalMode) saveData('cls_group_names', data.groupNames); }
            if(data.groupRoles) { setGroupRoles(data.groupRoles); if(!isLocalMode) saveData('cls_group_roles', data.groupRoles); }
            if(data.rolesList) { setRolesList(data.rolesList); if(!isLocalMode) saveData('cls_roles_list', data.rolesList); }
            if(data.roleDescriptions) { setRoleDescriptions(data.roleDescriptions); if(!isLocalMode) saveData('cls_role_descriptions', data.roleDescriptions); }
            if(data.seatAssignments) { setSeatAssignments(data.seatAssignments); if(!isLocalMode) saveData('cls_seat_assignments', data.seatAssignments); }
            if(data.seatConfig) { setSeatConfig(data.seatConfig); if(!isLocalMode) saveData('cls_seat_config', data.seatConfig); }
            if(data.appConfig) { setAppConfig(data.appConfig); setCfg(data.appConfig); if(!isLocalMode) saveData('cls_app_config', data.appConfig);
            } showToast("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); } catch(err) { 
                logSystemEvent(`JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
                showToast("JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); } }; reader.readAsText(file); };
            
            const handleApplyCode = () => {
                let code = updateCodeInput.trim();
                if (!code) return showToast("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setIsUpdating(true);
                setUpdateProgress(0);
                setUpdateStatus("ì½”ë“œ ë¶„ì„ ì¤‘...");
                setRemainingTime(3.0);

                const loaderHtml = `
                    <div id="temp-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#F5F5F7;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:sans-serif;">
                        <div style="font-size:40px;margin-bottom:20px;">ğŸš€</div>
                        <h2 style="color:#1e293b;margin-bottom:10px;">ì•±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
                        <p style="color:#64748b;font-size:14px;">í™”ë©´ì´ ì ì‹œ í•˜ì–—ê²Œ ë³´ì—¬ë„ ì •ìƒì…ë‹ˆë‹¤.</p>
                        <div style="width:200px;height:4px;background:#cbd5e1;border-radius:4px;margin-top:20px;overflow:hidden;">
                            <div style="width:100%;height:100%;background:#3b82f6;animation:loaderAnim 1.5s infinite ease-in-out;"></div>
                        </div>
                        <style>@keyframes loaderAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }</style>
                    </div>
                `;
                
                if (code.includes("<body")) {
                    code = code.replace(/<body[^>]*>/, (match) => match + loaderHtml);
                } else {
                    code = loaderHtml + code;
                }

                let progress = 0;
                const totalSteps = 30; 
                
                const timer = setInterval(() => {
                    progress += 100 / totalSteps;
                    const currentProgress = Math.min(Math.round(progress), 100);
                    const timeLeft = Math.max(0, (3 - (progress / 100 * 3))).toFixed(1);

                    setUpdateProgress(currentProgress);
                    setRemainingTime(timeLeft);

                    if (currentProgress < 30) setUpdateStatus("ì½”ë“œ ë¬´ê²°ì„± ê²€ì‚¬ ì¤‘...");
                    else if (currentProgress < 60) setUpdateStatus("ë°ì´í„° ë°±ì—… í™•ì¸ ì¤‘...");
                    else if (currentProgress < 90) setUpdateStatus("ìƒˆë¡œìš´ í™˜ê²½ êµ¬ì„± ì¤‘...");
                    else setUpdateStatus("ì—…ë°ì´íŠ¸ ì ìš© ì¤€ë¹„ ì™„ë£Œ!");

                    if (progress >= 100) {
                        clearInterval(timer);
                        setTimeout(() => {
                            setUpdateStatus("í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤...");
                            try {
                                document.open();
                                document.write(code); 
                                document.close();
                            } catch (e) {
                                logSystemEvent(`ì½”ë“œ ì—…ë°ì´íŠ¸ ì ìš© ì‹¤íŒ¨: ${e.message}`, 'error');
                                setIsUpdating(false);
                                showToast("ì½”ë“œ ì ìš© ì‹¤íŒ¨: " + e.message);
                            }
                        }, 500);
                    }
                }, 100);
            };

            const handleSaveCodeFile = () => {
                logSystemEvent('ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ ì €ì¥ ì‹œë„');
                if (!updateCodeInput.trim()) return showToast("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                const blob = new Blob(["\ufeff" + updateCodeInput], {type: "text/html;charset=utf-8"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Checklist_Updated_${dayjs().format('YYYYMMDD')}.html`;
                link.click();
                showToast("ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getManualContent = () => `
================================================================
  ğŸ“˜ ì´ê±°í–ˆì–´? ì‚¬ìš© ì„¤ëª…ì„œ (v${appConfig.version})
================================================================

ì•ˆë…•í•˜ì„¸ìš”, ì„ ìƒë‹˜! 
ì´ê±°í–ˆì–´?ëŠ” í•™ê¸‰ ìš´ì˜ì„ ë” ì‰½ê³  ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë„ì™€ë“œë¦¬ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
ì£¼ìš” ê¸°ëŠ¥ê³¼ ì‚¬ìš© íŒì„ ì•„ë˜ì— ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.

----------------------------------------------------------------
1. ğŸ§‘â€ğŸ“ í•™ìƒ ê´€ë¦¬ (ê¸°ì´ˆ ê³µì‚¬)
----------------------------------------------------------------
- [ë“±ë¡]: ì„¤ì •(âš™ï¸) > í•™ìƒ ê´€ë¦¬ì—ì„œ ì´ë¦„ì„ ì…ë ¥í•˜ê³  'ì¶”ê°€'ë¥¼ ëˆ„ë¥´ì„¸ìš”.
- [ì¼ê´„ ë“±ë¡]: ì—‘ì…€(CSV)ì´ë‚˜ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ëª…ë‹¨ì„ í•œ ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ì‚¬ì§„ ê´€ë¦¬]: 'ì‚¬ì§„ ì¼ê´„ ê´€ë¦¬' ë²„íŠ¼ìœ¼ë¡œ í•™ìƒë“¤ì˜ ì‚¬ì§„ì„ ì†ì‰½ê²Œ ë“±ë¡í•˜ì„¸ìš”.
- [ìˆ˜ì •/ì‚­ì œ]: í•™ìƒ ëª©ë¡ì—ì„œ ì—°í•„ ì•„ì´ì½˜(ìˆ˜ì •)ì´ë‚˜ íœ´ì§€í†µ ì•„ì´ì½˜(ì‚­ì œ)ì„ ëˆ„ë¥´ì„¸ìš”.
- [íŒ]: í•™ìƒì—ê²Œ 'ë¦¬ë”(ğŸ‘‘)' ì†ì„±ì„ ì£¼ë©´ ëª¨ë‘  í¸ì„± ì‹œ ê° ì¡°ì— ê³¨ê³ ë£¨ ë°°ì¹˜ë©ë‹ˆë‹¤.

----------------------------------------------------------------
2. ğŸ“ ê¸°ë¡ ëª¨ë“œ (ë§¤ì¼ ì“°ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸)
----------------------------------------------------------------
- [ì²´í¬]: í•™ìƒ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ê³¼ì œ ì œì¶œ/ì™„ë£Œ ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤.
- [ì„¸ë¶€ ê³¼ì œ]: 'ê³¼ì œ ì„¤ì •(+)' ë²„íŠ¼ì„ ëˆŒëŸ¬ 'ì¼ê¸°', 'ë…ì„œë¡' ë“± ì—¬ëŸ¬ ê³¼ì œë¥¼ ë“±ë¡í•˜ì„¸ìš”.
- [í•™ê¸‰ ìŠ¤í† ë¦¬]: í•˜ë£¨ ê¸°ë¡ì´ ëë‚˜ë©´ 'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ìŠ¤í† ë¦¬' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. 
  AIê°€ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ íŒíƒ€ì§€, ë™í™”, SF ë“± ë‹¤ì–‘í•œ ì¥ë¥´ì˜ ì´ì•¼ê¸°ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

----------------------------------------------------------------
3. ğŸ§© ëª¨ë‘  & ìë¦¬ ë°°ì¹˜ (AI ë¹„ì„œ)
----------------------------------------------------------------
- [AI í¸ì„±]: ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”, ê¸°í”¼ ê´€ê³„ ë“±ì„ ê³ ë ¤í•´ AIê°€ ìµœì ì˜ ëª¨ë‘ ì„ ì§œì¤ë‹ˆë‹¤.
- [ìˆ˜ë™ ì¡°ì •]: ë§ˆìš°ìŠ¤ë¡œ í•™ìƒì„ ë“œë˜ê·¸í•˜ì—¬ ë‹¤ë¥¸ ëª¨ë‘ ìœ¼ë¡œ ì‰½ê²Œ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ìë¦¬ ë°°ì¹˜]: í¸ì„±ëœ ëª¨ë‘ ì„ ë°”íƒ•ìœ¼ë¡œ êµì‹¤ ìë¦¬ ë°°ì¹˜ë„ê¹Œì§€ í•œ ë²ˆì— í•´ê²°í•˜ì„¸ìš”.
- [ì—­í•  ë¶„ë‹´]: 'ëª¨ë‘  ë„êµ¬'ì—ì„œ ë‚˜ëˆ”ì´, ì´ë„ë¯¸ ë“± ì—­í• ì„ ìë™ìœ¼ë¡œ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ë¶„ì„]: ëª¨ë‘ ë³„ ì„±ë³„/ì‹¤ë ¥ ë¶„í¬ë¥¼ ê·¸ë˜í”„ë¡œ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

----------------------------------------------------------------
4. ğŸ“Š í†µê³„ & ìƒë‹´ (ë°ì´í„° ê¸°ë°˜ ì§€ë„)
----------------------------------------------------------------
- [ëª…ì˜ˆì˜ ì „ë‹¹]: ì„±ì‹¤í•˜ê²Œ ì°¸ì—¬í•œ í•™ìƒë“¤ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”.
- [í™œë™ ì”ë””]: í•™ìƒë³„ 30ì¼ê°„ì˜ í™œë™ ê¸°ë¡ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.
- [AI ì£¼ê°„ ë¸Œë¦¬í•‘]: ì´ë²ˆ ì£¼ ìš°ë¦¬ ë°˜ ë¶„ìœ„ê¸°ê°€ ì–´ë• ëŠ”ì§€ AIê°€ ìš”ì•½í•´ì¤ë‹ˆë‹¤.
- [í•™ìƒ ì¸ì‚¬ì´íŠ¸]: í•™ìƒ ì´ë¦„ì„ ë”ë¸” í´ë¦­í•˜ë©´ ê°œë³„ ìƒë‹´ ê¸°ë¡, ì„±ì¥ ë¦¬í¬íŠ¸, 
  í•™ê¸‰ í‰ê·  ë¹„êµ ê·¸ë˜í”„ ë“±ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. AIê°€ ìƒí™œê¸°ë¡ë¶€ ì´ˆì•ˆë„ ì¨ì¤ë‹ˆë‹¤!

----------------------------------------------------------------
5. ğŸ’¾ ë°ì´í„° ì•ˆì „ & ì„¤ì •
----------------------------------------------------------------
- [ìë™ ì €ì¥]: ëª¨ë“  ë°ì´í„°ëŠ” ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
- [ë°±ì—…]: ì„¤ì • > ë°ì´í„° ê´€ë¦¬ > 'ë°ì´í„° ë‚´ë³´ë‚´ê¸°'ë¡œ ë°±ì—… íŒŒì¼ì„ PCì— ì €ì¥í•´ë‘ì„¸ìš”.
- [AI ì„¤ì •]: Google Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ë” ë˜‘ë˜‘í•œ AI ê¸°ëŠ¥ì„ ë¬´ë£Œë¡œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [í°íŠ¸ ë³€ê²½]: ì„¤ì • > ì•± ì„¤ì •ì—ì„œ ê³ ë”•, ëª…ì¡°, ì†ê¸€ì”¨ ë“± ì›í•˜ëŠ” í°íŠ¸ë¡œ ë³€ê²½í•´ë³´ì„¸ìš”.

----------------------------------------------------------------
ğŸ’¡ ë¬¸ì˜ ë° ì œì•ˆ: spk@smca.or.kr
================================================================
`.trim();

            const handleDownloadManualFile = () => {
                const content = getManualContent();
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Classroom_Checklist_Manual_v${appConfig.version}.txt`;
                link.click();
                showToast("ì‚¬ìš© ì„¤ëª…ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };


            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title={<><span onClick={onDevModeClick} className="cursor-default">âš™ï¸</span> <span onClick={handleDataManagementClick} className="cursor-default select-none">ì„¤ì •</span></>} icon={null} maxWidth="max-w-6xl">
                    <HelpModal isOpen={showBackupHelp} onClose={()=>setShowBackupHelp(false)} />
                    <ManualModal isOpen={showManualModal} onClose={() => setShowManualModal(false)} content={getManualContent()} onDownload={handleDownloadManualFile} />
                    
                    {isUpdating && (
                        <div className="fixed inset-0 z-[9999] bg-slate-900/90 flex flex-col items-center justify-center text-white backdrop-blur-sm animate-fade-in">
                            <div className="w-full max-w-md p-8 bg-slate-800 rounded-3xl shadow-2xl border border-slate-700 text-center">
                                <div className="mb-6 animate-bounce text-4xl">ğŸš€</div>
                                <h3 className="text-2xl font-bold mb-2">ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘</h3>
                                <p className="text-slate-400 text-sm mb-6">{updateStatus}</p>
                                <div className="relative h-4 bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div className="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 ease-out" style={{ width: `${updateProgress}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs font-mono text-slate-300 mb-4">
                                    <span>{updateProgress}%</span>
                                    <span>ë‚¨ì€ ì‹œê°„: {remainingTime}ì´ˆ</span>
                                </div>
                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-yellow-200 text-xs text-left">
                                    âš ï¸ <strong>ì£¼ì˜:</strong> ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ë©´ ì ì‹œ <strong>í™”ë©´ì´ í•˜ì–—ê²Œ ë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</strong>. <br/>
                                    ì´ëŠ” ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì •ìƒì ì¸ ê³¼ì •ì…ë‹ˆë‹¤. ë‹¹í™©í•˜ì§€ ë§ê³  3~5ì´ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex flex-col md:flex-row h-[65vh] gap-6">
                        <div className="w-full md:w-40 flex-shrink-0 flex flex-row md:flex-col gap-1 md:gap-2 bg-slate-50 md:bg-transparent p-1 md:p-0 rounded-xl">
                            <button onClick={() => setActiveTab('student')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'student' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ‘¤ í•™ìƒ ê´€ë¦¬</button>
                            <button onClick={() => setActiveTab('app')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'app' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ“± ì•± ì„¤ì •</button>
                            <button onClick={() => setActiveTab('data')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'data' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</button>
                        </div>

                        <div className={`flex-1 overflow-y-auto custom-scroll pr-2 space-y-6 pb-10 ${getTabAnimationClass()}`} key={activeTab}>
                            {activeTab === 'student' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><span className="text-xl">ğŸ§‘â€ğŸ“</span> í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</h3>
                                            <div className="flex items-center">
                                                <Btn onClick={() => fileRef.current.click()} className="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 flex items-center gap-1 font-bold" title="CSV/TXT ì—…ë¡œë“œ"> <Icon d={PATHS.upload} size={14} /> <span>CSV ì—…ë¡œë“œ</span> </Btn>
                                                <input type="file" ref={fileRef} onChange={handleFileUpload} className="hidden" accept=".csv,.txt" />
                                            </div>
                                        </div>
                                <div className="flex flex-wrap gap-2 items-center">
                                    <input value={name} onChange={e => setName(e.target.value)} className="h-10 p-2.5 border rounded-xl text-sm w-24 sm:w-32" placeholder="ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <select value={gender} onChange={e => setGender(e.target.value)} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select>
                                    <select value={skill} onChange={e => setSkill(parseInt(e.target.value))} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select>
                                    <input value={note} onChange={e => setNote(e.target.value)} className="h-10 flex-1 p-2.5 border rounded-xl text-sm min-w-[100px]" placeholder="ë¹„ê³ " onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <button onClick={() => setIsLeader(!isLeader)} className={`h-10 px-3 border rounded-xl text-lg ${isLeader ? 'bg-yellow-100 border-yellow-300 text-yellow-600' : 'bg-white border-slate-200 text-slate-300'}`} title="ë¦¬ë”(ì´ë„ë¯¸)">ğŸ‘‘</button>
                                    <Btn onClick={addStudent} className="h-10 bg-indigo-600 text-white px-4 rounded-xl font-bold hover:bg-indigo-700 text-sm whitespace-nowrap">ì¶”ê°€</Btn>
                                </div>
                                    </div>
                            
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col h-[500px]">
                                        <div className="flex justify-between items-center mb-3 flex-shrink-0">
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2">
                                                <span className="text-lg">ğŸ“‹</span> ë“±ë¡ëœ í•™ìƒ ëª…ë‹¨ ({students.length}ëª…)
                                            </h4>
                                            <div className="flex gap-2">
                                                <Btn onClick={addTestData} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:bg-indigo-100 transition-colors whitespace-nowrap">í…ŒìŠ¤íŠ¸ ëª…ë‹¨</Btn>
                                                {isDeleteLocked ? (
                                                    <Btn onClick={() => setIsDeleteLocked(false)} className="text-xs bg-slate-100 text-slate-400 p-1.5 rounded-lg font-bold flex items-center justify-center hover:bg-slate-200 transition-colors" title="ì ê¸ˆ í•´ì œ"><Icon d={PATHS.lock} size={14} /></Btn>
                                                ) : (
                                                    isDeletingAll ?
                                                    <div className="flex gap-2"><Btn onClick={handleDeleteAll} className="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg animate-pulse whitespace-nowrap">í™•ì¸</Btn><Btn onClick={() => { setIsDeletingAll(false); setIsDeleteLocked(true); }} className="text-xs bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg whitespace-nowrap">ì·¨ì†Œ</Btn></div> : 
                                                    <Btn onClick={() => setIsDeletingAll(true)} className="text-xs bg-rose-100 text-rose-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 whitespace-nowrap"><Icon d={PATHS.trash} size={12} /> ì „ì²´ ì‚­ì œ</Btn>
                                                )}
                                            </div>
                                        </div>
                            
                                        <div id="student-list" className="flex-1 overflow-y-auto custom-scroll bg-white p-2 rounded-xl border border-slate-200 shadow-inner space-y-1">
                                            {students.map(s => (
                                    <div key={s.id} className="flex justify-between items-center p-2.5 bg-white rounded-lg border border-slate-100 text-sm group min-h-[46px]">
                                        {editingId === s.id ? (
                                            <div className="flex gap-1 flex-1 items-center animate-fade-in w-full">
                                                <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-1 flex items-center justify-center">
                                                    <span className="text-sm">{editData.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                                </div>
                                                <span className="text-indigo-500 font-bold w-6 text-center">{s.order}.</span> <input value={editData.name} onChange={e=>setEditData({...editData, name: e.target.value})} className="p-1 border rounded w-20 text-xs" /> <select value={editData.gender} onChange={e=>setEditData({...editData, gender: e.target.value})} className="p-1 border rounded w-12 text-xs"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select> <select value={editData.skill} onChange={e=>setEditData({...editData, skill: parseInt(e.target.value)})} className="p-1 border rounded w-12 text-xs"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select> <input value={editData.note} onChange={e=>setEditData({...editData, note: e.target.value})} className="flex-1 p-1 border rounded text-xs min-w-[50px]" placeholder="ë¹„ê³ " /> <button onClick={() => setEditData({...editData, leader: !editData.leader})} className={`p-1 border rounded text-xs ${editData.leader ? 'bg-yellow-100 border-yellow-300' : 'bg-slate-50'}`}>ğŸ‘‘</button> <Btn onClick={saveEdit} className="bg-indigo-500 text-white px-2 py-1 rounded text-xs font-bold">ì €ì¥</Btn> <Btn onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-2 py-1 rounded text-xs">ì·¨ì†Œ</Btn> </div>
                                        ) : (
                                            <> 
                                                <div className="flex flex-col">
                                                    <span className="font-medium text-slate-700 flex items-center">
                                                        <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-2 flex items-center justify-center">
                                                            <span className="text-sm">{s.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                                        </div>
                                                        <span className="text-indigo-500 font-bold w-6 inline-block">{s.order}.</span> 
                                                        {s.name} 
                                                        <span className="text-xs text-slate-400 ml-1">({s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}/{['í•˜','ì¤‘','ìƒ'][s.skill-1]})</span>
                                                        {s.leader && <span className="ml-1 text-xs text-yellow-500" title="ë¦¬ë”">ğŸ‘‘</span>}
                                                    </span>
                                                    {s.note && <span className="text-xs text-slate-400 ml-7 truncate max-w-[200px]">{s.note}</span>}
                                                </div> 
                                                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"> <Btn onClick={() => startEdit(s)} className="text-slate-300 hover:text-indigo-500 p-1"><Icon d={PATHS.edit} size={16} /></Btn> {deleteTargetId === s.id ?
                                                (<div className="flex gap-1 animate-fade-in"><Btn onClick={(e) => { e.stopPropagation(); deleteStudent(s.id); setDeleteTargetId(null); }} className="bg-rose-500 text-white text-[10px] px-2 py-1 rounded font-bold">ì‚­ì œ</Btn><Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(null); }} className="bg-slate-200 text-slate-600 text-[10px] px-2 py-1 rounded font-bold">ì·¨ì†Œ</Btn></div>) : (<Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(s.id); }} className="text-slate-300 hover:text-rose-500 p-1"><Icon d={PATHS.trash} size={16} /></Btn>)} </div> 
                                            </>
                                        )}
                                    </div>
                                ))}
                                    </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'app' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 border-b-2 border-slate-100 pb-3 mb-5 flex items-center gap-2 cursor-default select-none">
                                    <span className="text-2xl">ğŸ“±</span> ì•± ì„¤ì • {isAdminMode && <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full ml-1">ê´€ë¦¬ì ëª¨ë“œ</span>}
                                    {isDevMode && <span className="text-xs bg-slate-800 text-white px-2 py-0.5 rounded-full ml-1">ê°œë°œì ëª¨ë“œ</span>}
                                </h3>
                                {(!isStandalone && (deferredPrompt || isIOS)) && (
                                    <div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-5 rounded-2xl text-white shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4 animate-fade-in mb-6 relative overflow-hidden group cursor-pointer mx-1" onClick={onInstallApp}>
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-white/20 transition-all"></div>
                                        <div className="flex items-center gap-4 relative z-10">
                                            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                                <span className="text-2xl">ğŸ“²</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-lg">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê³  ë” í¸í•˜ê²Œ!</span>
                                                <span className="text-xs text-indigo-100 font-medium">ì˜¤í”„ë¼ì¸ ì‚¬ìš© â€¢ ì „ì²´ í™”ë©´ â€¢ ë¹ ë¥¸ ì‹¤í–‰</span>
                                            </div>
                                        </div>
                                        <Btn className="bg-white text-indigo-600 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-indigo-50 shadow-md whitespace-nowrap relative z-10 transition-transform active:scale-95">
                                            {isIOS ? "ì„¤ì¹˜ ë°©ë²• ë³´ê¸°" : "í™ˆ í™”ë©´ì— ì¶”ê°€"}
                                        </Btn>
                                    </div>
                                )}

                                    <div className={`grid gap-4 ${isDevMode ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>
                                        {isDevMode && (
                                            <div className="space-y-4">
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ğŸ› ï¸ ê°œë°œì ì„¤ì •</h4>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-xs font-bold text-slate-600">ì•Œë¦¼ ë°©ì‹</span>
                                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'modal' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType !== 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>íŒì—…</button>
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'toast' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType === 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°°ë„ˆ</button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-100">
                                                            <Btn onClick={onTestUpdate} className="py-2 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</Btn>
                                                            <Btn onClick={() => { localStorage.setItem('cls_last_version', 'v0.0.0'); showToast("ë²„ì „ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."); }} className="py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold hover:bg-slate-200">ğŸ”„ ë²„ì „ ì´ˆê¸°í™”</Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ğŸ¨ ì•„ì´ì½˜ ì„¤ì •</h4>
                                                    <div className="grid grid-cols-3 gap-2">
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative">
                                                        <button onClick={(e) => { e.stopPropagation(); setShowFaviconHelp(!showFaviconHelp); }} className="absolute top-1 right-1 text-slate-300 hover:text-indigo-500 transition-colors"><Icon d={PATHS.help} size={12} /></button>
                                                        {showFaviconHelp && (
                                                            <div className="absolute top-6 right-1 w-48 bg-slate-800/95 backdrop-blur text-white text-[10px] p-3 rounded-xl shadow-xl z-20 text-left leading-relaxed animate-fade-in border border-slate-700" onClick={() => setShowFaviconHelp(false)}>
                                                                <p className="font-bold mb-1 text-indigo-300">ğŸ’¡ ì•„ì´ì½˜ ì—…ë¡œë“œ ê°€ì´ë“œ</p>
                                                                <ul className="list-disc pl-3 space-y-1 opacity-90">
                                                                    <li>ì ìš©: ë¸Œë¼ìš°ì € íƒ­, í™ˆ í™”ë©´(PWA)</li>
                                                                    <li>ë¹„ìœ¨: 1:1 ì •ì‚¬ê°í˜• (í•„ìˆ˜)</li>
                                                                    <li>í¬ê¸°: 192px ì´ìƒ ê¶Œì¥</li>
                                                                    <li>ë°°ê²½: íˆ¬ëª…(PNG) ê¶Œì¥</li>
                                                                    <li>ìš©ëŸ‰: ê°€ê¸‰ì  ì‘ê²Œ (ë¡œë”© ì†ë„)</li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                        <div className="flex gap-2 items-end mb-1 mt-1">
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">ë¸Œë¼ìš°ì €</span>
                                                                <div className="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100">
                                                                    {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-lg">ğŸ“</span>}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">iOS í™ˆ</span>
                                                                <div className="relative w-10 h-12 bg-gradient-to-b from-sky-300 to-sky-500 rounded-md flex flex-col items-center justify-center shadow-inner border border-slate-200 overflow-hidden pt-0.5">
                                                                    <div className="w-6 h-6 bg-white rounded-[6px] flex items-center justify-center overflow-hidden shadow-sm mb-0.5">
                                                                        {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-sm">ğŸ“</span>}
                                                                    </div>
                                                                    <span className="text-[4px] text-white font-medium drop-shadow-md truncate max-w-[36px] px-0.5">{appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?"}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={faviconRef} onChange={(e) => { 
                                                                const f = e.target.files[0]; 
                                                                if (f) { 
                                                                    const r = new FileReader(); 
                                                                    r.onload = (ev) => { 
                                                                        const newIcon = ev.target.result; 
                                                                        updateAppConfig({ favicon: newIcon });
                                                                        openConfirm("ì•± ì•„ì´ì½˜ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në³€ê²½ëœ ì•„ì´ì½˜ì„ í™ˆ í™”ë©´ì— ì ìš©í•˜ë ¤ë©´,\nê¸°ì¡´ ì•±ì„ ì‚­ì œí•˜ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n(í™•ì¸ì„ ëˆ„ë¥´ë©´ ì„¤ì¹˜ ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤)", () => onInstallApp()); 
                                                                    }; 
                                                                    r.readAsDataURL(f); 
                                                                } 
                                                            }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => faviconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ë³€ê²½</Btn>
                                                            <Btn onClick={() => openConfirm("ì•± ì•„ì´ì½˜ì„ ê¸°ë³¸ê°’(ğŸ“)ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => updateAppConfig({ favicon: null }))} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-full h-full object-cover" /> : <span className="text-xl">{appConfig.runner}</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={runnerImgRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ runner: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => runnerImgRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ëŸ¬ë„ˆ</Btn>
                                                            <Btn onClick={() => updateAppConfig({ runner: "ğŸƒ" })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-full h-full object-contain" /> : <span className="text-xl">â˜ï¸</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={cloudIconRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ cloudIcon: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => cloudIconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">êµ¬ë¦„</Btn>
                                                            <Btn onClick={() => updateAppConfig({ cloudIcon: null })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="space-y-2">
                                            <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-2"><span className="text-lg">ğŸ“</span> ì•± ê¸°ë³¸ ì„¤ì •</h4>
                                            <div className="grid grid-cols-1 gap-2">
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 flex-shrink-0"><Icon d={PATHS.edit} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ê¸°ë¡ ëª¨ë“œ ì œëª©</label>
                                                <input value={appConfig.recordTitle} onChange={e => updateAppConfig({ recordTitle: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ë‹¤í–ˆë‚˜ìš”!?" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-500 flex-shrink-0"><Icon d={PATHS.check} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ì™„ë£Œ ë©”ì‹œì§€</label>
                                                <input value={appConfig.recordMsg} onChange={e => updateAppConfig({ recordMsg: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ğŸ‰" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 flex-shrink-0"><Icon d={PATHS.users} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">í•™ê¸‰ëª… (íŒŒì¼ ì €ì¥ìš©)</label>
                                                <input value={appConfig.className || ""} onChange={e => updateAppConfig({ className: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ì˜ˆ: 3í•™ë…„ 2ë°˜" />
                                            </div>
                                        </div>
                                    </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full">
                                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-3"><span className="text-lg">ğŸ¨</span> í™”ë©´ ë° ì†Œë¦¬ ì„¤ì •</h4>
                                        <div className="flex flex-col gap-3">
                                            <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors relative">
                                            <div className="flex items-center gap-2 mb-2">
                                                <Icon d={PATHS.document} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">ì•± í°íŠ¸</span>
                                            </div>
                                            <button 
                                                onClick={() => setShowFontList(!showFontList)} 
                                                className={`w-full p-2 border rounded-lg text-xs bg-slate-50 outline-none focus:border-indigo-500 font-bold text-slate-700 flex justify-between items-center ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}
                                            >
                                                <span className="truncate">
                                                {
                                                    appConfig.font === 'sans' ? 'ê¸°ë³¸ ê³ ë”•' :
                                                    appConfig.font === 'nanum' ? 'ë‚˜ëˆ”ê³ ë”•' :
                                                    appConfig.font === 'nanum-bold' ? 'ë‚˜ëˆ”ê³ ë”• (Bold)' :
                                                    appConfig.font === 'serif' ? 'ë‚˜ëˆ”ëª…ì¡°' :
                                                    appConfig.font === 'jua' ? 'ì£¼ì•„ì²´' :
                                                    appConfig.font === 'hand' ? 'ê°œêµ¬ì²´' : 'ê¸°ë³¸ ê³ ë”•'
                                                }
                                                </span>
                                                <Icon d={PATHS.down} size={12} className="text-slate-400 flex-shrink-0" />
                                            </button>
                                            {showFontList && (
                                                <>
                                                    <div className="fixed inset-0 z-[60]" onClick={() => setShowFontList(false)}></div>
                                                    <div className="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl z-[70] overflow-hidden max-h-60 overflow-y-auto custom-scroll">
                                                        {[
                                                            { id: 'sans', label: 'ê¸°ë³¸ ê³ ë”•', cls: 'font-sans' },
                                                            { id: 'nanum', label: 'ë‚˜ëˆ”ê³ ë”•', cls: 'font-nanum' },
                                                            { id: 'nanum-bold', label: 'ë‚˜ëˆ”ê³ ë”• (Bold)', cls: 'font-nanum font-bold' },
                                                            { id: 'serif', label: 'ë‚˜ëˆ”ëª…ì¡°', cls: 'font-serif' },
                                                            { id: 'jua', label: 'ì£¼ì•„ì²´', cls: 'font-jua' },
                                                            { id: 'hand', label: 'ê°œêµ¬ì²´', cls: 'font-hand' },
                                                        ].map(f => (
                                                            <button 
                                                                key={f.id}
                                                                onClick={() => { updateAppConfig({ font: f.id }); setShowFontList(false); }}
                                                                className={`w-full text-left px-3 py-2.5 text-xs hover:bg-indigo-50 transition-colors border-b border-slate-50 last:border-0 ${f.cls} ${appConfig.font === f.id ? 'bg-indigo-50 text-indigo-600' : 'text-slate-700'}`}
                                                            >
                                                                {f.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                            <div className="grid grid-cols-2 gap-2">
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.animationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ animationEnabled: !(appConfig.animationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.play} size={16} className={appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.animationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>í™”ë©´ ì „í™˜</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.animationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.animationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.animationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.tabAnimationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ tabAnimationEnabled: !(appConfig.tabAnimationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.right} size={16} className={appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>íƒ­ íš¨ê³¼</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.tabAnimationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.tabAnimationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.tabAnimationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full">
                                        <div className="bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-indigo-300 transition-colors h-full flex flex-col">
                                        <label className="text-sm font-bold text-slate-700 flex items-center gap-2 mb-3"><span className="text-xl">ğŸ–ï¸</span> ë°©í•™ ê¸°ê°„ ì„¤ì •</label>
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-3 flex-1">
                                            {currentVacations.length > 0 ? (
                                                <div className="space-y-2 max-h-32 overflow-y-auto custom-scroll pr-1">
                                                    {currentVacations.map((v, i) => (
                                                        <div key={i} className="flex items-center justify-between bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm group hover:border-indigo-200 transition-colors">
                                                            <div className="flex items-center gap-2">
                                                                <span className="w-5 h-5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[10px] font-bold">{i+1}</span>
                                                                <span className="font-bold text-slate-600 text-xs">{dayjs(v.start).format('YY.MM.DD')} ~ {dayjs(v.end).format('YY.MM.DD')}</span>
                                                            </div>
                                                            <button onClick={() => removeVacation(i)} className="text-slate-300 hover:text-rose-500 p-1 hover:bg-rose-50 rounded transition-colors"><Icon d={PATHS.trash} size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (<div className="text-center text-slate-400 text-xs py-4 border-2 border-dashed border-slate-200 rounded-lg bg-white/50">ë“±ë¡ëœ ë°©í•™ ê¸°ê°„ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                            
                                            <div className="pt-3 border-t border-slate-200">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-2">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì‹œì‘ì¼</span>
                                                        <input type="date" value={newVacStart} onChange={e => setNewVacStart(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì¢…ë£Œì¼</span>
                                                        <input type="date" value={newVacEnd} onChange={e => setNewVacEnd(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                </div>
                                                <Btn onClick={addVacation} className="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 text-xs shadow-sm flex items-center justify-center gap-1 transition-transform active:scale-95">
                                                    <Icon d={PATHS.plus} size={14} /> ê¸°ê°„ ì¶”ê°€í•˜ê¸°
                                                </Btn>
                                            </div>
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-2 flex items-center gap-1">
                                            <Icon d={PATHS.help} size={10} /> ë°©í•™ ê¸°ê°„ì—ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒì´ ì œí•œë©ë‹ˆë‹¤.
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'data' && (
                                <div className="space-y-4 animate-fade-in">
                                    
                                    {/* [1ë‹¨] ì—°ë™ ë° ìš©ëŸ‰ ë¶„ì„ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full">
                                            <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-3"><span className="text-lg">ğŸ”—</span> ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™</h4>
                                            <div className="grid grid-cols-3 gap-2">
                                                <Btn onClick={onOpenNotionSetup} className={`py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isNotionConnected ? 'ring-2 ring-green-500 ring-offset-1' : ''}`} title="ë…¸ì…˜ ì—°ë™">
                                                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><span className="text-lg">N</span></div>
                                                    <span className="text-xs font-bold text-slate-600">ë…¸ì…˜ ì—°ë™</span>
                                                    {isNotionConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenApiKeySetup} className={`py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isAiConnected ? 'ring-2 ring-green-500 ring-offset-1' : ''}`}>
                                                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><Icon d={PATHS.bot} size={18} className="text-slate-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">AI ì„¤ì •</span>
                                                    {isAiConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenGoogleSheetSetup} className={`py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isGoogleSheetConnected ? 'ring-2 ring-green-500 ring-offset-1' : ''}`} title="êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™">
                                                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><span className="text-lg">ğŸ“Š</span></div>
                                                    <span className="text-xs font-bold text-slate-600">êµ¬ê¸€ ì‹œíŠ¸</span>
                                                    {isGoogleSheetConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                            </div>
                                            {isDevMode && (
                                                <div className="mt-3 pt-3 border-t border-slate-200 animate-fade-in">
                                                    <div className="flex gap-2">
                                                        <Btn onClick={toggleAiSafetyCheck} className={`flex-1 py-2.5 border rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${aiSafetyCheck ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                            <Icon d={aiSafetyCheck ? PATHS.check : PATHS.lock} size={14} />
                                                            AI ì „ì†¡ ë°ì´í„° í™•ì¸ {aiSafetyCheck ? 'ON' : 'OFF'}
                                                        </Btn>
                                                        <Btn onClick={() => setShowAiSafetyHelp(true)} className="px-3 bg-slate-100 text-slate-500 rounded-xl hover:bg-slate-200" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16} /></Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full">
                                            <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-3"><span className="text-lg">ğŸ“Š</span> ë°ì´í„° ìš©ëŸ‰ ìƒì„¸ ë¶„ì„</h4>
                                            <div className="p-4 rounded-xl border transition-colors shadow-sm bg-white border-slate-200">
                                                <div className="flex gap-3">
                                                    <div className={`w-3 h-3 rounded-full shadow-sm mt-1.5 flex-shrink-0 ${isLocalMode ? 'bg-slate-400' : 'bg-green-500 animate-pulse'}`}></div>
                                                    <div className="flex-1 flex flex-col">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-1 cursor-pointer hover:opacity-80" onClick={(e) => { e.stopPropagation(); setShowStorageHelp(!showStorageHelp); }}>
                                                                <span className={`font-bold text-sm ${isLocalMode ? 'text-slate-600' : 'text-green-700'}`}>{isLocalMode ? "ë¡œì»¬ ì €ì¥ì†Œ" : "í´ë¼ìš°ë“œ ë™ê¸°í™”"}</span>
                                                                <Icon d={showStorageHelp ? PATHS.down : PATHS.right} size={24} className="text-slate-400 hover:text-indigo-500 transition-colors" />
                                                            </div>
                                                            {isLocalMode ? <Btn onClick={() => { onClose(); onOpenSetup(); }} className="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-50">ì—°ê²°</Btn> : <Btn onClick={() => { openConfirm("ì—°ê²° í•´ì œ?", () => { localStorage.removeItem('checklist_config'); window.location.reload(); }) }} className="text-xs bg-white border border-rose-200 text-rose-500 px-3 py-1.5 rounded-lg font-bold hover:bg-rose-50">í•´ì œ</Btn>}
                                                        </div>
                                                        <div className="flex items-center gap-1.5 mt-2">
                                                            <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${isLocalMode ? 'bg-slate-200' : 'bg-green-200/50'}`}>
                                                                <div className={`h-full rounded-full transition-all duration-500 ${dataUsage.isCritical ? 'bg-rose-500' : dataUsage.isWarning ? 'bg-orange-500' : (isLocalMode ? 'bg-slate-500' : 'bg-green-500')}`} style={{ width: `${Math.min(dataUsage.percent, 100)}%` }}></div>
                                                            </div>
                                                            <span className={`text-[10px] font-mono ${dataUsage.isCritical ? 'text-rose-600 font-bold' : (isLocalMode ? 'text-slate-500' : 'text-green-600 font-bold')}`}>{dataUsage.percent}% ({dataUsage.kb}KB)</span>
                                                        </div>
                                                        
                                                        {showStorageHelp && (
    <div className="mt-3 p-3 bg-slate-100 rounded-lg border border-slate-200 text-[10px] text-slate-600 leading-relaxed animate-fade-in select-text cursor-auto" onClick={e=>e.stopPropagation()}>
        <div className="flex flex-col gap-3">
            <div>
                <p className="font-bold mb-2 text-indigo-600 flex justify-between items-center"><span>ğŸ“Š ë°ì´í„° ìš©ëŸ‰ ìƒì„¸ ë¶„ì„</span><span className="text-[9px] bg-white px-1.5 py-0.5 rounded border border-indigo-100">ì´ {dataUsage.kb}KB</span></p>
                <div className="space-y-1.5 mb-2">
                    {dataUsage.details.map((d, i) => (
                        <div key={i} className="flex items-center justify-between gap-2">
                            <span className="text-slate-500 w-14 shrink-0 truncate">{d.label}</span>
                            <div className="flex-1 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-indigo-400" style={{ width: `${d.percent}%` }}></div></div>
                            <span className="font-mono w-12 text-right text-slate-700">{d.kb}KB</span>
                        </div>
                    ))}
                </div>
            </div>
            <div className="border-t border-slate-200 pt-3">
                {isLocalMode ? (
                    <div className="text-center py-2">
                        <p className="font-bold mb-1 text-slate-700">ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ ëª¨ë“œ</p>
                        <p className="text-slate-500">í˜„ì¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ë°ì´í„° ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•´ì£¼ì„¸ìš”.</p>
                    </div>
                ) : (
                    <>
                        <p className="font-bold mb-2 text-slate-700 text-[10px] flex items-center justify-center gap-1"><span>ğŸ—ï¸</span> ë°ì´í„° ê´€ë¦¬ êµ¬ì¡°ë„</p>
                        <div className="bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <div className="bg-white border-2 border-orange-200 rounded-lg p-2 mb-2 relative shadow-sm">
                                <div className="absolute -top-2 left-2 bg-orange-100 text-orange-700 text-[9px] px-1.5 rounded font-bold">ë©”ì¸ ë°ì´í„°</div>
                                <div className="flex justify-between items-center mt-1">
                                    <span className="text-slate-600 font-bold">ê¸°ë³¸ ì„¤ì •, í•™ìƒ ëª…ë‹¨</span>
                                    <span className="text-[9px] text-rose-500 font-bold bg-rose-50 px-1 rounded">1MB ì œí•œ âš ï¸</span>
                                </div>
                            </div>
                            <div className="flex justify-center my-1 relative z-10"><Icon d={PATHS.down} size={16} className="text-slate-300 bg-slate-50 rounded-full p-0.5" /></div>
                            <div className="grid grid-cols-4 gap-1 mt-2">
                                <div className="bg-white border-2 border-pink-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-pink-100 text-pink-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê³¼ì œ</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>í• ì¼</div>
                                    <div className="text-[7px] text-pink-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-blue-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ëª¨ë‘ </div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>í¸ì„±</div>
                                    <div className="text-[7px] text-blue-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-purple-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-purple-100 text-purple-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">í™œë™</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>ì²´í¬</div>
                                    <div className="text-[7px] text-purple-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-green-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-green-100 text-green-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê°œë³„</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ìƒë‹´<br/>ìƒê¸°ë¶€</div>
                                    <div className="text-[7px] text-green-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    </div>
)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* [2ë‹¨] ë°±ì—…/ë³µì› ë° ì •ë¦¬/ì´ˆê¸°í™” */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full flex flex-col justify-between">
                                            <div>
                                                <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-3"><span className="text-lg">ğŸ’¾</span> ë°ì´í„° ë°±ì—… ë° ë³µì›</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={handleExportJson} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center"><Icon d={PATHS.upload} size={18} className="text-blue-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë°±ì—…</span>
                                                    </Btn>
                                                    <Btn onClick={()=>jsonFileRef.current.click()} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center"><Icon d={PATHS.download} size={18} className="text-green-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë³µì›</span>
                                                    </Btn>
                                                    <input type="file" ref={jsonFileRef} onChange={handleImportJson} className="hidden" accept=".json" />
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-2 p-3 bg-indigo-50/50 border border-indigo-100 rounded-xl">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2"><span className="text-xs font-bold text-indigo-800">ìë™ ë°±ì—… ì„¤ì •</span><Btn onClick={() => setShowBackupHelp(!showBackupHelp)} className="text-indigo-400 hover:text-indigo-600"><Icon d={PATHS.help} size={16}/></Btn></div>
                                                    <div onClick={toggleAutoBackup} className={`w-10 h-6 flex items-center rounded-full p-1 cursor-pointer transition-colors ${autoBackupEnabled ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${autoBackupEnabled ? 'translate-x-4' : ''}`}></div></div>
                                                </div>
                                                {autoBackupEnabled && (
                                                    <div className="mt-2 pt-2 border-t border-slate-100 animate-fade-in">
                                                        <div className="flex flex-wrap gap-2 mb-2">{backupTimes.map(t => (<div key={t} className="flex items-center bg-white border border-indigo-100 px-2 py-1 rounded-lg text-xs font-bold text-indigo-700 shadow-sm">{t} <button onClick={()=>removeBackupTime(t)} className="ml-2 text-indigo-300 hover:text-rose-500">Ã—</button></div>))}</div>
                                                        {backupTimes.length < 4 && (<div className="flex gap-2 items-center"><div className="flex border border-slate-300 rounded-lg overflow-hidden bg-white"><select value={ampm} onChange={e=>setAmpm(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600"><option value="AM">ì˜¤ì „</option><option value="PM">ì˜¤í›„</option></select><div className="border-l border-slate-200"></div><select value={hour} onChange={e=>setHour(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i + 1).map(h => (<option key={h} value={h}>{h}ì‹œ</option>))}</select><div className="border-l border-slate-200"></div><select value={minute} onChange={e=>setMinute(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i * 5).map(m => (<option key={m} value={String(m).padStart(2, '0')}>{String(m).padStart(2, '0')}ë¶„</option>))}</select></div><button onClick={addBackupTime} className="bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-600 shadow-sm">ì¶”ê°€</button></div>)}
                                                    </div>
                                                )}
                                                {showBackupHelp && <div className="text-[10px] text-slate-500 mt-1 leading-relaxed bg-white p-2 rounded-lg border border-slate-100 animate-fade-in">ì§€ì •ëœ ì‹œê°„ì— ë¸Œë¼ìš°ì €ë¥¼ ì—´ì–´ë‘ë©´ ìë™ìœ¼ë¡œ ë°±ì—… íŒŒì¼(json)ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. (ìµœëŒ€ 4ê°œ ì„¤ì • ê°€ëŠ¥)</div>}
                                            </div>
                                        </div>

                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 h-full flex flex-col justify-between">
                                            <div>
                                                <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2 mb-3"><span className="text-lg">ğŸ§¹</span> ë°ì´í„° ê´€ë¦¬ ë° ì´ˆê¸°í™”</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={() => setShowCleanupModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-rose-50 flex items-center justify-center"><Icon d={PATHS.trash} size={18} className="text-rose-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ì •ë¦¬</span>
                                                    </Btn>
                                                    <Btn onClick={() => setShowManualModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center"><Icon d={PATHS.book} size={18} className="text-orange-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ì‚¬ìš© ì„¤ëª…ì„œ</span>
                                                    </Btn>
                                                </div>
                                            </div>
                                            <Btn onClick={() => setShowResetOptions(true)} className="w-full py-3 bg-white border-2 border-rose-100 text-rose-500 rounded-xl font-bold hover:bg-rose-50 transition-colors text-sm flex items-center justify-center gap-2 shadow-sm"><Icon d={PATHS.trash} size={18} /> ë°ì´í„° ì´ˆê¸°í™”</Btn>
                                        </div>
                                    </div>

                                    {/* [3ë‹¨] ê´€ë¦¬ì ë©”ë‰´ */}
                                    {isAdminMode && (
                                        <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm animate-fade-in mt-2">
                                            <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><span className="text-lg">ğŸ‘‘</span> ê´€ë¦¬ì ë©”ë‰´</h4>
                                            <div className="grid grid-cols-2 gap-3 mb-4">
                                                <Btn onClick={handleDownloadHtml} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.download} size={16} className="text-indigo-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">íŒŒì¼ë¡œ ì €ì¥</span>
                                                </Btn>
                                                <Btn onClick={handleCopyCode} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.code} size={16} className="text-slate-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">ì½”ë“œ ë³µì‚¬</span>
                                                </Btn>
                                            </div>
                                            <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden shadow-inner">
                                                <div className="flex justify-between items-center py-3 px-4 cursor-pointer hover:bg-slate-100 transition-colors select-none" onClick={() => setShowCodeUpdater(!showCodeUpdater)}>
                                                    <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">ğŸ› ï¸ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ</h3>
                                                    <Icon d={showCodeUpdater ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                                </div>
                                                
                                                {showCodeUpdater && (
                                                    <div className="p-4 pt-2 animate-fade-in space-y-3 border-t border-slate-200 bg-white">
                                                        <p className="text-xs text-slate-500 mt-2 font-bold flex items-center gap-1"><Icon d={PATHS.document} size={12}/> ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                                                        <textarea value={updateCodeInput} onChange={(e) => setUpdateCodeInput(e.target.value)} className="w-full h-32 p-3 rounded-xl bg-slate-50 text-slate-700 text-xs font-mono border border-slate-300 focus:border-indigo-500 outline-none custom-scroll shadow-inner" placeholder="<!DOCTYPE html>..."/>
                                                        <div className="grid grid-cols-2 gap-3 mt-2">
                                                            <Btn onClick={handleApplyCode} className="py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-xs transition-colors">ì¦‰ì‹œ ì‹¤í–‰ (ë¯¸ë¦¬ë³´ê¸°)</Btn>
                                                            <Btn onClick={handleSaveCodeFile} className="py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md text-xs transition-colors">íŒŒì¼ë¡œ ì €ì¥ (ê¶Œì¥)</Btn>
                                                        </div>
                                                        <p className="text-[10px] text-orange-500 text-center font-bold bg-orange-50 p-2 rounded-lg mt-2">* ì¦‰ì‹œ ì‹¤í–‰ ì‹œ ë°ì´í„° ì•ˆì „ì„ ìœ„í•´ ê°€ê¸‰ì  ìë™ ë°±ì—… ì„¤ì • í›„ ì§„í–‰í•˜ì„¸ìš”.</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            <DataCleanupModal isOpen={showCleanupModal} onClose={() => setShowCleanupModal(false)} groupsByDate={groupsByDate} records={records} setGroupsByDate={setGroupsByDate} setRecords={setRecords} saveData={saveData} isLocalMode={isLocalMode} showToast={showToast} onBackup={handleExportJson} />
                        </div>
                    </div>
                    <AiSafetyHelpModal isOpen={showAiSafetyHelp} onClose={() => setShowAiSafetyHelp(false)} />
                    <ResetOptionsModal isOpen={showResetOptions} onClose={() => setShowResetOptions(false)} onReset={handleResetAllData} />
                </BaseModal>
            );
        };

        const BalanceVisualizer = ({ groups, students, groupNames, date }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const [detailGroup, setDetailGroup] = useState(null);

            if (!groups || groups.length === 0) return null;
            return (
                <>
                    <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-auto transition-all duration-300">
                        <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsExpanded(!isExpanded)}>
                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.chart} size={18} className="text-indigo-500" /> ëª¨ë‘  ë¶„ì„ ê²°ê³¼ <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">ë”ë¸”í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</span></h4>
                            <Icon d={isExpanded ? PATHS.down : PATHS.right} size={20} className="text-slate-400" />
                        </div>
                        {isExpanded && (
                            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 animate-fade-in">
                                {groups.map((g, i) => {
                                    if (g.length === 0) return null;
                                    const m = g.filter(s => s.gender === 'M'); const f = g.filter(s => s.gender === 'F');
                                    const high = g.filter(s => s.skill === 3); const mid = g.filter(s => s.skill === 2); const low = g.filter(s => s.skill === 1);
                                    const avgSkill = g.reduce((acc, s) => acc + s.skill, 0) / g.length;
                                    const groupName = groupNames[date]?.[i] || `${i + 1}ëª¨ë‘ `;
                                    const leader = g.find(s => s.leader);
                                    return (
                                        <div key={i} onDoubleClick={() => setDetailGroup({ index: i, students: g, name: groupName })} className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer group">
                                            <div className="flex justify-between items-center mb-3"><span className="font-bold text-slate-700 text-base truncate" title={groupName}>{groupName}</span><span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full font-bold">{g.length}ëª…</span></div>
                                            <div className="space-y-4">
                                                <div><div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span className="text-blue-500">ë‚¨ {m.length}</span><span className="text-pink-500">ì—¬ {f.length}</span></div><div className="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden flex"><div style={{ width: `${(m.length/g.length)*100}%` }} className="bg-blue-400 h-full"></div><div style={{ width: `${(f.length/g.length)*100}%` }} className="bg-pink-400 h-full"></div></div></div>
                                                <div><div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span>ì‹¤ë ¥ ë¶„í¬ (í‰ê·  {avgSkill.toFixed(1)})</span></div><div className="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden flex"><div style={{ width: `${(low.length/g.length)*100}%` }} className="bg-slate-300 h-full"></div><div style={{ width: `${(mid.length/g.length)*100}%` }} className="bg-indigo-300 h-full"></div><div style={{ width: `${(high.length/g.length)*100}%` }} className="bg-indigo-500 h-full"></div></div><div className="flex justify-between text-[10px] text-slate-400 mt-1 px-0.5"><span>í•˜ {low.length}</span><span>ì¤‘ {mid.length}</span><span>ìƒ {high.length}</span></div></div>
                                                {leader && <div className="pt-3 border-t border-slate-100 flex items-center gap-1.5 text-xs"><span className="text-yellow-500 text-sm">ğŸ‘‘</span><span className="font-bold text-slate-600">ë¦¬ë”:</span><span className="text-slate-800">{leader.name}</span></div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    {detailGroup && (
                        <BaseModal isOpen={!!detailGroup} onClose={() => setDetailGroup(null)} title={`${detailGroup.name} ìƒì„¸ ì •ë³´`} icon={PATHS.chart}>
                            <div className="space-y-6">
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200"><h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">ğŸ‘« ì„±ë³„ êµ¬ì„±</h4><div className="grid grid-cols-2 gap-4"><div className="bg-white p-3 rounded-xl border border-blue-100"><div className="text-xs font-bold text-blue-500 mb-2">ë‚¨í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='M').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='M').map(s => (<span key={s.id} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='M').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div><div className="bg-white p-3 rounded-xl border border-pink-100"><div className="text-xs font-bold text-pink-500 mb-2">ì—¬í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='F').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='F').map(s => (<span key={s.id} className="text-xs bg-pink-50 text-pink-700 px-2 py-1 rounded border border-pink-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='F').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div></div></div>
                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                                    <div className="flex justify-between items-end mb-4">
                                        <h4 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“Š ì‹¤ë ¥ ë¶„í¬</h4>
                                        <span className="text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">í‰ê·  {(detailGroup.students.reduce((a,b)=>a+b.skill,0) / detailGroup.students.length).toFixed(1)}</span>
                                    </div>
                                    <div className="h-4 w-full bg-white rounded-full overflow-hidden flex mb-4 border border-slate-100 shadow-inner">
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===3).length/detailGroup.students.length)*100}%` }} className="bg-indigo-500 h-full transition-all duration-500" title="ìƒ"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===2).length/detailGroup.students.length)*100}%` }} className="bg-indigo-300 h-full transition-all duration-500" title="ì¤‘"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===1).length/detailGroup.students.length)*100}%` }} className="bg-slate-300 h-full transition-all duration-500" title="í•˜"></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-white p-3 rounded-xl border border-indigo-100 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-600 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ìƒ</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===3).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===3).map(s => <span key={s.id} className="text-[11px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===3).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-indigo-50 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-400 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ì¤‘</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===2).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===2).map(s => <span key={s.id} className="text-[11px] bg-indigo-50/50 text-indigo-600 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===2).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-slate-500 border-b border-slate-100 pb-1 flex justify-between items-center"><span>í•˜</span> <span className="bg-slate-100 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===1).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===1).map(s => <span key={s.id} className="text-[11px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===1).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </BaseModal>
                    )}
                </>
            );
        };

        const ProgressBar = ({ progress, appConfig }) => (
            <div className="w-full max-w-xl mx-auto px-6 mt-1 mb-3">
                <div className="flex justify-between text-xs font-bold text-slate-400 mb-6">
                    <span>Start</span>
                    <span className={progress===100?"text-indigo-600 animate-bounce":"text-slate-600"}>
                        {progress===100?appConfig.recordMsg:`${Math.round(progress)}%`}
                    </span>
                </div>
                <div className="relative h-1.5 bg-slate-200 rounded-full shadow-inner">
                    <div className="absolute left-0 top-0 h-full bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full transition-all duration-700 ease-out" style={{ width: `${progress}%` }}>
                        <div className="absolute -right-4 -top-5 w-8 h-8 bg-white rounded-full shadow-md border border-slate-50 flex items-center justify-center transform transition-transform hover:scale-110 z-10 cursor-pointer">
                            <span className="text-lg filter drop-shadow-sm select-none">
                                {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-5 h-5 object-contain"/> : appConfig.runner}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        );
        
        const RecordView = ({ students, records, dailyTasks, date, toggleCheck, appConfig, stats, onLongPress }) => {
            const getStreakBadge = (studentId) => {
                const s = stats.students.find(st => st.id === studentId);
                if(!s) return null;
                if(s.streak >= 30) return "ğŸŒŸ";
                if(s.streak >= 7) return "ğŸ”¥";
                if(s.streak >= 3) return "ğŸŒ±";
                return null;
            };
            
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);

            const handleTouchStart = (id) => {
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    if (navigator.vibrate) navigator.vibrate(15);
                    onLongPress(id);
                }, 1000);
            };

            const handleTouchEnd = () => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
            };

            return (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const rec = records[date]?.[s.id] || { done: false, tasks: {} };
                        const currentTasks = dailyTasks[date] || [];
                        const isDone = rec.done;
                        const showPhoto = false;

                        return (
                            <div key={s.id} 
                                onMouseDown={() => handleTouchStart(s.id)} 
                                onMouseUp={handleTouchEnd} 
                                onMouseLeave={handleTouchEnd}
                                onTouchStart={() => handleTouchStart(s.id)} 
                                onTouchEnd={handleTouchEnd}
                                onClick={() => { if (!isLongPress.current) toggleCheck(s.id); }}
                                onDoubleClick={(e) => { e.preventDefault(); onLongPress(s.id); }}
                                className={`group relative flex flex-col bg-white rounded-md border transition-all duration-200 cursor-pointer overflow-hidden hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                {showPhoto ? (
                                    <div className="w-full aspect-[4/3] bg-gray-50 relative border-b border-notion-border">
                                        <img src={s.photo} className="w-full h-full object-cover" alt={s.name} />
                                        {isDone && <div className="absolute inset-0 bg-notion-blue/20 flex items-center justify-center backdrop-blur-[1px] transition-all"><div className="bg-notion-blue text-white rounded-full p-1.5 shadow-md"><Icon d={PATHS.check} size={20} /></div></div>}
                                    </div>
                                ) : (
                                    <div className={`h-1 w-full transition-colors duration-200 ${isDone ? 'bg-notion-blue' : 'bg-transparent'}`}></div>
                                )}
                                <div className="p-3 flex flex-col h-full min-h-[100px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex flex-col">
                                            <span className="text-sm font-bold text-notion-text flex items-center gap-1">
                                                {s.name} <span className="text-xs">{getStreakBadge(s.id)}</span>
                                            </span>
                                            <span className="text-[10px] text-notion-text-light">{s.order}ë²ˆ</span>
                                        </div>
                                        <div className={`transition-all duration-200 ${isDone ? 'text-notion-blue opacity-100' : 'text-notion-border opacity-0 group-hover:opacity-100'} ${showPhoto ? 'hidden' : ''}`}>
                                            <Icon d={PATHS.check} size={16} />
                                        </div>
                                    </div>
                                    {currentTasks.length > 0 ? (
                                        <div className="space-y-1 mt-1 flex-1">
                                            {currentTasks.map((t, idx) => {
                                                const taskDone = rec.tasks?.[idx];
                                                return (
                                                    <div key={idx} onClick={(e) => { e.stopPropagation(); toggleCheck(s.id, idx); }} className="flex items-center gap-2 p-1 rounded hover:bg-notion-bg-alt group/task transition-colors">
                                                        <div className={`w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${taskDone ? 'bg-notion-blue border-notion-blue text-white' : 'border-notion-border bg-white group-hover/task:border-notion-text-light'}`}>
                                                            {taskDone && <Icon d={PATHS.check} size={10} />}
                                                        </div>
                                                        <span className={`text-xs truncate flex-1 ${taskDone ? 'text-notion-text-light line-through' : 'text-notion-text'}`}>
                                                            {typeof t === 'object' ? t.title : t}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center">
                                            {isDone ? <span className="text-xs text-notion-blue font-medium bg-blue-50 px-2 py-1 rounded">ì™„ë£Œ</span> : <span className="text-xs text-notion-text-light bg-notion-bg-alt px-2 py-1 rounded">ë¯¸ì™„ë£Œ</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SimpleView = ({ students, simpleChecks, toggleCheck, onLongPress }) => {
            return (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const isDone = simpleChecks[s.id];
                        return (
                            <div key={s.id} onClick={() => toggleCheck(s.id)} onDoubleClick={(e) => { if(onLongPress) { e.preventDefault(); onLongPress(s.id); } }} className={`group relative flex flex-col items-center justify-center p-6 bg-white rounded-md border transition-all duration-200 cursor-pointer hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                <div className={`text-xl font-bold mb-1 ${isDone ? 'text-notion-blue' : 'text-notion-text'}`}>{s.name}</div>
                                <div className="text-xs text-notion-text-light">{s.order}ë²ˆ</div>
                                {isDone && <div className="absolute top-2 right-2 text-notion-blue"><Icon d={PATHS.check} size={16} /></div>}
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        let UPDATE_NOTES = [
            { version: "ë¡œë”© ì¤‘...", date: "", changes: ["ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤."] }
        ];

        const UpdateNotesModal = ({ isOpen, onClose, showToast }) => {
            const [expandedGroups, setExpandedGroups] = useState({ 0: true });
            const [showMajorOnly, setShowMajorOnly] = useState(false);
            const [selectedNote, setSelectedNote] = useState(null);

            const filteredNotes = useMemo(() => {
                return showMajorOnly 
                    ? UPDATE_NOTES.filter(note => {
                        if (note.version.endsWith('.0')) return true;
                        const content = (note.list || note.changes || []).join(' ');
                        return content.includes('ì¶”ê°€') || content.includes('ê¸°ëŠ¥') || content.includes('ê°•í™”') || content.includes('ê°œì„ ');
                    })
                    : UPDATE_NOTES;
            }, [showMajorOnly]);
            
            const groups = useMemo(() => {
                const result = [];
                let lastGroup = null;

                filteredNotes.forEach(item => {
                    const key = item.version.split('.').slice(0, 2).join('.');
                    if (!lastGroup || lastGroup.key !== key) {
                        lastGroup = { key, items: [] };
                        result.push(lastGroup);
                    }
                    lastGroup.items.push(item);
                });
                return result;
            }, [filteredNotes]);
            
            useEffect(() => { if (isOpen) setExpandedGroups({ 0: true }); }, [isOpen]);

            if (!isOpen) return null;
            
            const handleCopyEmail = () => {
                navigator.clipboard.writeText("spk@smca.or.kr");
                if (showToast) showToast("ì´ë©”ì¼ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            };

            const toggleGroup = (index) => {
                setExpandedGroups(prev => ({ ...prev, [index]: !prev[index] }));
            };

            const navigateNote = (direction) => {
                if (!selectedNote) return;
                const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < filteredNotes.length) {
                    setSelectedNote(filteredNotes[newIndex]);
                }
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—…ë°ì´íŠ¸ ë…¸íŠ¸" icon={PATHS.list} footer={
                    <div onClick={handleCopyEmail} className="block w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-center text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 cursor-pointer hover:bg-indigo-100 transition-colors select-none active:scale-95">
                        <div className="flex items-center gap-2"><span>ğŸ’¡</span> ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆí•˜ê¸° <span className="text-indigo-300 hidden sm:inline">|</span></div>
                        <div className="flex items-center gap-1"><span className="underline decoration-indigo-300 underline-offset-4">spk@smca.or.kr</span><span className="text-xs font-normal text-indigo-400 no-underline">(í´ë¦­í•˜ì—¬ ë³µì‚¬)</span></div>
                    </div>
                }>
                    <div className="flex justify-end mb-3 px-1">
                        <label className="flex items-center gap-2 cursor-pointer select-none group">
                            <span className="text-xs font-bold text-slate-500 group-hover:text-indigo-600 transition-colors">ì£¼ìš” ë³€ê²½ ì‚¬í•­ë§Œ ë³´ê¸°</span>
                            <div className={`w-9 h-5 rounded-full p-1 transition-colors duration-300 ${showMajorOnly ? 'bg-indigo-500' : 'bg-slate-200'}`}>
                                <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform duration-300 ${showMajorOnly ? 'translate-x-4' : ''}`}></div>
                            </div>
                            <input type="checkbox" checked={showMajorOnly} onChange={e => setShowMajorOnly(e.target.checked)} className="hidden" />
                        </label>
                    </div>
                    <div className="space-y-3">
                        {groups.length > 0 ? groups.map((group, groupIndex) => {
                            const isExpanded = !!expandedGroups[groupIndex];
                            return (
                                <div key={group.key} className="border border-slate-200 rounded-xl overflow-hidden bg-white">
                                    <div 
                                        className="px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors select-none bg-slate-50/50"
                                        onClick={() => toggleGroup(groupIndex)}
                                    >
                                        <h4 className="font-bold text-slate-700 text-base flex items-center gap-2">
                                            {group.key}.x 
                                            <span className="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100">
                                                {group.items.length}ê°œ ì—…ë°ì´íŠ¸
                                            </span>
                                        </h4>
                                        <Icon d={PATHS.down} size={16} className={`text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                    
                                    {isExpanded && (
                                        <div className="px-4 pb-4 pt-2 space-y-6 border-t border-slate-100">
                                            {group.items.map((update, i) => (
                                                <div key={i} className="relative pl-4 border-l-2 border-slate-200">
                                                    <div className={`absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full ${groupIndex === 0 && i === 0 ? 'bg-indigo-500 ring-4 ring-indigo-100' : 'bg-slate-300'}`}></div>
                                                    <div className="flex justify-between items-baseline mb-2 cursor-pointer group/title" onClick={() => setSelectedNote(update)}>
                                                        <h5 className={`font-bold text-sm flex items-center gap-2 ${groupIndex === 0 && i === 0 ? 'text-indigo-600' : 'text-slate-700'} group-hover/title:text-indigo-500 transition-colors`}>
                                                            {update.version}
                                                            {groupIndex === 0 && i === 0 && <span className="bg-rose-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">NEW</span>}
                                                            <Icon d={PATHS.right} size={12} className="opacity-0 group-hover/title:opacity-100 transition-opacity text-slate-400 -ml-1" />
                                                        </h5>
                                                    </div>
                                                    <ul className="space-y-1">
                                                        {(update.list || update.changes).map((change, j) => (
                                                            <li key={j} className="text-sm text-slate-600 flex items-start gap-2">
                                                                <span className="text-slate-400 mt-1.5 text-[6px]">â—</span>
                                                                <span className="flex-1 leading-relaxed">{change}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : <div className="text-center text-slate-400 py-8 text-sm">í•´ë‹¹í•˜ëŠ” ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                    {selectedNote && (() => {
                        const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                        return (
                            <div className="fixed inset-0 z-[2000] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                                <div className="absolute inset-0 bg-black/30 backdrop-blur-sm animate-fade-in" onClick={() => setSelectedNote(null)}></div>
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative z-10 animate-pop-up border border-slate-200 flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold text-indigo-600">{selectedNote.version}</h3>
                                        </div>
                                        <button onClick={() => setSelectedNote(null)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                                        <div className="space-y-3">
                                            {(selectedNote.list || selectedNote.changes).map((change, i) => (
                                                <div key={i} className="flex gap-3 text-sm text-slate-700 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <span className="text-indigo-500 font-bold mt-0.5">v</span>
                                                    <span>{change}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-slate-100">
                                        <div className="flex justify-between items-center gap-2">
                                            <Btn onClick={() => navigateNote(-1)} disabled={currentIndex === 0} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                <Icon d={PATHS.left} size={16} /> ì´ì „
                                            </Btn>
                                            <Btn onClick={() => setSelectedNote(null)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm">
                                                í™•ì¸
                                            </Btn>
                                            <Btn onClick={() => navigateNote(1)} disabled={currentIndex === filteredNotes.length - 1} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                ë‹¤ìŒ <Icon d={PATHS.right} size={16} />
                                            </Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </BaseModal>
            );
        };

        const SeatChart = ({ students, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, saveData, isLocalMode, showToast, openConfirm, groups, onGroupsChange, groupNumber, groupMethod, roleMap, onOpenStudentInfo }) => {
            const [isLayoutMode, setIsLayoutMode] = useState(false);
            const [selectedSeat, setSelectedSeat] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const seatChartRef = useRef(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const clickRef = useRef({ key: null, count: 0, lastTime: 0 });

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // [í•µì‹¬ ìˆ˜ì • 1] ë“œë˜ê·¸ ì‹œì‘: ë°ì´í„°ë¥¼ window ê°ì²´ì— ì§ì ‘ ì €ì¥ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
            const handleDragStart = (e, studentId, fromSeat) => {
                if (isLayoutMode) { e.preventDefault(); return; }
                
                console.log("Drag Start:", studentId, fromSeat); // ë””ë²„ê¹…ìš©

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ê³¼ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë¨)
                window.__dragData = { studentId, fromSeat };
                
                // ë°ì´í„° ì „ì†¡ ì„¤ì •
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromSeat }));
                
                const target = e.currentTarget;
                // ìŠ¤íƒ€ì¼ ì ìš© (ë¹„ë™ê¸°)
                requestAnimationFrame(() => {
                    target.classList.add("dragging");
                    document.body.classList.add('is-dragging-seat');
                });
            };

            const handleDragEnd = (e) => {
                console.log("Drag End");
                e.currentTarget.classList.remove("dragging");
                document.body.classList.remove('is-dragging-seat');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
                window.__dragData = null; // ì´ˆê¸°í™”
            };

            // [í•µì‹¬ ìˆ˜ì • 2] ë“œë˜ê·¸ ì˜¤ë²„: ë¬´ì¡°ê±´ í—ˆìš© (preventDefault í•„ìˆ˜)
            const handleDragOver = (e) => {
                e.preventDefault(); // ì´ê²Œ ì—†ìœ¼ë©´ Dropì´ ì•ˆë¨
                e.stopPropagation();
                if (!isLayoutMode) {
                    e.dataTransfer.dropEffect = "move";
                    if (!e.currentTarget.classList.contains("drag-over")) {
                        e.currentTarget.classList.add("drag-over");
                    }
                }
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove("drag-over");
            };

            // [í•µì‹¬ ìˆ˜ì • 3] ë“œë¡­ ë¡œì§: ì „ì—­ ë°ì´í„° ìš°ì„  ì‚¬ìš©
            const handleDrop = (e, r, c) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-seat');
                
                if (isLayoutMode) return;

                try {
                    // 1ìˆœìœ„: window ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    let data = window.__dragData;
                    
                    // 2ìˆœìœ„: dataTransferì—ì„œ íŒŒì‹± (ë°±ì—…)
                    if (!data) {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    }

                    console.log("Drop Data Received:", data); // ë””ë²„ê¹…ìš©

                    if (!data || !data.studentId) {
                        console.error("No drag data found");
                        return;
                    }

                    const { studentId, fromSeat } = data;
                    const toSeat = `${r}-${c}`;
                    
                    // ê°™ì€ ìë¦¬ë©´ ë¬´ì‹œ
                    if (fromSeat === toSeat) return;
                    // ë¹„í™œì„± ì¢Œì„ì´ë©´ ë¬´ì‹œ
                    if ((seatConfig.disabledSeats || []).includes(toSeat)) return;

                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[toSeat]; // ë„ì°©ì§€ì— ìˆëŠ” í•™ìƒ

                    // ë¡œì§ A: ê¸°ì¡´ ìë¦¬ì—ì„œ ì œê±° (ëŒ€ê¸°ëª…ë‹¨ì—ì„œ ì™”ìœ¼ë©´ fromSeatëŠ” nullì´ë¼ ë¬´ì‹œë¨)
                    if (fromSeat) delete newAssignments[fromSeat];

                    // ë¡œì§ B: ë„ì°©ì§€ì— í•™ìƒ ë°°ì¹˜
                    newAssignments[toSeat] = studentId;

                    // ë¡œì§ C: êµí™˜ (Swap) - ë„ì°©ì§€ì— í•™ìƒì´ ìˆì—ˆê³ , ì¶œë°œì§€ê°€ ì¢Œì„ì¸ ê²½ìš°
                    if (targetStudentId && fromSeat) {
                        newAssignments[fromSeat] = targetStudentId;
                    }
                    // ë„ì°©ì§€ì— í•™ìƒì´ ìˆì—ˆëŠ”ë° ì¶œë°œì§€ê°€ ëŒ€ê¸°ëª…ë‹¨ì´ë©´? -> ë„ì°©ì§€ í•™ìƒì€ ê·¸ëƒ¥ ë®ì–´ì”Œì›Œì§ (ìë™ìœ¼ë¡œ ëŒ€ê¸°ëª…ë‹¨ìœ¼ë¡œ ê°)

                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    
                } catch (err) {
                    console.error("Drop Error:", err);
                    if(showToast) showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                } finally {
                    window.__dragData = null; // ì •ë¦¬
                }
            };

            // ... (handleSeatClick, handleStudentClick, handleRightClick ë“± ë‚˜ë¨¸ì§€ í•¨ìˆ˜ëŠ” ê¸°ì¡´ ìœ ì§€) ...
            // ì½”ë“œê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ ìœ„ ë“œë˜ê·¸ ë¡œì§ ì´ì™¸ì˜ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.
            // ì•„ë˜ëŠ” ë Œë”ë§ ë¶€ë¶„ì…ë‹ˆë‹¤.

            // (Helper í•¨ìˆ˜ë“¤ ìƒëµ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš© - ìœ„ìª½ ì½”ë“œ ì°¸ê³ í•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”)
            // handleSeatClick, handleStudentClick, handleLoadGroups, handleSaveSeatsToGroups, 
            // handleRightClick, unassignedStudents, handleDownloadImage ë“±...
            
            // í¸ì˜ë¥¼ ìœ„í•´ ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ ë“œë¦¬ëŠ” ëŒ€ì‹ , 
            // ìœ„ì—ì„œ ìˆ˜ì •í•œ handleDragStart, handleDragOver, handleDrop í•¨ìˆ˜ë§Œ 
            // ê¸°ì¡´ SeatChart ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ë®ì–´ì“°ì…”ë„ ë©ë‹ˆë‹¤. 
            // í•˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ í•˜ê¸° ìœ„í•´ SeatChart ë‚´ë¶€ ë Œë”ë§ ë¶€ë¶„(return)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.

            /* ========== [ë Œë”ë§ ë¶€ë¶„ ì²´í¬ í¬ì¸íŠ¸] ========== */
            /* ëŒ€ê¸° ëª…ë‹¨ ë Œë”ë§ ë¶€ë¶„ì—ì„œ 
               draggable="true"
               onDragStart={(e) => handleDragStart(e, s.id, null)} 
               ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤. fromSeat ì¸ìì— 'null'ì„ ë„˜ê¸°ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            */

            const handleSeatClick = (r, c) => {
                const seatKey = `${r}-${c}`;
                if (isLayoutMode) {
                    const disabled = seatConfig.disabledSeats || [];
                    let newDisabled;
                    if (disabled.includes(seatKey)) newDisabled = disabled.filter(k => k !== seatKey);
                    else {
                        if (seatAssignments[seatKey]) {
                            const newAssignments = { ...seatAssignments };
                            delete newAssignments[seatKey];
                            setSeatAssignments(newAssignments);
                            if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        }
                        newDisabled = [...disabled, seatKey];
                    }
                    const newConfig = { ...seatConfig, disabledSeats: newDisabled };
                    setSeatConfig(newConfig);
                    if (!isLocalMode) saveData('cls_seat_config', newConfig);
                    return;
                }

                if ((seatConfig.disabledSeats || []).includes(seatKey)) return;

                // [New] íŠ¸ë¦¬í”Œ í´ë¦­ ê°ì§€ (ëª¨ë°”ì¼ ìš°í´ë¦­ ëŒ€ì²´)
                const now = Date.now();
                if (clickRef.current.key === seatKey && (now - clickRef.current.lastTime < 500)) {
                    clickRef.current.count += 1;
                } else {
                    clickRef.current.key = seatKey;
                    clickRef.current.count = 1;
                }
                clickRef.current.lastTime = now;

                if (clickRef.current.count === 3) {
                    if (seatAssignments[seatKey]) {
                        const newAssignments = { ...seatAssignments };
                        delete newAssignments[seatKey];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        if (selectedSeat === seatKey) setSelectedSeat(null);
                        if(showToast) showToast("ëŒ€ê¸° ëª…ë‹¨ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    clickRef.current.count = 0;
                    return;
                }

                if (selectedStudentId) {
                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[seatKey];
                    
                    const oldSeat = Object.keys(newAssignments).find(k => newAssignments[k] === selectedStudentId);
                    
                    if (oldSeat) delete newAssignments[oldSeat];
                    newAssignments[seatKey] = selectedStudentId;
                    
                    if (targetStudentId && oldSeat) {
                        newAssignments[oldSeat] = targetStudentId;
                    }
                    
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedStudentId(null);
                    setSelectedSeat(null);
                    return;
                }

                if (selectedSeat === seatKey) setSelectedSeat(null);
                else {
                    if (selectedSeat && seatAssignments[selectedSeat]) {
                        const sourceStudentId = seatAssignments[selectedSeat];
                        const targetStudentId = seatAssignments[seatKey];
                        const newAssignments = { ...seatAssignments };
                        newAssignments[seatKey] = sourceStudentId;
                        if (targetStudentId) newAssignments[selectedSeat] = targetStudentId;
                        else delete newAssignments[selectedSeat];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        setSelectedSeat(null);
                    } else setSelectedSeat(seatKey);
                }
            };

            const handleStudentClick = (studentId) => {
                if (selectedSeat) {
                    const newAssignments = { ...seatAssignments };
                    const currentSeat = Object.keys(newAssignments).find(k => newAssignments[k] === studentId);
                    const targetStudentId = newAssignments[selectedSeat];
                    if (currentSeat) {
                        if (targetStudentId) newAssignments[currentSeat] = targetStudentId;
                        else delete newAssignments[currentSeat];
                    }
                    newAssignments[selectedSeat] = studentId;
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedSeat(null);
                    setSelectedStudentId(null);
                } else {
                    const currentSeat = Object.keys(seatAssignments).find(k => seatAssignments[k] === studentId);
                    if (currentSeat) {
                        if (selectedSeat === currentSeat) setSelectedSeat(null);
                        else setSelectedSeat(currentSeat);
                        setSelectedStudentId(null);
                    } else {
                        setSelectedStudentId(prev => prev === studentId ? null : studentId);
                    }
                }
            };

            const handleLoadGroups = () => {
                if (!groups || groups.length === 0) return showToast("í¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                openConfirm("ëª¨ë‘  ê²°ê³¼ë¥¼ ìë¦¬ ë°°ì¹˜ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë°°ì¹˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤)", () => {
                    const newAssignments = {};
                    const flatStudents = groups.flat();
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    showToast("ëª¨ë‘  ê²°ê³¼ê°€ ìë¦¬ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleSaveSeatsToGroups = () => {
                const assignedIds = Object.values(seatAssignments);
                if (assignedIds.length === 0) return showToast("ë°°ì¹˜ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                
                openConfirm("í˜„ì¬ ìë¦¬ ë°°ì¹˜ë¥¼ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ëª¨ë‘ ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)", () => {
                    const sortedAssignments = [];
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if (seatAssignments[key]) sortedAssignments.push(seatAssignments[key]);
                        }
                    }
                    const currentStudents = sortedAssignments.map(id => students.find(s => s.id === id)).filter(s => s).map(s => ({
                        id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order
                    }));
                    const newGroups = [];
                    let chunkSize = groupMethod === 'size' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    for (let i = 0; i < currentStudents.length; i += chunkSize) {
                        newGroups.push(currentStudents.slice(i, i + chunkSize));
                    }
                    onGroupsChange(newGroups);
                    showToast("ìë¦¬ ë°°ì¹˜ê°€ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleRightClick = (e, seatKey) => {
                e.preventDefault();
                e.stopPropagation();
                if (isLayoutMode) return;
                
                if (seatAssignments[seatKey]) {
                    const newAssignments = { ...seatAssignments };
                    delete newAssignments[seatKey];
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    if (selectedSeat === seatKey) setSelectedSeat(null);
                }
            };

            const unassignedStudents = students.filter(s => !Object.values(seatAssignments).includes(s.id));

            const handleDownloadImage = async () => {
                if (!seatChartRef.current) return;
                try {
                    const canvas = await window.html2canvas(seatChartRef.current, {
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        onclone: (doc) => {
                            const waitingList = doc.getElementById('seat-waiting-list');
                            if (waitingList) waitingList.style.display = 'none';
                        }
                    });
                    const link = document.createElement('a');
                    link.download = `ìë¦¬ë°°ì¹˜ë„_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    if(showToast) showToast("ìë¦¬ ë°°ì¹˜ë„ê°€ ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ìë¦¬ ë°°ì¹˜ë„ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm select-none">
                    <div className="flex flex-col mb-4">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><span className="text-xl">ğŸª‘</span> ìë¦¬ ë°°ì¹˜ë„</h3>
                            <div className="flex items-center gap-2">
                                <Btn onClick={handleDownloadImage} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ì¥"><Icon d={PATHS.download} size={18} /></Btn>
                                <Btn onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`p-1.5 rounded-lg transition-colors ${isSettingsOpen ? 'bg-slate-100 text-slate-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                    <Icon d={isSettingsOpen ? PATHS.right : PATHS.left} size={16} />
                                </Btn>
                                <Btn onClick={() => setIsCollapsed(!isCollapsed)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg">
                                    <Icon d={PATHS.down} size={18} className={`transition-transform duration-200 ${!isCollapsed ? 'rotate-180' : ''}`} />
                                </Btn>
                            </div>
                        </div>
                        {isSettingsOpen && !isCollapsed && (
                            <div className="mt-3 pt-3 border-t border-slate-100 flex flex-wrap items-center gap-2 justify-end animate-fade-in">
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.rows - 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">í–‰ {seatConfig.rows}</span><button onClick={() => { const n = Math.min(10, seatConfig.rows + 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.cols - 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">ì—´ {seatConfig.cols}</span><button onClick={() => { const n = Math.min(10, seatConfig.cols + 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <label className={`flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded-lg border transition-colors ${isLayoutMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-500'}`}><input type="checkbox" checked={isLayoutMode} onChange={e => setIsLayoutMode(e.target.checked)} className="hidden" /><span className="text-xs font-bold">êµ¬ì¡° í¸ì§‘</span></label>
                                <div className="flex gap-1"><Btn onClick={handleLoadGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì ìš©</Btn><Btn onClick={handleSaveSeatsToGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì„¤ì •</Btn><Btn onClick={() => openConfirm("ìë¦¬ ë°°ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { setSeatAssignments({}); if(!isLocalMode) saveData('cls_seat_assignments', {}); })} className="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-200">ì´ˆê¸°í™”</Btn></div>
                            </div>
                        )}
                    </div>{!isCollapsed && (<div className="flex flex-col lg:flex-row gap-6" ref={seatChartRef}><div className="flex-1 overflow-auto custom-scroll bg-slate-50/50 rounded-2xl p-4 border border-slate-100 flex flex-col items-center"><div className="w-48 h-6 bg-slate-200 rounded-b-lg mb-6 flex items-center justify-center text-[10px] font-bold text-slate-500 shadow-inner">êµíƒ</div><div className="grid gap-2 md:gap-3 w-full max-w-6xl" style={{ gridTemplateColumns: `repeat(${seatConfig.cols}, minmax(${isMobile ? '60px' : '90px'}, 1fr))` }}>{Array.from({ length: seatConfig.rows }).map((_, r) => Array.from({ length: seatConfig.cols }).map((_, c) => { const seatKey = `${r}-${c}`; const studentId = seatAssignments[seatKey]; 
                    const student = students.find(s => s.id === studentId); 
                    const isDisabled = (seatConfig.disabledSeats || []).includes(seatKey); 
                    const isSelected = selectedSeat === seatKey; 
                    const role = student ? roleMap[student.id] : null; 
                    // [ì¤‘ìš”] onDrop ì´ë²¤íŠ¸ê°€ seat-cell DIVì— ê±¸ë ¤ìˆìŒ
                    return (<div key={seatKey} onClick={() => handleSeatClick(r, c)} onDragOver={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragEnter={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragLeave={!isLayoutMode && !isDisabled ? handleDragLeave : undefined} onDrop={!isLayoutMode && !isDisabled ? (e) => handleDrop(e, r, c) : undefined} className={`seat-cell h-20 md:h-28 rounded-xl border-2 flex flex-col items-center justify-center p-1 transition-all duration-200 ease-in-out relative group ${isLayoutMode ? (isDisabled ? 'bg-slate-100 border-slate-200 cursor-pointer hover:bg-slate-200' : 'bg-white border-indigo-200 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50') : (isDisabled ? 'opacity-0 pointer-events-none' : (student ? (student.gender === 'M' ? 'bg-blue-50/30 border-blue-200' : 'bg-pink-50/30 border-pink-200') : 'bg-white border-slate-200 border-dashed hover:border-indigo-300'))} ${isSelected ? 'ring-4 ring-indigo-400 ring-offset-2 z-10 border-indigo-500' : ''}`}>{!isLayoutMode && student && (<div draggable="true" onDragStart={(e) => handleDragStart(e, student.id, seatKey)} onDragEnd={handleDragEnd} onClick={(e) => { e.stopPropagation(); handleStudentClick(student.id); }} onDoubleClick={(e) => { e.stopPropagation(); onOpenStudentInfo(student.id); }} onContextMenu={(e) => handleRightClick(e, seatKey)} className="w-full h-full flex flex-col items-center justify-center cursor-grab active:cursor-grabbing seat-node animate-bounce-in touch-none"><div className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-lg shadow-sm mb-1 overflow-hidden pointer-events-none">{(student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§')}</div><span className="text-sm font-bold text-slate-700 w-full text-center leading-tight break-keep px-0.5 pointer-events-none">{student.name}</span>{role && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded-full mt-1 font-bold truncate max-w-full pointer-events-none">{role}</span>}</div>)}{isLayoutMode && !isDisabled && <span className="text-indigo-200 text-xs">{r+1}-{c+1}</span>}</div>); }))}</div></div>
                <div id="seat-waiting-list" className="lg:w-72 bg-slate-50 rounded-2xl border border-slate-200 p-4 flex flex-col h-auto min-h-[200px] md:min-h-[400px] flex-shrink-0">
                    <h4 className="font-bold text-slate-600 mb-2 text-xs flex justify-between items-center">
                        <span>ëŒ€ê¸° ëª…ë‹¨</span>
                        <span className="bg-slate-200 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-full">{unassignedStudents.length}</span>
                    </h4>
                    <div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 content-start p-1">
                        {unassignedStudents.map(s => (
                            <div key={s.id} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, null)} onDragEnd={handleDragEnd} onClick={() => handleStudentClick(s.id)} onDoubleClick={() => onOpenStudentInfo(s.id)} className={`student-card bg-white p-1 rounded-lg border-2 shadow-sm flex flex-col items-center justify-center gap-1 aspect-square cursor-grab active:cursor-grabbing transition-all duration-200 touch-none ${selectedStudentId === s.id ? 'border-blue-600 ring-4 ring-blue-100 bg-blue-50 z-10' : 'border-slate-200 hover:border-indigo-300 hover:shadow-md'}`}>
                                <div className="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-lg shadow-sm overflow-hidden pointer-events-none">{(s.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§')}</div>
                                <span className="text-sm font-bold text-slate-700 truncate w-full text-center pointer-events-none">{s.name}</span>
                            </div>
                        ))}
                    </div></div></div>)}
                </div>
            );
        };

        const PartnerAnalysisModal = ({ isOpen, onClose, groupsByDate }) => {
            if (!isOpen) return null;

            const pairCounts = useMemo(() => {
                const counts = {};
                Object.values(groupsByDate).forEach(groups => {
                    if (!Array.isArray(groups)) return;
                    groups.forEach(group => {
                        if (!Array.isArray(group)) return;
                        for (let i = 0; i < group.length; i++) {
                            for (let j = i + 1; j < group.length; j++) {
                                if (!group[i] || !group[j]) continue;
                                const names = [group[i].name, group[j].name].sort();
                                const key = names.join(' & ');
                                counts[key] = (counts[key] || 0) + 1;
                            }
                        }
                    });
                });
                return Object.entries(counts).filter(([_, count]) => count >= 2).sort((a, b) => b[1] - a[1]);
            }, [groupsByDate]);

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„" icon={PATHS.users}>
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-700"><p className="font-bold mb-1">ğŸ“Š ì¤‘ë³µ ì§ê¿ í˜„í™©</p><p>ì§€ê¸ˆê¹Œì§€ ê°™ì€ ëª¨ë‘ ì„ í–ˆë˜ íšŸìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. (2íšŒ ì´ìƒ)</p></div>
                        <div className="max-h-[60vh] overflow-y-auto custom-scroll space-y-2">{pairCounts.length > 0 ? pairCounts.map(([pair, count], i) => (<div key={i} className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-xl"><span className="font-bold text-slate-700 text-sm">{pair}</span><span className={`px-2 py-1 rounded-lg text-xs font-bold ${count >= 4 ? 'bg-rose-100 text-rose-600' : count === 3 ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-600'}`}>{count}íšŒ</span></div>)) : (<div className="text-center text-slate-400 py-8 text-sm">ì¤‘ë³µëœ ì§ê¿ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}</div>
                    </div>
                </BaseModal>
            );
        };

        const SetupModal = ({ isOpen, onClose, showToast, onConnect }) => {
            const [inputConfig, setInputConfig] = useState(""); 
            const [authId, setAuthId] = useState(""); 
            const [authPw, setAuthPw] = useState("");
            const [rememberMe, setRememberMe] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    const sId = localStorage.getItem('cls_fb_id');
                    const sPw = localStorage.getItem('cls_fb_pw');
                    const sCfg = localStorage.getItem('cls_fb_config');
                    if (sId || sPw || sCfg) {
                        setAuthId(sId || "");
                        setAuthPw(sPw || "");
                        setInputConfig(sCfg || "");
                        setRememberMe(true);
                    }
                }
            }, [isOpen]);
            
            const handleConnect = async () => { 
                if(!authId || !authPw) { showToast("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } 
                let config;
                try { 
                    let cleanInput = inputConfig.trim();
                    cleanInput = cleanInput.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm, '');
                    cleanInput = cleanInput.replace(/^(export\s+)?(const|let|var)\s+\w+\s*=\s*/, '');
                    cleanInput = cleanInput.replace(/;+\s*$/, '');
                    try { config = JSON.parse(cleanInput); } catch (e) { config = new Function("return " + cleanInput)(); }
                } catch (e) { showToast("ì„¤ì • ì½”ë“œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

                if (!config || !config.projectId) { showToast("ì˜¬ë°”ë¥¸ ì„¤ì • ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤ (projectId ëˆ„ë½)."); return; }

                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    await firebase.auth().signInWithEmailAndPassword(authId, authPw); 
                    if (rememberMe) { localStorage.setItem('cls_fb_id', authId); localStorage.setItem('cls_fb_pw', authPw); localStorage.setItem('cls_fb_config', inputConfig); } 
                    else { localStorage.removeItem('cls_fb_id'); localStorage.removeItem('cls_fb_pw'); localStorage.removeItem('cls_fb_config'); }
                    onConnect(config); 
                } catch (e) { 
                    let errMsg = "ì—°ê²° ì‹¤íŒ¨: " + e.message;
                    if(e.code && e.code.includes('auth')) errMsg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
                    showToast(errMsg); logSystemEvent(errMsg, 'error');
                } 
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="â›…ï¸ Firebase ì—°ê²° ì„¤ì •" icon={null}><div className="flex flex-col gap-3 mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="text-xs font-bold text-slate-500 mb-1">Firebase ì¸ì¦ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)</div><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ì´ë©”ì¼ (ID)" value={authId} onChange={e => setAuthId(e.target.value)} /><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" value={authPw} onChange={e => setAuthPw(e.target.value)} /></div><textarea className="w-full h-40 p-3 border rounded-xl text-xs font-mono bg-white outline-none custom-scroll" placeholder='ì„¤ì • ì½”ë“œ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: const firebaseConfig = ...)' value={inputConfig} onChange={e => setInputConfig(e.target.value)} /><div className="flex items-center gap-2 mt-2 px-1"><label className="flex items-center gap-2 cursor-pointer select-none group"><div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${rememberMe ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300 group-hover:border-indigo-400'}`}>{rememberMe && <Icon d={PATHS.check} size={14} className="text-white" />}</div><input type="checkbox" className="hidden" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)} /><span className="text-sm font-bold text-slate-600 group-hover:text-indigo-600 transition-colors">ë¡œê·¸ì¸ ì •ë³´ ì €ì¥</span></label></div><div className="flex gap-3 mt-5"><Btn onClick={onClose} className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl">ì·¨ì†Œ</Btn><Btn onClick={handleConnect} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">ì—°ê²°í•˜ê¸°</Btn></div></BaseModal>
            );
        };
        const GlobalRecordModal = ({ isOpen, onClose, students, setStudents, saveData, isLocalMode, showToast, buttonPos, appConfig }) => {
    if (!isOpen) return null;
    const [saveTarget, setSaveTarget] = React.useState(() => localStorage.getItem('cls_portfolio_mode') === 'true' ? 'notion_portfolio' : 'notion_record'); // [New] ì €ì¥ ëŒ€ìƒ ìƒíƒœ
    const [searchText, setSearchText] = React.useState("");
    const [selectedStudents, setSelectedStudents] = React.useState([]);
    const [showStudentDropdown, setShowStudentDropdown] = React.useState(false);
    const [notionDate, setNotionDate] = React.useState(dayjs().format('YYYY-MM-DD'));
    const [notionContent, setNotionContent] = React.useState('');
    const [keepContent, setKeepContent] = React.useState(false);
    const [notionStatus, setNotionStatus] = React.useState('idle');
    const modalRef = React.useRef(null);
    const textareaRef = React.useRef(null);

    React.useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
        }
    }, [notionContent]);

    const handleStudentSelect = (name) => {
        const s = students.find(st => st.name === name);
        if (s && !selectedStudents.find(sel => sel.id === s.id)) setSelectedStudents(prev => [...prev, s]);
    };
    const removeSelectedStudent = (id) => setSelectedStudents(prev => prev.filter(s => s.id !== id));

    const handleIntegratedSave = async (category) => {
        if (selectedStudents.length === 0) return showToast("í•™ìƒì„ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const content = notionContent.trim();
        if (!content) return showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        setNotionStatus('saving');
            const date = notionDate || dayjs().format('YYYY-MM-DD');
            
            // ğŸŒŸ í”Œë¡œíŒ… ë²„íŠ¼ì—ì„œë„ ë˜‘ê°™ì´ ì—¬ëŸ¬ ê°œì˜ ë°°ì§€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            let tags = [];
            if (typeof saveTarget !== 'undefined') {
                if (saveTarget === 'notion_record') tags.push("ë…¸ì…˜(ê¸°ë¡)");
                if (saveTarget === 'notion_portfolio') tags.push("ë…¸ì…˜(í¬í´)");
            }
            if (localStorage.getItem('cls_google_sheet_url')) {
                tags.push("êµ¬ê¸€ ì‹œíŠ¸");
            }

            const newNote = { id: Date.now(), date: date, content: content, destTags: tags };
            const targetIds = selectedStudents.map(s => s.id);
        
        const updatedStudents = students.map(s => {
            if (targetIds.includes(s.id)) {
                const prevNotes = s.counseling || [];
                let updatedStickers = s.stickers || 0;
                if (category === 'ì¹­ì°¬') updatedStickers += 1;
                return { ...s, counseling: [newNote, ...prevNotes], stickers: updatedStickers };
            }
            return s;
        });
        
        setStudents(updatedStudents);
        if (!isLocalMode) saveData('cls_students', updatedStudents);
        if (category === 'ì¹­ì°¬') {
            if (navigator.vibrate) navigator.vibrate(15);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 3000 });
        }

        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ë¶„ê¸°
        if (saveTarget === 'google_sheet') {
            for (const s of selectedStudents) {
                await saveToGoogleSheet(s.name, category, content, date);
            }
            setNotionStatus('success');
            if (!keepContent) { setNotionContent(''); setSelectedStudents([]); }
            setTimeout(() => { setNotionStatus('idle'); if(!keepContent) onClose(); }, 1500);
            showToast("êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            return;
        }

        try {
            const rawKey = localStorage.getItem('cls_notion_key') || "";
            const personalKey = rawKey.replace(/["']/g, '').trim();
            const rawDbId = (saveTarget === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
            const targetDbId = rawDbId.replace(/["']/g, '').trim();
            
            if (!personalKey || !targetDbId) {
                setNotionStatus('success');
                setTimeout(() => { setNotionStatus('idle'); if(!keepContent) onClose(); }, 1500);
                return; 
            }

            const bodyData = { category, content, personalKey, personalDbId: targetDbId };
            if (saveTarget === 'notion_portfolio') {
                const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
                bodyData.mode = 'relation';
                bodyData.studentIds = selectedStudents.map(s => map[s.name]).filter(id => id);
            } else {
                bodyData.mode = 'normal';
                bodyData.studentName = selectedStudents[0].name;
                bodyData.date = date;
            }

            await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData) });
            setNotionStatus('success');
            if (!keepContent) { setNotionContent(''); setSelectedStudents([]); }
            setTimeout(() => { setNotionStatus('idle'); if(!keepContent) onClose(); }, 1500);
        } catch (e) {
            setNotionStatus('error');
            setTimeout(() => setNotionStatus('idle'), 3000);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 z-[2000] p-4 backdrop-blur-sm animate-fade-in flex items-center justify-center" onClick={onClose}>
            <div ref={modalRef} className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col animate-expand-from" onClick={e => e.stopPropagation()}>
                <div className="bg-slate-50 p-5 border-b border-slate-200 flex justify-between items-center">
                    <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon d={PATHS.document} size={18} className="text-indigo-500"/> ë¹ ë¥¸ ê¸°ë¡</h3>
                    <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full text-slate-400"><Icon d={PATHS.x} /></button>
                </div>
                
                {/* [New] ì €ì¥ì†Œ ì„ íƒ íƒ­ UI */}
                <div className="px-5 pt-4">
                    <div className="flex gap-1 bg-slate-100 p-1 rounded-xl border border-slate-200">
                        <button onClick={() => setSaveTarget('notion_record')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'notion_record' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(ê¸°ë¡)</button>
                        <button onClick={() => setSaveTarget('notion_portfolio')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'notion_portfolio' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(í¬í´)</button>
                        <button onClick={() => setSaveTarget('google_sheet')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${saveTarget === 'google_sheet' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>
                    </div>
                </div>

                <div className="p-5 flex flex-col gap-4">
                    <div className="flex flex-wrap gap-1.5 relative">
                        {selectedStudents.map(s => (
                            <span key={s.id} className="text-xs px-2.5 py-1.5 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                {s.name} <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500"><Icon d={PATHS.x} size={10}/></button>
                            </span>
                        ))}
                        <div className="flex-1 min-w-[120px] relative">
                            <input placeholder="ëŒ€ìƒ í•™ìƒ ê²€ìƒ‰ (í´ë¦­)..." className="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-medium outline-none focus:border-indigo-500" value={searchText} onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }} onFocus={() => setShowStudentDropdown(true)} onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)} />
                            {showStudentDropdown && (
                                <div className="absolute top-full left-0 w-full bg-white shadow-xl border border-slate-200 rounded-xl z-50 max-h-40 overflow-y-auto mt-1 custom-scroll">
                                    {students.filter(s => s.name.includes(searchText)).map(s => (
                                        <div key={s.id} className="px-3 py-2 text-xs hover:bg-indigo-50 cursor-pointer font-bold flex justify-between" onMouseDown={() => { handleStudentSelect(s.name); setSearchText(""); }}>
                                            <span>{s.order}ë²ˆ {s.name}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-600 outline-none" />
                    <textarea ref={textareaRef} value={notionContent} onChange={(e) => setNotionContent(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none min-h-[7rem] max-h-[40vh] outline-none overflow-y-auto custom-scroll" placeholder="ê´€ì°° ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows={1} />
                    <div className="flex justify-end -mt-2">
                        <label className="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5" />
                            <span className="text-[10px] text-slate-500 font-bold">ì €ì¥ í›„ ì°½ ìœ ì§€</span>
                        </label>
                    </div>
                    <div className="flex gap-2.5">
                        <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} disabled={notionStatus === 'saving'} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-md">ì¹­ì°¬í•˜ê¸° +1</button>
                        <button onClick={() => handleIntegratedSave('ê´€ì°°')} disabled={notionStatus === 'saving'} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md">ê´€ì°° ê¸°ë¡ ì €ì¥</button>
                    </div>
                    {notionStatus === 'success' && <div className="text-center text-xs text-green-600 font-bold bg-green-50 py-1.5 rounded-lg">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>}
                </div>
            </div>
        </div>
    );
};
// --- [ì—¬ê¸°ê¹Œì§€ ë³µì‚¬] ---
        const App = () => {
            const [forceRender, setForceRender] = useState(0); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ìš© ìŠ¤ìœ„ì¹˜
            const CURRENT_VERSION = UPDATE_NOTES[0].version; // ë¬´ì¡°ê±´ jsonì˜ ì²«ë²ˆì§¸(ìµœì‹ )ë¥¼ ë‚´ ë²„ì „ìœ¼ë¡œ ì¸ì‹!
            const updateDate = UPDATE_NOTES[0].date;

            // [Service Worker Update Logic] 
    const [newVersionAvailable, setNewVersionAvailable] = useState(false); 
    const [waitingWorker, setWaitingWorker] = useState(null);

    const handleCloseUpdate = (type) => {
        let snoozeUntil;
        if (type === 'today') {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            snoozeUntil = tomorrow.getTime();
        } else {
            snoozeUntil = new Date().getTime() + 600000;
        }
        localStorage.setItem('cls_update_snooze', snoozeUntil.toString());
        setNewVersionAvailable(false);
    };

    const handleUpdateApp = async () => {
            // ğŸŒŸ 1. "ë‚˜ ì´ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œí–ˆì–´!"ë¼ê³  í°ì— ì˜êµ¬ ë„ì¥ ì°ê¸° (ë°°ë„ˆ ì•ˆ ëœ¨ê²Œ í•˜ëŠ” í•µì‹¬!)
            const latestVersion = Array.isArray(UPDATE_NOTES) ? UPDATE_NOTES[0].version : UPDATE_NOTES.version;
            localStorage.setItem('cls_last_version', latestVersion);

            // ğŸŒŸ 2. ë¸Œë¼ìš°ì € ìºì‹œ(ì˜›ë‚  ì°Œêº¼ê¸° íŒŒì¼ë“¤) ì™„ë²½í•˜ê²Œ í­íŒŒ
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                } catch (e) { console.error("ìºì‹œ ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ğŸŒŸ 3. ê³ ì§‘ë¶€ë¦¬ëŠ” ì˜›ë‚  ì„œë¹„ìŠ¤ ì›Œì»¤(ì•± ê´€ë¦¬ì) ê°•ì œ í•´ê³ ! (ê°€ì¥ í™•ì‹¤í•œ ì‹¤ì œ ì—…ë°ì´íŠ¸ ë°©ë²•)
            if (navigator.serviceWorker) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister(); 
                    }
                } catch (e) { console.error("SW ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ğŸŒŸ 4. ì°Œêº¼ê¸° í•˜ë‚˜ ì—†ëŠ” ì•„ì£¼ ê¹¨ë—í•œ ì£¼ì†Œë¡œ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?clear=' + new Date().getTime();
        };

    useEffect(() => { 
        const checkUpdateFile = () => {
            fetch(`/update.json?t=${new Date().getTime()}`)
                .then(res => res.json())
                .then(data => {
                    // ë°ì´í„° ì•ˆì „í•˜ê²Œ ë°°ì—´ë¡œ ë§Œë“¤ê¸°
                    let fetchedNotes = Array.isArray(data) ? data : [data];
                    UPDATE_NOTES = fetchedNotes;
                    
                    // í™”ë©´ ë Œë”ë§ ìŠ¤ìœ„ì¹˜ (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì‘ë™í•˜ë„ë¡ ë°©ì–´)
                    if (typeof setForceRender === 'function') setForceRender(prev => prev + 1);
                    if (typeof setIsLoaded === 'function') setIsLoaded(true);

                    // ğŸŒŸ ë¬´í•œ ì•Œë¦¼ ë°©ì§€ì˜ í•µì‹¬!
                    const latestVersion = fetchedNotes[0].version;
                    const lastVersion = localStorage.getItem('cls_last_version');
                    
                    // í•¸ë“œí°ì— ì°íŒ ë„ì¥(lastVersion)ê³¼ jsonì˜ ìµœì‹  ë²„ì „(latestVersion)ì´ ê°™ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ! (ë°°ë„ˆ ì•ˆ ëœ¸)
                    if (lastVersion === latestVersion) return;

                    // ìŠ¤ëˆ„ì¦ˆ(ë‚˜ì¤‘ì— ë³´ê¸°) ê¸°ëŠ¥ í™•ì¸
                    const snoozeTime = localStorage.getItem('cls_update_snooze');
                    const now = new Date().getTime();
                    if (snoozeTime && now < parseInt(snoozeTime, 10)) return;

                    // ë„ì¥ë„ ë‹¤ë¥´ê³ , ìŠ¤ëˆ„ì¦ˆë„ ì•„ë‹ˆë©´ ë¹„ë¡œì†Œ ë°°ë„ˆ ë„ì›€
                    setNewVersionAvailable(true);
                })
                .catch(err => console.log("ì—…ë°ì´íŠ¸ íŒŒì¼ í™•ì¸ ë¶ˆê°€:", err));
        };

        checkUpdateFile();

        if ('serviceWorker' in navigator) { 
            navigator.serviceWorker.register('./sw.js').then(registration => { 
                if (registration.waiting) { 
                    setWaitingWorker(registration.waiting); 
                    setNewVersionAvailable(true); 
                } 
                registration.addEventListener('updatefound', () => { 
                    const newWorker = registration.installing; 
                    newWorker.addEventListener('statechange', () => { 
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) { 
                            setWaitingWorker(newWorker); 
                            setNewVersionAvailable(true); 
                        } 
                    }); 
                }); 
                setInterval(() => {
                    registration.update(); 
                    checkUpdateFile();     
                }, 600000);
            }); 

            let refreshing = false; 
            navigator.serviceWorker.addEventListener('controllerchange', () => { 
                if (!refreshing) { 
                    window.location.reload(); 
                    refreshing = true; 
                } 
            }); 
        } 
    }, []);

            const [mode, setMode] = useState("record");
            const [date, setDate] = useState(getToday());

            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ì‹œì‘ --- */
            const [isPortfolioMode, setIsPortfolioMode] = React.useState(false);
            const [studentMap, setStudentMap] = React.useState({});
            const [portfolioDbId, setPortfolioDbId] = React.useState('');

            // ì´ˆê¸° ì‹¤í–‰ì‹œ ì €ì¥ëœ í¬íŠ¸í´ë¦¬ì˜¤ ID ë¶ˆëŸ¬ì˜¤ê¸°
            React.useEffect(() => {
                const saved = localStorage.getItem('cls_notion_portfolio_db_id');
                if (saved) setPortfolioDbId(saved);
                
                // [Fix] ì•± ì‹œì‘ ì‹œ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ë¡œë“œ
                const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                setIsPortfolioMode(savedMode);
            }, []);

            React.useEffect(() => {
              try {
                const saved = localStorage.getItem('cls_student_map');
                if (saved) setStudentMap(JSON.parse(saved));
              } catch (e) {}
            }, []);
            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ë --- */

            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState({});
            const [simpleChecks, setSimpleChecks] = useState({});
            const [groupsByDate, setGroupsByDate] = useState({});
            const [avoidancePairs, setAvoidancePairs] = useState([]);
            const [dailyTasks, setDailyTasks] = useState({});
            const [weeklyTasks, setWeeklyTasks] = useState({ 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cls_ai_key') || "");
            const [isApiKeyValid, setIsApiKeyValid] = useState(false);
            const [tags, setTags] = useState(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
            const [backupTimes, setBackupTimes] = useState(() => {
                const saved = localStorage.getItem('cls_backup_times');
                return saved ? JSON.parse(saved) : ['12:00', '14:50'];
            });
            const [lockedIds, setLockedIds] = useState([]);
            const [groupNames, setGroupNames] = useState({});
            const [groupRoles, setGroupRoles] = useState({});
            const [rolesList, setRolesList] = useState(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
            const [roleDescriptions, setRoleDescriptions] = useState(DEFAULT_ROLE_DESCRIPTIONS);
            const [seatAssignments, setSeatAssignments] = useState({});
            const [seatConfig, setSeatConfig] = useState({ rows: 5, cols: 5, disabledSeats: ['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4'] });
            const [groupDuration, setGroupDuration] = useState(1);
            const [isDevMode, setIsDevMode] = useState(() => localStorage.getItem('cls_dev_mode') === 'true');
            const [gearClickCount, setGearClickCount] = useState(0);
            const gearClickTimer = useRef(null);
            
            const [p1, setP1] = useState(""); const [p2, setP2] = useState("");
            const [groupMethod, setGroupMethod] = useState('count'); const [groupNumber, setGroupNumber] = useState(4);
            const [useGender, setUseGender] = useState(true); const [useSkill, setUseSkill] = useState(true);
            const [isGenerating, setIsGenerating] = useState(false); const [isAvoidanceVisible, setIsAvoidanceVisible] = useState(false);
            const [useLeader, setUseLeader] = useState(false);
            const [useHistory, setUseHistory] = useState(false); 
            const [mustPairs, setMustPairs] = useState([]); 
            const [pairTab, setPairTab] = useState('avoid'); 
            const [showRoleHelp, setShowRoleHelp] = useState(false);
            const [isGroupToolsOpen, setIsGroupToolsOpen] = useState(window.innerWidth >= 768);
            const [useAI, setUseAI] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("");
            const [aiReason, setAiReason] = useState(null);

            const [honorPeriod, setHonorPeriod] = useState('weekly'); const [helpPeriod, setHelpPeriod] = useState('weekly');
            const [honorTag, setHonorTag] = useState('ì „ì²´'); const [helpTag, setHelpTag] = useState('ì „ì²´'); const [grassStudentId, setGrassStudentId] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isSettingOpen, setIsSettingOpen] = useState(false); const [isSetupOpen, setIsSetupOpen] = useState(false); const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [isRangeCalendarOpen, setIsRangeCalendarOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: "", onConfirm: null }); const [toastMessage, setToastMessage] = useState(null);
            const [isNotionSetupOpen, setIsNotionSetupOpen] = useState(false);
            const [isApiKeySetupOpen, setIsApiKeySetupOpen] = useState(false);
            const [isGoogleSheetSetupOpen, setIsGoogleSheetSetupOpen] = useState(false);
            const [appConfig, setAppConfig] = useState({ recordTitle: "ë‹¤í–ˆë‚˜ìš”!?", recordMsg: "ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ğŸ‰", simpleTitle: "ë‹¨ìˆœ í™•ì¸í‘œ", simpleMsg: "í™•ì¸ ì™„ë£Œ! ğŸ‘Œ", runner: "ğŸƒ", version: CURRENT_VERSION, vacationStart: "", vacationEnd: "", cloudIcon: null, font: 'sans', favicon: null, animationEnabled: true, tabAnimationEnabled: true, updateNotificationType: 'toast' });
            const [isLocalMode, setIsLocalMode] = useState(true); const [db, setDb] = useState(null); const [appId, setAppId] = useState("");
            const [editingGroupIdx, setEditingGroupIdx] = useState(null);
            const lastBackupTime = useRef("");
            const [isLoading, setIsLoading] = useState(true); 
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [showLongLoading, setShowLongLoading] = useState(false);
            const [showOfflineModal, setShowOfflineModal] = useState(false);
            const [autoCloseTimer, setAutoCloseTimer] = useState(3);
            const [showUpdateNotes, setShowUpdateNotes] = useState(false);

            // [New] ë²„ì „ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ ìë™ í‘œì‹œ
            useEffect(() => {
                // [Fix] ì´ˆê¸° ë¡œë”© ìƒíƒœ("ë¡œë”© ì¤‘...")ì¼ ë•ŒëŠ” ë²„ì „ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ë°©ì–´ ì½”ë“œ ì¶”ê°€
                if (CURRENT_VERSION === "ë¡œë”© ì¤‘...") return;

                const lastVersion = localStorage.getItem('cls_last_version');
                if (lastVersion !== CURRENT_VERSION) {
                    //setShowUpdateNotes(true);
                    localStorage.setItem('cls_last_version', CURRENT_VERSION);
                }
            }, [CURRENT_VERSION]);

            const [isRoleEditOpen, setIsRoleEditOpen] = useState(false);
            const [isGroupPanelOpen, setIsGroupPanelOpen] = useState(window.innerWidth >= 768);
            const [formationClickCount, setFormationClickCount] = useState(0);
            const [showQuickApiKey, setShowQuickApiKey] = useState(false);
            const [showAiHelp, setShowAiHelp] = useState(false);
            const formationClickTimer = useRef(null);
            const groupsRef = useRef(null);
            const draggedGroupItemRef = useRef(null);
            const [showWeeklyBriefing, setShowWeeklyBriefing] = useState(false);
            const [showBriefingHelp, setShowBriefingHelp] = useState(false);
            const [aiContent, setAiContent] = useState("");
            const [generationProgress, setGenerationProgress] = useState(0);
            const [briefingStart, setBriefingStart] = useState(dayjs().subtract(4, 'day').format('YYYY-MM-DD'));
            const [briefingEnd, setBriefingEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [briefingTone, setBriefingTone] = useState('encouraging');
            const briefingRef = useRef(null);
            const [showClassStory, setShowClassStory] = useState(false);
            const [showStoryHelp, setShowStoryHelp] = useState(false);
            const [storyGenre, setStoryGenre] = useState('school');
            const [isToolsOpen, setIsToolsOpen] = useState(false);
            const [showAvoidanceLines, setShowAvoidanceLines] = useState(false);
            const [focusedGroupIdx, setFocusedGroupIdx] = useState(null);
            const [showPartnerAnalysis, setShowPartnerAnalysis] = useState(false);
            const [expandedGroupCards, setExpandedGroupCards] = useState({});
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);
            const [isStandalone, setIsStandalone] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [showGlobalRecord, setShowGlobalRecord] = React.useState(false);
            const [aiCheckState, setAiCheckState] = useState({ isOpen: false, prompt: "", resolve: null, reject: null });

            useEffect(() => {
                window.triggerAiSecurityCheck = (prompt) => {
                    return new Promise((resolve, reject) => {
                        setAiCheckState({ isOpen: true, prompt, resolve, reject });
                    });
                };
            }, []);

            const handleAiCheckConfirm = () => {
                if (aiCheckState.resolve) aiCheckState.resolve(true);
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            const handleAiCheckCancel = () => {
                if (aiCheckState.reject) aiCheckState.reject(new Error("ì‚¬ìš©ìì— ì˜í•´ ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            // [New] Floating Button Drag Logic
            const [buttonPos, setButtonPos] = useState({ x: window.innerWidth - 80, y: window.innerHeight - 80 });
            const [isDraggingButton, setIsDraggingButton] = useState(false);
            const dragOffset = useRef({ x: 0, y: 0 });
            const isDragGesture = useRef(false);
            const [isButtonIdle, setIsButtonIdle] = useState(false);
            const buttonIdleTimer = useRef(null);
            const [isHidden, setIsHidden] = useState(false);
            const hideTimer = useRef(null);

            const resetButtonIdleTimer = () => {
                setIsButtonIdle(false);
                if (buttonIdleTimer.current) clearTimeout(buttonIdleTimer.current);
                buttonIdleTimer.current = setTimeout(() => setIsButtonIdle(true), 5000);
            };

            useEffect(() => {
                resetButtonIdleTimer();
                return () => clearTimeout(buttonIdleTimer.current);
            }, []);

            useEffect(() => {
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);

                const screenWidth = window.innerWidth;
                const isLeft = buttonPos.x < 40;
                const isRight = buttonPos.x > screenWidth - 96;

                if (isLeft || isRight) {
                    hideTimer.current = setTimeout(() => {
                        setIsHidden(true);
                    }, 3000);
                }
            }, [buttonPos]);

            const handleButtonDragStart = (e) => {
                resetButtonIdleTimer();
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                dragOffset.current = { x: clientX - buttonPos.x, y: clientY - buttonPos.y };
                isDragGesture.current = false;
                const startX = clientX;
                const startY = clientY;
                
                // [New] Track current position for snap logic
                let currentX = buttonPos.x;
                let currentY = buttonPos.y;

                const handleMove = (moveEvent) => {
                    const moveX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const moveY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    
                    if (!isDragGesture.current) {
                        const dist = Math.hypot(moveX - startX, moveY - startY);
                        if (dist > 5) {
                            isDragGesture.current = true;
                            setIsDraggingButton(true);
                        }
                    }

                    if (isDragGesture.current) {
                        if (moveEvent.cancelable) moveEvent.preventDefault();
                        let newX = moveX - dragOffset.current.x;
                        let newY = moveY - dragOffset.current.y;
                        newX = Math.max(10, Math.min(window.innerWidth - 70, newX));
                        newY = Math.max(10, Math.min(window.innerHeight - 70, newY));
                        currentX = newX;
                        currentY = newY;
                        setButtonPos({ x: newX, y: newY });
                    }
                };

                const handleUp = () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleUp);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', handleUp);
                    setIsDraggingButton(false);
                    
                    if (isDragGesture.current) {
                        // Snap to nearest edge
                        const screenWidth = window.innerWidth;
                        const btnCenter = currentX + 28; // 56/2
                        const snapMargin = 24;
                        let finalX = currentX;
                        
                        if (btnCenter < screenWidth / 2) finalX = snapMargin;
                        else finalX = screenWidth - 56 - snapMargin;
                        
                        setButtonPos({ x: finalX, y: currentY });
                    }
                };

                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleUp);
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleUp);
            };

            // [Fix] onSnapshot ë‚´ë¶€ì—ì„œ ìµœì‹  students ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Ref
            const studentsRef = useRef(students);
            useEffect(() => { studentsRef.current = students; }, [students]);

            useEffect(() => {
                if (isLoading) {
                    const timer = setInterval(() => {
                        setLoadingProgress(prev => {
                            if (prev >= 95) return prev;
                            return prev + Math.random() * 5;
                        });
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [isLoading]);

            useEffect(() => {
                let timer;
                if (isLoading) {
                    timer = setTimeout(() => setShowLongLoading(true), 7000); // 7ì´ˆ í›„ ë²„íŠ¼ í‘œì‹œ
                }
                return () => clearTimeout(timer);
            }, [isLoading]);

            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                
                const userAgent = window.navigator.userAgent.toLowerCase();
                setIsIOS(/iphone|ipad|ipod/.test(userAgent));
                setIsStandalone(window.matchMedia('(display-mode: standalone)').matches);

                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallApp = () => {
                setShowInstallGuide(true);
            };

            const confirmInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') { setDeferredPrompt(null); setShowInstallGuide(false); }
                } else if (!isIOS) {
                    setToastMessage("ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆê±°ë‚˜ ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                }
            };

            const handleGearClick = (e) => {
                e.stopPropagation();
                if (gearClickTimer.current) clearTimeout(gearClickTimer.current);
                const newCount = gearClickCount + 1;
                setGearClickCount(newCount);
                
                if (newCount >= 3) {
                    const newMode = !isDevMode;
                    setIsDevMode(newMode);
                    localStorage.setItem('cls_dev_mode', newMode);
                    setToastMessage(newMode ? "ê°œë°œì ëª¨ë“œ ON: AI ì „ì†¡ ë‚´ìš©ì„ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." : "ê°œë°œì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setGearClickCount(0);
                } else {
                    gearClickTimer.current = setTimeout(() => setGearClickCount(0), 500);
                }
            };

            useEffect(() => {
                const updateIcons = async () => {
                    const defaultSvg = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>";
                    const iconSrc = appConfig.favicon || defaultSvg;
                    
                    // [Fix] ë¸Œë¼ìš°ì € ìºì‹œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ì¬ìƒì„±
                    const existingFavicon = document.getElementById('app-favicon');
                    if (existingFavicon) existingFavicon.remove();
                    const newFavicon = document.createElement('link');
                    newFavicon.id = 'app-favicon';
                    newFavicon.rel = 'icon';
                    newFavicon.href = iconSrc;
                    document.head.appendChild(newFavicon);

                    // [iOS í˜¸í™˜ì„±] ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì„œ PNGë¡œ ë³€í™˜ (í°ìƒ‰ ë°°ê²½ ì¶”ê°€)
                    const getPngDataUrl = (src) => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = 192; canvas.height = 192;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = "#ffffff"; // iOSëŠ” íˆ¬ëª… ë°°ê²½ì„ ê²€ê²Œ ì²˜ë¦¬í•˜ë¯€ë¡œ í°ìƒ‰ ë°°ê²½ í•„ìˆ˜
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0, 192, 192);
                                resolve(canvas.toDataURL('image/png'));
                            };
                            img.onerror = () => resolve(src); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
                            img.src = src;
                        });
                    };

                    let pngIcon = iconSrc;
                    if (iconSrc.startsWith('data:image')) {
                        try { pngIcon = await getPngDataUrl(iconSrc); } catch (e) { console.error(e); }
                    }

                    // [Fix] ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ì¬ìƒì„± (ë¸Œë¼ìš°ì € ì¸ì‹ ê°•ì œ)
            const existingAppleLinks = document.querySelectorAll('link[rel*="apple-touch-icon"]');
                    existingAppleLinks.forEach(el => el.remove());
                    const appleIconLink = document.createElement('link');
                    appleIconLink.rel = 'apple-touch-icon';
                    document.head.appendChild(appleIconLink);
                    appleIconLink.href = pngIcon;

                    const manifest = {
                        name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        short_name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        start_url: "./index.html",
                        display: "standalone",
                        background_color: "#ffffff",
                        theme_color: "#ffffff",
                        icons: [ { src: pngIcon, sizes: "192x192", type: "image/png" }, { src: pngIcon, sizes: "512x512", type: "image/png" } ]
                    };
                    
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    
                    const existingManifest = document.getElementById('app-manifest');
                    if (existingManifest) {
                        URL.revokeObjectURL(existingManifest.href);
                        existingManifest.remove();
                    }
                    const manifestLink = document.createElement('link');
                    manifestLink.id = 'app-manifest';
                    manifestLink.rel = 'manifest';
                    document.head.appendChild(manifestLink);
                    manifestLink.href = manifestURL;
                };
                updateIcons();
            }, [appConfig.favicon, appConfig.recordTitle]);

            // [Fix] ë¹„ë™ê¸° ë¡œì§(setTimeout) ë‚´ì—ì„œ ìµœì‹  ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Refs ì¶”ê°€
            const groupsByDateRef = useRef(groupsByDate);
            const groupRolesRef = useRef(groupRoles);
            useEffect(() => { groupsByDateRef.current = groupsByDate; }, [groupsByDate]);
            useEffect(() => { groupRolesRef.current = groupRoles; }, [groupRoles]);

            // [New] ë°ì´í„° ë³µêµ¬(Hydration) í•¨ìˆ˜: IDë§Œ ìˆëŠ” ëª¨ë‘  ë°ì´í„°ì— í•™ìƒ ìƒì„¸ ì •ë³´ë¥¼ ì±„ì›Œë„£ìŒ
            const hydrateGroups = (groupsData, studentsList) => {
                if (!groupsData) return {};
                const newGroups = { ...groupsData }; // ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬
                Object.keys(groupsData).forEach(date => {
                    if (Array.isArray(groupsData[date])) {
                        newGroups[date] = groupsData[date].map(groupItem => {
                            // [Fix] Firestore Nested Array ì§€ì›: { list: [...] } í˜•íƒœë¼ë©´ ë°°ì—´ë¡œ ë³€í™˜
                            let group = groupItem;
                            if (!Array.isArray(groupItem) && groupItem && groupItem.list && Array.isArray(groupItem.list)) {
                                group = groupItem.list;
                            }
                            
                            if (!Array.isArray(group)) return []; // [Safety] ë°°ì—´ì´ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜í•˜ì—¬ ì•± ë©ˆì¶¤(Crash) ë°©ì§€

                            return group.map(s => {
                                const id = (typeof s === 'object' && s !== null) ? s.id : s;
                                // [Fix] ID íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€ ë° ì´ë¦„ ë§¤ì¹­ Fallback ì¶”ê°€ (ë¬¸ìì—´/ìˆ«ì ë¹„êµ)
                                let fullStudent = studentsList.find(st => String(st.id) === String(id));
                                if (!fullStudent && typeof s === 'object' && s.name) {
                                    fullStudent = studentsList.find(st => st.name === s.name);
                                }
                                // [Fix] í•™ìƒ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°ì²´(s)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©, IDë§Œ ìˆë‹¤ë©´ ê¸°ë³¸ ê°ì²´ ìƒì„±
                                return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                            });
                        });
                    }
                });
                return newGroups;
            };

            // [New] í•™ìƒ ê°œë³„ ë°ì´í„°(ìƒë‹´ê¸°ë¡, ì´ˆì•ˆ) ì €ì¥ í•¨ìˆ˜
            const saveStudentDataToFirestore = async (studentId, data) => {
                if (isLocalMode || !db || !appId) return;
                try {
                    await db.collection('classes').doc(appId).collection('studentData').doc(String(studentId)).set(data, { merge: true });
                } catch (e) {
                    console.error("í•™ìƒ ê°œë³„ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
                    logSystemEvent(`í•™ìƒ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨(${studentId}): ${e.message}`, 'error');
                    setToastMessage("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ì¥ í•¨ìˆ˜ (1MB ì œí•œ íšŒí”¼ìš©)
            const saveGroupsToFirestore = async (groupsMap) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                Object.entries(groupsMap).forEach(([date, groups]) => {
                    const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                    // ë°ì´í„° ì •ì œ (ë¶ˆí•„ìš”í•œ ì •ë³´ ì œê±°)
                    const cleanGroups = groups.map(g => g.map(s => ({
                        id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order
                    })));
                    batch.set(ref, { list: cleanGroups });
                });
                try { await batch.commit(); } 
                catch (e) { console.error(e); setToastMessage("ëª¨ë‘  ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };
            
            // [New] ê³¼ì œ ë°ì´í„°(Daily, Weekly, Tags) ì €ì¥ í•¨ìˆ˜
            const saveTasksToFirestore = async (data) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                
                if (data.dailyTasks) {
                    Object.entries(data.dailyTasks).forEach(([date, tasks]) => {
                        const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                        batch.set(ref, { list: tasks }); // Overwrite list for that date
                    });
                }
                
                if (data.weeklyTasks) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { weekly: data.weeklyTasks }, { merge: true });
                }
                if (data.tags) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { tags: data.tags }, { merge: true });
                }

                try { await batch.commit(); } 
                catch (e) { console.error(e); setToastMessage("ê³¼ì œ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ì¥ í•¨ìˆ˜
            const saveRecordsToFirestore = async (recordsMap) => {
                if (isLocalMode || !db || !appId) return;
                const entries = Object.entries(recordsMap);
                const chunkSize = 450; // Firestore ë°°ì¹˜ ì œí•œ(500) ê³ ë ¤
                try {
                    for (let i = 0; i < entries.length; i += chunkSize) {
                        const batch = db.batch();
                        const chunk = entries.slice(i, i + chunkSize);
                        chunk.forEach(([date, data]) => {
                            const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                            batch.set(ref, data);
                        });
                        await batch.commit();
                    }
                } catch (e) { console.error(e); setToastMessage("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteRecordsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteGroupsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); }
                catch (e) { console.error(e); }
            };
            
            // [New] ê³¼ì œ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
            const deleteTasksFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            const handleRangeSelect = (start, end) => {
                setDate(start);
                const diff = dayjs(end).diff(dayjs(start), 'day') + 1;
                setGroupDuration(diff);
            };

            useEffect(() => {
                // Mobile Drag Drop Polyfill Init
                if (window.MobileDragDrop) {
                    window.MobileDragDrop.polyfill({ dragImageTranslateOverride: window.MobileDragDrop.scrollBehaviourDragImageTranslateOverride });
                }
            }, []);

            useEffect(() => { setAiReason(null); setFocusedGroupIdx(null); }, [date]);

            const handleSaveCounseling = (studentId, note, msg) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage(msg || "ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveStickers = (studentId, count) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
            };

            const validateApiKey = async () => {
                if (!apiKey) return setToastMessage("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if (response.ok) {
                        setIsApiKeyValid(true);
                        setToastMessage(`ìœ íš¨í•œ API í‚¤ì…ë‹ˆë‹¤. (${GEMINI_MODEL_NAME})`);
                        logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì„±ê³µ (${GEMINI_MODEL_NAME})`);
                    } else {
                        setIsApiKeyValid(false);
                        const data = await response.json();
                        setToastMessage("í‚¤ ì˜¤ë¥˜: " + (data.error?.message || "ì•Œ ìˆ˜ ì—†ìŒ"));
                    }
                } catch (e) {
                    setIsApiKeyValid(false);
                    logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì˜¤ë¥˜: " + e.message);
                }
            };

            const callGemini = async (apiKey, prompt) => {
                if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || response.statusText);
                    updateAiUsage();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) {
                    logSystemEvent(`AI ìš”ì²­ ì‹¤íŒ¨: ${e.message}`, 'error');
                    throw new Error("AI ìš”ì²­ ì‹¤íŒ¨: " + e.message);
                }
            };

            const handleDownloadGroupsImage = async () => {
                if (!groupsRef.current) return;
                const originalBtnText = isGenerating; 
                setIsGenerating(true); 
                try {
                    const canvas = await window.html2canvas(groupsRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `ëª¨ë‘ í¸ì„±_${dayjs(date).format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setToastMessage("ëª¨ë‘  í¸ì„± ê²°ê³¼ê°€ ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ëª¨ë‘  í¸ì„± ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                } 
                finally { setIsGenerating(false); }
            };

        const handleCopyAiReport = () => {
            if (!aiReason) return;
            navigator.clipboard.writeText(aiReason);
            setToastMessage("ë¦¬í¬íŠ¸ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        const handleSaveAiReport = () => {
            if (!aiReason) return;
            const blob = new Blob([aiReason], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `AI_ëª¨ë‘ í¸ì„±_ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.txt`;
            link.click();
            setToastMessage("ë¦¬í¬íŠ¸ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

            const handleExportDrafts = () => {
                logSystemEvent('ì´í‰ ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸° ì‹œë„');
                let content = "";
                let count = 0;
                const sortedStudents = [...students].sort((a, b) => a.order - b.order);

                sortedStudents.forEach(s => {
                    if (s.recordDrafts && Object.keys(s.recordDrafts).length > 0) {
                        content += `##################################################\n`;
                        content += `# ${s.order}ë²ˆ ${s.name}\n`;
                        content += `##################################################\n\n`;
                        
                        const drafts = Object.entries(s.recordDrafts).sort((a, b) => a[0].localeCompare(b[0]));
                        
                        drafts.forEach(([key, text]) => {
                            if (!text) return;
                            const [type, semester] = key.split('_');
                            let typeName = type;
                            if (type === 'behavior') typeName = 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬';
                            else if (type === 'subject') typeName = 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©';
                            
                            const semesterName = semester === 'all' ? 'ì „ì²´' : `${semester}í•™ê¸°`;
                            
                            content += `[${typeName} - ${semesterName}]\n`;
                            content += `${text}\n\n`;
                            content += `--------------------------------------------------\n\n`;
                        });
                        content += `\n`;
                        count++;
                    }
                });

                if (count === 0) {
                    setToastMessage("ì €ì¥ëœ í–‰ë°œ ì´ˆì•ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `ì´í‰ì´ˆì•ˆ_ì¼ê´„ë‚´ë³´ë‚´ê¸°_${dayjs().format('YYYYMMDD')}.txt`;
                link.click();
                setToastMessage(`${count}ëª…ì˜ ì´ˆì•ˆì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
            };

            const handleSaveStickerWithNote = (studentId, count, note) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage("ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRecordDraft = (studentId, draftKey, draftText) => {
                const updatedStudents = students.map(s => {
                    if (s.id === studentId) {
                        const newDrafts = { ...(s.recordDrafts || {}), [draftKey]: draftText };
                        return { ...s, recordDrafts: newDrafts };
                    }
                    return s;
                });
                setStudents(updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { recordDrafts: updatedStudents.find(s=>s.id===studentId).recordDrafts });
                setToastMessage("ì´ˆì•ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const exportData = useCallback(() => { const data = { version: appConfig.version, date: dayjs().format('YYYY-MM-DD HH:mm:ss'), students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Checklist_Backup_${dayjs().format('YYYYMMDD_HHmm')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); setToastMessage("ìë™ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig]);
            
            useEffect(() => { const checkTime = () => { const isEnabled = localStorage.getItem('cls_auto_backup') === 'true'; if (!isEnabled) return; const now = dayjs(); const nowStr = now.format('HH:mm'); if (backupTimes.includes(nowStr) && lastBackupTime.current !== nowStr) { lastBackupTime.current = nowStr; exportData(); } }; const interval = setInterval(checkTime, 10000); return () => clearInterval(interval); }, [exportData, backupTimes]);
            
            const handleGrassTitleClick = () => {
                setToastMessage("í™œë™ ì”ë””ì…ë‹ˆë‹¤.");
            };

            // [New] ëª¨ë‘  ë°ì´í„° ì‹¤ì‹œê°„ ë³µêµ¬ (Hydration) ë° ë™ê¸°í™”
            const groups = useMemo(() => {
                const currentGroups = groupsByDate[date] || [];
                if (!Array.isArray(currentGroups)) return [];
                
                return currentGroups.map(group => {
                    if (!Array.isArray(group)) return [];
                    return group.map(s => {
                        if (!s) return null;
                        // í•™ìƒ ëª©ë¡ì—ì„œ ìµœì‹  ì •ë³´ ì°¾ê¸° (ID ê¸°ë°˜ ë§¤í•‘)
                        const id = (typeof s === 'object') ? s.id : s;
                        // [Fix] í™”ë©´ í‘œì‹œ ì‹œì—ë„ ID íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€
                        let fullStudent = students.find(st => String(st.id) === String(id));
                        if (!fullStudent && typeof s === 'object' && s.name) {
                            fullStudent = students.find(st => st.name === s.name);
                        }
                        // ìµœì‹  ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ì •ë³´ ì‚¬ìš©í•˜ë˜ í•„ìˆ˜ í•„ë“œ ê¸°ë³¸ê°’ ë³´ì¥
                        return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                    }).filter(s => s !== null);
                });
            }, [groupsByDate, date, students]);

            const progress = students.length ? (students.filter(s => records[date]?.[s.id]?.done).length / students.length) * 100 : 0;
            const classAvgSkill = useMemo(() => students.length > 0 ? students.reduce((a, s) => a + s.skill, 0) / students.length : 0, [students]);
            const openConfirm = (message, onConfirm) => { setConfirmModal({ isOpen: true, message: message, onConfirm: onConfirm }); };

           useEffect(() => {
                const savedConfig = safeLocalStorage.getItem('checklist_config');
                
                // [New] ìºì‹œ ìš°ì„  ë¡œë”© (Offline-First): ë¡œì»¬ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì„œ ë¡œë”© í™”ë©´ ì¦‰ì‹œ ì œê±°
                const ls = (k) => safeLocalStorage.getItem(k);
                try {
                    if (ls('cls_students')) setStudents(JSON.parse(ls('cls_students')));
                    if (ls('cls_records')) setRecords(JSON.parse(ls('cls_records')));
                    if (ls('cls_groups_date')) setGroupsByDate(JSON.parse(ls('cls_groups_date')));
                    if (ls('cls_avoidance')) setAvoidancePairs(JSON.parse(ls('cls_avoidance')));
                    if (ls('cls_mustPairs')) setMustPairs(JSON.parse(ls('cls_mustPairs')) || []);
                    if (ls('cls_app_config')) setAppConfig({ ...JSON.parse(ls('cls_app_config')), version: CURRENT_VERSION });
                    if (ls('cls_daily_tasks')) setDailyTasks(JSON.parse(ls('cls_daily_tasks')));
                    if (ls('cls_weekly_tasks')) setWeeklyTasks(JSON.parse(ls('cls_weekly_tasks')));
                    if (ls('cls_tags')) setTags(JSON.parse(ls('cls_tags')));
                    if (ls('cls_group_names')) setGroupNames(JSON.parse(ls('cls_group_names')));
                    if (ls('cls_group_roles')) setGroupRoles(JSON.parse(ls('cls_group_roles')));
                    if (ls('cls_roles_list')) setRolesList(JSON.parse(ls('cls_roles_list')));
                    if (ls('cls_role_descriptions')) setRoleDescriptions(JSON.parse(ls('cls_role_descriptions')));
                    if (ls('cls_seat_assignments')) setSeatAssignments(JSON.parse(ls('cls_seat_assignments')));
                    if (ls('cls_seat_config')) setSeatConfig(JSON.parse(ls('cls_seat_config')));
                    if (ls('cls_ai_key')) setApiKey(ls('cls_ai_key'));
                } catch (e) { console.error("Cache load error", e); }
                
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        
                        const firestore = firebase.firestore();
                        setDb(firestore);
                        setAppId(config.projectId);
                        setIsLocalMode(false);

                        logSystemEvent(`Firebase ì—°ê²° ì‹œë„: ${config.projectId}`);
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                logSystemEvent(`Firebase ë¡œê·¸ì¸ ì„±ê³µ: ${user.email}`);
                                firestore.collection('artifacts').doc(config.projectId).collection('public').doc('data').onSnapshot(doc => {
                                    if (doc.exists) {
                                        const d = doc.data();
                                        if (d.students) setStudents(d.students);
                                        if (d.records) setRecords(prev => ({ ...d.records, ...prev })); // [Fix] ë©”ì¸ ë¬¸ì„œ ê¸°ë¡ì€ í•˜ìœ„ í˜¸í™˜ìš©ìœ¼ë¡œ ë¡œë“œí•˜ë˜, ë¡œì»¬/í•˜ìœ„ì»¬ë ‰ì…˜ ë°ì´í„° ìš°ì„ 
                                        if (d.groupsByDate) {
                                            // [Fix] d.studentsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì„ ê²½ìš° ë¡œì»¬ ìµœì‹  ìƒíƒœ(studentsRef)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µêµ¬ ì‹œë„
                                            // ë¡œì»¬ ìƒíƒœì™€ ì„œë²„ ìƒíƒœë¥¼ ë³‘í•©í•˜ì—¬ ìµœëŒ€í•œ ë§ì€ í•™ìƒ ì •ë³´ë¥¼ í™•ë³´
                                            const serverStudents = d.students || [];
                                            const localStudents = studentsRef.current || [];
                                            const mergedStudents = [...localStudents];
                                            serverStudents.forEach(s => {
                                                if (!mergedStudents.find(ls => String(ls.id) === String(s.id))) {
                                                    mergedStudents.push(s);
                                                }
                                            });

                                            // [Fix] ëª¨ë‘  ë°ì´í„° ë™ê¸°í™” ì‹œ ë¡œì»¬ ë°ì´í„° ìœ ì‹¤ ë°©ì§€ (ë°©ê¸ˆ ìƒì„±í•œ ë°ì´í„° ë³´í˜¸)
                                            const serverGroups = d.groupsByDate || {};
                                            const localGroups = groupsByDateRef.current || {};
                                            const mergedGroups = { ...serverGroups };

                                            // ë¡œì»¬ì—ë§Œ ìˆê³  ì„œë²„ì— ì—†ëŠ”(ë¹„ì–´ìˆëŠ”) ë‚ ì§œì˜ ë°ì´í„°ëŠ” ë¡œì»¬ ë°ì´í„° ìœ ì§€ (ë°©ê¸ˆ í¸ì„±í•œ ê²½ìš°)
                                            Object.keys(localGroups).forEach(date => {
                                                if (localGroups[date] && localGroups[date].length > 0) {
                                                    // ì„œë²„ ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜ ë¹ˆ ë°°ì—´ì¸ ê²½ìš° ë¡œì»¬ ë°ì´í„° ì‚¬ìš©
                                                    if (!serverGroups[date] || serverGroups[date].length === 0) {
                                                        mergedGroups[date] = localGroups[date];
                                                    }
                                                }
                                            });

                                            const hydrated = hydrateGroups(mergedGroups, mergedStudents);
                                            setGroupsByDate(hydrated);
                                        }
                                        if (d.avoidance) setAvoidancePairs(d.avoidance);
                                        if (d.mustPairs) setMustPairs(d.mustPairs);
                    if (d.config) setAppConfig({ ...d.config, version: CURRENT_VERSION });
                                        if (d.dailyTasks) setDailyTasks(d.dailyTasks);
                                        if (d.weeklyTasks) setWeeklyTasks(d.weeklyTasks);
                                        if (d.tags) setTags(d.tags);
                                        if (d.groupNames) setGroupNames(d.groupNames);
                                        if (d.groupRoles) setGroupRoles(d.groupRoles);
                                        if (d.rolesList) setRolesList(d.rolesList);

                                        // [New] AI Key ë° Notion ì„¤ì • ìë™ ë™ê¸°í™”
                                        if (d.aiKey) {
                                            setApiKey(d.aiKey);
                                            localStorage.setItem('cls_ai_key', d.aiKey);
                                        }
                                        if (d.notionKey) localStorage.setItem('cls_notion_key', d.notionKey);
                                        if (d.notionDbId) localStorage.setItem('cls_notion_db_id', d.notionDbId);
                                        // [Fix] snake_case í‚¤ ì§€ì› ë° í¬íŠ¸í´ë¦¬ì˜¤ ID ë¡œë”©
                                        if (d.notion_key) localStorage.setItem('cls_notion_key', d.notion_key);
                                        if (d.notion_db_id) localStorage.setItem('cls_notion_db_id', d.notion_db_id);
                                        if (d.notion_portfolio_db_id) { localStorage.setItem('cls_notion_portfolio_db_id', d.notion_portfolio_db_id); setPortfolioDbId(d.notion_portfolio_db_id); }
                                        if (d.portfolio_mode !== undefined) { 
                                            setIsPortfolioMode(d.portfolio_mode); 
                                            localStorage.setItem('cls_portfolio_mode', d.portfolio_mode); 
                                        }
                                        
                                        // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                                        setIsLoading(false);
                                        if (!localStorage.getItem('cls_intro_shown')) {
                                            setShowOfflineModal(true);
                                            setAutoCloseTimer(3);
                                            localStorage.setItem('cls_intro_shown', 'true');
                                        }
                                    } else {
                                        // [Fix] ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš°ì—ë„ ë¡œë”© í•´ì œ (ë¬´í•œ ë¡œë”© ë°©ì§€)
                                        setIsLoading(false);
                                    }
                                }, (error) => {
                                    logSystemEvent(`Firestore ìŠ¤ëƒ…ìƒ· ì—ëŸ¬: ${error.message}`, 'error');
                                    setIsLoading(false); // [Fix] ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© í•´ì œ
                                    setToastMessage("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: " + error.message);
                                });

                                // [New] ëª¨ë‘  ê²°ê³¼ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('groupResults').onSnapshot(snapshot => {
                                    const newGroups = {};
                                    snapshot.docs.forEach(doc => {
                                        newGroups[doc.id] = doc.data().list;
                                    });
                                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì„œë²„ ë°ì´í„° ìš°ì„ )
                                    setGroupsByDate(prev => hydrateGroups({ ...prev, ...newGroups }, studentsRef.current));
                                });

                                // [New] í™œë™ ê¸°ë¡ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('records').onSnapshot(snapshot => {
                                    setRecords(prev => {
                                        const next = { ...prev };
                                        snapshot.docChanges().forEach(change => {
                                            if (change.type === 'added' || change.type === 'modified') next[change.doc.id] = change.doc.data();
                                            if (change.type === 'removed') delete next[change.doc.id];
                                        });
                                        return next;
                                    });
                                });
                                
                                // [New] ê³¼ì œ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
                                firestore.collection('classes').doc(config.projectId).collection('tasks').onSnapshot(snapshot => {
                                    snapshot.docChanges().forEach(change => {
                                        if (change.doc.id === 'settings') {
                                            const data = change.doc.data();
                                            if (data.weekly) setWeeklyTasks(data.weekly);
                                            if (data.tags) setTags(data.tags);
                                        } else {
                                            if (change.type === 'removed') {
                                                setDailyTasks(prev => {
                                                    const next = { ...prev };
                                                    delete next[change.doc.id];
                                                    return next;
                                                });
                                            } else {
                                                setDailyTasks(prev => ({ ...prev, [change.doc.id]: change.doc.data().list }));
                                            }
                                        }
                                    });
                                });
                            } else {
                                logSystemEvent('Firebase ë¡œê·¸ì¸ ìƒíƒœ ì•„ë‹˜', 'warning');
                                setIsLoading(false);
                            }
                        });
                    } catch (e) { logSystemEvent(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${e.message}`, 'error'); setIsLocalMode(true); setIsLoading(false); }
                } else {
                    // ë¡œì»¬ ëª¨ë“œ (ìœ„ì—ì„œ ì´ë¯¸ ë¡œë“œí•¨)
                    
                    // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                    setIsLoading(false);
                    if (!localStorage.getItem('cls_intro_shown')) {
                        setShowOfflineModal(true);
                        setAutoCloseTimer(3);
                        localStorage.setItem('cls_intro_shown', 'true');
                    }
                }
            }, []);

            useEffect(() => {
                let timer;
                if (showOfflineModal && autoCloseTimer > 0) {
                    timer = setTimeout(() => setAutoCloseTimer(p => p - 1), 1000);
                } else if (showOfflineModal && autoCloseTimer === 0) {
                    setShowOfflineModal(false);
                }
                return () => clearTimeout(timer);
            }, [showOfflineModal, autoCloseTimer]);
            
            useEffect(() => { if (mode === 'record') { const dayOfWeek = dayjs(date).day(); if ((!dailyTasks[date] || dailyTasks[date].length === 0) && weeklyTasks[dayOfWeek]?.length > 0) { const tasksToAdd = weeklyTasks[dayOfWeek].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t); const newDailyTasks = { ...dailyTasks, [date]: tasksToAdd }; setDailyTasks(newDailyTasks); if (isLocalMode) saveData('cls_daily_tasks', newDailyTasks); } } }, [date, mode, weeklyTasks]);
            
            // [Fix] saveData í•¨ìˆ˜ ê°œì„ : ë‹¨ì¼ í‚¤/ê°’ ì €ì¥ë¿ë§Œ ì•„ë‹ˆë¼ ê°ì²´ í˜•íƒœì˜ ì¼ê´„ ì €ì¥(Batch) ì§€ì›
            const saveData = async (keyOrData, value) => {
                const updates = (typeof keyOrData === 'object') ? keyOrData : { [keyOrData]: value };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì—¬ë„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í•­ìƒ ìºì‹œ(ë°±ì—…) ì €ì¥ (ë¹ ë¥¸ ë¡œë”© ë° ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
                Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));

                if (isLocalMode) {
                    Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));
                    return;
                }
                
                if (db && appId) {
                    try {
                        const payload = {};
                        const batch = db.batch(); // ë°°ì¹˜ ì“°ê¸° ì‚¬ìš©
                        
                        for (const [k, v] of Object.entries(updates)) {
                            if (k === 'cls_groups_date') continue; // [New] ëª¨ë‘  ë°ì´í„°ëŠ” ë©”ì¸ ë¬¸ì„œì—ì„œ ì œì™¸ (1MB ì œí•œ íšŒí”¼)
                            if (k === 'cls_records') { saveRecordsToFirestore(v); continue; } // [New] ê¸°ë¡ ë°ì´í„°ëŠ” í•˜ìœ„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë¶„ë¦¬
                            if (k === 'cls_daily_tasks') { saveTasksToFirestore({ dailyTasks: v }); continue; } // [New] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬
                            if (k === 'cls_weekly_tasks') { saveTasksToFirestore({ weeklyTasks: v }); continue; }
                            if (k === 'cls_tags') { saveTasksToFirestore({ tags: v }); continue; }
                            const field = k.replace('cls_', '').replace('app_', '').replace('_date', 'ByDate');
                            const cleanData = JSON.parse(JSON.stringify(v));
                            
                            // [Fix] Firestore Nested Array ì˜¤ë¥˜ í•´ê²°: ëª¨ë‘  ë°ì´í„° ì €ì¥ ì‹œ ë‚´ë¶€ ë°°ì—´ì„ ê°ì²´ë¡œ ë˜í•‘
                            if (k === 'cls_groups_date') {
                                const wrappedData = {};
                                Object.keys(cleanData).forEach(d => {
                                    if (Array.isArray(cleanData[d])) {
                                        // [[s1, s2], [s3]] -> [{list: [s1, s2]}, {list: [s3]}]
                                        wrappedData[d] = cleanData[d].map(g => (Array.isArray(g) ? { list: g } : g));
                                    } else {
                                        wrappedData[d] = cleanData[d];
                                    }
                                });
                                payload[field] = wrappedData;
                            } else if (k === 'cls_students') {
                                // [New] í•™ìƒ ë°ì´í„° ì €ì¥ ì‹œ ìƒë‹´ê¸°ë¡/ì´ˆì•ˆ ë¶„ë¦¬ ì €ì¥ (ìš©ëŸ‰ ìµœì í™”)
                                const lightStudents = cleanData.map(s => {
                                    // ìƒë‹´ ê¸°ë¡ê³¼ ì´ˆì•ˆì´ ìˆë‹¤ë©´ ê°œë³„ ë¬¸ì„œë¡œ ì €ì¥
                                    if ((s.counseling && s.counseling.length > 0) || (s.recordDrafts && Object.keys(s.recordDrafts).length > 0)) {
                                        const studentRef = db.collection('classes').doc(appId).collection('studentData').doc(String(s.id));
                                        const studentData = {};
                                        if (s.counseling) studentData.counseling = s.counseling;
                                        if (s.recordDrafts) studentData.recordDrafts = s.recordDrafts;
                                        batch.set(studentRef, studentData, { merge: true });
                                    }
                                    // ë©”ì¸ ë¬¸ì„œì—ëŠ” ë¬´ê±°ìš´ ë°ì´í„° ì œì™¸
                                    const { counseling, recordDrafts, ...rest } = s;
                                    return rest;
                                });
                                payload[field] = lightStudents;
                            } else {
                                payload[field] = cleanData;
                            }
                        }
                        // ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ í•œ ë²ˆì— ì €ì¥ (Atomic Update)
                        const mainRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                        batch.set(mainRef, payload, { merge: true });
                        await batch.commit();
                    } catch (e) {
                        logSystemEvent(`Firebase ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                        console.error(e);
                        setToastMessage(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                    }
                }
            };
            
            const useDeepEffect = (fn, deps) => { const isFirst = useRef(true);
            useEffect(() => { if (isFirst.current) { isFirst.current = false; return; } fn(); }, deps); };
            
            useDeepEffect(() => { if (isLocalMode) saveData('cls_groups_date', groupsByDate); }, [groupsByDate]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_students', students); }, [students]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_records', records); }, [records]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_avoidance', avoidancePairs); }, [avoidancePairs]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_mustPairs', mustPairs); }, [mustPairs]); 
            useDeepEffect(() => { if (isLocalMode) saveData('cls_app_config', appConfig); }, [appConfig]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_daily_tasks', dailyTasks); }, [dailyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_weekly_tasks', weeklyTasks); }, [weeklyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_names', groupNames); }, [groupNames]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_roles', groupRoles); }, [groupRoles]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_roles_list', rolesList); }, [rolesList]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_role_descriptions', roleDescriptions); }, [roleDescriptions]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_assignments', seatAssignments); }, [seatAssignments]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_config', seatConfig); }, [seatConfig]);

            const toggleCheck = (id, taskIndex = null) => { 
                if (navigator.vibrate) navigator.vibrate(15);

                if (mode === 'simple') { const newDone = !simpleChecks[id];
            setSimpleChecks({ ...simpleChecks, [id]: newDone }); if (newDone) confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#6366f1', '#8b5cf6'] });
            return; } const currentRec = records[date]?.[id] || { done: false, tasks: {} }; const currentTasks = dailyTasks[date] || [];
            let newRec; if (taskIndex !== null) { const newTasksStatus = { ...currentRec.tasks, [taskIndex]: !currentRec.tasks?.[taskIndex] };
            const allDone = currentTasks.length > 0 && currentTasks.every((_, idx) => newTasksStatus[idx]); newRec = { ...currentRec, tasks: newTasksStatus, done: allDone };
            } else { const newDone = !currentRec.done; const newTasksStatus = {};
            if (currentTasks.length > 0) currentTasks.forEach((_, idx) => newTasksStatus[idx] = newDone); newRec = { ...currentRec, done: newDone, tasks: newTasksStatus };
            } const newRecords = { ...records, [date]: { ...records[date], [id]: newRec } }; setRecords(newRecords); if (!isLocalMode) saveRecordsToFirestore({ [date]: newRecords[date] });
            if (newRec.done) confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } }); };
            
            const resetDateRecord = () => { openConfirm(`${date} ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => { const newRecords = { ...records }; delete newRecords[date]; setRecords(newRecords); if (!isLocalMode) deleteRecordsFromFirestore([date]); setToastMessage("ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); });
            };
            
            const toggleLock = (studentId) => { setLockedIds(prev => prev.includes(studentId) ? prev.filter(id => id !== studentId) : [...prev, studentId]); };
            
            const applyPreset = (type) => {
                if (type === 'coop') { 
                    setUseGender(true);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'peer') { 
                    setUseGender(false);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                } else if (type === 'project') { 
                    setUseGender(true);
                    setUseSkill(false); setUseLeader(true); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'random') { 
                    setUseGender(false);
                    setUseSkill(false); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                }
                setToastMessage(`'${type === 'coop' ? 'í˜‘ë™ í•™ìŠµ' : type === 'peer' ? 'ë˜ë˜ êµìˆ˜' : type === 'project' ? 'í”„ë¡œì íŠ¸' : 'ëœë¤'}' í”„ë¦¬ì…‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            // [New] ì—­í•  ê³„ì‚° í—¬í¼ í•¨ìˆ˜
            const calculateRoles = (groupsToAssign) => {
                const activeRoles = rolesList.length > 0 ? rolesList : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                const rolesForDate = {};
                groupsToAssign.forEach((group, gIdx) => {
                    rolesForDate[gIdx] = {};
                    for (let sIdx = 0; sIdx < group.length; sIdx++) {
                        const myRoles = [];
                        activeRoles.forEach((r, rIdx) => { 
                            if (rIdx % group.length === sIdx) myRoles.push(r); 
                        });
                        rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                    }
                });
                return rolesForDate;
            };

            // [New] ëª¨ë‘  ë³€ê²½ ì‹œ ì—­í•  ì—…ë°ì´íŠ¸ í—¬í¼
            const updateRolesIfActive = (newGroups) => {
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                }
            };

            // [New] ëª¨ë‘  ê²°ê³¼ë¥¼ ìë¦¬ ë°°ì¹˜ì— ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
            const syncSeatsWithGroups = (groupsToSync) => {
                try {
                    const newAssignments = {};
                    if (!groupsToSync || !Array.isArray(groupsToSync)) return;
                    const flatStudents = groupsToSync.flat().filter(s => s && s.id);
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                } catch (e) {
                    console.error("Sync seats error:", e);
                    setToastMessage("ìë¦¬ ë°°ì¹˜ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜: " + e.message);
                }
            };

            const sanitizeStudent = (s) => {
                if (!s) return null;
                return { id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order };
            };
            
            const generateGroups = async () => {
                if (students.length === 0) return setToastMessage("í•™ìƒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");

                if (useAI) {
                    if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    setIsGenerating(true);
                    try {
                        const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(students.length / groupNumber);
                        
                        // [ë³´ì•ˆ] í•™ìƒ ëª…ë‹¨ ìµëª…í™” (í•™ìƒ1, í•™ìƒ2...)
                        const anonymizedMap = {};
                        const studentListStr = students.map((s, i) => {
                            const anonName = `í•™ìƒ${i+1}`;
                            anonymizedMap[anonName] = s;
                            const info = [`${s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}`, `ì‹¤ë ¥${['í•˜','ì¤‘','ìƒ'][s.skill-1]}`];
                            if (s.leader) info.push('ë¦¬ë”');
                            return `${anonName}(${info.join(', ')})`;
                        }).join(', ');

                        const constraints = [];
                        if (avoidancePairs.length > 0) {
                            const avoidStr = avoidancePairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (avoidStr) constraints.push(`- ê¸°í”¼ ê´€ê³„(ê°™ì€ ëª¨ë‘  ê¸ˆì§€): ${avoidStr}`);
                        }
                        if (mustPairs.length > 0) {
                            const mustStr = mustPairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (mustStr) constraints.push(`- í•„ìˆ˜ ì§ê¿(ê°™ì€ ëª¨ë‘  í•„ìˆ˜): ${mustStr}`);
                        }
                        
                        // [New] useHistory ì˜µì…˜ ì ìš©
                        if (useHistory) {
                            const recentDates = Object.keys(groupsByDate).sort().reverse().slice(0, 3);
                            if (recentDates.length > 0) {
                                const historyStr = recentDates.map(d => {
                                    const grps = groupsByDate[d] || [];
                                    return `- ${d}: ${grps.map(g => `[${g.map(s => {
                                        const idx = students.findIndex(st => st.id === s.id);
                                        return idx >= 0 ? `í•™ìƒ${idx+1}` : "ë¯¸í™•ì¸";
                                    }).join(',')}]`).join(', ')}`;
                                }).join('\n');
                                constraints.push(`- ì´ì „ ëª¨ë‘  êµ¬ì„±ê³¼ ìµœëŒ€í•œ ê²¹ì¹˜ì§€ ì•Šê²Œ í¸ì„±í•´ì£¼ì„¸ìš” (ìµœê·¼ ê¸°ë¡ ì°¸ê³ ):\n${historyStr}`);
                            }
                        }
                        
                        const userRequest = aiPrompt || "ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”ë¥¼ ê³¨ê³ ë£¨ ì„ì–´ì„œ ê· í˜• ìˆê²Œ í¸ì„±í•´ì¤˜.";

                        const prompt = `
                            ë‹¹ì‹ ì€ í•™ê¸‰ ê²½ì˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒë“¤ì„ ${targetGroupCount}ê°œì˜ ëª¨ë‘ ìœ¼ë¡œ í¸ì„±í•´ì£¼ì„¸ìš”.
                            
                            [í•™ìƒ ëª…ë‹¨]
                            ${studentListStr}

                            [ì œì•½ ì¡°ê±´]
                            - ëª¨ë“  í•™ìƒì€ ì •í™•íˆ í•œ ê°œì˜ ëª¨ë‘ ì—ë§Œ ì†í•´ì•¼ í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°°ì • ê¸ˆì§€)
                            ${constraints.join('\n')}
                            
                            [ì‚¬ìš©ì ìš”ì²­]
                            "${userRequest}"

                            [ì‘ë‹µ í˜•ì‹]
                            - ê²°ê³¼ëŠ” ë°˜ë“œì‹œ **JSON ê°ì²´**ë¡œ ì‘ì„±í•˜ì„¸ìš”.
                            - í˜•ì‹: { "groups": [["ì´ë¦„1", "ì´ë¦„2"], ...], "reason": "í¸ì„± ì´ìœ  ë° ì „ëµ ì„¤ëª… (2~3ë¬¸ì¥)" }
                            - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json)ì´ë‚˜ ë¶€ê°€ì ì¸ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
                        `;

                        const text = await callGemini(apiKey, prompt);
                        const jsonStr = text.replace(/```json|```/g, "").trim();
                        let result;
                        try {
                            result = JSON.parse(jsonStr);
                        } catch (e) {
                            // í˜¹ì‹œ ë°°ì—´ë¡œë§Œ ì™”ì„ ê²½ìš°ì— ëŒ€í•œ ë°©ì–´ ì½”ë“œ
                            if (Array.isArray(JSON.parse(jsonStr))) {
                                result = { groups: JSON.parse(jsonStr), reason: "AIê°€ ìµœì ì˜ ì¡°í•©ìœ¼ë¡œ í¸ì„±í–ˆìŠµë‹ˆë‹¤." };
                            } else {
                                throw e;
                            }
                        }
                        
                        const aiGroups = result.groups;
                        setAiReason(result.reason);

                        const mappedGroups = aiGroups.map(g => g.map(n => { 
                            const clean = n.split('(')[0].trim();
                            const s = anonymizedMap[clean];
                            return s ? sanitizeStudent(s) : { id: Math.random(), name: "ë¯¸í™•ì¸", gender: 'M', skill: 1, order: 0 };
                        }));

                        logSystemEvent('AI ëª¨ë‘  í¸ì„± ì„±ê³µ');
                        
                        const newGroupsData = { ...groupsByDate }; // [Fix] ë°ì´í„° ì‚­ì œ ë¡œì§ ì œê±°
                        const newGroupRoles = { ...groupRoles };
                        const hasActiveRoles = groupRoles[date] && Object.keys(groupRoles[date]).length > 0;
                        const groupsToSave = {};
                        
                        for(let i=0; i<groupDuration; i++) {
                            const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                            newGroupsData[d] = mappedGroups;
                            groupsToSave[d] = mappedGroups;
                            if (hasActiveRoles) newGroupRoles[d] = calculateRoles(mappedGroups);
                        }
                        
                        setGroupsByDate(newGroupsData);
                        if (!isLocalMode) saveGroupsToFirestore(groupsToSave);
                        
                        if (hasActiveRoles) {
                            setGroupRoles(newGroupRoles);
                            if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                        }

                        syncSeatsWithGroups(mappedGroups);
                        setToastMessage(`AI ëª¨ë‘  í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)`);
                        if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                    } catch (e) {
                        logSystemEvent(`AI ëª¨ë‘  í¸ì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                        setToastMessage("AI í¸ì„± ì‹¤íŒ¨: " + e.message);
                    } finally {
                        setIsGenerating(false);
                    }
                    return;
                }

                // [Fix] setTimeout ì œê±°: ìë¦¬ ë°°ì¹˜ë„ ë²„íŠ¼ì²˜ëŸ¼ ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ì•ˆì •ì„± í™•ë³´
                  try {
                    // ìµœì‹  ìƒíƒœ ì°¸ì¡° (Ref ì‚¬ìš© ë¶ˆí•„ìš”, ë™ê¸° ì‹¤í–‰ì´ë¯€ë¡œ í˜„ì¬ state ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€)
                    const currentGroupsByDate = groupsByDate;
                    const currentGroupRoles = groupRoles;
                    const currentStudents = students;

                    const currentGroups = currentGroupsByDate[date] || [];
                    const lockedMap = new Map();
                    const lockedStudentIds = new Set(lockedIds);
                    
                    if (currentGroups.length > 0) {
                        currentGroups.forEach((group, gIdx) => {
                            group.forEach(s => { if (lockedStudentIds.has(s.id)) lockedMap.set(s.id, gIdx); });
                        });
                    } else {
                        // í˜„ì¬ ë‚ ì§œì— ëª¨ë‘ ì´ ì—†ìœ¼ë©´ ê³¼ê±° ê¸°ë¡ì—ì„œ ê³ ì • í•™ìƒì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ìœ ì§€ (ê³ ì • í•™ìƒ ê¸°ëŠ¥ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse();
                        for (const d of sortedDates) {
                            const grps = currentGroupsByDate[d];
                            if (grps) {
                                grps.forEach((group, gIdx) => {
                                    group.forEach(s => { if (lockedStudentIds.has(s.id) && !lockedMap.has(s.id)) lockedMap.set(s.id, gIdx); });
                                });
                            }
                        }
                    }

                    const unlockedStudents = currentStudents.filter(s => !lockedStudentIds.has(s.id));
                    const lockedStudents = currentStudents.filter(s => lockedStudentIds.has(s.id));
                    const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    
                    const historyPairs = new Map();
                    if (useHistory) {
                        // ìµœê·¼ ê¸°ë¡ì¼ìˆ˜ë¡ ê°€ì¤‘ì¹˜ë¥¼ ë†’ê²Œ ë¶€ì—¬ (ì—°ì† ë°°ì • ë°©ì§€ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse().slice(0, 10);
                        sortedDates.forEach((d, idx) => {
                            const weight = Math.max(1, 5 - Math.floor(idx / 2)); // 5, 5, 4, 4, 3, 3...
                            (currentGroupsByDate[d] || []).forEach(g => {
                                for(let i=0; i<g.length; i++) {
                                    for(let j=i+1; j<g.length; j++) {
                                        const k = [g[i].id, g[j].id].sort().join('-');
                                        historyPairs.set(k, (historyPairs.get(k) || 0) + weight);
                                    }
                                }
                            });
                        });
                    }

                    const clusters = [];
                    const visited = new Set();
                    const adj = {};
                    mustPairs.forEach(p => {
                        const n1 = currentStudents.find(s=>s.name === p.p1)?.id;
                        const n2 = currentStudents.find(s=>s.name === p.p2)?.id;
                        if(n1 && n2) {
                            if(!adj[n1]) adj[n1] = []; if(!adj[n2]) adj[n2] = [];
                            adj[n1].push(n2); adj[n2].push(n1);
                        }
                    });

                    unlockedStudents.forEach(s => {
                        if(visited.has(s.id)) return;
                        const cluster = [];
                        const q = [s.id];
                        visited.add(s.id);
                        while(q.length > 0) {
                            const curr = q.pop();
                            const studentObj = currentStudents.find(st => st.id === curr);
                            if(studentObj) cluster.push(studentObj);
                            (adj[curr] || []).forEach(neighbor => {
                                if(!visited.has(neighbor) && !lockedStudentIds.has(neighbor)) {
                                    visited.add(neighbor);
                                    q.push(neighbor);
                                }
                            });
                        }
                        clusters.push(cluster);
                    });
                    let bestGroups = null;
                    let maxScore = -Infinity;

                    for(let iter=0; iter < 300; iter++) {
                        let groups = Array.from({ length: targetGroupCount }, () => []);
                        let nextLockedGroupIdx = 0;
                        lockedStudents.forEach(s => {
                            let gIdx = lockedMap.get(s.id);
                            // ê³ ì • ìœ„ì¹˜ê°€ ì—†ê±°ë‚˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìˆœì°¨ ë°°ì • (í•œ ê³³ì— ëª°ë¦¬ëŠ” ê²ƒ ë°©ì§€)
                            if (gIdx === undefined || gIdx >= targetGroupCount) {
                                gIdx = nextLockedGroupIdx % targetGroupCount;
                                nextLockedGroupIdx++;
                            }
                            groups[gIdx].push(s);
                        });
                        const shuffledClusters = [...clusters].sort(() => Math.random() - 0.5);

                        if (useLeader) {
                            const leaderClusters = shuffledClusters.filter(c => c.some(s => s.leader));
                            const normalClusters = shuffledClusters.filter(c => !c.some(s => s.leader));
                            
                            leaderClusters.forEach(cluster => {
                                let minLeaders = Infinity, targetIdx = 0;
                                groups.forEach((g, i) => {
                                    const lCount = g.filter(s => s.leader).length;
                                    if(lCount < minLeaders) { minLeaders = lCount; targetIdx = i; }
                                });
                                groups[targetIdx].push(...cluster);
                            });
                            normalClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        } else {
                            shuffledClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        }

                        let score = 0;
                        let valid = true;
                        
                        if (useSkill) {
                            const groupAverages = groups.map(g => g.length > 0 ? g.reduce((a, b) => a + b.skill, 0) / g.length : 0);
                            const validAverages = groupAverages.filter(avg => avg > 0);
                            if (validAverages.length > 1) {
                                const totalAverage = validAverages.reduce((a, b) => a + b, 0) / validAverages.length;
                                const variance = validAverages.reduce((a, b) => a + Math.pow(b - totalAverage, 2), 0) / validAverages.length;
                                score -= variance * 500; // Higher penalty for variance to enforce balance
                            }
                        }

                        groups.forEach(g => {
                            if (useGender) {
                                const m = g.filter(s => s.gender === 'M').length;
                                const f = g.length - m;
                                score -= Math.abs(m - f) * 10;
                            }
                            for(let i=0; i<g.length; i++) {
                                for(let j=i+1; j<g.length; j++) {
                                    const n1 = g[i].name, n2 = g[j].name;
                                    if(avoidancePairs.some(p => (p.p1===n1 && p.p2===n2) || (p.p1===n2 && p.p2===n1))) {
                                        score -= 10000; valid = false;
                                    }
                                    if(useHistory) {
                                        const key = [g[i].id, g[j].id].sort().join('-');
                                        const histScore = historyPairs.get(key) || 0;
                                        score -= histScore * 30; // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê¸°ë°˜ í˜ë„í‹°
                                    }
                                }
                            }
                        });
                        if (valid && score > maxScore) {
                            maxScore = score;
                            bestGroups = JSON.parse(JSON.stringify(groups)); 
                        }
                    }

                    const rawGroups = bestGroups || Array.from({ length: targetGroupCount }, () => []);
                    const finalGroups = rawGroups.map(g => g.map(s => sanitizeStudent(s)).filter(s => s !== null));

                    if(finalGroups.flat().length === 0) {
                         const plainGroups = Array.from({ length: targetGroupCount }, () => []);
                         currentStudents.forEach((s, i) => plainGroups[i % targetGroupCount].push(sanitizeStudent(s)));
                         
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const groupsToSave = {};
                         for(let i=0; i<groupDuration; i++) {
                             const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                             // [Fix] ì°¸ì¡° ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ê¹Šì€ ë³µì‚¬í•˜ì—¬ í• ë‹¹
                             newGroupsData[d] = plainGroups.map(g => g.map(s => ({...s}))); 
                             groupsToSave[d] = newGroupsData[d];
                         }
                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0) {
                             const newRolesForDate = calculateRoles(plainGroups);
                             const newGroupRoles = { ...currentGroupRoles, [date]: newRolesForDate };
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }
                         
                         syncSeatsWithGroups(plainGroups);
                    } else {
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const newGroupRoles = { ...currentGroupRoles };
                         const hasActiveRoles = currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0;
                         const groupsToSave = {};

                         for(let i=0; i<groupDuration; i++) {
                             const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                             newGroupsData[d] = finalGroups.map(g => g.map(s => ({...s})));
                             groupsToSave[d] = newGroupsData[d];
                             if (hasActiveRoles) newGroupRoles[d] = calculateRoles(finalGroups);
                         }

                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (hasActiveRoles) {
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }

                         syncSeatsWithGroups(finalGroups);
                    }
                    setToastMessage(`ëª¨ë‘  í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)` + (useHistory ? " (ìµœê·¼ ê¸°ë¡ ë°˜ì˜ë¨)" : ""));
                  } catch (e) {
                    logSystemEvent(`ëª¨ë‘  í¸ì„± ì˜¤ë¥˜: ${e.message}`, 'error');
                    setToastMessage("í¸ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                  } finally {
                    if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                  }
            };

            const rotateCurrentGroups = () => { 
                if (!groups || groups.length < 2) return setToastMessage("íšŒì „í•  ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const rotateArray = (arr) => {
                    if (arr.length < 2) return arr;
                    const last = arr[arr.length - 1];
                    const rest = arr.slice(0, arr.length - 1);
                    return [last, ...rest];
                };

                const newGroups = groups.map((_, i) => { const srcIdx = (i - 1 + groups.length) % groups.length; return rotateArray(groups[srcIdx]).map(s => sanitizeStudent(s)); });
                const newGroupsData = { ...groupsByDate, [date]: newGroups }; setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
                
                syncSeatsWithGroups(newGroups);
                setToastMessage("ìì „ê³¼ ê³µì „(íšŒì „)ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            };
            
            const handleDragStart = (e, studentId, fromGroupIdx) => { 
                draggedGroupItemRef.current = { studentId, fromGroupIdx };
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromGroupIdx }));
                e.dataTransfer.effectAllowed = "move";
                const target = e.currentTarget;
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        target.classList.add("dragging");
                        document.body.classList.add('is-dragging-group');
                    }, 0);
                });
            };
            const handleDragEnd = (e) => { 
                e.currentTarget.classList.remove("dragging"); 
                document.body.classList.remove('is-dragging-group');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over")); 
                draggedGroupItemRef.current = null;
            };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; e.currentTarget.classList.add("drag-over"); };
            const handleDragLeave = (e) => { 
                if (e.currentTarget.contains(e.relatedTarget)) return;
                e.currentTarget.classList.remove("drag-over"); 
            };
            
            const handleDrop = (e, toGroupIdx) => { 
                e.preventDefault(); 
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-group');
                
                let data = draggedGroupItemRef.current;
                if (!data) {
                    try {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    } catch (err) { console.error("Drop failed", err); }
                }

                if (!data || !data.studentId) return;
                const { studentId, fromGroupIdx } = data;

                if (fromGroupIdx === toGroupIdx) return;
                
                const currentGroups = [...(groupsByDate[date] || [])]; 
                const student = currentGroups[fromGroupIdx].find(s => s.id === studentId); 
                if (!student) return;
                currentGroups[fromGroupIdx] = currentGroups[fromGroupIdx].filter(s => s.id !== studentId); 
                currentGroups[toGroupIdx] = [...currentGroups[toGroupIdx], sanitizeStudent(student)]; 
                const newGroupsData = { ...groupsByDate, [date]: currentGroups }; 
                setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(currentGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: currentGroups });
                }
            };

            const handleAssignRoles = () => {
                const currentGroups = groupsByDate[date] || [];
                if (currentGroups.length === 0) return setToastMessage("í¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const newRolesForDate = calculateRoles(currentGroups);
                const newRoles = { ...groupRoles, [date]: newRolesForDate };
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ëª¨ë‘  ì—­í• ì´ ìë¦¬ì— ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleClearRoles = () => {
                const newRoles = { ...groupRoles };
                delete newRoles[date];
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ì—­í•  ë°°ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRoles = (newRoles) => {
                setRolesList(newRoles);
                if (!isLocalMode) saveData('cls_roles_list', newRoles);
                setToastMessage("ì—­í•  ëª©ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setIsRoleEditOpen(false);
                
                // í˜„ì¬ ì—­í•  ë°°ì • ì¤‘ì´ë¼ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const currentGroups = groupsByDate[date] || [];
                    if (currentGroups.length > 0) {
                        // ì„ì‹œë¡œ rolesList ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì§ì ‘ ì „ë‹¬
                        const activeRoles = newRoles.length > 0 ? newRoles : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        const rolesForDate = {};
                        currentGroups.forEach((group, gIdx) => {
                            rolesForDate[gIdx] = {};
                            for (let sIdx = 0; sIdx < group.length; sIdx++) {
                                const myRoles = [];
                                activeRoles.forEach((r, rIdx) => { 
                                    if (rIdx % group.length === sIdx) myRoles.push(r); 
                                });
                                rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                            }
                        });
                        const newGroupRoles = { ...groupRoles, [date]: rolesForDate };
                        setGroupRoles(newGroupRoles);
                        if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                    }
                }
            };

            const handleSaveRoleDescriptions = (newDesc) => {
                setRoleDescriptions(newDesc);
                if (!isLocalMode) saveData('cls_role_descriptions', newDesc);
            };

            const handleGroupsChange = (newGroups) => {
                // ë°ì´í„° í¬ê¸° ìµœì í™”ë¥¼ ìœ„í•´ ì‚¬ì§„ ë“± ë¶ˆí•„ìš”í•œ ì •ë³´ ì œê±°
                const newGroupsData = { ...groupsByDate, [date]: newGroups };
                setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
            };

            const roleMap = useMemo(() => {
                const map = {};
                const currentGroups = groupsByDate[date] || [];
                const currentRoles = groupRoles[date] || {};
                currentGroups.forEach((g, gIdx) => {
                    g.forEach((s, sIdx) => {
                        const role = currentRoles[gIdx]?.[sIdx] || currentRoles[gIdx]?.[s.id];
                        if (role) map[s.id] = role;
                    });
                });
                return map;
            }, [groupsByDate, groupRoles, date]);

            const stats = useMemo(() => { const dates = Object.keys(records).sort(); const isWithinPeriod = (dStr, period) => { const d = dayjs(dStr); const now = dayjs(); if (period === 'weekly') return d.isAfter(now.subtract(7, 'day')) && d.isBefore(now.add(1, 'day')); if (period === 'monthly') return d.isAfter(now.subtract(30, 'day')) && d.isBefore(now.add(1, 'day')); return true; }; const calcStatsForStudent = (s, period, tag) => { let doneCount = 0; let totalCount = 0; for(let i=34; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); if (!isWithinPeriod(d, period)) continue; const dayRecord = records[d]; const dayTasks = dailyTasks[d] || []; if (tag === 'ì „ì²´') { if (dayRecord) 
            { const tasksForDay = dailyTasks[d] || []; if (tasksForDay.length > 0) { totalCount += tasksForDay.length; const sRec = dayRecord[s.id]; if (sRec) { tasksForDay.forEach((_, idx) => { if (sRec.tasks && sRec.tasks[idx]) doneCount++; else if (!sRec.tasks && sRec.done) doneCount++; }); } } else { totalCount++;
            if (dayRecord[s.id]?.done) doneCount++; } } } else { const tagTasks = dayTasks.filter(t => (typeof t === 'object' ? t.tag : 'ê¸°íƒ€') === tag);
            if (tagTasks.length > 0) { totalCount += tagTasks.length; tagTasks.forEach((t, idx) => { const originalIdx = dayTasks.indexOf(t); const isTaskDone = dayRecord?.[s.id]?.done || dayRecord?.[s.id]?.tasks?.[originalIdx]; if(isTaskDone) doneCount++; });
            } } } return { count: doneCount, total: totalCount, rate: totalCount > 0 ?
            (doneCount / totalCount) * 100 : 0 }; }; const computedStudents = students.map(s => { let count = 0, currentStreak = 0; const history = []; const datesSorted = Object.keys(records).sort(); for(let i=29; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const dayIdx = dayjs(d).day(); if(dayIdx===0 || dayIdx===6) continue; let dailyDoneCount = 0; let dailyTotalCount = 0; const dayTasks = dailyTasks[d] || []; const dayRecord = records[d]; if(dayTasks.length > 0) { dailyTotalCount = dayTasks.length; if(dayRecord && dayRecord[s.id]) { dayTasks.forEach((_, idx) => { if(dayRecord[s.id].tasks && dayRecord[s.id].tasks[idx]) dailyDoneCount++; else if(!dayRecord[s.id].tasks && dayRecord[s.id].done) dailyDoneCount++; }); } } else { if(dayRecord && dayRecord[s.id]?.done) { dailyTotalCount = 1; dailyDoneCount = 1; } } const 
            ratio = dailyTotalCount > 0 ? dailyDoneCount / dailyTotalCount : 0; history.push({ date: d, ratio: ratio, count: dailyDoneCount, total: dailyTotalCount, done: dailyDoneCount === dailyTotalCount && dailyTotalCount > 0 }); if(ratio === 1) count++; } for(let i=0; i<365;
            i++) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const rec = records[d]?.[s.id]; let isDoneDay = false;
            if(rec) { if(rec.tasks) { if(rec.done) isDoneDay = true; } else if(rec.done) { isDoneDay = true; } } if(isDoneDay) currentStreak++;
            else if(i===0 && !isDoneDay) continue; else break; } const honorStats = calcStatsForStudent(s, honorPeriod, honorTag); const helpStats = calcStatsForStudent(s, helpPeriod, helpTag);
            return { ...s, count, streak: currentStreak, history, honorStats, helpStats }; }); const top5 = [...computedStudents].sort((a,b) => b.honorStats.count - a.honorStats.count).slice(0, 5);
            const bottom5 = [...computedStudents].sort((a,b) => a.helpStats.rate - b.helpStats.rate).slice(0, 5); return { students: computedStudents, top5, bottom5 };
            }, [students, records, dailyTasks, honorPeriod, honorTag, helpPeriod, helpTag]);
            
            const handleFirebaseConnect = (config) => { localStorage.setItem('checklist_config', JSON.stringify(config)); setIsSetupOpen(false);
            setToastMessage("ì—°ê²° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤."); setTimeout(() => window.location.reload(), 1500); };
            
            const handleResetAllData = (selectedItems) => { 
                openConfirm("ì„ íƒí•œ í•­ëª©ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    const updates = {};
                    
                    if (selectedItems.includes('students')) {
                        setStudents([]);
                        updates['cls_students'] = [];
                    }
                    if (selectedItems.includes('records')) {
                        setRecords({});
                        setSimpleChecks({});
                        updates['cls_records'] = {};

                        // [New] í•™ìƒ ëª…ë‹¨ì€ ìœ ì§€í•˜ë©´ì„œ ê¸°ë¡ë§Œ ì‚­ì œí•˜ëŠ” ê²½ìš°: ìƒë‹´ ê¸°ë¡ê³¼ ìŠ¤í‹°ì»¤ë„ ì´ˆê¸°í™”
                        if (!selectedItems.includes('students')) {
                            const resetStudents = students.map(s => ({ ...s, counseling: [], stickers: 0 }));
                            setStudents(resetStudents);
                            updates['cls_students'] = resetStudents;
                        }
                    }
                    if (selectedItems.includes('groups')) {
                        setGroupsByDate({});
                        setGroupNames({});
                        setGroupRoles({});
                        setAvoidancePairs([]);
                        setMustPairs([]);
                        updates['cls_groups_date'] = {};
                        updates['cls_group_names'] = {};
                        updates['cls_group_roles'] = {};
                        updates['cls_avoidance'] = [];
                        updates['cls_mustPairs'] = [];
                    }
                    if (selectedItems.includes('tasks')) {
                        setDailyTasks({});
                        setWeeklyTasks({0:[],1:[],2:[],3:[],4:[],5:[],6:[]});
                        setTags(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
                        updates['cls_daily_tasks'] = {};
                        updates['cls_weekly_tasks'] = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
                        updates['cls_tags'] = ['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€'];
                    }
                    if (selectedItems.includes('seats')) {
                        setSeatAssignments({});
                        setSeatConfig({rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']});
                        updates['cls_seat_assignments'] = {};
                        updates['cls_seat_config'] = {rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']};
                    }
                    if (selectedItems.includes('roles')) {
                        setRolesList(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
                        setRoleDescriptions(DEFAULT_ROLE_DESCRIPTIONS);
                        updates['cls_roles_list'] = ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        updates['cls_role_descriptions'] = DEFAULT_ROLE_DESCRIPTIONS;
                    }

                    if (!isLocalMode) {
                        saveData(updates);
                        if (db && appId) {
                            if (selectedItems.includes('students')) {
                                db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                            if (selectedItems.includes('records')) {
                                db.collection('classes').doc(appId).collection('records').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });

                                // [New] ìƒë‹´ ê¸°ë¡ í•„ë“œ ì‚­ì œ (í•™ìƒ ëª…ë‹¨ ìœ ì§€ ì‹œ)
                                if (!selectedItems.includes('students')) {
                                    db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                        const batch = db.batch();
                                        snapshot.docs.forEach(doc => {
                                            batch.update(doc.ref, { counseling: firebase.firestore.FieldValue.delete() });
                                        });
                                        batch.commit();
                                    });
                                }
                            }
                            if (selectedItems.includes('groups')) {
                                db.collection('classes').doc(appId).collection('groupResults').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                        }
                    } else {
                        saveData(updates);
                    }
                    setToastMessage("ì„ íƒí•œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                });
            };

            const handleFormationTitleClick = () => {
                if (formationClickTimer.current) clearTimeout(formationClickTimer.current);
                const newCount = formationClickCount + 1;
                setFormationClickCount(newCount);
                
                if (newCount >= 3) {
                    setShowQuickApiKey(prev => !prev);
                    setToastMessage(!showQuickApiKey ? "API í‚¤ ì…ë ¥ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤." : "API í‚¤ ì…ë ¥ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.");
                    setFormationClickCount(0);
                } else {
                    formationClickTimer.current = setTimeout(() => setFormationClickCount(0), 500);
                }
            };

            const handleGenerateBriefing = async () => {
                if (!apiKey) {
                    setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                setIsGenerating(true);
                setAiContent(""); 
                setShowWeeklyBriefing(true);
                setGenerationProgress(0);

                const timer = setInterval(() => {
                    setGenerationProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 300);

                try {
                    // ì„ íƒëœ ê¸°ê°„ ë°ì´í„° ì§‘ê³„
                    let curr = dayjs(briefingStart);
                    const end = dayjs(briefingEnd);
                    const targetDates = [];
                    while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                        targetDates.push(curr.format('YYYY-MM-DD'));
                        curr = curr.add(1, 'day');
                    }
                    const summary = targetDates.reverse().map(d => {
                        const tasks = dailyTasks[d] || [];
                        const recs = records[d] || {};
                        const total = students.length * (tasks.length || 1);
                        let done = 0;
                        students.forEach(s => {
                            const r = recs[s.id];
                            if(r) {
                                if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                                else if(r.done) done++;
                            }
                        });
                        return `${d}: ìˆ˜í–‰ë¥  ${total > 0 ? Math.round(done/total*100) : 0}%`;
                    }).join('\n');

                    let toneDesc = "ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ ë¹„ì„œì²˜ëŸ¼";
                    if (briefingTone === 'encouraging') toneDesc = "ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'analytical') toneDesc = "ê°ê´€ì ì´ê³  ë¶„ì„ì ì¸ ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'concise') toneDesc = "í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ì–´ì¡°ë¡œ";

                    const prompt = `
                        ${briefingStart}ë¶€í„° ${briefingEnd}ê¹Œì§€ì˜ í•™ê¸‰ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ ì„ ìƒë‹˜ì„ ìœ„í•œ 'ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

                        [ë°ì´í„° ìš”ì•½]
                        ${summary}

                        [ë¶„ì„ ìš”ì²­ì‚¬í•­]
                        1. **í•™ìŠµ íë¦„ ë¶„ì„**: ë‹¨ìˆœ ìˆ˜í–‰ë¥  ë‚˜ì—´ì´ ì•„ë‹Œ, ì£¼ê°„ í•™ìŠµ íë¦„ì˜ ë³€í™”ì™€ íŠ¹ì´ì ì„ íŒŒì•…í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì£¼ì´ˆ ëŒ€ë¹„ ì£¼ë§ì˜ ë³€í™”, íŠ¹ì • ìš”ì¼ì˜ ì €ì¡°í•¨ ë“±)
                        2. **ê´€ì‹¬ í•„ìš” ì˜ì—­**: ìˆ˜í–‰ë¥ ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§€ê±°ë‚˜ ì§€ì†ì ìœ¼ë¡œ ì €ì¡°í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì›ì¸ì„ ì¶”ë¡ í•˜ê³  ì–¸ê¸‰í•´ì£¼ì„¸ìš”.
                        3. **ë‹¤ìŒ ì£¼ ì „ëµ**: ë¶„ì„ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì£¼ í•™ê¸‰ ìš´ì˜ì— ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ 'ì›í¬ì¸íŠ¸ ë ˆìŠ¨'ì´ë‚˜ 'ë¯¸ì…˜'ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
                        4. **ì–´ì¡°**: ${toneDesc} ì‘ì„±í•´ì£¼ì„¸ìš”.
                        5. **í˜•ì‹**: ê°€ë…ì„± ì¢‹ê²Œ ì†Œì œëª©ì„ í™œìš©í•˜ì—¬ êµ¬ì¡°í™”í•˜ê³ , 400ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    clearInterval(timer);
                    setGenerationProgress(100);
                    setAiContent(text);
                } catch (e) {
                    clearInterval(timer);
                    setShowWeeklyBriefing(false);
                    setToastMessage("ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleDownloadBriefingPdf = async () => {
                if (!briefingRef.current) return;
                if (!window.jspdf) return setToastMessage("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(briefingRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`ì£¼ê°„ë¸Œë¦¬í•‘_${dayjs().format('YYYYMMDD')}.pdf`);
                    setToastMessage("PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { setToastMessage("PDF ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            const handleGenerateStory = async () => {
                if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsGenerating(true);
                try {
                    const tasks = dailyTasks[date] || [];
                    const recs = records[date] || {};
                    const total = students.length * (tasks.length || 1);
                    let done = 0;
                    students.forEach(s => {
                        const r = recs[s.id];
                        if(r) {
                            if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                            else if(r.done) done++;
                        }
                    });
                    const rate = total > 0 ? Math.round(done/total*100) : 0;
                    
                    let genrePrompt = "ëª…ë‘ ë§Œí™” ê°™ì€ ì¦ê±°ìš´ í•™êµ ìƒí™œ ì´ì•¼ê¸°";
                    let rolePrompt = "ê°œêµ¬ìŸì´ í•™ìƒë“¤";
                    if (storyGenre === 'adventure') { genrePrompt = "ë³´ë¬¼ì„ ì°¾ì•„ ë– ë‚˜ëŠ” ì‹ ë‚˜ëŠ” ëª¨í—˜ ì´ì•¼ê¸°"; rolePrompt = "ìš©ê°í•œ íƒí—˜ê°€"; }
                    else if (storyGenre === 'fairytale') { genrePrompt = "ë”°ëœ»í•˜ê³  êµí›ˆì ì¸ ë™í™”"; rolePrompt = "ìˆ²ì† ë™ë¬¼ ì¹œêµ¬ë“¤"; }
                    else if (storyGenre === 'detective') { genrePrompt = "ì‚¬ê±´ì„ í•´ê²°í•˜ëŠ” ê¼¬ë§ˆ íƒì •ë‹¨ ì´ì•¼ê¸°"; rolePrompt = "ëª…íƒì •"; }
                    else if (storyGenre === 'hero') { genrePrompt = "ìœ„ê¸°ì— ë¹ ì§„ ì„¸ìƒì„ êµ¬í•˜ëŠ” íˆì–´ë¡œ ì´ì•¼ê¸°"; rolePrompt = "ìŠˆí¼ íˆì–´ë¡œ"; }

                    const prompt = `
                        ì˜¤ëŠ˜ ìš°ë¦¬ ë°˜ì˜ í•˜ë£¨ í™œë™ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì•„ì´ë“¤ì´ ì£¼ì¸ê³µì´ ë˜ëŠ” ëª°ì…ê° ë„˜ì¹˜ëŠ” ${genrePrompt}ë¥¼ ì°½ì‘í•´ì£¼ì„¸ìš”.

                        [ì˜¤ëŠ˜ì˜ í™œë™ ë°ì´í„°]
                        - ë‚ ì§œ: ${date}
                        - í€˜ìŠ¤íŠ¸ ë‹¬ì„±ë¥ (ê³¼ì œ ìˆ˜í–‰ë¥ ): ${rate}% (ì´ ìˆ˜ì¹˜ê°€ ì´ì•¼ê¸° ì† 'ì„±ê³µ í™•ë¥ 'ì´ë‚˜ 'ìœ„ê¸° ìƒí™©'ì„ ê²°ì •í•©ë‹ˆë‹¤)
                        - íšë“í•œ ë³´ë¬¼(ìŠ¤í‹°ì»¤): ì˜¤ëŠ˜ ì „ì²´ ì§€ê¸‰ëœ ìŠ¤í‹°ì»¤ ìˆ˜ (ì¶”ì •)

                        [ìŠ¤í† ë¦¬í…”ë§ ê°€ì´ë“œ]
                        1. **ì„¸ê³„ê´€ ì„¤ì •**: ${genrePrompt}ì— ê±¸ë§ì€ ë…ì°½ì ì¸ ë°°ê²½ê³¼ ìš©ì–´(ì˜ˆ: ì—°í•„â†’ë§ˆë²• ì§€íŒ¡ì´, ê³¼ì œâ†’ëª¬ìŠ¤í„°)ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                        2. **ì „ê°œ**: 'ë°œë‹¨(í‰í™”ë¡œìš´ ì•„ì¹¨) - ì „ê°œ(ë¯¸ì…˜ ë°œìƒ) - ìœ„ê¸°(ê³¼ì œ ìˆ˜í–‰ì˜ ì–´ë ¤ì›€) - ì ˆì •(í˜‘ë™ê³¼ ë…¸ë ¥) - ê²°ë§(ì„±ì·¨ì™€ ë³´ìƒ)'ì˜ êµ¬ì¡°ë¥¼ ê°–ì¶°ì£¼ì„¸ìš”.
                        3. **ìºë¦­í„°**: í•™ìƒë“¤ì„ ${rolePrompt}ë¡œ ë¬˜ì‚¬í•˜ë˜, ìµëª…ì„±ì„ ìœ ì§€í•˜ë©´ì„œë„ ì•„ì´ë“¤ì´ ìì‹ ì„ íˆ¬ì˜í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì„¸ìš”.
                        4. **ë©”ì‹œì§€**: ìˆ˜í–‰ë¥ ì´ ë†’ë‹¤ë©´ 'í˜‘ë™ì˜ ìŠ¹ë¦¬'ë¥¼, ë‚®ë‹¤ë©´ 'í¬ê¸°í•˜ì§€ ì•ŠëŠ” ìš©ê¸°'ë¥¼ ê°•ì¡°í•˜ë©° ë‚´ì¼ì˜ ê¸°ëŒ€ë¥¼ ì‹¬ì–´ì£¼ì„¸ìš”.
                        5. **ë¶„ëŸ‰**: 600ì ë‚´ì™¸ë¡œ í¥ë¯¸ì§„ì§„í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    setAiContent(text);
                } catch (e) {
                    logSystemEvent(`í•™ê¸‰ ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleForceLocalMode = () => {
                setIsLocalMode(true);
                setIsLoading(false);
                setToastMessage("ë¡œì»¬ ëª¨ë“œë¡œ ê°•ì œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            if (isLoading) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-slate-50 space-y-6 p-8">
                        <div className="text-6xl animate-bounce mb-2">â³</div>
                        <div className="text-center space-y-2">
                            <div className="text-2xl font-bold text-slate-800">ì•±ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                            <div className="text-sm text-slate-500 font-medium">ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”.</div>
                        </div>
                        
                        <div className="w-full max-w-xs space-y-2">
                            <div className="h-3 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-300 ease-out" style={{ width: `${loadingProgress}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs font-bold text-slate-400">
                                <span>Loading...</span>
                                <span>{Math.round(loadingProgress)}%</span>
                            </div>
                        </div>

                        {showLongLoading && (
                            <div className="animate-fade-in flex flex-col items-center gap-3 mt-4 pt-4 border-t border-slate-200 w-full max-w-xs">
                                <p className="text-xs text-rose-500 font-bold text-center">
                                    ë¡œë”©ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.<br/>(ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” ì¼ì‹œì  ì˜¤ë¥˜)
                                </p>
                                <div className="flex gap-2 w-full">
                                    <button onClick={() => window.location.reload()} className="flex-1 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 shadow-sm text-sm transition-transform active:scale-95">
                                        ìƒˆë¡œê³ ì¹¨
                                    </button>
                                    <button onClick={handleForceLocalMode} className="flex-1 px-4 py-2.5 bg-slate-100 border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-200 shadow-sm text-sm transition-transform active:scale-95">
                                        ê°•ì œ ë¡œì»¬ ëª¨ë“œ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`flex flex-col h-full bg-slate-50 text-slate-900 ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                    <header className="bg-white border-b border-notion-border z-10 sticky top-0"><div className="px-4 py-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-3"><div className="flex items-center gap-6"><div className="flex items-center gap-2"><div className="p-1.5 bg-notion-bg-alt text-notion-text rounded border border-notion-border"><Icon d={PATHS.list} size={18}/></div><h1 className="text-base font-bold text-notion-text">{appConfig.recordTitle}</h1>{!isLocalMode && <div className="animate-fade-in" title="í´ë¼ìš°ë“œ ì—°ê²°ë¨">{appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-6 h-6 object-contain" alt="cloud"/> : <span className="text-xl">â˜ï¸</span>}</div>}</div><div className="hidden md:flex gap-1">{[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (<button key={m.id} onClick={()=>setMode(m.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-sm font-medium transition-all ${mode===m.id?'bg-notion-bg-hover text-notion-text':'text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text'}`}><Icon d={m.icon} size={14}/><span>{m.label}</span></button>))}</div></div>
                    <div className="flex items-center gap-2 absolute right-4 top-3 md:relative md:top-auto md:right-auto">
                        <button onClick={()=>setIsToolsOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>ğŸ§°</span><span className="text-sm font-medium">ë„êµ¬</span></button>
                        <button onClick={()=>setIsSettingOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>âš™ï¸</span><span className="text-sm font-medium">ì„¤ì •</span></button>
                    </div>
                    </div>{(mode === 'record' || mode === 'group') && (<div className="bg-white border-b border-notion-border pt-2 pb-2 flex justify-center"><div className="w-full max-w-2xl px-4 flex flex-col gap-2">{mode === 'record' ? <><DateHeader date={date} setDate={setDate} onAdd={()=>setIsTaskModalOpen(true)} onReset={resetDateRecord} onCalendar={()=>setIsCalendarOpen(true)} appConfig={appConfig}/> <ProgressBar progress={progress} appConfig={appConfig} /></> : <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border mx-auto w-fit justify-center cursor-pointer"
><Btn onClick={()=>setDate(dayjs(date).subtract(1,'day').format('YYYY-MM-DD'))} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18}/></Btn><div className="flex flex-col items-center px-3" onClick={()=>setIsCalendarOpen(true)}><div className="text-base font-bold text-notion-text">{dayjs(date).format('YY.MM.DD')}</div><div className="text-[10px] font-bold text-notion-text-light">{dayjs(date).format('dddd')}</div></div><Btn onClick={()=>setDate(dayjs(date).add(1,'day').format('YYYY-MM-DD'))} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18}/></Btn></div>}</div></div>)}</header>
                    <main 
                        className="flex-1 overflow-y-auto p-4 md:p-6 custom-scroll pb-20 md:pb-6 bg-white"
                    >
                        <div key={date} className="flex-1">
                            {mode === 'record' && (
                                <>
                                    <div className="flex justify-end mb-4 items-center gap-2">
                                        <Btn onClick={() => { if(!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); setAiContent(""); setShowClassStory(true); }} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                            <Icon d={PATHS.book} size={16} /> ì˜¤ëŠ˜ì˜ í•™ê¸‰ ìŠ¤í† ë¦¬ ë³´ê¸°
                                        </Btn>
                                        <button onClick={() => setShowStoryHelp(true)} className="text-notion-text-light hover:text-notion-text p-1 rounded hover:bg-notion-bg-hover transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={18} /></button>
                                    </div>
                                    <RecordView students={students} records={records} dailyTasks={dailyTasks} date={date} toggleCheck={toggleCheck} appConfig={appConfig} stats={stats} onLongPress={(id) => setGrassStudentId(id)} />
                                </>
                            )}
                            {mode === 'simple' && <SimpleView students={students} simpleChecks={simpleChecks} toggleCheck={toggleCheck} onLongPress={(id) => setGrassStudentId(id)} />}
                            {mode === 'group' && (
                                <div className="w-full md:h-full h-auto flex flex-col md:flex-row gap-6 pb-4 md:overflow-hidden">
                                    <div className={`md:w-1/3 lg:w-1/4 space-y-4 md:h-full h-auto md:overflow-y-auto custom-scroll transition-all duration-300 ${isGroupPanelOpen ? 'block' : 'hidden'}`}>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="flex justify-between items-center mb-4"><h3 onClick={handleFormationTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-default select-none"><span className="text-xl">ğŸ§©</span> í¸ì„±</h3><Btn onClick={()=>setIsAvoidanceVisible(!isAvoidanceVisible)} className="text-slate-400"><Icon d={isAvoidanceVisible ? PATHS.unlock : PATHS.lock}/></Btn></div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <Btn onClick={() => applyPreset('coop')} className={`py-2 rounded-lg text-xs font-bold ${useGender && useSkill && useHistory ? 'bg-indigo-600 text-white shadow-md' : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'}`}>í˜‘ë™ í•™ìŠµ<span className="block text-[9px] font-normal opacity-80 mt-0.5">ì‹¤ë ¥/ì„±ë³„/ê²¹ì¹¨ë°©ì§€</span></Btn>
                                                <Btn onClick={() => applyPreset('peer')} className={`py-2 rounded-lg text-xs font-bold ${!useGender && useSkill && !useHistory ? 'bg-green-600 text-white shadow-md' : 'bg-green-50 text-green-700 hover:bg-green-100'}`}>ë˜ë˜ êµìˆ˜<span className="block text-[9px] font-normal opacity-80 mt-0.5">ì‹¤ë ¥(ìƒ+í•˜) ë§¤ì¹­</span></Btn>
                                                <Btn onClick={() => applyPreset('project')} className={`py-2 rounded-lg text-xs font-bold ${useLeader ? 'bg-purple-600 text-white shadow-md' : 'bg-purple-50 text-purple-700 hover:bg-purple-100'}`}>í”„ë¡œì íŠ¸<span className="block text-[9px] font-normal opacity-80 mt-0.5">ë¦¬ë” ë¶„ì‚° ë°°ì¹˜</span></Btn>
                                                <Btn onClick={() => applyPreset('random')} className={`py-2 rounded-lg text-xs font-bold ${!useGender && !useSkill && !useLeader ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>ì™„ì „ ëœë¤<span className="block text-[9px] font-normal opacity-80 mt-0.5">ì¡°ê±´ ì—†ì´ ì„ê¸°</span></Btn>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useGender ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useGender} onChange={e=>setUseGender(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useGender ? 'text-indigo-700' : 'text-slate-400'}`}>ì„±ë³„ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useSkill ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useSkill} onChange={e=>setUseSkill(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useSkill ? 'text-indigo-700' : 'text-slate-400'}`}>ì‹¤ë ¥ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useLeader ? 'bg-purple-50 border-purple-200 ring-1 ring-purple-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useLeader} onChange={e=>setUseLeader(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useLeader ? 'text-purple-700' : 'text-slate-400'}`}>ğŸ‘‘ ë¦¬ë” ë¶„ì‚°</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useHistory ? 'bg-orange-50 border-orange-200 ring-1 ring-orange-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useHistory} onChange={e=>setUseHistory(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useHistory ? 'text-orange-700' : 'text-slate-400'}`}>ğŸ”„ ê²¹ì¹¨ ë°©ì§€</span></label>
                                            </div>
                                            {isAvoidanceVisible && (
                                                <div className="mb-6 animate-fade-in bg-slate-50 p-3 rounded-xl">
                                                    <div className="flex bg-white rounded-lg p-1 mb-3 border">
                                                        <button onClick={()=>setPairTab('avoid')} className={`flex-1 py-1.5 text-xs font-bold rounded ${pairTab==='avoid'?'bg-rose-100 text-rose-600 shadow-sm':'text-slate-400'}`}>ğŸš« ê¸°í”¼ ê´€ê³„</button>
                                                        <button onClick={()=>setPairTab('must')} className={`flex-1 py-1.5 text-xs font-bold rounded ${pairTab==='must'?'bg-green-100 text-green-600 shadow-sm':'text-slate-400'}`}>ğŸ¤ í•„ìˆ˜ ì§ê¿</button>
                                                    </div>
                                                    <div className="flex gap-2 mb-2">
                                                        <select value={p1} onChange={e=>setP1(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm bg-white"><option value="">í•™ìƒ1</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <select value={p2} onChange={e=>setP2(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm bg-white"><option value="">í•™ìƒ2</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <Btn onClick={()=>{ if(p1&&p2&&p1!==p2){ if(pairTab==='avoid') { setAvoidancePairs([...avoidancePairs,{p1,p2,id:Date.now()}]); } else { setMustPairs([...mustPairs,{p1,p2,id:Date.now()}]); } setP1(""); setP2(""); } }} className={`text-white px-3 rounded-lg ${pairTab==='avoid'?'bg-rose-500':'bg-green-500'}`}>+</Btn>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scroll">
                                                        {pairTab === 'avoid' ? avoidancePairs.map(p=><span key={p.id} className="text-xs bg-rose-50 text-rose-600 px-2 py-1 rounded border border-rose-100">{p.p1}â‰ {p.p2} <button onClick={()=>setAvoidancePairs(avoidancePairs.filter(x=>x.id!==p.id))}>Ã—</button></span>) : mustPairs.map(p=><span key={p.id} className="text-xs bg-green-50 text-green-600 px-2 py-1 rounded border border-green-100">{p.p1}={p.p2} <button onClick={()=>setMustPairs(mustPairs.filter(x=>x.id!==p.id))}>Ã—</button></span>)}
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-rose-100">
                                                        <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${showAvoidanceLines ? 'bg-rose-100 border-rose-200 text-rose-700' : 'bg-white border-slate-200 text-slate-400'}`}><input type="checkbox" checked={showAvoidanceLines} onChange={e=>setShowAvoidanceLines(e.target.checked)} className="hidden"/><span className="text-xs font-bold">ğŸš« ê¸°í”¼ ê´€ê³„ ì‹œê°í™”</span></label>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="pt-4 border-t mt-4 border-slate-100">
                                                <div className={`flex items-center p-2 rounded-xl border transition-all mb-2 ${!apiKey ? 'bg-slate-50 border-slate-200' : useAI ? 'bg-violet-50 border-violet-200 ring-1 ring-violet-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                    <label className={`flex items-center flex-1 cursor-pointer ${!apiKey ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                                        <div className={`w-4 h-4 rounded-full border flex items-center justify-center mr-2 ${useAI ? 'bg-violet-500 border-violet-500' : 'border-slate-300'}`}>{useAI && <Icon d={PATHS.check} size={10} className="text-white"/>}</div>
                                                        <span className={`text-sm font-bold flex-1 ${useAI ? 'text-violet-700' : 'text-slate-500'}`}>AI ëª¨ë‘  í¸ì„±</span>
                                                        <input type="checkbox" checked={useAI} onChange={e => { if(!apiKey) { setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } setUseAI(e.target.checked); }} className="hidden" disabled={!apiKey} />
                                                    </label>
                                                    <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowAiHelp(true); }} className="text-slate-400 hover:text-violet-600 p-2 rounded-full hover:bg-white/50 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16}/></button>
                                                </div>
                                            {showQuickApiKey && (
                                                <div className="mb-2 animate-fade-in p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                                                    <div className="flex justify-between items-center mb-1"><label className="text-xs font-bold text-indigo-700">Gemini API Key</label></div>
                                                    <div className="flex gap-2">
                                                        <input type="password" value={apiKey} onChange={(e) => { setApiKey(e.target.value); if(isLocalMode) localStorage.setItem('cls_ai_key', e.target.value); else saveData('cls_ai_key', e.target.value); }} className="flex-1 p-2 border border-indigo-200 rounded-lg text-xs outline-none focus:border-indigo-500 bg-white" placeholder="API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                                                        <Btn onClick={async () => {
                                                            if (!apiKey) return setToastMessage("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                                            setToastMessage("í‚¤ í™•ì¸ ì¤‘...");
                                                            try {
                                                                await callGemini(apiKey, "Hello");
                                                                setUseAI(true);
                                                                setToastMessage("API í‚¤ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. AI ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.");
                                                            } catch (e) { setToastMessage("ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤ì…ë‹ˆë‹¤."); }
                                                        }} className="bg-indigo-600 text-white px-3 rounded-lg text-xs font-bold hover:bg-indigo-700 whitespace-nowrap">í™•ì¸</Btn>
                                                    </div>
                                                </div>
                                            )}
                                                {useAI && (
                                                <div className="animate-fade-in space-y-2 relative">
                                                        <textarea value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)} className="w-full p-2 border rounded-xl text-xs outline-none focus:border-violet-500 resize-none bg-violet-50/30" placeholder="ì˜ˆ: ë‚¨ë…€ ì„ê³  ìˆ˜í•™ ì˜í•˜ëŠ” ì¹œêµ¬ ê³¨ê³ ë£¨ ë„£ì–´ì¤˜" rows="2"></textarea>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="space-y-3 mt-4 pt-4 border-t border-slate-100">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs font-bold text-slate-500 flex items-center gap-1">ğŸ“… ìœ ì§€ ê¸°ê°„</span>
                                                    <div className="flex items-center gap-1">
                                                        <select value={groupDuration} onChange={e=>setGroupDuration(parseInt(e.target.value))} className="p-1.5 border rounded-lg text-xs bg-white outline-none font-bold text-slate-700 focus:border-indigo-500 w-24">
                                                            <option value={1}>1ì¼</option>
                                                            <option value={7}>1ì£¼</option>
                                                            <option value={14}>2ì£¼</option>
                                                            <option value={21}>3ì£¼</option>
                                                            <option value={28}>4ì£¼</option>
                                                            {![1, 7, 14, 21, 28].includes(groupDuration) && <option value={groupDuration}>{groupDuration}ì¼</option>}
                                                        </select>
                                                        <Btn onClick={() => setIsRangeCalendarOpen(true)} className="p-1.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200" title="ë‹¬ë ¥ì—ì„œ ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={14}/></Btn>
                                                        {groupDuration > 1 && <Btn onClick={() => setGroupDuration(1)} className="p-1.5 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-100" title="ê¸°ê°„ ì´ˆê¸°í™”"><Icon d={PATHS.x} size={14}/></Btn>}
                                                    </div>
                                                </div>
                                                <div className="text-[10px] text-slate-400 text-right mt-1 font-mono">
                                                    {dayjs(date).format('MM/DD')} ~ {dayjs(date).add(groupDuration-1, 'day').format('MM/DD')} ({groupDuration}ì¼)
                                                </div>
                                                <div className="flex bg-slate-100 p-1 rounded-lg"><Btn onClick={()=>setGroupMethod('count')} className={`flex-1 py-1.5 text-xs font-bold rounded-md ${groupMethod==='count'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ëª¨ë‘  ìˆ˜ ê¸°ì¤€</Btn><Btn onClick={()=>setGroupMethod('size')} className={`flex-1 py-1.5 text-xs font-bold rounded-md ${groupMethod==='size'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ì¸ì› ìˆ˜ ê¸°ì¤€</Btn></div>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={groupNumber} onChange={e=>setGroupNumber(parseInt(e.target.value))} className="flex-1 p-2 border rounded-lg text-center font-bold" min="1" max="20"/>
                                                    <span className="text-sm text-slate-500 shrink-0">{groupMethod==='count'?'ê°œ':'ëª…'}</span>
                                                    <Btn onClick={generateGroups} disabled={isGenerating} className={`w-auto px-4 py-2 rounded-lg font-bold shadow-md text-sm whitespace-nowrap flex items-center gap-2 transition-all ${isGenerating ? 'bg-slate-400 text-slate-100 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}>
                                                        {isGenerating ? (
                                                            <>
                                                                <Icon d={PATHS.spinner} className="animate-spin" size={14} />
                                                                <span>í¸ì„± ì¤‘...</span>
                                                            </>
                                                        ) : (useAI ? 'AI í¸ì„±' : 'ëª¨ë‘  í¸ì„±')}
                                                    </Btn>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 mt-2"><Btn onClick={rotateCurrentGroups} className="py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold">ìì „ê³¼ ê³µì „</Btn><Btn onClick={()=>{openConfirm("ëª¨ë‘  ê¸°ë¡ê³¼ ìë¦¬ ë°°ì¹˜ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.", ()=>{ const newGroups = {...groupsByDate, [date]: []}; setGroupsByDate(newGroups); if(!isLocalMode) saveData('cls_groups_date', newGroups); setSeatAssignments({}); if(!isLocalMode) saveData('cls_seat_assignments', {}); showToast("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); })}} className="py-2.5 bg-white border border-rose-200 text-rose-500 rounded-xl font-bold">ì´ˆê¸°í™”</Btn></div>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 transition-all">
                                            <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsGroupToolsOpen(!isGroupToolsOpen)}>
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                                    <span className="text-xl">ğŸ› ï¸</span> ëª¨ë‘  ë„êµ¬
                                                    <button onClick={(e) => { e.stopPropagation(); setShowRoleHelp(true); }} className="text-slate-400 hover:text-indigo-500"><Icon d={PATHS.help} size={16} /></button>
                                                </h3>
                                                <Icon d={isGroupToolsOpen ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                            </div>
                                            {isGroupToolsOpen && (
                                                <div className="mt-4 grid grid-cols-1 gap-2 animate-fade-in">
                                                    <label className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                        <span className={`text-sm font-bold ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'text-indigo-700' : 'text-slate-500'}`}>ëª¨ë‘  ì—­í•  ìë™ ë¶„ë‹´</span>
                                                        <div className={`w-10 h-6 flex items-center rounded-full p-1 transition-colors ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'translate-x-4' : ''}`}></div></div>
                                                        <input type="checkbox" checked={!!(groupRoles[date] && Object.keys(groupRoles[date]).length > 0)} onChange={(e) => { if(e.target.checked) handleAssignRoles(); else openConfirm("ì—­í•  ë°°ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", handleClearRoles); }} className="hidden" />
                                                    </label>
                                                    <div className="flex gap-2">
                                                        <Btn onClick={() => setIsRoleEditOpen(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-sm">ì—­í•  ëª©ë¡ ìˆ˜ì •</Btn>
                                                        <Btn onClick={() => setShowPartnerAnalysis(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-sm">ğŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„</Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className={`flex flex-col md:h-full h-auto gap-4 md:overflow-y-auto custom-scroll pb-10 transition-all duration-300 ${isGroupPanelOpen ? 'md:w-2/3 lg:w-3/4' : 'md:w-full'}`}>
                                        <div id="groups-container" className={`bg-white rounded-2xl border border-slate-200 flex flex-col relative transition-all duration-300 h-auto`}>
                                            <div className="flex justify-between items-center px-4 py-3 border-b border-slate-200 flex-shrink-0 bg-white rounded-t-2xl md:sticky md:top-0 z-10">
                                                <div className="flex items-center gap-2 w-full">
                                                    <Btn onClick={() => setIsGroupPanelOpen(!isGroupPanelOpen)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500">
                                                        <Icon d={isGroupPanelOpen ? PATHS.left : PATHS.right} />
                                                    </Btn>
                                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“… {date} ëª¨ë‘  ({groups.length}ê°œ)</h3>
                                                    {groups.length > 0 && <Btn onClick={handleDownloadGroupsImage} className="ml-auto p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ì¥"><Icon d={PATHS.download} size={18} /></Btn>}
                                                </div>
                                            </div>
                                            <GroupOverlay groups={groups} avoidancePairs={avoidancePairs} isVisible={showAvoidanceLines} focusedGroupIdx={focusedGroupIdx} />
                                            <div className="p-4" ref={groupsRef}>
                                                {groups.length > 0 ? (
                                                    <div className="flex flex-wrap gap-4 pb-4 items-start">
                                                        {groups.map((g, i) => {
                                                            const groupAvgSkill = g.length > 0 ? g.reduce((a, s) => a + s.skill, 0) / g.length : 0;
                                                            const isSkillImbalanced = g.length > 0 && Math.abs(groupAvgSkill - classAvgSkill) > 0.5;
                                                            const isExpanded = expandedGroupCards[i];
                                                            const MAX_VISIBLE = 2;
                                                            const visibleStudents = (g.length > MAX_VISIBLE && !isExpanded) ? g.slice(0, MAX_VISIBLE) : g;
                                                            const hiddenCount = g.length - MAX_VISIBLE;
                                                            return (
                                                            <div key={i} className={`group-card bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-4 transition-all hover:shadow-md flex flex-col w-full sm:w-auto flex-grow ${focusedGroupIdx === i ? 'ring-2 ring-rose-400 shadow-md' : ''}`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, i)} onClick={() => setFocusedGroupIdx(prev => prev === i ? null : i)}>
                                                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-50">
                                                                    {editingGroupIdx === i ? (
                                                                        <div className="flex items-center gap-1 w-full max-w-[150px]">
                                                                            <input 
                                                                                className="font-bold text-lg text-slate-800 bg-white border border-indigo-200 rounded px-1 outline-none w-full focus:ring-2 focus:ring-indigo-200"
                                                                                defaultValue={groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}
                                                                                placeholder={`${i+1}ëª¨ë‘ `}
                                                                                autoFocus
                                                                                onInput={(e) => {
                                                                                    const newNames = { ...groupNames };
                                                                                    if (!newNames[date]) newNames[date] = {};
                                                                                    newNames[date][i] = e.target.value;
                                                                                    setGroupNames(newNames);
                                                                                }}
                                                                                onKeyDown={(e) => {
                                                                                    if(e.key === 'Enter') {
                                                                                        setEditingGroupIdx(null);
                                                                                        if(!isLocalMode) saveData('cls_group_names', groupNames);
                                                                                    }
                                                                                }}
                                                                                onBlur={() => {
                                                                                    setEditingGroupIdx(null);
                                                                                    if(!isLocalMode) saveData('cls_group_names', groupNames);
                                                                                }}
                                                                            />
                                                                            <Btn onClick={() => {
                                                                                setEditingGroupIdx(null);
                                                                                if(!isLocalMode) saveData('cls_group_names', groupNames);
                                                                            }} className="p-1 bg-indigo-100 text-indigo-600 rounded hover:bg-indigo-200"><Icon d={PATHS.check} size={14} /></Btn>
                                                                        </div>
                                                                    ) : (
                                                                        <div className="flex items-center gap-2 group/title">
                                                                            <span className="font-bold text-lg text-slate-800 truncate max-w-[120px]" title={groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}>{groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}</span>
                                                                            <Btn onClick={() => setEditingGroupIdx(i)} className="opacity-0 group-hover/title:opacity-100 p-1 text-slate-400 hover:text-indigo-500 transition-opacity"><Icon d={PATHS.edit} size={14} /></Btn>
                                                                        </div>
                                                                    )}
                                                                    <div className="flex items-center gap-1">
                                                                        {isSkillImbalanced && (
                                                                            <div className="text-orange-500 flex items-center animate-pulse" title={`ì‹¤ë ¥ ë¶ˆê· í˜• ê²½ê³  (ëª¨ë‘  í‰ê·  ${groupAvgSkill.toFixed(1)} vs ì „ì²´ ${classAvgSkill.toFixed(1)})`}>
                                                                                <Icon d={PATHS.warning} size={16} />
                                                                            </div>
                                                                        )}
                                                                        <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full">{g.length}ëª…</span>
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-col gap-2 flex-1">
                                                                    {visibleStudents.map((s, sIdx) => {
                                                                        const isLocked = lockedIds.includes(s.id);
                                                                        // ìë¦¬(Index) ê¸°ì¤€ ì—­í•  ì¡°íšŒ (ì—†ìœ¼ë©´ í•™ìƒ ID ê¸°ì¤€ ë ˆê±°ì‹œ ë°ì´í„° ì¡°íšŒ ì‹œë„)
                                                                        const role = groupRoles[date]?.[i]?.[sIdx] || groupRoles[date]?.[i]?.[s.id];
                                                                        return (
                                                                            <div key={s.id} data-student-name={s.name} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, i)} onDragEnd={handleDragEnd} className={`flex items-center justify-between p-2 rounded-2xl border transition-all cursor-grab active:cursor-grabbing touch-none ${s.gender === 'M' ? 'bg-blue-50/50 border-blue-100 hover:bg-blue-50' : 'bg-pink-50/50 border-pink-100 hover:bg-pink-50'} ${isLocked ? 'ring-2 ring-indigo-400 shadow-sm' : ''}`}>
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full ${s.gender==='M'?'bg-blue-200 text-blue-700':'bg-pink-200 text-pink-700'}`}>{s.order}</span>
                                                                                    <span className="text-sm font-bold text-slate-700 whitespace-nowrap">{s.name}</span>
                                                                                    {s.leader && <span className="text-xs" title="ë¦¬ë”">ğŸ‘‘</span>}
                                                                                    {role && <span className="text-[10px] bg-white/80 px-1.5 py-0.5 rounded border border-slate-200 text-slate-600">{role}</span>}
                                                                                </div>
                                                                                <button onClick={(e) => { e.stopPropagation(); toggleLock(s.id); }} className={`p-1 rounded-full hover:bg-white/50 transition-colors ${isLocked ? 'text-indigo-500' : 'text-slate-300 hover:text-slate-400'}`} title={isLocked ? "ê³ ì • í•´ì œ" : "ê³ ì •í•˜ê¸°"}>
                                                                                    <Icon d={isLocked ? PATHS.lock : PATHS.unlock} size={12} />
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                    {g.length > MAX_VISIBLE && (
                                                                        <button 
                                                                            onClick={(e) => { e.stopPropagation(); setExpandedGroupCards(prev => ({...prev, [i]: !prev[i]})); }}
                                                                            className="w-full py-2 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors flex items-center justify-center gap-1 mt-1"
                                                                        >
                                                                            {isExpanded ? <>ì ‘ê¸° <Icon d={PATHS.down} size={12} className="rotate-180"/></> : <>+{hiddenCount}ëª… ë” ë³´ê¸° <Icon d={PATHS.down} size={12}/></>}
                                                                        </button>
                                                                    )}
                                                                    {g.length === 0 && (
                                                                        <div className="flex-1 flex items-center justify-center text-slate-300 text-xs border-2 border-dashed border-slate-100 rounded-xl min-h-[60px]">ë¹ˆ ëª¨ë‘ </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ); })}
                                                    </div>
                                                ) : (
                                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-4"><Icon d={PATHS.users} size={48} className="opacity-20"/><p>í¸ì„±ëœ ëª¨ë‘  ì—†ìŒ</p></div>
                                                )}
                                            </div>
                                        </div>
                                        {groups.length > 0 && (
                                            <div className="h-auto flex-shrink-0 transition-all duration-300">
                                                {aiReason && (
                                                    <div className="bg-violet-50 p-4 rounded-2xl border border-violet-100 mb-4 animate-fade-in relative shadow-sm">
                                                        <button onClick={() => setAiReason(null)} className="absolute top-2 right-2 text-violet-300 hover:text-violet-500 p-1"><Icon d={PATHS.x} size={14}/></button>
                                                        <h4 className="font-bold text-violet-700 mb-2 flex items-center gap-2 text-sm"><Icon d={PATHS.magic} size={16}/> AI í¸ì„± ë¦¬í¬íŠ¸</h4>
                                                        <p className="text-xs text-violet-800 leading-relaxed whitespace-pre-wrap mb-3">{aiReason}</p>
                                                        <div className="flex justify-end gap-2 border-t border-violet-200/50 pt-3">
                                                            <Btn onClick={generateGroups} disabled={isGenerating} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm">
                                                                {isGenerating ? <Icon d={PATHS.spinner} size={12} className="animate-spin"/> : <Icon d={PATHS.magic} size={12}/>} ë‹¤ì‹œ í¸ì„±
                                                            </Btn>
                                                            <div className="w-px h-6 bg-violet-200 mx-1"></div>
                                                            <Btn onClick={handleCopyAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.copy} size={12}/> ë³µì‚¬</Btn>
                                                            <Btn onClick={handleSaveAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.download} size={12}/> ì €ì¥</Btn>
                                                        </div>
                                                    </div>
                                                )}
                                                <BalanceVisualizer groups={groups} students={students} groupNames={groupNames} date={date} />
                                            </div>
                                        )}
                                        <SeatChart students={students} seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments} seatConfig={seatConfig} setSeatConfig={setSeatConfig} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} groups={groups} onGroupsChange={handleGroupsChange} groupNumber={groupNumber} groupMethod={groupMethod} roleMap={roleMap} onOpenStudentInfo={(id) => setGrassStudentId(id)} />
                                    </div>
                                </div>
                            )}
                        </div>
                        {mode === 'stats' && (
                             <div className="max-w-5xl mx-auto space-y-6 animate-fade-in pb-10">
                                <div className="flex justify-end items-center gap-2">
                                    <Btn onClick={() => setShowWeeklyBriefing(true)} disabled={isGenerating} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'} ${isGenerating ? 'opacity-50' : ''}`}>
                                        <Icon d={PATHS.magic} size={16} /> AI ì£¼ê°„ ë¸Œë¦¬í•‘
                                    </Btn>
                                    <button onClick={(e) => { e.stopPropagation(); setShowBriefingHelp(true); }} className="text-slate-400 hover:text-indigo-500 p-2 rounded-full hover:bg-slate-100 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={20} /></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸ†</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><div className="flex items-center gap-2"><div className="relative"><select value={honorTag} onChange={(e) => setHonorTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={honorPeriod} onChange={setHonorPeriod} /></div></div></div><div className="space-y-3">{stats.top5.map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-yellow-50/50 rounded-xl border border-yellow-100"><div className="flex items-center gap-3"><span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${i===0?'bg-yellow-500 text-white':i===1?'bg-slate-400 text-white':i===2?'bg-orange-400 text-white':'bg-slate-200 text-slate-500'}`}>{i+1}</span><span className="font-bold text-slate-700">{s.name}</span></div><span className="font-bold text-indigo-600">{s.honorStats.count}íšŒ</span></div>))}{stats.top5.length === 0 && <div className="text-center text-slate-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div>
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸ“£</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ğŸ“£ ë„ì›€ì´ í•„ìš”í•´ìš”</h3><div className="flex items-center gap-2"><div className="relative"><select value={helpTag} onChange={(e) => setHelpTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={helpPeriod} onChange={setHelpPeriod} /></div></div></div><div className="space-y-3">{stats.bottom5.filter(s => s.helpStats.rate < 100).map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-rose-50/50 rounded-xl border border-rose-100"><div className="flex items-center gap-3"><span className="font-bold text-slate-700">{s.name}</span></div><div className="flex items-center gap-2"><div className="w-24 h-2 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-rose-400" style={{width:`${s.helpStats.rate}%`}}></div></div><span className="font-bold text-rose-500 text-sm">{Math.round(s.helpStats.rate)}%</span></div></div>))}{stats.bottom5.filter(s => s.helpStats.rate < 100).length === 0 && <div className="text-center text-slate-400 py-4">ëª¨ë‘ ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‰</div>}</div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <MissingView students={students} records={records} dailyTasks={dailyTasks} />
                                    <StickerAutomationView students={students} records={records} dailyTasks={dailyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} setStudents={setStudents} />
                                </div>
                                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden mt-6">
                                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸŒ±</div>
                                    <div className="flex justify-between items-center mb-6 relative z-10">
                                        <h3 onClick={handleGrassTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-pointer select-none"><span className="text-xl">ğŸŒ±</span> í™œë™ ì”ë”” (30ì¼)</h3>
                                        <Btn onClick={handleExportDrafts} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1 shadow-sm transition-transform active:scale-95">
                                            <Icon d={PATHS.upload} size={14} /> ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸°
                                        </Btn>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 relative z-10">{stats.students.map(s => (<div key={s.id} onClick={() => setGrassStudentId(s.id)} className="flex items-center gap-3 p-2 bg-slate-50 border border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 hover:shadow-sm transition-all group"><div className="w-8 h-8 rounded-full bg-white border flex items-center justify-center font-bold text-xs text-slate-500 overflow-hidden">{s.photo ? <img src={s.photo} className="w-full h-full object-cover" alt={s.name} /> : s.order}</div><div className="flex flex-col min-w-0"><span className="text-sm font-bold text-slate-700 truncate">{s.name}</span><div className="flex gap-0.5 mt-1">{s.history.slice(0,5).map((h,i) => (<div key={i} className="w-2 h-2 rounded-full" style={h.ratio > 0 ? { background: `conic-gradient(#4ade80 0% ${h.ratio*100}%, #e2e8f0 ${h.ratio*100}% 100%)` } : { backgroundColor: '#e2e8f0' }}></div>))}</div></div></div>))}</div>
                                </div>
                            </div>
                        )}
                        <footer onClick={() => setShowUpdateNotes(true)} className="md:hidden text-center py-4 text-[10px] text-slate-400 cursor-pointer hover:text-indigo-500 transition-colors">{CURRENT_VERSION} | Visual Studio Code With Gemini</footer>
                    </main>
                    <footer onClick={() => setShowUpdateNotes(true)} className="hidden md:block text-center py-2 text-xs text-slate-400 bg-slate-50 hover:bg-slate-100 border-t border-slate-200 cursor-pointer hover:text-indigo-500 transition-colors">{CURRENT_VERSION} | Visual Studio Code With Gemini</footer>
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-30 pb-safe">
                        <div className="flex justify-around items-center h-14">
                            {[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (
                                <button key={m.id} onClick={()=>setMode(m.id)} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mode===m.id ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                    <div className={`p-1 rounded-xl transition-all ${mode===m.id ? 'bg-indigo-50 transform -translate-y-1' : ''}`}><Icon d={m.icon} size={20} strokeWidth={mode===m.id?2.5:2} /></div>
                                    <span className={`text-[10px] font-bold mt-0.5 ${mode===m.id ? 'text-indigo-600' : 'text-slate-400'}`}>{m.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        message={confirmModal.message} 
                        onConfirm={() => { 
                            const action = confirmModal.onConfirm;
                            setConfirmModal({isOpen:false, message:"", onConfirm:null}); 
                            if(action) action();
                        }} 
                        onCancel={()=>setConfirmModal({isOpen:false, message:"", onConfirm:null})} 
                    />
                    {appConfig.updateNotificationType === 'toast' ? (
                        <UpdateNotificationToast
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    ) : (
                        <UpdateNotificationModal
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    )}
                    <Toast message={toastMessage} onClose={()=>setToastMessage(null)} />
                    <StatsGrassModal 
                        isOpen={!!grassStudentId} 
                        onClose={()=>setGrassStudentId(null)} 
                        student={stats.students.find(s=>s.id===grassStudentId)} 
                        students={students}
                        records={records} 
                        dates={Object.keys(records).sort()} 
                        dailyTasks={dailyTasks} 
                        onSaveCounseling={handleSaveCounseling} 
                        onSaveStickers={handleSaveStickers} 
                        onSaveStickerWithNote={handleSaveStickerWithNote} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        appConfig={appConfig} 
                        apiKey={apiKey} 
                        onSaveRecordDraft={handleSaveRecordDraft}
                        isLocalMode={isLocalMode}
                        db={db}
                        appId={appId}
                        isPortfolioMode={isPortfolioMode}
                        setStudents={setStudents}
                        saveData={saveData} />
                    <SettingsModal 
                        isOpen={isSettingOpen} 
                        onClose={()=>setIsSettingOpen(false)} 
                        students={students} 
                        setStudents={setStudents} 
                        appConfig={appConfig} 
                        setAppConfig={setAppConfig} 
                        isLocalMode={isLocalMode} 
                        saveData={saveData} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        handleResetAllData={handleResetAllData} 
                        onOpenSetup={() => setIsSetupOpen(true)}
                        onOpenNotionSetup={() => setIsNotionSetupOpen(true)}
                        onOpenGoogleSheetSetup={() => setIsGoogleSheetSetupOpen(true)}
                        onOpenApiKeySetup={() => setIsApiKeySetupOpen(true)}
                        records={records} 
                        groupsByDate={groupsByDate} 
                        avoidancePairs={avoidancePairs} 
                        dailyTasks={dailyTasks} 
                        weeklyTasks={weeklyTasks} 
                        tags={tags} 
                        setRecords={setRecords} 
                        setGroupsByDate={setGroupsByDate} 
                        setAvoidancePairs={setAvoidancePairs} 
                        setDailyTasks={setDailyTasks} 
                        setWeeklyTasks={setWeeklyTasks} 
                        setTags={setTags} 
                        backupTimes={backupTimes} 
                        setBackupTimes={setBackupTimes} 
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                        mustPairs={mustPairs} setMustPairs={setMustPairs}
                        groupNames={groupNames} setGroupNames={setGroupNames}
                        groupRoles={groupRoles} setGroupRoles={setGroupRoles}
                        rolesList={rolesList} setRolesList={setRolesList}
                        roleDescriptions={roleDescriptions} setRoleDescriptions={setRoleDescriptions}
                        seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments}
                        seatConfig={seatConfig} setSeatConfig={setSeatConfig}
                        db={db}
                        appId={appId}
                        deferredPrompt={deferredPrompt}
                        isIOS={isIOS}
                        isStandalone={isStandalone}
                        onInstallApp={handleInstallApp}
                        isDevMode={isDevMode}
                        onDevModeClick={handleGearClick}
                        onTestUpdate={() => setNewVersionAvailable(true)}
                    />
                    <NotionSetupModal isOpen={isNotionSetupOpen} onClose={() => setIsNotionSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} isPortfolioMode={isPortfolioMode} setIsPortfolioMode={setIsPortfolioMode} studentMap={studentMap} setStudentMap={setStudentMap} portfolioDbId={portfolioDbId} setPortfolioDbId={setPortfolioDbId} />
                    <GoogleSheetSetupModal isOpen={isGoogleSheetSetupOpen} onClose={() => setIsGoogleSheetSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} />
                    <ApiKeySetupModal isOpen={isApiKeySetupOpen} onClose={() => setIsApiKeySetupOpen(false)} apiKey={apiKey} setApiKey={setApiKey} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} validateApiKey={validateApiKey} />
                    <InstallGuideModal isOpen={showInstallGuide} onClose={() => setShowInstallGuide(false)} onInstall={confirmInstall} isIOS={isIOS} />
                    <TaskModal isOpen={isTaskModalOpen} onClose={()=>setIsTaskModalOpen(false)} date={date} dailyTasks={dailyTasks} setDailyTasks={setDailyTasks} weeklyTasks={weeklyTasks} setWeeklyTasks={setWeeklyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} tags={tags} setTags={setTags} openConfirm={openConfirm} />
                    <CalendarModal isOpen={isCalendarOpen} onClose={()=>setIsCalendarOpen(false)} currentDate={date} onSelectDate={setDate} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <CalendarModal isOpen={isRangeCalendarOpen} onClose={()=>setIsRangeCalendarOpen(false)} currentDate={date} selectionMode="range" onSelectRange={handleRangeSelect} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <RoleHelpModal isOpen={showRoleHelp} onClose={()=>setShowRoleHelp(false)} roleDescriptions={roleDescriptions} />
                    <RoleEditModal isOpen={isRoleEditOpen} onClose={() => setIsRoleEditOpen(false)} roles={rolesList} onSave={handleSaveRoles} roleDescriptions={roleDescriptions} onSaveDescriptions={handleSaveRoleDescriptions} />
                    <PartnerAnalysisModal isOpen={showPartnerAnalysis} onClose={()=>setShowPartnerAnalysis(false)} groupsByDate={groupsByDate} />
                    <ClassToolsModal isOpen={isToolsOpen} onClose={() => setIsToolsOpen(false)} students={students} />
                    <BaseModal isOpen={showAiHelp} onClose={()=>setShowAiHelp(false)} title="AI ëª¨ë‘  í¸ì„± ë„ì›€ë§" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">
                            <p><strong>ì‚¬ìš© ë°©ë²•:</strong><br/>ì›í•˜ëŠ” ëª¨ë‘  êµ¬ì„± ì¡°ê±´ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.</p>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <strong>ğŸ’¡ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ</strong>
                                <ul className="list-disc pl-4 mt-2 space-y-1">
                                    <li>ë‚¨ë…€ ì„±ë¹„ë¥¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì¤˜</li>
                                    <li>ë¦¬ë”(ì´ë„ë¯¸)ê°€ ê° ëª¨ë‘ ì— í•œ ëª…ì”© ë“¤ì–´ê°€ê²Œ í•´ì¤˜</li>
                                    <li>ìˆ˜í•™ ì‹¤ë ¥ì´ ìƒ/ì¤‘/í•˜ ê³¨ê³ ë£¨ ì„ì´ê²Œ í•´ì¤˜</li>
                                    <li>íŠ¹ì • í•™ìƒ(ì˜ˆ: ì² ìˆ˜, ì˜í¬)ì€ ê°™ì€ ëª¨ë‘ ì´ ë˜ì§€ ì•Šê²Œ í•´ì¤˜</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Weekly Briefing Modal */}
                    <BaseModal isOpen={showWeeklyBriefing} onClose={() => setShowWeeklyBriefing(false)} title="ğŸ“Š AI ì£¼ê°„ ë¸Œë¦¬í•‘" icon={PATHS.magic}>
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                        <input type="date" value={briefingStart} onChange={e=>setBriefingStart(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                        <span className="text-xs text-slate-400">~</span>
                                        <input type="date" value={briefingEnd} onChange={e=>setBriefingEnd(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¸Œë¦¬í•‘ ì–´ì¡°:</span>
                                        <div className="flex bg-white rounded-lg border border-slate-200 p-1 flex-1">
                                            <button onClick={()=>setBriefingTone('encouraging')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='encouraging'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ğŸ¥° ê²©ë ¤</button>
                                            <button onClick={()=>setBriefingTone('analytical')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='analytical'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š ë¶„ì„</button>
                                            <button onClick={()=>setBriefingTone('concise')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='concise'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>âš¡ ê°„ê²°</button>
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateBriefing} className="w-full py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ë¸Œë¦¬í•‘ ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-4">
                                    <div className="w-full max-w-xs bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div className="bg-indigo-500 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${generationProgress}%` }}></div>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm font-bold text-indigo-600">
                                        <Icon d={PATHS.spinner} size={16} className="animate-spin"/>
                                        <span>ë°ì´í„° ë¶„ì„ ì¤‘... {Math.round(generationProgress)}%</span>
                                    </div>
                                </div>
                            ) : aiContent && (
                                <div ref={briefingRef} className="bg-slate-50 p-6 rounded-2xl border border-slate-200 leading-relaxed whitespace-pre-wrap text-slate-700">
                                    {aiContent || "ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={() => setAiContent("")} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ë‹¤ì‹œ í•˜ê¸°</Btn>
                                        <Btn onClick={handleDownloadBriefingPdf} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.download} size={16} /> PDF
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.copy} size={16} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowWeeklyBriefing(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Briefing Help Modal */}
                    <BaseModal isOpen={showBriefingHelp} onClose={() => setShowBriefingHelp(false)} title="AI ì£¼ê°„ ë¸Œë¦¬í•‘ì´ë€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì„ íƒí•œ ê¸°ê°„ ë™ì•ˆì˜ í•™ê¸‰ ê¸°ë¡(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ì„ ë¶„ì„í•˜ì—¬ <strong>í•™ê¸‰ ìš´ì˜ì— ë„ì›€ì´ ë˜ëŠ” ì¸ì‚¬ì´íŠ¸</strong>ë¥¼ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <h4 className="font-bold text-indigo-700 mb-2">âœ¨ ì£¼ìš” ê¸°ëŠ¥ ë° í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>ê¸°ê°„ ì„¤ì •:</strong> ì›í•˜ëŠ” ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ê°„, ì›”ê°„, ë˜ëŠ” íŠ¹ì • ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>í•™ìŠµ ë¶„ìœ„ê¸° íŒŒì•…:</strong> ì „ì²´ì ì¸ ê³¼ì œ ìˆ˜í–‰ë¥  ì¶”ì„¸ë¥¼ í†µí•´ í•™ê¸‰ ë¶„ìœ„ê¸°ê°€ ì–´ë–»ê²Œ ë³€í™”í•˜ê³  ìˆëŠ”ì§€ í•œëˆˆì— ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>ë§ì¶¤í˜• ì¡°ì–¸:</strong> ë°ì´í„° ë¶„ì„ì„ í†µí•´ ì„ ìƒë‹˜ì—ê²Œ í•„ìš”í•œ ê²©ë ¤ì™€ êµ¬ì²´ì ì¸ í•™ê¸‰ ìš´ì˜ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ğŸ° í•™ê¸‰ ì„¸ê³„ê´€ ìŠ¤í† ë¦¬" icon={PATHS.book} zIndex="z-[2000]">
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 space-y-3">
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold text-purple-700">ì¥ë¥´ ì„ íƒ:</span>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                            {[
                                                {id:'school', emoji:'ğŸ«', label:'í•™êµ'},
                                                {id:'adventure', emoji:'ğŸ—ºï¸', label:'ëª¨í—˜'},
                                                {id:'fairytale', emoji:'ğŸ»', label:'ë™í™”'},
                                                {id:'detective', emoji:'ğŸ•µï¸', label:'íƒì •'},
                                                {id:'hero', emoji:'ğŸ¦¸', label:'íˆì–´ë¡œ'}
                                            ].map(g => (
                                                <button key={g.id} onClick={()=>setStoryGenre(g.id)} className={`flex flex-col items-center justify-center py-3 rounded-xl border-2 transition-all ${storyGenre===g.id?'bg-purple-50 border-purple-500 text-purple-700 shadow-md scale-105':'bg-white border-transparent hover:bg-purple-50 hover:border-purple-200 text-slate-500'}`}>
                                                    <span className="text-2xl mb-1">{g.emoji}</span>
                                                    <span className="text-xs font-bold">{g.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateStory} className="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold hover:shadow-lg transition-all text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ì´ì•¼ê¸° ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ëª¨í—˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : aiContent && (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2 flex-wrap">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={handleGenerateStory} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200 flex items-center gap-1">
                                            <Icon d={PATHS.magic} size={14} /> ë‹¤ì‹œ ì“°ê¸°
                                        </Btn>
                                        <Btn onClick={() => setAiContent("")} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">
                                            ë‹¤ë¥¸ ì¥ë¥´ë¡œ
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ìŠ¤í† ë¦¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-1">
                                            <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowClassStory(false)} className="px-3 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ğŸ° í•™ê¸‰ ì„¸ê³„ê´€ ìŠ¤í† ë¦¬" icon={PATHS.book}>
                        <div className="space-y-4">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ëª¨í—˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                <Btn onClick={handleGenerateStory} disabled={isGenerating} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200">ë‹¤ì‹œ ì“°ê¸°</Btn>
                                <Btn onClick={() => setShowClassStory(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>
                    
                    {/* Story Help Modal */}
                    <BaseModal isOpen={showStoryHelp} onClose={() => setShowStoryHelp(false)} title="í•™ê¸‰ ì„¸ê³„ê´€ ìŠ¤í† ë¦¬ë€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì˜¤ëŠ˜ í•˜ë£¨ ìš°ë¦¬ ë°˜ì˜ í™œë™ ë°ì´í„°(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ <strong>íŒíƒ€ì§€ ëª¨í—˜ ì´ì•¼ê¸°</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                            
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-slate-700 mb-2">ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
                                <ol className="list-decimal pl-5 space-y-1">
                                    <li>ì˜¤ëŠ˜ì˜ ê³¼ì œ ì²´í¬ì™€ ìŠ¤í‹°ì»¤ ì§€ê¸‰ì„ ì™„ë£Œí•©ë‹ˆë‹¤.</li>
                                    <li><strong>'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ìŠ¤í† ë¦¬ ë³´ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                                    <li>AIê°€ ì‘ì„±í•œ ìš°ë¦¬ ë°˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ í•¨ê»˜ ì½ìŠµë‹ˆë‹¤.</li>
                                </ol>
                            </div>

                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <h4 className="font-bold text-purple-700 mb-2">âœ¨ í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li>í•˜êµ ì‹œê°„ì— ì•„ì´ë“¤ê³¼ í•¨ê»˜ ì½ìœ¼ë©° í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•´ìš”.</li>
                                    <li>ê³¼ì œ ìˆ˜í–‰ë¥ ì´ ë†’ìœ¼ë©´ 'ìŠ¹ë¦¬í•œ ì´ì•¼ê¸°'ê°€, ë‚®ìœ¼ë©´ 'ìœ„ê¸°ì˜ ì´ì•¼ê¸°'ê°€ ë‚˜ì˜µë‹ˆë‹¤.</li>
                                    <li>ì•„ì´ë“¤ì´ 'ìš©ì‚¬'ê°€ ë˜ì–´ í•™ê¸‰ í™œë™ì— ë” ëª°ì…í•˜ê²Œ ë„ì™€ì¤ë‹ˆë‹¤.</li>
                                </ul>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h4 className="font-bold text-slate-700 mb-2">ğŸ“œ ì´ì•¼ê¸° ì˜ˆì‹œ</h4>
                                <p className="italic text-slate-500 text-xs bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">
                                    "ì˜¤ëŠ˜ ìš°ë¦¬ 3í•™ë…„ 2ë°˜ ëª¨í—˜ê°€ë“¤ì€ 'ìˆ˜í•™ ìµí˜ì±…'ì´ë¼ëŠ” ê±°ëŒ€í•œ ëª¬ìŠ¤í„°ë¥¼ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤. ì´ˆë°˜ì—ëŠ” ëª‡ëª‡ ìš©ì‚¬ë“¤ì´ ì—°ì‚°ì˜ ëŠªì— ë¹ ì ¸ í—ˆìš°ì ëŒ”ì§€ë§Œ, ê³§ ì„œë¡œë¥¼ ë•ëŠ” í˜‘ë™ ìŠ¤í‚¬ì„ ë°œíœ˜í•˜ì—¬ 95%ì˜ í€˜ìŠ¤íŠ¸ ë‹¬ì„±ë¥ ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤! ì˜¤ëŠ˜ íšë“í•œ ì „ë¦¬í’ˆ(ì¹­ì°¬ ìŠ¤í‹°ì»¤)ì€ ì´ 15ê°œ! ëª¨í—˜ê°€ë“¤ì€ ìŠ¹ë¦¬ì˜ ê¸°ì¨ì„ ë§Œë½í•˜ë©° ë‚´ì¼ ìˆì„ 'ë°›ì•„ì“°ê¸°' ë˜ì „ì„ ì¤€ë¹„í•˜ê¸° ìœ„í•´ ê°ìì˜ ì•ˆì‹ì²˜ë¡œ ê·€í™˜í–ˆìŠµë‹ˆë‹¤."
                                </p>
                            </div>
                        </div>
                    </BaseModal>
                    
                        <SetupModal 
                        isOpen={isSetupOpen} 
                        onClose={() => setIsSetupOpen(false)} 
                        showToast={setToastMessage} 
                        onConnect={handleFirebaseConnect} 
                    />
                    <BaseModal isOpen={showOfflineModal} onClose={() => setShowOfflineModal(false)} title="ì¤€ë¹„ ì™„ë£Œ!" icon={PATHS.check}>
                        <div className="text-center space-y-4 py-4">
                            <div className="text-6xl animate-bounce">ğŸ‘Œ</div>
                            <h3 className="text-lg font-bold text-slate-800">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</h3>
                            <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-sm text-indigo-700">
                                ì´ì œ ì¸í„°ë„·ì„ ëŠì–´ë„ ë©ë‹ˆë‹¤.<br/>(ìƒˆë¡œê³ ì¹¨ ê¸ˆì§€)
                            </div>
                        </div>
                        <Btn onClick={() => setShowOfflineModal(false)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mt-2">
                            í™•ì¸ ({autoCloseTimer}ì´ˆ í›„ ë‹«í˜)
                        </Btn>
                    </BaseModal>
                    <UpdateNotesModal isOpen={showUpdateNotes} onClose={() => setShowUpdateNotes(false)} showToast={setToastMessage} />
                    {showGlobalRecord && (
                        <GlobalRecordModal isOpen={showGlobalRecord} onClose={() => setShowGlobalRecord(false)} students={students} setStudents={setStudents} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} buttonPos={buttonPos} appConfig={appConfig} />
                    )}
                    <AiSecurityCheckModal isOpen={aiCheckState.isOpen} onClose={handleAiCheckCancel} prompt={aiCheckState.prompt} onConfirm={handleAiCheckConfirm} />
                    <button 
                        onMouseEnter={() => { setIsHidden(false); if(hideTimer.current) clearTimeout(hideTimer.current); }}
                        onMouseDown={handleButtonDragStart}
                        onTouchStart={handleButtonDragStart}
                        onClick={() => { if (!isDragGesture.current) { setShowGlobalRecord(true); resetButtonIdleTimer(); } }}
                        style={{ 
                            left: buttonPos.x, 
                            top: buttonPos.y,
                            transform: isHidden ? (buttonPos.x < window.innerWidth / 2 ? 'translateX(-50px)' : 'translateX(50px)') : 'none'
                        }}
                        className={`fixed z-[1500] w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center group ${isDraggingButton ? '' : 'transition-all duration-300 hover:bg-indigo-700 hover:scale-105'} ${isHidden ? 'opacity-50' : (isButtonIdle ? 'opacity-30 hover:opacity-100' : 'opacity-100')}`}
                        title="ë¹ ë¥¸ ê´€ì°° ê¸°ë¡"
                    >
                        <Icon d={PATHS.edit} size={24} />
                        <span className={`absolute bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none ${buttonPos.x < window.innerWidth / 2 ? 'left-full ml-3' : 'right-full mr-3'}`}>ë¹ ë¥¸ ê¸°ë¡</span>
                    </button>
                </div>
            );
        };

        const SwitchToggle = ({ value, onChange }) => (
                <>
                    <div className="md:hidden relative">
                        <select value={value} onChange={(e) => onChange(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">
                            <option value="weekly">ì£¼ê°„</option>
                            <option value="monthly">ì›”ê°„</option>
                            <option value="all">ì „ì²´</option>
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d={PATHS.down} size={12} /></div>
                    </div>
                    <div className="hidden md:flex bg-slate-100 p-1 rounded-xl shadow-inner">
                        <button onClick={() => onChange('weekly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'weekly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì£¼ê°„</button>
                        <button onClick={() => onChange('monthly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'monthly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì›”ê°„</button>
                        <button onClick={() => onChange('all')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'all' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì „ì²´</button>
                    </div>
                </>
        );

        const RoleEditModal = ({ isOpen, onClose, roles, onSave, roleDescriptions, onSaveDescriptions }) => {
            const [tempRoles, setTempRoles] = useState([]);
            const [newRole, setNewRole] = useState("");
            const [editingRole, setEditingRole] = useState(null);
            const [editTitle, setEditTitle] = useState("");
            const [editDesc, setEditDesc] = useState("");

            useEffect(() => { if (isOpen) setTempRoles([...roles]); }, [isOpen, roles]);

            const handleAdd = () => {
                if (newRole.trim()) {
                    setTempRoles([...tempRoles, newRole.trim()]);
                    setNewRole("");
                }
            };

            const handleDelete = (index) => {
                setTempRoles(tempRoles.filter((_, i) => i !== index));
            };

            const handleMove = (index, direction) => {
                const newRoles = [...tempRoles];
                const targetIndex = index + direction;
                if (targetIndex >= 0 && targetIndex < newRoles.length) {
                    [newRoles[index], newRoles[targetIndex]] = [newRoles[targetIndex], newRoles[index]];
                    setTempRoles(newRoles);
                }
            };

            const startEditDesc = (role) => {
                const descData = roleDescriptions[role] || { title: `${role}ì˜ ì—­í• `, desc: [] };
                setEditingRole(role);
                setEditTitle(descData.title);
                setEditDesc(descData.desc.join('\n'));
            };

            const saveDesc = () => {
                const newDescList = editDesc.split('\n').map(l => l.trim()).filter(l => l);
                const newDescriptions = {
                    ...roleDescriptions,
                    [editingRole]: { title: editTitle, desc: newDescList }
                };
                onSaveDescriptions(newDescriptions);
                setEditingRole(null);
            };

            const restoreDefault = () => {
                const def = DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                if (def) {
                    setEditTitle(def.title);
                    setEditDesc(def.desc.join('\n'));
                }
            };

            if (editingRole) {
                const hasDefault = !!DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                return (
                    <BaseModal isOpen={isOpen} onClose={() => setEditingRole(null)} title={`${editingRole} ì„¤ëª… í¸ì§‘`} icon={PATHS.edit} footer={
                        <div className="flex gap-2">
                            <Btn onClick={() => setEditingRole(null)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">ì·¨ì†Œ</Btn>
                            <Btn onClick={saveDesc} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">ì €ì¥</Btn>
                        </div>
                    }>
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between items-center mb-1">
                                    <label className="text-xs font-bold text-slate-500">ì—­í•  íƒ€ì´í‹€</label>
                                    {hasDefault && <Btn onClick={restoreDefault} className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded hover:bg-slate-200">ê¸°ë³¸ê°’ ë³µì›</Btn>}
                                </div>
                                <input value={editTitle} onChange={e => setEditTitle(e.target.value)} className="w-full p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ì˜ˆ: ì¹œêµ¬ë“¤ì„ ë„ì™€ì£¼ëŠ” ë‚˜ëˆ”ì´!" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ìƒì„¸ ì„¤ëª… (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                                <textarea value={editDesc} onChange={e => setEditDesc(e.target.value)} className="w-full h-32 p-2 border rounded-xl text-sm resize-none outline-none focus:border-indigo-500" placeholder="í•  ì¼ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”." />
                            </div>
                        </div>
                    </BaseModal>
                );
            }

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ëª©ë¡ í¸ì§‘" icon={PATHS.edit} footer={<Btn onClick={() => onSave(tempRoles)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">ì €ì¥í•˜ê¸°</Btn>}>
                    <div className="flex gap-2 mb-4"><input value={newRole} onChange={(e) => setNewRole(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.nativeEvent.isComposing && handleAdd()} className="flex-1 p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ìƒˆ ì—­í•  ì´ë¦„" /><Btn onClick={handleAdd} className="bg-indigo-50 text-indigo-600 px-4 rounded-xl font-bold hover:bg-indigo-100">ì¶”ê°€</Btn></div>
                    <div className="space-y-2 max-h-[300px] overflow-y-auto custom-scroll pr-1">{tempRoles.map((role, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-200"><span className="font-bold text-slate-700 text-sm">{i + 1}. {role}</span><div className="flex items-center gap-1"><Btn onClick={() => startEditDesc(role)} className="p-1 text-indigo-400 hover:text-indigo-600" title="ì„¤ëª… ìˆ˜ì •"><Icon d={PATHS.document} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleMove(i, -1)} disabled={i === 0} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} className="rotate-180" size={16} /></Btn><Btn onClick={() => handleMove(i, 1)} disabled={i === tempRoles.length - 1} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleDelete(i)} className="p-1 text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div></div>))}</div>
                    <p className="text-xs text-slate-400 mt-2 text-center">* ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ëª¨ë‘ ì›ì—ê²Œ ë°°ì •ë©ë‹ˆë‹¤.</p>
                </BaseModal>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
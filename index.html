<!DOCTYPE html>
<html lang="ko"><plasmo-csui id="brisk-teaching-extension-shadow-root" data-extension-version="1.0.349" data-extension-name="Brisk Teaching â€“ AI Assistant for Teachers" style="z-index: 2147483647;"></plasmo-csui><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤í–ˆë‚˜ìš”?</title>
    
    <meta property="og:title" content="ë‹¤í–ˆë‚˜ìš”!?">
    <meta property="og:description" content="ìš°ë¦¬ ë°˜ ìˆ™ì œ í™•ì¸ ë° í•™ê¸‰ ê²½ì˜ ë„êµ¬">
    
    
    
    <script src="https://cdn.tailwindcss.com" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/ko.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" data-app-script="true" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" data-app-script="true"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" data-app-script="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js" data-app-script="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" data-app-script="true"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css" data-app-style="true">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&amp;family=Jua&amp;family=Nanum+Gothic:wght@400;700&amp;family=Nanum+Myeongjo:wght@400;700&amp;display=swap" rel="stylesheet">

    <script data-app-script="true">
        dayjs.locale('ko');
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: { 50: '#F7F7F5', 100: '#E9E9E7', 500: '#37352F', 600: '#2F2F2F', 700: '#191711' },
                        notion: {
                            bg: '#FFFFFF',
                            'bg-hover': '#F1F1EF',
                            'bg-alt': '#F7F7F5',
                            text: '#37352F',
                            'text-light': 'rgba(55, 53, 47, 0.65)',
                            border: '#E9E9E7',
                            red: '#E03E3E',
                            blue: '#0B6E99',
                            green: '#0F7B6C',
                            orange: '#D9730D',
                            yellow: '#DFAB01',
                            purple: '#6940A5',
                            pink: '#AD1A72',
                        }
                    },
                    fontFamily: { 
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Helvetica', '"Apple Color Emoji"', 'Arial', 'sans-serif', '"Segoe UI Emoji"', '"Segoe UI Symbol"'],
                        serif: ['Lyon-Text', 'Georgia', 'YuMincho', '"Yu Mincho"', '"Hiragino Mincho ProN"', '"Hiragino Mincho Pro"', '"Songti SC"', '"Shimsong"', 'serif'],
                        hand: ['"Gaegu"', 'cursive'],
                        jua: ['"Jua"', 'sans-serif'],
                        nanum: ['"Nanum Gothic"', 'sans-serif'],
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'pop-up': 'popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'modal-enter': 'modalEnter 0.25s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'expand-from': 'expandFrom 0.25s cubic-bezier(0.16, 1, 0.3, 1)',
                        'blink-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blink-strong': 'blinkStrong 0.4s ease-in-out infinite',
                        'zoom-out': 'zoomOut 0.3s ease-in-out forwards',
                        'zoom-in': 'zoomIn 0.3s ease-in-out forwards',
                        'zoom-out-reverse': 'zoomOutReverse 0.3s ease-in-out forwards',
                        'zoom-in-reverse': 'zoomInReverse 0.3s ease-in-out forwards',
                        'slide-out-left': 'slideOutLeft 0.2s ease-in-out forwards',
                        'slide-out-right': 'slideOutRight 0.2s ease-in-out forwards',
                        'slide-in-right-fwd': 'slideInRight 0.2s ease-in-out forwards',
                        'slide-in-left-fwd': 'slideInLeft 0.2s ease-in-out forwards',
                    },
                    keyframes: {
                        bounceIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        fadeIn: { 'from': { opacity: 0 }, 'to': { opacity: 1 } },
                        popUp: { 'from': { transform: 'translate(-50%, -40%) scale(0.9)', opacity: 0 }, 'to': { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 } },
                        modalEnter: { '0%': { opacity: 0, transform: 'scale(0.95) translateY(10px)' }, '100%': { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        slideInRight: { '0%': { transform: 'translateX(20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInLeft: { '0%': { transform: 'translateX(-20%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInRight: { '0%': { transform: 'translateX(50%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        slideInLeft: { '0%': { transform: 'translateX(-50%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        expandFrom: { '0%': { transform: 'scale(0)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        slideInDown: { '0%': { transform: 'translate(-50%, -100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                        blinkStrong: { '0%, 100%': { opacity: 1, transform: 'scale(1)' }, '50%': { opacity: 0.4, transform: 'scale(1.15)' } },
                        zoomOut: { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(1.15)', opacity: 0 } },
                        zoomIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        zoomOutReverse: { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.9)', opacity: 0 } },
                        zoomInReverse: { '0%': { transform: 'scale(1.15)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        slideOutLeft: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(-20%)', opacity: 0 } },
                        slideOutRight: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(20%)', opacity: 0 } },
                        slideOutLeft: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(-50%)', opacity: 0 } },
                        slideOutRight: { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(50%)', opacity: 0 } },
                    }
                }
            }
        }
    </script>
    <style data-app-style="true">
        /* ğŸŒŸ ì´ í•œ ì¤„ì´ í™”ë©´ ë°‘ì˜ ëª¨ë“  ìœ ë ¹ ì—¬ë°±ì„ ê°•ì œë¡œ ì˜ë¼ëƒ…ë‹ˆë‹¤! */
        #root > div { padding-bottom: 20px !important; margin-bottom: 0 !important; }
        
        /* ğŸŒŸ ëª» ì°¾ìœ¼ì…¨ë‹¤ë©´ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”! (main íƒœê·¸ì˜ í•˜ë‹¨ ì—¬ë°± ê°•ì œ ì¶•ì†Œ) */
        main { padding-bottom: 60px !important; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .dragging { opacity: 0.5; transform: scale(0.98); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .drag-over { background-color: #eff6ff; border-color: #3b82f6 !important; border-width: 2px !important; transform: scale(1.02); box-shadow: 0 0 0 2px #3b82f6; z-index: 10; }
        .seat-cell { position: relative; }
        .seat-cell.drag-over::after {
            content: '+';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #22c55e;
            font-size: 3rem;
            font-weight: 800;
            border-radius: 0.75rem;
            pointer-events: none;
            z-index: 50;
            border: 2px dashed #22c55e;
        }
        body.is-dragging-seat .seat-cell * { pointer-events: none !important; }
        body.is-dragging-seat .student-card { pointer-events: none !important; opacity: 0.5; }
        body.is-dragging-seat img { pointer-events: none !important; }
        body.is-dragging-group .group-card * { pointer-events: none !important; }
        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ëª¨ë“  ìì‹ ìš”ì†Œì˜ ì´ë²¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ì—¬ ë“œë¡­ ì˜ì—­ ê°ì§€ìœ¨ì„ ë†’ì„ */
        body.is-dragging-seat * {
            cursor: grabbing !important;
        }
        body.is-dragging-seat .student-card,
        body.is-dragging-seat .seat-cell * {
            pointer-events: none !important;
        }
/* ë“œë¡­ ê°€ëŠ¥í•œ ì˜ì—­(ì¢Œì„)ì€ ì´ë²¤íŠ¸ ë°›ê¸° í—ˆìš© */
        body.is-dragging-seat .seat-cell {
            pointer-events: auto !important;
        }
    </style>
<link id="app-favicon" rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKIAAACiCAYAAADC8hYbAAAAonpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabY/RDcMgDET/PUVHsAEfMA6RgpQNOn5NTEqi9n44nuE4aH8fnV5DgkBJc0EF2JRqqqGZKewyKo2F1bw4Uvgq25OT7m5CMRTXgIMvUYwMv83sKygavZ2ny6CWzGkN8gziVW4m/N+TMgp6TugaESGZoV6Fz389Wn7bGr892sJodF76HdxFH9KoQ6jnsTyoAAANhmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6QXR0cmliPSJodHRwOi8vbnMuYXR0cmlidXRpb24uY29tL2Fkcy8xLjAvIgogICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgeG1sbnM6cGRmPSJodHRwOi8vbnMuYWRvYmUuY29tL3BkZi8xLjMvIgogICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpleGlmPSJodHRwOi8vbnMuYWRvYmUuY29tL2V4aWYvMS4wLyIKICAgcGRmOkF1dGhvcj0i7KGw7JWE6528IgogICB4bXA6Q3JlYXRvclRvb2w9IkNhbnZhIChSZW5kZXJlcikgZG9jPURBSEFoYkxuYXo0IHVzZXI9VUFGYjdQaHh2bTQgYnJhbmQ9TU1WIEdMT0JBTCDri5jsnZgg7YyAIgogICB0aWZmOlhSZXNvbHV0aW9uPSI5Ni8xIgogICB0aWZmOllSZXNvbHV0aW9uPSI5Ni8xIgogICB0aWZmOlJlc29sdXRpb25Vbml0PSIyIgogICB0aWZmOlNvZnR3YXJlPSJQaG90b1NjYXBlIgogICBleGlmOkNvbG9yU3BhY2U9IjEiCiAgIGV4aWY6UGl4ZWxYRGltZW5zaW9uPSIxNjIiCiAgIGV4aWY6UGl4ZWxZRGltZW5zaW9uPSIxNjIiPgogICA8QXR0cmliOkFkcz4KICAgIDxyZGY6U2VxPgogICAgIDxyZGY6bGkKICAgICAgQXR0cmliOkNyZWF0ZWQ9IjIwMjYtMDItMDYiCiAgICAgIEF0dHJpYjpEYXRhPSJ7JnF1b3Q7ZG9jJnF1b3Q7OiZxdW90O0RBSEFoYkxuYXo0JnF1b3Q7LCZxdW90O3VzZXImcXVvdDs6JnF1b3Q7VUFGYjdQaHh2bTQmcXVvdDssJnF1b3Q7YnJhbmQmcXVvdDs6JnF1b3Q7TU1WIEdMT0JBTCDri5jsnZgg7YyAJnF1b3Q7fSIKICAgICAgQXR0cmliOkV4dElkPSI2MGI2Y2QxZS00ODE1LTQwN2ItYmI3Ny1kOWYxNmY3NWE1MTkiCiAgICAgIEF0dHJpYjpGYklkPSI1MjUyNjU5MTQxNzk1ODAiCiAgICAgIEF0dHJpYjpUb3VjaFR5cGU9IjIiLz4KICAgIDwvcmRmOlNlcT4KICAgPC9BdHRyaWI6QWRzPgogICA8ZGM6dGl0bGU+CiAgICA8cmRmOkFsdD4KICAgICA8cmRmOmxpIHhtbDpsYW5nPSJ4LWRlZmF1bHQiPjAyLiAwNi4gLSAxPC9yZGY6bGk+CiAgICA8L3JkZjpBbHQ+CiAgIDwvZGM6dGl0bGU+CiAgPC9yZGY6RGVzY3JpcHRpb24+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg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"><link rel="apple-touch-icon" href="data:image/png;base64,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"><link id="app-manifest" rel="manifest" href="blob:https://checklist-zeta-woad.vercel.app/a4f22af6-4a87-4819-95cd-4ddd8a0ce4fd"></head>
<body class="bg-white text-[#37352F] select-none overscroll-y-none md:overscroll-y-auto" __processed_ead473d2-53c5-4776-8448-f41133475e12__="true" style="zoom: 100%; --ui-scale: 1;">
    <div id="root" class="min-h-screen flex flex-col" style="height: 100vh;"></div>

    <script type="text/babel" data-app-script="true">
        const safeLocalStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { return window._memStore ? window._memStore[key] : null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { if (!window._memStore) window._memStore = {}; window._memStore[key] = value; }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } 
                catch (e) { if (window._memStore) delete window._memStore[key]; }
            }
        };
        
        const updateAiUsage = () => {
            const current = parseInt(localStorage.getItem('cls_ai_usage') || '0');
            localStorage.setItem('cls_ai_usage', current + 1);
            
            try {
                const today = dayjs().format('YYYY-MM-DD');
                const history = JSON.parse(localStorage.getItem('cls_ai_usage_history') || '{}');
                history[today] = (history[today] || 0) + 1;
                
                const keys = Object.keys(history).sort();
                if (keys.length > 30) {
                    const newHistory = {};
                    keys.slice(keys.length - 30).forEach(k => newHistory[k] = history[k]);
                    localStorage.setItem('cls_ai_usage_history', JSON.stringify(newHistory));
                } else {
                    localStorage.setItem('cls_ai_usage_history', JSON.stringify(history));
                }
            } catch (e) { console.error("Usage history update failed", e); }
        };

        const logSystemEvent = (message, type = 'info') => {
            try {
                const logs = JSON.parse(localStorage.getItem('cls_system_logs') || '[]');
                const newLog = {
                    time: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                    type,
                    message: (message instanceof Error) ? message.toString() : (typeof message === 'object' ? JSON.stringify(message) : String(message))
                };
                const updatedLogs = [newLog, ...logs].slice(0, 100); // Keep last 100 logs
                localStorage.setItem('cls_system_logs', JSON.stringify(updatedLogs));
            } catch (e) { console.error("System log write failure:", e); }
        };

        const GEMINI_MODEL_NAME = "gemini-2.5-flash-lite";
        // [New] Gemini í˜¸ì¶œ í•¨ìˆ˜ (ë¦¬í¬íŠ¸ ìƒì„±ìš©)
        const callGemini = async (apiKey, prompt, temperature = 0.7) => {
            // ğŸ”’ [ë³´ì•ˆ ì ê²€] ì‹¤ì œ AIì—ê²Œ ì „ì†¡ë˜ëŠ” ë‚´ìš©ì„ ì½˜ì†”ì°½ì— ì¶œë ¥í•©ë‹ˆë‹¤.
            // F12(ê°œë°œì ë„êµ¬) > Console íƒ­ì—ì„œ í•™ìƒ ì´ë¦„ì´ [STUDENT_TOKEN]ìœ¼ë¡œ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            console.log("ğŸš€ [Gemini ì „ì†¡ í”„ë¡¬í”„íŠ¸ í™•ì¸]", prompt);

            // [New] ê°œë°œì ëª¨ë“œ ë˜ëŠ” ë³´ì•ˆ í™•ì¸ ëª¨ë“œì¼ ê²½ìš° ì „ì†¡ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì‚¬ìš©ì í™•ì¸ìš©)
            if (localStorage.getItem('cls_ai_safety_check') === 'true') {
                if (window.triggerAiSecurityCheck) {
                    await window.triggerAiSecurityCheck(prompt);
                } else {
                    const msg = `[ğŸ”’ ë³´ì•ˆ í™•ì¸: AI ì „ì†¡ ë°ì´í„°]\n\n${prompt.substring(0, 300)}...\n\n(ì´ë¦„ì´ [STUDENT_TOKEN] ë˜ëŠ” 'ê¸‰ìš°' ë“±ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)\n\nì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (!confirm(msg)) throw new Error("ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }

            if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: temperature }
                    }),
                    referrerPolicy: "no-referrer"
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || response.statusText);
                updateAiUsage();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (e) {
                logSystemEvent(e, 'error');
                if (e.message.includes('Failed to fetch')) throw new Error("ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ (CORS ë˜ëŠ” ì¸í„°ë„· ë¬¸ì œ)");
                throw e;
            }
        };

        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        // ğŸŒŸ ë”°ì˜´í‘œ ì¤‘ë³µ ë°©ì§€ ë° ì „ì†¡ ìµœì í™” ë²„ì „
        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        // [New] êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ìš© í•¨ìˆ˜
        const saveToGoogleSheet = async (studentData, category, recordContent, recordDate) => {
            let url = localStorage.getItem('cls_google_sheet_url');
            if (url) url = url.trim().replace(/^"|'|"$|'$/g, '');
            
            if (!url) {
                alert("ì„¤ì • > ë°ì´í„° ê´€ë¦¬ > ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì—ì„œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
            }
            try {
                const dateStr = recordDate ? dayjs(recordDate).format('YYYY-MM-DD') + ' ' + dayjs().format('HH:mm:ss') : dayjs().format('YYYY-MM-DD HH:mm:ss');
                const clean = (val) => String(val || "").trim().replace(/^"|"$/g, '');

                let payload;
                // ğŸŒŸ í•µì‹¬ ê¸°ìˆ : ë‹¤ìˆ˜ì˜ í•™ìƒ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ 'ë°°ì—´(Array)'ë¡œ ë¬¶ì–´ì„œ í¬ì¥í•©ë‹ˆë‹¤!
                if (Array.isArray(studentData)) {
                    payload = studentData.map(s => ({
                        date: clean(dateStr),
                        name: clean(s.name || s),
                        category: clean(category),
                        content: clean(recordContent), 
                        memo: clean(recordContent),
                        text: clean(recordContent)
                    }));
                } else {
                    payload = {
                        date: clean(dateStr),
                        name: clean(studentData),
                        category: clean(category),
                        content: clean(recordContent), 
                        memo: clean(recordContent),
                        text: clean(recordContent)
                    };
                }

                await fetch(url, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (e) {
                console.error(e); return false;
            }
        };

        // [New] ìµëª…í™” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const anonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            let processed = text;
            processed = processed.replaceAll(studentName, '[STUDENT_TOKEN]');
            if (studentName.length >= 3) {
                const nameOnly = studentName.substring(1);
                processed = processed.replaceAll(nameOnly, '[STUDENT_TOKEN]');
            }
            return processed;
        };

        const deanonymizeText = (text, studentName) => {
            if (!text || !studentName) return text;
            // [Safety] AIê°€ ì‹¤ìˆ˜ë¡œ ì‹¤ëª…ì„ í¬í•¨í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¨¼ì € ìµëª…í™” í† í°ìœ¼ë¡œ ë³€í™˜
            const safeText = anonymizeText(text, studentName);
            return safeText.replaceAll('[STUDENT_TOKEN]', studentName).replaceAll('í•´ë‹¹ í•™ìƒ', studentName);
        };

        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const getToday = () => dayjs().format('YYYY-MM-DD');
        const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        const HOLIDAYS = {
            '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚  ì—°íœ´', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚  ì—°íœ´', '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-06-03': 'ì§€ë°©ì„ ê±°', '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-09-24': 'ì¶”ì„ ì—°íœ´', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„ ì—°íœ´', '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-10-09': 'í•œê¸€ë‚ ', '2026-12-25': 'ì„±íƒ„ì ˆ'
        };
        
        const PATHS = {
            calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
            check: "M20 6 9 17l-5-5", users: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
            chart: "M3 3v18h18 M18 17V9 M13 17V5 M8 17v-3", plus: "M12 5v14 M5 12h14", trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            left: "M15 18 L9 12 L15 6", right: "M9 18 L15 12 L9 6", upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12", download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            bot: "M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M12 8v4 M4 12v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6 M9 16a2 2 0 0 1-2-2v-1 M15 16a2 2 0 0 0 2-2v-1 M12 16v-4",
            list: "M8 6h13 M8 12h13 M8 18h13 M3 6h.01 M3 12h.01 M3 18h.01", code: "M16 18l6-6-6-6 M8 6l-6 6 6 6", edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
            cloud: "M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.17 0-.335.01-.497.027C16.48 6.965 13.812 5 10.5 5 6.358 5 3 8.358 3 12.5c0 3.23 2.063 6.008 5.006 7",
            grid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z", trophy: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M2 12h20",
            warning: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01",
            lock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 10 0v4",
            unlock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-7 0V7a5 5 0 0 1 9.9-1",
            x: "M18 6L6 18M6 6l12 12", help: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-1-5h2v2h-2v-2zm2-1.645V14h-2v-1.5a1 1 0 0 1 1-1 1.5 1.5 0 1 0-1.471-1.794l-1.962-.393A3.501 3.501 0 1 1 13 13.355z",
            settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.01a2 2 0 0 1-2 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2.78a2 2 0 0 1-2-2v-.01a2 2 0 0 1-2-2z",
            down: "M6 9l6 6 6-6", sun: "M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z",
            crown: "M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14v2H5v-2z", 
            link: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71", document: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8",
            copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z",
            spinner: "M21 12a9 9 0 1 1-6.219-8.56", mic: "M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v4 M8 23h8",
            magic: "M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34 M18 2l4 4 M15.5 4.5l3 3 M10 10l8-8", book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            send: "M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z", search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
            key: "M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4",
            speaker: "M11 5L6 9H2v6h4l5 4V5z M19.07 4.93a10 10 0 0 1 0 14.14 M15.54 8.46a5 5 0 0 1 0 7.07",
            mute: "M11 5L6 9H2v6h4l5 4V5z M23 9l-6 6 M17 9l6 6",
            play: "M5 3l14 9-14 9V3z"
        };

        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Btn = ({ onClick, className, children, ...props }) => (
            <button onClick={onClick} className={`transition-colors duration-100 active:opacity-70 flex items-center justify-center rounded hover:bg-notion-bg-hover ${className}`} {...props}>{children}</button>
        );
        const BaseModal = ({ isOpen, onClose, title, icon, children, footer, maxWidth = "max-w-2xl", zIndex = "z-50", onTitleClick }) => {
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                };
            }, [isOpen, onClose]);

            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 bg-black/40 ${zIndex} flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in`} onClick={onClose}>
                    <div 
                        className={`bg-white w-full ${maxWidth} rounded-xl shadow-xl border border-notion-border p-6 h-auto flex flex-col animate-modal-enter`} 
                        style={{ maxHeight: 'calc(85vh / var(--ui-scale, 1))' }}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 className={`text-lg font-bold flex items-center gap-2 text-notion-text ${onTitleClick ? 'cursor-pointer select-none' : ''}`} onClick={onTitleClick}>{icon ? <Icon d={icon} className="text-notion-text" /> : null} {title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-notion-bg-hover rounded text-notion-text-light"><Icon d={PATHS.x} /></button>
                        </div>
                        <div className="overflow-y-auto custom-scroll flex-1 pr-2 space-y-6">{children}</div>
                        {footer && <div className="pt-4 border-t mt-4 flex-shrink-0">{footer}</div>}
                    </div>
                </div>
            );
        };
        const Toast = ({ message, action, onClose }) => {
            const onCloseRef = useRef(onClose);
            useEffect(() => { onCloseRef.current = onClose; }, [onClose]);
            useEffect(() => { 
                if (!message) return; 
                let duration = action ? 4000 : 3000;
                if (message.includes("ì—°ë™ ìƒíƒœ í™•ì¸ ì¤‘")) duration = 600000; 
                if (message.includes("âŒ")) return;
                const timer = setTimeout(() => onCloseRef.current(), duration); 
                return () => clearTimeout(timer); 
            }, [message, action]);
            if (!message) return null;
            
            // ğŸŒŸ ë©”ì‹œì§€ ë‚´ìš©ì— ë”°ë¼ ë””ìì¸ ìë™ ë³€ê²½ (ì‚­ì œ/ì—ëŸ¬ vs ì„±ê³µ/ì €ì¥)
            const isAlert = message.includes("ì‚­ì œ") || message.includes("ì´ˆê¸°í™”") || message.includes("ì‹¤íŒ¨") || message.includes("ì˜¤ë¥˜");
            const iconBg = isAlert ? "from-rose-400 to-rose-600" : "from-indigo-500 to-purple-500";
            const emoji = isAlert ? "ğŸ—‘ï¸" : "âœ¨";
            const borderColor = isAlert ? "border-rose-100" : "border-indigo-100";

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[4000] w-full max-w-sm px-4 animate-[slideInDown_0.5s_cubic-bezier(0.16,1,0.3,1)] pointer-events-none">
                    <div className={`bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-3 border ${borderColor} flex items-center gap-3 ring-1 ring-black/5 pointer-events-auto`}>
                        <div className={`w-10 h-10 bg-gradient-to-br ${iconBg} rounded-full flex items-center justify-center flex-shrink-0 shadow-sm`}>
                            <span className="text-lg animate-bounce">{emoji}</span>
                        </div>
                        <div className="flex-1 min-w-0 pr-2">
                            <h4 className="font-bold text-slate-800 text-sm leading-tight break-keep whitespace-pre-wrap">{message}</h4>
                        </div>
                        {action && (
                            <button onClick={action.onClick} className="ml-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-xl text-xs font-bold transition-colors shadow-sm whitespace-nowrap">
                                {action.label}
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 z-[2500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div 
                        className="bg-white rounded-xl shadow-xl border border-notion-border p-6 w-full max-w-sm animate-modal-enter relative"
                    >
                        <button onClick={onCancel} className="absolute top-4 right-4 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                            <Icon d={PATHS.x} size={18} />
                        </button>
                        <div className="flex items-center gap-2 mb-4 text-notion-text font-bold"><Icon d={PATHS.warning} /> í™•ì¸</div><p className="text-notion-text mb-6 text-sm whitespace-pre-wrap">{message}</p><div className="flex gap-3"><Btn onClick={onCancel} className="flex-1 py-2 bg-white text-slate-600 rounded border border-slate-200 font-medium hover:bg-slate-100 hover:border-slate-300 transition-colors">ì·¨ì†Œ</Btn><Btn onClick={onConfirm} className="flex-1 py-2 bg-notion-red text-white rounded font-medium hover:bg-red-600 shadow-sm transition-colors">í™•ì¸</Btn></div></div></div>
            );
        };
        const UpdateNotificationModal = ({ isOpen, onUpdate, onClose }) => {
            if (!isOpen) return null;
            
            // ğŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const latestUpdate = UPDATE_NOTES[0];
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed inset-0 bg-black/50 z-[3000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center animate-bounce-in relative overflow-hidden border border-white/50">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors z-20">
                            <Icon d={PATHS.x} size={20} />
                        </button>
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        
                        <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner ring-4 ring-indigo-50/50">
                            <span className="text-4xl animate-pulse drop-shadow-sm select-none">ğŸš€</span>
                        </div>
                        <h3 className="text-xl font-extrabold text-slate-800 mb-1">ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ!</h3>
                        <p className="text-xs text-slate-500 mb-4">ì›í™œí•œ ì‚¬ìš©ì„ ìœ„í•´ ì•±ì„ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.</p>
                        
                        {/* ğŸŒŸ ì—¬ê¸°ì— ìµœì‹  ì—…ë°ì´íŠ¸ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ */}
                        <div className="text-left bg-slate-50 p-4 rounded-xl border border-slate-100 mb-5">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded-md">
                                    {latestUpdate.version}
                                </span>
                                <span className="text-[10px] text-slate-400 font-medium">{latestUpdate.date || "ìµœì‹  ì—…ë°ì´íŠ¸"}</span>
                            </div>
                            <ul className="text-[11px] text-slate-600 space-y-1.5">
                                {changes.slice(0, 3).map((item, index) => (
                                    <li key={index} className="flex items-start gap-1.5">
                                        <span className="text-indigo-400 mt-0.5">â€¢</span>
                                        <span className="leading-tight">{item}</span>
                                    </li>
                                ))}
                                {changes.length > 3 && (
                                    <li className="text-slate-400 pl-3 pt-1 font-medium">...ì™¸ {changes.length - 3}ê±´</li>
                                )}
                            </ul>
                        </div>

                        <div className="flex flex-col gap-2">
                            <button onClick={onUpdate} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <span>âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨)</span>
                            </button>
                            <div className="flex gap-2">
                                <button onClick={() => onClose('today')} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</button>
                                <button onClick={() => onClose()} className="flex-1 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors bg-slate-50 rounded-xl hover:bg-slate-100">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const UpdateNotificationToast = ({ isOpen, onUpdate, onClose }) => {
            const timerRef = useRef(null);
            
            useEffect(() => {
                if (isOpen) {
                    timerRef.current = setTimeout(onClose, 8000); // í…ìŠ¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆë„ë¡ 8ì´ˆ ìœ ì§€
                }
                return () => clearTimeout(timerRef.current);
            }, [isOpen, onClose]);
            
            const handleMouseEnter = () => clearTimeout(timerRef.current);
            const handleMouseLeave = () => { 
                if (isOpen) timerRef.current = setTimeout(onClose, 8000); 
            };
            
            if (!isOpen) return null;

            // ğŸŒŸ í•µì‹¬: ì—¬ëŸ¬ ë²„ì „ì˜ ê¸°ë¡ì´ ìˆì–´ë„ ë¬´ì¡°ê±´ [0]ë²ˆì§¸(ê°€ì¥ ìµœì‹ ) ë°ì´í„°ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤!
            const latestUpdate = UPDATE_NOTES[0] || {};
            const changes = latestUpdate.list || latestUpdate.changes || [];

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[3000] w-full max-w-sm px-4 animate-[slideInDown_0.5s_cubic-bezier(0.16,1,0.3,1)]" 
                     onMouseEnter={handleMouseEnter} 
                     onMouseLeave={handleMouseLeave} 
                     onTouchStart={handleMouseEnter} 
                     onTouchEnd={handleMouseLeave}>
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-4 border border-indigo-100 flex flex-col gap-3 ring-1 ring-black/5 relative">
                        
                        <button onClick={() => onClose()} className="absolute top-2 right-2 p-1 text-slate-300 hover:text-slate-500 rounded-full hover:bg-slate-100 transition-colors z-10">
                            <Icon d={PATHS.x} size={14} />
                        </button>

                        <div className="flex items-start gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm mt-0.5">
                                <span className="text-lg animate-pulse">ğŸš€</span>
                            </div>
                            
                            <div className="flex-1 min-w-0">
                                <h4 className="font-bold text-slate-800 text-sm flex items-center gap-2 mb-2">
                                    ìƒˆë¡œìš´ ë²„ì „ ì¶œì‹œ! 
                                    <span className="bg-indigo-100 text-indigo-600 text-[10px] px-1.5 py-0.5 rounded font-bold">{latestUpdate.version}</span>
                                </h4>
                                
                                {/* ğŸŒŸ ìµœì‹  ì—…ë°ì´íŠ¸ ë‚´ìš© ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */}
                                <ul className="text-[11px] text-slate-600 space-y-1.5 max-h-[150px] overflow-y-auto custom-scroll pr-2">
                                    {changes.map((item, index) => (
                                        <li key={index} className="flex items-start gap-1.5">
                                            <span className="text-indigo-400 mt-0.5">â€¢</span>
                                            <span className="leading-tight break-keep">{item}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-1 pt-3 border-t border-slate-100">
                            <button onClick={() => onClose('today')} className="flex-1 py-2 text-slate-500 text-[11px] font-bold bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors">
                                ì˜¤ëŠ˜ í•˜ë£¨ ìˆ¨ê¹€
                            </button>
                            <button onClick={onUpdate} className="flex-1 py-2 bg-indigo-600 text-white text-[11px] font-bold rounded-xl hover:bg-indigo-700 shadow-sm active:scale-95 transition-all">
                                âœ¨ ì§€ê¸ˆ ì—…ë°ì´íŠ¸
                            </button>
                        </div>
                        
                    </div>
                </div>
            );
        };
        const HelpModal = ({ isOpen, onClose }) => {
            if(!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ìë™ ë°±ì—… ë„ì›€ë§" icon={PATHS.help}><div className="space-y-4 text-sm text-slate-600 leading-relaxed"><div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><h4 className="font-bold text-indigo-700 mb-2">ğŸš€ ê¸°ëŠ¥ ì†Œê°œ</h4><p>ì„¤ì •ëœ ì‹œê°„ì— í˜„ì¬ ì•±ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ <strong>JSON íŒŒì¼</strong>ë¡œ ìë™ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. ë§Œì•½ì˜ ì‚¬íƒœì— ëŒ€ë¹„í•´ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”.</p></div><div className="space-y-2"><h4 className="font-bold text-slate-800">âš ï¸ í•„ìˆ˜ ì£¼ì˜ì‚¬í•­</h4><ul className="list-disc pl-5 space-y-1"><li><strong>ì•±ì´ ì¼œì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:</strong> ì´ ê¸°ëŠ¥ì€ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì‘ë™í•˜ë¯€ë¡œ, í•´ë‹¹ ì‹œê°„ì— ì´ ì›¹í˜ì´ì§€ê°€ ì—´ë ¤ ìˆì–´ì•¼ë§Œ ì‘ë™í•©ë‹ˆë‹¤. ì»´í“¨í„°ê°€ êº¼ì ¸ ìˆê±°ë‚˜ íƒ­ì„ ë‹«ìœ¼ë©´ ë°±ì—…ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li><strong>íŒì—… ì°¨ë‹¨ í•´ì œ:</strong> ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ 'ìë™ ë‹¤ìš´ë¡œë“œ' ë˜ëŠ” 'íŒì—…'ì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li><strong>ì €ì¥ ìœ„ì¹˜:</strong> ë³´ì•ˆìƒ ì›¹ì‚¬ì´íŠ¸ê°€ ë°”íƒ•í™”ë©´ ë“± ì €ì¥ ìœ„ì¹˜ë¥¼ ê°•ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì˜ 'ë‹¤ìš´ë¡œë“œ í´ë”'ì— ì €ì¥ë©ë‹ˆë‹¤. (ì„¤ì •ì—ì„œ 'ë‹¤ìš´ë¡œë“œ ì „ì— ì €ì¥ ìœ„ì¹˜ í™•ì¸'ì„ ì¼œë‘ì‹œë©´ ë§¤ë²ˆ ìœ„ì¹˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</li></ul></div></div></BaseModal>
            );
        }

        const DEFAULT_ROLE_DESCRIPTIONS = {
            'ë‚˜ëˆ”ì´': { title: 'ìš°ë¦¬ ëª¨ë‘ ì„ ìœ„í•´ ì„¬ê²¨ì£¼ëŠ” ë‚˜ëˆ”ì´!', desc: ['ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ë‚˜ëˆ ì¤˜ìš”!', 'ì¹œêµ¬ë“¤ì´ í™œë™ì„ ì˜ í•  ìˆ˜ ìˆê²Œ ì±™ê²¨ì¤˜ìš”', 'ì„ ìƒë‹˜ì˜ ë§ì„ ëª¨ë‘  ì¹œêµ¬ë“¤ì—ê²Œ ì „ë‹¬í•´ìš”'] },
            'ë§ºìŒì´': { title: 'ì¹œêµ¬ë“¤ì—ê²Œ í™œë™ì§€ë¥¼ ì •ë¦¬í•´ì£¼ëŠ” ë§ºìŒì´!', desc: ['ì¹œêµ¬ë“¤ì˜ í™œë™ì§€ë¥¼ ì„ ìƒë‹˜ì—ê²Œ ì œì¶œí•´ìš”', 'ë‚¨ì€ í™œë™ì‹œê°„ì„ ì¹œêµ¬ë“¤ì—ê²Œ ì•Œë ¤ì¤˜ìš”'] },
            'ì±™ê¹€ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì˜¤ëŠ” ì±™ê¹€ì´', desc: ['ëª¨ë‘ ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì™€ìš”', '4êµì‹œê¹Œì§€ ì•Œë¦¼ì¥ì„ ì“¸ ìˆ˜ ìˆê²Œ ë„ì™€ì¤˜ìš”'] },
            'ê¹”ë”ì´': { title: 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì •ë¦¬í•˜ëŠ” ê¹”ë”ì´!', desc: ['í’€ê³¼ ê°€ìœ„ë¥¼ ì •ë¦¬í•´ìš”', 'ëª¨ë‘  ë°”êµ¬ë‹ˆë¥¼ ì œìë¦¬ì— ë‚˜ë‘¬ìš”'] }
        };

        const RoleHelpModal = ({ isOpen, onClose, roleDescriptions }) => {
            if (!isOpen) return null;
            const descriptions = roleDescriptions || DEFAULT_ROLE_DESCRIPTIONS;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ì„¤ëª…" icon={PATHS.help}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {Object.entries(descriptions).map(([role, info]) => (
                            <div key={role} className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-2 mb-2"><span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold">{role}</span><h4 className="font-bold text-slate-700 text-sm">{info.title}</h4></div>
                                <ul className="list-disc pl-4 space-y-1">{info.desc.map((d, i) => (<li key={i} className="text-xs text-slate-600">{d}</li>))}</ul>
                            </div>
                        ))}
                    </div>
                </BaseModal>
            );
        };

        const GroupOverlay = ({ groups, avoidancePairs, isVisible, focusedGroupIdx }) => {
            const [lines, setLines] = useState([]);
            
            useEffect(() => {
                const shouldShow = isVisible || focusedGroupIdx !== null;
                if (!shouldShow) { setLines([]); return; }
                
                const updateLines = () => {
                    const newLines = [];
                    const container = document.getElementById('groups-container');
                    if (!container) return;
                    const containerRect = container.getBoundingClientRect();

                    let targetPairs = avoidancePairs;
                    if (focusedGroupIdx !== null && groups[focusedGroupIdx]) {
                        const memberNames = new Set(groups[focusedGroupIdx].map(s => s.name));
                        targetPairs = avoidancePairs.filter(p => memberNames.has(p.p1) || memberNames.has(p.p2));
                    }

                    targetPairs.forEach(pair => {
                        const el1 = document.querySelector(`[data-student-name="${pair.p1}"]`);
                        const el2 = document.querySelector(`[data-student-name="${pair.p2}"]`);
                        
                        if (el1 && el2) {
                            const r1 = el1.getBoundingClientRect();
                            const r2 = el2.getBoundingClientRect();
                            const x1 = r1.left + r1.width / 2 - containerRect.left;
                            const y1 = r1.top + r1.height / 2 - containerRect.top;
                            const x2 = r2.left + r2.width / 2 - containerRect.left;
                            const y2 = r2.top + r2.height / 2 - containerRect.top;
                            newLines.push({ x1, y1, x2, y2, id: pair.id });
                        }
                    });
                    setLines(newLines);
                };

                updateLines();
                window.addEventListener('resize', updateLines);
                const timer = setTimeout(updateLines, 500); 
                return () => { window.removeEventListener('resize', updateLines); clearTimeout(timer); };
            }, [groups, avoidancePairs, isVisible, focusedGroupIdx]);

            if (!isVisible && focusedGroupIdx === null) return null;
            return (
                <svg className="absolute inset-0 w-full h-full pointer-events-none z-50" style={{ overflow: 'visible' }}>
                    {lines.map(line => <line key={line.id} x1={line.x1} y1={line.y1} x2={line.x2} y2={line.y2} stroke="#ef4444" strokeWidth="2" strokeDasharray="5,5" opacity="0.6" />)}
                </svg>
            );
        };

        const RadarChart = ({ data }) => {
            const tags = Object.entries(data).filter(([_, stat]) => stat.cDone > 0).map(([tag]) => tag);
            if (tags.length < 3) return <div className="text-center text-xs text-slate-400 py-8 bg-slate-50 rounded-xl border border-slate-100 border-dashed">ë°©ì‚¬í˜• ì°¨íŠ¸ëŠ” ê³¼ëª©ì´ 3ê°œ ì´ìƒì¼ ë•Œ í‘œì‹œë©ë‹ˆë‹¤.<br/>(í˜„ì¬ {tags.length}ê°œ)</div>;

            const size = 220;
            const center = size / 2;
            const radius = 70;
            const angleStep = (Math.PI * 2) / tags.length;

            const getCoordinates = (value, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const r = (value / 100) * radius;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                return [x, y];
            };

            const studentPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            const classPoints = tags.map((tag, i) => {
                const stat = data[tag];
                const rate = stat.cTotal > 0 ? (stat.cDone / stat.cTotal) * 100 : 0;
                return getCoordinates(rate, i).join(',');
            }).join(' ');

            return (
                <div className="flex flex-col items-center py-2">
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible">
                        {[20, 40, 60, 80, 100].map((level, idx) => (
                            <polygon key={idx} points={tags.map((_, i) => getCoordinates(level, i).join(',')).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 2" />
                        ))}
                        {tags.map((tag, i) => {
                            const [lx, ly] = getCoordinates(100, i);
                            const [tx, ty] = getCoordinates(120, i);
                            return (
                                <g key={i}>
                                    <line x1={center} y1={center} x2={lx} y2={ly} stroke="#e2e8f0" strokeWidth="1" />
                                    <text x={tx} y={ty} textAnchor="middle" dominantBaseline="middle" fontSize="10" fill="#64748b" className="font-bold">{tag}</text>
                                </g>
                            );
                        })}
                        <polygon points={classPoints} fill="rgba(148, 163, 184, 0.3)" stroke="#94a3b8" strokeWidth="2" />
                        <polygon points={studentPoints} fill="rgba(99, 102, 241, 0.3)" stroke="#6366f1" strokeWidth="4" />
                        {tags.map((tag, i) => {
                             const stat = data[tag];
                             const sRate = stat.sTotal > 0 ? (stat.sDone / stat.sTotal) * 100 : 0;
                             const [sx, sy] = getCoordinates(sRate, i);
                             return <circle key={`s-${i}`} cx={sx} cy={sy} r="3" fill="#6366f1" />;
                        })}
                    </svg>
                    <div className="flex gap-4 mt-2 text-[10px]">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-indigo-500"></div><span className="text-slate-600 font-bold">ë‚˜</span></div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-slate-400"></div><span className="text-slate-400 font-bold">í•™ê¸‰ í‰ê· </span></div>
                    </div>
                </div>
            );
        };

        const GRASS_THEMES = {
            indigo: { bg: 'bg-indigo-50', border: 'border-indigo-400', ring: 'ring-indigo-300', text: 'text-indigo-700', dot: 'bg-indigo-500' },
            rose: { bg: 'bg-rose-50', border: 'border-rose-400', ring: 'ring-rose-300', text: 'text-rose-700', dot: 'bg-rose-500' },
            blue: { bg: 'bg-blue-50', border: 'border-blue-400', ring: 'ring-blue-300', text: 'text-blue-700', dot: 'bg-blue-500' },
            green: { bg: 'bg-green-50', border: 'border-green-400', ring: 'ring-green-300', text: 'text-green-700', dot: 'bg-green-500' },
            amber: { bg: 'bg-amber-50', border: 'border-amber-400', ring: 'ring-amber-300', text: 'text-amber-700', dot: 'bg-amber-500' },
            purple: { bg: 'bg-purple-50', border: 'border-purple-400', ring: 'ring-purple-300', text: 'text-purple-700', dot: 'bg-purple-500' },
            slate: { bg: 'bg-slate-100', border: 'border-slate-400', ring: 'ring-slate-300', text: 'text-slate-700', dot: 'bg-slate-500' },
        };

        const CounselingAIModal = ({ isOpen, onClose, student, students, apiKey, showToast, onSave, notes }) => {
            const [advice, setAdvice] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [consultationTopic, setConsultationTopic] = useState("");
            const [showPromptSettings, setShowPromptSettings] = useState(false);
            const [promptTemplate, setPromptTemplate] = useState("");

            const DEFAULT_COUNSELING_TEMPLATE = `ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ì ì‹¬ë¦¬ ìƒë‹´ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒì— ëŒ€í•œ ìƒë‹´ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: (ìµëª…)
- ìµœê·¼ ê´€ì°° ê¸°ë¡:
{{records}}

[ìƒë‹´ ì£¼ì œ]
{{topic}}

[ìš”ì²­ ì‚¬í•­]
1. í•™ìƒì˜ ìƒí™©ì„ ê³µê°í•˜ê³  ì´í•´í•˜ëŠ” íƒœë„ë¡œ ì‘ì„±í•˜ì„¸ìš”.
2. êµì‚¬ê°€ í•™ìƒì—ê²Œ í•´ì¤„ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì¡°ì–¸ì´ë‚˜ ì§€ë„ ë°©ë²•ì„ 3ê°€ì§€ ì •ë„ ì œì‹œí•˜ì„¸ìš”.
3. í•™ë¶€ëª¨ë‹˜ê³¼ ìƒë‹´í•  ë•Œ í™œìš©í•  ìˆ˜ ìˆëŠ” íŒë„ í•œ ë¬¸ì¥ ë§ë¶™ì—¬ì£¼ì„¸ìš”.
4. ë§íˆ¬ëŠ” ì •ì¤‘í•˜ê³  ë¶€ë“œëŸ½ê²Œ í•´ì£¼ì„¸ìš”.`;

            if (!isOpen) return null;

            useEffect(() => {
                const saved = localStorage.getItem('cls_ai_prompt_counseling');
                setPromptTemplate(saved || DEFAULT_COUNSELING_TEMPLATE);
            }, []);

            const handleGenerate = async () => {
                if (!consultationTopic.trim()) return showToast("ìƒë‹´ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsGenerating(true);
                try {
                    const recentNotes = notes.slice(0, 5).map(n => `[${n.date}] ${n.content}`).join('\n');
                    let safeNotes = recentNotes;
                    let safeTopic = consultationTopic;

                    // [ë³´ì•ˆ] ëŒ€ìƒ í•™ìƒ ìµëª…í™”
                    if (typeof anonymizeText === 'function') {
                        safeNotes = anonymizeText(safeNotes, student.name);
                        safeTopic = anonymizeText(safeTopic, student.name);
                    }

                    // [ë³´ì•ˆ] ë‹¤ë¥¸ í•™ìƒë“¤ ìµëª…í™” (ê¸‰ìš°)
                    if (students && Array.isArray(students)) {
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotes = safeNotes.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotes = safeNotes.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                                safeTopic = safeTopic.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeTopic = safeTopic.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                    }
                    
                    let prompt = promptTemplate || DEFAULT_COUNSELING_TEMPLATE;
                    prompt = prompt.replace('{{records}}', safeNotes || "ê¸°ë¡ ì—†ìŒ");
                    prompt = prompt.replace('{{topic}}', safeTopic);

                    const response = await callGemini(apiKey, prompt);
                    setAdvice(response);
                } catch (e) {
                    showToast("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleSavePrompt = () => {
                localStorage.setItem('cls_ai_prompt_counseling', promptTemplate);
                showToast("í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setShowPromptSettings(false);
            };

            const handleResetPrompt = () => {
                setPromptTemplate(DEFAULT_COUNSELING_TEMPLATE);
                localStorage.removeItem('cls_ai_prompt_counseling');
                showToast("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ¤– AI ì€ìƒ˜ì´ ìƒë‹´ì†Œ" icon={PATHS.heart}>
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">ğŸ’¡ ì„ ìƒë‹˜ì„ ìœ„í•œ AI ìƒë‹´ ì¡°ì–¸</p>
                            <p className="text-xs opacity-80">í•™ìƒì˜ í‰ì†Œ ê¸°ë¡ê³¼ ì„ ìƒë‹˜ì˜ ê³ ë¯¼ì„ ë°”íƒ•ìœ¼ë¡œ<br/>AIê°€ ë§ì¶¤í˜• ì§€ë„ ë°©ë²•ê³¼ ìƒë‹´ íŒì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">ìƒë‹´í•˜ê³  ì‹¶ì€ ë‚´ìš© (ê³ ë¯¼)</label>
                            <textarea className="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none focus:border-rose-500 resize-none h-24" placeholder="ì˜ˆ: ì¹œêµ¬ë“¤ê³¼ ìì£¼ ë‹¤íˆ¬ëŠ”ë° ì–´ë–»ê²Œ ì§€ë„í•˜ë©´ ì¢‹ì„ê¹Œìš”? / ìˆ˜ì—… ì‹œê°„ì— ì§‘ì¤‘ì„ ì˜ ëª»í•´ìš”." value={consultationTopic} onChange={(e) => setConsultationTopic(e.target.value)} />
                        </div>
                        
                        <div className="border-t border-slate-100 pt-2">
                            <button onClick={() => setShowPromptSettings(!showPromptSettings)} className="text-xs font-bold text-slate-400 flex items-center gap-1 hover:text-slate-600 transition-colors mb-2">
                                <Icon d={PATHS.settings} size={12} /> í”„ë¡¬í”„íŠ¸ ì„¤ì • {showPromptSettings ? 'ì ‘ê¸°' : 'ì—´ê¸°'}
                            </button>
                            {showPromptSettings && (
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fade-in space-y-2">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
    <p className="text-[10px] text-slate-500 font-bold">í”„ë¡¬í”„íŠ¸ ë³€ìˆ˜ ê°€ì´ë“œ (ìë™ ìµëª…í™”ë¨)</p>
    <select 
        className="text-xs border border-indigo-200 rounded-lg px-2 py-1.5 bg-white text-indigo-700 font-bold focus:outline-none cursor-pointer hover:bg-indigo-50 transition-colors shadow-sm"
        onChange={(e) => {
            const val = e.target.value;
            
            // ğŸŒ± 1. ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë³µêµ¬
            if (val === "default") {
                setPromptTemplate("ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ì ì‹¬ë¦¬ ìƒë‹´ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒì— ëŒ€í•œ ìƒë‹´ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.\n\n[í•™ìƒ ì •ë³´]\n- ì´ë¦„: (ìµëª…)\n- ìµœê·¼ ê´€ì°° ê¸°ë¡:\n{{records}}\n\n[ìƒë‹´ ì£¼ì œ]\n{{topic}}\n\n[ìš”ì²­ ì‚¬í•­]\n1. í•™ìƒì˜ ìƒí™©ì„ ê¹Šì´ ê³µê°í•˜ê³  ì‹¬ë¦¬ì  ì›ì¸ì„ ë¶„ì„í•˜ì„¸ìš”.\n2. êµì‚¬ê°€ êµì‹¤ì—ì„œ ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì§€ë„ ë°©ë²•ì„ 3ê°€ì§€ ì œì‹œí•˜ì„¸ìš”.\n3. í•™ë¶€ëª¨ ìƒë‹´ ì‹œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë”°ëœ»í•œ ì¡°ì–¸ ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                if(typeof showToast !== 'undefined') showToast("ğŸŒ± ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } 
            
            // ==========================================
            // ğŸ”¬ ê·¸ë£¹ 1: í•™ë¬¸ì  ì‹¬ì¸µ í”„ë ˆì„ì›Œí¬ (ì›ì¸/ë¶„ì„ ì¤‘ì‹¬)
            // ==========================================
            else if (val === "behavior_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì•„ë™ í–‰ë™ ì‹¬ë¦¬ ì „ë¬¸ê°€ì´ì ì‘ìš©í–‰ë™ë¶„ì„(ABA)ì˜ ê¶Œìœ„ìì…ë‹ˆë‹¤.\n- ì–´ì¡°: ê°ê´€ì , ë¶„ì„ì , ë‹¨í˜¸í•˜ë˜ í•™ìƒì„ í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë”°ëœ»í•¨.\n- ê¸ˆì§€ì‚¬í•­: \"ì‚¬ë‘ìœ¼ë¡œ ê°ì‹¸ì£¼ì„¸ìš”\" ê°™ì€ ì¶”ìƒì ì´ê³  ë»”í•œ ì¡°ì–¸ ì ˆëŒ€ ê¸ˆì§€.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ í–‰ë™ ì¤‘ì¬ ê³„íš(BIP)ì„ ìˆ˜ë¦½í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ABC í–‰ë™ ê¸°ëŠ¥ ë¶„ì„**: A(ì„ í–‰ì‚¬ê±´)-B(ë¬¸ì œí–‰ë™)-C(ìˆ¨ì€ ëª©ì ) ì •ë°€ ë¶„ì„\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: ìš°ìˆ˜ì‚¬ë¡€ë‚˜ ì €ëª…í•œ ì‹¬ë¦¬ ì „ë¬¸ê°€ì˜ ì‹¤ì œ ê·¹ë³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **3ë‹¨ê³„ êµì‹¤ ì¤‘ì¬ ì „ëµ(ì‹¤ì²œë²•)**: [ì˜ˆë°©]-[ëŒ€ì²´ í–‰ë™ êµìˆ˜]-[ë°˜ì‘(15ì´ˆ ëŒ€ì²˜ë²•)]\n4. **í•™ë¶€ëª¨ ìƒë‹´ ì‹œë‚˜ë¦¬ì˜¤**: ì¼ê´€ëœ í›ˆìœ¡ì„ ëŒì–´ë‚´ê¸° ìœ„í•œ êµ¬ì²´ì  í˜‘ì¡° ìš”ì²­ ë©˜íŠ¸");
                if(typeof showToast !== 'undefined') showToast("ğŸ”¬ í–‰ë™ êµì •(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "social_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ í•™ê¸‰ ê¸ì • í›ˆìœ¡(PDC) ë° ë¹„í­ë ¥ ëŒ€í™”(NVC) ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: \"ì¹œí•˜ê²Œ ì§€ë‚´ë¼\" ìˆ˜ì¤€ì˜ 1ì°¨ì›ì  ì¡°ì–¸ ê¸ˆì§€.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë˜ë˜ ì—­í•™ì„ ì‹¬ì¸µ ë¶„ì„í•˜ê³  ê´€ê³„ íšŒë³µ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë˜ë˜ ì—­í•™(Sociogram) ì¶”ë¡  ë¶„ì„**: ì‚¬íšŒì  ê¸°ìˆ  ê²°í• ìš”ì†Œ(ì¶©ë™ì„±, ëˆˆì¹˜ ë“±) ì •ë°€ ë¶„ì„\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: í•™êµ í­ë ¥/ê°ˆë“± ì¤‘ì¬ ì„±ê³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **í•™ê¸‰ ìš´ì˜(í™˜ê²½) ê°œì…ë²•**: ìì—°ìŠ¤ëŸ½ê²Œ ì†Œì†ê°ì„ ë¶€ì—¬í•  ìˆ˜ ìˆëŠ” í•™ê¸‰ ì—­í• /ì§ í™œë™ ì•„ì´ë””ì–´\n4. **1:1 ë¹„í­ë ¥ ëŒ€í™”(NVC) ìŠ¤í¬ë¦½íŠ¸**: í•™ìƒì˜ ë°©ì–´ê¸°ì œë¥¼ ë‚®ì¶”ëŠ” ê´€ì°°-ëŠë‚Œ-ìš•êµ¬-ë¶€íƒì˜ ëŒ€í™” ëŒ€ë³¸\n5. **ê°ˆë“± ì¦‰ê° ê°œì… ë©˜íŠ¸**: ë‹¤íˆ¼ ë°œìƒ ì¦‰ì‹œ êµì‚¬ê°€ ì–‘ì¸¡ì— ë˜ì§ˆ ì¤‘ë¦½ì  ì²« ë¬¸ì¥");
                if(typeof showToast !== 'undefined') showToast("ğŸ”¬ êµìš° ê´€ê³„(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "study_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ê¸°ë°˜ í•™ìŠµ ì½”ì¹­ ë° ë©”íƒ€ì¸ì§€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ëˆ„êµ¬ë‚˜ ì•„ëŠ” ì¼ë°˜ë¡ ì  ì¹­ì°¬ ê¸ˆì§€.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ 'í•™ìŠµëœ ë¬´ê¸°ë ¥'ì˜ ì›ì¸ì„ í•´ë¶€í•˜ëŠ” ì²˜ë°©ì „ì„ ì‘ì„±í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë¬´ê¸°ë ¥ì˜ ì›ì¸ í•´ë¶€**: ê¸°ì´ˆ ê²°ì†(Can't)ì¸ì§€ ë™ê¸° ë¶€ì¡±(Won't)ì¸ì§€ ëª…í™•íˆ ì§„ë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: í•™ìŠµ ë¶€ì§„ ê·¹ë³µì˜ ì‹¤ì œ ë™ê¸° íšŒë³µ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ë§ˆì´í¬ë¡œ í•´ë¹—(Micro-habit) ì„¤ê³„**: í•˜ë£¨ 5ë¶„ ë‹¨ìœ„ì˜ 100% ì„±ê³µ ë³´ì¥ ì´ˆë¯¸ì„¸ í•™ìŠµ ë£¨í‹´\n4. **ë©”íƒ€ì¸ì§€ ìê·¹ ìŠ¤í¬ë¦½íŠ¸**: ì•„ì´ê°€ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹«ê²Œ ë§Œë“œëŠ” êµì‚¬ì˜ 'ì§ˆë¬¸í˜• ëŒ€ë³¸' 3ê°€ì§€\n5. **í•™ë¶€ëª¨ ì—°ê³„ ì½”ì¹­**: ê²°ê³¼ ëŒ€ì‹  ê³¼ì •ì„ ì¹­ì°¬í•˜ê²Œ ìœ ë„í•˜ëŠ” ìƒë‹´ ë©˜íŠ¸");
                if(typeof showToast !== 'undefined') showToast("ğŸ”¬ í•™ìŠµ ë¬´ê¸°ë ¥(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "emotion_aca") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì¡´ ê°€íŠ¸ë§¨ ê°ì • ì½”ì¹­ ì´ë¡ ê³¼ ë‡Œê³¼í•™ ê¸°ë°˜ íŠ¸ë¼ìš°ë§ˆ/ìœ„ê¸° ê°œì… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: \"ë§ˆìŒì„ ì½ì–´ì£¼ì„¸ìš”\"ë¡œ ëë‚˜ëŠ” ì¡°ì–¸ ê¸ˆì§€.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì¢…í•©í•˜ì—¬ ê³ ë°˜ì‘ì„± í•™ìƒì˜ ê°ì • ì‹œìŠ¤í…œì„ ë¶„ì„í•˜ê³  ì•ˆì „ ëŒ€ì²˜ ë§¤ë‰´ì–¼ì„ ì œì‹œí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê°ì •ì˜ ë‡Œê³¼í•™ì  ë¶„ì„**: íˆ¬ìŸ-ë„í”¼ ë°˜ì‘ ìœ ë°œ ìš”ì¸ ë° ë¹™ì‚° ì•„ë˜ í•µì‹¬ ê°ì •(ìˆ˜ì¹˜ì‹¬, ë¶ˆì•ˆ ë“±) ì§„ë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: ì†Œì•„ì •ì‹ ì˜í•™íšŒ ë°œì·Œ ë“± í…íŠ¸ëŸ¼(Tantrum) ëŒ€ì²˜ ì‚¬ë¡€ (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ìœ„ê¸° ê°œì… ìŠ¤í¬ë¦½íŠ¸(ê°€íŠ¸ë§¨ 5ë‹¨ê³„)**: ê°ì • í­ë°œ ì‹œ 3ë¶„ ê³¨ë“ íƒ€ì„ ë‚´ì— ë˜ì ¸ì•¼ í•  ëŒ€ì‚¬ì™€ í–‰ë™ ì§€ì¹¨\n4. **í‰ìƒì‹œ ê°ì • ê·¸ë¦‡ ë„“íˆê¸°**: ì•„ì´ ìŠ¤ìŠ¤ë¡œ ê°ì •ì„ ì‹œê°í™”í•˜ê³  ì¿¨ë‹¤ìš´í•˜ëŠ” ì „ëµ\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ë¶€ëª¨ë¥¼ ì§€ì§€í•˜ê³  ì¼ê´€ëœ ê°ì • ì½”ì¹­ì„ ê¶Œìœ í•˜ëŠ” ë©”ì‹œì§€");
                if(typeof showToast !== 'undefined') showToast("ğŸ”¬ ê°ì • ì¡°ì ˆ(ì‹¬ì¸µ ë¶„ì„) í…œí”Œë¦¿ ì ìš©!");
            }

            // ==========================================
            // ğŸ› ï¸ ê·¸ë£¹ 2: êµì‹¤ ì‹¤ì²œ ë„êµ¬ í”„ë ˆì„ì›Œí¬ (ë¬¼ë¦¬ì /í™˜ê²½ ì„¸íŒ… ì¤‘ì‹¬)
            // ==========================================
            else if (val === "behavior_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ì•„ë™ í–‰ë™ ì‹¬ë¦¬ ì „ë¬¸ê°€ì´ì í•™êµì°¨ì›ì˜ ê¸ì •ì  í–‰ë™ì§€ì›(SWPBS) ì‹¤ë¬´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ì¶”ìƒì  ì¡°ì–¸ ì ˆëŒ€ ê¸ˆì§€. êµì‹¤ì—ì„œ ëˆˆì— ë³´ì´ëŠ” ë¬¼ë¦¬ì  ìˆ˜ë‹¨ì„ ì œì‹œí•  ê²ƒ.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¹ì¥ ë‚´ì¼ ì ìš©í•  êµì‹¤ í™˜ê²½ ì„¸íŒ…ê³¼ ì‹¤ì²œ ë„êµ¬ë¥¼ ì œì‹œí•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ABC í–‰ë™ ë¶„ì„**: A(ì„ í–‰ì‚¬ê±´)-B(ë¬¸ì œí–‰ë™)-C(ìˆ¨ì€ ëª©ì ) í•µì‹¬ ìš”ì•½\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜: OOìë£Œ] ëª…ì‹œ, ì§€ì–´ë‚´ê¸° ê¸ˆì§€)\n3. **ğŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì‹œê°ì  ì‹œê°„í‘œ, í† í° ì´ì½”ë…¸ë¯¸(ë³´ìƒíŒ), ë¹„ë°€ í–‰ë™ ê³„ì•½ì„œ, íŠ¹ì • ìë¦¬ ë°°ì¹˜ íŒ ë“± ë‚´ì¼ ë‹¹ì¥ ì„¸íŒ…í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í™˜ê²½/ë¬¼ë¦¬ì  ë„êµ¬ì™€ í™œìš©ë²•\n4. **ìœ„ê¸° ê°œì… ìŠ¤í¬ë¦½íŠ¸**: í–‰ë™ ë°œìƒ ì¦‰ì‹œì˜ ë‹¨í˜¸í•œ 15ì´ˆ ê°œì… ëŒ€ì‚¬\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ë„êµ¬ í™œìš©ì— ëŒ€í•œ ê°€ì •í†µì‹  ì•ˆë‚´");
                if(typeof showToast !== 'undefined') showToast("ğŸ› ï¸ í–‰ë™ êµì •(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "social_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ í•™ê¸‰ ê¸ì • í›ˆìœ¡(PDC) ì‹¤ì²œê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: 1ì°¨ì›ì  í›ˆí™” ë§ì”€ ê¸ˆì§€. êµ¬ì²´ì ì¸ êµì‹¤ ë‚´ í•™ê¸‰ í™œë™(Activity)ì„ ì œì‹œí•  ê²ƒ.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê´€ê³„ íšŒë³µì„ ìœ„í•œ êµì‹¤ ë‚´ í™œë™ ë„êµ¬ì™€ ë£¨í‹´ì„ ì„¤ê³„í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê²°í• ê¸°ìˆ  ë¶„ì„**: í•™ìƒì˜ ì‚¬íšŒì  ê¸°ìˆ  ë¶€ì¡± ë¶€ë¶„ íŒŒì•…\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ğŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬/í™œë™ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì˜ë¯¸ ìˆëŠ” 1ì¸ 1ì—­(ì—­í•  ì„¸ë¶€ ì„¤ê³„), í•™ê¸‰ íšŒì˜ ì•ˆê±´ í™œìš©ë²•, ë˜ë˜ ë©˜í† ë§, ê²©ë ¤ ì„œí´ ë“± ìì—°ìŠ¤ëŸ½ê²Œ ë¬´ë¦¬ì— ì„ì´ê²Œ í•˜ëŠ” êµì‹¤ í™œë™ ë§¤ë‰´ì–¼\n4. **NVC ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸**: ì§§ê³  íš¨ê³¼ì ì¸ 1:1 êµì‚¬ ë°œë¬¸\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ì‚¬íšŒì„± ê´€ë ¨ ê°€ì • ë‚´ ë¯¸ì…˜ ì•ˆë‚´");
                if(typeof showToast !== 'undefined') showToast("ğŸ› ï¸ êµìš° ê´€ê³„(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "study_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ ë³´í¸ì  í•™ìŠµì„¤ê³„(UDL) ë° êµë³´ì¬ í™œìš© ì‹¤ë¬´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ë»”í•œ ë™ê¸°ë¶€ì—¬ ëª…ì–¸ ê¸ˆì§€. ì†ì— ì¡íˆëŠ” í•™ìŠµ ë³´ì¡° ì¥ì¹˜ë¥¼ ì œì‹œí•  ê²ƒ.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ë¶„ì„í•˜ì—¬ ë¬´ê¸°ë ¥ì„ ê·¹ë³µí•  êµì‹¤ ë‚´ í•™ìŠµ ë³´ì¡° ë„êµ¬ì™€ ë¬¼ë¦¬ì  í™˜ê²½ì„ ì„¤ê³„í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ë¬´ê¸°ë ¥ ì§„ë‹¨**: ê¸°ì´ˆ ê²°ì† vs ë™ê¸° ë¶€ì¡± íŒë‹¨\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ğŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: ì‹œê°ì  íƒ€ì´ë¨¸(ë½€ëª¨ë„ë¡œ), ìŠ¤ìºí´ë”©(ë‚œì´ë„ ì¡°ì ˆ í•™ìŠµì§€) ì œì‘ íŒ, ì‹œê°ì  ë‹¨ì„œ ì¹´ë“œ ì„¸íŒ…, ë§ˆì´í¬ë¡œ í•´ë¹— ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤í‹°ì»¤ ë“± êµì‚¬ê°€ ì§ê´€ì ìœ¼ë¡œ ì œê³µí•  ë³´ì¡° ë„êµ¬\n4. **ë©”íƒ€ì¸ì§€ ë°œë¬¸**: í•™ìŠµ ì ê²€ìš© ì§ˆë¬¸ ëŒ€ë³¸\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ê°€ì • í•™ìŠµ ì„¸íŒ… ê°€ì´ë“œ");
                if(typeof showToast !== 'undefined') showToast("ğŸ› ï¸ í•™ìŠµ ë¬´ê¸°ë ¥(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            } 
            else if (val === "emotion_prac") {
                setPromptTemplate("# ì—­í•  ë° ì¡°ê±´\n- ë‹¹ì‹ ì€ íŠ¸ë¼ìš°ë§ˆ ê¸°ë°˜ êµì‹¤ í™˜ê²½(Trauma-Informed Classroom) ì„¸íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n- ê¸ˆì§€ì‚¬í•­: ì¶”ìƒì ì¸ ê³µê° ì¡°ì–¸ ê¸ˆì§€. êµì‹¤ì˜ ê³µê°„ê³¼ ë¬¼í’ˆì„ í™œìš©í•œ ë°©ë²• ì œì‹œ.\n\n# ì„ë¬´\n[ê´€ì°° ê¸°ë¡]ê³¼ [ìƒë‹´ ì£¼ì œ]ë¥¼ ì¢…í•©í•˜ì—¬ í•™ìƒì˜ ê°ì •ì„ ì•ˆì „í•˜ê²Œ ìˆ˜ìš©í•  ìˆ˜ ìˆëŠ” êµì‹¤ í™˜ê²½ ë° ë¬¼ë¦¬ì  ë„êµ¬ ì„¸íŒ… ë§¤ë‰´ì–¼ì„ ì‘ì„±í•˜ì„¸ìš”.\n[ê´€ì°° ê¸°ë¡]: {{records}}\n[ìƒë‹´ ì£¼ì œ]: {{topic}}\n\n# ì¶œë ¥ í˜•ì‹\n1. **ê°ì • ë°˜ì‘ ì§„ë‹¨**: íˆ¬ìŸ-ë„í”¼ ìœ ë°œ íŠ¸ë¦¬ê±° íŒŒì•…\n2. **ê²€ì¦ëœ ì‹¤ì‚¬ë¡€ ë° ì¶œì²˜**: (ë°˜ë“œì‹œ [ì¶œì²˜] ëª…ì‹œ)\n3. **ğŸ› ï¸ êµì‹¤ ì ìš© ì‹¤ì²œ ë„êµ¬ (ë‹¤ì–‘í•˜ê²Œ 3ê°€ì§€ ì´ìƒ)**: í‰í™” êµ¬ì—­(Calming Corner)ì˜ êµ¬ì²´ì  ìœ„ì¹˜ì™€ ë¹„ì¹˜í•  ë¬¼í’ˆ(ì˜ˆ: ìŠ¤íŠ¸ë ˆìŠ¤ ë³¼, í˜¸í¡ ì¹´ë“œ), ì±…ìƒ ìœ„ ê°ì • ì‹ í˜¸ë“±/ì˜¨ë„ê³„ ì„¸íŒ…, ì¿¨ë‹¤ìš´ íƒ€ì„(Time-In) ë§¤ë‰´ì–¼ ë“±\n4. **ìœ„ê¸° ê°œì… ìŠ¤í¬ë¦½íŠ¸**: ëŒë°œ í–‰ë™ ì‹œ ë¬¼ë¦¬ì /ì–¸ì–´ì  ëŒ€ì²˜ ì§€ì¹¨\n5. **í•™ë¶€ëª¨ ì—°ê³„**: ê°€ì • ë‚´ ê°ì • ì¡°ì ˆ ê³µê°„ ì„¸íŒ… íŒ");
                if(typeof showToast !== 'undefined') showToast("ğŸ› ï¸ ê°ì • ì¡°ì ˆ(ì‹¤ì²œ ë„êµ¬) í…œí”Œë¦¿ ì ìš©!");
            }

            e.target.value = ""; 
        }}
    >
        <option value="">ğŸ’¡ ì¶”ì²œ í…œí”Œë¦¿ ì„ íƒ...</option>
        <option value="default">ğŸŒ± ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ì›ë˜ëŒ€ë¡œ)</option>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
        <optgroup label="ğŸ”¬ í•™ë¬¸ì  ì‹¬ì¸µ ë¶„ì„ (ì´ë¡ /ì›ì¸ íŒŒì•…)">
            <option value="behavior_aca">ğŸš¨ í–‰ë™ êµì • (ABC ì›ì¸ë¶„ì„)</option>
            <option value="social_aca">ğŸ¤ êµìš° ê´€ê³„ (ë˜ë˜ì—­í•™ ì¶”ë¡ )</option>
            <option value="study_aca">ğŸ“š í•™ìŠµ ë¬´ê¸°ë ¥ (ë¬´ê¸°ë ¥ í•´ë¶€)</option>
            <option value="emotion_aca">â˜” ê°ì • ì¡°ì ˆ (ë‡Œê³¼í•™ì  ë¶„ì„)</option>
        </optgroup>
        <optgroup label="ğŸ› ï¸ êµì‹¤ ì‹¤ì²œ ë„êµ¬ (ì‹¤ë¬´/í™˜ê²½ ì„¸íŒ…)">
            <option value="behavior_prac">ğŸš¨ í–‰ë™ êµì • (êµì‹¤í™˜ê²½/ë„êµ¬ì„¸íŒ…)</option>
            <option value="social_prac">ğŸ¤ êµìš° ê´€ê³„ (í•™ê¸‰í™œë™/ë£¨í‹´ì„¤ê³„)</option>
            <option value="study_prac">ğŸ“š í•™ìŠµ ë¬´ê¸°ë ¥ (í•™ìŠµë³´ì¡°/ì‹œê°í™”)</option>
            <option value="emotion_prac">â˜” ê°ì • ì¡°ì ˆ (ì•ˆì •í™”êµ¬ì—­/êµë³´ì¬)</option>
        </optgroup>
    </select>
</div>
                                    <div className="grid grid-cols-2 gap-2 text-[10px] text-slate-600 bg-white p-2 rounded border border-slate-100">
                                        <div><code>{`{{records}}`}</code> : ê´€ì°° ê¸°ë¡</div>
                                        <div><code>{`{{topic}}`}</code> : ìƒë‹´ ì£¼ì œ</div>
                                    </div>
                                    <textarea value={promptTemplate} onChange={(e) => setPromptTemplate(e.target.value)} className="w-full h-40 p-2 border border-slate-300 rounded-lg text-xs font-mono outline-none focus:border-indigo-500 resize-none custom-scroll" />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={handleResetPrompt} className="px-3 py-1.5 bg-white border border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-50">ì´ˆê¸°í™”</button>
                                        <button onClick={handleSavePrompt} className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">ì €ì¥</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <Btn onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md flex items-center justify-center gap-2">
                            {isGenerating ? <><Icon d={PATHS.spinner} className="animate-spin"/> ê³ ë¯¼í•˜ëŠ” ì¤‘...</> : <><Icon d={PATHS.magic}/> ì¡°ì–¸ êµ¬í•˜ê¸°</>}
                        </Btn>
                        {advice && (
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                                <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><Icon d={PATHS.bot} className="text-rose-500"/> AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸</h4>
                                <div className="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap max-h-60 overflow-y-auto custom-scroll p-2 bg-slate-50 rounded-lg">{advice}</div>
                                <div className="flex justify-end gap-2 mt-3">
                                    <Btn onClick={() => { navigator.clipboard.writeText(advice); showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50">ë³µì‚¬</Btn>
                                    <Btn onClick={() => { onSave(advice); onClose(); }} className="px-3 py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold hover:bg-rose-200">ê¸°ë¡ì— ì €ì¥</Btn>
                                </div>
                            </div>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const StatsGrassModal = ({ isOpen, onClose, student, students, records, dates, dailyTasks, onSaveCounseling, onSaveStickers, onSaveStickerWithNote, showToast, openConfirm, appConfig, apiKey, onSaveRecordDraft, isLocalMode, db, appId, setStudents, saveData, isPortfolioMode }) => {
            if (!isOpen || !student || !student.history) return null;
            useEffect(() => {
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => {
                    window.removeEventListener('keydown', handleEsc);
                };
            }, [onClose]);

            const [notes, setNotes] = useState([]);
            const [stickerCount, setStickerCount] = useState(student.stickers || 0);
            const [selectedDate, setSelectedDate] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [showSearchCal, setShowSearchCal] = useState(false);
            const [calMonth, setCalMonth] = useState(dayjs());
            const recordDates = Array.from(new Set(notes.map(n => n.date))); // ê¸°ë¡ì´ ìˆëŠ” ë‚ ì§œë§Œ ì™ì™ ë½‘ê¸°
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editNoteContent, setEditNoteContent] = useState("");
            const [aiComment, setAiComment] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [showReportEdit, setShowReportEdit] = useState(false);
            const [reportStart, setReportStart] = useState(dayjs().subtract(1, 'month').format('YYYY-MM-DD'));
            const [reportEnd, setReportEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [tempComment, setTempComment] = useState("");
            const [reportTone, setReportTone] = useState('warm');
            const [reportFont, setReportFont] = useState('sans');
            const [reportFocus, setReportFocus] = useState('comprehensive');
            const [reportPurpose, setReportPurpose] = useState('regular');
            const [showCounselingAI, setShowCounselingAI] = useState(false);
            const [reportStats, setReportStats] = useState({ studentRate: 0, classRate: 0, tagStats: {} });
            const [showDetailStats, setShowDetailStats] = useState(false);
            const [showStudentRecordAI, setShowStudentRecordAI] = useState(false);
            const modalRef = useRef(null);
            const reportRef = useRef(null);
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_report_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const [chartType, setChartType] = useState('bar');
            const [grassStart, setGrassStart] = useState(dayjs().startOf('month').format('YYYY-MM-DD'));
            const [grassEnd, setGrassEnd] = useState(dayjs().endOf('month').format('YYYY-MM-DD'));
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [stickerEffect, setStickerEffect] = useState(false);
            const [showButtonEffect, setShowButtonEffect] = useState(false);
            const [keepContent, setKeepContent] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);
            const [isGrassExpanded, setIsGrassExpanded] = useState(false); // [ì¶”ê°€ë¨] í™œë™ ì”ë”” ì ‘ê³  í´ê¸° ìƒíƒœ
            const [selectedGrassDate, setSelectedGrassDate] = useState(null);
            const [dateRangeAnim, setDateRangeAnim] = useState(false);
            const [cachedDetailDate, setCachedDetailDate] = useState(null); // [New] ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë°ì´í„° ìœ ì§€ìš©
            const [isDetailViewOpen, setIsDetailViewOpen] = useState(false); // [New] ìŠ¬ë¼ì´ë“œ ìƒíƒœ ë¶„ë¦¬
            const [grassTheme, setGrassTheme] = useState(() => localStorage.getItem('cls_grass_theme') || 'indigo');
            const [showThemePicker, setShowThemePicker] = useState(false);
            
            // [New] ì—°ë™ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ê°’ ì„¤ì • (ì´ˆê¸°í™”)
            const [hasNotionRecord, setHasNotionRecord] = useState(false);
            const [hasNotionPortfolio, setHasNotionPortfolio] = useState(false);
            const [hasGoogleSheet, setHasGoogleSheet] = useState(false);

            const [saveTargets, setSaveTargets] = useState(() => {
                // [Fix] ì €ì¥ëœ ì„¤ì • ìš°ì„  ë¶ˆëŸ¬ì˜¤ê¸°
                const savedPref = localStorage.getItem('cls_save_targets_pref');
                if (savedPref) {
                    try { return new Set(JSON.parse(savedPref)); } catch(e) {}
                }

                const key = localStorage.getItem('cls_notion_key');
                const dbId = localStorage.getItem('cls_notion_db_id');
                const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
                const sheetUrl = localStorage.getItem('cls_google_sheet_url');
                const targets = new Set();
                if (isPortfolioMode && key && portDbId) targets.add('notion_portfolio');
                if (key && dbId) targets.add('notion_record');
                if (sheetUrl) targets.add('google_sheet');
                return targets;
            });
            
            const [notionDate, setNotionDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [notionContent, setNotionContent] = useState('');
            const [notionCategory, setNotionCategory] = useState('ê´€ì°°');
            const [searchText, setSearchText] = useState("");
            const [selectedStudents, setSelectedStudents] = useState([]);
            const [searchQuery, setSearchQuery] = useState("");
            const [showStudentDropdown, setShowStudentDropdown] = useState(false);
            const [notionStatus, setNotionStatus] = useState('idle');
            const [hasNotionConfig, setHasNotionConfig] = useState(false);
            const [hasGoogleSheetConfig, setHasGoogleSheetConfig] = useState(false);
            
            useEffect(() => {
                if (isOpen) {
                    const key = localStorage.getItem('cls_notion_key');
                    const dbId = localStorage.getItem('cls_notion_db_id');
                    const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
                    const sheetUrl = localStorage.getItem('cls_google_sheet_url');

                    const rec = !!(key && dbId);
                    const port = !!(key && portDbId);
                    const sheet = !!sheetUrl;

                    setHasNotionRecord(rec);
                    setHasNotionPortfolio(port);
                    setHasGoogleSheet(sheet);
                    
                    // ë°°ì§€ìš© ìƒíƒœ ì—…ë°ì´íŠ¸ (í˜¸í™˜ì„± ìœ ì§€)
                    setHasNotionConfig(rec || port);
                    setHasGoogleSheetConfig(sheet);
                    
                    // [Fix] ì €ì¥ëœ ì„¤ì •ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                    const savedPref = localStorage.getItem('cls_save_targets_pref');
                    if (savedPref) {
                        try {
                            setSaveTargets(new Set(JSON.parse(savedPref)));
                        } catch (e) {}
                    } else {
                        setSaveTargets(prev => {
                            const next = new Set();
                            if (isPortfolioMode && port) next.add('notion_portfolio');
                            else if (rec) next.add('notion_record');
                            if (sheet) next.add('google_sheet');
                            return next;
                        });
                    }
                }
            }, [isOpen, isPortfolioMode]);

            // [New] ì„ íƒ ìƒíƒœ ë³€ê²½ ì‹œ ì €ì¥
            useEffect(() => {
                localStorage.setItem('cls_save_targets_pref', JSON.stringify([...saveTargets]));
            }, [saveTargets]);

            // [New] ìƒì„¸ ë·° ë°ì´í„° ìºì‹± (ë‹«í ë•Œ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ìš©)
            useEffect(() => {
                if (selectedGrassDate) setCachedDetailDate(selectedGrassDate);
            }, [selectedGrassDate]);

            useEffect(() => {
                if (isOpen && isPortfolioMode && student) {
                    setSearchText("");
                    setSelectedStudents([student]);
                }
            }, [isOpen, isPortfolioMode, student]);

            useEffect(() => { 
                if (!student) return;
                setStickerCount(student.stickers || 0);
                if (!isLocalMode && db && appId) {
                    const unsubscribe = db.collection('classes').doc(appId).collection('studentData').doc(String(student.id))
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                if (data.counseling) setNotes(data.counseling);
                            }
                        }, err => console.error("ê°œë³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));
                    return () => unsubscribe();
                } else {
                    const data = student.counseling;
                    if (Array.isArray(data)) setNotes(data);
                    else if (data) setNotes([{ id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: data }]);
                    else setNotes([]);
                }
                setAiComment("");
                setSelectedStudents([student]);
                setNotionDate(dayjs().format('YYYY-MM-DD'));
                setNotionContent('');
                setNotionCategory('ê´€ì°°');
                setNotionStatus('idle');

                const key = localStorage.getItem('cls_notion_key');
                const dbId = localStorage.getItem('cls_notion_db_id');
                setHasNotionConfig(!!(key && dbId));
            }, [student, isLocalMode, db, appId]);

            useEffect(() => {
                setNotionDate(selectedDate || dayjs().format('YYYY-MM-DD'));
            }, [selectedDate]);

            const level = Math.floor(stickerCount / 5) + 1;
            
            const handleSticker = (delta) => { 
                const newCount = Math.max(0, stickerCount + delta);
                setStickerCount(newCount); 
                onSaveStickers(student.id, newCount); 
                if(delta > 0) {
                    setStickerEffect(true);
                    setTimeout(() => setStickerEffect(false), 200);
                    if (navigator.vibrate) navigator.vibrate(15);
                    if (newCount % 5 === 0) { 
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                        if(showToast) showToast(`ğŸ‰ ë ˆë²¨ ì—…! Lv.${Math.floor(newCount / 5) + 1} ë‹¬ì„±!`);
                    }
                    else { 
                        confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                    }
                }
            };
            
            const handleDeleteNote = (id) => {
                openConfirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    const newNotes = notes.filter(n => n.id !== id);
                    setNotes(newNotes);
                    onSaveCounseling(student.id, newNotes, "ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };
            
            const startEditing = (note) => {
                setEditingNoteId(note.id);
                setEditNoteContent(note.content);
            };

            const saveEditing = () => {
                if (!editNoteContent.trim()) return;
                const newNotes = notes.map(n => n.id === editingNoteId ? { ...n, content: editNoteContent.trim() } : n);
                setNotes(newNotes);
                onSaveCounseling(student.id, newNotes, "ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setEditingNoteId(null);
                setEditNoteContent("");
            };

            const handleStudentSelect = (name) => {
                const s = students.find(st => st.name === name);
                if (s && !selectedStudents.find(sel => sel.id === s.id)) {
                    setSelectedStudents(prev => [...prev, s]);
                }
            };
            
            const removeSelectedStudent = (id) => {
                setSelectedStudents(prev => prev.filter(s => s.id !== id));
            };

            const handleIntegratedSave = async (targetCategory) => {
                const category = targetCategory || 'ê´€ì°°';
                const content = notionContent.trim();
                const date = notionDate || dayjs().format('YYYY-MM-DD');

                if (!content) return showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setNotionStatus('saving');
                
                let tags = [];
                if (saveTargets.has('notion_record')) tags.push("ë…¸ì…˜(ê¸°ë¡)");
                if (saveTargets.has('notion_portfolio')) tags.push("ë…¸ì…˜(í¬í´)");
                if (saveTargets.has('google_sheet')) tags.push("êµ¬ê¸€ ì‹œíŠ¸");

                const newNote = { id: Date.now(), date: date, content: content, destTags: tags };
                const targetIds = selectedStudents.map(s => s.id);
                
                let updatedStudentsList = [...students];

                for (const targetId of targetIds) {
                    const studentObj = students.find(s => s.id === targetId);
                    if (!studentObj) continue;

                    let prevNotes = [];
                    // ğŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ë³´ì´ì§€ ì•ŠëŠ” í•˜ìœ„ ê¸ˆê³ (studentData)ì—ì„œ ì˜›ë‚  ê¸°ë¡ì„ ë¨¼ì € êº¼ë‚´ì˜µë‹ˆë‹¤.
                    if (!isLocalMode && db && appId) {
                        try {
                            const doc = await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).get();
                            if (doc.exists && doc.data().counseling) {
                                prevNotes = doc.data().counseling;
                            }
                        } catch (e) { console.error("ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e); }
                    } else {
                        prevNotes = studentObj.counseling || [];
                    }

                    const updatedNotes = [newNote, ...prevNotes];
                    let updatedStickers = studentObj.stickers || 0;
                    if (category === 'ì¹­ì°¬') updatedStickers += 1;

                    // ğŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ì˜›ë‚  ê¸°ë¡ê³¼ ìƒˆ ê¸°ë¡ì„ í•©ì³ì„œ ë‹¤ì‹œ ê¸ˆê³ ì— ì•ˆì „í•˜ê²Œ ë„£ìŠµë‹ˆë‹¤!
                    if (!isLocalMode && db && appId) {
                        await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).set({ counseling: updatedNotes }, { merge: true });
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, stickers: updatedStickers } : s);
                    } else {
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, counseling: updatedNotes, stickers: updatedStickers } : s);
                    }
                }

                setStudents(updatedStudentsList);
                if (!isLocalMode) saveData('cls_students', updatedStudentsList);
                else localStorage.setItem('cls_students', JSON.stringify(updatedStudentsList));

                if (targetIds.includes(student.id)) {
                    setNotes(prev => [newNote, ...prev]);
                    if (category === 'ì¹­ì°¬') {
                        setStickerCount(prev => prev + 1);
                        setShowButtonEffect(true); setTimeout(() => setShowButtonEffect(false), 800);
                        setStickerEffect(true); setTimeout(() => setStickerEffect(false), 200);
                        if (navigator.vibrate) navigator.vibrate(15);
                        if ((stickerCount + 1) % 5 === 0) { 
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 2000 });
                            if(showToast) showToast(`ğŸ‰ ë ˆë²¨ ì—…! Lv.${Math.floor((stickerCount + 1) / 5) + 1} ë‹¬ì„±!`);
                        } else { 
                            confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#fbbf24', '#f59e0b'], zIndex: 2000 });
                        }
                    }
                }

                if (saveTargets.has('google_sheet')) {
                    let successCount = 0;
                    // ğŸŒŸ ì¤„ ì„¸ìš°ì§€ ì•Šê³ , ë°°ì—´ í†µì§¸ë¡œ ì „ì†¡!
                    if (await saveToGoogleSheet(selectedStudents, category, content, date)) {
                        successCount = selectedStudents.length;
                    }
                    if (successCount > 0) {
                        setNotionStatus('success'); 
                        if (!keepContent) setNotionContent(''); 
                        setTimeout(() => setNotionStatus('idle'), 3000); 
                        showToast("âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        if (closeAfterSave) onClose();
                    }
                }

                try {
                    const rawKey = localStorage.getItem('cls_notion_key') || "";
                    const personalKey = rawKey.replace(/["']/g, '').trim();
                    const targets = [];
                    if (saveTargets.has('notion_record')) targets.push('notion_record');
                    if (saveTargets.has('notion_portfolio')) targets.push('notion_portfolio');

                    for (const target of targets) {
                        const rawDbId = (target === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
                        const targetDbId = rawDbId.replace(/["']/g, '').trim();
                        if (!personalKey || !targetDbId) continue;

                        const bodyData = { category: category, content: content, personalKey: personalKey, personalDbId: targetDbId };
                        
                        if (target === 'notion_portfolio') {
    const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
    const ids = []; selectedStudents.forEach(s => { if (map[s.name]) ids.push(map[s.name]); });
    
    // ğŸŒŸ ì„ íƒëœ ì•„ì´ë“¤ì˜ ì´ë¦„ì„ ì‰¼í‘œë¡œ ëª¨ë‘ ì—°ê²°í•©ë‹ˆë‹¤. (ì˜ˆ: "ê¹€ì² ìˆ˜, ì´ì˜í¬, ë°•ì§€ë¯¼")
    const joinedNames = selectedStudents.map(s => s.name).join(', ');
    
    bodyData.mode = 'relation'; 
    bodyData.studentIds = ids;
    bodyData.studentName = joinedNames; // ë…¸ì…˜ì˜ 'ì œëª©' ë˜ëŠ” 'ì´ë¦„' ì¹¸ì— í•œ ë²ˆì— ì „ì†¡!
    
    await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData) });
} else {
    // [Fix] ë…¸ì…˜(ê¸°ë¡) ëª¨ë“œì¼ ë•Œ ì„ íƒëœ ëª¨ë“  í•™ìƒì— ëŒ€í•´ ê°œë³„ ì €ì¥
    for (const s of selectedStudents) {
        const individualBody = { 
            ...bodyData, 
            mode: 'normal', 
            studentName: s.name, 
            date: dayjs(date).format('YYYY-MM-DD') 
        };
        await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(individualBody) });
        
        // ğŸŒŸ í•µì‹¬ í•´ê²°ì±…: ë…¸ì…˜ ì„œë²„ê°€ íŠ•ê²¨ë‚´ì§€ ëª»í•˜ê²Œ 1ëª… ì €ì¥í•  ë•Œë§ˆë‹¤ 0.35ì´ˆ(350ms)ì”© ë¶€ë“œëŸ½ê²Œ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤!
        await new Promise(resolve => setTimeout(resolve, 350));
    }
}
                    }
                    setNotionStatus('success'); if(typeof showToast !== 'undefined') showToast("âœ¨ ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì´ ì•ˆì „í•˜ê²Œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); if (!keepContent) setNotionContent(''); setTimeout(() => setNotionStatus('idle'), 3000);
                    showToast("âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } catch (e) {
                    console.error(e); setNotionStatus('error'); setTimeout(() => setNotionStatus('idle'), 3000);
                }
            };
            
            const calculateStatsForPeriod = (startStr, endStr) => {
                let pTotal = 0, pDone = 0;
                const pMissed = {};
                const tagStats = {};
                let curr = dayjs(startStr);
                const end = dayjs(endStr);
                let classTotal = 0, classDone = 0;
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    
                    if (tasks.length > 0) {
                        pTotal += tasks.length;
                        tasks.forEach(t => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            if (!tagStats[tag]) tagStats[tag] = { sTotal: 0, sDone: 0, cTotal: 0, cDone: 0 };
                        });
                        tasks.forEach((t, idx) => {
                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                            const isDone = rec?.tasks ? rec.tasks[idx] : (rec?.done && !rec.tasks);
                            tagStats[tag].sTotal++;
                            if(isDone) {
                                pDone++;
                                tagStats[tag].sDone++;
                            } else {
                                pMissed[tag] = (pMissed[tag] || 0) + 1;
                            }
                        });
                        const recs = records[dStr] || {};
                        students.forEach(s => {
                            const r = recs[s.id];
                            classTotal += tasks.length;
                            tasks.forEach((t, idx) => {
                                const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                                tagStats[tag].cTotal++;
                                let taskDone = false;
                                if (r && (r.tasks ? r.tasks[idx] : r.done)) taskDone = true;
                                if (taskDone) { tagStats[tag].cDone++; classDone++; }
                            });
                        });
                    }
                    curr = curr.add(1, 'day');
                }
                
                const pRate = pTotal > 0 ? Math.round((pDone / pTotal) * 100) : 0;
                const classAvgRate = classTotal > 0 ? Math.round((classDone / classTotal) * 100) : 0;

                return { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats };
            };
            
            useEffect(() => {
                if (isOpen && student && students) {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                }
            }, [isOpen, student, students, records, dailyTasks, reportStart, reportEnd]);
            
            // ... (generateReportContent ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€) ...
            const generateReportContent = async () => {
                if (isGenerating) return;
                setIsGenerating(true);
                try {
                    const stats = calculateStatsForPeriod(reportStart, reportEnd);
                    const { pRate, classAvgRate, pTotal, pDone, pMissed, tagStats } = stats;
                    setReportStats({ studentRate: pRate, classRate: classAvgRate, tagStats });
                    const pNotes = notes.filter(n => n.date >= reportStart && n.date <= reportEnd);
                    const missedList = Object.entries(pMissed).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]}(${x[1]}íšŒ)`);
                    const weakSubjects = [];
                    if (tagStats) {
                        Object.entries(tagStats).forEach(([tag, stat]) => {
                            const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                            const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                            if (cRate - sRate >= 15) weakSubjects.push(tag);
                        });
                    }
                    const weakSubjectsStr = weakSubjects.length > 0 ? weakSubjects.join(', ') : 'ì—†ìŒ';
                    if (apiKey) {
                        const isInsufficientData = pNotes.length < 2;
                        if(showToast) showToast("AIê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...");
                        
                        // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™” ì²˜ë¦¬
                        const safeName = "[STUDENT_TOKEN]";
                        
                        // [ë³´ì•ˆ ê°•í™”] ëŒ€ìƒ í•™ìƒ ì™¸ì— ë‹¤ë¥¸ í•™ìƒë“¤ì˜ ì´ë¦„ë„ ëª¨ë‘ ìµëª…í™”
                        let safeNotesStr = pNotes.map(n => `[${n.date}] ${n.content}`).join('\n');
                        safeNotesStr = anonymizeText(safeNotesStr, student.name);
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                        
                        const prompt = `[ë³´ì•ˆ ê·œì¹™:ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]\n\në‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ë¡œì„œ í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³  í•™ìƒì—ê²Œ ë„ì›€ì„ ì¤„ ìˆ˜ ìˆëŠ” ë‚´ìš©ìœ¼ë¡œ ì„±ì¥ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. [í•™ìƒ ì •ë³´] - ì´ë¦„: ${safeName}, ë¶„ì„ ê¸°ê°„: ${reportStart} ~ ${reportEnd}, ì„±ì‹¤ë„ ì§€í‘œ (ê³¼ì œ ìˆ˜í–‰ë¥ ): ${pRate}%, ë¶€ì¡±í•œ ê³¼ëª©: ${weakSubjectsStr}, ì¹­ì°¬ ìŠ¤í‹°ì»¤: ${stickerCount}ê°œ. [êµì‚¬ ê´€ì°° ê¸°ë¡] ${pNotes.length > 0 ? safeNotesStr : 'íŠ¹ì´ ê¸°ë¡ ì—†ìŒ'} ${isInsufficientData ? '[ê²½ê³ ] í˜„ì¬ ì´ í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ì§§ê³  ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.' : ''}`;
                        
                        const aiText = await callGemini(apiKey, prompt, 0.2);
                        
                        // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                        const finalContent = deanonymizeText(aiText, student.name);
                        setTempComment(finalContent);
                    } else {
                        const tpl = `${student.name} í•™ìƒì€ ${reportStart}ë¶€í„° ${reportEnd}ê¹Œì§€ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í–ˆìŠµë‹ˆë‹¤.\n\nì´ ê¸°ê°„ ë™ì•ˆ ê³¼ì œ ìˆ˜í–‰ë¥ ì€ ${pRate}%ì´ë©°, ${missedList.length > 0 ? `ì£¼ë¡œ ${missedList.join(', ')} ê³¼ëª©ì—ì„œ ë³´ì™„ì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.` : 'ëª¨ë“  ê³¼ëª©ì„ í›Œë¥­í•˜ê²Œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.'}\n\nê°€ì •ì—ì„œë„ ë§ì€ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;
                        setTempComment(tpl);
                    }
                } catch (e) {
                    if(showToast) showToast("ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handlePrepareReport = () => {
                const stats = calculateStatsForPeriod(reportStart, reportEnd);
                setReportStats({ studentRate: stats.pRate, classRate: stats.classAvgRate, tagStats: stats.tagStats });
                const savedDraft = student.recordDrafts?.['growth_report'];
                if (savedDraft) {
                    setTempComment(savedDraft);
                } else {
                    setTempComment(`${student.name} í•™ìƒì€ í˜„ì¬ ë ˆë²¨ ${level}ë¡œ ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.`);
                }
                setShowReportEdit(true);
            };
            
            const handleSaveReportDraft = () => onSaveRecordDraft(student.id, 'growth_report', tempComment);

            const handleDownloadReport = async () => {
                setShowReportEdit(false); setAiComment(tempComment); setIsGenerating(true);
                if(showToast) showToast("ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
                await new Promise(resolve => setTimeout(resolve, 1000));
                try {
                    const canvas = await window.html2canvas(reportRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${student.name}_ì„±ì¥ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message);
                } finally { setIsGenerating(false); }
            };
            
            const handleCopyText = () => { navigator.clipboard.writeText(tempComment).then(() => { if(showToast) showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }); };

            const grassHistory = useMemo(() => {
                const start = dayjs(grassStart);
                const end = dayjs(grassEnd);
                const diff = end.diff(start, 'day') + 1;
                const history = [];
                for (let i = 0; i < diff; i++) {
                    const d = start.add(i, 'day');
                    const dStr = d.format('YYYY-MM-DD');
                    const dayOfWeek = d.day();
                    if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                    const tasks = dailyTasks[dStr] || [];
                    const rec = records[dStr]?.[student.id];
                    let done = 0; let total = 0;
                    if (tasks.length > 0) {
                        total = tasks.length;
                        if (rec) {
                            tasks.forEach((_, idx) => {
                                if (rec.tasks && rec.tasks[idx]) done++;
                                else if (!rec.tasks && rec.done) done++;
                            });
                        }
                    } else { if (rec && rec.done) { total = 1; done = 1; } }
                    const ratio = total > 0 ? done / total : 0;
                    history.push({ date: dStr, ratio, count: done, total });
                }
                return history;
            }, [grassStart, grassEnd, dailyTasks, records, student.id]);

            const avgRate = useMemo(() => {
                const history = student.history || [];
                return history.length > 0 ? Math.round((history.reduce((acc, h) => acc + h.ratio, 0) / history.length) * 100) : 0;
            }, [student.history]);
            
            const missedTags = useMemo(() => {
                const counts = {};
                dates.forEach(date => {
                    const tasks = dailyTasks[date];
                    const rec = records[date]?.[student.id];
                    if (tasks && tasks.length > 0) {
                        tasks.forEach((task, idx) => {
                            let isDone = false;
                            if (rec) { if (rec.tasks) isDone = !!rec.tasks[idx]; else isDone = !!rec.done; }
                            if (!isDone) {
                                const tag = typeof task === 'object' ? task.tag : 'ê¸°íƒ€';
                                counts[tag] = (counts[tag] || 0) + 1;
                            }
                        });
                    }
                });
                return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
            }, [student, records, dailyTasks, dates]);
            
            const reportHistoryData = useMemo(() => {
                const history = [];
                let curr = dayjs(reportStart);
                const end = dayjs(reportEnd);
                while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                    const dStr = curr.format('YYYY-MM-DD');
                    if (curr.day() === 0 || curr.day() === 6) { curr = curr.add(1, 'day'); continue; }
                    // ...(ê°„ëµí™”ëœ ì”ë”” ë°ì´í„° ë¡œì§, ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ë Œë”ë§ì— ì‚¬ìš©ë¨)
                    history.push({ date: dStr, ratio: 0.8, count: 4, total: 5 });
                    curr = curr.add(1, 'day');
                }
                return history;
            }, [reportStart, reportEnd]); // reportHistory ìƒëµëœ ë¡œì§ ì¶•ì†Œ

            const handleSaveAIAdvice = (adviceText) => {
                const newNote = { id: Date.now(), date: dayjs().format('YYYY-MM-DD'), content: `[AI ìƒë‹´]\n${adviceText}` };
                const newNotes = [newNote, ...notes];
                setNotes(newNotes);
                onSaveCounseling(student.id, newNotes, "AI ìƒë‹´ ë‚´ìš©ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleOpenCounselingAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowCounselingAI(true);
            };
            
            const handleOpenStudentRecordAI = () => {
                if (!apiKey) return showToast("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setShowStudentRecordAI(true);
            };
            
            const getPieStyle = (ratio) => {
                if (ratio <= 0) return { backgroundColor: '#f1f5f9' };
                if (ratio >= 1) return { backgroundColor: '#22c55e' };
                const percentage = ratio * 100;
                return { background: `conic-gradient(#4ade80 0% ${percentage}%, #f1f5f9 ${percentage}% 100%)` };
            };
            
            const getLevelColor = (lv) => {
                if (lv >= 5) return 'bg-orange-500';
                if (lv === 4) return 'bg-purple-500';
                if (lv === 3) return 'bg-indigo-500';
                if (lv === 2) return 'bg-blue-500';
                return 'bg-green-500';
            };
            
            const getLevelTextColor = (lv) => {
                if (lv >= 5) return 'text-orange-500';
                if (lv === 4) return 'text-purple-500';
                if (lv === 3) return 'text-indigo-600';
                if (lv === 2) return 'text-blue-500';
                return 'text-green-500';
            };

            const handleAddPhrase = () => {
                if (!tempComment.trim()) return showToast("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, tempComment.trim()];
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_report_phrases', JSON.stringify(newPhrases));
            };
            
            const handleApplyPhrase = (text) => {
                setTempComment(prev => prev + (prev ? "\n\n" : "") + text);
                setShowPhraseList(false);
            };

           const filteredNotes = notes.filter(n => {
                const matchDate = selectedDate ? n.date === selectedDate : true;
                // ğŸŒŸ í•µì‹¬: ê²€ìƒ‰ì–´(searchTerm)ê°€ 'ë‚´ìš©(content)'ì— ìˆê±°ë‚˜ 'ë‚ ì§œ(date)'ì™€ ë˜‘ê°™ìœ¼ë©´ ë³´ì—¬ì¤˜!
                const matchText = searchTerm 
                    ? (n.content && n.content.toLowerCase().includes(searchTerm.toLowerCase())) || 
                      (n.date && n.date.includes(searchTerm)) 
                    : true;
                return matchDate && matchText;
            });
            
            const displayedNotes = isExpanded ? filteredNotes : filteredNotes.slice(0, 2);
            const hasMore = filteredNotes.length > 2;

            // [ì¶”ê°€ë¨] í™œë™ ì”ë”” (ì˜¤ëŠ˜ ë‚ ì§œ ë° ì ‘ê³  í´ê¸° ë¡œì§)
            const todayStr = dayjs().format('YYYY-MM-DD');
            const currentWeekGrass = grassHistory.filter(h => dayjs(h.date).isSame(dayjs(), 'week'));
            const defaultGrass = currentWeekGrass.length > 0 ? currentWeekGrass : grassHistory.slice(-5);
            const displayedGrass = isGrassExpanded ? grassHistory : defaultGrass;

            return (
                <div className="fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    {/* [ìˆ˜ì •ë¨] max-w-5xl, max-h-[85vh] ë¡œ í¬ê¸° ì¶•ì†Œ */}
                    <div ref={modalRef} className="bg-slate-50 w-full max-w-5xl rounded-3xl shadow-2xl p-4 md:p-6 max-h-[85vh] overflow-y-auto overflow-x-hidden custom-scroll flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header Container */}
                        <div className="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200 mb-6 flex-shrink-0">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-16 h-16 rounded-full bg-slate-50 border border-slate-200 overflow-hidden flex items-center justify-center shadow-sm flex-shrink-0">
                                        <span className="text-3xl">{student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                            {student.name}
                                            <span className="text-sm font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">{student.order}ë²ˆ</span>
                                        </div>
                                        <div className="text-sm font-bold text-indigo-500 mt-1">Level {level} <span className="text-slate-400 font-normal">| í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span></div>
                                    </div>
                                </div>
                                
                                {/* Header Action Buttons */}
                                <div className="flex items-center gap-2" id="export-hide-area">
                                    <button onClick={handleOpenCounselingAI} className="p-2 hover:bg-rose-50 text-rose-500 rounded-xl transition-colors border border-transparent hover:border-rose-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.heart} size={18}/> <span className="hidden md:inline">AI ìƒë‹´ì†Œ</span></button>
                                    <button onClick={handleOpenStudentRecordAI} className="p-2 hover:bg-blue-50 text-blue-500 rounded-xl transition-colors border border-transparent hover:border-blue-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.document} size={18}/> <span className="hidden md:inline">ì´í‰ ì´ˆì•ˆ</span></button>
                                    <button onClick={handlePrepareReport} disabled={isGenerating} className="p-2 hover:bg-indigo-50 text-indigo-600 rounded-xl transition-colors border border-transparent hover:border-indigo-100 flex items-center gap-1 text-sm font-bold"><Icon d={PATHS.edit} size={18}/> <span className="hidden md:inline">ë¦¬í¬íŠ¸ ì‘ì„±</span></button>
                                    <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                    <button onClick={onClose} className="p-2 hover:bg-slate-100 text-slate-500 rounded-xl transition-colors"><Icon d={PATHS.x} size={20}/></button>
                                </div>
                            </div>
                        </div>

                        {/* Dashboard Grid Container */}
                        <div className="lg:grid lg:grid-cols-12 lg:gap-6 space-y-6 lg:space-y-0 flex-1">
                            
                            {/* LEFT COLUMN (5/12) */}
                            <div className="lg:col-span-5 space-y-6 flex flex-col">
                                
                                {/* Missed Tags */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                                    <h4 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon d={PATHS.chart} size={16} className="text-indigo-500"/> ìì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</h4>
                                    {missedTags.length > 0 ? (
                                        <div className="space-y-3">
                                            {missedTags.map(([tag, count], i) => (
                                                <div key={tag} className="flex justify-between items-center p-2.5 bg-slate-50 rounded-xl border border-slate-100">
                                                    <span className="flex items-center gap-2">
                                                        <span className={`w-5 h-5 rounded-full flex items-center justify-center text-xs text-white font-bold ${i===0?'bg-rose-500':i===1?'bg-orange-400':'bg-yellow-400'}`}>{i+1}</span>
                                                        <span className="text-slate-700 font-bold text-sm">{tag}</span>
                                                    </span>
                                                    <span className="text-rose-500 font-bold text-sm">{count}íšŒ ë¯¸í¡</span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center text-slate-400 text-sm py-6 bg-slate-50 rounded-xl border border-dashed border-slate-200">ë¯¸í¡í•œ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</div>
                                    )}
                                </div>

                                {/* Class Average Comparison */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm cursor-pointer hover:border-indigo-300 transition-colors group" onClick={() => setShowDetailStats(!showDetailStats)}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.users} size={16} className="text-blue-500"/> í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                        <div className="flex items-center gap-1 text-xs font-bold text-slate-400 group-hover:text-indigo-500 transition-colors">
                                            <span>{showDetailStats ? 'ì ‘ê¸°' : 'ìì„¸íˆ ë³´ê¸°'}</span>
                                            <Icon d={showDetailStats ? PATHS.down : PATHS.right} size={14} />
                                        </div>
                                    </div>
                                    <div className="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div>
                                            <div className="flex justify-between text-xs mb-1.5"><span className="font-bold text-slate-600">{student.name}</span><span className={`font-black ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span></div>
                                            <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner"><div className={`h-full ${getLevelColor(level)} transition-all duration-1000`} style={{ width: `${reportStats.studentRate}%` }}></div></div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-xs mb-1.5"><span className="font-bold text-slate-600">í•™ê¸‰ í‰ê· </span><span className="font-black text-slate-500">{reportStats.classRate}%</span></div>
                                            <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-slate-400 transition-all duration-1000" style={{ width: `${reportStats.classRate}%` }}></div></div>
                                        </div>
                                    </div>

                                    {showDetailStats && reportStats.tagStats && (
                                        <div className="mt-4 pt-4 border-t border-slate-100 space-y-4 animate-fade-in" onClick={e => e.stopPropagation()}>
                                            <div className="flex justify-end mb-3">
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('bar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'bar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë§‰ëŒ€ ê·¸ë˜í”„</button>
                                                    <button onClick={(e) => { e.stopPropagation(); setChartType('radar'); }} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${chartType === 'radar' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°©ì‚¬í˜• ì°¨íŠ¸</button>
                                                </div>
                                            </div>
                                            {chartType === 'bar' ? (
                                                Object.entries(reportStats.tagStats)
                                                .filter(([tag, stat]) => stat.cDone > 0)
                                                .sort((a,b) => b[1].sTotal - a[1].sTotal).map(([tag, stat]) => {
                                                    const sRate = stat.sTotal > 0 ? Math.round((stat.sDone / stat.sTotal) * 100) : 0;
                                                    const cRate = stat.cTotal > 0 ? Math.round((stat.cDone / stat.cTotal) * 100) : 0;
                                                    const isLow = cRate - sRate >= 20;
                                                    const isHigh = sRate > cRate;
                                                    return (
                                                        <div key={tag} className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                            <div className="flex justify-between text-xs mb-2 font-bold text-slate-600">
                                                                <div className="flex items-center gap-1.5"><span className="bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-600">{tag}</span>{isHigh && <span className="text-[10px] text-orange-500 animate-pulse">í›Œë¥­í•´ìš”! ğŸ‰</span>}</div>
                                                                <div className="flex gap-3"><span className={isLow ? "text-rose-500" : getLevelTextColor(level)}>ë‚˜ {sRate}%</span><span className="text-slate-400">ë°˜ {cRate}%</span></div>
                                                            </div>
                                                            <div className="flex flex-col gap-1.5">
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className={`h-full ${isLow ? "bg-rose-500" : getLevelColor(level)}`} style={{ width: `${sRate}%` }}></div></div>
                                                                <div className="h-2 bg-slate-200 rounded-full overflow-hidden w-full"><div className="h-full bg-slate-400" style={{ width: `${cRate}%` }}></div></div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            ) : <RadarChart data={reportStats.tagStats} />}
                                        </div>
                                    )}
                                </div>

                            </div>

                            {/* RIGHT COLUMN (7/12) */}
                            <div className="lg:col-span-7 space-y-6 flex flex-col h-full">

                                {/* Sticker Area */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <h4 className="text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><span className="text-lg">ğŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤</h4>
                                        <span className="text-xs text-slate-400 font-medium">ê¸ì •ì  ê°•í™”ì™€ ë³´ìƒ</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <Btn onClick={() => handleSticker(-1)} className="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 font-bold text-lg">-</Btn>
                                        <span className={`text-3xl font-black text-yellow-500 w-12 text-center transition-transform duration-200 ${stickerEffect ? 'scale-150 text-orange-500' : ''}`}>{stickerCount}</span>
                                        <Btn onClick={() => handleSticker(1)} className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold text-lg shadow-sm">+</Btn>
                                    </div>
                                </div>

                                {/* Records Area (Logs + Input) */}
                                <div className="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm flex flex-col flex-1">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-sm font-bold text-slate-700 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 items-start">
                                            <span className="flex items-center gap-2 whitespace-nowrap"><Icon d={PATHS.document} size={16} className="text-green-500"/> êµì‚¬ ê´€ì°° ë° ì¹­ì°¬ ê¸°ë¡</span>
                                            <div className="flex flex-col sm:flex-row gap-1">
                                                {hasNotionConfig && <span className="w-fit text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />ë…¸ì…˜ ì—°ë™</span>}
                                                {hasGoogleSheetConfig && <span className="w-fit text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />êµ¬ê¸€ ì—°ë™</span>}
                                            </div>
                                        </h4>
                                    </div>

                                    {/* Unified Input Form */}
                                    <div className="flex flex-col gap-3 mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner">
                                        {saveTargets.has('notion_portfolio') && (
                                            <div className="flex flex-wrap gap-1.5 mb-1 relative">
                                                {selectedStudents.map(s => (
                                                    <span key={s.id} className="text-xs px-2.5 py-1 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                                        {s.name}
                                                        {s.id !== student.id && <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500 bg-indigo-100 rounded-full p-0.5"><Icon d={PATHS.x} size={10}/></button>}
                                                    </span>
                                                ))}
                                            </div>
                                        )}

                                        {/* [New] ì €ì¥ì†Œ ì„ íƒ íƒ­ UI */}
                                        {(hasNotionRecord || hasNotionPortfolio || hasGoogleSheet) ? (
                                            <div className="flex gap-1 bg-white p-1 rounded-xl border border-slate-200">
                                                {hasNotionRecord && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_record')) next.delete('notion_record'); else next.add('notion_record'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_record') ? 'bg-indigo-50 text-indigo-600 shadow-sm ring-1 ring-indigo-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(ê¸°ë¡)</button>}
                                                {hasNotionPortfolio && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_portfolio')) next.delete('notion_portfolio'); else next.add('notion_portfolio'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_portfolio') ? 'bg-amber-50 text-amber-600 shadow-sm ring-1 ring-amber-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(í¬í´)</button>}
                                                {hasGoogleSheet && <button onClick={() => { const next = new Set(saveTargets); if(next.has('google_sheet')) next.delete('google_sheet'); else next.add('google_sheet'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('google_sheet') ? 'bg-green-50 text-green-600 shadow-sm ring-1 ring-green-100' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>}
                                            </div>
                                        ) : (
                                            <div className="text-center text-xs text-slate-400 py-2 bg-slate-50 rounded-xl border border-slate-200 border-dashed">ì—°ë™ëœ ì™¸ë¶€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤ (ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)</div>
                                        )}

                                        <div className="flex items-center gap-2 relative z-20">
                                            {saveTargets.has('notion_portfolio') && (
                                                <div className="flex-1 relative">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <Icon d={PATHS.search} size={14} className="text-slate-400" />
                                                    </div>
                                                    <input 
                                                        placeholder="ë‹¤ë¥¸ í•™ìƒ í•¨ê»˜ íƒœê·¸í•˜ê¸°..." 
                                                        className="w-full p-2.5 pl-9 bg-white border border-slate-300 rounded-xl text-xs font-medium outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all shadow-sm" 
                                                        value={searchText}
                                                        onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }}
                                                        onFocus={() => setShowStudentDropdown(true)}
                                                        onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)}
                                                    />
                                                    {showStudentDropdown && (
                                                        <div className="absolute top-full left-0 w-full bg-white shadow-2xl border border-slate-200 rounded-xl z-50 max-h-48 overflow-y-auto mt-2 custom-scroll py-1 animate-fade-in">
                                                            <div className="px-3 py-1.5 text-[10px] font-bold text-slate-400 bg-slate-50 border-b border-slate-100 mb-1">í•™ìƒ ê²€ìƒ‰</div>
                                                            {students.filter(s => s.name.includes(searchText)).sort((a, b) => a.name.localeCompare(b.name)).map(s => (
                                                                <div 
                                                                    key={s.id} 
                                                                    className="px-3 py-2.5 text-xs text-slate-700 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center"
                                                                    onMouseDown={() => { handleStudentSelect(s.name); setSearchText(""); }}
                                                                >
                                                                    <span className="font-bold flex items-center gap-2"><span className="text-[10px] text-slate-400 font-normal">{s.order}ë²ˆ</span> {s.name}</span>
                                                                    {selectedStudents.find(sel => sel.id === s.id) && <Icon d={PATHS.check} size={12} className="text-indigo-500 bg-indigo-100 rounded-full p-0.5"/>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-600 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 shadow-sm" />
                                        </div>
                                        
                                        <textarea 
                                            value={notionContent}
                                            onChange={(e) => setNotionContent(e.target.value)}
                                            className="w-full p-3.5 bg-white border border-slate-300 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 resize-none h-24 placeholder-slate-400 shadow-sm"
                                            placeholder="ê´€ì°°í•œ ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                        />
                                        
                                        <div className="flex justify-end -mt-1">
                                            <label className="flex items-center gap-1.5 cursor-pointer select-none">
                                                <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5 text-indigo-600 rounded focus:ring-indigo-500" />
                                                <span className="text-[10px] text-slate-500 font-bold hover:text-slate-700">ì €ì¥ í›„ ë‚´ìš© ìœ ì§€</span>
                                            </label>
                                        </div>
                                        
                                        <div className="flex gap-2.5">
                                            <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} disabled={notionStatus === 'saving'} className={`relative flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md whitespace-nowrap ${notionStatus === 'saving' ? 'bg-rose-300' : 'bg-rose-500 hover:bg-rose-600 active:scale-95'}`}>
                                                ì¹­ì°¬í•˜ê¸° +1
                                            </button>
                                            <button onClick={() => handleIntegratedSave('ê´€ì°°')} disabled={notionStatus === 'saving'} className={`flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 shadow-md whitespace-nowrap ${notionStatus === 'saving' ? 'bg-indigo-300' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                                                ê´€ì°° ê¸°ë¡ ì €ì¥
                                            </button>
                                        </div>
                                    </div>

                                    {/* Logs Search & Accordion */}
                                    <div className="mb-4 flex gap-2 relative">
                                        
                                        {/* 1. í…ìŠ¤íŠ¸ ê²€ìƒ‰ì°½ */}
                                        <div className="relative flex-1">
                                            <Icon d={PATHS.search} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                                            <input
                                                type="text"
                                                value={searchTerm}
                                                onChange={e => setSearchTerm(e.target.value)}
                                                placeholder="ë‚´ìš© ë˜ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒ..."
                                                className="w-full pl-9 pr-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none transition-colors"
                                            />
                                        </div>
                                        
                                        {/* 2. ë‹¬ë ¥ ì—¬ëŠ” ë²„íŠ¼ */}
                                        <button
                                            onClick={() => setShowSearchCal(!showSearchCal)}
                                            className="p-2 border border-slate-200 bg-slate-50 rounded-xl hover:bg-indigo-50 text-slate-500 transition-colors"
                                            title="ë‹¬ë ¥ìœ¼ë¡œ ë‚ ì§œ ì°¾ê¸°"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </button>

                                        {/* 3. íŠ¹ì • ë‚ ì§œ ì„ íƒ ì‹œ ì·¨ì†Œ(X) ë²„íŠ¼ (í•„ìˆ˜ ë³µêµ¬!) */}
                                        {selectedDate && (
                                            <button onClick={() => setSelectedDate(null)} className="px-3 py-2 bg-indigo-50 border border-indigo-100 text-indigo-600 rounded-xl text-xs font-bold whitespace-nowrap flex items-center gap-1 hover:bg-indigo-100 transition-colors">
                                                {dayjs(selectedDate).format('MM/DD')} <Icon d={PATHS.x} size={12}/>
                                            </button>
                                        )}

                                        {/* 4. ë¯¸ë‹ˆ íŒì—… ë‹¬ë ¥ */}
                                        {showSearchCal && (
                                            <div className="absolute top-12 right-0 mt-1 bg-white border border-slate-100 shadow-2xl shadow-indigo-100/50 rounded-3xl p-4 z-50 w-72 animate-fade-in">
                                                <div className="flex justify-between items-center mb-4 px-1">
                                                    <button onClick={() => setCalMonth(calMonth.subtract(1, 'month'))} className="p-1.5 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors"><Icon d={PATHS.left} size={16} /></button>
                                                    <span className="font-extrabold text-sm text-slate-800">{calMonth.format('YYYYë…„ Mì›”')}</span>
                                                    <button onClick={() => setCalMonth(calMonth.add(1, 'month'))} className="p-1.5 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors"><Icon d={PATHS.right} size={16} /></button>
                                                </div>
                                                <div className="grid grid-cols-7 mb-2 text-center">
                                                    {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((d, i) => (
                                                        <div key={d} className={`text-[10px] font-bold pb-1 ${i === 0 ? 'text-red-400' : i === 6 ? 'text-blue-400' : 'text-slate-400'}`}>{d}</div>
                                                    ))}
                                                </div>
                                                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                                                    {Array.from({ length: calMonth.startOf('month').day() }).map((_, i) => <div key={`empty-${i}`} />)}
                                                    {Array.from({ length: calMonth.daysInMonth() }).map((_, i) => {
                                                        const dateStr = calMonth.date(i + 1).format('YYYY-MM-DD');
                                                        const hasRecord = recordDates.includes(dateStr); 
                                                        const isSelected = searchTerm === dateStr;
                                                        const isToday = dateStr === dayjs().format('YYYY-MM-DD');
                                                        
                                                        let cellClass = "aspect-square flex flex-col items-center justify-center rounded-full text-xs font-medium cursor-pointer transition-all duration-200 relative group";
                                                        if (isSelected) cellClass += " bg-indigo-600 text-white shadow-md shadow-indigo-200 font-bold transform scale-105 z-10";
                                                        else if (isToday) cellClass += " text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100";
                                                        else cellClass += " text-slate-600 hover:bg-slate-100";

                                                        return (
                                                            <button
                                                                key={i}
                                                                onClick={() => {
                                                                    setSearchTerm(dateStr); 
                                                                    setShowSearchCal(false); 
                                                                }}
                                                                className={cellClass}
                                                            >
                                                                <span>{i + 1}</span>
                                                                {hasRecord && !isSelected && <div className={`absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full ${isToday ? 'bg-indigo-400' : 'bg-blue-400'}`}></div>}
                                                                {isSelected && (
                                                                    <div className="absolute -top-0.5 -right-0.5 bg-white text-indigo-600 rounded-full p-[1px] shadow-sm animate-bounce-in z-20"><Icon d={PATHS.check} size={8} strokeWidth={4} /></div>
                                                                )}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1 max-h-[400px]">
                                        {displayedNotes.length > 0 ? displayedNotes.map(n => (
                                            <div key={n.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm group hover:border-indigo-200 transition-colors">
                                                {editingNoteId === n.id ? (
                                                    <div className="flex flex-col gap-3">
                                                        <textarea value={editNoteContent} onChange={(e) => setEditNoteContent(e.target.value)} className="w-full p-3 border border-indigo-300 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-100 resize-none bg-indigo-50/30" rows="3" />
                                                        <div className="flex justify-end gap-2">
                                                            <Btn onClick={() => setEditingNoteId(null)} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                                                            <Btn onClick={saveEditing} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold shadow-md hover:bg-indigo-700">ì €ì¥</Btn>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-1.5 flex-wrap">
                                                                <span className="text-[10px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-2 py-1 rounded-md">{n.date}</span>
                                                                
                                                                {/* 1. ì˜ˆì „ ê¸°ë¡ í˜¸í™˜ìš© (ë‹¨ì¼ ë°°ì§€) */}
                                                                {n.destTag && !n.destTags && (
                                                                    <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded border shadow-sm ${n.destTag.includes('ë…¸ì…˜') ? (n.destTag.includes('í¬í´') ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100') : 'bg-green-50 text-green-600 border-green-100'}`}>
                                                                        {n.destTag}
                                                                    </span>
                                                                )}

                                                                {/* 2. ìƒˆë¡œìš´ ê¸°ë¡ìš© (ì—¬ëŸ¬ ê°œì˜ ë°°ì§€ë¥¼ ë‚˜ë€íˆ í‘œì‹œ) */}
                                                                {n.destTags && n.destTags.map((tag, idx) => (
                                                                    <span key={idx} className={`text-[9px] font-bold px-1.5 py-0.5 rounded border shadow-sm ${tag.includes('ë…¸ì…˜') ? (tag.includes('í¬í´') ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100') : 'bg-green-50 text-green-600 border-green-100'}`}>
                                                                        {tag}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={() => startEditing(n)} className="text-slate-400 hover:text-indigo-600 p-1 bg-slate-50 hover:bg-indigo-50 rounded"><Icon d={PATHS.edit} size={14}/></button>
                                                                <button onClick={() => handleDeleteNote(n.id)} className="text-slate-400 hover:text-rose-600 p-1 bg-slate-50 hover:bg-rose-50 rounded"><Icon d={PATHS.x} size={14}/></button>
                                                            </div>
                                                        </div>
                                                        <p className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed font-medium">{n.content}</p>
                                                    </>
                                                )}
                                            </div>
                                        )) : (
                                            <div className="h-32 flex flex-col items-center justify-center text-slate-400 text-sm gap-3 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                                                <Icon d={PATHS.document} size={24} className="opacity-30" />
                                                <span>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                            </div>
                                        )}
                                        {hasMore && (
                                            <button onClick={() => setIsExpanded(!isExpanded)} className="w-full py-3 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-3 shadow-sm">
                                                {isExpanded ? 'ì ‘ê¸°' : `ê³¼ê±° ê¸°ë¡ ${filteredNotes.length - 2}ê°œ ë” ë³´ê¸°`} 
                                                <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {/* [ìˆ˜ì •ë¨] Grass Chart Area - 5x5 ë‹¬ë ¥í˜• ë° ì˜¤ëŠ˜ ë‚ ì§œ í…Œë‘ë¦¬ ê°•ì¡° */}
                                <div className="bg-white p-6 border border-slate-100 rounded-3xl shadow-xl shadow-indigo-50/50 overflow-hidden">
                                    {/* [New] Grid Overlay êµ¬ì¡°ë¡œ ë³€ê²½í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¼ì´ë“œ êµ¬í˜„ */}
                                    <div className="grid grid-cols-1 grid-rows-1">
                                        
                                        {/* 1. ìƒì„¸ ë·° (Detail View) - ì˜¤ë¥¸ìª½ì—ì„œ ë“¤ì–´ì˜´ */}
                                        <div className={`col-start-1 row-start-1 w-full transition-all duration-300 ease-in-out transform ${isDetailViewOpen ? 'translate-x-0 opacity-100 visible' : 'translate-x-full opacity-0 invisible pointer-events-none'}`}>
                                            {(selectedGrassDate || cachedDetailDate) && (() => {
                                                const detailDate = selectedGrassDate || cachedDetailDate;
                                                return (
                                                    <>
                                                        <div className="flex items-center justify-between mb-6">
                                                            <button onClick={() => setIsDetailViewOpen(false)} className="p-2 hover:bg-slate-100 rounded-xl text-slate-500 transition-colors flex items-center gap-1 text-xs font-bold bg-slate-50 border border-slate-200 whitespace-nowrap">
                                                                <Icon d={PATHS.left} size={14} /> ëª©ë¡ìœ¼ë¡œ
                                                            </button>
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-8 h-8 rounded-full shadow-inner flex items-center justify-center relative overflow-hidden bg-slate-100" style={getPieStyle(grassHistory.find(h => h.date === detailDate)?.ratio || 0)}></div>
                                                                <span className="text-base font-extrabold text-slate-800 whitespace-nowrap">{dayjs(detailDate).format('Mì›” Dì¼ (ddd)')}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="space-y-6">
                                                            <div>
                                                                <div className="flex items-center gap-2 mb-3">
                                                                    <div className="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg"><Icon d={PATHS.check} size={14} strokeWidth={3} /></div>
                                                                    <h4 className="text-sm font-bold text-slate-700">ê³¼ì œ ìˆ˜í–‰ í˜„í™©</h4>
                                                                </div>
                                                                {(dailyTasks[detailDate] || []).length > 0 ? (
                                                                    <div className="space-y-2">
                                                                        {(dailyTasks[detailDate] || []).map((t, i) => {
                                                                            const title = typeof t === 'object' ? t.title : t;
                                                                            const tag = typeof t === 'object' ? t.tag : 'ê¸°íƒ€';
                                                                            const rec = records[detailDate]?.[student.id];
                                                                            const isDone = rec ? (rec.tasks ? rec.tasks[i] : rec.done) : false;
                                                                            return (
                                                                                <div key={i} className={`flex items-center justify-between p-3 rounded-2xl border transition-all ${isDone ? 'bg-indigo-50/50 border-indigo-100' : 'bg-white border-slate-100'}`}>
                                                                                    <div className="flex items-center gap-3 overflow-hidden w-full">
                                                                                        <div className={`w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 border transition-colors ${isDone ? 'bg-indigo-500 border-indigo-500 text-white' : 'bg-white border-slate-300'}`}>
                                                                                            {isDone && <Icon d={PATHS.check} size={12} strokeWidth={4} />}
                                                                                        </div>
                                                                                        <div className="flex flex-col min-w-0 flex-1">
                                                                                            <div className="flex items-center gap-1.5 mb-0.5"><span className="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded font-bold">{tag}</span></div>
                                                                                            <span className={`text-sm truncate ${isDone ? 'text-slate-700 font-bold' : 'text-slate-500'}`}>{title}</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                ) : (
                                                                    <div className="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-2xl border border-dashed border-slate-200 flex flex-col items-center gap-2"><span className="text-2xl opacity-50">ğŸ“­</span><span>ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</span></div>
                                                                )}
                                                            </div>
                                                            {notes.filter(n => n.date === detailDate).length > 0 && (
                                                                <div>
                                                                    <div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-yellow-100 text-yellow-600 rounded-lg"><Icon d={PATHS.edit} size={14} strokeWidth={3} /></div><h4 className="text-sm font-bold text-slate-700">ê´€ì°° ë° ìƒë‹´</h4></div>
                                                                    <div className="space-y-2">{notes.filter(n => n.date === detailDate).map(n => (<div key={n.id} className="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap shadow-sm relative overflow-hidden"><div className="absolute top-0 left-0 w-1 h-full bg-yellow-300"></div>{n.content}</div>))}</div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>

                                        {/* 2. ëª©ë¡ ë·° (List View) - ì™¼ìª½ìœ¼ë¡œ ë‚˜ê° */}
                                        <div className={`col-start-1 row-start-1 w-full transition-all duration-300 ease-in-out transform ${isDetailViewOpen ? '-translate-x-full opacity-0 invisible pointer-events-none' : 'translate-x-0 opacity-100 visible'}`}>
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 sm:gap-0">
                                                <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2 whitespace-nowrap">
                                                    <Icon d={PATHS.calendar} size={16} className="text-orange-500"/> í™œë™ ì”ë”” 
                                                    <span className="text-indigo-600 font-extrabold text-xs bg-indigo-50 px-2 py-0.5 rounded-md whitespace-nowrap">{dayjs(grassStart).format('YYYYë…„ Mì›”')}</span>
                                                    <div className="relative ml-1 flex items-center">
                                                        <button onClick={(e) => { e.stopPropagation(); setShowThemePicker(!showThemePicker); }} className="p-1.5 hover:bg-slate-100 rounded-full transition-colors" title="ê°•ì¡° ìƒ‰ìƒ ë³€ê²½">
                                                            <div className={`w-4 h-4 rounded-full ${GRASS_THEMES[grassTheme].bg} border-2 ${GRASS_THEMES[grassTheme].border}`}></div>
                                                        </button>
                                                        {showThemePicker && (
                                                            <div className="absolute top-full left-0 mt-2 bg-white p-2 rounded-xl shadow-xl border border-slate-100 z-50 flex gap-1.5 animate-fade-in w-max" onClick={(e) => e.stopPropagation()}>
                                                                {Object.entries(GRASS_THEMES).map(([key, theme]) => (
                                                                    <button key={key} onClick={() => { setGrassTheme(key); localStorage.setItem('cls_grass_theme', key); setShowThemePicker(false); }} className={`w-6 h-6 rounded-full ${theme.bg} border-2 ${theme.border} hover:scale-110 transition-transform ring-1 ring-offset-1 ${grassTheme === key ? 'ring-slate-400' : 'ring-transparent'}`}></button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </h4>
                                                <div className="flex flex-col items-end sm:items-center gap-1 w-full sm:w-auto">
                                                    <div className="flex gap-1 bg-slate-100 p-1 rounded-lg w-full sm:w-auto justify-center sm:justify-start">
                                                        <button onClick={() => { const prev = dayjs(grassStart).subtract(1, 'month'); setGrassStart(prev.startOf('month').format('YYYY-MM-DD')); setGrassEnd(prev.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.left} size={12}/></button>
                                                        <button onClick={() => { const now = dayjs(); setGrassStart(now.startOf('month').format('YYYY-MM-DD')); setGrassEnd(now.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(false); setDateRangeAnim(true); setTimeout(() => setDateRangeAnim(false), 500); }} className="text-[10px] px-2.5 py-1 rounded-md font-bold text-slate-600 hover:bg-white shadow-sm transition-all whitespace-nowrap">ì´ë²ˆ ë‹¬</button>
                                                        <button onClick={() => { const next = dayjs(grassStart).add(1, 'month'); setGrassStart(next.startOf('month').format('YYYY-MM-DD')); setGrassEnd(next.endOf('month').format('YYYY-MM-DD')); setIsGrassExpanded(true); }} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all"><Icon d={PATHS.right} size={12}/></button>
                                                        <button onClick={() => setIsCalendarOpen(true)} className="p-1 hover:bg-white rounded-md text-slate-500 shadow-sm transition-all ml-1" title="ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={12}/></button>
                                                    </div>
                                                    <span className={`text-[10px] text-slate-400 font-medium transition-all duration-300 whitespace-nowrap ${dateRangeAnim ? 'text-indigo-600 font-bold scale-110' : ''}`}>{dayjs(grassStart).format('YY.MM.DD')} ~ {dayjs(grassEnd).format('YY.MM.DD')}</span>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-5 gap-y-6 gap-x-2 justify-items-center py-4 mt-2">
                                                {displayedGrass.map((h, i) => {
                                                    const isToday = h.date === todayStr;
                                                    const theme = GRASS_THEMES[grassTheme];
                                                    // [New] íˆ´íŒ ìœ„ì¹˜ ì¡°ì • (ê°€ì¥ìë¦¬ ì˜ë¦¼ ë°©ì§€)
                                                    const colIndex = i % 5;
                                                    let tooltipPos = "left-1/2 -translate-x-1/2";
                                                    let arrowPos = "left-1/2 -translate-x-1/2";
                                                    if (colIndex === 0) { tooltipPos = "left-0"; arrowPos = "left-6"; }
                                                    else if (colIndex === 4) { tooltipPos = "right-0"; arrowPos = "right-6"; }

                                                    return (
                                                    <div key={i} onClick={() => { setSelectedGrassDate(h.date); setIsDetailViewOpen(true); }} className={`flex flex-col items-center gap-2 group relative cursor-pointer p-2 rounded-2xl transition-all duration-200 ease-out ${selectedGrassDate === h.date ? `${isToday ? theme.bg : 'bg-white'} border-2 ${isToday ? 'border-transparent' : 'border-indigo-100'} scale-100 md:scale-105 shadow-md z-20` : (isToday ? `${theme.bg} border-2 border-transparent shadow-sm scale-100 md:scale-110 hover:scale-105 md:hover:scale-115 z-10` : 'hover:bg-slate-50 border-2 border-transparent hover:border-slate-100 hover:scale-110 hover:shadow-lg hover:z-30')}`}>
                                                        <div className={`w-12 h-12 rounded-full shadow-inner flex items-center justify-center relative overflow-hidden bg-slate-100 ${isToday ? `ring-4 ${theme.ring} ring-offset-2` : ''}`} style={getPieStyle(h.ratio)}></div>
                                                        <span className={`text-xs ${isToday ? `${theme.text} font-black` : selectedGrassDate === h.date ? 'text-slate-800 font-bold' : 'text-slate-500 font-medium'}`}>{dayjs(h.date).format('MM/DD')}</span>
                                                        <div className={`absolute bottom-full mb-2 z-50 w-max bg-slate-900 text-white rounded-xl px-3 py-2 shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-y-1 group-hover:translate-y-0 pointer-events-none flex items-center gap-3 ${tooltipPos}`}>
                                                            <span className="text-[10px] text-slate-400 font-medium whitespace-nowrap">{dayjs(h.date).format('YYYY.MM.DD (ddd)')}</span>
                                                            <div className="w-px h-3 bg-slate-700"></div>
                                                            <div className="flex items-center gap-2 justify-center whitespace-nowrap">
                                                                <div className={`w-2 h-2 rounded-full ${h.ratio === 1 ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]' : h.ratio > 0 ? 'bg-yellow-400' : 'bg-slate-600'}`}></div>
                                                                <span className="text-xs font-bold">{Math.round(h.ratio * 100)}%</span>
                                                                <span className="text-[10px] text-slate-500 font-medium">({h.count}/{h.total})</span>
                                                            </div>
                                                            <div className={`absolute top-full border-[6px] border-transparent border-t-slate-900 ${arrowPos}`}></div>
                                                        </div>
                                                    </div>
                                                )})}
                                            </div>
                                            {grassHistory.length > 5 && (
                                                <button onClick={() => setIsGrassExpanded(!isGrassExpanded)} className="w-full py-2 text-xs font-bold text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all flex items-center justify-center gap-1.5 mt-4 shadow-sm">
                                                    {isGrassExpanded ? 'ì´ë²ˆ ì£¼ë§Œ ë³´ê¸°' : 'ì´ë²ˆ ë‹¬ ì „ì²´ ë³´ê¸°'}
                                                    <Icon d={PATHS.down} size={14} className={`transition-transform duration-300 ${isGrassExpanded ? 'rotate-180' : ''}`} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        {/* ìˆ¨ê²¨ì§„ ë¦¬í¬íŠ¸ ëª¨ë‹¬, AI ëª¨ë‹¬ ë“± ëª¨ë‘ ìœ ì§€ */}
                        <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                            <div ref={reportRef} className={`w-[800px] bg-white p-12 border border-slate-200 text-slate-800 ${reportFont === 'serif' ? 'font-serif' : reportFont === 'hand' ? 'font-hand' : reportFont === 'jua' ? 'font-jua' : reportFont === 'nanum' ? 'font-nanum' : reportFont === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                                <div className="text-center border-b-2 border-slate-800 pb-6 mb-8">
                                    <h1 className="text-4xl font-extrabold text-slate-900 mb-2">ğŸŒ± í•™ìŠµ ì„±ì¥ ë¦¬í¬íŠ¸</h1>
                                    <p className="text-slate-500 text-lg">{dayjs().format('YY.MM.DD')}</p>
                                </div>
                                <div className="flex gap-8 mb-8">
                                    <div className="w-32 h-32 rounded-full bg-slate-100 border-4 border-slate-200 overflow-hidden flex items-center justify-center flex-shrink-0">
                                        <span className="text-6xl">{student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center">
                                        <div className="flex items-baseline gap-3 mb-2"><h2 className="text-3xl font-bold text-slate-800">{student.name}</h2><span className="text-xl text-slate-500">{student.order}ë²ˆ</span></div>
                                        <div className="flex gap-4"><span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-bold">Lv.{level}</span><span className="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">í‰ê·  ìˆ˜í–‰ë¥  {avgRate}%</span><span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg font-bold">ì¹­ì°¬ ìŠ¤í‹°ì»¤ {stickerCount}ê°œ</span></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-8 mb-8">
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ğŸ“Š í™œë™ ë¶„ì„</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center"><span className="text-slate-600">ìµœê·¼ 30ì¼ í™œë™</span><span className="font-bold text-indigo-600">{student.history.length}ì¼ ì¤‘ {student.history.filter(h=>h.ratio===1).length}ì¼ ì™„ë£Œ</span></div>
                                            <div><span className="text-slate-600 block mb-1">ìì£¼ ë†“ì¹˜ëŠ” ê³¼ëª©</span>{missedTags.length > 0 ? (<div className="flex gap-2 flex-wrap">{missedTags.map(([t, c]) => <span key={t} className="text-xs bg-white border border-slate-200 px-2 py-1 rounded-md text-rose-500 font-bold">{t} ({c}íšŒ)</span>)}</div>) : <span className="text-sm text-green-600 font-bold">ì—†ìŒ (í›Œë¥­í•´ìš”!)</span>}</div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-100">
                                            <h4 className="text-sm font-bold text-slate-600 mb-2">ğŸ“Š í•™ê¸‰ í‰ê·  ë¹„êµ</h4>
                                            <div className="space-y-2">
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">{student.name}</span><span className={`font-bold ${getLevelTextColor(level)}`}>{reportStats.studentRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${getLevelColor(level)}`} style={{ width: `${reportStats.studentRate}%` }}></div></div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">í•™ê¸‰ í‰ê· </span><span className="font-bold text-slate-600">{reportStats.classRate}%</span></div>
                                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-400" style={{ width: `${reportStats.classRate}%` }}></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="font-bold text-lg text-slate-700 mb-4 border-b border-slate-200 pb-2">ğŸ“ ì„ ìƒë‹˜ì˜ í•œë§ˆë””</h3>
                                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{aiComment || "ë¶„ì„ ì¤‘..."}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showCounselingAI && (
                            <CounselingAIModal isOpen={showCounselingAI} onClose={() => setShowCounselingAI(false)} student={student} students={students} apiKey={apiKey} showToast={showToast} onSave={handleSaveAIAdvice} notes={notes} />
                        )}

                        {showStudentRecordAI && (
                            <StudentRecordAIModal isOpen={showStudentRecordAI} onClose={() => setShowStudentRecordAI(false)} student={student} students={students} apiKey={apiKey} showToast={showToast} notes={notes} dailyTasks={dailyTasks} records={records} appConfig={appConfig} onSaveDraft={onSaveRecordDraft} />
                        )}

                        {showReportEdit && (
                            <div className="fixed inset-0 bg-black/50 z-[1700] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={() => setShowReportEdit(false)}>
                                <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon d={PATHS.edit} className="text-indigo-500" /> ë¦¬í¬íŠ¸ ì‘ì„±</h3>
                                        <button onClick={() => setShowReportEdit(false)} className="p-2 hover:bg-slate-100 rounded-full"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                            <input type="date" value={reportStart} onChange={e=>setReportStart(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                            <span className="text-xs text-slate-400">~</span>
                                            <input type="date" value={reportEnd} onChange={e=>setReportEnd(e.target.value)} className="text-xs p-1 border rounded bg-white"/>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ìƒë‹´ ëª©ì  (Purpose)</label>
                                                <select value={reportPurpose} onChange={e=>setReportPurpose(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="regular">ğŸ“… ì •ê¸° ìƒë‹´ (ì„±ì¥ ê³µìœ )</option><option value="issue">â¤ï¸ ìƒí™œ ì§€ë„ (ë¬¸ì œ ê°œì„ )</option><option value="study">ğŸ“š í•™ì—… ìƒë‹´ (ì„±ì  í–¥ìƒ)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ë¦¬í¬íŠ¸ ì–´ì¡° (Tone)</label>
                                                <select value={reportTone} onChange={e=>setReportTone(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="warm">ğŸ¥° ë”°ëœ»/ì¹­ì°¬ (ê¸°ë³¸)</option><option value="rational">ğŸ“Š ê°ê´€/ë¶„ì„</option><option value="coaching">ğŸ”¥ ì„±ì¥/ì½”ì¹­</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ê¸€ê¼´ (Font)</label>
                                                <select value={reportFont} onChange={e=>setReportFont(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="sans">ê¸°ë³¸ ê³ ë”•</option><option value="nanum">ë‚˜ëˆ”ê³ ë”•</option><option value="nanum-bold">ë‚˜ëˆ”ê³ ë”• (Bold)</option><option value="serif">ë‚˜ëˆ”ëª…ì¡°</option><option value="jua">ì£¼ì•„ì²´</option><option value="hand">ê°œêµ¬ì²´ (ì†ê¸€ì”¨)</option></select>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <label className="text-[10px] font-bold text-slate-500">ì¤‘ì  ë¶„ì„ ë¶„ì•¼ (Focus)</label>
                                                <select value={reportFocus} onChange={e=>setReportFocus(e.target.value)} className="text-xs p-1.5 border rounded bg-white outline-none"><option value="comprehensive">ğŸ« í•™êµìƒí™œ ì¢…í•©</option><option value="study">ğŸ“ í•™ìŠµ íƒœë„</option><option value="relationship">ğŸ¤ êµìš° ê´€ê³„</option><option value="habit">â° ìƒí™œ ìŠµê´€</option></select>
                                            </div>
                                        </div>
                                        <Btn onClick={generateReportContent} disabled={isGenerating} className={`w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 ${apiKey ? 'bg-violet-100 text-violet-700 hover:bg-violet-200' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                                            {isGenerating ? 'ì‘ì„± ì¤‘...' : apiKey ? 'âœ¨ AIë¡œ ë¦¬í¬íŠ¸ ìƒˆë¡œ ì‘ì„±í•˜ê¸°' : 'ğŸ”„ ê¸°ê°„ ì„¤ì • ì ìš©í•˜ì—¬ ë‹¤ì‹œ ì“°ê¸°'}
                                        </Btn>
                                        {!apiKey && <div className="text-[10px] text-slate-400 mt-1 text-center">* ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë” í’ì„±í•œ ë‚´ìš©ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.</div>}
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-end px-1">
                                            <div className="flex gap-2 items-center">
                                                <span className="text-xs font-bold text-slate-500">ë‚´ìš© í¸ì§‘</span>
                                                <div className="relative">
                                                    <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                                        <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                                    </button>
                                                    {showPhraseList && (
                                                        <div className="absolute left-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                            <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                                <span className="text-xs font-bold text-slate-600">ì €ì¥ëœ ë¬¸êµ¬</span>
                                                                <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
                                                            </div>
                                                            <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                                {phrases.length > 0 ? phrases.map((p, i) => (
                                                                    <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                                        <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                                    </div>
                                                                )) : <div className="text-center text-slate-400 text-xs py-2">ì €ì¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <button onClick={() => { let comment = `${student.name} í•™ìƒì€ í˜„ì¬ ë ˆë²¨ ${level}ë¡œ, í‰ê·  ìˆ˜í–‰ë¥  ${avgRate}%ë¥¼ ê¸°ë¡í•˜ë©° ì„±ì‹¤í•˜ê²Œ í•™êµ ìƒí™œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ${missedTags.length > 0 ? `íŠ¹íˆ ${missedTags.map(t=>t[0]).join(', ')} ê³¼ëª©ì— ì¡°ê¸ˆ ë” ê´€ì‹¬ì„ ê¸°ìš¸ì¸ë‹¤ë©´ ë”ìš± ì„±ì¥í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.` : "ëª¨ë“  ê³¼ëª©ì—ì„œ ê³ ë¥´ê²Œ ìš°ìˆ˜í•œ ëª¨ìŠµì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤."} ê°€ì •ì—ì„œë„ ë§ì€ ì¹­ì°¬ê³¼ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`; setTempComment(comment); }} className="text-[10px] text-slate-400 hover:text-rose-500 underline">ì´ˆê¸°í™”</button>
                                        </div>
                                        <textarea className="w-full h-48 p-4 border border-slate-200 rounded-xl text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none custom-scroll" value={tempComment} onChange={(e) => setTempComment(e.target.value)} placeholder="ë¦¬í¬íŠ¸ì— ë“¤ì–´ê°ˆ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." />
                                        <div className="flex gap-2">
                                            <Btn onClick={handleSaveReportDraft} className="flex-1 py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.check} /> ì´ˆì•ˆ ì €ì¥</Btn>
                                            <Btn onClick={handleCopyText} className="flex-1 py-3 bg-white border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 shadow-sm flex items-center justify-center gap-2"><Icon d={PATHS.copy} /> í…ìŠ¤íŠ¸ ë³µì‚¬</Btn>
                                            <Btn onClick={handleDownloadReport} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Icon d={PATHS.download} /> ì´ë¯¸ì§€ë¡œ ì €ì¥</Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isCalendarOpen && (
                            <CalendarModal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} currentDate={grassStart} selectionMode="range" onSelectRange={(s, e) => { setGrassStart(s); setGrassEnd(e); }} records={records} appConfig={appConfig} groupsByDate={{}} mode="record" />
                        )}
                    </div>
                </div>
            );
        };
        const StudentRecordAIModal = ({ isOpen, onClose, student, students, apiKey, showToast, notes, dailyTasks, records, appConfig, onSaveDraft }) => {
            const [draft, setDraft] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [keywords, setKeywords] = useState("");
            const [recordType, setRecordType] = useState("behavior"); // behavior (í–‰ë°œ), subject (êµê³¼)
            const contentRef = useRef(null);
            const [semester, setSemester] = useState("1"); // 1, 2, all
            const [progress, setProgress] = useState(0);
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [phrases, setPhrases] = useState(() => { try { return JSON.parse(localStorage.getItem('cls_behavior_phrases') || '[]'); } catch { return []; } });
            const [showPhraseList, setShowPhraseList] = useState(false);
            const textareaRef = useRef(null);
            const [showPromptSettings, setShowPromptSettings] = useState(false);
            const [behaviorTemplate, setBehaviorTemplate] = useState("");
            const [subjectTemplate, setSubjectTemplate] = useState("");

            const DEFAULT_BEHAVIOR_TEMPLATE = `{{security_rule}}

# Role
ë‹¹ì‹ ì€ ì´ˆë“±êµìœ¡ ì „ë¬¸ê°€ì´ì ë‹´ì„ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì„ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ê³ , í•™ìƒì˜ ì „ì¸ì  ì„±ì¥ì„ ë•ëŠ” 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬(ì´í‰)'ì„ ì‘ì„±í•©ë‹ˆë‹¤.

# Strict Guidelines (ì‘ì„± ì›ì¹™)
1. **Fact-Based**: ë°˜ë“œì‹œ ì œê³µëœ [êµì‚¬ ê´€ì°° ê¸°ë¡]ì— ìˆëŠ” ë‚´ìš©ë§Œìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”.
2. **Data Validation**: ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ì‘ì„±í•˜ê¸°ì— ì •ë³´ê°€ í˜„ì €íˆ ë¶€ì¡±í•˜ë‹¤ë©´, ì–µì§€ë¡œ ë‚´ìš©ì„ ë§Œë“¤ì§€ ë§ê³  "ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì´í‰ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•™ìƒì— ëŒ€í•œ ê´€ì°° ê¸°ë¡ì„ ë” ì…ë ¥í•´ì£¼ì„¸ìš”."ë¼ê³ ë§Œ ì¶œë ¥í•˜ê³  ì‘ì„±ì„ ì¤‘ë‹¨í•˜ì„¸ìš”.
3. **Subject**: ë¬¸ì¥ì˜ ì£¼ì–´ëŠ” ë°˜ë“œì‹œ 'í•™ìƒ'ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (êµì‚¬ì˜ ê´€ì°°, ê²½í—˜, ê°ì •ì´ ì£¼ì–´ê°€ ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜)
4. **Tone**: ê³µì‹ ë¬¸ì„œ(ìƒí™œê¸°ë¡ë¶€)ì´ë¯€ë¡œ ì§€ë‚˜ì¹˜ê²Œ ë¬¸í•™ì ì¸ í‘œí˜„ì€ ìì œí•˜ê³ , ëª…í™•í•˜ê³  ì •ì¤‘í•œ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
5. **Growth Focus**: ì „ë…„/ì „í•™ê¸°ì— ë¹„í•´ ì˜ì , ì¸ì§€ì , ì •ì„œì , í•™ìŠµì , ì‚¬íšŒë„ë•ì , ì‹ ì²´ì  ë¶€ë¶„ì—ì„œ ì–´ë–¤ ì„±ì¥ì´ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ ë“œëŸ¬ë‚˜ë„ë¡ ê¸°ìˆ í•˜ì„¸ìš”.
{{length_constraint}}

# Writing Structure (ì‘ì„± ìˆœì„œ)
ë‹¤ìŒ ìˆœì„œì™€ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í•˜ë‚˜ì˜ ì™„ì„±ëœ ê¸€ë¡œ ì‘ì„±í•˜ì„¸ìš”.
1. **í•µì‹¬ íŠ¹ì„±**: ì „ì²´ ì£¼ì œì–´ê°€ ë ë§Œí•œ í•µì‹¬ íŠ¹ì„±ì„ ìˆ˜ì‹ì–´ë¡œ ì‚¬ìš©í•˜ì—¬ í•™ìƒì„ ì†Œê°œí•˜ëŠ” ì²« ë¬¸ì¥. (ì˜ˆ: "ì„¬ê¸°ëŠ” ê²ƒì„ ê¸°ë»í•˜ëŠ” [STUDENT_TOKEN]ì´ëŠ”...")
2. **ì˜ì  ì„±ì¥**: ì½”ëŒë°ì˜¤ ì‹œê°„, í•˜ë‚˜ë‹˜ì„ ì•„ëŠ” ì§€ì‹ì—ì„œì˜ ì„±ì¥ (ê¸°ë¡ì´ ìˆì„ ê²½ìš°).
3. **ì§€ì  ì„±ì¥**: êµê³¼ í•™ìŠµì—ì„œì˜ ì„±ì¥, ì¬ëŠ¥ê³¼ ì€ì‚¬.
4. **í•™ìŠµ íƒœë„**: ê¸°ìˆ , ì „ëµì—ì„œì˜ ì„±ì¥.
5. **ì •ì„œì  ë°œë‹¬**: ì •ì„œì  ì•ˆì •ì„±, ì¡°ì ˆ, í™œìš© ëŠ¥ë ¥.
6. **ì„±í’ˆ ë° í–‰ë™**: ë°°ë ¤, ë¦¬ë”ì‹­, êµìš° ê´€ê³„.
7. **ì œì–¸**: ë¶€ì¡±í•œ ë¶€ë¶„, ì—°ì•½í•œ ë¶€ë¶„ì— ëŒ€í•œ ì•„ì‰¬ì›€ê³¼ êµ¬ì²´ì ì¸ êµìœ¡ì  ì œì•ˆ.
8. **ê¸°ëŒ€**: í–¥í›„ í•˜ë‚˜ë‹˜ì´ í•˜ì‹¤ ë¶€ë¶„ì— ëŒ€í•œ ê¸°ëŒ€ì™€ ì¶•ë³µ.

# Input Data
- ì´ë¦„: {{name}}
- ì„±ì‹¤ì„±(ê³¼ì œ ìˆ˜í–‰ë¥ ): {{task_rate}}%
- ì¹­ì°¬ ìŠ¤í‹°ì»¤: {{sticker_count}}ê°œ
- í‚¤ì›Œë“œ: {{keywords}}

[êµì‚¬ ê´€ì°° ê¸°ë¡ (ê¸°ì´ˆ ìë£Œ)]
{{records}}

{{insufficient_notice}}`;

            const DEFAULT_SUBJECT_TEMPLATE = `{{security_rule}}

# Role Definition
ì´ˆë“±í•™êµ êµì‚¬ë¡œì„œ 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©'ì„ ì‘ì„±í•˜ë¼.

# Strict Guidelines
1. **Fact Only**: ì œê³µëœ ê´€ì°° ê¸°ë¡ì— ìˆëŠ” ë‚´ìš©ë§Œ ì„œìˆ í•˜ë¼.
2. **No Hallucination**: í•™ìƒì´ íŠ¹ì • ê³¼ëª©ì„ ì˜í–ˆëŠ”ì§€ ëª»í–ˆëŠ”ì§€ ê¸°ë¡ì— ì—†ë‹¤ë©´ ì–¸ê¸‰í•˜ì§€ ë§ˆë¼.
3. **ë°ì´í„° ë¶€ì¡± ì‹œ**: "íŠ¹ì´ ì‚¬í•­ ì—†ìŒ" ë˜ëŠ” ê³¼ì œ ìˆ˜í–‰ë¥ ë§Œ ì–¸ê¸‰í•˜ê³  ë§ˆë¬´ë¦¬í•˜ë¼.

[êµì‚¬ ê´€ì°° ê¸°ë¡]
{{records}}

ìœ„ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ, ê³¼í•™, ì˜ì–´ ë“± êµê³¼ ê´€ë ¨ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”. ê¸°ë¡ì´ ì—†ëŠ” ê³¼ëª©ì€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.`;

            useEffect(() => {
                const savedBehavior = localStorage.getItem('cls_ai_prompt_behavior');
                const savedSubject = localStorage.getItem('cls_ai_prompt_subject');
                setBehaviorTemplate(savedBehavior || DEFAULT_BEHAVIOR_TEMPLATE);
                setSubjectTemplate(savedSubject || DEFAULT_SUBJECT_TEMPLATE);
            }, []);

            useEffect(() => {
                if (isOpen && student) {
                    const draftKey = `${recordType}_${semester}`;
                    const savedDraft = student.recordDrafts?.[draftKey] || "";
                    setDraft(savedDraft);
                }
            }, [isOpen, student, semester, recordType]);

            useEffect(() => {
                const today = dayjs();
                let sDate = today.startOf('year').format('YYYY-MM-DD');
                let eDate = today.endOf('year').format('YYYY-MM-DD');

                if (semester === '1') { 
                    if (appConfig?.sem1Start) sDate = appConfig.sem1Start;
                    if (appConfig?.sem1End) eDate = appConfig.sem1End;
                    else eDate = today.year() + '-07-31'; 
                } else if (semester === '2') { 
                    if (appConfig?.sem2Start) sDate = appConfig.sem2Start;
                    else sDate = today.year() + '-08-01';
                    if (appConfig?.sem2End) eDate = appConfig.sem2End;
                }
                setStartDate(sDate);
                setEndDate(eDate);
            }, [semester, appConfig]);

            const handleGenerate = async () => {
                setIsGenerating(true);
                setProgress(0);
                const timer = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 500);
                try {
                    // Simple stats calculation
                    let totalTasks = 0;
                    let doneTasks = 0;
                    // Iterate roughly through the year or just use what's available in records/dailyTasks
                    Object.keys(dailyTasks).forEach(date => {
                        if (date >= startDate && date <= endDate) {
                            const tasks = dailyTasks[date];
                            const rec = records[date]?.[student.id];
                            if (tasks && tasks.length > 0) {
                                totalTasks += tasks.length;
                                tasks.forEach((_, idx) => {
                                    if (rec && (rec.tasks?.[idx] || (rec.done && !rec.tasks))) doneTasks++;
                                });
                            }
                        }
                    });
                    const taskRate = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;

                    const validNotes = notes.filter(n => n.date >= startDate && n.date <= endDate);
                    const isInsufficient = validNotes.length < 2;

                    // [ë³´ì•ˆ] ë°ì´í„° ìµëª…í™”
                    const safeName = "[STUDENT_TOKEN]";
                    let safeNotesStr = validNotes.length > 0 ? validNotes.map(n => `- [${n.date}] ${n.content}`).join('\n') : 'ê¸°ë¡ ì—†ìŒ';
                    safeNotesStr = anonymizeText(safeNotesStr, student.name);
                    if (students) {
                        students.forEach(s => {
                            if (s.id !== student.id) {
                                safeNotesStr = safeNotesStr.replaceAll(s.name, "ê¸‰ìš°");
                                if (s.name.length >= 3) safeNotesStr = safeNotesStr.replaceAll(s.name.substring(1), "ê¸‰ìš°");
                            }
                        });
                    }
                    const safeKeywords = anonymizeText(keywords || 'ì—†ìŒ', student.name);

                    let lengthConstraint = "";
                    if (semester === '1') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 450ì ì´ë‚´ë¡œ ì‘ì„±í•  ê²ƒ.";
                    } else if (semester === '2') {
                        lengthConstraint = "7. **ë¶„ëŸ‰ ì œí•œ:** ë°˜ë“œì‹œ ê³µë°± í¬í•¨ 550ì ì´ë‚´ë¡œ ì‘ì„±í•  ê²ƒ.";
                    }

                    const securityRule = "[ë³´ì•ˆ ê·œì¹™: ë‹¹ì‹ ì€ ì² ì €í•œ ìµëª…ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì— ì‚¬ëŒì˜ ì´ë¦„ì´ë‚˜ ì‹¤ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìˆëŠ” ë‹¨ì–´ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëŒ€ëª…ì‚¬ê°€ í•„ìš”í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'í•´ë‹¹ í•™ìƒ'ì´ë¼ê³ ë§Œ ì§€ì¹­í•˜ì„¸ìš”.]";

                    let prompt = (recordType === 'behavior' ? (behaviorTemplate || DEFAULT_BEHAVIOR_TEMPLATE) : (subjectTemplate || DEFAULT_SUBJECT_TEMPLATE));
                    
                    // ê³µí†µ ë³€ìˆ˜ ì¹˜í™˜
                    prompt = prompt.replace('{{security_rule}}', securityRule);
                    prompt = prompt.replace('{{name}}', safeName);
                    prompt = prompt.replace('{{task_rate}}', taskRate);
                    prompt = prompt.replace('{{sticker_count}}', student.stickers);
                    prompt = prompt.replace('{{keywords}}', safeKeywords);
                    prompt = prompt.replace('{{records}}', safeNotesStr);

                    // í–‰ë™íŠ¹ì„± ì „ìš© ë³€ìˆ˜ ì¹˜í™˜
                    if (recordType === 'behavior') { // í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ (ê¸°ë…êµ ëŒ€ì•ˆí•™êµ ìŠ¤íƒ€ì¼)
                        prompt = prompt.replace('{{length_constraint}}', lengthConstraint ? `6. **Length**: ${lengthConstraint}` : "");
                        prompt = prompt.replace('{{insufficient_notice}}', isInsufficient ? "ì£¼ì˜: ê¸°ë¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤. ìœ„ ì›ì¹™ì— ë”°ë¼ 'ê´€ì°° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬...' ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜, ìˆ˜í–‰ë¥  ë°ì´í„°ë§Œìœ¼ë¡œ ì•„ì£¼ ê°„ëµí•˜ê²Œ ì‚¬ì‹¤ë§Œ ê¸°ìˆ í•˜ì„¸ìš”." : "ìœ„ ì›ì¹™ê³¼ ìˆœì„œì— ë§ì¶° ì‘ì„±í•˜ì„¸ìš”.");
                    }

                    const text = await callGemini(apiKey, prompt, 0.1);
                    clearInterval(timer);
                    setProgress(100);
                    
                    // [ë³´ì•ˆ] ê²°ê³¼ ë³µí˜¸í™”
                    const finalContent = deanonymizeText(text, student.name);
                    setDraft(finalContent);
                } catch (e) {
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    clearInterval(timer);
                    showToast("ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleAddPhrase = () => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                const textToSave = (textarea.value.substring(textarea.selectionStart, textarea.selectionEnd) || textarea.value).trim();
                if (!textToSave) return showToast("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                const newPhrases = [...phrases, textToSave];
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
                showToast("ìƒìš©êµ¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            const handleDeletePhrase = (idx) => {
                const newPhrases = phrases.filter((_, i) => i !== idx);
                setPhrases(newPhrases);
                localStorage.setItem('cls_behavior_phrases', JSON.stringify(newPhrases));
            };
            const handleApplyPhrase = (text) => {
                setDraft(prev => prev + (prev ? " " : "") + text);
                setShowPhraseList(false);
            };

            const handleSave = () => {
                if (semester === 'all') {
                    showToast("ì „ì²´ í•™ê¸° ì´ˆì•ˆì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 1í•™ê¸° ë˜ëŠ” 2í•™ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                const draftKey = `${recordType}_${semester}`;
                onSaveDraft(student.id, draftKey, draft);
            };

            const handleDownloadPdf = async () => {
                if (!contentRef.current) return;
                if (!window.jspdf) return showToast("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(contentRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`${student.name}_${recordType === 'behavior' ? 'ì´í‰' : 'êµê³¼ë°œë‹¬'}_ì´ˆì•ˆ_${dayjs().format('YYYYMMDD')}.pdf`);
                    showToast("PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ì´í‰ ì´ˆì•ˆ PDF ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    showToast("PDF ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            const handleSavePrompt = () => {
                if (recordType === 'behavior') {
                    localStorage.setItem('cls_ai_prompt_behavior', behaviorTemplate);
                } else {
                    localStorage.setItem('cls_ai_prompt_subject', subjectTemplate);
                }
                showToast("í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setShowPromptSettings(false);
            };

            const handleResetPrompt = () => {
                if (recordType === 'behavior') {
                    setBehaviorTemplate(DEFAULT_BEHAVIOR_TEMPLATE);
                    localStorage.removeItem('cls_ai_prompt_behavior');
                } else {
                    setSubjectTemplate(DEFAULT_SUBJECT_TEMPLATE);
                    localStorage.removeItem('cls_ai_prompt_subject');
                }
                showToast("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“ AI ì´í‰ ì´ˆì•ˆ ìƒì„±">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                            <p className="font-bold mb-1">ğŸ’¡ ìƒí™œê¸°ë¡ë¶€ ì´ˆì•ˆì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">1ë…„ ë™ì•ˆì˜ ê³¼ì œ ìˆ˜í–‰, ìŠ¤í‹°ì»¤, ìƒë‹´ ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ AIê°€ ì‘ì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì„ ìƒë‹˜ì˜ ê²€í† ì™€ ìˆ˜ì •ì„ ê±°ì³ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex flex-col gap-2">
                            <label className="text-xs font-bold text-slate-500">ì¶”ê°€ ê°•ì¡°í•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œ (ì„ íƒ)</label>
                            <input value={keywords} onChange={e => setKeywords(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-blue-500" placeholder="ì˜ˆ: ë´‰ì‚¬ì •ì‹ , ì°½ì˜ë ¥, ë…ì„œì™•..." />
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">í•™ê¸° ì„ íƒ:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setSemester('1')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '1' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>1í•™ê¸°</button>
                                <button onClick={() => setSemester('2')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === '2' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>2í•™ê¸°</button>
                                <button onClick={() => setSemester('all')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${semester === 'all' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ì „ì²´</button>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                             <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                             <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                             <span className="text-xs text-slate-400">~</span>
                             <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="text-xs p-1 border rounded bg-white outline-none focus:border-indigo-500"/>
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">ìƒì„± í•­ëª©:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setRecordType('behavior')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'behavior' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬</button>
                                <button onClick={() => setRecordType('subject')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${recordType === 'subject' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>êµê³¼ í•™ìŠµ ë°œë‹¬</button>
                            </div>
                        </div>

                        <div className="border-t border-slate-100 pt-2">
                            <button onClick={() => setShowPromptSettings(!showPromptSettings)} className="text-xs font-bold text-slate-400 flex items-center gap-1 hover:text-slate-600 transition-colors mb-2">
                                <Icon d={PATHS.settings} size={12} /> í”„ë¡¬í”„íŠ¸ ì„¤ì • {showPromptSettings ? 'ì ‘ê¸°' : 'ì—´ê¸°'}
                            </button>
                            {showPromptSettings && (
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fade-in space-y-2">
                                    <div className="flex justify-between items-center">
                                        <p className="text-[10px] text-slate-500 font-bold">ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ (ìë™ ì¹˜í™˜)</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-1 text-[10px] text-slate-600 bg-white p-2 rounded border border-slate-100">
                                        <div><code>{`{{name}}`}</code> : í•™ìƒ ì´ë¦„ (ìµëª…)</div>
                                        <div><code>{`{{records}}`}</code> : ê´€ì°° ê¸°ë¡</div>
                                        <div><code>{`{{task_rate}}`}</code> : ê³¼ì œ ìˆ˜í–‰ë¥ </div>
                                        <div><code>{`{{sticker_count}}`}</code> : ìŠ¤í‹°ì»¤ ìˆ˜</div>
                                        <div><code>{`{{keywords}}`}</code> : í‚¤ì›Œë“œ</div>
                                        <div className="col-span-2 text-rose-500"><code>{`{{security_rule}}`}</code> : ë³´ì•ˆ ê·œì¹™ (í•„ìˆ˜)</div>
                                    </div>
                                    <textarea 
                                        value={recordType === 'behavior' ? behaviorTemplate : subjectTemplate} 
                                        onChange={(e) => recordType === 'behavior' ? setBehaviorTemplate(e.target.value) : setSubjectTemplate(e.target.value)} 
                                        className="w-full h-40 p-2 border border-slate-300 rounded-lg text-xs font-mono outline-none focus:border-indigo-500 resize-none custom-scroll" 
                                    />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={handleResetPrompt} className="px-3 py-1.5 bg-white border border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-50">ì´ˆê¸°í™”</button>
                                        <button onClick={handleSavePrompt} className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">ì €ì¥</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <Btn onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2">
                            {isGenerating ? <><Icon d={PATHS.spinner} className="animate-spin" /> ì‘ì„± ì¤‘... {Math.round(progress)}%</> : <><Icon d={PATHS.magic} /> ì´ˆì•ˆ ìƒì„±í•˜ê¸°</>}
                        </Btn>

                        {draft && (
                            <div ref={contentRef} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm animate-fade-in">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold text-slate-500">ìƒì„±ëœ ì´ˆì•ˆ</span>
                                    <div className="relative">
                                        <button onClick={() => setShowPhraseList(!showPhraseList)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-100 font-bold flex items-center gap-1">
                                            <Icon d={PATHS.list} size={10} /> ìƒìš©êµ¬
                                        </button>
                                        {showPhraseList && (
                                            <div className="absolute right-0 bottom-full mb-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-2 z-50 animate-fade-in">
                                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100 px-1">
                                                    <span className="text-xs font-bold text-slate-600">ì €ì¥ëœ ë¬¸êµ¬</span>
                                                    <button onClick={handleAddPhrase} className="text-[10px] text-indigo-500 hover:underline">ì„ íƒ/ì „ì²´ ì €ì¥</button>
                                                </div>
                                                <div className="max-h-40 overflow-y-auto custom-scroll space-y-1">
                                                    {phrases.length > 0 ? phrases.map((p, i) => (
                                                        <div key={i} className="group flex items-start gap-2 p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100" onClick={() => handleApplyPhrase(p)}>
                                                            <span className="text-xs text-slate-600 line-clamp-2 flex-1">{p}</span>
                                                            <button onClick={(e) => { e.stopPropagation(); handleDeletePhrase(i); }} className="text-slate-300 hover:text-rose-500"><Icon d={PATHS.trash} size={12} /></button>
                                                        </div>
                                                    )) : <div className="text-center text-slate-400 text-xs py-2">ì €ì¥ëœ ìƒìš©êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-slate-100 text-[9px] text-slate-400 text-center">
                                                    * í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ í›„ ì €ì¥í•˜ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <textarea ref={textareaRef} value={draft} onChange={e => setDraft(e.target.value)} className="w-full h-48 text-sm leading-relaxed text-slate-700 outline-none resize-none custom-scroll" />
                                <div className="flex justify-end gap-2 border-t border-slate-100 pt-4 mt-2" data-html2canvas-ignore="true">
                                    <Btn onClick={handleDownloadPdf} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.download} size={14} /> PDF
                                    </Btn>
                                    <Btn onClick={() => { navigator.clipboard.writeText(draft); showToast("ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1">
                                        <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                    </Btn>
                                    <Btn onClick={handleSave} className="px-3 py-2 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1">
                                        <Icon d={PATHS.check} size={14} /> ì €ì¥
                                    </Btn>
                                </div>
                            </div>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const CalendarModal = ({ isOpen, onClose, currentDate, onSelectDate, records, appConfig, groupsByDate, mode, selectionMode = 'single', onSelectRange }) => {
            const [viewDate, setViewDate] = useState(dayjs(currentDate));
            const [range, setRange] = useState({ start: null, end: null });
            const [blinkDate, setBlinkDate] = useState(null);
            const [tempSelected, setTempSelected] = useState(null);

            useEffect(() => { 
                if (isOpen) {
                    setViewDate(dayjs(currentDate)); 
                    if (selectionMode === 'range') setRange({ start: null, end: null });
                } 
            }, [isOpen, currentDate, selectionMode]);

            if (!isOpen) return null;
            const startDay = viewDate.startOf('month').day();
            const calendarDays = [...Array(startDay).fill(null), ...Array(viewDate.daysInMonth()).fill(0).map((_, i) => viewDate.date(i + 1))];
            
            const handleDateClick = (dateStr) => {
                const day = dayjs(dateStr).day();
                const isWeekend = day === 0 || day === 6;
                const isHoliday = !!HOLIDAYS[dateStr];
                const isVacation = (appConfig.vacations || []).some(v => dateStr >= v.start && dateStr <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && dateStr >= appConfig.vacationStart && dateStr <= appConfig.vacationEnd);
                
                if (!isWeekend && !isHoliday && !isVacation) {
                    if (selectionMode === 'single') {
                        setTempSelected(dateStr);
                        setTimeout(() => {
                            onSelectDate(dateStr);
                            onClose();
                        }, 400);
                    } else {
                        if (!range.start || (range.start && range.end)) {
                            setRange({ start: dateStr, end: null });
                        } else {
                            let start = range.start;
                            let end = dateStr;
                            if (dayjs(end).isBefore(dayjs(start))) [start, end] = [end, start];
                            setRange({ start, end });
                            if (onSelectRange) onSelectRange(start, end);
                            onClose();
                        }
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 z-[1500] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm md:max-w-lg rounded-3xl shadow-2xl shadow-indigo-100/50 p-4 md:p-6 transform transition-all" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-extrabold text-slate-800 flex items-center gap-2">
                                <span className="text-2xl">ğŸ“…</span> 
                                {selectionMode === 'range' ? 'ê¸°ê°„ ì„ íƒ (ì‹œì‘ì¼ â†’ ì¢…ë£Œì¼)' : 'ë‚ ì§œ ì„ íƒ'}
                            </h3>
                            <div className="flex items-center gap-2">
                                {selectionMode === 'single' && <button onClick={() => { 
                                    const today = getToday();
                                    setViewDate(dayjs(today));
                                    onSelectDate(today);
                                    setBlinkDate(today);
                                    setTimeout(() => setBlinkDate(null), 1500);
                                }} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 transition-colors">ì˜¤ëŠ˜</button>}
                                {selectionMode === 'range' && <button onClick={() => { if(onSelectRange) onSelectRange(currentDate, currentDate); onClose(); }} className="text-xs bg-rose-50 text-rose-500 px-3 py-1.5 rounded-full font-bold hover:bg-rose-100 transition-colors">ì´ˆê¸°í™”</button>}
                                <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} size={20} /></button>
                            </div>
                        </div>
                        <div className="flex justify-between items-center mb-6 px-2">
                            <button onClick={() => setViewDate(viewDate.subtract(1, 'month'))} className="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-800 transition-colors"><Icon d={PATHS.left} size={20} /></button>
                            <span className="text-lg font-extrabold text-slate-800 tracking-tight">{viewDate.format('YYYYë…„ Mì›”')}</span>
                            <button onClick={() => setViewDate(viewDate.add(1, 'month'))} className="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-800 transition-colors"><Icon d={PATHS.right} size={20} /></button>
                        </div>
                        <div className="grid grid-cols-7 mb-2 text-center">
                            {DAYS.map((d, i) => <div key={d} className={`text-xs font-bold pb-2 ${i === 0 ? 'text-red-400' : i === 6 ? 'text-blue-400' : 'text-slate-400'}`}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays.map((dateObj, idx) => { 
                                if (!dateObj) return <div key={idx} className="aspect-square"></div>; 
                                const dateStr = dateObj.format('YYYY-MM-DD'); 
                                const isToday = dateStr === getToday(); 
                                const dayOfWeek = dateObj.day(); 
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; 
                                const holidayName = HOLIDAYS[dateStr]; 
                                const isHoliday = !!holidayName; 
                                const isVacation = (appConfig.vacations || []).some(v => dateStr >= v.start && dateStr <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && dateStr >= appConfig.vacationStart && dateStr <= appConfig.vacationEnd);
                                const hasRecord = records[dateStr] && Object.values(records[dateStr]).some(r => r.done || (r.tasks && Object.values(r.tasks).some(t => t))); 
                                const hasGroup = groupsByDate && groupsByDate[dateStr] && groupsByDate[dateStr].length > 0; 
                                const showDot = mode === 'group' ? hasGroup : hasRecord; 
                                
                                let isSelected = false;
                                let isInRange = false;
                                if (selectionMode === 'single') {
                                    isSelected = dateStr === currentDate || dateStr === tempSelected;
                                } else {
                                    if (range.start === dateStr) isSelected = true;
                                    if (range.end === dateStr) isSelected = true;
                                    if (range.start && range.end && dateStr > range.start && dateStr < range.end) isInRange = true;
                                }

                                const isDisabled = isVacation || isWeekend || isHoliday;
                                const isBlinking = blinkDate === dateStr;
                                let cellClass = "aspect-square flex flex-col items-center justify-center rounded-full text-sm font-medium cursor-pointer transition-all duration-300 relative group";
                                
                                if (isSelected) cellClass += " bg-indigo-600 text-white shadow-lg shadow-indigo-200 font-bold transform scale-110 z-10";
                                else if (isInRange) cellClass += " bg-indigo-50 text-indigo-700 font-bold";
                                else if (isDisabled) cellClass += " text-slate-300 cursor-not-allowed bg-slate-50/50";
                                else if (isToday) cellClass += " text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100";
                                else cellClass += " text-slate-700 hover:bg-slate-100 active:scale-95";
                                
                                if (isBlinking) cellClass += " ring-4 ring-indigo-300 ring-offset-2 animate-blink-strong";
                                
                                return (
                                    <button key={idx} disabled={isDisabled} onClick={() => handleDateClick(dateStr)} className={cellClass}>
                                        <span>{dateObj.date()}</span>
                                        {isSelected && (
                                            <div className="absolute -top-1 -right-1 bg-white text-indigo-600 rounded-full p-[2px] shadow-sm animate-bounce-in z-20"><Icon d={PATHS.check} size={10} strokeWidth={4} /></div>
                                        )}
                                        {showDot && !isDisabled && !isSelected && !isInRange && (<div className={`w-1 h-1 rounded-full mt-0.5 ${isToday ? 'bg-indigo-400' : 'bg-blue-400'}`}></div>)}
                                        {isHoliday && !isVacation && <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 text-[8px] leading-none text-rose-400 font-bold whitespace-nowrap w-full text-center truncate px-1">{holidayName}</div>}
                                    </button>
                                ) 
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        const DateHeader = ({ date, setDate, onAdd, onReset, onCalendar, appConfig }) => {
            const isVacation = (appConfig.vacations || []).some(v => date >= v.start && date <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && date >= appConfig.vacationStart && date <= appConfig.vacationEnd);
            const isHoliday = !!HOLIDAYS[date];
            const holidayName = HOLIDAYS[date];
            
            // [New] D-Day Logic
            const today = dayjs().format('YYYY-MM-DD');
            let dDayLabel = null;
            
            // Check if today is already vacation
            const isTodayVacation = (appConfig.vacations || []).some(v => today >= v.start && today <= v.end) || (appConfig.vacationStart && appConfig.vacationEnd && today >= appConfig.vacationStart && today <= appConfig.vacationEnd);

            if (appConfig.dDayEnabled !== false && !isTodayVacation) {
                const allVacations = [...(appConfig.vacations || [])];
                if (appConfig.vacationStart && appConfig.vacationEnd) {
                    allVacations.push({ start: appConfig.vacationStart, end: appConfig.vacationEnd });
                }
                
                const nextVacation = allVacations
                    .filter(v => v.start > today)
                    .sort((a, b) => a.start.localeCompare(b.start))[0];
                
                if (nextVacation) {
                    const diff = dayjs(nextVacation.start).diff(dayjs(today), 'day');
                    if (diff > 0) {
                        dDayLabel = `ë°©í•™ê¹Œì§€ D-${diff}`;
                    }
                }
            }

            const moveDate = (direction) => { let nextDate = dayjs(date).add(direction, 'day'); let count = 0; while (count < 365) { const dStr = nextDate.format('YYYY-MM-DD'); const day = nextDate.day(); const isWknd = day === 0 || day === 6; const isHol = !!HOLIDAYS[dStr]; if (!isWknd && !isHol) break; nextDate = nextDate.add(direction, 'day'); count++; } setDate(nextDate.format('YYYY-MM-DD')); };
            return (
                <div className="flex flex-col items-center">
                    {(isVacation || isHoliday || dDayLabel) && (
                        <div className="flex gap-2 mb-2">
                            {isVacation && <div className="bg-orange-100 text-orange-600 text-xs font-bold px-3 py-1 rounded">ğŸ–ï¸ ë°©í•™ ê¸°ê°„ì…ë‹ˆë‹¤</div>}
                            {isHoliday && <div className="bg-rose-100 text-rose-600 text-xs font-bold px-3 py-1 rounded">ğŸ‰ {holidayName}</div>}
                            {dDayLabel && !isVacation && <div className="bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1 rounded flex items-center gap-1"><span>â³</span> {dDayLabel}</div>}
                        </div>
                    )}
                    <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border w-fit mx-auto justify-center">{onAdd && <><Btn onClick={onAdd} className="text-notion-text p-1.5 rounded hover:bg-notion-bg-hover flex items-center justify-center"><Icon d={PATHS.plus} size={18} /></Btn><div className="w-px h-4 bg-notion-border"></div></>}<Btn onClick={() => moveDate(-1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18} /></Btn><div className="flex flex-col items-center cursor-pointer hover:bg-notion-bg-hover rounded px-3 py-1 transition-colors" onClick={onCalendar}><div className="text-base font-bold text-notion-text tracking-tight">{dayjs(date).format('YY.MM.DD')}</div><div className={`text-[10px] font-bold ${isHoliday || dayjs(date).day()===0 ? 'text-notion-red' : dayjs(date).day()===6 ? 'text-notion-blue' : 'text-notion-text-light'}`}>{dayjs(date).format('dddd')}</div></div><Btn onClick={() => moveDate(1)} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18} /></Btn>{onReset && <><div className="w-px h-4 bg-notion-border"></div><Btn onClick={(e) => { e.stopPropagation(); onReset(); }} className="p-1.5 text-notion-text-light hover:text-notion-red hover:bg-notion-bg-hover rounded"><Icon d={PATHS.trash} size={16} /></Btn></>}</div>
                </div>
            );
        };
        const TagSelector = ({ current, setTag, tags, onAdd, onEdit, onDelete }) => {
            const [showManager, setShowManager] = useState(false);
            const [newTagInput, setNewTagInput] = useState("");
            const [editingTag, setEditingTag] = useState(null);
            const [editTagValue, setEditTagValue] = useState("");
            const handleAdd = () => { if (newTagInput.trim()) { onAdd(newTagInput.trim()); setNewTagInput(""); } };
            const handleFinishEdit = () => { if (editingTag && editTagValue.trim() && editTagValue.trim() !== editingTag) onEdit(editingTag, editTagValue.trim()); setEditingTag(null); setEditTagValue(""); };
            return (
                <div className="mt-2"><div className="flex flex-wrap gap-1 items-center">{tags.map(t => <Btn key={t} onClick={() => setTag(t)} className={`px-2 py-1 text-xs rounded-lg border ${current === t ? 'bg-indigo-500 text-white border-indigo-500 shadow-sm hover:bg-indigo-500' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{t}</Btn>)}<Btn onClick={() => setShowManager(!showManager)} className={`p-1 rounded-full ${showManager ? 'bg-slate-200 text-slate-600' : 'text-slate-300 hover:text-slate-500'}`}><span className="text-sm">âš™ï¸</span></Btn></div>{showManager && (<div className="mt-2 p-3 bg-slate-50 rounded-xl border border-slate-200 animate-fade-in relative z-10"><div className="text-[10px] font-bold text-slate-400 mb-2">íƒœê·¸ ê´€ë¦¬</div><div className="flex flex-wrap gap-2 mb-2">{tags.map(tag => editingTag === tag ? (<div key={tag} className="flex items-center bg-white border border-indigo-300 rounded-lg overflow-hidden shadow-sm"><input value={editTagValue} onChange={e => setEditTagValue(e.target.value)} className="w-16 px-1 py-0.5 text-xs outline-none" autoFocus onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleFinishEdit() }} /><Btn onClick={handleFinishEdit} className="bg-indigo-100 text-indigo-600 px-1.5 py-0.5 hover:bg-indigo-200"><Icon d={PATHS.check} size={10} /></Btn><Btn onClick={() => setEditingTag(null)} className="bg-slate-100 text-slate-500 px-1.5 py-0.5 hover:bg-slate-200"><Icon d={PATHS.x} size={10} /></Btn></div>) : (<div key={tag} className="px-2 py-1 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 flex items-center gap-1 group"><span>{tag}</span><div className="flex gap-0.5 opacity-50 group-hover:opacity-100 transition-opacity"><Btn onClick={() => { setEditingTag(tag); setEditTagValue(tag); }} className="hover:text-indigo-500 p-0.5"><Icon d={PATHS.edit} size={10} /></Btn>{tag !== 'ê¸°íƒ€' && <Btn onClick={(e) => { e.preventDefault(); e.stopPropagation(); onDelete(tag); }} className="text-rose-500 hover:text-rose-700 p-0.5"><Icon d={PATHS.trash} size={10} /></Btn>}</div></div>))}</div><div className="flex gap-1"><input value={newTagInput} onChange={e => setNewTagInput(e.target.value)} className="flex-1 p-1.5 border rounded-lg text-xs outline-none focus:border-indigo-500" placeholder="ìƒˆ íƒœê·¸ ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) handleAdd() }} /><Btn onClick={handleAdd} className="bg-indigo-500 text-white px-3 rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn></div></div>)}</div>
            );
        };
        const TaskModal = ({ isOpen, onClose, date, dailyTasks, setDailyTasks, weeklyTasks, setWeeklyTasks, saveData, isLocalMode, showToast, tags, setTags, openConfirm }) => {
            const [tasks, setTempTasks] = useState([]); const [newTask, setNewTask] = useState(""); const [selectedTag, setSelectedTag] = useState("êµ­ì–´"); const [wTasks, setWTasks] = useState({}); const [wSelectedDays, setWSelectedDays] = useState([]); const [wNewTask, setWNewTask] = useState(""); const [wSelectedTag, setWSelectedTag] = useState("êµ­ì–´");
            const [dueDate, setDueDate] = useState(date); // ğŸŒŸ ì œì¶œì¼ ìƒíƒœ ì¶”ê°€
            
            useEffect(() => { if (isOpen) { setTempTasks((dailyTasks[date] || []).map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); const loadedWeekly = {}; Object.keys(weeklyTasks).forEach(k => loadedWeekly[k] = weeklyTasks[k].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t)); setWTasks(loadedWeekly); setDueDate(date); /* ğŸŒŸ ì—´ë¦´ ë•Œë§ˆë‹¤ í˜„ì¬ ë‚ ì§œë¡œ ì´ˆê¸°í™” */ } }, [isOpen, dailyTasks, weeklyTasks, date]);
            const updateTags = (newTag) => { if (newTag && !tags.includes(newTag)) { const newTags = [...tags, newTag]; setTags(newTags); if (!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); } };
            const addTask = () => { 
                if (newTask && newTask.trim() !== "") { 
                    updateTags(selectedTag);
                    
                    // 1. ë‹¬ë ¥ ë‚ ì§œê°€ ì˜¤ëŠ˜(í˜„ì¬ í™”ë©´)ê³¼ ê°™ì„ ë•Œ (ê¸°ì¡´ ë°©ì‹)
                    if (dueDate === date) {
                        if (tasks.length < 5) {
                            setTempTasks([...tasks, { title: newTask, tag: selectedTag }]); 
                            setNewTask(""); 
                        } else { showToast("ì˜¤ëŠ˜ ê³¼ì œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); }
                    } 
                    // 2. ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí–ˆì„ ë•Œ (ë¯¸ë˜ë¡œ ë³´ë‚´ê¸°!)
                    else {
                        const targetTasks = dailyTasks[dueDate] || [];
                        if (targetTasks.length < 5) {
                            const updatedTasks = [...targetTasks, { title: newTask, tag: selectedTag }];
                            const newDaily = { ...dailyTasks, [dueDate]: updatedTasks };
                            setDailyTasks(newDaily);
                            
                            // ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê¸°
                            localStorage.setItem('cls_daily_tasks', JSON.stringify(newDaily));
                            try { if (!isLocalMode) saveData('cls_daily_tasks', newDaily); } catch(e) {}
                            
                            showToast(`${dayjs(dueDate).format('MM/DD')} ìˆ™ì œê°€ ë“±ë¡ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            setNewTask("");
                            setDueDate(date); // ì¶”ê°€ í›„ ë‹¤ì‹œ ì›ë˜ ë‚ ì§œë¡œ ë³µê·€
                        } else { showToast("ì„ íƒí•˜ì‹  ë‚ ì§œì— ì´ë¯¸ ê³¼ì œê°€ 5ê°œ ê½‰ ì°¼ìŠµë‹ˆë‹¤."); }
                    }
                } 
            };
            const removeTask = (idx) => setTempTasks(tasks.filter((_, i) => i !== idx));
            const saveAll = () => { 
                const newDaily = { ...dailyTasks, [date]: tasks }; 
                setDailyTasks(newDaily); 
                setWeeklyTasks(wTasks);
                setTags(tags); // íƒœê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸

                if (!isLocalMode) {
                    // [Fix] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬ ì €ì¥ (ìµœì í™”: ë³€ê²½ëœ ë‚ ì§œë§Œ ì €ì¥)
                    // saveTasksToFirestoreëŠ” App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ propsë¡œ ì „ë‹¬ë°›ê±°ë‚˜ í•´ì•¼ í•¨.
                    // í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” TaskModalì´ App ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, 
                    // saveDataë¥¼ í†µí•´ ìš°íšŒí•´ì•¼ í•˜ëŠ”ë°, saveDataëŠ” ì „ì²´ ì €ì¥ì´ë¯€ë¡œ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ.
                    // App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ í•¨ìˆ˜ì¸ saveTasksToFirestoreë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì • í•„ìš”.
                    // *TaskModalì´ App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ saveTasksToFirestore ì ‘ê·¼ ê°€ëŠ¥*
                    // (ì•„ë˜ App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModal ì •ì˜ ë¶€ë¶„ í™•ì¸ í•„ìš” - í˜„ì¬ App ë‚´ë¶€ì— ì •ì˜ë¨)
                } 
                // *TaskModalì€ App ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ê°€ ì•„ë‹ˆë¼ ë³„ë„ ì»´í¬ë„ŒíŠ¸ì„. propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.*
                // í•˜ì§€ë§Œ í˜„ì¬ ì½”ë“œ êµ¬ì¡°ìƒ TaskModalì€ App ë‚´ë¶€ì—ì„œ ì •ì˜ëœ ê²ƒì´ ì•„ë‹ˆë¼ ë³„ë„ë¡œ ì •ì˜ë˜ì–´ ìˆìŒ.
                // ë”°ë¼ì„œ saveTasksToFirestoreë¥¼ propsë¡œ ë„˜ê²¨ì£¼ê±°ë‚˜, saveDataê°€ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” saveDataë¥¼ í˜¸ì¶œí•˜ë˜, Appì˜ saveDataê°€ ë¶„ê¸° ì²˜ë¦¬í•˜ë„ë¡ í•¨.
                // ë‹¨, TaskModalì—ì„œ ìµœì í™”ë¥¼ ìœ„í•´ saveTasksToFirestoreë¥¼ ì§ì ‘ propìœ¼ë¡œ ë°›ëŠ” ê²ƒì´ ì¢‹ìŒ.
                // ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜, Appì—ì„œ TaskModalì— saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½ ì˜ˆì •.
                
                // [ìˆ˜ì •] TaskModalì€ App ì™¸ë¶€ ì»´í¬ë„ŒíŠ¸ì´ë¯€ë¡œ propsë¡œ í•¨ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•¨.
                // App ì»´í¬ë„ŒíŠ¸ì—ì„œ TaskModalì„ ë¶€ë¥¼ ë•Œ saveTasksToFirestoreë¥¼ ë„˜ê²¨ì£¼ë„ë¡ ìˆ˜ì • í•„ìš”.
                // ì—¬ê¸°ì„œëŠ” propsë¡œ ë°›ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©.
                
                // (TaskModal propsì— saveTasksToFirestore ì¶”ê°€ í•„ìš”)
            };
            const toggleDay = (d) => setWSelectedDays(prev => prev.includes(d) ? prev.filter(x => x !== d) : [...prev, d]);
            const addWeeklyTask = () => { if (wNewTask && wSelectedDays.length > 0) { const newW = { ...wTasks }; wSelectedDays.forEach(d => { if ((newW[d] || []).length < 5) newW[d] = [...(newW[d] || []), { title: wNewTask, tag: wSelectedTag }]; }); setWTasks(newW); updateTags(wSelectedTag); setWNewTask(""); setWSelectedDays([]); showToast("ìš”ì¼ë³„ ê³¼ì œ ì¶”ê°€ë¨"); } };
            const removeWeeklyTask = (d, i) => setWTasks({ ...wTasks, [d]: wTasks[d].filter((_, idx) => idx !== i) });
            const handleTagAction = (action, ...args) => { if(action === 'add') updateTags(args[0]); else if(action === 'delete') { openConfirm(`'${args[0]}' íƒœê·¸ ì‚­ì œ?`, () => { const newTags = tags.filter(t => t !== args[0]); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); if(selectedTag === args[0]) setSelectedTag("ê¸°íƒ€"); if(wSelectedTag === args[0]) setWSelectedTag("ê¸°íƒ€"); }); } else if(action === 'edit') { const [oldT, newT] = args; if(newT && newT !== oldT){ const newTags = tags.map(t=>t===oldT?newT:t); setTags(newTags); if(!isLocalMode) saveData('cls_tags', newTags); else localStorage.setItem('cls_tags', JSON.stringify(newTags)); showToast("íƒœê·¸ ìˆ˜ì •ë¨"); } } };

            // [New] ì €ì¥ ë¡œì§ ì¬ì •ì˜ (propsë¡œ ë°›ì€ í•¨ìˆ˜ ì‚¬ìš©)
            const handleSaveAll = () => {
                const newDaily = { ...dailyTasks, [date]: tasks };
                setDailyTasks(newDaily);
                setWeeklyTasks(wTasks);
                setTags(tags);

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°±ì—… (í•­ìƒ ìˆ˜í–‰)
                localStorage.setItem('cls_daily_tasks', JSON.stringify(newDaily));
                localStorage.setItem('cls_weekly_tasks', JSON.stringify(wTasks));
                localStorage.setItem('cls_tags', JSON.stringify(tags));

                if (!isLocalMode && props.saveTasksToFirestore) {
                    // í´ë¼ìš°ë“œ ëª¨ë“œ: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ìµœì í™” ì €ì¥
                    props.saveTasksToFirestore({ 
                        dailyTasks: { [date]: tasks }, // ë³€ê²½ëœ ë‚ ì§œë§Œ
                        weeklyTasks: wTasks,
                        tags: tags
                    });
                } else if (isLocalMode) {
                    // ë¡œì»¬ ëª¨ë“œ: ì´ë¯¸ ìœ„ì—ì„œ ì €ì¥í•¨ (saveData í˜¸ì¶œ ë¶ˆí•„ìš”)
                } else {
                    // Fallback (êµ¬ë²„ì „ í˜¸í™˜)
                    saveData('cls_daily_tasks', newDaily);
                    saveData('cls_weekly_tasks', wTasks);
                    saveData('cls_tags', tags);
                }
                onClose();
                showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ê³¼ì œ ì„¤ì •" icon={PATHS.edit} footer={<Btn onClick={handleSaveAll} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg hover:bg-slate-900">ëª¨ë“  ì„¤ì • ì €ì¥ ë° ë‹«ê¸°</Btn>}><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-indigo-500 pl-3 flex justify-between"><span>ì˜¤ëŠ˜ì˜ ê³¼ì œ ({dayjs(date).format('YY.MM.DD')})</span><span className="text-xs font-normal text-slate-400">ìµœëŒ€ 5ê°œ</span></h4><div className="bg-slate-50 p-4 rounded-2xl border border-slate-100"><div className="flex flex-col mb-3"><div className="flex gap-2 items-center mb-2 w-full">
    <div className="flex items-center gap-1.5 shrink-0 bg-slate-100 px-3 py-2.5 rounded-xl border border-slate-200">
        <span className="text-xs font-extrabold text-slate-500 whitespace-nowrap">ì œì¶œì¼</span>
        <input 
            type="date" 
            value={dueDate} 
            onChange={e => setDueDate(e.target.value)} 
            className="text-sm font-bold text-slate-700 bg-transparent outline-none cursor-pointer" 
            title="ê³¼ì œ ì œì¶œì¼ ë³€ê²½" 
        />
    </div>
    <input 
        value={newTask} 
        onChange={e => setNewTask(e.target.value)} 
        className="flex-1 min-w-0 p-2.5 border border-slate-300 rounded-xl text-sm outline-none focus:border-indigo-500 shadow-sm" 
        placeholder="ì˜ˆ: ìˆ˜í•™ ìµí˜ì±… í’€ì–´ì˜¤ê¸°" 
        onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addTask() }} 
    />
    <Btn 
        onClick={addTask} 
        className="shrink-0 bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-indigo-700 whitespace-nowrap"
    >
        ì¶”ê°€
    </Btn>
</div><TagSelector current={selectedTag} setTag={setSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><div className="flex items-center gap-2"><span className="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] rounded font-bold">{t.tag}</span><span className="text-sm font-medium text-slate-700">{t.title}</span></div><Btn onClick={() => removeTask(i)} className="text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div>))}{tasks.length === 0 && <div className="text-center text-slate-400 text-sm py-4">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div></section><section><h4 className="font-bold text-slate-700 mb-3 border-l-4 border-green-500 pl-3"><span>ìš”ì¼ë³„ ê³ ì • ê³¼ì œ</span></h4><div className="bg-green-50/50 p-4 rounded-2xl border border-green-100"><div className="flex justify-between mb-3 bg-white p-1 rounded-xl border border-green-100">{[1, 2, 3, 4, 5].map(d => <Btn key={d} onClick={() => toggleDay(d)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${wSelectedDays.includes(d) ? 'bg-green-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>{DAYS[d]}</Btn>)}</div><div className="flex flex-col mb-6"><div className="flex gap-2 items-center mb-2 w-full"><input value={wNewTask} onChange={e => setWNewTask(e.target.value)} className="flex-1 min-w-0 p-2.5 border rounded-xl text-sm outline-none focus:border-green-500" placeholder="ê³¼ì œ ë‚´ìš©" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addWeeklyTask() }} /><Btn onClick={addWeeklyTask} className="shrink-0 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 whitespace-nowrap">ì¼ê´„ ì¶”ê°€</Btn></div><TagSelector current={wSelectedTag} setTag={setWSelectedTag} tags={tags} onAdd={t=>handleTagAction('add',t)} onEdit={(o,n)=>handleTagAction('edit',o,n)} onDelete={t=>handleTagAction('delete',t)} /></div><div className="grid grid-cols-1 sm:grid-cols-5 gap-3">{[1, 2, 3, 4, 5].map(d => (<div key={d} className="bg-white p-3 rounded-xl border border-slate-200"><div className="text-center font-bold text-slate-500 text-xs mb-2 pb-1 border-b">{DAYS[d]}ìš”ì¼</div><div className="space-y-1 min-h-[60px]">{(wTasks[d] || []).map((t, i) => (<div key={i} className="flex justify-between items-start text-xs bg-slate-50 p-1.5 rounded group"><div className="flex flex-col"><span className="text-[9px] text-slate-400">{t.tag}</span><span className="break-all leading-tight">{t.title}</span></div><Btn onClick={() => removeWeeklyTask(d, i)} className="text-rose-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 ml-1">Ã—</Btn></div>))}</div></div>))}</div></div></section></BaseModal>
            );
        };
        
        const StickerAutomationView = ({ students, records, dailyTasks, saveData, isLocalMode, showToast, openConfirm, setStudents }) => {
            const [stickerDate, setStickerDate] = useState(getToday());
            const [stickerRate, setStickerRate] = useState(100);
            const [stickerAdd, setStickerAdd] = useState(1);
            const [previewCount, setPreviewCount] = useState(-1);

            const calculateQualified = () => {
                const tasks = dailyTasks[stickerDate] || [];
                if (tasks.length === 0) return [];
                
                return students.filter(s => {
                    const rec = records[stickerDate]?.[s.id];
                    let done = 0;
                    if (rec) {
                        tasks.forEach((_, idx) => {
                            if (rec.tasks && rec.tasks[idx]) done++;
                            else if (!rec.tasks && rec.done) done++;
                        });
                    }
                    const rate = (done / tasks.length) * 100;
                    return rate >= stickerRate;
                });
            };

            const handlePreviewStickers = () => {
                const qualified = calculateQualified();
                setPreviewCount(qualified.length);
            };

            const handleApplyStickers = () => {
                const qualified = calculateQualified();
                if (qualified.length === 0) {
                    showToast("ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                
                openConfirm(`${stickerDate} ê³¼ì œ ìˆ˜í–‰ë¥  ${stickerRate}% ì´ìƒì¸\n${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ ${stickerAdd}ê°œë¥¼ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                    const updatedStudents = students.map(s => {
                        if (qualified.find(q => q.id === s.id)) {
                            return { ...s, stickers: (s.stickers || 0) + stickerAdd };
                        }
                        return s;
                    });
                    setStudents(updatedStudents);
                    if(!isLocalMode) saveData('cls_students', updatedStudents);
                    showToast(`${qualified.length}ëª…ì—ê²Œ ìŠ¤í‹°ì»¤ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`);
                    setPreviewCount(-1);
                });
            };

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full flex flex-col"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸŒŸ</div><h3 className="font-bold text-slate-800 text-lg flex items-center gap-2 mb-6 relative z-10"><span className="text-xl">ğŸŒŸ</span> ì¹­ì°¬ ìŠ¤í‹°ì»¤ ìë™ ë¶€ì—¬</h3><div className="space-y-6 relative z-10 flex-1 flex flex-col justify-center"><div className="space-y-2"><label className="text-xs font-bold text-slate-500">ë‚ ì§œ ë° ê¸°ì¤€</label><div className="flex gap-2 items-center"><input type="date" value={stickerDate} onChange={e => { setStickerDate(e.target.value); setPreviewCount(-1); }} className="flex-1 p-2.5 border rounded-xl text-sm bg-slate-50 outline-none focus:border-indigo-500" /><select value={stickerRate} onChange={e => { setStickerRate(parseInt(e.target.value)); setPreviewCount(-1); }} className="p-2.5 border rounded-xl text-sm bg-slate-50 font-bold outline-none focus:border-indigo-500"><option value="100">100%</option><option value="80">80%â†‘</option><option value="50">50%â†‘</option></select></div></div><div className="space-y-2"><div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">ì§€ê¸‰ ê°œìˆ˜</label>{previewCount >= 0 && <span className="text-indigo-600 text-xs font-bold animate-fade-in">{previewCount}ëª… ëŒ€ìƒ</span>}</div><div className="flex items-center bg-slate-50 border rounded-xl overflow-hidden"><button onClick={() => setStickerAdd(Math.max(1, stickerAdd - 1))} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">-</button><span className="flex-1 text-center font-bold text-slate-700">{stickerAdd}ê°œ</span><button onClick={() => setStickerAdd(stickerAdd + 1)} className="px-4 py-3 hover:bg-slate-200 text-slate-500 transition-colors">+</button></div></div><div className="grid grid-cols-2 gap-3 pt-2"><Btn onClick={handlePreviewStickers} className="py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 text-sm">ëŒ€ìƒ í™•ì¸</Btn><Btn onClick={handleApplyStickers} className="py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 text-sm shadow-md">ì§€ê¸‰í•˜ê¸°</Btn></div></div></div>
            );
        };

        const MissingView = ({ students, records, dailyTasks }) => {
            const [filter, setFilter] = useState('today');
            
            const datesToCheck = useMemo(() => {
                const today = getToday();
                if (filter === 'today') return [today];
                return [
                    today,
                    dayjs().subtract(1, 'day').format('YYYY-MM-DD'),
                    dayjs().subtract(2, 'day').format('YYYY-MM-DD')
                ];
            }, [filter]);

            const missingData = useMemo(() => {
                const data = {};
                datesToCheck.forEach(date => {
                    const tasks = dailyTasks[date] || [];
                    if (tasks.length === 0) return;
                    
                    data[date] = tasks.map((task, idx) => {
                        const missingStudents = students.filter(s => {
                            const rec = records[date]?.[s.id];
                            if (rec && rec.tasks && rec.tasks[idx]) return false;
                            if (rec && !rec.tasks && rec.done) return false;
                            return true;
                        });
                        return { 
                            task: typeof task === 'object' ? task : { title: task, tag: 'ê¸°íƒ€' }, 
                            students: missingStudents 
                        };
                    }).filter(item => item.students.length > 0);
                });
                return data;
            }, [datesToCheck, dailyTasks, students, records]);

            const hasMissingData = Object.keys(missingData).some(date => missingData[date].length > 0);

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden animate-fade-in h-full">
                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">âš ï¸</div>
                    <div className="flex flex-wrap items-center gap-3 mb-6 relative z-10">
                        <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2"><span className="text-xl">âš ï¸</span> ê³¼ì œ ë¯¸ì œì¶œ ëª…ë‹¨</h3>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setFilter('today')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'today' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì˜¤ëŠ˜</button>
                            <button onClick={() => setFilter('recent3')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${filter === 'recent3' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ìµœê·¼ 3ì¼</button>
                        </div>
                    </div>
                    <div className="relative z-10 space-y-4">
                        {!hasMissingData ? (
                            <div className="text-center py-6 text-slate-400 flex flex-col items-center bg-slate-50 rounded-xl border border-slate-200 border-dashed">
                                <Icon d={PATHS.check} size={32} className="mb-2 text-indigo-200"/>
                                <p className="text-sm">ë¯¸ì œì¶œ ë‚´ì—­ì´ ì—†ê±°ë‚˜ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ‰</p>
                            </div>
                        ) : (
                            Object.entries(missingData).map(([date, items]) => {
                                if (items.length === 0) return null;
                                return (
                                    <div key={date} className="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                                        <div className="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-white/50">
                                            <h3 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“… {dayjs(date).format('MMì›” DDì¼ (ddd)')}</h3>
                                            <span className="text-xs font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-lg border border-rose-100">ë¯¸ì œì¶œ {items.reduce((acc, curr) => acc + curr.students.length, 0)}ê±´</span>
                                        </div>
                                        <div className="divide-y divide-slate-200/50">
                                            {items.map((item, idx) => (
                                                <div key={idx} className="p-4">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-xs rounded-md font-bold">{item.task.tag}</span>
                                                        <span className="font-bold text-slate-700">{item.task.title}</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 mt-2">
                                                        {item.students.map(s => (
                                                            <span key={s.id} className="inline-flex items-center px-2.5 py-1 rounded-lg bg-white text-rose-600 text-xs font-bold border border-rose-100 shadow-sm">{s.order}. {s.name}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const ApiKeyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="Gemini API í‚¤ ë°œê¸‰ ë°©ë²•" icon={PATHS.key}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Googleì˜ <strong>Gemini API í‚¤</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ë¬´ë£Œ)</p>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-2">
                            <h4 className="font-bold text-slate-800">ğŸ”‘ ë°œê¸‰ ìˆœì„œ</h4>
                            <ol className="list-decimal pl-5 space-y-1">
                                <li>ì•„ë˜ <strong>'Google AI Studio ë°”ë¡œê°€ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                <li>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</li>
                                <li>ì¢Œì¸¡ ìƒë‹¨ì˜ <strong>'Get API key'</strong> ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                                <li><strong>'Create API key'</strong>ë¥¼ í´ë¦­í•˜ì—¬ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
                                <li>ìƒì„±ëœ í‚¤(sk-...)ë¥¼ ë³µì‚¬í•˜ì—¬ ì´ ì•±ì˜ ì„¤ì • ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</li>
                            </ol>
                        </div>
                        <div className="flex justify-center">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2">
                                <Icon d={PATHS.link} size={16} /> Google AI Studio ë°”ë¡œê°€ê¸°
                            </a>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const NotionSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode, isPortfolioMode, setIsPortfolioMode, studentMap, setStudentMap, portfolioDbId, setPortfolioDbId }) => {
            const [apiKey, setApiKey] = useState("");
            const [dbId, setDbId] = useState("");
            const [saveLocally, setSaveLocally] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [isTesting, setIsTesting] = useState(false);
            const [testSuccess, setTestSuccess] = useState(false);
            const [manualInput, setManualInput] = useState("");
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    const savedKey = localStorage.getItem('cls_notion_key');
                    const savedDbId = localStorage.getItem('cls_notion_db_id');
                    
                    // [Fix] ì €ì¥ëœ í‚¤/ID ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì œê±° (JSON.stringifyë¡œ ì¸í•´ ìƒê¸°ëŠ” ë¬¸ì œ í•´ê²°)
                    if (savedKey) {
                        setApiKey(savedKey.replace(/["']/g, '').trim());
                    }
                    if (savedDbId) {
                        setDbId(savedDbId.replace(/["']/g, '').trim());
                    }
                    
                    if (portfolioDbId && (portfolioDbId.includes('"') || portfolioDbId.includes("'"))) {
                        setPortfolioDbId(portfolioDbId.replace(/["']/g, '').trim());
                    }
                    if (savedKey || savedDbId) setSaveLocally(true);
                    
                    const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                    if (setIsPortfolioMode && savedMode !== isPortfolioMode) setIsPortfolioMode(savedMode);
                }
            }, [isOpen]);

            const handleTestConnection = async () => {
                const cleanKey = apiKey.replace(/["']/g, '').trim();
                if (!cleanKey) return showToast("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                const cleanDbId = dbId.replace(/["']/g, '').trim();
                const cleanPortfolioId = portfolioDbId ? portfolioDbId.replace(/["']/g, '').trim() : "";
                
                const tests = [];
                if (cleanDbId) tests.push({ id: cleanDbId, mode: 'normal', label: 'ê¸°ë¡ ëª¨ë“œ' });
                if (cleanPortfolioId) tests.push({ id: cleanPortfolioId, mode: 'relation', label: 'í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ' });

                if (tests.length === 0) return showToast("Database IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                setIsTesting(true);
                setTestSuccess(false);
                
                let successCount = 0;
                let messages = [];

                for (const test of tests) {
                    try {
                        const response = await fetch('/api/save-notion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                personalKey: cleanKey, 
                                personalDbId: test.id,
                                testMode: true,
                                mode: test.mode
                            })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || "ì‹¤íŒ¨");
                        successCount++;
                        messages.push(`âœ… ${test.label}: ì„±ê³µ`);
                    } catch (e) {
                        messages.push(`âŒ ${test.label}: ${e.message}`);
                    }
                }

                setIsTesting(false);
                if (successCount > 0) {
                    setSaveLocally(true);
                    setTestSuccess(true);
                    setTimeout(() => setTestSuccess(false), 3000);
                }
                showToast(messages.join('\n'));
            };

            const handleSave = () => {
                const cleanKey = apiKey.replace(/["']/g, '').trim();
                const cleanDbId = dbId.replace(/["']/g, '').trim();
                const cleanPortfolioId = portfolioDbId ? portfolioDbId.replace(/["']/g, '').trim() : "";
                
                // [Fix] í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ëª…ì‹œì  ì €ì¥
                localStorage.setItem('cls_portfolio_mode', isPortfolioMode);

                if (saveLocally) {
                    localStorage.setItem('cls_notion_key', cleanKey);
                    localStorage.setItem('cls_notion_db_id', cleanDbId);
                    if (cleanPortfolioId) localStorage.setItem('cls_notion_portfolio_db_id', cleanPortfolioId);

                    if (!isLocalMode && saveData) saveData({ 
                        cls_notion_key: cleanKey, 
                        cls_notion_db_id: cleanDbId,
                        cls_notion_portfolio_db_id: cleanPortfolioId,
                        cls_portfolio_mode: isPortfolioMode
                    });
                } else {
                    localStorage.removeItem('cls_notion_key');
                    localStorage.removeItem('cls_notion_db_id');
                    localStorage.removeItem('cls_notion_portfolio_db_id');
                    if (!isLocalMode && saveData) saveData({ cls_notion_key: "", cls_notion_db_id: "", cls_notion_portfolio_db_id: "" });
                }
                showToast("ë…¸ì…˜ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            const handlePasteKey = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setApiKey(text);
                        showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const setTargetDbId = (val) => {
                const cleanVal = val.replace(/["']/g, '').trim();
                if (isPortfolioMode) {
                    setPortfolioDbId(cleanVal);
                    localStorage.setItem('cls_notion_portfolio_db_id', cleanVal);
                } else {
                    setDbId(cleanVal);
                    localStorage.setItem('cls_notion_db_id', cleanVal);
                }
            };

            const extractAndSetDbId = (text) => {
                if (text.includes("notion.so")) {
                    const match = text.match(/([a-f0-9]{32})/);
                    if (match) {
                        setTargetDbId(match[1]);
                        return true;
                    }
                }
                setTargetDbId(text);
                return false;
            };

            const handlePasteDbId = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        if (extractAndSetDbId(text)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ë¶™ì—¬ë„£ì—ˆìŠµë‹ˆë‹¤.");
                        else showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const handlePortfolioToggle = (e) => {
                const checked = e.target.checked;
                if (setIsPortfolioMode) setIsPortfolioMode(checked);
                localStorage.setItem('cls_portfolio_mode', checked);
                if (showToast) showToast(checked ? "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œê°€ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê¸°ë¡ëª¨ë“œê°€ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleFileUploadPortfolio = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const lines = text.split(/[\r\n]+/);
                    const newMap = { ...studentMap };
                    let count = 0;
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const parts = line.split(/[,:\t]+/).map(s => s.trim());
                        if (parts.length >= 2) {
                            const name = parts[0];
                            const id = parts[parts.length - 1];
                            if (name && id) { newMap[name] = id; count++; }
                        }
                    });
                    if (setStudentMap) setStudentMap(newMap);
                    localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                    if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
                    showToast(`${count}ëª…ì˜ ë°ì´í„°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleManualAdd = () => {
                if (!manualInput.trim()) return;
                const lines = manualInput.split(/[\r\n]+/);
                const newMap = { ...studentMap };
                let count = 0;
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/[:=,]+/).map(s => s.trim());
                    if (parts.length >= 2) {
                        const name = parts[0];
                        const id = parts[parts.length - 1];
                        if (name && id) { newMap[name] = id; count++; }
                    }
                });
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
                setManualInput("");
                showToast(`${count}ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            const handleDeleteItem = (name) => {
                const newMap = { ...studentMap };
                delete newMap[name];
                if (setStudentMap) setStudentMap(newMap);
                localStorage.setItem('cls_student_map', JSON.stringify(newMap));
                if (!isLocalMode && saveData) saveData('cls_student_map', newMap);
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ““ Notion ì—°ë™ ì„¤ì •" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <p className="font-bold mb-1">ğŸ”‘ ê°œì¸ ë…¸ì…˜ ì—°ë™</p>
                            <p>ì…ë ¥í•œ ì •ë³´ëŠ” ë¸Œë¼ìš°ì €(Local Storage)ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ì— ë³„ë„ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>

                        {showManual && (
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-slate-700 space-y-4 animate-fade-in">
                                <div>
                                    <h4 className="font-bold text-indigo-700 mb-2">ğŸš€ ë…¸ì…˜ ì—°ë™ 3ë‹¨ê³„ (ê³µí†µ)</h4>
                                    <ol className="list-decimal pl-4 space-y-1">
                                        <li><strong>í†µí•© ë§Œë“¤ê¸°:</strong> <a href="https://www.notion.so/my-integrations" target="_blank" className="text-blue-600 underline font-bold">ë…¸ì…˜ ë‚´ í†µí•©</a>ì—ì„œ 'ìƒˆ í†µí•©' ìƒì„± í›„ <strong>API Key</strong> ë³µì‚¬.</li>
                                        <li><strong>ì—°ê²°í•˜ê¸°:</strong> ì‚¬ìš©í•  ë…¸ì…˜ DB í˜ì´ì§€ ìš°ì¸¡ ìƒë‹¨ <strong>[...] &gt; [ì—°ê²°]</strong>ì—ì„œ í†µí•© ì—°ê²°.</li>
                                        <li><strong>ID ì°¾ê¸°:</strong> DB í˜ì´ì§€ URLì—ì„œ <strong>32ìë¦¬ ID</strong> ë³µì‚¬.<br/><span className="text-[10px] text-slate-500 bg-white px-1 border rounded mt-1 inline-block">https://notion.so/.../<b>30a285...</b>?v=...</span></li>
                                    </ol>
                                </div>
                                
                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-2">ğŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ì†ì„± ì„¤ì • (í•„ìˆ˜)</h4>
                                    <p className="mb-2 text-slate-500">ë…¸ì…˜ DBì˜ ì†ì„± ì´ë¦„ê³¼ ìœ í˜•ì„ ì•„ë˜ì™€ ë˜‘ê°™ì´ ë§ì¶°ì£¼ì„¸ìš”. (í´ë¦­í•˜ì—¬ ë³µì‚¬)</p>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <h5 className="font-bold text-slate-800 mb-2 border-b pb-1">âšª ê¸°ë³¸ ëª¨ë“œ (ê¸°ë¡ìš©)</h5>
                                            <ul className="space-y-1 text-slate-600">
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ì´ë¦„"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ì´ë¦„</button> (ì œëª©)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚ ì§œ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë‚ ì§œ</button> (ë‚ ì§œ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë¶„ë¥˜"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë¶„ë¥˜</button> (ì„ íƒ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚´ìš©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-slate-100 px-1 rounded border border-slate-200 bg-slate-50 font-bold">ë‚´ìš©</button> (í…ìŠ¤íŠ¸)</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white p-3 rounded-lg border border-indigo-200 shadow-sm ring-1 ring-indigo-50">
                                            <h5 className="font-bold text-indigo-600 mb-2 border-b border-indigo-100 pb-1">ğŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ</h5>
                                            <ul className="space-y-1 text-slate-600">
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ì œëª©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ì œëª©</button> (ì œëª©)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ìƒì„±ì¼ì‹œ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ìƒì„±ì¼ì‹œ</button> (ë‚ ì§œ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë¶„ë¥˜"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ë¶„ë¥˜</button> (ì„ íƒ)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("ë‚´ìš©"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">ë‚´ìš©</button> (í…ìŠ¤íŠ¸)</li>
                                                <li className="flex items-center gap-1"><button onClick={() => { navigator.clipboard.writeText("í•™ìƒ"); showToast("ë³µì‚¬ë¨"); }} className="hover:bg-indigo-50 px-1 rounded border border-indigo-100 bg-white font-bold text-indigo-700">í•™ìƒ</button> (ê´€ê³„í˜•)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-3 border-t border-indigo-200">
                                    <h4 className="font-bold text-slate-700 mb-1">ğŸŒ Vercel ë°°í¬ìš© API ì½”ë“œ</h4>
                                    <p className="text-slate-500 mb-2">ì§ì ‘ ë°°í¬í•˜ì‹œëŠ” ê²½ìš° <code>api/save-notion.js</code> íŒŒì¼ì„ ìƒì„±í•˜ê³  ì•„ë˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                                    <div className="relative group">
                                        <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white max-h-40 custom-scroll">
{`export default async function handler(req, res) {
    if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');
    let { personalKey, personalDbId, studentName, date, category, content, mode, studentIds, testMode } = req.body;

    const cleanKey = personalKey ? personalKey.replace(/["']/g, '').trim() : '';
    const cleanDbId = personalDbId ? personalDbId.toString().replace(/["']/g, '').trim() : '';

    if (!cleanKey || !cleanDbId) return res.status(400).json({ error: "ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });

    const titlePropertyName = (mode === 'relation') ? "ì œëª©" : "ì´ë¦„";
    let properties = {};
    const pageIcon = { type: "emoji", emoji: testMode ? "ğŸ§ª" : "ğŸ€" };

    if (testMode) {
        properties[titlePropertyName] = { "title": [{ "text": { "content": \`âœ… [\${titlePropertyName}] ì¹¸ ì—°ë™ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\` } }] };
    } else {
        if (mode === 'relation') {
            const summary = content ? (content.length > 15 ? content.substring(0, 15) + "..." : content) : "ìƒˆë¡œìš´ ê¸°ë¡";
            properties["ì œëª©"] = { "title": [{ "text": { "content": \`[\${category || "ê´€ì°°"}] \${summary}\` } }] };
            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };
            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };
            if (studentIds && studentIds.length > 0) properties["í•™ìƒ"] = { "relation": studentIds.map(id => ({ "id": id })) };
        } else {
            properties["ì´ë¦„"] = { "title": [{ "text": { "content": studentName || "í•™ìƒ" } }] };
            properties["ë‚ ì§œ"] = { "date": { "start": date || new Date().toISOString().split('T')[0] } };
            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };
            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };
        }
    }

    try {
        const response = await fetch('https://api.notion.com/v1/pages', {
            method: 'POST',
            headers: { 'Authorization': \`Bearer \${cleanKey}\`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' },
            body: JSON.stringify({ parent: { database_id: cleanDbId }, icon: pageIcon, properties: properties })
        });
        const data = await response.json();
        if (!response.ok) return res.status(response.status).json(data);
        res.status(200).json({ success: true });
    } catch (error) { res.status(500).json({ error: error.message }); }
}`}
                                        </div>
                                        <button onClick={() => { 
                                            const code = `export default async function handler(req, res) {\n    if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');\n    let { personalKey, personalDbId, studentName, date, category, content, mode, studentIds, testMode } = req.body;\n\n    const cleanKey = personalKey ? personalKey.replace(/["']/g, '').trim() : '';\n    const cleanDbId = personalDbId ? personalDbId.toString().replace(/["']/g, '').trim() : '';\n\n    if (!cleanKey || !cleanDbId) return res.status(400).json({ error: "ì„¤ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });\n\n    const titlePropertyName = (mode === 'relation') ? "ì œëª©" : "ì´ë¦„";\n    let properties = {};\n    const pageIcon = { type: "emoji", emoji: testMode ? "ğŸ§ª" : "ğŸ€" };\n\n    if (testMode) {\n        properties[titlePropertyName] = { "title": [{ "text": { "content": \`âœ… [\${titlePropertyName}] ì¹¸ ì—°ë™ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\` } }] };\n    } else {\n        if (mode === 'relation') {\n            const summary = content ? (content.length > 15 ? content.substring(0, 15) + "..." : content) : "ìƒˆë¡œìš´ ê¸°ë¡";\n            properties["ì œëª©"] = { "title": [{ "text": { "content": \`[\${category || "ê´€ì°°"}] \${summary}\` } }] };\n            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };\n            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };\n            if (studentIds && studentIds.length > 0) properties["í•™ìƒ"] = { "relation": studentIds.map(id => ({ "id": id })) };\n        } else {\n            properties["ì´ë¦„"] = { "title": [{ "text": { "content": studentName || "í•™ìƒ" } }] };\n            properties["ë‚ ì§œ"] = { "date": { "start": date || new Date().toISOString().split('T')[0] } };\n            properties["ë¶„ë¥˜"] = { "select": { "name": category || "ê´€ì°°" } };\n            properties["ë‚´ìš©"] = { "rich_text": [{ "text": { "content": content || "" } }] };\n        }\n    }\n\n    try {\n        const response = await fetch('https://api.notion.com/v1/pages', {\n            method: 'POST',\n            headers: { 'Authorization': \`Bearer \${cleanKey}\`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' },\n            body: JSON.stringify({ parent: { database_id: cleanDbId }, icon: pageIcon, properties: properties })\n        });\n        const data = await response.json();\n        if (!response.ok) return res.status(response.status).json(data);\n        res.status(200).json({ success: true });\n    } catch (error) { res.status(500).json({ error: error.message }); }\n}`; 
                                            navigator.clipboard.writeText(code); 
                                            showToast("âœ… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                                        }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                            <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Notion API Key (Secret)</label>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="secret_..." />
                                    {apiKey && (
                                        <button onClick={() => setApiKey("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                            <Icon d={PATHS.x} size={14} />
                                        </button>
                                    )}
                                </div>
                                <Btn onClick={handlePasteKey} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">{isPortfolioMode ? "ğŸ”µ í¬íŠ¸í´ë¦¬ì˜¤ìš© DB ID (í•™ìƒê³¼ ì—°ê²°)" : "âšª ì¼ë°˜ ê¸°ë¡ìš© DB ID (ë‹¨ìˆœ ê¸°ë¡)"}</label>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <input type="text" value={isPortfolioMode ? portfolioDbId : dbId} onChange={e => { const val = e.target.value.replace(/"/g, ''); if(extractAndSetDbId(val)) showToast("URLì—ì„œ IDë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤."); }} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="32ìë¦¬ ID (URL ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)" />
                                    {(isPortfolioMode ? portfolioDbId : dbId) && (
                                        <button onClick={() => isPortfolioMode ? setPortfolioDbId("") : setDbId("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                            <Icon d={PATHS.x} size={14} />
                                        </button>
                                    )}
                                </div>
                                <Btn onClick={handlePasteDbId} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                            </div>
                        </div>
                        
                        <div className="pt-4 border-t border-slate-200">
                            <label className="flex items-center justify-between cursor-pointer select-none">
                                <span className="text-sm font-bold text-slate-700">{isPortfolioMode ? "í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ" : "ê¸°ë¡ ëª¨ë“œ (ê¸°ë³¸)"}</span>
                                <div className="relative">
                                    <input type="checkbox" className="sr-only" checked={isPortfolioMode} onChange={handlePortfolioToggle} />
                                    <div className={`w-10 h-6 rounded-full shadow-inner transition-colors ${isPortfolioMode ? 'bg-indigo-500' : 'bg-slate-300'}`}></div>
                                    <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${isPortfolioMode ? 'translate-x-4' : ''}`}></div>
                                </div>
                            </label>
                            <p className="text-xs text-slate-500 mt-1">í•™ìƒ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ì—°ê²°ëœ ë…¸ì…˜ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
                        </div>

                        {isPortfolioMode && (
                            <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-4 animate-fade-in">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xs font-bold text-slate-600">ëª…ë‹¨ ê´€ë¦¬ (ì´ë¦„:ë…¸ì…˜ID)</h4>
                                    <Btn onClick={() => fileInputRef.current.click()} className="px-2 py-1 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50">ğŸ“‚ ì—‘ì…€(CSV) ì—…ë¡œë“œ</Btn>
                                    <input type="file" ref={fileInputRef} onChange={handleFileUploadPortfolio} className="hidden" accept=".csv,.txt" />
                                </div>
                                <div className="max-h-32 overflow-y-auto custom-scroll bg-white border border-slate-200 rounded-lg p-2 space-y-1">
                                    {studentMap && Object.keys(studentMap).length > 0 ? (
                                        Object.entries(studentMap).sort((a, b) => a[0].localeCompare(b[0])).map(([name, id]) => (
                                            <div key={name} className="flex justify-between items-center text-xs p-1 hover:bg-slate-50 rounded">
                                                <span className="font-bold text-slate-700">{name}</span>
                                                <div className="flex items-center gap-2"><span className="text-slate-400 font-mono text-[10px] truncate max-w-[100px]">{id}</span><button onClick={() => handleDeleteItem(name)} className="text-rose-400 hover:text-rose-600">Ã—</button></div>
                                            </div>
                                        ))
                                    ) : (<div className="text-center text-slate-400 text-xs py-4">ë“±ë¡ëœ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                </div>
                                <div className="flex gap-2">
                                    <textarea value={manualInput} onChange={e => setManualInput(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-indigo-500 resize-none" placeholder="ì´ë¦„:ID (ì—¬ëŸ¬ ëª…ì€ ì¤„ë°”ê¿ˆ)" rows="2" />
                                    <Btn onClick={handleManualAdd} className="px-3 bg-indigo-500 text-white rounded-lg text-xs font-bold hover:bg-indigo-600">ì¶”ê°€</Btn>
                                </div>
                            </div>
                        )}

                        <label className="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" checked={saveLocally} onChange={e => setSaveLocally(e.target.checked)} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                            <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— ì •ë³´ ì €ì¥í•˜ê¸°</span>
                        </label>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTestConnection} disabled={isTesting} className={`flex-1 py-3 rounded-xl font-bold transition-colors ${testSuccess ? 'bg-green-500 text-white border border-green-500 hover:bg-green-600' : 'bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50'}`}>
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>í™•ì¸ ì¤‘...</> : testSuccess ? 'âœ… ì—°ë™ ì„±ê³µ!' : 'ğŸ”Œ ì—°ë™ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md transition-colors">ì„¤ì • ì €ì¥í•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const GoogleSheetSetupModal = ({ isOpen, onClose, showToast, saveData, isLocalMode }) => {
            const [url, setUrl] = useState("");
            const [isTesting, setIsTesting] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [testSuccess, setTestSuccess] = useState(false);
            const [saveLocally, setSaveLocally] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    let savedUrl = localStorage.getItem('cls_google_sheet_url') || "";
                    // ğŸŒŸ ë¶ˆëŸ¬ì˜¬ ë•Œ ë”°ì˜´í‘œ ì°Œêº¼ê¸° 1ì°¨ ì œê±°
                    savedUrl = savedUrl.trim().replace(/^"|'|"$|'$/g, '');
                    setUrl(savedUrl);
                    if (savedUrl) setSaveLocally(true);
                }
            }, [isOpen]);

            const handleTestConnection = async () => {
                // ğŸŒŸ í…ŒìŠ¤íŠ¸í•  ë•Œë„ ì•ˆì „í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì „ì†¡
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                if (!cleanUrl) return showToast("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsTesting(true);
                setTestSuccess(false);
                try {
                    await fetch(cleanUrl, {
                        method: "POST",
                        mode: 'no-cors',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ date: dayjs().format('YYYY-MM-DD HH:mm:ss'), name: "í…ŒìŠ¤íŠ¸", category: "ì—°ë™ í…ŒìŠ¤íŠ¸", content: "Google ì‹œíŠ¸ ì—°ë™ ì„±ê³µ!" })
                    });
                    showToast("âœ… ì „ì†¡ ì„±ê³µ! ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    setTestSuccess(true);
                    setTimeout(() => setTestSuccess(false), 3000);
                } catch (e) {
                    showToast("âŒ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
                    setTestSuccess(false);
                } finally {
                    setIsTesting(false);
                }
            };

            const handleSave = () => {
                // ğŸŒŸ ì˜êµ¬ ì €ì¥í•  ë•Œ ì™„ë²½í•˜ê²Œ ë”°ì˜´í‘œ ì œê±° í›„ ì €ì¥
                const cleanUrl = url.trim().replace(/^"|'|"$|'$/g, '');
                
                if (saveLocally) {
                    localStorage.setItem('cls_google_sheet_url', cleanUrl);
                    if (!isLocalMode && saveData) saveData('cls_google_sheet_url', cleanUrl);
                } else {
                    localStorage.removeItem('cls_google_sheet_url');
                    if (!isLocalMode && saveData) saveData('cls_google_sheet_url', "");
                }
                
                showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™" icon={null}>
                    <div className="space-y-4">
                        <div className="bg-green-50 p-4 rounded-xl border border-green-200 text-sm text-green-800">
                            <p className="font-bold mb-1">ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™</p>
                            <p>ê¸°ë¡ëœ ë°ì´í„°ë¥¼ êµ¬ê¸€ ì‹œíŠ¸ì— ìë™ìœ¼ë¡œ í•œ ì¤„ì”© ì¶”ê°€í•©ë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex justify-end">
                            <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                                <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                            </button>
                        </div>
                        {showManual && (
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-600 space-y-2 animate-fade-in">
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± &gt; <strong>í™•ì¥ í”„ë¡œê·¸ë¨ &gt; Apps Script</strong></li>
                                    <li>ì•„ë˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸° &gt; ì €ì¥
                                <div className="relative mt-2 mb-2 group">
                                    <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white">
{`function doPost(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);

    // ğŸŒŸ 1. ì—¬ëŸ¬ ëª…ì˜ ë°ì´í„°ê°€ í•œêº¼ë²ˆì— 'ë°°ì—´(ë°•ìŠ¤)'ë¡œ ë“¤ì–´ì˜¨ ê²½ìš° (ì´ˆê³ ì† ì¼ê´„ ì €ì¥)
    if (Array.isArray(data)) {
      var rows = [];
      for (var i = 0; i < data.length; i++) {
        // [ì£¼ì˜] Aì—´:ë‚ ì§œ, Bì—´:ì´ë¦„, Cì—´:ë¶„ë¥˜, Dì—´:ë‚´ìš© ìˆœì„œì…ë‹ˆë‹¤.
        rows.push([data[i].date, data[i].name, data[i].category, data[i].content]);
      }
      
      // êµ¬ê¸€ ì‹œíŠ¸ì˜ ë¹ˆ ì¤„ì„ ì°¾ì•„ì„œ, ì—¬ëŸ¬ ì¤„ì„ ë‹¨ 0.1ì´ˆ ë§Œì— í•œ ë²ˆì— ìŸì•„ë¶“ìŠµë‹ˆë‹¤!
      if (rows.length > 0) {
        sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
      }
    } 
    // ğŸŒŸ 2. ê¸°ì¡´ì²˜ëŸ¼ 1ëª… ë¶„ëŸ‰ì˜ ë°ì´í„°ë§Œ ë“¤ì–´ì˜¨ ê²½ìš° (ì•ˆì „ì¥ì¹˜)
    else {
      sheet.appendRow([data.date, data.name, data.category, data.content]);
    }

    return ContentService.createTextOutput(JSON.stringify({"result": "success", "message": "ì´ˆê³ ì† ì €ì¥ ì„±ê³µ!"}))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({"result": "error", "error": error.toString()}))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}`}
                                    </div>
                                    <button onClick={() => { const code = `function doPost(e) {\n  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();\n  var data = JSON.parse(e.postData.contents);\n  sheet.appendRow([data.date, data.name, data.category, data.content]);\n  return ContentService.createTextOutput("Success");\n}`; navigator.clipboard.writeText(code); showToast("âœ… ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                        <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                    </button>
                                        </div>
                                    </li>
                                    <li><strong>ë°°í¬ &gt; ìƒˆ ë°°í¬</strong> (ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´ ë°˜ë“œì‹œ 'ìƒˆ ë²„ì „'ìœ¼ë¡œ ë°°í¬í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤!)</li>
                                    <li>ìœ í˜•: <strong>ì›¹ ì•±</strong> &gt; ì•¡ì„¸ìŠ¤ ê¶Œí•œ: <strong>ëª¨ë“  ì‚¬ìš©ì</strong> (í•„ìˆ˜)</li>
                                    <li>ìƒì„±ëœ <strong>ì›¹ ì•± URL</strong>ì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.</li>
                                </ol>
                            </div>
                        )}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">Web App URL</label>
                            <div className="relative">
                                <input type="text" value={url} onChange={e => setUrl(e.target.value)} className="w-full p-3 pr-10 border rounded-xl text-sm outline-none focus:border-green-500 font-mono" placeholder="https://script.google.com/macros/s/..." />
                                {url && (
                                    <button onClick={() => setUrl("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                        <Icon d={PATHS.x} size={16} />
                                    </button>
                                )}
                            </div>
                        </div>
                        <label className="flex items-center gap-2 cursor-pointer select-none mt-4">
                            <input type="checkbox" checked={saveLocally} onChange={e => setSaveLocally(e.target.checked)} className="w-4 h-4 text-green-600 rounded focus:ring-green-500" />
                            <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— ì •ë³´ ì €ì¥í•˜ê¸°</span>
                        </label>
                        <div className="flex gap-2 pt-2">
                            <Btn onClick={handleTestConnection} disabled={isTesting} className={`flex-1 py-3 rounded-xl font-bold transition-colors ${testSuccess ? 'bg-green-500 text-white border border-green-500 hover:bg-green-600' : 'bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50'}`}>
                                {isTesting ? <><Icon d={PATHS.spinner} className="animate-spin mr-2" size={16}/>í™•ì¸ ì¤‘...</> : testSuccess ? 'âœ… ì—°ë™ ì„±ê³µ!' : 'ğŸ”Œ ì—°ë™ í…ŒìŠ¤íŠ¸'}
                            </Btn>
                            <Btn onClick={handleSave} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md transition-colors">ì„¤ì • ì €ì¥í•˜ê¸°</Btn>
                        </div>

                    </div>
                </BaseModal>
            );
        };

        const ApiKeySetupModal = ({ isOpen, onClose, apiKey, setApiKey, saveData, isLocalMode, showToast, validateApiKey }) => {
            const [isChecking, setIsChecking] = useState(false);
            const [isSaved, setIsSaved] = useState(!!localStorage.getItem('cls_ai_key'));
            const [showHelp, setShowHelp] = useState(false);
            const [usage, setUsage] = useState(0);
            const [usageHistory, setUsageHistory] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setIsSaved(!!localStorage.getItem('cls_ai_key'));
                    setUsageHistory(JSON.parse(localStorage.getItem('cls_ai_usage_history') || '{}'));
                }
            }, [isOpen]);

            const handleCheck = async () => {
                setIsChecking(true);
                await validateApiKey();
                setIsChecking(false);
            };

            const handlePasteKey = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setApiKey(text);
                        showToast("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            const handleSaveToggle = (e) => {
                const checked = e.target.checked;
                setIsSaved(checked);
                if (checked) {
                    if(!isLocalMode) saveData('cls_ai_key', apiKey);
                    else localStorage.setItem('cls_ai_key', apiKey);
                } else {
                    if(!isLocalMode) saveData('cls_ai_key', "");
                    else localStorage.removeItem('cls_ai_key');
                }
            };

            const handleSaveAndClose = () => {
                if (isSaved) {
                    if(!isLocalMode) {
                        saveData('cls_ai_key', apiKey);
                        // [Fix] saveDataê°€ ë¬¸ìì—´ì— ë”°ì˜´í‘œë¥¼ ì¶”ê°€í•˜ì—¬ ì €ì¥í•˜ëŠ” ë¬¸ì œ ë°©ì§€ (ë®ì–´ì“°ê¸°)
                        localStorage.setItem('cls_ai_key', apiKey);
                    }
                    else localStorage.setItem('cls_ai_key', apiKey);
                    if(apiKey) showToast("API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    if(!isLocalMode) saveData('cls_ai_key', "");
                    else localStorage.removeItem('cls_ai_key');
                }
                onClose();
            };

            const renderUsageGraph = () => {
                const today = dayjs();
                const last7Days = Array.from({length: 7}, (_, i) => today.subtract(6 - i, 'day').format('YYYY-MM-DD'));
                const data = last7Days.map(d => ({ date: d, count: usageHistory[d] || 0 }));
                const maxCount = Math.max(...data.map(d => d.count), 5); // Minimum scale 5

                return (
                    <div className="mt-4 pt-4 border-t border-slate-100">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-slate-500">ìµœê·¼ 7ì¼ ì‚¬ìš©ëŸ‰</span>
                            <span className="text-[10px] text-slate-400">ì´ {usage}íšŒ</span>
                        </div>
                        <div className="flex items-end justify-between h-24 gap-2">
                            {data.map((d, i) => {
                                const height = Math.max((d.count / maxCount) * 100, 5); // Min height 5%
                                const isToday = d.date === today.format('YYYY-MM-DD');
                                return (
                                    <div key={i} className="flex flex-col items-center flex-1 gap-1 group relative">
                                        <div className="w-full bg-slate-100 rounded-t-md relative flex items-end justify-center overflow-hidden h-full">
                                            <div 
                                                className={`w-full transition-all duration-500 ease-out ${isToday ? 'bg-indigo-500' : 'bg-indigo-300 group-hover:bg-indigo-400'}`} 
                                                style={{ height: `${height}%` }}
                                            ></div>
                                            {d.count > 0 && (
                                                <span className="absolute bottom-1 text-[9px] font-bold text-white drop-shadow-md">{d.count}</span>
                                            )}
                                        </div>
                                        <span className={`text-[9px] ${isToday ? 'font-bold text-indigo-600' : 'text-slate-400'}`}>
                                            {dayjs(d.date).format('MM/DD')}
                                        </span>
                                        {d.count > 0 && (
                                            <div className="absolute bottom-full mb-1 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                                {d.count}íšŒ
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ¤– AI ì„¤ì •" icon={null}>
                    <ApiKeyHelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
                    <div className="space-y-4">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-bold mb-1">ğŸ”‘ Gemini API Key ì„¤ì •</p>
                                    <p>Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë¬´ë£Œ)</p>
                                </div>
                                <div className="flex flex-col items-end">
                                    <span className="text-[10px] font-bold text-slate-400 mb-0.5">Model</span>
                                    <span className="text-[10px] bg-white border border-slate-200 px-2 py-1 rounded-lg text-indigo-600 font-bold font-mono">
                                        {GEMINI_MODEL_NAME}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <div className="flex justify-between items-center">
                                <label className="text-xs font-bold text-slate-500">API Key</label>
                                <button onClick={() => setShowHelp(true)} className="text-[10px] text-indigo-500 hover:underline flex items-center gap-0.5">í‚¤ ë°œê¸‰ ë°©ë²• <Icon d={PATHS.help} size={10} /></button>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <input type="password" autoComplete="new-password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-3 pr-8 border rounded-xl text-sm outline-none focus:border-indigo-500 font-mono" placeholder="API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.." />
                                    {apiKey && (
                                        <button onClick={() => setApiKey("")} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors" title="ì§€ìš°ê¸°">
                                            <Icon d={PATHS.x} size={14} />
                                        </button>
                                    )}
                                </div>
                                <Btn onClick={handlePasteKey} className="px-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 whitespace-nowrap">ë¶™ì—¬ë„£ê¸°</Btn>
                                <Btn onClick={handleCheck} className="bg-indigo-600 text-white px-4 rounded-xl text-xs font-bold hover:bg-indigo-700 whitespace-nowrap">{isChecking ? 'í™•ì¸ ì¤‘...' : 'í™•ì¸'}</Btn>
                            </div>
                        </div>
                        
                        {renderUsageGraph()}

                        <div className="flex justify-between items-center pt-2">
                            <label className="flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" checked={isSaved} onChange={handleSaveToggle} className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" />
                                <span className="text-sm text-slate-700 font-bold">ì´ ê¸°ê¸°ì— í‚¤ ì €ì¥í•˜ê¸°</span>
                            </label>
                        </div>
                        <Btn onClick={handleSaveAndClose} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 mt-4 shadow-md">ì €ì¥ ë° ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ManualModal = ({ isOpen, onClose, content, onDownload }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“˜ ì‚¬ìš© ì„¤ëª…ì„œ" icon={PATHS.book} maxWidth="max-w-3xl">
                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 h-[60vh] overflow-y-auto custom-scroll whitespace-pre-wrap text-sm leading-relaxed text-slate-700 font-mono select-text shadow-inner">
                        {content}
                    </div>
                    <div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
                        <Btn onClick={onDownload} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-md transition-transform active:scale-95">
                            <Icon d={PATHS.download} size={18} /> í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                        </Btn>
                        <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">ë‹«ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ClassToolsModal = ({ isOpen, onClose, students }) => {
            const [activeTab, setActiveTab] = useState('picker');
            const [pickedStudent, setPickedStudent] = useState(null);
            const [isPicking, setIsPicking] = useState(false);
            const [timerTime, setTimerTime] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => {
                if (isTimerRunning && timerTime > 0) {
                    timerRef.current = setInterval(() => setTimerTime(t => t - 1), 1000);
                } else {
                    clearInterval(timerRef.current);
                    if (timerTime === 0 && isTimerRunning) {
                        setIsTimerRunning(false);
                        confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#ef4444', '#f87171'] });
                    }
                }
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning, timerTime]);

            const handlePick = () => {
                if (students.length === 0) return;
                setIsPicking(true);
                let count = 0;
                const interval = setInterval(() => {
                    setPickedStudent(students[Math.floor(Math.random() * students.length)]);
                    count++;
                    if (count > 20) {
                        clearInterval(interval);
                        setIsPicking(false);
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                }, 100);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (s % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ§° í•™ê¸‰ ë„êµ¬ ìƒì" icon={PATHS.settings} maxWidth="max-w-md">
                    <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                        <button onClick={() => setActiveTab('picker')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'picker' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ğŸ² ë°œí‘œì ë½‘ê¸°</button>
                        <button onClick={() => setActiveTab('timer')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'timer' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>â±ï¸ íƒ€ì´ë¨¸</button>
                    </div>

                    {activeTab === 'picker' && (
                        <div className="flex flex-col items-center py-4 space-y-6">
                            <div className="text-4xl font-bold text-slate-800 h-20 flex items-center justify-center">{pickedStudent ? pickedStudent.name : <span className="text-slate-300 text-6xl">?</span>}</div>
                            <Btn onClick={handlePick} disabled={isPicking} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                {isPicking ? 'ë‘êµ¬ë‘êµ¬...' : 'ë°œí‘œì ë½‘ê¸°!'}
                            </Btn>
                        </div>
                    )}

                    {activeTab === 'timer' && (
                        <div className="flex flex-col items-center py-2 space-y-6">
                            <div className={`text-7xl font-mono font-bold tabular-nums tracking-wider ${timerTime <= 10 && timerTime > 0 && isTimerRunning ? 'text-rose-500 animate-pulse' : 'text-slate-800'}`}>{formatTime(timerTime)}</div>
                            <div className="grid grid-cols-4 gap-2 w-full">
                                {[10, 60, 180, 300].map(sec => (
                                    <Btn key={sec} onClick={() => setTimerTime(t => t + sec)} className="py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200">+{sec < 60 ? sec + 'ì´ˆ' : sec / 60 + 'ë¶„'}</Btn>
                                ))}
                            </div>
                            <div className="flex gap-3 w-full">
                                <Btn onClick={() => { setIsTimerRunning(false); setTimerTime(0); }} className="flex-1 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ì´ˆê¸°í™”</Btn>
                                <Btn onClick={() => setIsTimerRunning(!isTimerRunning)} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md ${isTimerRunning ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'}`}>{isTimerRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}</Btn>
                            </div>
                        </div>
                    )}
                </BaseModal>
            );
        };

        const InstallGuideModal = ({ isOpen, onClose, onInstall, isIOS }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ“² ì•± ì„¤ì¹˜ ì•ˆë‚´" icon={PATHS.download} maxWidth="max-w-md">
                    <div className="space-y-6 text-center">
                        <div className="w-20 h-20 bg-indigo-100 rounded-3xl mx-auto flex items-center justify-center shadow-inner">
                            <span className="text-4xl">ğŸ“±</span>
                        </div>
                        <div className="space-y-2">
                            <h3 className="text-xl font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€í•´ë³´ì„¸ìš”!</h3>
                            <p className="text-sm text-slate-500 leading-relaxed">
                                ì•±ì„ ì„¤ì¹˜í•˜ë©´ ë” í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-left">
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">âš¡ï¸ ë¹ ë¥¸ ì‹¤í–‰</div><div className="text-xs text-slate-500">í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì ‘ì†í•˜ì„¸ìš”.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ–¥ï¸ ë„“ì€ í™”ë©´</div><div className="text-xs text-slate-500">ì£¼ì†Œì°½ ì—†ì´ ë„“ê²Œ ë´…ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ’¾ ì˜¤í”„ë¼ì¸</div><div className="text-xs text-slate-500">ì¸í„°ë„· ì—†ì´ë„ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div></div>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="font-bold text-slate-700 text-sm mb-1">ğŸ”„ ìë™ ì—…ë°ì´íŠ¸</div><div className="text-xs text-slate-500">í•­ìƒ ìµœì‹  ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.</div></div>
                        </div>
                        
                        {isIOS ? (
                            <div className="bg-slate-100 p-4 rounded-xl text-left text-sm space-y-2 animate-fade-in">
                                <p className="font-bold text-slate-700 flex items-center gap-2">ğŸ ì•„ì´í°/ì•„ì´íŒ¨ë“œ ì„¤ì¹˜ ë°©ë²•</p>
                                <ol className="list-decimal pl-5 space-y-1 text-slate-600 text-xs">
                                    <li>ì‚¬íŒŒë¦¬(Safari) í•˜ë‹¨ì˜ <span className="font-bold text-blue-500">ê³µìœ (Share)</span> ë²„íŠ¼ í„°ì¹˜</li>
                                    <li>ë©”ë‰´ì—ì„œ <span className="font-bold text-slate-800">í™ˆ í™”ë©´ì— ì¶”ê°€</span> ì„ íƒ</li>
                                    <li>ìš°ì¸¡ ìƒë‹¨ì˜ <span className="font-bold text-blue-500">ì¶”ê°€</span> ë²„íŠ¼ í„°ì¹˜</li>
                                </ol>
                            </div>
                        ) : (
                            <Btn onClick={onInstall} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                                <Icon d={PATHS.download} /> ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°
                            </Btn>
                        )}
                    </div>
                </BaseModal>
            );
        };

        const DataCleanupModal = ({ isOpen, onClose, groupsByDate, records, setGroupsByDate, setRecords, saveData, isLocalMode, showToast, onBackup }) => {
            const [targetDate, setTargetDate] = useState(dayjs().subtract(1, 'year').format('YYYY-MM-DD'));
            
            const cleanupStats = useMemo(() => {
                let groupCount = 0;
                let recordCount = 0;
                
                Object.keys(groupsByDate).forEach(date => { if (date < targetDate) groupCount++; });
                Object.keys(records).forEach(date => { if (date < targetDate) recordCount++; });
                
                return { groupCount, recordCount };
            }, [groupsByDate, records, targetDate]);

            const handleCleanup = () => {
                if (cleanupStats.groupCount === 0 && cleanupStats.recordCount === 0) { showToast("ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                if (!confirm(`${targetDate} ì´ì „ì˜ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ëª¨ë‘  ê¸°ë¡: ${cleanupStats.groupCount}ê±´\n- í™œë™ ê¸°ë¡: ${cleanupStats.recordCount}ê±´\n\n(ì•ˆì „ì„ ìœ„í•´ í˜„ì¬ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤)`)) return;

                // ìë™ ë°±ì—… ì‹¤í–‰
                if (onBackup) onBackup();

                const newGroups = { ...groupsByDate };
                const newRecords = { ...records };
                const deletedGroupDates = [];
                const deletedRecordDates = [];
                Object.keys(newGroups).forEach(date => { if (date < targetDate) { delete newGroups[date]; deletedGroupDates.push(date); } });
                Object.keys(newRecords).forEach(date => { if (date < targetDate) { delete newRecords[date]; deletedRecordDates.push(date); } });

                setGroupsByDate(newGroups);
                setRecords(newRecords);
                
                if (!isLocalMode) {
                    // saveData({ cls_records: newRecords }); // [Fix] recordsëŠ” ë³„ë„ í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë¨ (ì‚­ì œëŠ” deleteRecordsFromFirestore ì‚¬ìš©)
                    // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ë¬¸ì„œ ì‚­ì œ
                    if (deletedGroupDates.length > 0) deleteGroupsFromFirestore(deletedGroupDates);
                    if (deletedRecordDates.length > 0) deleteRecordsFromFirestore(deletedRecordDates);
                }
                else { localStorage.setItem('cls_groups_date', JSON.stringify(newGroups)); localStorage.setItem('cls_records', JSON.stringify(newRecords)); }
                
                showToast("ë°ì´í„° ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                onClose();
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ§¹ ë°ì´í„° ì •ë¦¬ ë„êµ¬" icon={PATHS.trash}>
                    <div className="space-y-4">
                        <div className="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm text-orange-800"><p className="font-bold mb-1">âš ï¸ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬</p><p className="text-xs opacity-80">ì €ì¥ ìš©ëŸ‰ í™•ë³´ë¥¼ ìœ„í•´ ì˜¤ë˜ëœ ê¸°ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤.<br/>ì‚­ì œ ê¸°ì¤€ì¼ ì´ì „ì˜ ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.</p></div>
                        <div className="flex flex-col gap-2"><label className="text-xs font-bold text-slate-500">ì‚­ì œ ê¸°ì¤€ì¼ (ì´ ë‚ ì§œ ì´ì „ ë°ì´í„° ì‚­ì œ)</label><input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full p-3 border rounded-xl text-sm outline-none focus:border-orange-500" /><div className="flex justify-end gap-2 mt-1"><button onClick={() => setTargetDate(dayjs().subtract(6, 'month').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">6ê°œì›” ì „</button><button onClick={() => setTargetDate(dayjs().subtract(1, 'year').format('YYYY-MM-DD'))} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 hover:bg-slate-200">1ë…„ ì „</button></div></div>
                        <div className="bg-white border border-slate-200 rounded-xl p-4 space-y-2">
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ëª¨ë‘  ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.groupCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  í™œë™ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.recordCount}ê±´</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-600">ì‚­ì œë  ê³¼ì œ ê¸°ë¡</span><span className="font-bold text-rose-500">{cleanupStats.taskCount}ê±´</span></div>
                        </div>
                        <Btn onClick={handleCleanup} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md flex items-center justify-center gap-2"><Icon d={PATHS.trash} /> ì •ë¦¬ ì‹œì‘í•˜ê¸°</Btn>
                    </div>
                </BaseModal>
            );
        };

        const ResetOptionsModal = ({ isOpen, onClose, onReset }) => {
            const [selected, setSelected] = useState({
                students: true, records: true, groups: true, tasks: true, seats: true, roles: true
            });
            
            const options = [
                { id: 'students', label: 'í•™ìƒ ëª…ë‹¨', desc: 'ì´ë¦„, ì„±ë³„, ì‹¤ë ¥ ë“±' },
                { id: 'records', label: 'í™œë™ ê¸°ë¡', desc: 'ì²´í¬ë¦¬ìŠ¤íŠ¸, ìƒë‹´, ìŠ¤í‹°ì»¤' },
                { id: 'groups', label: 'ëª¨ë‘  ê¸°ë¡', desc: 'í¸ì„± ì´ë ¥, ê¸°í”¼ ê´€ê³„' },
                { id: 'tasks', label: 'ê³¼ì œ ì„¤ì •', desc: 'ì˜¤ëŠ˜/ìš”ì¼ë³„ ê³¼ì œ, íƒœê·¸' },
                { id: 'seats', label: 'ìë¦¬ ë°°ì¹˜', desc: 'í˜„ì¬ ë°°ì¹˜, ì±…ìƒ êµ¬ì¡°' },
                { id: 'roles', label: 'ì—­í•  ì„¤ì •', desc: 'ì—­í•  ëª©ë¡, ì„¤ëª…' },
            ];

            const toggleAll = () => {
                const allSelected = Object.values(selected).every(v => v);
                const newVal = !allSelected;
                const newSelected = {};
                options.forEach(o => newSelected[o.id] = newVal);
                setSelected(newSelected);
            };

            const handleReset = () => {
                const items = Object.keys(selected).filter(k => selected[k]);
                if (items.length === 0) return;
                onReset(items);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”" icon={PATHS.trash} maxWidth="max-w-md">
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">âš ï¸ ì£¼ì˜: ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">ì´ˆê¸°í™”í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div className="flex justify-end">
                            <button onClick={toggleAll} className="text-xs font-bold text-slate-500 hover:text-indigo-600 transition-colors">
                                {Object.values(selected).every(v => v) ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}
                            </button>
                        </div>

                        <div className="space-y-2">
                            {options.map(opt => (
                                <label key={opt.id} className={`flex items-center p-3 rounded-xl border cursor-pointer transition-all ${selected[opt.id] ? 'bg-rose-50 border-rose-200' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                    <input type="checkbox" checked={selected[opt.id]} onChange={() => setSelected(prev => ({ ...prev, [opt.id]: !prev[opt.id] }))} className="w-4 h-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500" />
                                    <div className="ml-3 flex-1">
                                        <div className={`text-sm font-bold ${selected[opt.id] ? 'text-rose-700' : 'text-slate-700'}`}>{opt.label}</div>
                                        <div className="text-xs text-slate-400">{opt.desc}</div>
                                    </div>
                                </label>
                            ))}
                        </div>

                        <div className="flex gap-2 mt-4">
                            <Btn onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                            <Btn onClick={handleReset} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md">
                                ì„ íƒ í•­ëª© ì‚­ì œ
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSafetyHelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="AI ë°ì´í„° ë³´ì•ˆ ëª¨ë“œë€?" icon={PATHS.help}>
                    <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                        <p>í•™ìƒë“¤ì˜ ì†Œì¤‘í•œ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´, AIì—ê²Œ ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ì „ <strong>ì´ë¦„ì„ ìë™ìœ¼ë¡œ ê°€ëª… ì²˜ë¦¬(ë§ˆìŠ¤í‚¹)</strong>í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                        
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 className="font-bold text-slate-700 mb-2">ğŸ‘€ ì‘ë™ ì˜ˆì‹œ</h4>
                            <div className="space-y-3">
                                <div>
                                    <div className="text-xs font-bold text-rose-500 mb-1">ì›ë³¸ ë°ì´í„° (ì„ ìƒë‹˜ í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-rose-100 text-xs text-slate-500">
                                        "<strong>ê¹€ì² ìˆ˜</strong> í•™ìƒì€ <strong>ì´ì˜í¬</strong> í•™ìƒê³¼ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                                <div className="flex justify-center"><Icon d={PATHS.down} size={16} className="text-slate-300"/></div>
                                <div>
                                    <div className="text-xs font-bold text-indigo-600 mb-1">ì „ì†¡ ë°ì´í„° (AIê°€ ë³´ëŠ” í™”ë©´)</div>
                                    <div className="bg-white p-2 rounded border border-indigo-100 text-xs text-slate-500">
                                        "<strong>[STUDENT_TOKEN]</strong> í•™ìƒì€ <strong>ê¸‰ìš°</strong>ì™€ ë‹¤íˆ¬ì—ˆìœ¼ë‚˜..."
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-indigo-800 text-xs">
                            <p className="font-bold mb-1">âœ¨ ê¸°ëŠ¥ì´ ì¼œì ¸ ìˆìœ¼ë©´?</p>
                            <p>AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ <strong>ì „ì†¡ ì „ í™•ì¸ ì°½</strong>ì´ ëœ¹ë‹ˆë‹¤. ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³€í™˜ë˜ì—ˆëŠ”ì§€ ëˆˆìœ¼ë¡œ ì§ì ‘ í™•ì¸í•˜ê³  ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const AiSecurityCheckModal = ({ isOpen, onClose, prompt, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ”’ AI ì „ì†¡ ë°ì´í„° ë³´ì•ˆ í™•ì¸" icon={PATHS.lock} zIndex="z-[3000]">
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800">
                            <p className="font-bold mb-1">ğŸ›¡ï¸ ê°œì¸ì •ë³´ ë³´í˜¸ í•„í„° ì‘ë™ ì¤‘</p>
                            <p className="text-xs opacity-80">AIì—ê²Œ ì „ì†¡ë˜ê¸° ì§ì „ì˜ ë°ì´í„°ì…ë‹ˆë‹¤.<br/>í•™ìƒ ì´ë¦„ì´ <strong>[STUDENT_TOKEN]</strong> ë˜ëŠ” <strong>ê¸‰ìš°</strong>ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-[40vh] overflow-y-auto custom-scroll">
                            <p className="text-xs text-slate-600 whitespace-pre-wrap font-mono leading-relaxed">{prompt}</p>
                        </div>
                        <div className="flex justify-end gap-2">
                            <Btn onClick={onClose} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì „ì†¡ ì·¨ì†Œ</Btn>
                            <Btn onClick={onConfirm} className="px-4 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md flex items-center gap-2">
                                <Icon d={PATHS.send} size={16} /> ì „ì†¡í•˜ê¸°
                            </Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, students, setStudents, appConfig, setAppConfig, isLocalMode, saveData, showToast, openConfirm, handleResetAllData, onOpenSetup, onOpenNotionSetup, onOpenGoogleSheetSetup, onOpenApiKeySetup, records, groupsByDate, avoidancePairs, dailyTasks, weeklyTasks, tags, setRecords, setGroupsByDate, setAvoidancePairs, setDailyTasks, setWeeklyTasks, setTags, backupTimes, setBackupTimes, apiKey, setApiKey, mustPairs, setMustPairs, groupNames, setGroupNames, groupRoles, setGroupRoles, rolesList, setRolesList, roleDescriptions, setRoleDescriptions, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, db, appId, deferredPrompt, isIOS, isStandalone, onInstallApp, isDevMode, onDevModeClick, deleteTasksFromFirestore, onTestUpdate }) => {
            const [name, setName] = useState("");
            const [gender, setGender] = useState("M"); const [skill, setSkill] = useState(2); const [note, setNote] = useState(""); const [isLeader, setIsLeader] = useState(false);
            const fileRef = useRef(null); const jsonFileRef = useRef(null); const runnerImgRef = useRef(null); const cloudIconRef = useRef(null); const faviconRef = useRef(null);
            const [deleteTargetId, setDeleteTargetId] = useState(null); const [isDeletingAll, setIsDeletingAll] = useState(false); const [editingId, setEditingId] = useState(null); const [editData, setEditData] = useState({});
            const [isDeleteLocked, setIsDeleteLocked] = useState(true);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(() => localStorage.getItem('cls_auto_backup') === 'true'); const [showBackupHelp, setShowBackupHelp] = useState(false); const [isAdminMode, setIsAdminMode] = useState(false);
            const [adminClickCount, setAdminClickCount] = useState(0); const [ampm, setAmpm] = useState("PM"); const [hour, setHour] = useState("12"); const [minute, setMinute] = useState("00");
            const [newVacStart, setNewVacStart] = useState(""); const [newVacEnd, setNewVacEnd] = useState("");
            const [showFontList, setShowFontList] = useState(false);
            
            // ì½”ë“œ ì—…ë°ì´íŠ¸ ê´€ë ¨ ìƒíƒœ
            const [showCodeUpdater, setShowCodeUpdater] = useState(false);
            const [updateCodeInput, setUpdateCodeInput] = useState("");
            const [isUpdating, setIsUpdating] = useState(false);
            const [updateProgress, setUpdateProgress] = useState(0);
            const [updateStatus, setUpdateStatus] = useState("");
            const [remainingTime, setRemainingTime] = useState(3);
            const [aiUsage, setAiUsage] = useState(0);
            const [showManualModal, setShowManualModal] = useState(false);
            const [showStorageHelp, setShowStorageHelp] = useState(false);
            const [showCleanupModal, setShowCleanupModal] = useState(false);
            const [isDataManagementOpen, setIsDataManagementOpen] = useState(true);
            const [showFaviconHelp, setShowFaviconHelp] = useState(false);
            const [showResetOptions, setShowResetOptions] = useState(false);
            const [isStudentListOpen, setIsStudentListOpen] = useState(true);
            const [activeTab, setActiveTab] = useState('app');
            const prevTabRef = useRef(activeTab);
            const isGoogleSheetConnected = !!localStorage.getItem('cls_google_sheet_url');
            const [aiSafetyCheck, setAiSafetyCheck] = useState(() => localStorage.getItem('cls_ai_safety_check') === 'true');
            const [showAiSafetyHelp, setShowAiSafetyHelp] = useState(false);
            const [testAllSuccess, setTestAllSuccess] = useState(false);
            const [isTestingAll, setIsTestingAll] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState({
                ai: { status: 'idle', message: '' },
                notion_record: { status: 'idle', message: '' },
                notion_portfolio: { status: 'idle', message: '' },
                google: { status: 'idle', message: '' }
            });

            const handleTestAllConnections = async () => {
                const notionKey = localStorage.getItem('cls_notion_key');
                const notionDbId = localStorage.getItem('cls_notion_db_id');
                const notionPortId = localStorage.getItem('cls_notion_portfolio_db_id');
                const googleSheetUrl = localStorage.getItem('cls_google_sheet_url');
                const aiKey = localStorage.getItem('cls_ai_key');
                
                const tests = [];
                if (aiKey) tests.push({ type: 'ai', name: 'AI (Gemini)', key: aiKey, id: 'ai' });
                if (notionKey && notionDbId) tests.push({ type: 'notion', name: 'ë…¸ì…˜(ê¸°ë¡)', id: notionDbId, mode: 'normal' });
                if (notionKey && notionPortId) tests.push({ type: 'notion', name: 'ë…¸ì…˜(í¬í´)', id: 'notion_portfolio', key: notionKey, dbId: notionPortId, mode: 'relation' });
                if (googleSheetUrl) tests.push({ type: 'google', name: 'êµ¬ê¸€ì‹œíŠ¸', id: 'google', url: googleSheetUrl });

                if (tests.length === 0) return showToast("ì €ì¥ëœ ì—°ë™ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                setIsTestingAll(true);
                setConnectionStatus(prev => {
                    const next = { ...prev };
                    tests.forEach(t => next[t.id] = { status: 'pending', message: 'í…ŒìŠ¤íŠ¸ ì¤‘...' });
                    return next;
                });

                let hasSuccess = false;

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    let success = false;
                    let errorMsg = '';

                    try {
                        if (test.type === 'ai') {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${test.key}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                            });
                            if (response.ok) success = true;
                            else {
                                const data = await response.json();
                                errorMsg = data.error?.message || "API í˜¸ì¶œ ì‹¤íŒ¨";
                            }
                        } else if (test.type === 'notion') {
                            const cleanKey = test.key.replace(/["']/g, '').trim();
                            const cleanDbId = test.dbId.replace(/["']/g, '').trim();
                            const res = await fetch('/api/save-notion', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ personalKey: cleanKey, personalDbId: cleanDbId, testMode: true, mode: test.mode })
                            });
                            const data = await res.json();
                            if (res.ok) success = true;
                            else errorMsg = data.error || "ì—°ë™ ì‹¤íŒ¨";
                        } else if (test.type === 'google') {
                            const cleanUrl = test.url.trim().replace(/^"|'|"$|'$/g, '');
                            await fetch(cleanUrl, {
                                method: "POST",
                                mode: 'no-cors',
                                headers: { "Content-Type": "text/plain;charset=utf-8" },
                                body: JSON.stringify({ date: dayjs().format('YYYY-MM-DD HH:mm:ss'), name: "í…ŒìŠ¤íŠ¸", category: "ì—°ë™ í…ŒìŠ¤íŠ¸", content: "ì „ì²´ ì—°ë™ í…ŒìŠ¤íŠ¸" })
                            });
                            success = true;
                        }
                    } catch (e) {
                        success = false;
                        errorMsg = e.message;
                    }

                    setConnectionStatus(prev => ({
                        ...prev,
                        [test.id]: { status: success ? 'success' : 'error', message: success ? 'ì—°ë™ ì„±ê³µ' : errorMsg }
                    }));
                    if (success) hasSuccess = true;
                }

                setIsTestingAll(false);
                if (hasSuccess) {
                    setTestAllSuccess(true);
                    setTimeout(() => setTestAllSuccess(false), 3000);
                }
            };

            const toggleAiSafetyCheck = () => {
                const newVal = !aiSafetyCheck;
                setAiSafetyCheck(newVal);
                localStorage.setItem('cls_ai_safety_check', newVal);
                showToast(newVal ? "AI ì „ì†¡ ì‹œ ë³´ì•ˆ í™•ì¸ ì°½ì´ í‘œì‹œë©ë‹ˆë‹¤." : "AI ì „ì†¡ ë³´ì•ˆ í™•ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getTabAnimationClass = () => {
                if (appConfig.tabAnimationEnabled === false) return '';
                const tabs = ['student', 'app', 'data'];
                const prevIdx = tabs.indexOf(prevTabRef.current);
                const currIdx = tabs.indexOf(activeTab);
                if (prevIdx === -1 || currIdx === -1 || prevIdx === currIdx) return 'animate-fade-in';
                return currIdx > prevIdx ? 'animate-slide-in-right' : 'animate-slide-in-left';
            };
            useEffect(() => { prevTabRef.current = activeTab; }, [activeTab]);
            
            const isNotionConnected = !!(localStorage.getItem('cls_notion_key') && localStorage.getItem('cls_notion_db_id'));
            const isAiConnected = !!apiKey;

            const dataUsage = useMemo(() => {
                const rawDetails = [
                    { label: 'í•™ìƒ ëª…ë‹¨', val: students, color: '#6366f1' }, // Indigo
                    { label: 'í™œë™ ê¸°ë¡', val: records, color: '#ec4899' }, // Pink
                    { label: 'ëª¨ë‘  ê¸°ë¡', val: groupsByDate, color: '#8b5cf6' }, // Violet
                    { label: 'ê³¼ì œ ëª©ë¡', val: dailyTasks, color: '#3b82f6' }, // Blue
                    { label: 'ëª¨ë‘  ì´ë¦„', val: groupNames, color: '#10b981' }, // Emerald
                    { label: 'ëª¨ë‘  ì—­í• ', val: groupRoles, color: '#f59e0b' }, // Amber
                    { label: 'ìë¦¬ ë°°ì¹˜', val: seatAssignments, color: '#f97316' }, // Orange
                    { label: 'ê´€ê³„ ì„¤ì •', val: { avoidancePairs, mustPairs }, color: '#ef4444' }, // Red
                    { label: 'ì£¼ê°„/íƒœê·¸', val: { weeklyTasks, tags }, color: '#14b8a6' }, // Teal
                    { label: 'ì•± ì„¤ì •', val: appConfig, color: '#64748b' }, // Slate
                    { label: 'ê¸°íƒ€', val: { rolesList, roleDescriptions, seatConfig }, color: '#94a3b8' } // Slate-400
                ];

                const totalBytes = new Blob([JSON.stringify({
                    students, records, groupsByDate, avoidancePairs, mustPairs, 
                    dailyTasks, weeklyTasks, tags, appConfig, groupNames, 
                    groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig
                })]).size;

                // [Mod] ë¡œì»¬ ëª¨ë“œ: 5MB, í´ë¼ìš°ë“œ ëª¨ë“œ: 1MB ê¸°ì¤€
                const MAX_SIZE = isLocalMode ? 5242880 : 1048576; 
                const kb = (totalBytes / 1024).toFixed(1);
                const percent = ((totalBytes / MAX_SIZE) * 100).toFixed(1);
                
                // ìƒì„¸ ë¶„ì„ ì¶”ê°€
                const details = rawDetails.map(item => {
                    const itemBytes = new Blob([JSON.stringify(item.val)]).size;
                    return {
                        ...item,
                        bytes: itemBytes,
                        kb: (itemBytes / 1024).toFixed(1),
                        percent: totalBytes > 0 ? ((itemBytes / totalBytes) * 100) : 0
                    };
                }).sort((a, b) => b.bytes - a.bytes);

                return { kb, percent, bytes: totalBytes, isWarning: percent > 80, isCritical: percent > 95, details };
            }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig, isLocalMode]);

            const updateAppConfig = (updates) => {
                const newConfig = { ...appConfig, ...updates };
                setAppConfig(newConfig);
                saveData('cls_app_config', newConfig);
            };

            useEffect(() => { 
                if (isOpen) { 
                    setAiUsage(parseInt(localStorage.getItem('cls_ai_usage') || '0'));
                    setNewVacStart("");
                    setNewVacEnd("");
                } 
            }, [isOpen]);

            const currentVacations = useMemo(() => {
                if (appConfig.vacations && appConfig.vacations.length > 0) return appConfig.vacations;
                if (appConfig.vacationStart && appConfig.vacationEnd) return [{ start: appConfig.vacationStart, end: appConfig.vacationEnd }];
                return [];
            }, [appConfig.vacations, appConfig.vacationStart, appConfig.vacationEnd]);

            const addVacation = () => {
                if (newVacStart && newVacEnd) {
                    if (newVacStart > newVacEnd) return showToast("ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    const newVacations = [...currentVacations, { start: newVacStart, end: newVacEnd }].sort((a, b) => a.start.localeCompare(b.start));
                    updateAppConfig({ vacations: newVacations });
                    setNewVacStart(""); setNewVacEnd("");
                } else { showToast("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); }
            };
            const removeVacation = (index) => { 
                const newVacations = currentVacations.filter((_, i) => i !== index);
                updateAppConfig({ vacations: newVacations });
            };

            const toggleAutoBackup = () => { const newValue = !autoBackupEnabled; setAutoBackupEnabled(newValue); localStorage.setItem('cls_auto_backup', newValue);
            showToast(newValue ? "ìë™ ë°±ì—…ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ìë™ ë°±ì—…ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤."); };
            
            const addBackupTime = () => { let h = parseInt(hour);
            if (ampm === "PM" && h !== 12) h += 12;
            if (ampm === "AM" && h === 12) h = 0; const timeStr = `${String(h).padStart(2, '0')}:${minute}`;
            if (!backupTimes.includes(timeStr) && backupTimes.length < 4) { const newTimes = [...backupTimes, timeStr].sort(); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes));
            } else if (backupTimes.includes(timeStr)) { showToast("ì´ë¯¸ ì„¤ì •ëœ ì‹œê°„ì…ë‹ˆë‹¤."); } else if (backupTimes.length >= 4) { showToast("ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            } };
            const removeBackupTime = (time) => { const newTimes = backupTimes.filter(t => t !== time); setBackupTimes(newTimes); localStorage.setItem('cls_backup_times', JSON.stringify(newTimes)); };
            
            // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
            const handleDataManagementClick = () => { 
                const newCount = adminClickCount + 1; 
                if(newCount >= 3) { 
                    setIsAdminMode(!isAdminMode);
                    showToast(!isAdminMode ? "ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤." : "ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    setAdminClickCount(0);
                } else {
                    setAdminClickCount(newCount);
                }
            };

            const addTestData = () => { 
                const testData = [
                    { name: "ìœ ì¬ì„", gender: "M" }, { name: "ì•„ì´ìœ ", gender: "F" }, { name: "ë°•ë³´ê²€", gender: "M" }, 
                    { name: "ê¹€ì—°ì•„", gender: "F" }, { name: "ì†í¥ë¯¼", gender: "M" }, { name: "ë´‰ì¤€í˜¸", gender: "M" }, 
                    { name: "ê¹€íƒœë¦¬", gender: "F" }, { name: "ê³µìœ ", gender: "M" }, { name: "ì†¡í˜œêµ", gender: "F" }, 
                    { name: "í˜„ë¹ˆ", gender: "M" }, { name: "ì†ì˜ˆì§„", gender: "F" }, { name: "ì´ì •ì¬", gender: "M" }, 
                    { name: "ì „ì§€í˜„", gender: "F" }, { name: "ë§ˆë™ì„", gender: "M" }, { name: "ê¹€í˜œìˆ˜", gender: "F" }
                ];
                const newStudents = testData.map((d, i) => ({ id: Date.now() + i, name: d.name, order: students.length + i + 1, gender: d.gender, skill: (i % 3) + 1, note: "í…ŒìŠ¤íŠ¸ í•™ìƒ", leader: i % 5 === 0 }));
                const updatedStudents = [...students, ...newStudents]; 
                setStudents(updatedStudents); 
                if(!isLocalMode) saveData('cls_students', updatedStudents); 
                showToast("í…ŒìŠ¤íŠ¸ í•™ìƒ 15ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100); 
            };
            const addStudent = () => { if (name) { const updated = [...students, { id: Date.now(), name, order: students.length + 1, gender, skill, note, leader: isLeader }];
            setStudents(updated); if(!isLocalMode) saveData('cls_students', updated); setName(""); setNote(""); setIsLeader(false); setTimeout(() => { const list = document.getElementById('student-list'); if (list) list.scrollTop = list.scrollHeight; }, 100);
            } };
            const deleteStudent = (id) => { const n = students.filter(s => s.id !== id); setStudents(n); if(!isLocalMode) saveData('cls_students', n);
            };
            const startEdit = (student) => { setEditingId(student.id); setEditData({...student}); };
            const cancelEdit = () => { setEditingId(null); setEditData({}); };
            const saveEdit = () => { const updatedStudents = students.map(s => s.id === editingId ? editData : s); setStudents(updatedStudents);
            if(!isLocalMode) saveData('cls_students', updatedStudents); setEditingId(null); setEditData({}); showToast("í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); };
            const handleFileUpload = (e) => { const f = e.target.files[0];
            if (!f) return; const r = new FileReader(); r.onload = (ev) => { const lines = ev.target.result.split(/[\r\n]+/).filter(l => l.trim());
            const newStds = []; lines.forEach((l, i) => { const p = l.split(','); if (p[0]) newStds.push({ id: Date.now() + i, name: p[0].trim(), gender: (p[1] || 'M').trim(), skill: parseInt(p[2] || 2), note: (p[3] || "").trim(), order: students.length + i + 1, leader: false }); });
            if (newStds.length) { const u = [...students, ...newStds]; setStudents(u); if(!isLocalMode) saveData('cls_students', u); showToast(`${newStds.length}ëª… ì¶”ê°€ë¨`); } }; r.readAsText(f); };
            const handleDeleteAll = () => { setStudents([]); if(!isLocalMode) saveData('cls_students', []); setIsDeletingAll(false); setIsDeleteLocked(true); showToast("ì „ì²´ ì‚­ì œë¨"); };
            const getCleanHtmlCode = () => { const docClone = document.documentElement.cloneNode(true); const root = docClone.querySelector('#root'); if (root) root.innerHTML = '';
            const scripts = docClone.querySelectorAll('script'); scripts.forEach(s => { if (!s.hasAttribute('data-app-script')) s.remove(); }); const styles = docClone.querySelectorAll('style');
            styles.forEach(s => { if (!s.hasAttribute('data-app-style')) s.remove(); }); return "<!DOCTYPE html>\n" + docClone.outerHTML; };
            const handleDownloadHtml = () => { const html = getCleanHtmlCode(); const blob = new Blob([html], {type: "text/html"});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Checklist_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.html`; link.click(); };
            const handleCopyCode = () => { const htmlContent = getCleanHtmlCode(); const textarea = document.createElement("textarea"); textarea.value = htmlContent; document.body.appendChild(textarea); textarea.select();
            try { const successful = document.execCommand('copy'); if (successful) showToast("ì „ì²´ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); else showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } catch (err) { showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } finally { document.body.removeChild(textarea); } };
            
            const handleExportJson = async () => { 
                let exportStudents = [...students];
                let exportRecords = { ...records };
                let exportGroups = { ...groupsByDate };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì¼ ê²½ìš° ë¶„ì‚° ì €ì¥ëœ ëª¨ë“  ë°ì´í„°(í•™ìƒìƒì„¸, ê¸°ë¡, ëª¨ë‘ )ë¥¼ ê°€ì ¸ì™€ì„œ ë³‘í•©
                if (!isLocalMode && db && appId) {
                    showToast("í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
                    try {
                        // 1. í•™ìƒ ê°œë³„ ë°ì´í„° (ìƒë‹´, ì´ˆì•ˆ)
                        const studentSnapshot = await db.collection('classes').doc(appId).collection('studentData').get();
                        const studentDataMap = {};
                        studentSnapshot.forEach(doc => { studentDataMap[doc.id] = doc.data(); });
                        
                        exportStudents = exportStudents.map(s => {
                            const extra = studentDataMap[String(s.id)];
                            return extra ? { ...s, ...extra } : s;
                        });

                        // 2. í™œë™ ê¸°ë¡ (Records)
                        const recordSnapshot = await db.collection('classes').doc(appId).collection('records').get();
                        recordSnapshot.forEach(doc => { 
                            exportRecords[doc.id] = doc.data(); 
                        });

                        // 3. ëª¨ë‘  ê¸°ë¡ (GroupResults)
                        const groupSnapshot = await db.collection('classes').doc(appId).collection('groupResults').get();
                        groupSnapshot.forEach(doc => { 
                            const data = doc.data();
                            exportGroups[doc.id] = data.list || data; 
                        });
                        
                        // 4. ê³¼ì œ ë°ì´í„° (Tasks)
                        const taskSnapshot = await db.collection('classes').doc(appId).collection('tasks').get();
                        taskSnapshot.forEach(doc => {
                            if (doc.id === 'settings') {
                                // settingsëŠ” ë³„ë„ ì²˜ë¦¬ ì•ˆí•¨ (stateì— ì´ë¯¸ ìˆìŒ)
                            } else {
                                // exportDailyTasks[doc.id] = doc.data().list; // dailyTasks stateì— ì´ë¯¸ ë³‘í•©ë˜ì–´ ìˆìŒ
                            }
                        });

                    } catch (e) {
                        console.error("Export fetch error:", e);
                        showToast("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ë°ì´í„°ê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    }
                }

                const data = { 
                    version: appConfig.version, 
                    date: dayjs().format('YYYY-MM-DD HH:mm:ss'), 
                    students: exportStudents, 
                    records: exportRecords, 
                    groupsByDate: exportGroups, 
                    avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig 
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url;
                link.download = `Checklist_Data_${appConfig.className ? appConfig.className + '_' : ''}${appConfig.version}_${dayjs().format('YYYYMMDD')}.json`; link.click(); showToast("ë°ì´í„°ê°€ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤."); 
            };
            
            const handleImportJson = (e) => { const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if(data.students) { setStudents(data.students);
            if(!isLocalMode) saveData('cls_students', data.students); } if(data.records) { setRecords(data.records); if(!isLocalMode) saveData('cls_records', data.records); } if(data.groupsByDate) { setGroupsByDate(data.groupsByDate); if(!isLocalMode) saveData('cls_groups_date', data.groupsByDate);
            } if(data.avoidancePairs) { setAvoidancePairs(data.avoidancePairs); if(!isLocalMode) saveData('cls_avoidance', data.avoidancePairs); } if(data.dailyTasks) { setDailyTasks(data.dailyTasks); if(!isLocalMode) saveData('cls_daily_tasks', data.dailyTasks); } if(data.weeklyTasks) { setWeeklyTasks(data.weeklyTasks);
            if(!isLocalMode) saveData('cls_weekly_tasks', data.weeklyTasks); } if(data.tags) { setTags(data.tags); if(!isLocalMode) saveData('cls_tags', data.tags); } 
            if(data.mustPairs) { setMustPairs(data.mustPairs); if(!isLocalMode) saveData('cls_mustPairs', data.mustPairs); }
            if(data.groupNames) { setGroupNames(data.groupNames); if(!isLocalMode) saveData('cls_group_names', data.groupNames); }
            if(data.groupRoles) { setGroupRoles(data.groupRoles); if(!isLocalMode) saveData('cls_group_roles', data.groupRoles); }
            if(data.rolesList) { setRolesList(data.rolesList); if(!isLocalMode) saveData('cls_roles_list', data.rolesList); }
            if(data.roleDescriptions) { setRoleDescriptions(data.roleDescriptions); if(!isLocalMode) saveData('cls_role_descriptions', data.roleDescriptions); }
            if(data.seatAssignments) { setSeatAssignments(data.seatAssignments); if(!isLocalMode) saveData('cls_seat_assignments', data.seatAssignments); }
            if(data.seatConfig) { setSeatConfig(data.seatConfig); if(!isLocalMode) saveData('cls_seat_config', data.seatConfig); }
            if(data.appConfig) { setAppConfig(data.appConfig); setCfg(data.appConfig); if(!isLocalMode) saveData('cls_app_config', data.appConfig);
            } showToast("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); } catch(err) { 
                logSystemEvent(`JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
                showToast("JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); } }; reader.readAsText(file); };
            
            const handleApplyCode = () => {
                let code = updateCodeInput.trim();
                if (!code) return showToast("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setIsUpdating(true);
                setUpdateProgress(0);
                setUpdateStatus("ì½”ë“œ ë¶„ì„ ì¤‘...");
                setRemainingTime(3.0);

                const loaderHtml = `
                    <div id="temp-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#F5F5F7;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:sans-serif;">
                        <div style="font-size:40px;margin-bottom:20px;">ğŸš€</div>
                        <h2 style="color:#1e293b;margin-bottom:10px;">ì•±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
                        <p style="color:#64748b;font-size:14px;">í™”ë©´ì´ ì ì‹œ í•˜ì–—ê²Œ ë³´ì—¬ë„ ì •ìƒì…ë‹ˆë‹¤.</p>
                        <div style="width:200px;height:4px;background:#cbd5e1;border-radius:4px;margin-top:20px;overflow:hidden;">
                            <div style="width:100%;height:100%;background:#3b82f6;animation:loaderAnim 1.5s infinite ease-in-out;"></div>
                        </div>
                        <style>@keyframes loaderAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }</style>
                    </div>
                `;
                
                if (code.includes("<body")) {
                    code = code.replace(/<body[^>]*>/, (match) => match + loaderHtml);
                } else {
                    code = loaderHtml + code;
                }

                let progress = 0;
                const totalSteps = 30; 
                
                const timer = setInterval(() => {
                    progress += 100 / totalSteps;
                    const currentProgress = Math.min(Math.round(progress), 100);
                    const timeLeft = Math.max(0, (3 - (progress / 100 * 3))).toFixed(1);

                    setUpdateProgress(currentProgress);
                    setRemainingTime(timeLeft);

                    if (currentProgress < 30) setUpdateStatus("ì½”ë“œ ë¬´ê²°ì„± ê²€ì‚¬ ì¤‘...");
                    else if (currentProgress < 60) setUpdateStatus("ë°ì´í„° ë°±ì—… í™•ì¸ ì¤‘...");
                    else if (currentProgress < 90) setUpdateStatus("ìƒˆë¡œìš´ í™˜ê²½ êµ¬ì„± ì¤‘...");
                    else setUpdateStatus("ì—…ë°ì´íŠ¸ ì ìš© ì¤€ë¹„ ì™„ë£Œ!");

                    if (progress >= 100) {
                        clearInterval(timer);
                        setTimeout(() => {
                            setUpdateStatus("í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤...");
                            try {
                                document.open();
                                document.write(code); 
                                document.close();
                            } catch (e) {
                                logSystemEvent(`ì½”ë“œ ì—…ë°ì´íŠ¸ ì ìš© ì‹¤íŒ¨: ${e.message}`, 'error');
                                setIsUpdating(false);
                                showToast("ì½”ë“œ ì ìš© ì‹¤íŒ¨: " + e.message);
                            }
                        }, 500);
                    }
                }, 100);
            };

            const handleSaveCodeFile = () => {
                logSystemEvent('ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ ì €ì¥ ì‹œë„');
                if (!updateCodeInput.trim()) return showToast("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                const blob = new Blob(["\ufeff" + updateCodeInput], {type: "text/html;charset=utf-8"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Checklist_Updated_${dayjs().format('YYYYMMDD')}.html`;
                link.click();
                showToast("ì˜¤í”„ë¼ì¸ ì‹¤í–‰ìš© íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const getManualContent = () => `
================================================================
  ğŸ“˜ ë‹¤í–ˆë‚˜ìš”? ì‚¬ìš© ì„¤ëª…ì„œ (v${appConfig.version})
================================================================

ì•ˆë…•í•˜ì„¸ìš”, ì„ ìƒë‹˜! 
'ë‹¤í–ˆë‚˜ìš”?'ëŠ” í•™ê¸‰ ìš´ì˜ì„ ë” ì‰½ê³  ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë„ì™€ë“œë¦¬ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
ì£¼ìš” ê¸°ëŠ¥ê³¼ ì‚¬ìš© íŒì„ ì•„ë˜ì— ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.

----------------------------------------------------------------
1. ğŸ§‘â€ğŸ“ í•™ìƒ ê´€ë¦¬ (ê¸°ì´ˆ ê³µì‚¬)
----------------------------------------------------------------
- [ë“±ë¡]: ì„¤ì •(âš™ï¸) > í•™ìƒ ê´€ë¦¬ì—ì„œ ì´ë¦„ì„ ì…ë ¥í•˜ê³  'ì¶”ê°€'ë¥¼ ëˆ„ë¥´ì„¸ìš”.
- [ì¼ê´„ ë“±ë¡]: ì—‘ì…€(CSV)ì´ë‚˜ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ëª…ë‹¨ì„ í•œ ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ì‚¬ì§„ ê´€ë¦¬]: 'ì‚¬ì§„ ì¼ê´„ ê´€ë¦¬' ë²„íŠ¼ìœ¼ë¡œ í•™ìƒë“¤ì˜ ì‚¬ì§„ì„ ì†ì‰½ê²Œ ë“±ë¡í•˜ì„¸ìš”.
- [ìˆ˜ì •/ì‚­ì œ]: í•™ìƒ ëª©ë¡ì—ì„œ ì—°í•„ ì•„ì´ì½˜(ìˆ˜ì •)ì´ë‚˜ íœ´ì§€í†µ ì•„ì´ì½˜(ì‚­ì œ)ì„ ëˆ„ë¥´ì„¸ìš”.
- [íŒ]: í•™ìƒì—ê²Œ 'ë¦¬ë”(ğŸ‘‘)' ì†ì„±ì„ ì£¼ë©´ ëª¨ë‘  í¸ì„± ì‹œ ê° ì¡°ì— ê³¨ê³ ë£¨ ë°°ì¹˜ë©ë‹ˆë‹¤.

----------------------------------------------------------------
2. ğŸ“ ê¸°ë¡ ëª¨ë“œ (ë§¤ì¼ ì“°ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸)
----------------------------------------------------------------
- [ì²´í¬]: í•™ìƒ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ê³¼ì œ ì œì¶œ/ì™„ë£Œ ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤.
- [ì„¸ë¶€ ê³¼ì œ]: 'ê³¼ì œ ì„¤ì •(+)' ë²„íŠ¼ì„ ëˆŒëŸ¬ 'ì¼ê¸°', 'ë…ì„œë¡' ë“± ì—¬ëŸ¬ ê³¼ì œë¥¼ ë“±ë¡í•˜ì„¸ìš”.
- [ë¹ ë¥¸ ê¸°ë¡]: í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼(âœï¸)ì„ ëˆŒëŸ¬ ì–¸ì œ ì–´ë””ì„œë“  ê´€ì°° ê¸°ë¡ì„ ë‚¨ê¸°ì„¸ìš”.
- [í•™ê¸‰ ìŠ¤í† ë¦¬]: í•˜ë£¨ ê¸°ë¡ì´ ëë‚˜ë©´ 'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. 
  AIê°€ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ íŒíƒ€ì§€, ë™í™”, SF ë“± ë‹¤ì–‘í•œ ì¥ë¥´ì˜ ì´ì•¼ê¸°ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

----------------------------------------------------------------
3. ğŸ§© ëª¨ë‘  & ìë¦¬ ë°°ì¹˜ (AI ë¹„ì„œ)
----------------------------------------------------------------
- [AI í¸ì„±]: ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”, ê¸°í”¼ ê´€ê³„ ë“±ì„ ê³ ë ¤í•´ AIê°€ ìµœì ì˜ ëª¨ë‘ ì„ ì§œì¤ë‹ˆë‹¤.
- [ìˆ˜ë™ ì¡°ì •]: ë§ˆìš°ìŠ¤ë¡œ í•™ìƒì„ ë“œë˜ê·¸í•˜ì—¬ ë‹¤ë¥¸ ëª¨ë‘ ìœ¼ë¡œ ì‰½ê²Œ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ìë¦¬ ë°°ì¹˜]: í¸ì„±ëœ ëª¨ë‘ ì„ ë°”íƒ•ìœ¼ë¡œ êµì‹¤ ìë¦¬ ë°°ì¹˜ë„ê¹Œì§€ í•œ ë²ˆì— í•´ê²°í•˜ì„¸ìš”.
- [ì—­í•  ë¶„ë‹´]: 'ëª¨ë‘  ë„êµ¬'ì—ì„œ ë‚˜ëˆ”ì´, ì´ë„ë¯¸ ë“± ì—­í• ì„ ìë™ìœ¼ë¡œ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [ìì „ê³¼ ê³µì „]: ëª¨ë‘  êµ¬ì„±ì›ì€ ìœ ì§€í•œ ì±„ ìë¦¬ë§Œ íšŒì „ì‹œí‚¤ëŠ” ê¸°ëŠ¥ë„ ì§€ì›í•©ë‹ˆë‹¤.

----------------------------------------------------------------
4. ğŸ“Š í†µê³„ & ìƒë‹´ (ë°ì´í„° ê¸°ë°˜ ì§€ë„)
----------------------------------------------------------------
- [ëª…ì˜ˆì˜ ì „ë‹¹]: ì„±ì‹¤í•˜ê²Œ ì°¸ì—¬í•œ í•™ìƒë“¤ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”.
- [í™œë™ ì”ë””]: í•™ìƒë³„ 30ì¼ê°„ì˜ í™œë™ ê¸°ë¡ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.
- [AI ì£¼ê°„ ë¸Œë¦¬í•‘]: ì´ë²ˆ ì£¼ ìš°ë¦¬ ë°˜ ë¶„ìœ„ê¸°ê°€ ì–´ë• ëŠ”ì§€ AIê°€ ìš”ì•½í•´ì¤ë‹ˆë‹¤.
- [í•™ìƒ ì¸ì‚¬ì´íŠ¸]: í•™ìƒ ì´ë¦„ì„ ë”ë¸” í´ë¦­í•˜ë©´ ê°œë³„ ìƒë‹´ ê¸°ë¡, ì„±ì¥ ë¦¬í¬íŠ¸, 
  í•™ê¸‰ í‰ê·  ë¹„êµ ê·¸ë˜í”„ ë“±ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- [AI ì€ìƒ˜ìƒë‹´ì†Œ]: í•™ìƒ ì§€ë„ ê³ ë¯¼ì´ ìˆì„ ë•Œ AIì—ê²Œ ì¡°ì–¸ì„ êµ¬í•´ë³´ì„¸ìš”.
- [ì´í‰ ì´ˆì•ˆ]: 1ë…„ê°„ì˜ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ìƒí™œê¸°ë¡ë¶€(í–‰ë°œ, êµê³¼) ì´ˆì•ˆì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.

----------------------------------------------------------------
5. ğŸ”— ì™¸ë¶€ ì—°ë™ & ë°ì´í„° ê´€ë¦¬
----------------------------------------------------------------
- [ë…¸ì…˜ ì—°ë™]: ê¸°ë¡ì„ ê°œì¸ ë…¸ì…˜ í˜ì´ì§€ì— ìë™ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  (ê¸°ë¡ ëª¨ë“œ / í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì§€ì›)
- [êµ¬ê¸€ ì‹œíŠ¸]: ê¸°ë¡ ë°ì´í„°ë¥¼ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ì‹¤ì‹œê°„ ì „ì†¡í•©ë‹ˆë‹¤.
- [ìë™ ë°±ì—…]: ì„¤ì • > ë°ì´í„° ê´€ë¦¬ì—ì„œ ìë™ ë°±ì—… ì‹œê°„ì„ ì„¤ì •í•˜ë©´ ì•ˆì‹¬ì…ë‹ˆë‹¤.
- [ë°ì´í„° ì •ë¦¬]: ì˜¤ë˜ëœ ê¸°ë¡ì„ ì •ë¦¬í•˜ì—¬ ì•± ì†ë„ë¥¼ ìµœì í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

----------------------------------------------------------------
6. ğŸ§° í•™ê¸‰ ë„êµ¬ ìƒì
----------------------------------------------------------------
- [ë°œí‘œì ë½‘ê¸°]: ë¬´ì‘ìœ„ë¡œ ë°œí‘œìë¥¼ ì„ ì •í•  ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.
- [íƒ€ì´ë¨¸]: ìˆ˜ì—… ì‹œê°„ ê´€ë¦¬ì— ìœ ìš©í•œ íƒ€ì´ë¨¸ ê¸°ëŠ¥ì´ ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

----------------------------------------------------------------
ğŸ’¡ ë¬¸ì˜ ë° ì œì•ˆ: spk@smca.or.kr
================================================================
`.trim();

            const handleDownloadManualFile = () => {
                const content = getManualContent();
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Classroom_Checklist_Manual_v${appConfig.version}.txt`;
                link.click();
                showToast("ì‚¬ìš© ì„¤ëª…ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };


            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title={<><span onClick={onDevModeClick} className="cursor-default">âš™ï¸</span> <span onClick={handleDataManagementClick} className="cursor-default select-none">ì„¤ì •</span></>} icon={null} maxWidth="max-w-6xl">
                    <HelpModal isOpen={showBackupHelp} onClose={()=>setShowBackupHelp(false)} />
                    <ManualModal isOpen={showManualModal} onClose={() => setShowManualModal(false)} content={getManualContent()} onDownload={handleDownloadManualFile} />
                    
                    {isUpdating && (
                        <div className="fixed inset-0 z-[9999] bg-slate-900/90 flex flex-col items-center justify-center text-white backdrop-blur-sm animate-fade-in">
                            <div className="w-full max-w-md p-8 bg-slate-800 rounded-3xl shadow-2xl border border-slate-700 text-center">
                                <div className="mb-6 animate-bounce text-4xl">ğŸš€</div>
                                <h3 className="text-2xl font-bold mb-2">ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘</h3>
                                <p className="text-slate-400 text-sm mb-6">{updateStatus}</p>
                                <div className="relative h-4 bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div className="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 ease-out" style={{ width: `${updateProgress}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs font-mono text-slate-300 mb-4">
                                    <span>{updateProgress}%</span>
                                    <span>ë‚¨ì€ ì‹œê°„: {remainingTime}ì´ˆ</span>
                                </div>
                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-yellow-200 text-xs text-left">
                                    âš ï¸ <strong>ì£¼ì˜:</strong> ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ë©´ ì ì‹œ <strong>í™”ë©´ì´ í•˜ì–—ê²Œ ë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</strong>. <br/>
                                    ì´ëŠ” ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì •ìƒì ì¸ ê³¼ì •ì…ë‹ˆë‹¤. ë‹¹í™©í•˜ì§€ ë§ê³  3~5ì´ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
                                </div>
                            </div>
                        </div>
                    )}

                    {/* [Fix] í™”ë©´ ë°°ìœ¨ì— ë”°ë¼ ëª¨ë‹¬ ë†’ì´ ìë™ ì¡°ì ˆ (í™”ë©´ ì˜ë¦¼ ë°©ì§€) */}
                    <div className="flex flex-col md:flex-row gap-6" style={{ 
                        height: `${Math.min(65, 65 * (100 / (appConfig.uiScale || 100)))}vh` 
                    }}>
                        <div className="w-full md:w-40 flex-shrink-0 flex flex-row md:flex-col gap-1 md:gap-2 bg-slate-50 md:bg-transparent p-1 md:p-0 rounded-xl">
                            <button onClick={() => setActiveTab('student')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'student' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ‘¤ í•™ìƒ ê´€ë¦¬</button>
                            <button onClick={() => setActiveTab('app')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'app' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ“± ì•± ì„¤ì •</button>
                            <button onClick={() => setActiveTab('data')} className={`flex-1 md:flex-none px-1 md:px-4 py-2 md:py-2.5 text-xs md:text-sm font-bold rounded-lg md:rounded-xl text-center md:text-left whitespace-nowrap transition-all ${activeTab === 'data' ? 'bg-white md:bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</button>
                        </div>

                        <div className={`flex-1 overflow-y-auto custom-scroll pr-2 space-y-6 pb-10 ${getTabAnimationClass()}`} key={activeTab}>
                            {activeTab === 'student' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5 cursor-default select-none">
                                            <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ§‘â€ğŸ“</div> 
                                            í•™ìƒ ëª…ë‹¨ ê´€ë¦¬
                                        </h4>
                                        
                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6">
                                            <div className="flex justify-between items-center mb-4">
                                                <h5 className="text-sm font-bold text-slate-700">ìƒˆ í•™ìƒ ë“±ë¡</h5>
                                            <div className="flex items-center">
                                                <Btn onClick={() => fileRef.current.click()} className="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 flex items-center gap-1 font-bold" title="CSV/TXT ì—…ë¡œë“œ"> <Icon d={PATHS.upload} size={14} /> <span>CSV ì—…ë¡œë“œ</span> </Btn>
                                                <input type="file" ref={fileRef} onChange={handleFileUpload} className="hidden" accept=".csv,.txt" />
                                            </div>
                                        </div>
                                <div className="flex flex-wrap gap-2 items-center">
                                    <input value={name} onChange={e => setName(e.target.value)} className="h-10 p-2.5 border rounded-xl text-sm w-24 sm:w-32" placeholder="ì´ë¦„" onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <select value={gender} onChange={e => setGender(e.target.value)} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select>
                                    <select value={skill} onChange={e => setSkill(parseInt(e.target.value))} className="h-10 w-16 p-2.5 border rounded-xl text-sm"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select>
                                    <input value={note} onChange={e => setNote(e.target.value)} className="h-10 flex-1 p-2.5 border rounded-xl text-sm min-w-[100px]" placeholder="ë¹„ê³ " onKeyDown={e => { if (e.key === 'Enter' && !e.nativeEvent.isComposing) addStudent() }} />
                                    <button onClick={() => setIsLeader(!isLeader)} className={`h-10 px-3 border rounded-xl text-lg ${isLeader ? 'bg-yellow-100 border-yellow-300 text-yellow-600' : 'bg-white border-slate-200 text-slate-300'}`} title="ë¦¬ë”(ì´ë„ë¯¸)">ğŸ‘‘</button>
                                    <Btn onClick={addStudent} className="h-10 bg-indigo-600 text-white px-4 rounded-xl font-bold hover:bg-indigo-700 text-sm whitespace-nowrap">ì¶”ê°€</Btn>
                                </div>
                                    </div>
                            
                                    <div className={`flex flex-col transition-all duration-300 ${isStudentListOpen ? 'h-[500px]' : 'h-auto'}`}>
                                        <div className="flex justify-between items-center mb-3 flex-shrink-0 cursor-pointer select-none" onClick={() => setIsStudentListOpen(!isStudentListOpen)}>
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2 text-sm">
                                                <span className="text-lg">ğŸ“‹</span> ë“±ë¡ëœ í•™ìƒ ({students.length}ëª…)
                                                <Icon d={isStudentListOpen ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                            </h4>
                                            <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                                                <Btn onClick={addTestData} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:bg-indigo-100 transition-colors whitespace-nowrap">í…ŒìŠ¤íŠ¸ ëª…ë‹¨</Btn>
                                                {isDeleteLocked ? (
                                                    <Btn onClick={() => setIsDeleteLocked(false)} className="text-xs bg-slate-100 text-slate-400 p-1.5 rounded-lg font-bold flex items-center justify-center hover:bg-slate-200 transition-colors" title="ì ê¸ˆ í•´ì œ"><Icon d={PATHS.lock} size={14} /></Btn>
                                                ) : (
                                                    isDeletingAll ?
                                                    <div className="flex gap-2"><Btn onClick={handleDeleteAll} className="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg animate-pulse whitespace-nowrap">í™•ì¸</Btn><Btn onClick={() => { setIsDeletingAll(false); setIsDeleteLocked(true); }} className="text-xs bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg whitespace-nowrap">ì·¨ì†Œ</Btn></div> : 
                                                    <Btn onClick={() => setIsDeletingAll(true)} className="text-xs bg-rose-100 text-rose-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 whitespace-nowrap"><Icon d={PATHS.trash} size={12} /> ì „ì²´ ì‚­ì œ</Btn>
                                                )}
                                            </div>
                                        </div>
                            
                                        {isStudentListOpen && (
                                            <div id="student-list" className="flex-1 overflow-y-auto custom-scroll bg-slate-50 p-2 rounded-xl border border-slate-200 shadow-inner space-y-1 animate-fade-in">
                                            {students.map(s => (
                                    <div key={s.id} className="flex justify-between items-center p-2.5 bg-white rounded-lg border border-slate-100 text-sm group min-h-[46px]">
                                        {editingId === s.id ? (
                                            <div className="flex gap-1 flex-1 items-center animate-fade-in w-full">
                                                <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-1 flex items-center justify-center">
                                                    <span className="text-sm">{editData.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                                </div>
                                                <span className="text-indigo-500 font-bold w-6 text-center">{s.order}.</span> <input value={editData.name} onChange={e=>setEditData({...editData, name: e.target.value})} className="p-1 border rounded w-20 text-xs" /> <select value={editData.gender} onChange={e=>setEditData({...editData, gender: e.target.value})} className="p-1 border rounded w-12 text-xs"><option value="M">ë‚¨</option><option value="F">ì—¬</option></select> <select value={editData.skill} onChange={e=>setEditData({...editData, skill: parseInt(e.target.value)})} className="p-1 border rounded w-12 text-xs"><option value="3">ìƒ</option><option value="2">ì¤‘</option><option value="1">í•˜</option></select> <input value={editData.note} onChange={e=>setEditData({...editData, note: e.target.value})} className="flex-1 p-1 border rounded text-xs min-w-[50px]" placeholder="ë¹„ê³ " /> <button onClick={() => setEditData({...editData, leader: !editData.leader})} className={`p-1 border rounded text-xs ${editData.leader ? 'bg-yellow-100 border-yellow-300' : 'bg-slate-50'}`}>ğŸ‘‘</button> <Btn onClick={saveEdit} className="bg-indigo-500 text-white px-2 py-1 rounded text-xs font-bold">ì €ì¥</Btn> <Btn onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-2 py-1 rounded text-xs">ì·¨ì†Œ</Btn> </div>
                                        ) : (
                                            <> 
                                                <div className="flex flex-col">
                                                    <span className="font-medium text-slate-700 flex items-center">
                                                        <div className="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 mr-2 flex items-center justify-center">
                                                            <span className="text-sm">{s.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                                                        </div>
                                                        <span className="text-indigo-500 font-bold w-6 inline-block">{s.order}.</span> 
                                                        {s.name} 
                                                        <span className="text-xs text-slate-400 ml-1">({s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}/{['í•˜','ì¤‘','ìƒ'][s.skill-1]})</span>
                                                        {s.leader && <span className="ml-1 text-xs text-yellow-500" title="ë¦¬ë”">ğŸ‘‘</span>}
                                                    </span>
                                                    {s.note && <span className="text-xs text-slate-400 ml-7 truncate max-w-[200px]">{s.note}</span>}
                                                </div> 
                                                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"> <Btn onClick={() => startEdit(s)} className="text-slate-300 hover:text-indigo-500 p-1"><Icon d={PATHS.edit} size={16} /></Btn> {deleteTargetId === s.id ?
                                                (<div className="flex gap-1 animate-fade-in"><Btn onClick={(e) => { e.stopPropagation(); deleteStudent(s.id); setDeleteTargetId(null); }} className="bg-rose-500 text-white text-[10px] px-2 py-1 rounded font-bold">ì‚­ì œ</Btn><Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(null); }} className="bg-slate-200 text-slate-600 text-[10px] px-2 py-1 rounded font-bold">ì·¨ì†Œ</Btn></div>) : (<Btn onClick={(e) => { e.stopPropagation(); setDeleteTargetId(s.id); }} className="text-slate-300 hover:text-rose-500 p-1"><Icon d={PATHS.trash} size={16} /></Btn>)} </div> 
                                            </>
                                        )}
                                    </div>
                                ))}
                                            </div>
                                        )}
                                    </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'app' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5 cursor-default select-none">
                                            <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ“±</div> 
                                            ì•± ê¸°ë³¸ ì„¤ì •
                                            <div className="flex flex-col gap-1 ml-auto">
                                                {isAdminMode && <span className="w-fit text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">ê´€ë¦¬ì</span>}
                                                {isDevMode && <span className="w-fit text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-full">ê°œë°œì</span>}
                                            </div>
                                        </h4>

                                {(!isStandalone && (deferredPrompt || isIOS)) && (
                                    <div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-5 rounded-2xl text-white shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4 animate-fade-in mb-6 relative overflow-hidden group cursor-pointer mx-1" onClick={onInstallApp}>
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-white/20 transition-all"></div>
                                        <div className="flex items-center gap-4 relative z-10">
                                            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                                <span className="text-2xl">ğŸ“²</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-lg">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê³  ë” í¸í•˜ê²Œ!</span>
                                                <span className="text-xs text-indigo-100 font-medium">ì˜¤í”„ë¼ì¸ ì‚¬ìš© â€¢ ì „ì²´ í™”ë©´ â€¢ ë¹ ë¥¸ ì‹¤í–‰</span>
                                            </div>
                                        </div>
                                        <Btn className="bg-white text-indigo-600 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-indigo-50 shadow-md whitespace-nowrap relative z-10 transition-transform active:scale-95">
                                            {isIOS ? "ì„¤ì¹˜ ë°©ë²• ë³´ê¸°" : "í™ˆ í™”ë©´ì— ì¶”ê°€"}
                                        </Btn>
                                    </div>
                                )}

                                    <div className={`grid gap-4 ${isDevMode ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>
                                        {isDevMode && (
                                            <div className="space-y-4 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ğŸ› ï¸ ê°œë°œì ì„¤ì •</h4>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-indigo-300 transition-colors">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-xs font-bold text-slate-600">ì•Œë¦¼ ë°©ì‹</span>
                                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'modal' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType !== 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>íŒì—…</button>
                                                                <button onClick={() => updateAppConfig({ updateNotificationType: 'toast' })} className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.updateNotificationType === 'toast' ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>ë°°ë„ˆ</button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-100">
                                                            <Btn onClick={onTestUpdate} className="py-2 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</Btn>
                                                            <Btn onClick={() => { localStorage.setItem('cls_last_version', 'v0.0.0'); showToast("ë²„ì „ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."); }} className="py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold hover:bg-slate-200">ğŸ”„ ë²„ì „ ì´ˆê¸°í™”</Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2 text-sm">ğŸ¨ ì•„ì´ì½˜ ì„¤ì •</h4>
                                                    <div className="grid grid-cols-3 gap-2 bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-indigo-300 transition-colors">
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative">
                                                        <button onClick={(e) => { e.stopPropagation(); setShowFaviconHelp(!showFaviconHelp); }} className="absolute top-1 right-1 text-slate-300 hover:text-indigo-500 transition-colors"><Icon d={PATHS.help} size={12} /></button>
                                                        {showFaviconHelp && (
                                                            <div className="absolute top-6 right-1 w-48 bg-slate-800/95 backdrop-blur text-white text-[10px] p-3 rounded-xl shadow-xl z-20 text-left leading-relaxed animate-fade-in border border-slate-700" onClick={() => setShowFaviconHelp(false)}>
                                                                <p className="font-bold mb-1 text-indigo-300">ğŸ’¡ ì•„ì´ì½˜ ì—…ë¡œë“œ ê°€ì´ë“œ</p>
                                                                <ul className="list-disc pl-3 space-y-1 opacity-90">
                                                                    <li>ì ìš©: ë¸Œë¼ìš°ì € íƒ­, í™ˆ í™”ë©´(PWA)</li>
                                                                    <li>ë¹„ìœ¨: 1:1 ì •ì‚¬ê°í˜• (í•„ìˆ˜)</li>
                                                                    <li>í¬ê¸°: 192px ì´ìƒ ê¶Œì¥</li>
                                                                    <li>ë°°ê²½: íˆ¬ëª…(PNG) ê¶Œì¥</li>
                                                                    <li>ìš©ëŸ‰: ê°€ê¸‰ì  ì‘ê²Œ (ë¡œë”© ì†ë„)</li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                        <div className="flex gap-2 items-end mb-1 mt-1">
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">ë¸Œë¼ìš°ì €</span>
                                                                <div className="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100">
                                                                    {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-lg">ğŸ“</span>}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <span className="text-[8px] text-slate-400 font-bold">iOS í™ˆ</span>
                                                                <div className="relative w-10 h-12 bg-gradient-to-b from-sky-300 to-sky-500 rounded-md flex flex-col items-center justify-center shadow-inner border border-slate-200 overflow-hidden pt-0.5">
                                                                    <div className="w-6 h-6 bg-white rounded-[6px] flex items-center justify-center overflow-hidden shadow-sm mb-0.5">
                                                                        {appConfig.favicon ? <img src={appConfig.favicon} className="w-full h-full object-cover" /> : <span className="text-sm">ğŸ“</span>}
                                                                    </div>
                                                                    <span className="text-[4px] text-white font-medium drop-shadow-md truncate max-w-[36px] px-0.5">{appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?"}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={faviconRef} onChange={(e) => { 
                                                                const f = e.target.files[0]; 
                                                                if (f) { 
                                                                    const r = new FileReader(); 
                                                                    r.onload = (ev) => { 
                                                                        const newIcon = ev.target.result; 
                                                                        updateAppConfig({ favicon: newIcon });
                                                                        openConfirm("ì•± ì•„ì´ì½˜ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në³€ê²½ëœ ì•„ì´ì½˜ì„ í™ˆ í™”ë©´ì— ì ìš©í•˜ë ¤ë©´,\nê¸°ì¡´ ì•±ì„ ì‚­ì œí•˜ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n(í™•ì¸ì„ ëˆ„ë¥´ë©´ ì„¤ì¹˜ ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤)", () => onInstallApp()); 
                                                                    }; 
                                                                    r.readAsDataURL(f); 
                                                                } 
                                                            }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => faviconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ë³€ê²½</Btn>
                                                            <Btn onClick={() => openConfirm("ì•± ì•„ì´ì½˜ì„ ê¸°ë³¸ê°’(ğŸ“)ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => updateAppConfig({ favicon: null }))} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-full h-full object-cover" /> : <span className="text-xl">{appConfig.runner}</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={runnerImgRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ runner: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => runnerImgRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">ëŸ¬ë„ˆ</Btn>
                                                            <Btn onClick={() => updateAppConfig({ runner: "ğŸƒ" })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 shadow-sm relative overflow-hidden">
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center overflow-hidden border border-slate-100 mb-1">
                                                            {appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-full h-full object-contain" /> : <span className="text-xl">â˜ï¸</span>}
                                                        </div>
                                                        <div className="flex gap-1 w-full">
                                                            <input type="file" ref={cloudIconRef} onChange={(e) => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = (ev) => updateAppConfig({ cloudIcon: ev.target.result }); r.readAsDataURL(f); } }} className="hidden" accept="image/*" />
                                                            <Btn onClick={() => cloudIconRef.current.click()} className="flex-1 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold hover:bg-indigo-100">êµ¬ë¦„</Btn>
                                                            <Btn onClick={() => updateAppConfig({ cloudIcon: null })} className="px-1.5 py-1 bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon d={PATHS.trash} size={12}/></Btn>
                                                        </div>
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 gap-2">
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 flex-shrink-0"><Icon d={PATHS.edit} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ê¸°ë¡ ëª¨ë“œ ì œëª©</label>
                                                <input value={appConfig.recordTitle} onChange={e => updateAppConfig({ recordTitle: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ë‹¤í–ˆë‚˜ìš”!?" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-500 flex-shrink-0"><Icon d={PATHS.check} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ì™„ë£Œ ë©”ì‹œì§€</label>
                                                <input value={appConfig.recordMsg} onChange={e => updateAppConfig({ recordMsg: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ğŸ‰" />
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-500 flex-shrink-0"><Icon d={PATHS.users} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">ìì „ê³¼ ê³µì „ ì•Œë¦¼ ìš”ì¼</label>
                                                <select value={appConfig.rotationDay !== undefined ? appConfig.rotationDay : 5} onChange={e => updateAppConfig({ rotationDay: parseInt(e.target.value) })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent cursor-pointer">
                                                    <option value={1}>ì›”ìš”ì¼</option>
                                                    <option value={2}>í™”ìš”ì¼</option>
                                                    <option value={3}>ìˆ˜ìš”ì¼</option>
                                                    <option value={4}>ëª©ìš”ì¼</option>
                                                    <option value={5}>ê¸ˆìš”ì¼</option>
                                                    <option value={6}>í† ìš”ì¼</option>
                                                    <option value={0}>ì¼ìš”ì¼</option>
                                                    <option value={-1}>ì‚¬ìš© ì•ˆ í•¨</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm flex items-center gap-3 hover:border-indigo-300 transition-colors">
                                            <div className="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 flex-shrink-0"><Icon d={PATHS.users} size={20}/></div>
                                            <div className="flex-1 min-w-0">
                                                <label className="text-[10px] font-bold text-slate-400 block mb-0.5">í•™ê¸‰ëª… (íŒŒì¼ ì €ì¥ìš©)</label>
                                                <input value={appConfig.className || ""} onChange={e => updateAppConfig({ className: e.target.value })} className="w-full text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300" placeholder="ì˜ˆ: 3í•™ë…„ 2ë°˜" />
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="h-full group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ¨</div> í™”ë©´ ë° ì†Œë¦¬ ì„¤ì •</h4>
                                        <div className="flex flex-col gap-4">
                                            <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors relative">
                                            <div className="flex items-center gap-2 mb-2">
                                                <Icon d={PATHS.document} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">ì•± í°íŠ¸</span>
                                            </div>
                                            <button 
                                                onClick={() => setShowFontList(!showFontList)} 
                                                className={`w-full p-2 border rounded-lg text-xs bg-slate-50 outline-none focus:border-indigo-500 font-bold text-slate-700 flex justify-between items-center ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}
                                            >
                                                <span className="truncate">
                                                {
                                                    appConfig.font === 'sans' ? 'ê¸°ë³¸ ê³ ë”•' :
                                                    appConfig.font === 'nanum' ? 'ë‚˜ëˆ”ê³ ë”•' :
                                                    appConfig.font === 'nanum-bold' ? 'ë‚˜ëˆ”ê³ ë”• (Bold)' :
                                                    appConfig.font === 'serif' ? 'ë‚˜ëˆ”ëª…ì¡°' :
                                                    appConfig.font === 'jua' ? 'ì£¼ì•„ì²´' :
                                                    appConfig.font === 'hand' ? 'ê°œêµ¬ì²´' : 'ê¸°ë³¸ ê³ ë”•'
                                                }
                                                </span>
                                                <Icon d={PATHS.down} size={12} className="text-slate-400 flex-shrink-0" />
                                            </button>
                                            {showFontList && (
                                                <>
                                                    <div className="fixed inset-0 z-[60]" onClick={() => setShowFontList(false)}></div>
                                                    <div className="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl z-[70] overflow-hidden max-h-60 overflow-y-auto custom-scroll">
                                                        {[
                                                            { id: 'sans', label: 'ê¸°ë³¸ ê³ ë”•', cls: 'font-sans' },
                                                            { id: 'nanum', label: 'ë‚˜ëˆ”ê³ ë”•', cls: 'font-nanum' },
                                                            { id: 'nanum-bold', label: 'ë‚˜ëˆ”ê³ ë”• (Bold)', cls: 'font-nanum font-bold' },
                                                            { id: 'serif', label: 'ë‚˜ëˆ”ëª…ì¡°', cls: 'font-serif' },
                                                            { id: 'jua', label: 'ì£¼ì•„ì²´', cls: 'font-jua' },
                                                            { id: 'hand', label: 'ê°œêµ¬ì²´', cls: 'font-hand' },
                                                        ].map(f => (
                                                            <button 
                                                                key={f.id}
                                                                onClick={() => { updateAppConfig({ font: f.id }); setShowFontList(false); }}
                                                                className={`w-full text-left px-3 py-2.5 text-xs hover:bg-indigo-50 transition-colors border-b border-slate-50 last:border-0 ${f.cls} ${appConfig.font === f.id ? 'bg-indigo-50 text-indigo-600' : 'text-slate-700'}`}
                                                            >
                                                                {f.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                            <div className="grid grid-cols-2 gap-2">
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.animationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ animationEnabled: !(appConfig.animationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.play} size={16} className={appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.animationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>í™”ë©´ ì „í™˜</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.animationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.animationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.animationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.animationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.tabAnimationEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ tabAnimationEnabled: !(appConfig.tabAnimationEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.right} size={16} className={appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>íƒ­ íš¨ê³¼</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.tabAnimationEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.tabAnimationEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.tabAnimationEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.tabAnimationEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.autoBatchRename ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ autoBatchRename: !appConfig.autoBatchRename })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.copy} size={16} className={appConfig.autoBatchRename ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.autoBatchRename ? "text-indigo-700" : "text-slate-500"}`}>ëª¨ë‘  ì´ë¦„ ì¼ê´„ ë³€ê²½</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.autoBatchRename ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.autoBatchRename ? "í™•ì¸ ìƒëµ" : "í•­ìƒ í™•ì¸"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.autoBatchRename ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.autoBatchRename && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div 
                                                className={`border rounded-xl p-2.5 shadow-sm flex flex-col justify-between transition-all cursor-pointer select-none ${appConfig.dDayEnabled !== false ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                                                onClick={() => updateAppConfig({ dDayEnabled: !(appConfig.dDayEnabled !== false) })}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    <Icon d={PATHS.calendar} size={16} className={appConfig.dDayEnabled !== false ? "text-indigo-500" : "text-slate-400"}/>
                                                    <span className={`text-xs font-bold ${appConfig.dDayEnabled !== false ? "text-indigo-700" : "text-slate-500"}`}>D-Day í‘œì‹œ</span>
                                                </div>
                                                <div className="flex justify-end items-center gap-2">
                                                    <span className={`text-[10px] font-bold ${appConfig.dDayEnabled !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.dDayEnabled !== false ? "ON" : "OFF"}</span>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${appConfig.dDayEnabled !== false ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                                        {appConfig.dDayEnabled !== false && <Icon d={PATHS.check} size={14} className="text-white" strokeWidth={3} />}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.magic} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í”Œë¡œíŒ… ë²„íŠ¼ ìë™ ìˆ¨ê¹€</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] font-bold ${appConfig.floatingButtonAutoHide !== false ? "text-indigo-500" : "text-slate-400"}`}>{appConfig.floatingButtonAutoHide !== false ? "ON" : "OFF"}</span>
                                                <div onClick={() => updateAppConfig({ floatingButtonAutoHide: !(appConfig.floatingButtonAutoHide !== false) })} className={`w-8 h-5 flex items-center rounded-full p-1 cursor-pointer transition-colors ${appConfig.floatingButtonAutoHide !== false ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-3 h-3 rounded-full shadow-md transform transition-transform ${appConfig.floatingButtonAutoHide !== false ? 'translate-x-3' : ''}`}></div></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.edit} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í”Œë¡œíŒ… ë²„íŠ¼ í¬ê¸°</span>
                                            </div>
                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                {['small', 'medium', 'large', 'xlarge'].map(size => (
                                                    <button key={size} onClick={() => updateAppConfig({ floatingButtonSize: size })} className={`flex-1 whitespace-nowrap px-1 py-1 text-[10px] font-bold rounded-md transition-all ${appConfig.floatingButtonSize === size ? 'bg-white shadow text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                                        {size === 'small' ? 'ì‘ê²Œ' : size === 'medium' ? 'ë³´í†µ' : size === 'large' ? 'í¬ê²Œ' : 'ë” í¬ê²Œ'}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white border border-slate-200 rounded-xl p-2.5 shadow-sm hover:border-indigo-300 transition-colors">
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2">
                                                <Icon d={PATHS.search} size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">í™”ë©´ ë°°ìœ¨ (UI Scale)</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold text-indigo-600">{appConfig.uiScale || 100}%</span>
                                                {(appConfig.uiScale !== 100) && (
                                                    <button 
                                                        onClick={() => updateAppConfig({ uiScale: 100 })}
                                                        className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full hover:bg-slate-200 transition-colors font-bold"
                                                    >ì´ˆê¸°í™”</button>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <input type="range" min="80" max="200" step="5" value={appConfig.uiScale || 100} onChange={(e) => updateAppConfig({ uiScale: parseInt(e.target.value) })} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                            <div className="flex justify-between gap-1">
                                                {[100, 110, 125, 150].map(scale => (
                                                    <button 
                                                        key={scale} 
                                                        onClick={() => updateAppConfig({ uiScale: scale })}
                                                        className={`flex-1 py-1 text-[10px] font-bold rounded border transition-all ${appConfig.uiScale === scale ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-slate-50 text-slate-500 border-transparent hover:bg-slate-100'}`}
                                                    >
                                                        {scale}%
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    </div>

                                    <div className="h-full group">
                                        <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ–ï¸</div> ë°©í•™ ê¸°ê°„ ì„¤ì •</h4>
                                        <div className="h-full flex flex-col">
                                        <div className="space-y-3 flex-1">
                                            {currentVacations.length > 0 ? (
                                                <div className="space-y-2 max-h-32 overflow-y-auto custom-scroll pr-1">
                                                    {currentVacations.map((v, i) => (
                                                        <div key={i} className="flex items-center justify-between bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm group hover:border-indigo-200 transition-colors">
                                                            <div className="flex items-center gap-2">
                                                                <span className="w-5 h-5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[10px] font-bold">{i+1}</span>
                                                                <span className="font-bold text-slate-600 text-xs">{dayjs(v.start).format('YY.MM.DD')} ~ {dayjs(v.end).format('YY.MM.DD')}</span>
                                                            </div>
                                                            <button onClick={() => removeVacation(i)} className="text-slate-300 hover:text-rose-500 p-1 hover:bg-rose-50 rounded transition-colors"><Icon d={PATHS.trash} size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (<div className="text-center text-slate-400 text-xs py-4 border-2 border-dashed border-slate-200 rounded-lg bg-white/50">ë“±ë¡ëœ ë°©í•™ ê¸°ê°„ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}
                                            
                                            <div className="pt-3 border-t border-slate-200">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-2">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì‹œì‘ì¼</span>
                                                        <input type="date" value={newVacStart} onChange={e => setNewVacStart(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-[10px] font-bold text-slate-400 ml-1">ì¢…ë£Œì¼</span>
                                                        <input type="date" value={newVacEnd} onChange={e => setNewVacEnd(e.target.value)} className="w-full p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500 font-bold text-slate-600" />
                                                    </div>
                                                </div>
                                                <Btn onClick={addVacation} className="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 text-xs shadow-sm flex items-center justify-center gap-1 transition-transform active:scale-95">
                                                    <Icon d={PATHS.plus} size={14} /> ê¸°ê°„ ì¶”ê°€í•˜ê¸°
                                                </Btn>
                                            </div>
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-2 flex items-center gap-1">
                                            <Icon d={PATHS.help} size={10} /> ë°©í•™ ê¸°ê°„ì—ëŠ” ë‹¬ë ¥ì—ì„œ ë‚ ì§œ ì„ íƒì´ ì œí•œë©ë‹ˆë‹¤.
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'data' && (
                                <div className="space-y-6 animate-fade-in">
                                    
                                    {/* [1ë‹¨] ì—°ë™ ë° ìš©ëŸ‰ ë¶„ì„ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full group">
                                            <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5">
                                                <div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ”—</div> 
                                                ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™
                                                <div className="flex flex-col gap-1 ml-auto">
                                                    {isAdminMode && <span className="w-fit text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">ê´€ë¦¬ì</span>}
                                                    {isDevMode && <span className="w-fit text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-full">ê°œë°œì</span>}
                                                </div>
                                            </h4>
                                            <div className="grid grid-cols-3 gap-2">
                                                <Btn onClick={onOpenNotionSetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isNotionConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`} title="ë…¸ì…˜ ì—°ë™">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isNotionConnected ? 'bg-green-100' : 'bg-slate-100'}`}><span className="text-lg">N</span></div>
                                                    <span className={`text-xs font-bold ${isNotionConnected ? 'text-green-700' : 'text-slate-600'}`}>ë…¸ì…˜ ì—°ë™</span>
                                                    {isNotionConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenApiKeySetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isAiConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`}>
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isAiConnected ? 'bg-green-100' : 'bg-slate-100'}`}><Icon d={PATHS.bot} size={18} className={isAiConnected ? "text-green-700" : "text-slate-500"} /></div>
                                                    <span className={`text-xs font-bold ${isAiConnected ? 'text-green-700' : 'text-slate-600'}`}>AI ì„¤ì •</span>
                                                    {isAiConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                                <Btn onClick={onOpenGoogleSheetSetup} className={`py-3 h-auto border border-slate-200 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm transition-all relative ${isGoogleSheetConnected ? 'bg-green-50 ring-2 ring-green-500 ring-offset-1' : 'bg-white hover:bg-slate-50'}`} title="êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isGoogleSheetConnected ? 'bg-green-100' : 'bg-slate-100'}`}><span className="text-lg">ğŸ“Š</span></div>
                                                    <span className={`text-xs font-bold ${isGoogleSheetConnected ? 'text-green-700' : 'text-slate-600'}`}>êµ¬ê¸€ ì‹œíŠ¸</span>
                                                    {isGoogleSheetConnected && <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-0.5 shadow-sm"><Icon d={PATHS.check} size={12} strokeWidth={3} /></div>}
                                                </Btn>
                                            </div>
                                            
                                            {/* ğŸŒŸ ì „ì²´ ì—°ë™ ìƒíƒœ ì ê²€ íŒ¨ë„ (ì´ë™ë¨) */}
                                            <div id="sync-test-panel" className="mt-4 p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner">
                                                <div className="flex justify-between items-center mb-3">
                                                    <div>
                                                        <h4 className="font-bold text-slate-700 flex items-center gap-2 text-xs">
                                                            <span className="text-base">ğŸ”„</span> ì—°ë™ ìƒíƒœ ì ê²€
                                                        </h4>
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={handleTestAllConnections}
                                                        disabled={isTestingAll}
                                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-colors shadow-sm whitespace-nowrap ${isTestingAll ? 'bg-slate-100 text-slate-400' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-100'}`}
                                                    >
                                                        {isTestingAll ? 'ì ê²€ ì¤‘...' : 'ì „ì²´ ì ê²€'}
                                                    </button>
                                                </div>
                                                <div className="space-y-1.5">
                                                    {[
                                                        { id: 'ai', label: 'AI (Gemini)' },
                                                        { id: 'notion_record', label: 'ë…¸ì…˜ (ê¸°ë¡)' },
                                                        { id: 'notion_portfolio', label: 'ë…¸ì…˜ (í¬í´)' },
                                                        { id: 'google', label: 'êµ¬ê¸€ ì‹œíŠ¸' }
                                                    ].map(item => {
                                                        const status = connectionStatus[item.id];
                                                        const isError = status.status === 'error';
                                                        const isSuccess = status.status === 'success';
                                                        const isPending = status.status === 'pending';
                                                        
                                                        return (
                                                            <div key={item.id} className={`flex flex-col p-2 rounded-lg border transition-colors ${isSuccess ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                                                <div className="flex items-center justify-between">
                                                                    <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-600">{item.label}</span></div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={`text-[10px] font-bold ${isError ? 'text-rose-500' : isSuccess ? 'text-emerald-600' : 'text-slate-400'}`}>
                                                                            {isPending ? 'í™•ì¸ ì¤‘...' : isSuccess ? 'ì—°ë™ ì„±ê³µ' : isError ? 'ì—°ë™ ì‹¤íŒ¨' : 'ëŒ€ê¸°'}
                                                                        </span>
                                                                        <div className="w-4 h-4 flex items-center justify-center text-xs">
                                                                            {isPending ? 'â³' : isSuccess ? 'âœ…' : isError ? 'âŒ' : 'âšª'}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {isError && status.message && (
                                                                    <div className="text-[10px] text-rose-500 mt-1 bg-rose-50 p-1.5 rounded border border-rose-100 break-all">
                                                                        {status.message}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {isDevMode && (
                                                <div className="mt-3 pt-3 border-t border-slate-200 animate-fade-in">
                                                    <div className="flex gap-2">
                                                        <Btn onClick={toggleAiSafetyCheck} className={`flex-1 py-2.5 border rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${aiSafetyCheck ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                            <Icon d={aiSafetyCheck ? PATHS.check : PATHS.lock} size={14} />
                                                            AI ì „ì†¡ ë°ì´í„° í™•ì¸ {aiSafetyCheck ? 'ON' : 'OFF'}
                                                        </Btn>
                                                        <Btn onClick={() => setShowAiSafetyHelp(true)} className="px-3 bg-slate-100 text-slate-500 rounded-xl hover:bg-slate-200" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16} /></Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full group">
                                            <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ“Š</div> ë°ì´í„° ìš©ëŸ‰ ë¶„ì„</h4>
                                            <div className="p-4 rounded-2xl border transition-colors shadow-sm bg-slate-50 border-slate-200">
                                                <div className="flex gap-3">
                                                    <div className={`w-3 h-3 rounded-full shadow-sm mt-1.5 flex-shrink-0 ${isLocalMode ? 'bg-slate-400' : 'bg-green-500 animate-pulse'}`}></div>
                                                    <div className="flex-1 flex flex-col">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-1 cursor-pointer hover:opacity-80" onClick={(e) => { e.stopPropagation(); setShowStorageHelp(!showStorageHelp); }}>
                                                                <span className={`font-bold text-sm ${isLocalMode ? 'text-slate-600' : 'text-green-700'}`}>{isLocalMode ? "ë¡œì»¬ ì €ì¥ì†Œ" : "í´ë¼ìš°ë“œ ë™ê¸°í™”"}</span>
                                                                <Icon d={showStorageHelp ? PATHS.down : PATHS.right} size={24} className="text-slate-400 hover:text-indigo-500 transition-colors" />
                                                            </div>
                                                            {isLocalMode ? <Btn onClick={() => { onClose(); onOpenSetup(); }} className="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-50">ì—°ê²°</Btn> : <Btn onClick={() => { openConfirm("ì—°ê²° í•´ì œ?", () => { localStorage.removeItem('checklist_config'); window.location.reload(); }) }} className="text-xs bg-white border border-rose-200 text-rose-500 px-3 py-1.5 rounded-lg font-bold hover:bg-rose-50">í•´ì œ</Btn>}
                                                        </div>
                                                        <div className="flex items-center gap-1.5 mt-2">
                                                            <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${isLocalMode ? 'bg-slate-200' : 'bg-green-200/50'}`}>
                                                                <div className={`h-full rounded-full transition-all duration-500 ${dataUsage.isCritical ? 'bg-rose-500' : dataUsage.isWarning ? 'bg-orange-500' : (isLocalMode ? 'bg-slate-500' : 'bg-green-500')}`} style={{ width: `${Math.min(dataUsage.percent, 100)}%` }}></div>
                                                            </div>
                                                            <span className={`text-[10px] font-mono ${dataUsage.isCritical ? 'text-rose-600 font-bold' : (isLocalMode ? 'text-slate-500' : 'text-green-600 font-bold')}`}>{dataUsage.percent}% ({dataUsage.kb}KB)</span>
                                                        </div>
                                                        
                                                        {showStorageHelp && (
    <div className="mt-3 p-4 bg-slate-100 rounded-2xl border border-slate-200 text-[10px] text-slate-600 leading-relaxed animate-fade-in select-text cursor-auto" onClick={e=>e.stopPropagation()}>
        <div className="flex flex-col gap-4">
            <div className="flex flex-col sm:flex-row gap-4 items-center">
                {/* ë„ë„› ì°¨íŠ¸ */}
                <div className="relative flex items-center justify-center flex-shrink-0" style={{ width: 120, height: 120 }}>
                    <svg width="120" height="120" viewBox="0 0 120 120" className="transform -rotate-90">
                        {(() => {
                            let acc = 0;
                            const r = 45; const c = 2 * Math.PI * r;
                            return dataUsage.details.map((d, i) => {
                                const val = d.percent;
                                const dash = `${(val / 100) * c} ${c}`;
                                const off = -((acc / 100) * c);
                                acc += val;
                                return <circle key={i} cx="60" cy="60" r={r} fill="transparent" stroke={d.color} strokeWidth="20" strokeDasharray={dash} strokeDashoffset={off} />;
                            });
                        })()}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span className="text-[9px] font-bold text-slate-400">Total</span>
                        <span className="text-xs font-black text-slate-700">{dataUsage.kb}KB</span>
                    </div>
                </div>

                {/* ìƒì„¸ ë¦¬ìŠ¤íŠ¸ */}
                <div className="flex-1 w-full space-y-1.5">
                    <p className="font-bold mb-2 text-indigo-600 flex justify-between items-center"><span>ğŸ“Š ìƒì„¸ ë¶„ì„</span></p>
                    <div className="grid grid-cols-1 gap-1.5 max-h-40 overflow-y-auto custom-scroll pr-1">
                        {dataUsage.details.map((d, i) => (
                            <div key={i} className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: d.color }}></div>
                                <span className="flex-1 truncate font-medium text-slate-600">{d.label}</span>
                                <span className="font-mono text-slate-500">{d.percent.toFixed(1)}%</span>
                                <span className="font-mono text-slate-400 w-12 text-right">{d.kb}KB</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            <div className="border-t border-slate-200 pt-3">
                {isLocalMode ? (
                    <div className="text-center py-2">
                        <p className="font-bold mb-1 text-slate-700">ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ ëª¨ë“œ</p>
                        <p className="text-slate-500">í˜„ì¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ë°ì´í„° ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•´ì£¼ì„¸ìš”.</p>
                    </div>
                ) : (
                    <>
                        <p className="font-bold mb-2 text-slate-700 text-[10px] flex items-center justify-center gap-1"><span>ğŸ—ï¸</span> ë°ì´í„° ê´€ë¦¬ êµ¬ì¡°ë„</p>
                        <div className="bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <div className="bg-white border-2 border-orange-200 rounded-lg p-2 mb-2 relative shadow-sm">
                                <div className="absolute -top-2 left-2 bg-orange-100 text-orange-700 text-[9px] px-1.5 rounded font-bold">ë©”ì¸ ë°ì´í„°</div>
                                <div className="flex justify-between items-center mt-1">
                                    <span className="text-slate-600 font-bold">ê¸°ë³¸ ì„¤ì •, í•™ìƒ ëª…ë‹¨</span>
                                    <span className="text-[9px] text-rose-500 font-bold bg-rose-50 px-1 rounded">1MB ì œí•œ âš ï¸</span>
                                </div>
                            </div>
                            <div className="flex justify-center my-1 relative z-10"><Icon d={PATHS.down} size={16} className="text-slate-300 bg-slate-50 rounded-full p-0.5" /></div>
                            <div className="grid grid-cols-4 gap-1 mt-2">
                                <div className="bg-white border-2 border-pink-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-pink-100 text-pink-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê³¼ì œ</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>í• ì¼</div>
                                    <div className="text-[7px] text-pink-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-blue-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ëª¨ë‘ </div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>í¸ì„±</div>
                                    <div className="text-[7px] text-blue-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-purple-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-purple-100 text-purple-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">í™œë™</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ë‚ ì§œë³„<br/>ì²´í¬</div>
                                    <div className="text-[7px] text-purple-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                                <div className="bg-white border-2 border-green-200 rounded-lg p-1 pt-2.5 relative shadow-sm">
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 bg-green-100 text-green-700 text-[8px] px-1 rounded font-bold whitespace-nowrap">ê°œë³„</div>
                                    <div className="text-center text-slate-500 leading-tight text-[8px]">ìƒë‹´<br/>ìƒê¸°ë¶€</div>
                                    <div className="text-[7px] text-green-400 text-center mt-0.5 font-bold">ë¬´ì œí•œ</div>
                                </div>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    </div>
)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* [2ë‹¨] ë°±ì—…/ë³µì› ë° ì •ë¦¬/ì´ˆê¸°í™” */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full flex flex-col justify-between group">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-green-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ’¾</div> ë°ì´í„° ë°±ì—… ë° ë³µì›</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={handleExportJson} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center"><Icon d={PATHS.upload} size={18} className="text-blue-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë°±ì—…</span>
                                                    </Btn>
                                                    <Btn onClick={()=>jsonFileRef.current.click()} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center"><Icon d={PATHS.download} size={18} className="text-green-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ë³µì›</span>
                                                    </Btn>
                                                    <input type="file" ref={jsonFileRef} onChange={handleImportJson} className="hidden" accept=".json" />
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-2 p-4 bg-indigo-50/50 border border-indigo-100 rounded-2xl">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2"><span className="text-xs font-bold text-indigo-800">ìë™ ë°±ì—… ì„¤ì •</span><Btn onClick={() => setShowBackupHelp(!showBackupHelp)} className="text-indigo-400 hover:text-indigo-600"><Icon d={PATHS.help} size={16}/></Btn></div>
                                                    <div onClick={toggleAutoBackup} className={`w-10 h-6 flex items-center rounded-full p-1 cursor-pointer transition-colors ${autoBackupEnabled ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${autoBackupEnabled ? 'translate-x-4' : ''}`}></div></div>
                                                </div>
                                                {autoBackupEnabled && (
                                                    <div className="mt-2 pt-2 border-t border-slate-100 animate-fade-in">
                                                        <div className="flex flex-wrap gap-2 mb-2">{backupTimes.map(t => (<div key={t} className="flex items-center bg-white border border-indigo-100 px-2 py-1 rounded-lg text-xs font-bold text-indigo-700 shadow-sm">{t} <button onClick={()=>removeBackupTime(t)} className="ml-2 text-indigo-300 hover:text-rose-500">Ã—</button></div>))}</div>
                                                        {backupTimes.length < 4 && (<div className="flex gap-2 items-center"><div className="flex border border-slate-300 rounded-lg overflow-hidden bg-white"><select value={ampm} onChange={e=>setAmpm(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600"><option value="AM">ì˜¤ì „</option><option value="PM">ì˜¤í›„</option></select><div className="border-l border-slate-200"></div><select value={hour} onChange={e=>setHour(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i + 1).map(h => (<option key={h} value={h}>{h}ì‹œ</option>))}</select><div className="border-l border-slate-200"></div><select value={minute} onChange={e=>setMinute(e.target.value)} className="p-1.5 text-xs bg-transparent outline-none font-bold text-slate-600">{Array.from({length: 12}, (_, i) => i * 5).map(m => (<option key={m} value={String(m).padStart(2, '0')}>{String(m).padStart(2, '0')}ë¶„</option>))}</select></div><button onClick={addBackupTime} className="bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-600 shadow-sm">ì¶”ê°€</button></div>)}
                                                    </div>
                                                )}
                                                {showBackupHelp && <div className="text-[10px] text-slate-500 mt-1 leading-relaxed bg-white p-2 rounded-lg border border-slate-100 animate-fade-in">ì§€ì •ëœ ì‹œê°„ì— ë¸Œë¼ìš°ì €ë¥¼ ì—´ì–´ë‘ë©´ ìë™ìœ¼ë¡œ ë°±ì—… íŒŒì¼(json)ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. (ìµœëŒ€ 4ê°œ ì„¤ì • ê°€ëŠ¥)</div>}
                                            </div>
                                        </div>

                                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all h-full flex flex-col justify-between group">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-base flex items-center gap-2 mb-5"><div className="w-10 h-10 rounded-2xl bg-rose-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ğŸ§¹</div> ë°ì´í„° ê´€ë¦¬ ë° ì´ˆê¸°í™”</h4>
                                                <div className="grid grid-cols-2 gap-3 mb-3">
                                                    <Btn onClick={() => setShowCleanupModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-rose-50 flex items-center justify-center"><Icon d={PATHS.trash} size={18} className="text-rose-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ë°ì´í„° ì •ë¦¬</span>
                                                    </Btn>
                                                    <Btn onClick={() => setShowManualModal(true)} className="py-3 h-auto bg-white border border-slate-200 rounded-xl hover:bg-slate-50 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                        <div className="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center"><Icon d={PATHS.book} size={18} className="text-orange-500" /></div>
                                                        <span className="text-xs font-bold text-slate-600">ì‚¬ìš© ì„¤ëª…ì„œ</span>
                                                    </Btn>
                                                </div>
                                            </div>
                                            <Btn onClick={() => setShowResetOptions(true)} className="w-full py-3 bg-white border-2 border-rose-100 text-rose-500 rounded-xl font-bold hover:bg-rose-50 transition-colors text-sm flex items-center justify-center gap-2 shadow-sm"><Icon d={PATHS.trash} size={18} /> ë°ì´í„° ì´ˆê¸°í™”</Btn>
                                        </div>
                                    </div>

                                    {/* [3ë‹¨] ê´€ë¦¬ì ë©”ë‰´ */}
                                    {isAdminMode && (
                                        <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm animate-fade-in mt-2">
                                            <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><span className="text-lg">ğŸ‘‘</span> ê´€ë¦¬ì ë©”ë‰´</h4>
                                            <div className="grid grid-cols-2 gap-3 mb-4">
                                                <Btn onClick={handleDownloadHtml} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.download} size={16} className="text-indigo-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">íŒŒì¼ë¡œ ì €ì¥</span>
                                                </Btn>
                                                <Btn onClick={handleCopyCode} className="py-3 h-auto bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 flex flex-col items-center justify-center gap-1 shadow-sm transition-all">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center"><Icon d={PATHS.code} size={16} className="text-slate-500" /></div>
                                                    <span className="text-xs font-bold text-slate-600">ì½”ë“œ ë³µì‚¬</span>
                                                </Btn>
                                            </div>
                                            <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden shadow-inner">
                                                <div className="flex justify-between items-center py-3 px-4 cursor-pointer hover:bg-slate-100 transition-colors select-none" onClick={() => setShowCodeUpdater(!showCodeUpdater)}>
                                                    <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">ğŸ› ï¸ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ</h3>
                                                    <Icon d={showCodeUpdater ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                                </div>
                                                
                                                {showCodeUpdater && (
                                                    <div className="p-4 pt-2 animate-fade-in space-y-3 border-t border-slate-200 bg-white">
                                                        <p className="text-xs text-slate-500 mt-2 font-bold flex items-center gap-1"><Icon d={PATHS.document} size={12}/> ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                                                        <textarea value={updateCodeInput} onChange={(e) => setUpdateCodeInput(e.target.value)} className="w-full h-32 p-3 rounded-xl bg-slate-50 text-slate-700 text-xs font-mono border border-slate-300 focus:border-indigo-500 outline-none custom-scroll shadow-inner" placeholder="<!DOCTYPE html>..."/>
                                                        <div className="grid grid-cols-2 gap-3 mt-2">
                                                            <Btn onClick={handleApplyCode} className="py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-xs transition-colors">ì¦‰ì‹œ ì‹¤í–‰ (ë¯¸ë¦¬ë³´ê¸°)</Btn>
                                                            <Btn onClick={handleSaveCodeFile} className="py-2.5 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-md text-xs transition-colors">íŒŒì¼ë¡œ ì €ì¥ (ê¶Œì¥)</Btn>
                                                        </div>
                                                        <p className="text-[10px] text-orange-500 text-center font-bold bg-orange-50 p-2 rounded-lg mt-2">* ì¦‰ì‹œ ì‹¤í–‰ ì‹œ ë°ì´í„° ì•ˆì „ì„ ìœ„í•´ ê°€ê¸‰ì  ìë™ ë°±ì—… ì„¤ì • í›„ ì§„í–‰í•˜ì„¸ìš”.</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            <DataCleanupModal isOpen={showCleanupModal} onClose={() => setShowCleanupModal(false)} groupsByDate={groupsByDate} records={records} setGroupsByDate={setGroupsByDate} setRecords={setRecords} saveData={saveData} isLocalMode={isLocalMode} showToast={showToast} onBackup={handleExportJson} />
                        </div>
                    </div>
                    <AiSafetyHelpModal isOpen={showAiSafetyHelp} onClose={() => setShowAiSafetyHelp(false)} />
                    <ResetOptionsModal isOpen={showResetOptions} onClose={() => setShowResetOptions(false)} onReset={handleResetAllData} />
                </BaseModal>
            );
        };

        const BalanceVisualizer = ({ groups, students, groupNames, date }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const [detailGroup, setDetailGroup] = useState(null);

            if (!groups || groups.length === 0) return null;
            return (
                <>
                    <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-auto transition-all duration-300">
                        <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsExpanded(!isExpanded)}>
                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><Icon d={PATHS.chart} size={18} className="text-indigo-500" /> ëª¨ë‘  ë¶„ì„ ê²°ê³¼ <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">ë”ë¸”í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</span></h4>
                            <Icon d={isExpanded ? PATHS.down : PATHS.right} size={20} className="text-slate-400" />
                        </div>
                        {isExpanded && (
                            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 animate-fade-in">
                                {groups.map((g, i) => {
                                    if (g.length === 0) return null;
                                    const m = g.filter(s => s.gender === 'M'); const f = g.filter(s => s.gender === 'F');
                                    const high = g.filter(s => s.skill === 3); const mid = g.filter(s => s.skill === 2); const low = g.filter(s => s.skill === 1);
                                    const avgSkill = g.reduce((acc, s) => acc + s.skill, 0) / g.length;
                                    const groupName = groupNames[date]?.[i] || `${i + 1}ëª¨ë‘ `;
                                    const leader = g.find(s => s.leader);
                                    return (
                                        <div key={i} onDoubleClick={() => setDetailGroup({ index: i, students: g, name: groupName })} className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer group">
                                            <div className="flex justify-between items-center mb-3"><span className="font-bold text-slate-700 text-base truncate" title={groupName}>{groupName}</span><span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full font-bold">{g.length}ëª…</span></div>
                                            <div className="space-y-4">
                                                <div>
                                                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span className="text-blue-500">ë‚¨ {m.length}</span><span className="text-pink-500">ì—¬ {f.length}</span></div>
                                                    <div className="w-full bg-slate-100 rounded-xl overflow-hidden flex text-[10px] leading-tight min-h-[24px]">
                                                        {m.length > 0 && <div style={{ width: `${(m.length/g.length)*100}%` }} className="bg-blue-400 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{m.map(s => <span key={s.id}>{s.name}{s.leader && 'ğŸ‘‘'}</span>)}</div>}
                                                        {f.length > 0 && <div style={{ width: `${(f.length/g.length)*100}%` }} className="bg-pink-400 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{f.map(s => <span key={s.id}>{s.name}{s.leader && 'ğŸ‘‘'}</span>)}</div>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs text-slate-500 mb-1 font-bold"><span>ì‹¤ë ¥ ë¶„í¬ (í‰ê·  {avgSkill.toFixed(1)})</span></div>
                                                    <div className="w-full bg-slate-100 rounded-xl overflow-hidden flex text-[10px] leading-tight min-h-[24px]">
                                                        {low.length > 0 && <div style={{ width: `${(low.length/g.length)*100}%` }} className="bg-slate-300 text-slate-700 p-1 flex flex-wrap gap-1 justify-center items-center content-center">{low.map(s => <span key={s.id}>{s.name}{s.leader && 'ğŸ‘‘'}</span>)}</div>}
                                                        {mid.length > 0 && <div style={{ width: `${(mid.length/g.length)*100}%` }} className="bg-indigo-300 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{mid.map(s => <span key={s.id}>{s.name}{s.leader && 'ğŸ‘‘'}</span>)}</div>}
                                                        {high.length > 0 && <div style={{ width: `${(high.length/g.length)*100}%` }} className="bg-indigo-500 text-white p-1 flex flex-wrap gap-1 justify-center items-center content-center">{high.map(s => <span key={s.id}>{s.name}{s.leader && 'ğŸ‘‘'}</span>)}</div>}
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-0.5"><span>í•˜ {low.length}</span><span>ì¤‘ {mid.length}</span><span>ìƒ {high.length}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    {detailGroup && (
                        <BaseModal isOpen={!!detailGroup} onClose={() => setDetailGroup(null)} title={`${detailGroup.name} ìƒì„¸ ì •ë³´`} icon={PATHS.chart}>
                            <div className="space-y-6">
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200"><h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">ğŸ‘« ì„±ë³„ êµ¬ì„±</h4><div className="grid grid-cols-2 gap-4"><div className="bg-white p-3 rounded-xl border border-blue-100"><div className="text-xs font-bold text-blue-500 mb-2">ë‚¨í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='M').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='M').map(s => (<span key={s.id} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='M').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div><div className="bg-white p-3 rounded-xl border border-pink-100"><div className="text-xs font-bold text-pink-500 mb-2">ì—¬í•™ìƒ ({detailGroup.students.filter(s=>s.gender==='F').length}ëª…)</div><div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.gender==='F').map(s => (<span key={s.id} className="text-xs bg-pink-50 text-pink-700 px-2 py-1 rounded border border-pink-100">{s.name}</span>))}{detailGroup.students.filter(s=>s.gender==='F').length === 0 && <span className="text-xs text-slate-400">-</span>}</div></div></div></div>
                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                                    <div className="flex justify-between items-end mb-4">
                                        <h4 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“Š ì‹¤ë ¥ ë¶„í¬</h4>
                                        <span className="text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">í‰ê·  {(detailGroup.students.reduce((a,b)=>a+b.skill,0) / detailGroup.students.length).toFixed(1)}</span>
                                    </div>
                                    <div className="h-4 w-full bg-white rounded-full overflow-hidden flex mb-4 border border-slate-100 shadow-inner">
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===3).length/detailGroup.students.length)*100}%` }} className="bg-indigo-500 h-full transition-all duration-500" title="ìƒ"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===2).length/detailGroup.students.length)*100}%` }} className="bg-indigo-300 h-full transition-all duration-500" title="ì¤‘"></div>
                                        <div style={{ width: `${(detailGroup.students.filter(s=>s.skill===1).length/detailGroup.students.length)*100}%` }} className="bg-slate-300 h-full transition-all duration-500" title="í•˜"></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-white p-3 rounded-xl border border-indigo-100 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-600 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ìƒ</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===3).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===3).map(s => <span key={s.id} className="text-[11px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===3).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-indigo-50 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-indigo-400 border-b border-indigo-50 pb-1 flex justify-between items-center"><span>ì¤‘</span> <span className="bg-indigo-50 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===2).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===2).map(s => <span key={s.id} className="text-[11px] bg-indigo-50/50 text-indigo-600 px-1.5 py-0.5 rounded border border-indigo-100">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===2).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col gap-2 shadow-sm">
                                            <div className="text-xs font-bold text-slate-500 border-b border-slate-100 pb-1 flex justify-between items-center"><span>í•˜</span> <span className="bg-slate-100 px-1.5 rounded-full">{detailGroup.students.filter(s=>s.skill===1).length}</span></div>
                                            <div className="flex flex-wrap gap-1">{detailGroup.students.filter(s=>s.skill===1).map(s => <span key={s.id} className="text-[11px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">{s.name}</span>)}{detailGroup.students.filter(s=>s.skill===1).length===0 && <span className="text-[10px] text-slate-300">-</span>}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </BaseModal>
                    )}
                </>
            );
        };

        const ProgressBar = ({ progress, appConfig }) => (
            <div className="w-full max-w-xl mx-auto px-6 mt-1 mb-3">
                <div className="flex justify-between text-xs font-bold text-slate-400 mb-6">
                    <span>Start</span>
                    <span className={progress===100?"text-indigo-600 animate-bounce":"text-slate-600"}>
                        {progress===100?appConfig.recordMsg:`${Math.round(progress)}%`}
                    </span>
                </div>
                <div className="relative h-1.5 bg-slate-200 rounded-full shadow-inner">
                    <div className="absolute left-0 top-0 h-full bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full transition-all duration-700 ease-out" style={{ width: `${progress}%` }}>
                        <div className="absolute -right-4 -top-5 w-8 h-8 bg-white rounded-full shadow-md border border-slate-50 flex items-center justify-center transform transition-transform hover:scale-110 z-10 cursor-pointer">
                            <span className="text-lg filter drop-shadow-sm select-none">
                                {appConfig.runner.startsWith('data:image') ? <img src={appConfig.runner} className="w-5 h-5 object-contain"/> : appConfig.runner}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        );
        
        const RecordView = ({ students, records, dailyTasks, date, toggleCheck, appConfig, stats, onLongPress }) => {
            const getStreakBadge = (studentId) => {
                const s = stats.students.find(st => st.id === studentId);
                if(!s) return null;
                if(s.streak >= 30) return "ğŸŒŸ";
                if(s.streak >= 7) return "ğŸ”¥";
                if(s.streak >= 3) return "ğŸŒ±";
                return null;
            };
            
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);

            const handleTouchStart = (id) => {
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    if (navigator.vibrate) navigator.vibrate(15);
                    onLongPress(id);
                }, 1000);
            };

            const handleTouchEnd = () => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
            };

            return (
                <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const rec = records[date]?.[s.id] || { done: false, tasks: {} };
                        const currentTasks = dailyTasks[date] || [];
                        const isDone = rec.done;
                        const showPhoto = false;

                        return (
                            <div key={s.id} 
                                onMouseDown={() => handleTouchStart(s.id)} 
                                onMouseUp={handleTouchEnd} 
                                onMouseLeave={handleTouchEnd}
                                onTouchStart={() => handleTouchStart(s.id)} 
                                onTouchEnd={handleTouchEnd}
                                onClick={() => { if (!isLongPress.current) toggleCheck(s.id); }}
                                onDoubleClick={(e) => { e.preventDefault(); onLongPress(s.id); }}
                                className={`group relative flex flex-col bg-white rounded-md border transition-all duration-200 cursor-pointer overflow-hidden hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                {showPhoto ? (
                                    <div className="w-full aspect-[4/3] bg-gray-50 relative border-b border-notion-border">
                                        <img src={s.photo} className="w-full h-full object-cover" alt={s.name} />
                                        {isDone && <div className="absolute inset-0 bg-notion-blue/20 flex items-center justify-center backdrop-blur-[1px] transition-all"><div className="bg-notion-blue text-white rounded-full p-1.5 shadow-md"><Icon d={PATHS.check} size={20} /></div></div>}
                                    </div>
                                ) : (
                                    <div className={`h-1 w-full transition-colors duration-200 ${isDone ? 'bg-notion-blue' : 'bg-transparent'}`}></div>
                                )}
                                <div className="p-3 flex flex-col h-full min-h-[100px]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex flex-col">
                                            <span className="text-sm font-bold text-notion-text flex items-center gap-1">
                                                {s.name} <span className="text-xs">{getStreakBadge(s.id)}</span>
                                            </span>
                                            <span className="text-[10px] text-notion-text-light">{s.order}ë²ˆ</span>
                                        </div>
                                        <div className={`transition-all duration-200 ${isDone ? 'text-notion-blue opacity-100' : 'text-notion-border opacity-0 group-hover:opacity-100'} ${showPhoto ? 'hidden' : ''}`}>
                                            <Icon d={PATHS.check} size={16} />
                                        </div>
                                    </div>
                                    {currentTasks.length > 0 ? (
                                        <div className="space-y-1 mt-1 flex-1">
                                            {currentTasks.map((t, idx) => {
                                                const taskDone = rec.tasks?.[idx];
                                                return (
                                                    <div key={idx} onClick={(e) => { e.stopPropagation(); toggleCheck(s.id, idx); }} className="flex items-center gap-2 p-1 rounded hover:bg-notion-bg-alt group/task transition-colors">
                                                        <div className={`w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${taskDone ? 'bg-notion-blue border-notion-blue text-white' : 'border-notion-border bg-white group-hover/task:border-notion-text-light'}`}>
                                                            {taskDone && <Icon d={PATHS.check} size={10} />}
                                                        </div>
                                                        <span className={`text-xs truncate flex-1 ${taskDone ? 'text-notion-text-light line-through' : 'text-notion-text'}`}>
                                                            {typeof t === 'object' ? t.title : t}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center">
                                            {isDone ? <span className="text-xs text-notion-blue font-medium bg-blue-50 px-2 py-1 rounded">ì™„ë£Œ</span> : <span className="text-xs text-notion-text-light bg-notion-bg-alt px-2 py-1 rounded">ë¯¸ì™„ë£Œ</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SimpleView = ({ students, simpleChecks, toggleCheck, onLongPress }) => {
            return (
                <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 animate-fade-in pb-10">
                    {students.map(s => {
                        const isDone = simpleChecks[s.id];
                        return (
                            <div key={s.id} onClick={() => toggleCheck(s.id)} onDoubleClick={(e) => { if(onLongPress) { e.preventDefault(); onLongPress(s.id); } }} className={`group relative flex flex-col items-center justify-center p-6 bg-white rounded-md border transition-all duration-200 cursor-pointer hover:bg-notion-bg-hover ${isDone ? "border-notion-blue shadow-sm" : "border-notion-border shadow-sm hover:shadow-md"}`}>
                                <div className={`text-xl font-bold mb-1 ${isDone ? 'text-notion-blue' : 'text-notion-text'}`}>{s.name}</div>
                                <div className="text-xs text-notion-text-light">{s.order}ë²ˆ</div>
                                {isDone && <div className="absolute top-2 right-2 text-notion-blue"><Icon d={PATHS.check} size={16} /></div>}
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        let UPDATE_NOTES = [
            { version: "ë¡œë”© ì¤‘...", date: "", changes: ["ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤."] }
        ];

        const UpdateNotesModal = ({ isOpen, onClose, showToast, notes }) => {
            const [expandedGroups, setExpandedGroups] = useState({ 0: true });
            const [showMajorOnly, setShowMajorOnly] = useState(false);
            const [selectedNote, setSelectedNote] = useState(null);
            
            const currentNotes = notes || UPDATE_NOTES;

            const filteredNotes = useMemo(() => {
                return showMajorOnly 
                    ? currentNotes.filter(note => {
                        if (note.version.endsWith('.0')) return true;
                        const content = (note.list || note.changes || []).join(' ');
                        return content.includes('ì¶”ê°€') || content.includes('ê¸°ëŠ¥') || content.includes('ê°•í™”') || content.includes('ê°œì„ ');
                    })
                    : currentNotes;
            }, [showMajorOnly, currentNotes]);
            
            const groups = useMemo(() => {
                const result = [];
                let lastGroup = null;

                filteredNotes.forEach(item => {
                    const key = item.version.split('.').slice(0, 2).join('.');
                    if (!lastGroup || lastGroup.key !== key) {
                        lastGroup = { key, items: [] };
                        result.push(lastGroup);
                    }
                    lastGroup.items.push(item);
                });
                return result;
            }, [filteredNotes]);
            
            useEffect(() => { if (isOpen) setExpandedGroups({ 0: true }); }, [isOpen]);

            if (!isOpen) return null;
            
            const handleCopyEmail = () => {
                navigator.clipboard.writeText("spk@smca.or.kr");
                if (showToast) showToast("ì´ë©”ì¼ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            };

            const toggleGroup = (index) => {
                setExpandedGroups(prev => ({ ...prev, [index]: !prev[index] }));
            };

            const navigateNote = (direction) => {
                if (!selectedNote) return;
                const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < filteredNotes.length) {
                    setSelectedNote(filteredNotes[newIndex]);
                }
            };

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—…ë°ì´íŠ¸ ë…¸íŠ¸" icon={PATHS.list} footer={
                    <div onClick={handleCopyEmail} className="block w-full py-2 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-center text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 cursor-pointer hover:bg-indigo-100 transition-colors select-none active:scale-95">
                        <div className="flex items-center gap-2"><span>ğŸ’¡</span> ìƒˆë¡œìš´ ê¸°ëŠ¥ ì œì•ˆí•˜ê¸° <span className="text-indigo-300 hidden sm:inline">|</span></div>
                        <div className="flex items-center gap-1"><span className="underline decoration-indigo-300 underline-offset-4">spk@smca.or.kr</span><span className="text-xs font-normal text-indigo-400 no-underline">(í´ë¦­í•˜ì—¬ ë³µì‚¬)</span></div>
                    </div>
                }>
                    <div className="flex justify-end mb-3 px-1">
                        <label className="flex items-center gap-2 cursor-pointer select-none group">
                            <span className="text-xs font-bold text-slate-500 group-hover:text-indigo-600 transition-colors">ì£¼ìš” ë³€ê²½ ì‚¬í•­ë§Œ ë³´ê¸°</span>
                            <div className={`w-9 h-5 rounded-full p-1 transition-colors duration-300 ${showMajorOnly ? 'bg-indigo-500' : 'bg-slate-200'}`}>
                                <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform duration-300 ${showMajorOnly ? 'translate-x-4' : ''}`}></div>
                            </div>
                            <input type="checkbox" checked={showMajorOnly} onChange={e => setShowMajorOnly(e.target.checked)} className="hidden" />
                        </label>
                    </div>
                    <div className="space-y-3">
                        {groups.length > 0 ? groups.map((group, groupIndex) => {
                            const isExpanded = !!expandedGroups[groupIndex];
                            return (
                                <div key={group.key} className="border border-slate-200 rounded-xl overflow-hidden bg-white">
                                    <div 
                                        className="px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors select-none bg-slate-50/50"
                                        onClick={() => toggleGroup(groupIndex)}
                                    >
                                        <h4 className="font-bold text-slate-700 text-base flex items-center gap-2">
                                            {group.key}.x 
                                            <span className="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-100">
                                                {group.items.length}ê°œ ì—…ë°ì´íŠ¸
                                            </span>
                                        </h4>
                                        <Icon d={PATHS.down} size={16} className={`text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                    
                                    {isExpanded && (
                                        <div className="px-4 pb-4 pt-2 space-y-6 border-t border-slate-100">
                                            {group.items.map((update, i) => (
                                                <div key={i} className="relative pl-4 border-l-2 border-slate-200">
                                                    <div className={`absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full ${groupIndex === 0 && i === 0 ? 'bg-indigo-500 ring-4 ring-indigo-100' : 'bg-slate-300'}`}></div>
                                                    <div className="flex justify-between items-baseline mb-2 cursor-pointer group/title" onClick={() => setSelectedNote(update)}>
                                                        <h5 className={`font-bold text-sm flex items-center gap-2 ${groupIndex === 0 && i === 0 ? 'text-indigo-600' : 'text-slate-700'} group-hover/title:text-indigo-500 transition-colors`}>
                                                            {update.version}
                                                            {groupIndex === 0 && i === 0 && <span className="bg-rose-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">NEW</span>}
                                                            <Icon d={PATHS.right} size={12} className="opacity-0 group-hover/title:opacity-100 transition-opacity text-slate-400 -ml-1" />
                                                        </h5>
                                                    </div>
                                                    <ul className="space-y-1">
                                                        {(update.list || update.changes).map((change, j) => (
                                                            <li key={j} className="text-sm text-slate-600 flex items-start gap-2">
                                                                <span className="text-slate-400 mt-1.5 text-[6px]">â—</span>
                                                                <span className="flex-1 leading-relaxed">{change}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : <div className="text-center text-slate-400 py-8 text-sm">í•´ë‹¹í•˜ëŠ” ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                    {selectedNote && (() => {
                        const currentIndex = filteredNotes.findIndex(note => note.version === selectedNote.version);
                        return (
                            <div className="fixed inset-0 z-[2000] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                                <div className="absolute inset-0 bg-black/30 backdrop-blur-sm animate-fade-in" onClick={() => setSelectedNote(null)}></div>
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative z-10 animate-pop-up border border-slate-200 flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold text-indigo-600">{selectedNote.version}</h3>
                                        </div>
                                        <button onClick={() => setSelectedNote(null)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><Icon d={PATHS.x} /></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                                        <div className="space-y-3">
                                            {(selectedNote.list || selectedNote.changes).map((change, i) => (
                                                <div key={i} className="flex gap-3 text-sm text-slate-700 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <span className="text-indigo-500 font-bold mt-0.5">v</span>
                                                    <span>{change}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-slate-100">
                                        <div className="flex justify-between items-center gap-2">
                                            <Btn onClick={() => navigateNote(-1)} disabled={currentIndex === 0} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                <Icon d={PATHS.left} size={16} /> ì´ì „
                                            </Btn>
                                            <Btn onClick={() => setSelectedNote(null)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm">
                                                í™•ì¸
                                            </Btn>
                                            <Btn onClick={() => navigateNote(1)} disabled={currentIndex === filteredNotes.length - 1} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                                ë‹¤ìŒ <Icon d={PATHS.right} size={16} />
                                            </Btn>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </BaseModal>
            );
        };

        const SeatChart = ({ students, seatAssignments, setSeatAssignments, seatConfig, setSeatConfig, saveData, isLocalMode, showToast, openConfirm, groups, onGroupsChange, groupNumber, groupMethod, roleMap, onOpenStudentInfo }) => {
            const [isLayoutMode, setIsLayoutMode] = useState(false);
            const [selectedSeat, setSelectedSeat] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const seatChartRef = useRef(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const clickRef = useRef({ key: null, count: 0, lastTime: 0 });

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // [í•µì‹¬ ìˆ˜ì • 1] ë“œë˜ê·¸ ì‹œì‘: ë°ì´í„°ë¥¼ window ê°ì²´ì— ì§ì ‘ ì €ì¥ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
            const handleDragStart = (e, studentId, fromSeat) => {
                if (isLayoutMode) { e.preventDefault(); return; }
                
                console.log("Drag Start:", studentId, fromSeat); // ë””ë²„ê¹…ìš©

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ê³¼ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë¨)
                window.__dragData = { studentId, fromSeat };
                
                // ë°ì´í„° ì „ì†¡ ì„¤ì •
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromSeat }));
                
                const target = e.currentTarget;
                // ìŠ¤íƒ€ì¼ ì ìš© (ë¹„ë™ê¸°)
                requestAnimationFrame(() => {
                    target.classList.add("dragging");
                    document.body.classList.add('is-dragging-seat');
                });
            };

            const handleDragEnd = (e) => {
                console.log("Drag End");
                e.currentTarget.classList.remove("dragging");
                document.body.classList.remove('is-dragging-seat');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
                window.__dragData = null; // ì´ˆê¸°í™”
            };

            // [í•µì‹¬ ìˆ˜ì • 2] ë“œë˜ê·¸ ì˜¤ë²„: ë¬´ì¡°ê±´ í—ˆìš© (preventDefault í•„ìˆ˜)
            const handleDragOver = (e) => {
                e.preventDefault(); // ì´ê²Œ ì—†ìœ¼ë©´ Dropì´ ì•ˆë¨
                e.stopPropagation();
                if (!isLayoutMode) {
                    e.dataTransfer.dropEffect = "move";
                    if (!e.currentTarget.classList.contains("drag-over")) {
                        e.currentTarget.classList.add("drag-over");
                    }
                }
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove("drag-over");
            };

            // [í•µì‹¬ ìˆ˜ì • 3] ë“œë¡­ ë¡œì§: ì „ì—­ ë°ì´í„° ìš°ì„  ì‚¬ìš©
            const handleDrop = (e, r, c) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-seat');
                
                if (isLayoutMode) return;

                try {
                    // 1ìˆœìœ„: window ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    let data = window.__dragData;
                    
                    // 2ìˆœìœ„: dataTransferì—ì„œ íŒŒì‹± (ë°±ì—…)
                    if (!data) {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    }

                    console.log("Drop Data Received:", data); // ë””ë²„ê¹…ìš©

                    if (!data || !data.studentId) {
                        console.error("No drag data found");
                        return;
                    }

                    const { studentId, fromSeat } = data;
                    const toSeat = `${r}-${c}`;
                    
                    // ê°™ì€ ìë¦¬ë©´ ë¬´ì‹œ
                    if (fromSeat === toSeat) return;
                    // ë¹„í™œì„± ì¢Œì„ì´ë©´ ë¬´ì‹œ
                    if ((seatConfig.disabledSeats || []).includes(toSeat)) return;

                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[toSeat]; // ë„ì°©ì§€ì— ìˆëŠ” í•™ìƒ

                    // ë¡œì§ A: ê¸°ì¡´ ìë¦¬ì—ì„œ ì œê±° (ëŒ€ê¸°ëª…ë‹¨ì—ì„œ ì™”ìœ¼ë©´ fromSeatëŠ” nullì´ë¼ ë¬´ì‹œë¨)
                    if (fromSeat) delete newAssignments[fromSeat];

                    // ë¡œì§ B: ë„ì°©ì§€ì— í•™ìƒ ë°°ì¹˜
                    newAssignments[toSeat] = studentId;

                    // ë¡œì§ C: êµí™˜ (Swap) - ë„ì°©ì§€ì— í•™ìƒì´ ìˆì—ˆê³ , ì¶œë°œì§€ê°€ ì¢Œì„ì¸ ê²½ìš°
                    if (targetStudentId && fromSeat) {
                        newAssignments[fromSeat] = targetStudentId;
                    }
                    // ë„ì°©ì§€ì— í•™ìƒì´ ìˆì—ˆëŠ”ë° ì¶œë°œì§€ê°€ ëŒ€ê¸°ëª…ë‹¨ì´ë©´? -> ë„ì°©ì§€ í•™ìƒì€ ê·¸ëƒ¥ ë®ì–´ì”Œì›Œì§ (ìë™ìœ¼ë¡œ ëŒ€ê¸°ëª…ë‹¨ìœ¼ë¡œ ê°)

                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    
                } catch (err) {
                    console.error("Drop Error:", err);
                    if(showToast) showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                } finally {
                    window.__dragData = null; // ì •ë¦¬
                }
            };

            // ... (handleSeatClick, handleStudentClick, handleRightClick ë“± ë‚˜ë¨¸ì§€ í•¨ìˆ˜ëŠ” ê¸°ì¡´ ìœ ì§€) ...
            // ì½”ë“œê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ ìœ„ ë“œë˜ê·¸ ë¡œì§ ì´ì™¸ì˜ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.
            // ì•„ë˜ëŠ” ë Œë”ë§ ë¶€ë¶„ì…ë‹ˆë‹¤.

            // (Helper í•¨ìˆ˜ë“¤ ìƒëµ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš© - ìœ„ìª½ ì½”ë“œ ì°¸ê³ í•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”)
            // handleSeatClick, handleStudentClick, handleLoadGroups, handleSaveSeatsToGroups, 
            // handleRightClick, unassignedStudents, handleDownloadImage ë“±...
            
            // í¸ì˜ë¥¼ ìœ„í•´ ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ ë“œë¦¬ëŠ” ëŒ€ì‹ , 
            // ìœ„ì—ì„œ ìˆ˜ì •í•œ handleDragStart, handleDragOver, handleDrop í•¨ìˆ˜ë§Œ 
            // ê¸°ì¡´ SeatChart ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ë®ì–´ì“°ì…”ë„ ë©ë‹ˆë‹¤. 
            // í•˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ í•˜ê¸° ìœ„í•´ SeatChart ë‚´ë¶€ ë Œë”ë§ ë¶€ë¶„(return)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.

            /* ========== [ë Œë”ë§ ë¶€ë¶„ ì²´í¬ í¬ì¸íŠ¸] ========== */
            /* ëŒ€ê¸° ëª…ë‹¨ ë Œë”ë§ ë¶€ë¶„ì—ì„œ 
               draggable="true"
               onDragStart={(e) => handleDragStart(e, s.id, null)} 
               ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤. fromSeat ì¸ìì— 'null'ì„ ë„˜ê¸°ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            */

            const handleSeatClick = (r, c) => {
                const seatKey = `${r}-${c}`;
                if (isLayoutMode) {
                    const disabled = seatConfig.disabledSeats || [];
                    let newDisabled;
                    if (disabled.includes(seatKey)) newDisabled = disabled.filter(k => k !== seatKey);
                    else {
                        if (seatAssignments[seatKey]) {
                            const newAssignments = { ...seatAssignments };
                            delete newAssignments[seatKey];
                            setSeatAssignments(newAssignments);
                            if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        }
                        newDisabled = [...disabled, seatKey];
                    }
                    const newConfig = { ...seatConfig, disabledSeats: newDisabled };
                    setSeatConfig(newConfig);
                    if (!isLocalMode) saveData('cls_seat_config', newConfig);
                    return;
                }

                if ((seatConfig.disabledSeats || []).includes(seatKey)) return;

                // [New] íŠ¸ë¦¬í”Œ í´ë¦­ ê°ì§€ (ëª¨ë°”ì¼ ìš°í´ë¦­ ëŒ€ì²´)
                const now = Date.now();
                if (clickRef.current.key === seatKey && (now - clickRef.current.lastTime < 500)) {
                    clickRef.current.count += 1;
                } else {
                    clickRef.current.key = seatKey;
                    clickRef.current.count = 1;
                }
                clickRef.current.lastTime = now;

                if (clickRef.current.count === 3) {
                    if (seatAssignments[seatKey]) {
                        const newAssignments = { ...seatAssignments };
                        delete newAssignments[seatKey];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        if (selectedSeat === seatKey) setSelectedSeat(null);
                        if(showToast) showToast("ëŒ€ê¸° ëª…ë‹¨ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    clickRef.current.count = 0;
                    return;
                }

                if (selectedStudentId) {
                    const newAssignments = { ...seatAssignments };
                    const targetStudentId = newAssignments[seatKey];
                    
                    const oldSeat = Object.keys(newAssignments).find(k => newAssignments[k] === selectedStudentId);
                    
                    if (oldSeat) delete newAssignments[oldSeat];
                    newAssignments[seatKey] = selectedStudentId;
                    
                    if (targetStudentId && oldSeat) {
                        newAssignments[oldSeat] = targetStudentId;
                    }
                    
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedStudentId(null);
                    setSelectedSeat(null);
                    return;
                }

                if (selectedSeat === seatKey) setSelectedSeat(null);
                else {
                    if (selectedSeat && seatAssignments[selectedSeat]) {
                        const sourceStudentId = seatAssignments[selectedSeat];
                        const targetStudentId = seatAssignments[seatKey];
                        const newAssignments = { ...seatAssignments };
                        newAssignments[seatKey] = sourceStudentId;
                        if (targetStudentId) newAssignments[selectedSeat] = targetStudentId;
                        else delete newAssignments[selectedSeat];
                        setSeatAssignments(newAssignments);
                        if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                        setSelectedSeat(null);
                    } else setSelectedSeat(seatKey);
                }
            };

            const handleStudentClick = (studentId) => {
                if (selectedSeat) {
                    const newAssignments = { ...seatAssignments };
                    const currentSeat = Object.keys(newAssignments).find(k => newAssignments[k] === studentId);
                    const targetStudentId = newAssignments[selectedSeat];
                    if (currentSeat) {
                        if (targetStudentId) newAssignments[currentSeat] = targetStudentId;
                        else delete newAssignments[currentSeat];
                    }
                    newAssignments[selectedSeat] = studentId;
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    setSelectedSeat(null);
                    setSelectedStudentId(null);
                } else {
                    const currentSeat = Object.keys(seatAssignments).find(k => seatAssignments[k] === studentId);
                    if (currentSeat) {
                        if (selectedSeat === currentSeat) setSelectedSeat(null);
                        else setSelectedSeat(currentSeat);
                        setSelectedStudentId(null);
                    } else {
                        setSelectedStudentId(prev => prev === studentId ? null : studentId);
                    }
                }
            };

            const handleLoadGroups = () => {
                if (!groups || groups.length === 0) return showToast("í¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                openConfirm("ëª¨ë‘  ê²°ê³¼ë¥¼ ìë¦¬ ë°°ì¹˜ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë°°ì¹˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤)", () => {
                    const newAssignments = {};
                    const flatStudents = groups.flat().filter(s => s && s.id);
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    showToast("ëª¨ë‘  ê²°ê³¼ê°€ ìë¦¬ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleSaveSeatsToGroups = () => {
                const assignedIds = Object.values(seatAssignments);
                if (assignedIds.length === 0) return showToast("ë°°ì¹˜ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                
                openConfirm("í˜„ì¬ ìë¦¬ ë°°ì¹˜ë¥¼ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ëª¨ë‘ ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)", () => {
                    const sortedAssignments = [];
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if (seatAssignments[key]) sortedAssignments.push(seatAssignments[key]);
                        }
                    }
                    const currentStudents = sortedAssignments.map(id => students.find(s => s.id === id)).filter(s => s).map(s => ({
                        id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order
                    }));
                    const newGroups = [];
                    let chunkSize = groupMethod === 'size' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    for (let i = 0; i < currentStudents.length; i += chunkSize) {
                        newGroups.push(currentStudents.slice(i, i + chunkSize));
                    }
                    onGroupsChange(newGroups);
                    showToast("ìë¦¬ ë°°ì¹˜ê°€ ëª¨ë‘  ê²°ê³¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            const handleRightClick = (e, seatKey) => {
                e.preventDefault();
                e.stopPropagation();
                if (isLayoutMode) return;
                
                if (seatAssignments[seatKey]) {
                    const newAssignments = { ...seatAssignments };
                    delete newAssignments[seatKey];
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                    if (selectedSeat === seatKey) setSelectedSeat(null);
                }
            };

            const unassignedStudents = students.filter(s => !Object.values(seatAssignments).includes(s.id));

            const handleDownloadImage = async () => {
                if (!seatChartRef.current) return;
                try {
                    const canvas = await window.html2canvas(seatChartRef.current, {
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        onclone: (doc) => {
                            const waitingList = doc.getElementById('seat-waiting-list');
                            if (waitingList) waitingList.style.display = 'none';
                        }
                    });
                    const link = document.createElement('a');
                    link.download = `ìë¦¬ë°°ì¹˜ë„_${dayjs().format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    if(showToast) showToast("ìë¦¬ ë°°ì¹˜ë„ê°€ ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ìë¦¬ ë°°ì¹˜ë„ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    if(showToast) showToast("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm select-none">
                    <div className="flex flex-col mb-4">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><span className="text-xl">ğŸª‘</span> ìë¦¬ ë°°ì¹˜ë„</h3>
                            <div className="flex items-center gap-2">
                                <Btn onClick={handleDownloadImage} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ì¥"><Icon d={PATHS.download} size={18} /></Btn>
                                <Btn onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`p-1.5 rounded-lg transition-colors ${isSettingsOpen ? 'bg-slate-100 text-slate-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                    <Icon d={isSettingsOpen ? PATHS.right : PATHS.left} size={16} />
                                </Btn>
                                <Btn onClick={() => setIsCollapsed(!isCollapsed)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg">
                                    <Icon d={PATHS.down} size={18} className={`transition-transform duration-200 ${!isCollapsed ? 'rotate-180' : ''}`} />
                                </Btn>
                            </div>
                        </div>
                        {isSettingsOpen && !isCollapsed && (
                            <div className="mt-3 pt-3 border-t border-slate-100 flex flex-wrap items-center gap-2 justify-end animate-fade-in">
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.rows - 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">í–‰ {seatConfig.rows}</span><button onClick={() => { const n = Math.min(10, seatConfig.rows + 1); setSeatConfig({ ...seatConfig, rows: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, rows: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <div className="flex items-center bg-slate-100 rounded-lg p-1"><button onClick={() => { const n = Math.max(1, seatConfig.cols - 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">-</button><span className="text-xs font-bold text-slate-500 px-2">ì—´ {seatConfig.cols}</span><button onClick={() => { const n = Math.min(10, seatConfig.cols + 1); setSeatConfig({ ...seatConfig, cols: n }); if(!isLocalMode) saveData('cls_seat_config', { ...seatConfig, cols: n }); }} className="w-6 h-6 flex items-center justify-center hover:bg-white rounded text-slate-600 font-bold">+</button></div>
                                <label className={`flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded-lg border transition-colors ${isLayoutMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-500'}`}><input type="checkbox" checked={isLayoutMode} onChange={e => setIsLayoutMode(e.target.checked)} className="hidden" /><span className="text-xs font-bold">êµ¬ì¡° í¸ì§‘</span></label>
                                <div className="flex gap-1"><Btn onClick={handleLoadGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì ìš©</Btn><Btn onClick={handleSaveSeatsToGroups} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ëª¨ë‘  ì„¤ì •</Btn><Btn onClick={() => openConfirm("ìë¦¬ ë°°ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { setSeatAssignments({}); if(!isLocalMode) saveData('cls_seat_assignments', {}); })} className="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-200">ì´ˆê¸°í™”</Btn></div>
                            </div>
                        )}
                    </div>{!isCollapsed && (<div className="flex flex-col lg:flex-row gap-6" ref={seatChartRef}><div className="flex-1 overflow-auto custom-scroll bg-slate-50/50 rounded-2xl p-4 border border-slate-100 flex flex-col items-center"><div className="w-48 h-6 bg-slate-200 rounded-b-lg mb-6 flex items-center justify-center text-[10px] font-bold text-slate-500 shadow-inner">êµíƒ</div><div className="grid gap-2 md:gap-3 w-full max-w-6xl" style={{ gridTemplateColumns: `repeat(${seatConfig.cols}, minmax(${isMobile ? '60px' : '90px'}, 1fr))` }}>{Array.from({ length: seatConfig.rows }).map((_, r) => Array.from({ length: seatConfig.cols }).map((_, c) => { const seatKey = `${r}-${c}`; const studentId = seatAssignments[seatKey]; 
                    const student = students.find(s => s.id === studentId); 
                    const isDisabled = (seatConfig.disabledSeats || []).includes(seatKey); 
                    const isSelected = selectedSeat === seatKey; 
                    const role = student ? roleMap[student.id] : null; 
                    // [ì¤‘ìš”] onDrop ì´ë²¤íŠ¸ê°€ seat-cell DIVì— ê±¸ë ¤ìˆìŒ
                    return (<div key={seatKey} onClick={() => handleSeatClick(r, c)} onDragOver={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragEnter={!isLayoutMode && !isDisabled ? handleDragOver : undefined} onDragLeave={!isLayoutMode && !isDisabled ? handleDragLeave : undefined} onDrop={!isLayoutMode && !isDisabled ? (e) => handleDrop(e, r, c) : undefined} className={`seat-cell h-20 md:h-28 rounded-xl border-2 flex flex-col items-center justify-center p-1 transition-all duration-200 ease-in-out relative group ${isLayoutMode ? (isDisabled ? 'bg-slate-100 border-slate-200 cursor-pointer hover:bg-slate-200' : 'bg-white border-indigo-200 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50') : (isDisabled ? 'opacity-0 pointer-events-none' : (student ? (student.gender === 'M' ? 'bg-blue-50/30 border-blue-200' : 'bg-pink-50/30 border-pink-200') : 'bg-white border-slate-200 border-dashed hover:border-indigo-300'))} ${isSelected ? 'ring-4 ring-indigo-400 ring-offset-2 z-10 border-indigo-500' : ''}`}>{!isLayoutMode && student && (<div draggable="true" onDragStart={(e) => handleDragStart(e, student.id, seatKey)} onDragEnd={handleDragEnd} onClick={(e) => { e.stopPropagation(); handleStudentClick(student.id); }} onDoubleClick={(e) => { e.stopPropagation(); onOpenStudentInfo(student.id); }} onContextMenu={(e) => handleRightClick(e, seatKey)} className="w-full h-full flex flex-col items-center justify-center cursor-grab active:cursor-grabbing seat-node animate-bounce-in touch-none"><div className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-lg shadow-sm mb-1 overflow-hidden pointer-events-none">{(student.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§')}</div><span className="text-sm font-bold text-slate-700 w-full text-center leading-tight break-keep px-0.5 pointer-events-none">{student.name}</span>{role && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded-full mt-1 font-bold truncate max-w-full pointer-events-none">{role}</span>}</div>)}{isLayoutMode && !isDisabled && <span className="text-indigo-200 text-xs">{r+1}-{c+1}</span>}</div>); }))}</div></div>
                <div id="seat-waiting-list" className="lg:w-72 bg-slate-50 rounded-2xl border border-slate-200 p-4 flex flex-col h-auto min-h-[200px] md:min-h-[400px] flex-shrink-0">
                    <h4 className="font-bold text-slate-600 mb-2 text-xs flex justify-between items-center">
                        <span>ëŒ€ê¸° ëª…ë‹¨</span>
                        <span className="bg-slate-200 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-full">{unassignedStudents.length}</span>
                    </h4>
                    <div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 content-start p-1">
                        {unassignedStudents.map(s => (
                            <div key={s.id} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, null)} onDragEnd={handleDragEnd} onClick={() => handleStudentClick(s.id)} onDoubleClick={() => onOpenStudentInfo(s.id)} className={`student-card bg-white p-1 rounded-lg border-2 shadow-sm flex flex-col items-center justify-center gap-1 aspect-square cursor-grab active:cursor-grabbing transition-all duration-200 touch-none ${selectedStudentId === s.id ? 'border-blue-600 ring-4 ring-blue-100 bg-blue-50 z-10' : 'border-slate-200 hover:border-indigo-300 hover:shadow-md'}`}>
                                <div className="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-lg shadow-sm overflow-hidden pointer-events-none">{(s.gender === 'M' ? 'ğŸ‘¦' : 'ğŸ‘§')}</div>
                                <span className="text-sm font-bold text-slate-700 truncate w-full text-center pointer-events-none">{s.name}</span>
                            </div>
                        ))}
                    </div></div></div>)}
                </div>
            );
        };

        const PartnerAnalysisModal = ({ isOpen, onClose, groupsByDate }) => {
            if (!isOpen) return null;

            const pairCounts = useMemo(() => {
                const counts = {};
                Object.values(groupsByDate).forEach(groups => {
                    if (!Array.isArray(groups)) return;
                    groups.forEach(group => {
                        if (!Array.isArray(group)) return;
                        for (let i = 0; i < group.length; i++) {
                            for (let j = i + 1; j < group.length; j++) {
                                if (!group[i] || !group[j]) continue;
                                const names = [group[i].name, group[j].name].sort();
                                const key = names.join(' & ');
                                counts[key] = (counts[key] || 0) + 1;
                            }
                        }
                    });
                });
                return Object.entries(counts).filter(([_, count]) => count >= 2).sort((a, b) => b[1] - a[1]);
            }, [groupsByDate]);

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„" icon={PATHS.users}>
                    <div className="space-y-4">
                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-700"><p className="font-bold mb-1">ğŸ“Š ì¤‘ë³µ ì§ê¿ í˜„í™©</p><p>ì§€ê¸ˆê¹Œì§€ ê°™ì€ ëª¨ë‘ ì„ í–ˆë˜ íšŸìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. (2íšŒ ì´ìƒ)</p></div>
                        <div className="max-h-[60vh] overflow-y-auto custom-scroll space-y-2">{pairCounts.length > 0 ? pairCounts.map(([pair, count], i) => (<div key={i} className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-xl"><span className="font-bold text-slate-700 text-sm">{pair}</span><span className={`px-2 py-1 rounded-lg text-xs font-bold ${count >= 4 ? 'bg-rose-100 text-rose-600' : count === 3 ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-600'}`}>{count}íšŒ</span></div>)) : (<div className="text-center text-slate-400 py-8 text-sm">ì¤‘ë³µëœ ì§ê¿ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>)}</div>
                    </div>
                </BaseModal>
            );
        };

        const GroupResetModal = ({ isOpen, onClose, onReset }) => {
            const [duration, setDuration] = useState(1);
            
            if (!isOpen) return null;

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ğŸ§¹ ëª¨ë‘  ì´ˆê¸°í™” ì˜µì…˜" icon={PATHS.trash} maxWidth="max-w-sm">
                    <div className="space-y-4">
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-sm text-rose-800">
                            <p className="font-bold mb-1">âš ï¸ ëª¨ë‘  í¸ì„± ê²°ê³¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p>
                            <p className="text-xs opacity-80">ì‚­ì œí•  ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br/>(ê¸°í”¼ ê´€ê³„, í•„ìˆ˜ ì§ê¿ ë“± ê´€ê³„ ì„¤ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)</p>
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-500">ì´ˆê¸°í™” ê¸°ê°„ (ì˜¤ëŠ˜ë¶€í„°)</label>
                            <div className="grid grid-cols-1 gap-2">
                                {[1, 7, 14, 21, 28].map(d => (
                                    <button key={d} onClick={() => setDuration(d)} className={`flex items-center justify-between p-3 rounded-xl border transition-all ${duration === d ? 'bg-rose-50 border-rose-200 ring-1 ring-rose-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                        <span className={`text-sm font-bold ${duration === d ? 'text-rose-700' : 'text-slate-600'}`}>{d === 1 ? 'ì˜¤ëŠ˜ í•˜ë£¨ (1ì¼)' : `${d/7}ì£¼ (${d}ì¼)`}</span>
                                        {duration === d && <Icon d={PATHS.check} size={16} className="text-rose-500" />}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex gap-2 mt-4">
                            <Btn onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ì·¨ì†Œ</Btn>
                            <Btn onClick={() => onReset(duration)} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-md">ì‚­ì œí•˜ê¸°</Btn>
                        </div>
                    </div>
                </BaseModal>
            );
        };

        const SetupModal = ({ isOpen, onClose, showToast, onConnect }) => {
            const [inputConfig, setInputConfig] = useState(""); 
            const [authId, setAuthId] = useState(""); 
            const [authPw, setAuthPw] = useState("");
            const [rememberMe, setRememberMe] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [isTesting, setIsTesting] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    const sId = localStorage.getItem('cls_fb_id');
                    const sPw = localStorage.getItem('cls_fb_pw');
                    const sCfg = localStorage.getItem('cls_fb_config');
                    if (sId || sPw || sCfg) {
                        setAuthId(sId || "");
                        setAuthPw(sPw || "");
                        setInputConfig(sCfg || "");
                        setRememberMe(true);
                    }
                }
            }, [isOpen]);
            
            const parseConfig = (input) => {
                if (!input) return null;
                try {
                    let clean = input.trim();
                    clean = clean.replace(/\/\*[\s\S]*?\*\//g, '');
                    clean = clean.replace(/([^\\:]|^)\/\/.*$/gm, '$1');
                    clean = clean.replace(/(?:^|[\s\r\n]+)(?:export\s+)?(?:const|let|var)\s+\w+\s*=\s*/, '');
                    clean = clean.replace(/;+\s*$/, '');
                    try { return JSON.parse(clean); } catch (e) { return new Function("return " + clean)(); }
                } catch (e) { return null; }
            };

            const handleConnect = async () => { 
                if(!authId || !authPw) { showToast("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } 
                const config = parseConfig(inputConfig);

                if (!config || !config.projectId) { showToast("ì˜¬ë°”ë¥¸ ì„¤ì • ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤ (projectId ëˆ„ë½)."); return; }

                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    await firebase.auth().signInWithEmailAndPassword(authId, authPw); 
                    if (rememberMe) { localStorage.setItem('cls_fb_id', authId); localStorage.setItem('cls_fb_pw', authPw); localStorage.setItem('cls_fb_config', inputConfig); } 
                    else { localStorage.removeItem('cls_fb_id'); localStorage.removeItem('cls_fb_pw'); localStorage.removeItem('cls_fb_config'); }
                    onConnect(config); 
                } catch (e) { 
                    let errMsg = "ì—°ê²° ì‹¤íŒ¨: " + e.message;
                    if(e.code && e.code.includes('auth')) errMsg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
                    showToast(errMsg); logSystemEvent(errMsg, 'error');
                } 
            };

            const handleTest = async () => {
                if(!authId || !authPw) { showToast("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                const config = parseConfig(inputConfig);

                if (!config || !config.projectId) { showToast("ì˜¬ë°”ë¥¸ ì„¤ì • ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤ (projectId ëˆ„ë½)."); return; }

                setIsTesting(true);
                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    await firebase.auth().signInWithEmailAndPassword(authId, authPw);
                    showToast("âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ! (ë¡œê·¸ì¸ í™•ì¸ë¨)");
                } catch (e) {
                    let errMsg = "ì—°ê²° ì‹¤íŒ¨: " + e.message;
                    if(e.code && e.code.includes('auth')) errMsg = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.";
                    showToast(errMsg);
                } finally {
                    setIsTesting(false);
                }
            };

            const handlePasteConfig = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        setInputConfig(text);
                        showToast("ì„¤ì • ì½”ë“œê°€ ë¶™ì—¬ë„£ì–´ì¡ŒìŠµë‹ˆë‹¤.");
                    }
                } catch (err) { showToast("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸ í•„ìš”)"); }
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="â›…ï¸ Firebase ì—°ê²° ì„¤ì •" icon={null}>
                    <div className="flex justify-end mb-2">
                        <button onClick={() => setShowManual(!showManual)} className="text-xs text-indigo-500 font-bold flex items-center gap-1 hover:underline">
                            <Icon d={showManual ? PATHS.down : PATHS.right} size={10} /> ì—°ë™ ë§¤ë‰´ì–¼ {showManual ? 'ì ‘ê¸°' : 'ë³´ê¸°'}
                        </button>
                    </div>
                    {showManual && (
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-600 space-y-4 animate-fade-in mb-4 max-h-60 overflow-y-auto custom-scroll">
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">1. í”„ë¡œì íŠ¸ ìƒì„± ë° ì„¤ì •</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li><a href="https://console.firebase.google.com/" target="_blank" className="text-blue-600 underline">Firebase Console</a> ì ‘ì† &gt; í”„ë¡œì íŠ¸ ì¶”ê°€</li>
                                    <li>ì•± ì¶”ê°€(Web, &lt;/&gt; ì•„ì´ì½˜) &gt; ì•± ë‹‰ë„¤ì„ ì…ë ¥ &gt; ì•± ë“±ë¡</li>
                                    <li><code>const firebaseConfig = ...</code> ì½”ë“œ ì „ì²´ ë³µì‚¬</li>
                                    <li>ì•„ë˜ <strong>'ì„¤ì • ì½”ë“œ ë¶™ì—¬ë„£ê¸°'</strong> ì¹¸ì— ë¶™ì—¬ë„£ê¸°</li>
                                </ol>
                            </div>
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">2. ì¸ì¦(ë¡œê·¸ì¸) ì„¤ì •</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>ì¢Œì¸¡ ë©”ë‰´ <strong>Build &gt; Authentication</strong> &gt; Get started</li>
                                    <li><strong>Sign-in method</strong> &gt; <strong>Email/Password</strong> &gt; ì‚¬ìš© ì„¤ì •(Enable) &gt; ì €ì¥</li>
                                    <li><strong>Users</strong> íƒ­ &gt; Add user &gt; ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ìƒì„±</li>
                                    <li>ìƒì„±í•œ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•„ë˜ ì…ë ¥ì°½ì— ì…ë ¥</li>
                                </ol>
                            </div>
                            <div>
                                <h4 className="font-bold text-indigo-700 mb-1">3. ë°ì´í„°ë² ì´ìŠ¤(Firestore) ë° ë³´ì•ˆ ê·œì¹™</h4>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>ì¢Œì¸¡ ë©”ë‰´ <strong>Build &gt; Firestore Database</strong> &gt; Create database</li>
                                    <li><strong>Rules</strong> íƒ­ í´ë¦­ &gt; ì•„ë˜ ì½”ë“œë¡œ êµì²´ &gt; <strong>Publish</strong></li>
                                    <li>(ì£¼ì˜) ì½”ë“œ ë‚´ <code>'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”'</code> ë¶€ë¶„ì€ <strong>Authentication &gt; Users</strong> íƒ­ì—ì„œ ë°©ê¸ˆ ìƒì„±í•œ ì´ë©”ì¼ì˜ <strong>User UID</strong> ê°’ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (UIDì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë³µì‚¬ ì•„ì´ì½˜ì´ ëœ¹ë‹ˆë‹¤)</li>
                                </ol>
                                <div className="relative mt-2 group">
                                    <div className="bg-slate-800 text-green-400 p-3 rounded-lg font-mono text-[10px] overflow-x-auto whitespace-pre border border-slate-700 shadow-inner selection:bg-green-900 selection:text-white">
{`rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // ëª¨ë“  ë¬¸ì„œ({document=**})ì— ëŒ€í•˜ì—¬\n    match /{document=**} {\n      \n      // 1. ë°˜ë“œì‹œ ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆì–´ì•¼ í•˜ë©°\n      // 2. ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ UIDê°€ ì‚¬ìš©ìë‹˜ì˜ UIDì™€ ì¼ì¹˜í•  ë•Œë§Œ ëª¨ë“  ì½ê¸°/ì“°ê¸°ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.\n      allow read, write: if request.auth != null && request.auth.uid == 'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”';\n      \n    }\n  }\n}`}
                                    </div>
                                    <button onClick={() => { const code = "rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // ëª¨ë“  ë¬¸ì„œ({document=**})ì— ëŒ€í•˜ì—¬\n    match /{document=**} {\n      \n      // 1. ë°˜ë“œì‹œ ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆì–´ì•¼ í•˜ë©°\n      // 2. ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ UIDê°€ ì‚¬ìš©ìë‹˜ì˜ UIDì™€ ì¼ì¹˜í•  ë•Œë§Œ ëª¨ë“  ì½ê¸°/ì“°ê¸°ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.\n      allow read, write: if request.auth != null && request.auth.uid == 'ê°œì¸UIDë¥¼ ë„£ì–´ì£¼ì„¸ìš”';\n      \n    }\n  }\n}"; navigator.clipboard.writeText(code); showToast("âœ… ê·œì¹™ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1.5 rounded-md text-[10px] font-bold border border-white/20 backdrop-blur-sm transition-colors flex items-center gap-1.5 shadow-sm">
                                        <Icon d={PATHS.copy} size={12} /> ì½”ë“œ ë³µì‚¬
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="flex flex-col gap-3 mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200"><div className="text-xs font-bold text-slate-500 mb-1">Firebase ì¸ì¦ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)</div><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ì´ë©”ì¼ (ID)" value={authId} onChange={e => setAuthId(e.target.value)} /><input className="w-full p-2.5 border rounded-lg text-sm bg-white outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" value={authPw} onChange={e => setAuthPw(e.target.value)} /></div><div className="relative"><textarea className="w-full h-40 p-3 border rounded-xl text-xs font-mono bg-white outline-none custom-scroll" placeholder={`// Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì • ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "project-id.firebaseapp.com",
  projectId: "project-id",
  storageBucket: "project-id.firebasestorage.app",
  messagingSenderId: "...",
  appId: "..."
};`} value={inputConfig} onChange={e => setInputConfig(e.target.value)} /><button onClick={handlePasteConfig} className="absolute top-3 right-3 bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 px-2.5 py-1.5 rounded-lg text-[10px] font-bold transition-all shadow-sm flex items-center gap-1">ë¶™ì—¬ë„£ê¸°</button></div><div className="flex items-center gap-2 mt-2 px-1"><label className="flex items-center gap-2 cursor-pointer select-none group"><div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${rememberMe ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300 group-hover:border-indigo-400'}`}>{rememberMe && <Icon d={PATHS.check} size={14} className="text-white" />}</div><input type="checkbox" className="hidden" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)} /><span className="text-sm font-bold text-slate-600 group-hover:text-indigo-600 transition-colors">ë¡œê·¸ì¸ ì •ë³´ ì €ì¥</span></label></div><div className="flex gap-2 mt-5"><Btn onClick={onClose} className="px-4 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl">ì·¨ì†Œ</Btn><Btn onClick={handleTest} disabled={isTesting} className="flex-1 py-3 bg-white border border-indigo-200 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 flex items-center justify-center gap-2">{isTesting ? <><Icon d={PATHS.spinner} className="animate-spin" size={16}/> í™•ì¸ ì¤‘...</> : 'ì—°ê²° í…ŒìŠ¤íŠ¸'}</Btn><Btn onClick={handleConnect} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">ì—°ê²°í•˜ê¸°</Btn></div></BaseModal>
            );
        };
        const GlobalRecordModal = ({ isOpen, onClose, students, setStudents, saveData, isLocalMode, showToast, buttonPos, appConfig, db, appId }) => {
    if (!isOpen) return null;
    
    // [New] ì—°ë™ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ê°’ ì„¤ì •
    const [hasNotionRecord, setHasNotionRecord] = React.useState(false);
    const [hasNotionPortfolio, setHasNotionPortfolio] = React.useState(false);
    const [hasGoogleSheet, setHasGoogleSheet] = React.useState(false);

    const [saveTargets, setSaveTargets] = React.useState(() => {
        // [New] ì´ì „ì— ì„ íƒí•œ ì €ì¥ì†Œ ì„¤ì •ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedPref = localStorage.getItem('cls_save_targets_pref');
        if (savedPref) {
            try { return new Set(JSON.parse(savedPref)); } catch(e) {}
        }

        const key = localStorage.getItem('cls_notion_key');
        const dbId = localStorage.getItem('cls_notion_db_id');
        const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
        const sheetUrl = localStorage.getItem('cls_google_sheet_url');
        const isPortMode = localStorage.getItem('cls_portfolio_mode') === 'true';

        const targets = new Set();
        if (isPortMode && key && portDbId) targets.add('notion_portfolio');
        if (key && dbId) targets.add('notion_record');
        if (sheetUrl) targets.add('google_sheet');
        return targets;
    });

    const [searchText, setSearchText] = React.useState("");
    const [selectedStudents, setSelectedStudents] = React.useState([]);
    const [showStudentDropdown, setShowStudentDropdown] = React.useState(false);
    const [notionDate, setNotionDate] = React.useState(dayjs().format('YYYY-MM-DD'));
    const [notionContent, setNotionContent] = React.useState('');
    const [keepContent, setKeepContent] = React.useState(false);
    const [closeAfterSave, setCloseAfterSave] = React.useState(false);
    const [notionStatus, setNotionStatus] = React.useState('idle');
    const [hasNotionConfig, setHasNotionConfig] = React.useState(false);
    const [hasGoogleSheetConfig, setHasGoogleSheetConfig] = React.useState(false);
    const modalRef = React.useRef(null);
    const textareaRef = React.useRef(null);

    React.useEffect(() => {
        if (isOpen) {
            const key = localStorage.getItem('cls_notion_key');
            const dbId = localStorage.getItem('cls_notion_db_id');
            const portDbId = localStorage.getItem('cls_notion_portfolio_db_id');
            const sheetUrl = localStorage.getItem('cls_google_sheet_url');
            
            const rec = !!(key && dbId);
            const port = !!(key && portDbId);
            const sheet = !!sheetUrl;

            setHasNotionRecord(rec);
            setHasNotionPortfolio(port);
            setHasGoogleSheet(sheet);
            setHasNotionConfig(rec || port);
            setHasGoogleSheetConfig(sheet);

            // [Fix] ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì €ì¥ëœ ì„¤ì •ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ì ìš© (ìƒíƒœ ì´ˆê¸°í™” ë°©ì§€)
            const savedPref = localStorage.getItem('cls_save_targets_pref');
            if (savedPref) {
                try {
                    const savedSet = new Set(JSON.parse(savedPref));
                    setSaveTargets(savedSet);
                } catch (e) {}
            }
        }
    }, [isOpen]);

    // [New] ì €ì¥ì†Œ ì„ íƒ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    React.useEffect(() => {
        localStorage.setItem('cls_save_targets_pref', JSON.stringify([...saveTargets]));
    }, [saveTargets]);

    React.useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
        }
    }, [notionContent]);

    const handleStudentSelect = (name) => {
        const s = students.find(st => st.name === name);
        if (s && !selectedStudents.find(sel => sel.id === s.id)) setSelectedStudents(prev => [...prev, s]);
    };
    const removeSelectedStudent = (id) => setSelectedStudents(prev => prev.filter(s => s.id !== id));

    const handleIntegratedSave = async (category) => {
                if (selectedStudents.length === 0) return showToast("í•™ìƒì„ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                const content = notionContent.trim();
                if (!content) return showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setNotionStatus('saving');
                const date = notionDate || dayjs().format('YYYY-MM-DD');
                
                let tags = [];
                if (saveTargets.has('notion_record')) tags.push("ë…¸ì…˜(ê¸°ë¡)");
                if (saveTargets.has('notion_portfolio')) tags.push("ë…¸ì…˜(í¬í´)");
                if (saveTargets.has('google_sheet')) tags.push("êµ¬ê¸€ ì‹œíŠ¸");

                const newNote = { id: Date.now(), date: date, content: content, destTags: tags };
                const targetIds = selectedStudents.map(s => s.id);
                
                let updatedStudentsList = [...students];

                for (const targetId of targetIds) {
                    const studentObj = students.find(s => s.id === targetId);
                    if (!studentObj) continue;

                    let prevNotes = [];
                    // ğŸŒŸ í´ë¼ìš°ë“œ ëª¨ë“œ: ì—¬ê¸°ì„œë„ ê³¼ê±° ê¸°ë¡ì„ êº¼ë‚´ì˜µë‹ˆë‹¤!
                    if (!isLocalMode && db && appId) {
                        try {
                            const doc = await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).get();
                            if (doc.exists && doc.data().counseling) {
                                prevNotes = doc.data().counseling;
                            }
                        } catch (e) { console.error("ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e); }
                    } else {
                        prevNotes = studentObj.counseling || [];
                    }

                    const updatedNotes = [newNote, ...prevNotes];
                    let updatedStickers = studentObj.stickers || 0;
                    if (category === 'ì¹­ì°¬') updatedStickers += 1;

                    if (!isLocalMode && db && appId) {
                        await db.collection('classes').doc(appId).collection('studentData').doc(String(targetId)).set({ counseling: updatedNotes }, { merge: true });
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, stickers: updatedStickers } : s);
                    } else {
                        updatedStudentsList = updatedStudentsList.map(s => s.id === targetId ? { ...s, counseling: updatedNotes, stickers: updatedStickers } : s);
                    }
                }

                setStudents(updatedStudentsList);
                if (!isLocalMode) saveData('cls_students', updatedStudentsList);
                else localStorage.setItem('cls_students', JSON.stringify(updatedStudentsList));

                if (saveTargets.has('google_sheet')) {
                    let successCount = 0;
                    // ğŸŒŸ ì¤„ ì„¸ìš°ì§€ ì•Šê³ , ë°°ì—´ í†µì§¸ë¡œ ì „ì†¡!
                    if (await saveToGoogleSheet(selectedStudents, category, content, date)) {
                        successCount = selectedStudents.length;
                    }
                    if (successCount > 0) {
                        setNotionStatus('success'); if (!keepContent) setNotionContent(''); 
                        setTimeout(() => setNotionStatus('idle'), 3000); 
                    }
                }

                try {
                    const rawKey = localStorage.getItem('cls_notion_key') || "";
                    const personalKey = rawKey.replace(/["']/g, '').trim();
                    const targets = [];
                    if (saveTargets.has('notion_record')) targets.push('notion_record');
                    if (saveTargets.has('notion_portfolio')) targets.push('notion_portfolio');

                    for (const target of targets) {
                        const rawDbId = (target === 'notion_portfolio') ? (localStorage.getItem('cls_notion_portfolio_db_id') || "") : (localStorage.getItem('cls_notion_db_id') || "");
                        const targetDbId = rawDbId.replace(/["']/g, '').trim();
                        if (!personalKey || !targetDbId) continue;

                        const bodyData = { category: category, content: content, personalKey: personalKey, personalDbId: targetDbId };
                        
                        if (target === 'notion_portfolio') {
                            const map = JSON.parse(localStorage.getItem('cls_student_map') || '{}');
                            const ids = []; selectedStudents.forEach(s => { if (map[s.name]) ids.push(map[s.name]); });
                            bodyData.mode = 'relation'; bodyData.studentIds = ids;
                            await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData) });
                        } else {
                            // [Fix] ë…¸ì…˜(ê¸°ë¡) ëª¨ë“œì¼ ë•Œ ì„ íƒëœ ëª¨ë“  í•™ìƒì— ëŒ€í•´ ê°œë³„ ì €ì¥
                            for (const s of selectedStudents) {
                                const individualBody = { 
                                    ...bodyData, 
                                    mode: 'normal', 
                                    studentName: s.name, 
                                    date: dayjs(date).format('YYYY-MM-DD') 
                                };
                                await fetch('/api/save-notion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(individualBody) });
                            }
                        }
                    }
                    setNotionStatus('success'); if (!keepContent) setNotionContent(''); setTimeout(() => setNotionStatus('idle'), 3000);
                    showToast("âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    if (closeAfterSave) onClose();
                } catch (e) {
                    console.error(e); setNotionStatus('error'); setTimeout(() => setNotionStatus('idle'), 3000);
                }
            };

    return (
        <div className="fixed inset-0 bg-black/50 z-[2000] p-4 backdrop-blur-sm animate-fade-in flex items-center justify-center" onClick={onClose}>
            <div ref={modalRef} className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col animate-expand-from" onClick={e => e.stopPropagation()}>
                <div className="bg-slate-50 p-5 border-b border-slate-200 flex justify-between items-center">
                    <h3 className="font-bold text-slate-800 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 items-start">
                        <span className="flex items-center gap-2 whitespace-nowrap"><Icon d={PATHS.document} size={18} className="text-indigo-500"/> ë¹ ë¥¸ ê¸°ë¡</span>
                        <div className="flex flex-col sm:flex-row gap-1">
                            {hasNotionConfig && <span className="w-fit text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />ë…¸ì…˜ ì—°ë™</span>}
                            {hasGoogleSheetConfig && <span className="w-fit text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-normal flex items-center gap-0.5 whitespace-nowrap"><Icon d={PATHS.check} size={10} strokeWidth={3} />êµ¬ê¸€ ì—°ë™</span>}
                        </div>
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full text-slate-400"><Icon d={PATHS.x} /></button>
                </div>
                
                {/* [New] ì €ì¥ì†Œ ì„ íƒ íƒ­ UI */}
                <div className="px-5 pt-4">
                    {(hasNotionRecord || hasNotionPortfolio || hasGoogleSheet) ? (
                        <div className="flex gap-1 bg-slate-100 p-1 rounded-xl border border-slate-200">
                            {hasNotionRecord && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_record')) next.delete('notion_record'); else next.add('notion_record'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_record') ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(ê¸°ë¡)</button>}
                            {hasNotionPortfolio && <button onClick={() => { const next = new Set(saveTargets); if(next.has('notion_portfolio')) next.delete('notion_portfolio'); else next.add('notion_portfolio'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('notion_portfolio') ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“ ë…¸ì…˜(í¬í´)</button>}
                            {hasGoogleSheet && <button onClick={() => { const next = new Set(saveTargets); if(next.has('google_sheet')) next.delete('google_sheet'); else next.add('google_sheet'); setSaveTargets(next); }} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${saveTargets.has('google_sheet') ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸</button>}
                        </div>
                    ) : (
                        <div className="text-center text-xs text-slate-400 py-2 bg-slate-50 rounded-xl border border-slate-200 border-dashed">ì—°ë™ëœ ì™¸ë¶€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤ (ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)</div>
                    )}
                </div>

                <div className="p-5 flex flex-col gap-4">
                    <div className="flex flex-wrap gap-1.5 relative">
                        {selectedStudents.map(s => (
                            <span key={s.id} className="text-xs px-2.5 py-1.5 rounded-full flex items-center gap-1.5 border bg-indigo-50 text-indigo-700 border-indigo-200 font-bold shadow-sm">
                                {s.name} <button onClick={() => removeSelectedStudent(s.id)} className="hover:text-rose-500"><Icon d={PATHS.x} size={10}/></button>
                            </span>
                        ))}
                        <div className="flex-1 min-w-[120px] relative">
                            <input placeholder="ëŒ€ìƒ í•™ìƒ ê²€ìƒ‰ (í´ë¦­)..." className="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-medium outline-none focus:border-indigo-500" value={searchText} onChange={(e) => { setSearchText(e.target.value); setShowStudentDropdown(true); }} onFocus={() => setShowStudentDropdown(true)} onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)} />
                            {showStudentDropdown && (
                                <div className="absolute top-full left-0 w-full bg-white shadow-xl border border-slate-200 rounded-xl z-50 max-h-40 overflow-y-auto mt-1 custom-scroll">
                                    {students.filter(s => s.name.includes(searchText)).map(s => (
                                        <div key={s.id} className="px-3 py-2 text-xs hover:bg-indigo-50 cursor-pointer font-bold flex justify-between" onMouseDown={() => { handleStudentSelect(s.name); setSearchText(""); }}>
                                            <span>{s.order}ë²ˆ {s.name}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    <input type="date" value={notionDate} onChange={(e) => setNotionDate(e.target.value)} className="p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-600 outline-none" />
                    <textarea ref={textareaRef} value={notionContent} onChange={(e) => setNotionContent(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none min-h-[7rem] max-h-[40vh] outline-none overflow-y-auto custom-scroll" placeholder="ê´€ì°° ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows={1} />
                    <div className="flex justify-end -mt-2 gap-3">
                        <label className="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" checked={keepContent} onChange={e => setKeepContent(e.target.checked)} className="w-3.5 h-3.5" />
                            <span className="text-[10px] text-slate-500 font-bold">ë‚´ìš© ìœ ì§€</span>
                        </label>
                        <label className="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" checked={closeAfterSave} onChange={e => setCloseAfterSave(e.target.checked)} className="w-3.5 h-3.5" />
                            <span className="text-[10px] text-slate-500 font-bold">ìë™ ë‹«ê¸°</span>
                        </label>
                    </div>
                    <div className="flex gap-2.5">
                        <button onClick={() => handleIntegratedSave('ì¹­ì°¬')} disabled={notionStatus === 'saving'} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-md whitespace-nowrap">ì¹­ì°¬í•˜ê¸° +1</button>
                        <button onClick={() => handleIntegratedSave('ê´€ì°°')} disabled={notionStatus === 'saving'} className="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md whitespace-nowrap">ê´€ì°° ê¸°ë¡ ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    );
};
// --- [ì—¬ê¸°ê¹Œì§€ ë³µì‚¬] ---
        const App = () => {
            const [forceRender, setForceRender] = useState(0); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ìš© ìŠ¤ìœ„ì¹˜
            const CURRENT_VERSION = UPDATE_NOTES[0].version; // ë¬´ì¡°ê±´ jsonì˜ ì²«ë²ˆì§¸(ìµœì‹ )ë¥¼ ë‚´ ë²„ì „ìœ¼ë¡œ ì¸ì‹!
            const updateDate = UPDATE_NOTES[0].date;

            // [Service Worker Update Logic] 
    const [newVersionAvailable, setNewVersionAvailable] = useState(false); 
    const [waitingWorker, setWaitingWorker] = useState(null);

    const handleCloseUpdate = (type) => {
        let snoozeUntil;
        if (type === 'today') {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            snoozeUntil = tomorrow.getTime();
        } else {
            snoozeUntil = new Date().getTime() + 600000;
        }
        localStorage.setItem('cls_update_snooze', snoozeUntil.toString());
        setNewVersionAvailable(false);
    };

    const handleUpdateApp = async () => {
            // ğŸŒŸ 1. "ë‚˜ ì´ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œí–ˆì–´!"ë¼ê³  í°ì— ì˜êµ¬ ë„ì¥ ì°ê¸° (ë°°ë„ˆ ì•ˆ ëœ¨ê²Œ í•˜ëŠ” í•µì‹¬!)
            const latestVersion = Array.isArray(UPDATE_NOTES) ? UPDATE_NOTES[0].version : UPDATE_NOTES.version;
            localStorage.setItem('cls_last_version', latestVersion);

            // ğŸŒŸ 2. ë¸Œë¼ìš°ì € ìºì‹œ(ì˜›ë‚  ì°Œêº¼ê¸° íŒŒì¼ë“¤) ì™„ë²½í•˜ê²Œ í­íŒŒ
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                } catch (e) { console.error("ìºì‹œ ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ğŸŒŸ 3. ê³ ì§‘ë¶€ë¦¬ëŠ” ì˜›ë‚  ì„œë¹„ìŠ¤ ì›Œì»¤(ì•± ê´€ë¦¬ì) ê°•ì œ í•´ê³ ! (ê°€ì¥ í™•ì‹¤í•œ ì‹¤ì œ ì—…ë°ì´íŠ¸ ë°©ë²•)
            if (navigator.serviceWorker) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister(); 
                    }
                } catch (e) { console.error("SW ì‚­ì œ ì‹¤íŒ¨:", e); }
            }

            // ğŸŒŸ 4. ì°Œêº¼ê¸° í•˜ë‚˜ ì—†ëŠ” ì•„ì£¼ ê¹¨ë—í•œ ì£¼ì†Œë¡œ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            window.location.href = window.location.pathname + '?clear=' + new Date().getTime();
        };

    useEffect(() => { 
        const checkUpdateFile = () => {
            fetch(`/update.json?t=${new Date().getTime()}`)
                .then(res => res.json())
                .then(data => {
                    // ë°ì´í„° ì•ˆì „í•˜ê²Œ ë°°ì—´ë¡œ ë§Œë“¤ê¸°
                    let fetchedNotes = Array.isArray(data) ? data : [data];
                    UPDATE_NOTES = fetchedNotes;
                    
                    // í™”ë©´ ë Œë”ë§ ìŠ¤ìœ„ì¹˜ (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì‘ë™í•˜ë„ë¡ ë°©ì–´)
                    if (typeof setForceRender === 'function') setForceRender(prev => prev + 1);
                    if (typeof setIsLoaded === 'function') setIsLoaded(true);

                    // ğŸŒŸ ë¬´í•œ ì•Œë¦¼ ë°©ì§€ì˜ í•µì‹¬!
                    const latestVersion = fetchedNotes[0].version;
                    const lastVersion = localStorage.getItem('cls_last_version');
                    
                    // í•¸ë“œí°ì— ì°íŒ ë„ì¥(lastVersion)ê³¼ jsonì˜ ìµœì‹  ë²„ì „(latestVersion)ì´ ê°™ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ! (ë°°ë„ˆ ì•ˆ ëœ¸)
                    if (lastVersion === latestVersion) return;

                    // ìŠ¤ëˆ„ì¦ˆ(ë‚˜ì¤‘ì— ë³´ê¸°) ê¸°ëŠ¥ í™•ì¸
                    const snoozeTime = localStorage.getItem('cls_update_snooze');
                    const now = new Date().getTime();
                    if (snoozeTime && now < parseInt(snoozeTime, 10)) return;

                    // ë„ì¥ë„ ë‹¤ë¥´ê³ , ìŠ¤ëˆ„ì¦ˆë„ ì•„ë‹ˆë©´ ë¹„ë¡œì†Œ ë°°ë„ˆ ë„ì›€
                    setNewVersionAvailable(true);
                })
                .catch(err => console.log("ì—…ë°ì´íŠ¸ íŒŒì¼ í™•ì¸ ë¶ˆê°€:", err));
        };

        checkUpdateFile();

        if ('serviceWorker' in navigator) { 
            navigator.serviceWorker.register('./sw.js').then(registration => { 
                if (registration.waiting) { 
                    setWaitingWorker(registration.waiting); 
                    setNewVersionAvailable(true); 
                } 
                registration.addEventListener('updatefound', () => { 
                    const newWorker = registration.installing; 
                    newWorker.addEventListener('statechange', () => { 
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) { 
                            setWaitingWorker(newWorker); 
                            setNewVersionAvailable(true); 
                        } 
                    }); 
                }); 
                setInterval(() => {
                    registration.update(); 
                    checkUpdateFile();     
                }, 600000);
            }); 

            let refreshing = false; 
            navigator.serviceWorker.addEventListener('controllerchange', () => { 
                if (!refreshing) { 
                    window.location.reload(); 
                    refreshing = true; 
                } 
            }); 
        } 
    }, []);

            const [mode, setMode] = useState("record");
            const [date, setDate] = useState(getToday());

            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ì‹œì‘ --- */
            const [isPortfolioMode, setIsPortfolioMode] = React.useState(false);
            const [studentMap, setStudentMap] = React.useState({});
            const [portfolioDbId, setPortfolioDbId] = React.useState('');

            // ì´ˆê¸° ì‹¤í–‰ì‹œ ì €ì¥ëœ í¬íŠ¸í´ë¦¬ì˜¤ ID ë¶ˆëŸ¬ì˜¤ê¸°
            React.useEffect(() => {
                const saved = localStorage.getItem('cls_notion_portfolio_db_id');
                if (saved) setPortfolioDbId(saved);
                
                // [Fix] ì•± ì‹œì‘ ì‹œ í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ìƒíƒœ ë¡œë“œ
                const savedMode = localStorage.getItem('cls_portfolio_mode') === 'true';
                setIsPortfolioMode(savedMode);
            }, []);

            React.useEffect(() => {
              try {
                const saved = localStorage.getItem('cls_student_map');
                if (saved) setStudentMap(JSON.parse(saved));
              } catch (e) {}
            }, []);
            /* --- í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë“œ ì„¤ì • ë --- */

            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState({});
            const [simpleChecks, setSimpleChecks] = useState({});
            const [groupsByDate, setGroupsByDate] = useState({});
            const [avoidancePairs, setAvoidancePairs] = useState([]);
            const [dailyTasks, setDailyTasks] = useState({});
            const [weeklyTasks, setWeeklyTasks] = useState({ 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cls_ai_key') || "");
            const [isApiKeyValid, setIsApiKeyValid] = useState(false);
            const [tags, setTags] = useState(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
            const [backupTimes, setBackupTimes] = useState(() => {
                const saved = localStorage.getItem('cls_backup_times');
                return saved ? JSON.parse(saved) : ['12:00', '14:50'];
            });
            const [lockedIds, setLockedIds] = useState([]);
            const [groupNames, setGroupNames] = useState({});
            const [groupRoles, setGroupRoles] = useState({});
            const [rolesList, setRolesList] = useState(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
            const [roleDescriptions, setRoleDescriptions] = useState(DEFAULT_ROLE_DESCRIPTIONS);
            const [seatAssignments, setSeatAssignments] = useState({});
            const [seatConfig, setSeatConfig] = useState({ rows: 5, cols: 5, disabledSeats: ['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4'] });
            const [groupDuration, setGroupDuration] = useState(1);
            const [historyDuration, setHistoryDuration] = useState(14);
            const [isDevMode, setIsDevMode] = useState(() => localStorage.getItem('cls_dev_mode') === 'true');
            const [gearClickCount, setGearClickCount] = useState(0);
            const gearClickTimer = useRef(null);
            
            const [p1, setP1] = useState(""); const [p2, setP2] = useState("");
            const [groupMethod, setGroupMethod] = useState('count'); const [groupNumber, setGroupNumber] = useState(4);
            const [useGender, setUseGender] = useState(true); const [useSkill, setUseSkill] = useState(true);
            const [isGenerating, setIsGenerating] = useState(false); const [isAvoidanceVisible, setIsAvoidanceVisible] = useState(false);
            const [useLeader, setUseLeader] = useState(false);
            const [useHistory, setUseHistory] = useState(false); 
            const [mustPairs, setMustPairs] = useState([]); 
            const [pairTab, setPairTab] = useState('avoid'); 
            const [showRoleHelp, setShowRoleHelp] = useState(false);
            const [isGroupToolsOpen, setIsGroupToolsOpen] = useState(window.innerWidth >= 768);
            const [useAI, setUseAI] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("");
            const [aiReason, setAiReason] = useState(null);

            const [honorPeriod, setHonorPeriod] = useState('weekly'); const [helpPeriod, setHelpPeriod] = useState('weekly');
            const [honorTag, setHonorTag] = useState('ì „ì²´'); const [helpTag, setHelpTag] = useState('ì „ì²´'); const [grassStudentId, setGrassStudentId] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isSettingOpen, setIsSettingOpen] = useState(false); const [isSetupOpen, setIsSetupOpen] = useState(false); const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [isRangeCalendarOpen, setIsRangeCalendarOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: "", onConfirm: null, onCancel: null }); const [toastMessage, setToastMessage] = useState(null); const [toastAction, setToastAction] = useState(null);
            const [isNotionSetupOpen, setIsNotionSetupOpen] = useState(false);
            const [isApiKeySetupOpen, setIsApiKeySetupOpen] = useState(false);
            const [isGoogleSheetSetupOpen, setIsGoogleSheetSetupOpen] = useState(false);
            // ğŸŒŸ íŠœí† ë¦¬ì–¼ ìƒíƒœ ê´€ë¦¬
    const [showTutorial, setShowTutorial] = useState(false);
    const [tutorialStep, setTutorialStep] = useState(0);

    const tutorialSlides = [
        { emoji: 'ğŸ‘‹', title: 'ì„ ìƒë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!', desc: 'í‡´ê·¼ ì‹œê°„ì„ ì•ë‹¹ê²¨ ì¤„ ìŠ¤ë§ˆíŠ¸í•œ í•™ê¸‰ ê²½ì˜ ë„êµ¬ì…ë‹ˆë‹¤. ë†€ë¼ìš´ í•µì‹¬ ê¸°ëŠ¥ì„ ë¹ ë¥´ê²Œ ì•Œì•„ë³¼ê¹Œìš”?' },
        { emoji: 'âš¡', title: 'ë¹ ë¥¸ ë‹¤ì¤‘ ê¸°ë¡', desc: 'ìš°ì¸¡ í•˜ë‹¨ì˜ [ë¹ ë¥¸ ê¸°ë¡ íœ] ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. í•œ ë²ˆì— ì—¬ëŸ¬ ëª…ì˜ ê´€ì°°/ì¹­ì°¬ ê¸°ë¡ì„ ìˆœì‹ê°„ì— ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
        { emoji: 'ğŸš€', title: 'ì´ˆê³ ì† ì™¸ë¶€ ì—°ë™ (ëˆ„ë½ 0%)', desc: 'ì…ë ¥í•œ ê¸°ë¡ì€ êµ¬ê¸€ ì‹œíŠ¸ì™€ ë…¸ì…˜ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. ìˆ˜ì‹­ ëª…ì„ ì„ íƒí•´ë„ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°•ìŠ¤(Batch)ë¡œ ë¬¶ì–´ 0.1ì´ˆ ë§Œì— ì•ˆì „í•˜ê³  ë¹ ë¥´ê²Œ ì¼ê´„ ì „ì†¡í•©ë‹ˆë‹¤.' },
        { emoji: 'ğŸ¤–', title: 'ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ AI ìƒë‹´ì†Œ', desc: 'í•™ìƒ ì´ë¦„í‘œë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ ì¸ì‚¬ì´íŠ¸ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. [AI ìƒë‹´ì†Œ]ì˜ í†±ë‹ˆë°”í€´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ABA, PDC, ê°ì •ì½”ì¹­ ë“± ë§ì¶¤í˜• ì „ë¬¸ê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ë°”ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.' },
        { emoji: 'ğŸ“Š', title: 'í´ë¦­ í•œ ë²ˆì— ìƒê¸°ë¶€ ì´ˆì•ˆ ì™„ì„±', desc: 'ê¸°ë¡ì´ ìŒ“ì´ë©´ [AI ì´í‰ ì´ˆì•ˆ] íƒ­ì„ í™œìš©í•´ ë³´ì„¸ìš”. í–‰ë°œ, êµê³¼ ë“± ìë™ ì¶”ì²œ í…œí”Œë¦¿ì— ë§ì¶° í•™ìƒì˜ ì¢…í•© ì˜ê²¬ ì´ˆì•ˆì„ ëšë”± ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.' }
    ];
            const [appConfig, setAppConfig] = useState({ recordTitle: "ë‹¤í–ˆë‚˜ìš”!?", recordMsg: "ëª¨ë‘ ì œì¶œ ì™„ë£Œ! ğŸ‰", simpleTitle: "ë‹¨ìˆœ í™•ì¸í‘œ", simpleMsg: "í™•ì¸ ì™„ë£Œ! ğŸ‘Œ", runner: "ğŸƒ", version: CURRENT_VERSION, vacationStart: "", vacationEnd: "", cloudIcon: null, font: 'sans', favicon: null, animationEnabled: true, tabAnimationEnabled: true, updateNotificationType: 'toast', floatingButtonSize: 'medium', uiScale: 100 });
            const [isLocalMode, setIsLocalMode] = useState(true); const [db, setDb] = useState(null); const [appId, setAppId] = useState("");
            const [editingGroupIdx, setEditingGroupIdx] = useState(null);
            const [editingGroupName, setEditingGroupName] = useState("");
            const lastBackupTime = useRef("");
            const [editingRoleTarget, setEditingRoleTarget] = useState(null);
            const [isLoading, setIsLoading] = useState(true); 
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [showLongLoading, setShowLongLoading] = useState(false);
            const [showOfflineModal, setShowOfflineModal] = useState(false);
            const [autoCloseTimer, setAutoCloseTimer] = useState(3);
            const [showUpdateNotes, setShowUpdateNotes] = useState(false);

            useEffect(() => {
                const scale = appConfig.uiScale || 100;
                const scaleFactor = scale / 100;
                
                // [Fix] Firefox ë“± zoom ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ëŒ€ì‘ ë° ë†’ì´ ë³´ì • ë¡œì§ ê°œì„ 
                const isZoomSupported = 'zoom' in document.documentElement.style;
                
                if (isZoomSupported) {
                    document.body.style.zoom = scale + '%';
                    document.body.style.setProperty('--ui-scale', scaleFactor);
                    
                    // í™”ë©´ ë°°ìœ¨ í™•ëŒ€ ì‹œ ë·°í¬íŠ¸ ë†’ì´ ë³´ì • (ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€)
                    const root = document.getElementById('root');
                    if (root) {
                        const adjustedHeight = 100 / scaleFactor;
                        root.style.height = `${adjustedHeight}vh`;
                    }
                } else {
                    // zoom ë¯¸ì§€ì› ì‹œ ë°°ìœ¨ ì„¤ì • ë¬´ì‹œ (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€)
                    document.body.style.zoom = '';
                    document.body.style.removeProperty('--ui-scale');
                    const root = document.getElementById('root');
                    if (root) root.style.height = '';
                }

                // [Fix] í™”ë©´ ë°°ìœ¨ ë³€ê²½ ì‹œ í”Œë¡œíŒ… ë²„íŠ¼ ìœ„ì¹˜ ì¬ì¡°ì • (í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” í˜„ìƒ ë°©ì§€)
                setButtonPos(prev => {
                    const screenW = window.innerWidth;
                    const screenH = window.innerHeight;
                    const btnSize = 80; // ë²„íŠ¼ í¬ê¸° + ì—¬ìœ  ê³µê°„
                    
                    // Effective screen size in zoomed coordinates
                    const effectiveW = screenW / scaleFactor;
                    const effectiveH = screenH / scaleFactor;

                    let newX = prev.x;
                    let newY = prev.y;
                    
                    if (newX > effectiveW - btnSize) newX = effectiveW - btnSize;
                    if (newY > effectiveH - btnSize) newY = effectiveH - btnSize;
                    
                    return { x: Math.max(10, newX), y: Math.max(10, newY) };
                });
            }, [appConfig.uiScale]);

            // [New] ë²„ì „ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ ë…¸íŠ¸ ìë™ í‘œì‹œ
            useEffect(() => {
                // [Fix] ì´ˆê¸° ë¡œë”© ìƒíƒœ("ë¡œë”© ì¤‘...")ì¼ ë•ŒëŠ” ë²„ì „ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ë°©ì–´ ì½”ë“œ ì¶”ê°€
                if (CURRENT_VERSION === "ë¡œë”© ì¤‘...") return;

                const lastVersion = localStorage.getItem('cls_last_version');
                if (lastVersion !== CURRENT_VERSION) {
                    //setShowUpdateNotes(true);
                    localStorage.setItem('cls_last_version', CURRENT_VERSION);
                }
            }, [CURRENT_VERSION]);

            const [isRoleEditOpen, setIsRoleEditOpen] = useState(false);
            const [isGroupPanelOpen, setIsGroupPanelOpen] = useState(window.innerWidth >= 768);
            const [formationClickCount, setFormationClickCount] = useState(0);
            const [showAiHelp, setShowAiHelp] = useState(false);
            const formationClickTimer = useRef(null);
            const groupsRef = useRef(null);
            const draggedGroupItemRef = useRef(null);
            const [showWeeklyBriefing, setShowWeeklyBriefing] = useState(false);
            const [showBriefingHelp, setShowBriefingHelp] = useState(false);
            const [aiContent, setAiContent] = useState("");
            const [generationProgress, setGenerationProgress] = useState(0);
            const [briefingStart, setBriefingStart] = useState(dayjs().subtract(4, 'day').format('YYYY-MM-DD'));
            const [briefingEnd, setBriefingEnd] = useState(dayjs().format('YYYY-MM-DD'));
            const [briefingTone, setBriefingTone] = useState('encouraging');
            const briefingRef = useRef(null);
            const [showClassStory, setShowClassStory] = useState(false);
            const [showStoryHelp, setShowStoryHelp] = useState(false);
            const [storyGenre, setStoryGenre] = useState('school');
            const [isToolsOpen, setIsToolsOpen] = useState(false);
            const [showAvoidanceLines, setShowAvoidanceLines] = useState(false);
            const [focusedGroupIdx, setFocusedGroupIdx] = useState(null);
            const [showPartnerAnalysis, setShowPartnerAnalysis] = useState(false);
            const [expandedGroupCards, setExpandedGroupCards] = useState({});
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);
            const [isStandalone, setIsStandalone] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [showGlobalRecord, setShowGlobalRecord] = React.useState(false);
            const [showGroupResetModal, setShowGroupResetModal] = useState(false);
            const [aiCheckState, setAiCheckState] = useState({ isOpen: false, prompt: "", resolve: null, reject: null });
            const [hideRotationBanner, setHideRotationBanner] = useState(false);

            useEffect(() => {
                window.triggerAiSecurityCheck = (prompt) => {
                    return new Promise((resolve, reject) => {
                        setAiCheckState({ isOpen: true, prompt, resolve, reject });
                    });
                };
            }, []);

            const isRotationDay = useMemo(() => {
                const today = dayjs();
                const targetDay = appConfig.rotationDay !== undefined ? parseInt(appConfig.rotationDay) : 5;
                return targetDay !== -1 && today.day() === targetDay && date === today.format('YYYY-MM-DD');
            }, [appConfig.rotationDay, date]);

            const handleAiCheckConfirm = () => {
                if (aiCheckState.resolve) aiCheckState.resolve(true);
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            const handleAiCheckCancel = () => {
                if (aiCheckState.reject) aiCheckState.reject(new Error("ì‚¬ìš©ìì— ì˜í•´ ì „ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."));
                setAiCheckState({ isOpen: false, prompt: "", resolve: null, reject: null });
            };

            // [New] Floating Button Drag Logic
            const [buttonPos, setButtonPos] = useState({ x: window.innerWidth - 80, y: window.innerHeight - 80 });
            const [isDraggingButton, setIsDraggingButton] = useState(false);
            const dragOffset = useRef({ x: 0, y: 0 });
            const isDragGesture = useRef(false);
            const [isButtonIdle, setIsButtonIdle] = useState(false);
            const buttonIdleTimer = useRef(null);
            const [isHidden, setIsHidden] = useState(false);
            const hideTimer = useRef(null);

            const resetButtonIdleTimer = () => {
                setIsButtonIdle(false);
                if (buttonIdleTimer.current) clearTimeout(buttonIdleTimer.current);
                buttonIdleTimer.current = setTimeout(() => setIsButtonIdle(true), 5000);
            };

            useEffect(() => {
                resetButtonIdleTimer();
                return () => clearTimeout(buttonIdleTimer.current);
            }, []);

            useEffect(() => {
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);
                
                if (appConfig.floatingButtonAutoHide === false) return;

                const scaleFactor = (appConfig.uiScale || 100) / 100;
                const screenWidth = window.innerWidth / scaleFactor;

                const isLeft = buttonPos.x < 40;
                const isRight = buttonPos.x > screenWidth - 96;

                if (isLeft || isRight) {
                    hideTimer.current = setTimeout(() => {
                        setIsHidden(true);
                    }, 3000);
                }
            }, [buttonPos, appConfig.floatingButtonAutoHide, appConfig.uiScale]);

            const handleButtonDragStart = (e) => {
                resetButtonIdleTimer();
                setIsHidden(false);
                if (hideTimer.current) clearTimeout(hideTimer.current);

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                dragOffset.current = { x: clientX - buttonPos.x, y: clientY - buttonPos.y };
                isDragGesture.current = false;
                const startX = clientX;
                const startY = clientY;
                
                // [New] Track current position for snap logic
                let currentX = buttonPos.x;
                let currentY = buttonPos.y;

                const handleMove = (moveEvent) => {
                    const moveX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const moveY = moveEvent.touches ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    
                    if (!isDragGesture.current) {
                        const dist = Math.hypot(moveX - startX, moveY - startY);
                        if (dist > 5) {
                            isDragGesture.current = true;
                            setIsDraggingButton(true);
                        }
                    }

                    if (isDragGesture.current) {
                        if (moveEvent.cancelable) moveEvent.preventDefault();
                        let newX = moveX - dragOffset.current.x;
                        let newY = moveY - dragOffset.current.y;
                        newX = Math.max(10, Math.min(window.innerWidth - 70, newX));
                        newY = Math.max(10, Math.min(window.innerHeight - 70, newY));
                        currentX = newX;
                        currentY = newY;
                        setButtonPos({ x: newX, y: newY });
                    }
                };

                const handleUp = () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleUp);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', handleUp);
                    setIsDraggingButton(false);
                    
                    if (isDragGesture.current) {
                        const screenWidth = window.innerWidth;
                        const btnSize = appConfig.floatingButtonSize || 'medium';
                        const radius = btnSize === 'small' ? 20 : btnSize === 'large' ? 32 : btnSize === 'xlarge' ? 40 : 28;
                        const btnCenter = currentX + radius;
                        const snapMargin = 24;
                        let finalX = currentX;
                        
                        if (window.innerWidth >= 768) {
                            // [Mod] ë°ìŠ¤í¬íƒ‘: ê°€ì¥ìë¦¬ ê·¼ì²˜(100px)ì— ê°”ì„ ë•Œë§Œ ìì„ íš¨ê³¼ ì ìš©
                            const snapThreshold = 100;
                            if (currentX < snapThreshold) finalX = snapMargin;
                            else if (currentX > screenWidth - (radius * 2) - snapThreshold) finalX = screenWidth - (radius * 2) - snapMargin;
                            else {
                                setButtonPos({ x: currentX, y: currentY });
                                return; // ì¤‘ê°„ì— ë†“ìœ¼ë©´ ììœ  ë°°ì¹˜
                            }
                        } else {
                            // ëª¨ë°”ì¼: í•­ìƒ ê°€ì¥ ê°€ê¹Œìš´ ë²½ìœ¼ë¡œ ì´ë™
                            if (btnCenter < screenWidth / 2) finalX = snapMargin;
                            else finalX = screenWidth - (radius * 2) - snapMargin;
                        }
                        
                        setButtonPos({ x: finalX, y: currentY });
                    }
                };

                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleUp);
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleUp);
            };

            // [Fix] onSnapshot ë‚´ë¶€ì—ì„œ ìµœì‹  students ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Ref
            const studentsRef = useRef(students);
            useEffect(() => { studentsRef.current = students; }, [students]);

            useEffect(() => {
                if (isLoading) {
                    const timer = setInterval(() => {
                        setLoadingProgress(prev => {
                            if (prev >= 95) return prev;
                            return prev + Math.random() * 5;
                        });
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [isLoading]);

            useEffect(() => {
                let timer;
                if (isLoading) {
                    timer = setTimeout(() => setShowLongLoading(true), 7000); // 7ì´ˆ í›„ ë²„íŠ¼ í‘œì‹œ
                }
                return () => clearTimeout(timer);
            }, [isLoading]);

            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                
                const userAgent = window.navigator.userAgent.toLowerCase();
                setIsIOS(/iphone|ipad|ipod/.test(userAgent));
                setIsStandalone(window.matchMedia('(display-mode: standalone)').matches);

                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallApp = () => {
                setShowInstallGuide(true);
            };

            const confirmInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') { setDeferredPrompt(null); setShowInstallGuide(false); }
                } else if (!isIOS) {
                    setToastMessage("ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆê±°ë‚˜ ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                }
            };

            const handleGearClick = (e) => {
                e.stopPropagation();
                if (gearClickTimer.current) clearTimeout(gearClickTimer.current);
                const newCount = gearClickCount + 1;
                setGearClickCount(newCount);
                
                if (newCount >= 3) {
                    const newMode = !isDevMode;
                    setIsDevMode(newMode);
                    localStorage.setItem('cls_dev_mode', newMode);
                    setToastMessage(newMode ? "ê°œë°œì ëª¨ë“œ ON: AI ì „ì†¡ ë‚´ìš©ì„ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." : "ê°œë°œì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setGearClickCount(0);
                } else {
                    gearClickTimer.current = setTimeout(() => setGearClickCount(0), 500);
                }
            };

            useEffect(() => {
                const updateIcons = async () => {
                    const defaultSvg = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>";
                    const iconSrc = appConfig.favicon || defaultSvg;
                    
                    // [Fix] ë¸Œë¼ìš°ì € ìºì‹œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ì¬ìƒì„±
                    const existingFavicon = document.getElementById('app-favicon');
                    if (existingFavicon) existingFavicon.remove();
                    const newFavicon = document.createElement('link');
                    newFavicon.id = 'app-favicon';
                    newFavicon.rel = 'icon';
                    newFavicon.href = iconSrc;
                    document.head.appendChild(newFavicon);

                    // [iOS í˜¸í™˜ì„±] ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì„œ PNGë¡œ ë³€í™˜ (í°ìƒ‰ ë°°ê²½ ì¶”ê°€)
                    const getPngDataUrl = (src) => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = 192; canvas.height = 192;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = "#ffffff"; // iOSëŠ” íˆ¬ëª… ë°°ê²½ì„ ê²€ê²Œ ì²˜ë¦¬í•˜ë¯€ë¡œ í°ìƒ‰ ë°°ê²½ í•„ìˆ˜
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0, 192, 192);
                                resolve(canvas.toDataURL('image/png'));
                            };
                            img.onerror = () => resolve(src); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
                            img.src = src;
                        });
                    };

                    let pngIcon = iconSrc;
                    if (iconSrc.startsWith('data:image')) {
                        try { pngIcon = await getPngDataUrl(iconSrc); } catch (e) { console.error(e); }
                    }

                    // [Fix] ê¸°ì¡´ íƒœê·¸ ì œê±° í›„ ì¬ìƒì„± (ë¸Œë¼ìš°ì € ì¸ì‹ ê°•ì œ)
            const existingAppleLinks = document.querySelectorAll('link[rel*="apple-touch-icon"]');
                    existingAppleLinks.forEach(el => el.remove());
                    const appleIconLink = document.createElement('link');
                    appleIconLink.rel = 'apple-touch-icon';
                    document.head.appendChild(appleIconLink);
                    appleIconLink.href = pngIcon;

                    const manifest = {
                        name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        short_name: appConfig.recordTitle || "ë‹¤í–ˆë‚˜ìš”!?",
                        start_url: "./index.html",
                        display: "standalone",
                        background_color: "#ffffff",
                        theme_color: "#ffffff",
                        icons: [ { src: pngIcon, sizes: "192x192", type: "image/png" }, { src: pngIcon, sizes: "512x512", type: "image/png" } ]
                    };
                    
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    
                    const existingManifest = document.getElementById('app-manifest');
                    if (existingManifest) {
                        URL.revokeObjectURL(existingManifest.href);
                        existingManifest.remove();
                    }
                    const manifestLink = document.createElement('link');
                    manifestLink.id = 'app-manifest';
                    manifestLink.rel = 'manifest';
                    document.head.appendChild(manifestLink);
                    manifestLink.href = manifestURL;
                };
                updateIcons();
            }, [appConfig.favicon, appConfig.recordTitle]);

            // [Fix] ë¹„ë™ê¸° ë¡œì§(setTimeout) ë‚´ì—ì„œ ìµœì‹  ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Refs ì¶”ê°€
            const groupsByDateRef = useRef(groupsByDate);
            const groupRolesRef = useRef(groupRoles);
            useEffect(() => { groupsByDateRef.current = groupsByDate; }, [groupsByDate]);
            useEffect(() => { groupRolesRef.current = groupRoles; }, [groupRoles]);

            // [New] ë°ì´í„° ë³µêµ¬(Hydration) í•¨ìˆ˜: IDë§Œ ìˆëŠ” ëª¨ë‘  ë°ì´í„°ì— í•™ìƒ ìƒì„¸ ì •ë³´ë¥¼ ì±„ì›Œë„£ìŒ
            const hydrateGroups = (groupsData, studentsList) => {
                if (!groupsData) return {};
                const newGroups = { ...groupsData }; // ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬
                Object.keys(groupsData).forEach(date => {
                    if (Array.isArray(groupsData[date])) {
                        newGroups[date] = groupsData[date].map(groupItem => {
                            // [Fix] Firestore Nested Array ì§€ì›: { list: [...] } í˜•íƒœë¼ë©´ ë°°ì—´ë¡œ ë³€í™˜
                            let group = groupItem;
                            if (!Array.isArray(groupItem) && groupItem && groupItem.list && Array.isArray(groupItem.list)) {
                                group = groupItem.list;
                            }
                            
                            if (!Array.isArray(group)) return []; // [Safety] ë°°ì—´ì´ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜í•˜ì—¬ ì•± ë©ˆì¶¤(Crash) ë°©ì§€

                            return group.map(s => {
                                const id = (typeof s === 'object' && s !== null) ? s.id : s;
                                // [Fix] ID íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€ ë° ì´ë¦„ ë§¤ì¹­ Fallback ì¶”ê°€ (ë¬¸ìì—´/ìˆ«ì ë¹„êµ)
                                let fullStudent = studentsList.find(st => String(st.id) === String(id));
                                if (!fullStudent && typeof s === 'object' && s.name) {
                                    fullStudent = studentsList.find(st => st.name === s.name);
                                }
                                // [Fix] í•™ìƒ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°ì²´(s)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©, IDë§Œ ìˆë‹¤ë©´ ê¸°ë³¸ ê°ì²´ ìƒì„±
                                return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                            });
                        });
                    }
                });
                return newGroups;
            };

            // [New] í•™ìƒ ê°œë³„ ë°ì´í„°(ìƒë‹´ê¸°ë¡, ì´ˆì•ˆ) ì €ì¥ í•¨ìˆ˜
            const saveStudentDataToFirestore = async (studentId, data) => {
                if (isLocalMode || !db || !appId) return;
                try {
                    await db.collection('classes').doc(appId).collection('studentData').doc(String(studentId)).set(data, { merge: true });
                } catch (e) {
                    console.error("í•™ìƒ ê°œë³„ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
                    logSystemEvent(`í•™ìƒ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨(${studentId}): ${e.message}`, 'error');
                    setToastMessage("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ì¥ í•¨ìˆ˜ (1MB ì œí•œ íšŒí”¼ìš©)
            const saveGroupsToFirestore = async (groupsMap) => {
            if (isLocalMode || !db || !appId) return;
            const batch = db.batch();
            Object.entries(groupsMap).forEach(([date, groups]) => {
                const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                // ğŸŒŸ Firestore ì¤‘ì²© ë°°ì—´(Nested Array) ì—ëŸ¬ ë°©ì§€: ì•ˆìª½ ë°°ì—´ì„ { list: [...] } í˜•íƒœë¡œ ê°ì‹¸ì¤ë‹ˆë‹¤!
                const cleanGroups = groups.map(g => ({
                    list: g.map(s => ({ id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order }))
                }));
                batch.set(ref, { list: cleanGroups });
            });
            try {
                await batch.commit();
            } catch (e) {
                console.error(e);
                setToastMessage("ëª¨ë‘  ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        };
            
            // [New] ê³¼ì œ ë°ì´í„°(Daily, Weekly, Tags) ì €ì¥ í•¨ìˆ˜
            const saveTasksToFirestore = async (data) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                
                if (data.dailyTasks) {
                    Object.entries(data.dailyTasks).forEach(([date, tasks]) => {
                        const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                        batch.set(ref, { list: tasks }); // Overwrite list for that date
                    });
                }
                
                if (data.weeklyTasks) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { weekly: data.weeklyTasks }, { merge: true });
                }
                if (data.tags) {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc('settings');
                    batch.set(ref, { tags: data.tags }, { merge: true });
                }

                try { await batch.commit(); } 
                catch (e) { console.error(e); setToastMessage("ê³¼ì œ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì €ì¥ í•¨ìˆ˜
            const saveRecordsToFirestore = async (recordsMap) => {
                if (isLocalMode || !db || !appId) return;
                const entries = Object.entries(recordsMap);
                const chunkSize = 450; // Firestore ë°°ì¹˜ ì œí•œ(500) ê³ ë ¤
                try {
                    for (let i = 0; i < entries.length; i += chunkSize) {
                        const batch = db.batch();
                        const chunk = entries.slice(i, i + chunkSize);
                        chunk.forEach(([date, data]) => {
                            const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                            batch.set(ref, data);
                        });
                        await batch.commit();
                    }
                } catch (e) { console.error(e); setToastMessage("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            // [New] í™œë™ ê¸°ë¡(Records) í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteRecordsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('records').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            // [New] Firestore í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í•¨ìˆ˜
            const deleteGroupsFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('groupResults').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); }
                catch (e) { console.error(e); }
            };
            
            // [New] ê³¼ì œ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
            const deleteTasksFromFirestore = async (dates) => {
                if (isLocalMode || !db || !appId) return;
                const batch = db.batch();
                dates.forEach(date => {
                    const ref = db.collection('classes').doc(appId).collection('tasks').doc(date);
                    batch.delete(ref);
                });
                try { await batch.commit(); } catch (e) { console.error(e); }
            };

            const handleRangeSelect = (start, end) => {
                setDate(start);
                const diff = dayjs(end).diff(dayjs(start), 'day') + 1;
                setGroupDuration(diff);
            };

            useEffect(() => {
                // Mobile Drag Drop Polyfill Init
                if (window.MobileDragDrop) {
                    window.MobileDragDrop.polyfill({ dragImageTranslateOverride: window.MobileDragDrop.scrollBehaviourDragImageTranslateOverride });
                }
            }, []);

            useEffect(() => { setAiReason(null); setFocusedGroupIdx(null); }, [date]);

            const handleSaveCounseling = (studentId, note, msg) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage(msg || "ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveStickers = (studentId, count) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
            };

            const validateApiKey = async () => {
                if (!apiKey) return setToastMessage("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if (response.ok) {
                        setIsApiKeyValid(true);
                        setToastMessage(`ìœ íš¨í•œ API í‚¤ì…ë‹ˆë‹¤. (${GEMINI_MODEL_NAME})`);
                        logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì„±ê³µ (${GEMINI_MODEL_NAME})`);
                    } else {
                        setIsApiKeyValid(false);
                        const data = await response.json();
                        setToastMessage("í‚¤ ì˜¤ë¥˜: " + (data.error?.message || "ì•Œ ìˆ˜ ì—†ìŒ"));
                    }
                } catch (e) {
                    setIsApiKeyValid(false);
                    logSystemEvent(`API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì˜¤ë¥˜: " + e.message);
                }
            };

            const callGemini = async (apiKey, prompt) => {
                if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${apiKey.trim()}`;
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || response.statusText);
                    updateAiUsage();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch (e) {
                    logSystemEvent(`AI ìš”ì²­ ì‹¤íŒ¨: ${e.message}`, 'error');
                    throw new Error("AI ìš”ì²­ ì‹¤íŒ¨: " + e.message);
                }
            };

            const handleDownloadGroupsImage = async () => {
                if (!groupsRef.current) return;
                const originalBtnText = isGenerating; 
                setIsGenerating(true); 
                try {
                    const canvas = await window.html2canvas(groupsRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `ëª¨ë‘ í¸ì„±_${dayjs(date).format('YYYYMMDD')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setToastMessage("ëª¨ë‘  í¸ì„± ê²°ê³¼ê°€ ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { 
                    logSystemEvent(`ëª¨ë‘  í¸ì„± ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message); 
                } 
                finally { setIsGenerating(false); }
            };

        const handleCopyAiReport = () => {
            if (!aiReason) return;
            navigator.clipboard.writeText(aiReason);
            setToastMessage("ë¦¬í¬íŠ¸ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        const handleSaveAiReport = () => {
            if (!aiReason) return;
            const blob = new Blob([aiReason], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `AI_ëª¨ë‘ í¸ì„±_ë¦¬í¬íŠ¸_${dayjs().format('YYYYMMDD')}.txt`;
            link.click();
            setToastMessage("ë¦¬í¬íŠ¸ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

            const handleExportDrafts = () => {
                logSystemEvent('ì´í‰ ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸° ì‹œë„');
                let content = "";
                let count = 0;
                const sortedStudents = [...students].sort((a, b) => a.order - b.order);

                sortedStudents.forEach(s => {
                    if (s.recordDrafts && Object.keys(s.recordDrafts).length > 0) {
                        content += `##################################################\n`;
                        content += `# ${s.order}ë²ˆ ${s.name}\n`;
                        content += `##################################################\n\n`;
                        
                        const drafts = Object.entries(s.recordDrafts).sort((a, b) => a[0].localeCompare(b[0]));
                        
                        drafts.forEach(([key, text]) => {
                            if (!text) return;
                            const [type, semester] = key.split('_');
                            let typeName = type;
                            if (type === 'behavior') typeName = 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬';
                            else if (type === 'subject') typeName = 'êµê³¼ í•™ìŠµ ë°œë‹¬ ìƒí™©';
                            
                            const semesterName = semester === 'all' ? 'ì „ì²´' : `${semester}í•™ê¸°`;
                            
                            content += `[${typeName} - ${semesterName}]\n`;
                            content += `${text}\n\n`;
                            content += `--------------------------------------------------\n\n`;
                        });
                        content += `\n`;
                        count++;
                    }
                });

                if (count === 0) {
                    setToastMessage("ì €ì¥ëœ í–‰ë°œ ì´ˆì•ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `ì´í‰ì´ˆì•ˆ_ì¼ê´„ë‚´ë³´ë‚´ê¸°_${dayjs().format('YYYYMMDD')}.txt`;
                link.click();
                setToastMessage(`${count}ëª…ì˜ ì´ˆì•ˆì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
            };

            const handleSaveStickerWithNote = (studentId, count, note) => {
                const updatedStudents = students.map(s => s.id === studentId ? { ...s, stickers: count, counseling: note } : s);
                setStudents(updatedStudents);
                if (!isLocalMode) saveData('cls_students', updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { counseling: note });
                setToastMessage("ì¹­ì°¬ ìŠ¤í‹°ì»¤ ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRecordDraft = (studentId, draftKey, draftText) => {
                const updatedStudents = students.map(s => {
                    if (s.id === studentId) {
                        const newDrafts = { ...(s.recordDrafts || {}), [draftKey]: draftText };
                        return { ...s, recordDrafts: newDrafts };
                    }
                    return s;
                });
                setStudents(updatedStudents);
                if (!isLocalMode) saveStudentDataToFirestore(studentId, { recordDrafts: updatedStudents.find(s=>s.id===studentId).recordDrafts });
                setToastMessage("ì´ˆì•ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const exportData = useCallback(() => { const data = { version: appConfig.version, date: dayjs().format('YYYY-MM-DD HH:mm:ss'), students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Checklist_Backup_${dayjs().format('YYYYMMDD_HHmm')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); setToastMessage("ìë™ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }, [students, records, groupsByDate, avoidancePairs, mustPairs, dailyTasks, weeklyTasks, tags, appConfig, groupNames, groupRoles, rolesList, roleDescriptions, seatAssignments, seatConfig]);
            
            useEffect(() => { const checkTime = () => { const isEnabled = localStorage.getItem('cls_auto_backup') === 'true'; if (!isEnabled) return; const now = dayjs(); const nowStr = now.format('HH:mm'); if (backupTimes.includes(nowStr) && lastBackupTime.current !== nowStr) { lastBackupTime.current = nowStr; exportData(); } }; const interval = setInterval(checkTime, 10000); return () => clearInterval(interval); }, [exportData, backupTimes]);
            
            const handleGrassTitleClick = () => {
                setToastMessage("í™œë™ ì”ë””ì…ë‹ˆë‹¤.");
            };

            // [New] ëª¨ë‘  ë°ì´í„° ì‹¤ì‹œê°„ ë³µêµ¬ (Hydration) ë° ë™ê¸°í™”
            const groups = useMemo(() => {
                const currentGroups = groupsByDate[date] || [];
                if (!Array.isArray(currentGroups)) return [];
                
                return currentGroups.map(group => {
                    if (!Array.isArray(group)) return [];
                    return group.map(s => {
                        if (!s) return null;
                        // í•™ìƒ ëª©ë¡ì—ì„œ ìµœì‹  ì •ë³´ ì°¾ê¸° (ID ê¸°ë°˜ ë§¤í•‘)
                        const id = (typeof s === 'object') ? s.id : s;
                        // [Fix] í™”ë©´ í‘œì‹œ ì‹œì—ë„ ID íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€
                        let fullStudent = students.find(st => String(st.id) === String(id));
                        if (!fullStudent && typeof s === 'object' && s.name) {
                            fullStudent = students.find(st => st.name === s.name);
                        }
                        // ìµœì‹  ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ì •ë³´ ì‚¬ìš©í•˜ë˜ í•„ìˆ˜ í•„ë“œ ê¸°ë³¸ê°’ ë³´ì¥
                        return fullStudent ? { ...fullStudent } : (typeof s === 'object' ? s : { id: id, name: 'ë¯¸ë“±ë¡', gender: 'M', skill: 1 });
                    }).filter(s => s !== null);
                });
            }, [groupsByDate, date, students]);

            const progress = students.length ? (students.filter(s => records[date]?.[s.id]?.done).length / students.length) * 100 : 0;
            const classAvgSkill = useMemo(() => students.length > 0 ? students.reduce((a, s) => a + s.skill, 0) / students.length : 0, [students]);
            const openConfirm = (message, onConfirm, onCancel = null) => { setConfirmModal({ isOpen: true, message: message, onConfirm: onConfirm, onCancel: onCancel }); };

           useEffect(() => {
                const savedConfig = safeLocalStorage.getItem('checklist_config');
                
                // [New] ìºì‹œ ìš°ì„  ë¡œë”© (Offline-First): ë¡œì»¬ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì„œ ë¡œë”© í™”ë©´ ì¦‰ì‹œ ì œê±°
                const ls = (k) => safeLocalStorage.getItem(k);
                try {
                    if (ls('cls_students')) setStudents(JSON.parse(ls('cls_students')));
                    if (ls('cls_records')) setRecords(JSON.parse(ls('cls_records')));
                    if (ls('cls_groups_date')) setGroupsByDate(JSON.parse(ls('cls_groups_date')));
                    if (ls('cls_avoidance')) setAvoidancePairs(JSON.parse(ls('cls_avoidance')));
                    if (ls('cls_mustPairs')) setMustPairs(JSON.parse(ls('cls_mustPairs')) || []);
                    if (ls('cls_app_config')) setAppConfig({ ...JSON.parse(ls('cls_app_config')), version: CURRENT_VERSION });
                    if (ls('cls_daily_tasks')) setDailyTasks(JSON.parse(ls('cls_daily_tasks')));
                    if (ls('cls_weekly_tasks')) setWeeklyTasks(JSON.parse(ls('cls_weekly_tasks')));
                    if (ls('cls_tags')) setTags(JSON.parse(ls('cls_tags')));
                    if (ls('cls_group_names')) setGroupNames(JSON.parse(ls('cls_group_names')));
                    if (ls('cls_group_roles')) setGroupRoles(JSON.parse(ls('cls_group_roles')));
                    if (ls('cls_roles_list')) setRolesList(JSON.parse(ls('cls_roles_list')));
                    if (ls('cls_role_descriptions')) setRoleDescriptions(JSON.parse(ls('cls_role_descriptions')));
                    if (ls('cls_seat_assignments')) setSeatAssignments(JSON.parse(ls('cls_seat_assignments')));
                    if (ls('cls_seat_config')) setSeatConfig(JSON.parse(ls('cls_seat_config')));
                    if (ls('cls_ai_key')) setApiKey(ls('cls_ai_key'));
                } catch (e) { console.error("Cache load error", e); }
                
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        
                        const firestore = firebase.firestore();
                        setDb(firestore);
                        setAppId(config.projectId);
                        setIsLocalMode(false);

                        logSystemEvent(`Firebase ì—°ê²° ì‹œë„: ${config.projectId}`);
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                logSystemEvent(`Firebase ë¡œê·¸ì¸ ì„±ê³µ: ${user.email}`);
                                firestore.collection('artifacts').doc(config.projectId).collection('public').doc('data').onSnapshot(doc => {
                                    if (doc.exists) {
                                        const d = doc.data();
                                        if (d.students) setStudents(d.students);
                                        if (d.records) setRecords(prev => ({ ...d.records, ...prev })); // [Fix] ë©”ì¸ ë¬¸ì„œ ê¸°ë¡ì€ í•˜ìœ„ í˜¸í™˜ìš©ìœ¼ë¡œ ë¡œë“œí•˜ë˜, ë¡œì»¬/í•˜ìœ„ì»¬ë ‰ì…˜ ë°ì´í„° ìš°ì„ 
                                        if (d.groupsByDate) {
                                            // [Fix] d.studentsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì„ ê²½ìš° ë¡œì»¬ ìµœì‹  ìƒíƒœ(studentsRef)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µêµ¬ ì‹œë„
                                            // ë¡œì»¬ ìƒíƒœì™€ ì„œë²„ ìƒíƒœë¥¼ ë³‘í•©í•˜ì—¬ ìµœëŒ€í•œ ë§ì€ í•™ìƒ ì •ë³´ë¥¼ í™•ë³´
                                            const serverStudents = d.students || [];
                                            const localStudents = studentsRef.current || [];
                                            const mergedStudents = [...localStudents];
                                            serverStudents.forEach(s => {
                                                if (!mergedStudents.find(ls => String(ls.id) === String(s.id))) {
                                                    mergedStudents.push(s);
                                                }
                                            });

                                            // [Fix] ëª¨ë‘  ë°ì´í„° ë™ê¸°í™” ì‹œ ë¡œì»¬ ë°ì´í„° ìœ ì‹¤ ë°©ì§€ (ë°©ê¸ˆ ìƒì„±í•œ ë°ì´í„° ë³´í˜¸)
                                            const serverGroups = d.groupsByDate || {};
                                            const localGroups = groupsByDateRef.current || {};
                                            const mergedGroups = { ...serverGroups };

                                            // ë¡œì»¬ì—ë§Œ ìˆê³  ì„œë²„ì— ì—†ëŠ”(ë¹„ì–´ìˆëŠ”) ë‚ ì§œì˜ ë°ì´í„°ëŠ” ë¡œì»¬ ë°ì´í„° ìœ ì§€ (ë°©ê¸ˆ í¸ì„±í•œ ê²½ìš°)
                                            Object.keys(localGroups).forEach(date => {
                                                if (localGroups[date] && localGroups[date].length > 0) {
                                                    // ì„œë²„ ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜ ë¹ˆ ë°°ì—´ì¸ ê²½ìš° ë¡œì»¬ ë°ì´í„° ì‚¬ìš©
                                                    if (!serverGroups[date] || serverGroups[date].length === 0) {
                                                        mergedGroups[date] = localGroups[date];
                                                    }
                                                }
                                            });

                                            const hydrated = hydrateGroups(mergedGroups, mergedStudents);
                                            setGroupsByDate(hydrated);
                                        }
                                        if (d.avoidance) setAvoidancePairs(d.avoidance);
                                        if (d.mustPairs) setMustPairs(d.mustPairs);
                    if (d.config) setAppConfig({ ...d.config, version: CURRENT_VERSION });
                                        if (d.dailyTasks) setDailyTasks(d.dailyTasks);
                                        if (d.weeklyTasks) setWeeklyTasks(d.weeklyTasks);
                                        if (d.tags) setTags(d.tags);
                                        if (d.groupNames) setGroupNames(d.groupNames);
                                        if (d.groupRoles) setGroupRoles(d.groupRoles);
                                        if (d.rolesList) setRolesList(d.rolesList);

                                        // [New] AI Key ë° Notion ì„¤ì • ìë™ ë™ê¸°í™”
                                        if (d.aiKey) {
                                            setApiKey(d.aiKey);
                                            localStorage.setItem('cls_ai_key', d.aiKey);
                                        }
                                        if (d.notionKey) localStorage.setItem('cls_notion_key', d.notionKey);
                                        if (d.notionDbId) localStorage.setItem('cls_notion_db_id', d.notionDbId);
                                        // [Fix] snake_case í‚¤ ì§€ì› ë° í¬íŠ¸í´ë¦¬ì˜¤ ID ë¡œë”©
                                        if (d.notion_key) localStorage.setItem('cls_notion_key', d.notion_key);
                                        if (d.notion_db_id) localStorage.setItem('cls_notion_db_id', d.notion_db_id);
                                        if (d.notion_portfolio_db_id) { localStorage.setItem('cls_notion_portfolio_db_id', d.notion_portfolio_db_id); setPortfolioDbId(d.notion_portfolio_db_id); }
                                        if (d.studentMap) { setStudentMap(d.studentMap); localStorage.setItem('cls_student_map', JSON.stringify(d.studentMap)); }
                                        if (d.portfolio_mode !== undefined) { 
                                            setIsPortfolioMode(d.portfolio_mode); 
                                            localStorage.setItem('cls_portfolio_mode', d.portfolio_mode); 
                                        }
                                        
                                        // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                                        setIsLoading(false);
                                        if (!localStorage.getItem('cls_intro_shown')) {
                                            setShowOfflineModal(true);
                                            setAutoCloseTimer(3);
                                            localStorage.setItem('cls_intro_shown', 'true');
                                        }
                                    } else {
                                        // [Fix] ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš°ì—ë„ ë¡œë”© í•´ì œ (ë¬´í•œ ë¡œë”© ë°©ì§€)
                                        setIsLoading(false);
                                    }
                                }, (error) => {
                                    logSystemEvent(`Firestore ìŠ¤ëƒ…ìƒ· ì—ëŸ¬: ${error.message}`, 'error');
                                    setIsLoading(false); // [Fix] ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© í•´ì œ
                                    setToastMessage("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: " + error.message);
                                });

                                // [New] ëª¨ë‘  ê²°ê³¼ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('groupResults').onSnapshot(snapshot => {
                                    const newGroups = {};
                                    snapshot.docs.forEach(doc => {
                                        newGroups[doc.id] = doc.data().list;
                                    });
                                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì„œë²„ ë°ì´í„° ìš°ì„ )
                                    setGroupsByDate(prev => hydrateGroups({ ...prev, ...newGroups }, studentsRef.current));
                                });

                                // [New] í™œë™ ê¸°ë¡ í•˜ìœ„ ì»¬ë ‰ì…˜ ë¦¬ìŠ¤ë„ˆ (1MB ì œí•œ íšŒí”¼)
                                firestore.collection('classes').doc(config.projectId).collection('records').onSnapshot(snapshot => {
                                    setRecords(prev => {
                                        const next = { ...prev };
                                        snapshot.docChanges().forEach(change => {
                                            if (change.type === 'added' || change.type === 'modified') next[change.doc.id] = change.doc.data();
                                            if (change.type === 'removed') delete next[change.doc.id];
                                        });
                                        return next;
                                    });
                                });
                                
                                // [New] ê³¼ì œ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
                                firestore.collection('classes').doc(config.projectId).collection('tasks').onSnapshot(snapshot => {
                                    snapshot.docChanges().forEach(change => {
                                        if (change.doc.id === 'settings') {
                                            const data = change.doc.data();
                                            if (data.weekly) setWeeklyTasks(data.weekly);
                                            if (data.tags) setTags(data.tags);
                                        } else {
                                            if (change.type === 'removed') {
                                                setDailyTasks(prev => {
                                                    const next = { ...prev };
                                                    delete next[change.doc.id];
                                                    return next;
                                                });
                                            } else {
                                                setDailyTasks(prev => ({ ...prev, [change.doc.id]: change.doc.data().list }));
                                            }
                                        }
                                    });
                                });
                            } else {
                                logSystemEvent('Firebase ë¡œê·¸ì¸ ìƒíƒœ ì•„ë‹˜', 'warning');
                                setIsLoading(false);
                            }
                        });
                    } catch (e) { logSystemEvent(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${e.message}`, 'error'); setIsLocalMode(true); setIsLoading(false); }
                } else {
                    // ë¡œì»¬ ëª¨ë“œ (ìœ„ì—ì„œ ì´ë¯¸ ë¡œë“œí•¨)
                    
                    // [ì¶”ê°€ë¨] ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                    setIsLoading(false);
                    if (!localStorage.getItem('cls_intro_shown')) {
                        setShowOfflineModal(true);
                        setAutoCloseTimer(3);
                        localStorage.setItem('cls_intro_shown', 'true');
                    }
                }
            }, []);

            useEffect(() => {
                let timer;
                if (showOfflineModal && autoCloseTimer > 0) {
                    timer = setTimeout(() => setAutoCloseTimer(p => p - 1), 1000);
                } else if (showOfflineModal && autoCloseTimer === 0) {
                    setShowOfflineModal(false);
                }
                return () => clearTimeout(timer);
            }, [showOfflineModal, autoCloseTimer]);
            
            useEffect(() => { if (mode === 'record') { const dayOfWeek = dayjs(date).day(); if ((!dailyTasks[date] || dailyTasks[date].length === 0) && weeklyTasks[dayOfWeek]?.length > 0) { const tasksToAdd = weeklyTasks[dayOfWeek].map(t => typeof t === 'string' ? { title: t, tag: 'ê¸°íƒ€' } : t); const newDailyTasks = { ...dailyTasks, [date]: tasksToAdd }; setDailyTasks(newDailyTasks); if (isLocalMode) saveData('cls_daily_tasks', newDailyTasks); } } }, [date, mode, weeklyTasks]);
            
            // [Fix] saveData í•¨ìˆ˜ ê°œì„ : ë‹¨ì¼ í‚¤/ê°’ ì €ì¥ë¿ë§Œ ì•„ë‹ˆë¼ ê°ì²´ í˜•íƒœì˜ ì¼ê´„ ì €ì¥(Batch) ì§€ì›
            const saveData = async (keyOrData, value) => {
                const updates = (typeof keyOrData === 'object') ? keyOrData : { [keyOrData]: value };
                
                // [New] í´ë¼ìš°ë“œ ëª¨ë“œì—¬ë„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í•­ìƒ ìºì‹œ(ë°±ì—…) ì €ì¥ (ë¹ ë¥¸ ë¡œë”© ë° ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
                Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));

                if (isLocalMode) {
                    Object.entries(updates).forEach(([k, v]) => localStorage.setItem(k, JSON.stringify(v)));
                    return;
                }
                
                if (db && appId) {
                    try {
                        const payload = {};
                        const batch = db.batch(); // ë°°ì¹˜ ì“°ê¸° ì‚¬ìš©
                        
                        for (const [k, v] of Object.entries(updates)) {
                            if (k === 'cls_groups_date') continue; // [New] ëª¨ë‘  ë°ì´í„°ëŠ” ë©”ì¸ ë¬¸ì„œì—ì„œ ì œì™¸ (1MB ì œí•œ íšŒí”¼)
                            if (k === 'cls_records') { saveRecordsToFirestore(v); continue; } // [New] ê¸°ë¡ ë°ì´í„°ëŠ” í•˜ìœ„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë¶„ë¦¬
                            if (k === 'cls_daily_tasks') { saveTasksToFirestore({ dailyTasks: v }); continue; } // [New] ê³¼ì œ ë°ì´í„° ë¶„ë¦¬
                            if (k === 'cls_weekly_tasks') { saveTasksToFirestore({ weeklyTasks: v }); continue; }
                            if (k === 'cls_tags') { saveTasksToFirestore({ tags: v }); continue; }
                            if (k === 'cls_student_map') { payload['studentMap'] = JSON.parse(JSON.stringify(v)); continue; }
                            const field = k.replace('cls_', '').replace('app_', '').replace('_date', 'ByDate');
                            const cleanData = JSON.parse(JSON.stringify(v));
                            
                            // [Fix] Firestore Nested Array ì˜¤ë¥˜ í•´ê²°: ëª¨ë‘  ë°ì´í„° ì €ì¥ ì‹œ ë‚´ë¶€ ë°°ì—´ì„ ê°ì²´ë¡œ ë˜í•‘
                            if (k === 'cls_groups_date') {
                                const wrappedData = {};
                                Object.keys(cleanData).forEach(d => {
                                    if (Array.isArray(cleanData[d])) {
                                        // [[s1, s2], [s3]] -> [{list: [s1, s2]}, {list: [s3]}]
                                        wrappedData[d] = cleanData[d].map(g => (Array.isArray(g) ? { list: g } : g));
                                    } else {
                                        wrappedData[d] = cleanData[d];
                                    }
                                });
                                payload[field] = wrappedData;
                            } else if (k === 'cls_students') {
                                // [New] í•™ìƒ ë°ì´í„° ì €ì¥ ì‹œ ìƒë‹´ê¸°ë¡/ì´ˆì•ˆ ë¶„ë¦¬ ì €ì¥ (ìš©ëŸ‰ ìµœì í™”)
                                const lightStudents = cleanData.map(s => {
                                    // ìƒë‹´ ê¸°ë¡ê³¼ ì´ˆì•ˆì´ ìˆë‹¤ë©´ ê°œë³„ ë¬¸ì„œë¡œ ì €ì¥
                                    if ((s.counseling && s.counseling.length > 0) || (s.recordDrafts && Object.keys(s.recordDrafts).length > 0)) {
                                        const studentRef = db.collection('classes').doc(appId).collection('studentData').doc(String(s.id));
                                        const studentData = {};
                                        if (s.counseling) studentData.counseling = s.counseling;
                                        if (s.recordDrafts) studentData.recordDrafts = s.recordDrafts;
                                        batch.set(studentRef, studentData, { merge: true });
                                    }
                                    // ë©”ì¸ ë¬¸ì„œì—ëŠ” ë¬´ê±°ìš´ ë°ì´í„° ì œì™¸
                                    const { counseling, recordDrafts, ...rest } = s;
                                    return rest;
                                });
                                payload[field] = lightStudents;
                            } else {
                                payload[field] = cleanData;
                            }
                        }
                        // ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ í•œ ë²ˆì— ì €ì¥ (Atomic Update)
                        const mainRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                        batch.set(mainRef, payload, { merge: true });
                        await batch.commit();
                    } catch (e) {
                        logSystemEvent(`Firebase ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
                        console.error(e);
                        setToastMessage(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                    }
                }
            };
            
            const useDeepEffect = (fn, deps) => { const isFirst = useRef(true);
            useEffect(() => { if (isFirst.current) { isFirst.current = false; return; } fn(); }, deps); };
            
            useDeepEffect(() => { if (isLocalMode) saveData('cls_groups_date', groupsByDate); }, [groupsByDate]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_students', students); }, [students]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_records', records); }, [records]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_avoidance', avoidancePairs); }, [avoidancePairs]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_mustPairs', mustPairs); }, [mustPairs]); 
            useDeepEffect(() => { if (isLocalMode) saveData('cls_app_config', appConfig); }, [appConfig]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_daily_tasks', dailyTasks); }, [dailyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_weekly_tasks', weeklyTasks); }, [weeklyTasks]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_names', groupNames); }, [groupNames]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_group_roles', groupRoles); }, [groupRoles]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_roles_list', rolesList); }, [rolesList]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_role_descriptions', roleDescriptions); }, [roleDescriptions]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_assignments', seatAssignments); }, [seatAssignments]);
            useDeepEffect(() => { if (isLocalMode) saveData('cls_seat_config', seatConfig); }, [seatConfig]);

            const toggleCheck = (id, taskIndex = null) => { 
                if (navigator.vibrate) navigator.vibrate(15);

                if (mode === 'simple') { const newDone = !simpleChecks[id];
            setSimpleChecks({ ...simpleChecks, [id]: newDone }); if (newDone) confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#6366f1', '#8b5cf6'] });
            return; } const currentRec = records[date]?.[id] || { done: false, tasks: {} }; const currentTasks = dailyTasks[date] || [];
            let newRec; if (taskIndex !== null) { const newTasksStatus = { ...currentRec.tasks, [taskIndex]: !currentRec.tasks?.[taskIndex] };
            const allDone = currentTasks.length > 0 && currentTasks.every((_, idx) => newTasksStatus[idx]); newRec = { ...currentRec, tasks: newTasksStatus, done: allDone };
            } else { const newDone = !currentRec.done; const newTasksStatus = {};
            if (currentTasks.length > 0) currentTasks.forEach((_, idx) => newTasksStatus[idx] = newDone); newRec = { ...currentRec, done: newDone, tasks: newTasksStatus };
            } const newRecords = { ...records, [date]: { ...records[date], [id]: newRec } }; setRecords(newRecords); if (!isLocalMode) saveRecordsToFirestore({ [date]: newRecords[date] });
            if (newRec.done) confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } }); };
            
            const resetDateRecord = () => { openConfirm(`${date} ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => { const newRecords = { ...records }; delete newRecords[date]; setRecords(newRecords); if (!isLocalMode) deleteRecordsFromFirestore([date]); setToastMessage("ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); });
            };
            
            const toggleLock = (studentId) => { setLockedIds(prev => prev.includes(studentId) ? prev.filter(id => id !== studentId) : [...prev, studentId]); };
            
            const applyPreset = (type) => {
                if (type === 'coop') { 
                    setUseGender(true);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'peer') { 
                    setUseGender(false);
                    setUseSkill(true); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                } else if (type === 'project') { 
                    setUseGender(true);
                    setUseSkill(false); setUseLeader(true); setIsAvoidanceVisible(true); setUseHistory(true);
                } else if (type === 'random') { 
                    setUseGender(false);
                    setUseSkill(false); setUseLeader(false); setIsAvoidanceVisible(false); setUseHistory(false);
                }
                setToastMessage(`'${type === 'coop' ? 'í˜‘ë™ í•™ìŠµ' : type === 'peer' ? 'ë˜ë˜ êµìˆ˜' : type === 'project' ? 'í”„ë¡œì íŠ¸' : 'ëœë¤'}' í”„ë¦¬ì…‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            // [New] ì—­í•  ê³„ì‚° í—¬í¼ í•¨ìˆ˜
            const calculateRoles = (groupsToAssign) => {
                const activeRoles = rolesList.length > 0 ? rolesList : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                const rolesForDate = {};
                groupsToAssign.forEach((group, gIdx) => {
                    rolesForDate[gIdx] = {};
                    for (let sIdx = 0; sIdx < group.length; sIdx++) {
                        const myRoles = [];
                        activeRoles.forEach((r, rIdx) => { 
                            if (rIdx % group.length === sIdx) myRoles.push(r); 
                        });
                        rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                    }
                });
                return rolesForDate;
            };

            // [New] ëª¨ë‘  ë³€ê²½ ì‹œ ì—­í•  ì—…ë°ì´íŠ¸ í—¬í¼
            const updateRolesIfActive = (newGroups) => {
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                }
            };

            // [New] ëª¨ë‘  ê²°ê³¼ë¥¼ ìë¦¬ ë°°ì¹˜ì— ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
            const syncSeatsWithGroups = (groupsToSync) => {
                try {
                    const newAssignments = {};
                    if (!groupsToSync || !Array.isArray(groupsToSync)) return;
                    const flatStudents = groupsToSync.flat().filter(s => s && s.id);
                    let idx = 0;
                    for (let r = 0; r < seatConfig.rows; r++) {
                        for (let c = 0; c < seatConfig.cols; c++) {
                            const key = `${r}-${c}`;
                            if ((seatConfig.disabledSeats || []).includes(key)) continue;
                            if (idx < flatStudents.length) {
                                newAssignments[key] = flatStudents[idx].id;
                                idx++;
                            }
                        }
                    }
                    setSeatAssignments(newAssignments);
                    if (!isLocalMode) saveData('cls_seat_assignments', newAssignments);
                } catch (e) {
                    console.error("Sync seats error:", e);
                    setToastMessage("ìë¦¬ ë°°ì¹˜ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜: " + e.message);
                }
            };

            const sanitizeStudent = (s) => {
                if (!s) return null;
                return { id: s.id, name: s.name, gender: s.gender, skill: s.skill, leader: s.leader, order: s.order };
            };
            
            const generateGroups = async () => {
                if (students.length === 0) return setToastMessage("í•™ìƒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");

                if (useAI) {
                    if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    setIsGenerating(true);
                    try {
                        const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(students.length / groupNumber);
                        
                        // [ë³´ì•ˆ] í•™ìƒ ëª…ë‹¨ ìµëª…í™” (í•™ìƒ1, í•™ìƒ2...)
                        const anonymizedMap = {};
                        const studentListStr = students.map((s, i) => {
                            const anonName = `í•™ìƒ${i+1}`;
                            anonymizedMap[anonName] = s;
                            const info = [`${s.gender === 'M' ? 'ë‚¨' : 'ì—¬'}`, `ì‹¤ë ¥${['í•˜','ì¤‘','ìƒ'][s.skill-1]}`];
                            if (s.leader) info.push('ë¦¬ë”');
                            return `${anonName}(${info.join(', ')})`;
                        }).join(', ');

                        const constraints = [];
                        if (avoidancePairs.length > 0) {
                            const avoidStr = avoidancePairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (avoidStr) constraints.push(`- ê¸°í”¼ ê´€ê³„(ê°™ì€ ëª¨ë‘  ê¸ˆì§€): ${avoidStr}`);
                        }
                        if (mustPairs.length > 0) {
                            const mustStr = mustPairs.map(p => {
                                const idx1 = students.findIndex(s => s.name === p.p1);
                                const idx2 = students.findIndex(s => s.name === p.p2);
                                if (idx1 >= 0 && idx2 >= 0) return `í•™ìƒ${idx1+1}ì™€ í•™ìƒ${idx2+1}`;
                                return null;
                            }).filter(x => x).join(', ');
                            if (mustStr) constraints.push(`- í•„ìˆ˜ ì§ê¿(ê°™ì€ ëª¨ë‘  í•„ìˆ˜): ${mustStr}`);
                        }
                        
                        // [New] useHistory ì˜µì…˜ ì ìš©
                        if (useHistory) {
                            const recentDates = Object.keys(groupsByDate).sort().reverse().slice(0, historyDuration);
                            if (recentDates.length > 0) {
                                const historyStr = recentDates.map(d => {
                                    const grps = groupsByDate[d] || [];
                                    return `- ${d}: ${grps.map(g => `[${g.map(s => {
                                        const idx = students.findIndex(st => st.id === s.id);
                                        return idx >= 0 ? `í•™ìƒ${idx+1}` : "ë¯¸í™•ì¸";
                                    }).join(',')}]`).join(', ')}`;
                                }).join('\n');
                                constraints.push(`- ì´ì „ ëª¨ë‘  êµ¬ì„±ê³¼ ìµœëŒ€í•œ ê²¹ì¹˜ì§€ ì•Šê²Œ í¸ì„±í•´ì£¼ì„¸ìš” (ìµœê·¼ ê¸°ë¡ ì°¸ê³ ):\n${historyStr}`);
                            }
                        }
                        
                        const userRequest = aiPrompt || "ì„±ë³„, ì‹¤ë ¥, ë¦¬ë”ë¥¼ ê³¨ê³ ë£¨ ì„ì–´ì„œ ê· í˜• ìˆê²Œ í¸ì„±í•´ì¤˜.";
                        
                        // [ë³´ì•ˆ] ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ë‚´ ì‹¤ëª… ìµëª…í™” (í•™ìƒNìœ¼ë¡œ ì¹˜í™˜)
                        let safeUserRequest = userRequest;
                        const sortedStudentsForMasking = [...students].sort((a, b) => b.name.length - a.name.length);
                        sortedStudentsForMasking.forEach(s => {
                            const originalIndex = students.findIndex(st => st.id === s.id);
                            if (originalIndex === -1) return;
                            const anonName = `í•™ìƒ${originalIndex + 1}`;
                            safeUserRequest = safeUserRequest.replaceAll(s.name, anonName);
                            if (s.name.length >= 3) safeUserRequest = safeUserRequest.replaceAll(s.name.substring(1), anonName);
                        });

                        const prompt = `
                            ë‹¹ì‹ ì€ í•™ê¸‰ ê²½ì˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒë“¤ì„ ${targetGroupCount}ê°œì˜ ëª¨ë‘ ìœ¼ë¡œ í¸ì„±í•´ì£¼ì„¸ìš”.
                            
                            [í•™ìƒ ëª…ë‹¨]
                            ${studentListStr}

                            [ì œì•½ ì¡°ê±´]
                            - ëª¨ë“  í•™ìƒì€ ì •í™•íˆ í•œ ê°œì˜ ëª¨ë‘ ì—ë§Œ ì†í•´ì•¼ í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°°ì • ê¸ˆì§€)
                            ${constraints.join('\n')}
                            
                            [ì‚¬ìš©ì ìš”ì²­]
                            "${safeUserRequest}"

                            [ì‘ë‹µ í˜•ì‹]
                            - ê²°ê³¼ëŠ” ë°˜ë“œì‹œ **JSON ê°ì²´**ë¡œ ì‘ì„±í•˜ì„¸ìš”.
                            - í˜•ì‹: { "groups": [["ì´ë¦„1", "ì´ë¦„2"], ...], "reason": "í¸ì„± ì´ìœ  ë° ì „ëµ ì„¤ëª… (2~3ë¬¸ì¥)" }
                            - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json)ì´ë‚˜ ë¶€ê°€ì ì¸ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
                        `;

                        const text = await callGemini(apiKey, prompt);
                        const jsonStr = text.replace(/```json|```/g, "").trim();
                        let result;
                        try {
                            result = JSON.parse(jsonStr);
                        } catch (e) {
                            // í˜¹ì‹œ ë°°ì—´ë¡œë§Œ ì™”ì„ ê²½ìš°ì— ëŒ€í•œ ë°©ì–´ ì½”ë“œ
                            if (Array.isArray(JSON.parse(jsonStr))) {
                                result = { groups: JSON.parse(jsonStr), reason: "AIê°€ ìµœì ì˜ ì¡°í•©ìœ¼ë¡œ í¸ì„±í–ˆìŠµë‹ˆë‹¤." };
                            } else {
                                throw e;
                            }
                        }
                        
                        const aiGroups = result.groups;
                        setAiReason(result.reason);

                        const mappedGroups = aiGroups.map(g => g.map(n => { 
                            const clean = n.split('(')[0].trim();
                            const s = anonymizedMap[clean];
                            return s ? sanitizeStudent(s) : { id: Math.random(), name: "ë¯¸í™•ì¸", gender: 'M', skill: 1, order: 0 };
                        }));

                        logSystemEvent('AI ëª¨ë‘  í¸ì„± ì„±ê³µ');
                        
                        const newGroupsData = { ...groupsByDate }; // [Fix] ë°ì´í„° ì‚­ì œ ë¡œì§ ì œê±°
                        const newGroupRoles = { ...groupRoles };
                        const hasActiveRoles = groupRoles[date] && Object.keys(groupRoles[date]).length > 0;
                        const groupsToSave = {};
                        
                        for(let i=0; i<groupDuration; i++) {
                            const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                            newGroupsData[d] = mappedGroups;
                            groupsToSave[d] = mappedGroups;
                            if (hasActiveRoles) newGroupRoles[d] = calculateRoles(mappedGroups);
                        }
                        
                        setGroupsByDate(newGroupsData);
                        if (!isLocalMode) saveGroupsToFirestore(groupsToSave);
                        
                        if (hasActiveRoles) {
                            setGroupRoles(newGroupRoles);
                            if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                        }

                        syncSeatsWithGroups(mappedGroups);
                        setToastMessage(`AI ëª¨ë‘  í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)`);
                        if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                    } catch (e) {
                        logSystemEvent(`AI ëª¨ë‘  í¸ì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                        setToastMessage("AI í¸ì„± ì‹¤íŒ¨: " + e.message);
                    } finally {
                        setIsGenerating(false);
                    }
                    return;
                }

                // [Fix] setTimeout ì œê±°: ìë¦¬ ë°°ì¹˜ë„ ë²„íŠ¼ì²˜ëŸ¼ ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ì•ˆì •ì„± í™•ë³´
                  try {
                    // ìµœì‹  ìƒíƒœ ì°¸ì¡° (Ref ì‚¬ìš© ë¶ˆí•„ìš”, ë™ê¸° ì‹¤í–‰ì´ë¯€ë¡œ í˜„ì¬ state ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€)
                    const currentGroupsByDate = groupsByDate;
                    const currentGroupRoles = groupRoles;
                    const currentStudents = students;

                    const currentGroups = currentGroupsByDate[date] || [];
                    const lockedMap = new Map();
                    const lockedStudentIds = new Set(lockedIds);
                    
                    if (currentGroups.length > 0) {
                        currentGroups.forEach((group, gIdx) => {
                            group.forEach(s => { if (lockedStudentIds.has(s.id)) lockedMap.set(s.id, gIdx); });
                        });
                    } else {
                        // í˜„ì¬ ë‚ ì§œì— ëª¨ë‘ ì´ ì—†ìœ¼ë©´ ê³¼ê±° ê¸°ë¡ì—ì„œ ê³ ì • í•™ìƒì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ìœ ì§€ (ê³ ì • í•™ìƒ ê¸°ëŠ¥ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse();
                        for (const d of sortedDates) {
                            const grps = currentGroupsByDate[d];
                            if (grps) {
                                grps.forEach((group, gIdx) => {
                                    group.forEach(s => { if (lockedStudentIds.has(s.id) && !lockedMap.has(s.id)) lockedMap.set(s.id, gIdx); });
                                });
                            }
                        }
                    }

                    const unlockedStudents = currentStudents.filter(s => !lockedStudentIds.has(s.id));
                    const lockedStudents = currentStudents.filter(s => lockedStudentIds.has(s.id));
                    const targetGroupCount = groupMethod === 'count' ? groupNumber : Math.ceil(currentStudents.length / groupNumber);
                    
                    const historyPairs = new Map();
                    if (useHistory) {
                        // ìµœê·¼ ê¸°ë¡ì¼ìˆ˜ë¡ ê°€ì¤‘ì¹˜ë¥¼ ë†’ê²Œ ë¶€ì—¬ (ì—°ì† ë°°ì • ë°©ì§€ ê°•í™”)
                        const sortedDates = Object.keys(currentGroupsByDate).sort().reverse().slice(0, historyDuration);
                        sortedDates.forEach((d, idx) => {
                            const weight = Math.max(1, 5 - Math.floor(idx / 2)); // 5, 5, 4, 4, 3, 3...
                            (currentGroupsByDate[d] || []).forEach(g => {
                                for(let i=0; i<g.length; i++) {
                                    for(let j=i+1; j<g.length; j++) {
                                        const k = [g[i].id, g[j].id].sort().join('-');
                                        historyPairs.set(k, (historyPairs.get(k) || 0) + weight);
                                    }
                                }
                            });
                        });
                    }

                    const clusters = [];
                    const visited = new Set();
                    const adj = {};
                    mustPairs.forEach(p => {
                        const n1 = currentStudents.find(s=>s.name === p.p1)?.id;
                        const n2 = currentStudents.find(s=>s.name === p.p2)?.id;
                        if(n1 && n2) {
                            if(!adj[n1]) adj[n1] = []; if(!adj[n2]) adj[n2] = [];
                            adj[n1].push(n2); adj[n2].push(n1);
                        }
                    });

                    unlockedStudents.forEach(s => {
                        if(visited.has(s.id)) return;
                        const cluster = [];
                        const q = [s.id];
                        visited.add(s.id);
                        while(q.length > 0) {
                            const curr = q.pop();
                            const studentObj = currentStudents.find(st => st.id === curr);
                            if(studentObj) cluster.push(studentObj);
                            (adj[curr] || []).forEach(neighbor => {
                                if(!visited.has(neighbor) && !lockedStudentIds.has(neighbor)) {
                                    visited.add(neighbor);
                                    q.push(neighbor);
                                }
                            });
                        }
                        clusters.push(cluster);
                    });
                    let bestGroups = null;
                    let maxScore = -Infinity;

                    for(let iter=0; iter < 300; iter++) {
                        let groups = Array.from({ length: targetGroupCount }, () => []);
                        let nextLockedGroupIdx = 0;
                        lockedStudents.forEach(s => {
                            let gIdx = lockedMap.get(s.id);
                            // ê³ ì • ìœ„ì¹˜ê°€ ì—†ê±°ë‚˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìˆœì°¨ ë°°ì • (í•œ ê³³ì— ëª°ë¦¬ëŠ” ê²ƒ ë°©ì§€)
                            if (gIdx === undefined || gIdx >= targetGroupCount) {
                                gIdx = nextLockedGroupIdx % targetGroupCount;
                                nextLockedGroupIdx++;
                            }
                            groups[gIdx].push(s);
                        });
                        const shuffledClusters = [...clusters].sort(() => Math.random() - 0.5);

                        if (useLeader) {
                            const leaderClusters = shuffledClusters.filter(c => c.some(s => s.leader));
                            const normalClusters = shuffledClusters.filter(c => !c.some(s => s.leader));
                            
                            leaderClusters.forEach(cluster => {
                                let minLeaders = Infinity, targetIdx = 0;
                                groups.forEach((g, i) => {
                                    const lCount = g.filter(s => s.leader).length;
                                    if(lCount < minLeaders) { minLeaders = lCount; targetIdx = i; }
                                });
                                groups[targetIdx].push(...cluster);
                            });
                            normalClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        } else {
                            shuffledClusters.forEach(cluster => {
                                let minSize = Infinity, targetIdx = 0;
                                if (useSkill) {
                                    let minSkillSum = Infinity;
                                    groups.forEach((g, i) => {
                                        const currentSum = g.reduce((acc, s) => acc + s.skill, 0);
                                        if (currentSum < minSkillSum) { minSkillSum = currentSum; targetIdx = i; }
                                        else if (currentSum === minSkillSum && g.length < groups[targetIdx].length) { targetIdx = i; }
                                    });
                                } else {
                                    groups.forEach((g, i) => { if(g.length < minSize) { minSize = g.length; targetIdx = i; } });
                                }
                                groups[targetIdx].push(...cluster);
                            });
                        }

                        let score = 0;
                        let valid = true;
                        
                        if (useSkill) {
                            const groupAverages = groups.map(g => g.length > 0 ? g.reduce((a, b) => a + b.skill, 0) / g.length : 0);
                            const validAverages = groupAverages.filter(avg => avg > 0);
                            if (validAverages.length > 1) {
                                const totalAverage = validAverages.reduce((a, b) => a + b, 0) / validAverages.length;
                                const variance = validAverages.reduce((a, b) => a + Math.pow(b - totalAverage, 2), 0) / validAverages.length;
                                score -= variance * 500; // Higher penalty for variance to enforce balance
                            }
                        }

                        groups.forEach(g => {
                            if (useGender) {
                                const m = g.filter(s => s.gender === 'M').length;
                                const f = g.length - m;
                                score -= Math.abs(m - f) * 10;
                            }
                            for(let i=0; i<g.length; i++) {
                                for(let j=i+1; j<g.length; j++) {
                                    const n1 = g[i].name, n2 = g[j].name;
                                    if(avoidancePairs.some(p => (p.p1===n1 && p.p2===n2) || (p.p1===n2 && p.p2===n1))) {
                                        score -= 10000; valid = false;
                                    }
                                    if(useHistory) {
                                        const key = [g[i].id, g[j].id].sort().join('-');
                                        const histScore = historyPairs.get(key) || 0;
                                        score -= histScore * 30; // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê¸°ë°˜ í˜ë„í‹°
                                    }
                                }
                            }
                        });
                        if (valid && score > maxScore) {
                            maxScore = score;
                            bestGroups = JSON.parse(JSON.stringify(groups)); 
                        }
                    }

                    const rawGroups = bestGroups || Array.from({ length: targetGroupCount }, () => []);
                    const finalGroups = rawGroups.map(g => g.map(s => sanitizeStudent(s)).filter(s => s !== null));
                    
                    // [New] Manual Reason Generation
                    const activeConditions = [];
                    if (useGender) activeConditions.push("ì„±ë³„");
                    if (useSkill) activeConditions.push("ì‹¤ë ¥");
                    if (useLeader) activeConditions.push("ë¦¬ë”");
                    if (useHistory) activeConditions.push("ì´ì „ ê¸°ë¡");
                    if (avoidancePairs.length > 0) activeConditions.push("ê¸°í”¼ ê´€ê³„");
                    if (mustPairs.length > 0) activeConditions.push("í•„ìˆ˜ ì§ê¿");
                    const reasonText = activeConditions.length > 0 ? `ì„ íƒí•˜ì‹  ì¡°ê±´(${activeConditions.join(', ')})ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ì•Œê³ ë¦¬ì¦˜ì´ ìµœì ì˜ ì¡°í•©ì„ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.` : "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ì´ ë¬´ì‘ìœ„ë¡œ ì„ì–´ì„œ í¸ì„±í–ˆìŠµë‹ˆë‹¤.";
                    setAiReason(reasonText);

                    if(finalGroups.flat().length === 0) {
                         const plainGroups = Array.from({ length: targetGroupCount }, () => []);
                         currentStudents.forEach((s, i) => plainGroups[i % targetGroupCount].push(sanitizeStudent(s)));
                         
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const groupsToSave = {};
                         for(let i=0; i<groupDuration; i++) {
                             const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                             // [Fix] ì°¸ì¡° ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ê¹Šì€ ë³µì‚¬í•˜ì—¬ í• ë‹¹
                             newGroupsData[d] = plainGroups.map(g => g.map(s => ({...s}))); 
                             groupsToSave[d] = newGroupsData[d];
                         }
                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0) {
                             const newRolesForDate = calculateRoles(plainGroups);
                             const newGroupRoles = { ...currentGroupRoles, [date]: newRolesForDate };
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }
                         
                         syncSeatsWithGroups(plainGroups);
                    } else {
                         const newGroupsData = { ...currentGroupsByDate }; // [Fix] ìµœì‹  ë°ì´í„° ì‚¬ìš©
                         const newGroupRoles = { ...currentGroupRoles };
                         const hasActiveRoles = currentGroupRoles[date] && Object.keys(currentGroupRoles[date]).length > 0;
                         const groupsToSave = {};

                         for(let i=0; i<groupDuration; i++) {
                             const d = dayjs(date).add(i, 'day').format('YYYY-MM-DD');
                             newGroupsData[d] = finalGroups.map(g => g.map(s => ({...s})));
                             groupsToSave[d] = newGroupsData[d];
                             if (hasActiveRoles) newGroupRoles[d] = calculateRoles(finalGroups);
                         }

                         setGroupsByDate(newGroupsData);
                         
                         const updates = {};
                         if (hasActiveRoles) {
                             setGroupRoles(newGroupRoles);
                             updates['cls_group_roles'] = newGroupRoles;
                         }
                         if (!isLocalMode) {
                             saveData(updates);
                             saveGroupsToFirestore(groupsToSave);
                         }

                         syncSeatsWithGroups(finalGroups);
                    }
                    setToastMessage(`ëª¨ë‘  í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${groupDuration}ì¼ ì ìš©)` + (useHistory ? " (ìµœê·¼ ê¸°ë¡ ë°˜ì˜ë¨)" : ""));
                  } catch (e) {
                    logSystemEvent(`ëª¨ë‘  í¸ì„± ì˜¤ë¥˜: ${e.message}`, 'error');
                    setToastMessage("í¸ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                  } finally {
                    if (window.innerWidth < 768) setIsGroupPanelOpen(false);
                  }
            };

            const rotateCurrentGroups = () => { 
                if (!groups || groups.length < 2) return setToastMessage("íšŒì „í•  ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const rotateArray = (arr) => {
                    if (arr.length < 2) return arr;
                    const last = arr[arr.length - 1];
                    const rest = arr.slice(0, arr.length - 1);
                    return [last, ...rest];
                };

                const newGroups = groups.map((_, i) => { const srcIdx = (i - 1 + groups.length) % groups.length; return rotateArray(groups[srcIdx]).map(s => sanitizeStudent(s)); });
                const newGroupsData = { ...groupsByDate, [date]: newGroups }; setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
                
                syncSeatsWithGroups(newGroups);
                setToastMessage("ìì „ê³¼ ê³µì „(íšŒì „)ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            };

            const handleGroupNameSave = (groupIndex, newName) => {
                const oldName = groupNames[date]?.[groupIndex] || `${groupIndex+1}ëª¨ë‘ `;
                if (!newName || newName.trim() === "" || newName === oldName) {
                    setEditingGroupIdx(null);
                    return;
                }

                const currentGroupMembers = groups[groupIndex].map(s => s.id).sort().join(',');
                const sameMemberGroups = [];
                
                Object.entries(groupsByDate).forEach(([d, dateGroups]) => {
                    if (d === date) return;
                    if (!Array.isArray(dateGroups)) return;
                    
                    dateGroups.forEach((g, gIdx) => {
                        if (!Array.isArray(g)) return;
                        const members = g.map(s => (s.id || s)).sort().join(',');
                        if (members === currentGroupMembers) {
                            sameMemberGroups.push({ date: d, index: gIdx });
                        }
                    });
                });

                const prevGroupNames = { ...groupNames }; // Undoë¥¼ ìœ„í•œ ì´ì „ ìƒíƒœ ì €ì¥

                const update = (applyAll) => {
                    const newNames = { ...groupNames };
                    if (!newNames[date]) newNames[date] = {};
                    newNames[date][groupIndex] = newName;

                    if (applyAll) {
                        sameMemberGroups.forEach(({ date: d, index: i }) => {
                            if (!newNames[d]) newNames[d] = { ...(groupNames[d] || {}) }; // ë¶ˆë³€ì„± ìœ ì§€ë¥¼ ìœ„í•´ ë³µì‚¬
                            else newNames[d] = { ...newNames[d] };
                            newNames[d][i] = newName;
                        });
                        setToastMessage(`${sameMemberGroups.length}ê°œì˜ ê³¼ê±° ëª¨ë‘  ì´ë¦„ë„ í•¨ê»˜ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        setToastAction({
                            label: "ë˜ëŒë¦¬ê¸°",
                            onClick: () => {
                                setGroupNames(prevGroupNames);
                                if (!isLocalMode) saveData('cls_group_names', prevGroupNames);
                                setToastMessage("ë³€ê²½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                setToastAction(null);
                            }
                        });
                    }
                    setGroupNames(newNames);
                    if (!isLocalMode) saveData('cls_group_names', newNames);
                    setEditingGroupIdx(null);
                };

                if (sameMemberGroups.length > 0) {
                    if (appConfig.autoBatchRename) {
                        update(true);
                    } else {
                        openConfirm(
                            `ê³¼ê±° ê¸°ë¡ ì¤‘ ë™ì¼í•œ êµ¬ì„±ì›ì˜ ëª¨ë‘ ì´ ${sameMemberGroups.length}ê°œ ìˆìŠµë‹ˆë‹¤.\nì´ë¦„ì„ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œ ì‹œ í˜„ì¬ ëª¨ë‘ ë§Œ ë³€ê²½ë©ë‹ˆë‹¤)`,
                            () => update(true),
                            () => update(false)
                        );
                    }
                } else {
                    update(false);
                }
            };

            const handleRoleChange = (groupIdx, studentIdx, newRole) => {
                const newRoles = { ...groupRoles };
                if (!newRoles[date]) newRoles[date] = {};
                if (!newRoles[date][groupIdx]) newRoles[date][groupIdx] = {};
                
                if (newRole) newRoles[date][groupIdx][studentIdx] = newRole;
                else if (newRoles[date][groupIdx]) delete newRoles[date][groupIdx][studentIdx];
                
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setEditingRoleTarget(null);
            };
            
            const handleGroupReset = (duration) => {
                const datesToDelete = [];
                for (let i = 0; i < duration; i++) {
                    datesToDelete.push(dayjs(date).add(i, 'day').format('YYYY-MM-DD'));
                }

                const newGroups = { ...groupsByDate };
                const newRoles = { ...groupRoles };
                
                datesToDelete.forEach(d => {
                    delete newGroups[d];
                    delete newRoles[d];
                });

                setGroupsByDate(newGroups);
                setGroupRoles(newRoles);
                setSeatAssignments({});

                const updates = { cls_groups_date: newGroups, cls_group_roles: newRoles, cls_seat_assignments: {} };

                if (!isLocalMode) {
                    saveData(updates);
                    deleteGroupsFromFirestore(datesToDelete);
                } else {
                    saveData(updates);
                }

                setToastMessage(`${duration}ì¼ê°„ì˜ ëª¨ë‘  ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                setShowGroupResetModal(false);
            };

            const handleDragStart = (e, studentId, fromGroupIdx) => { 
                draggedGroupItemRef.current = { studentId, fromGroupIdx };
                e.dataTransfer.setData("text/plain", JSON.stringify({ studentId, fromGroupIdx }));
                e.dataTransfer.effectAllowed = "move";
                const target = e.currentTarget;
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        target.classList.add("dragging");
                        document.body.classList.add('is-dragging-group');
                    }, 0);
                });
            };
            const handleDragEnd = (e) => { 
                e.currentTarget.classList.remove("dragging"); 
                document.body.classList.remove('is-dragging-group');
                document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over")); 
                draggedGroupItemRef.current = null;
            };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; e.currentTarget.classList.add("drag-over"); };
            const handleDragLeave = (e) => { 
                if (e.currentTarget.contains(e.relatedTarget)) return;
                e.currentTarget.classList.remove("drag-over"); 
            };
            
            const handleDrop = (e, toGroupIdx) => { 
                e.preventDefault(); 
                e.currentTarget.classList.remove("drag-over");
                document.body.classList.remove('is-dragging-group');
                
                let data = draggedGroupItemRef.current;
                if (!data) {
                    try {
                        const text = e.dataTransfer.getData("text/plain");
                        if (text) data = JSON.parse(text);
                    } catch (err) { console.error("Drop failed", err); }
                }

                if (!data || !data.studentId) return;
                const { studentId, fromGroupIdx } = data;

                if (fromGroupIdx === toGroupIdx) return;
                
                // 1. í˜„ì¬ ë‚ ì§œ ë³€ê²½
                const currentGroups = [...(groupsByDate[date] || [])]; 
                const student = currentGroups[fromGroupIdx].find(s => s.id === studentId); 
                if (!student) return;
                
                currentGroups[fromGroupIdx] = currentGroups[fromGroupIdx].filter(s => s.id !== studentId); 
                currentGroups[toGroupIdx] = [...currentGroups[toGroupIdx], sanitizeStudent(student)]; 
                
                const newGroupsData = { ...groupsByDate, [date]: currentGroups }; 
                const groupsToSave = { [date]: currentGroups };
                const rolesToSave = {};

                // 2. ì´í›„ ë‚ ì§œ ë™ê¸°í™” (Sync to future dates)
                const futureDates = Object.keys(groupsByDate).filter(d => d > date).sort();
                let syncCount = 0;

                futureDates.forEach(fDate => {
                    const fGroups = [...(groupsByDate[fDate] || [])];
                    // ëŒ€ìƒ ëª¨ë‘  ì¸ë±ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    if (fGroups.length <= toGroupIdx) return;

                    // í•´ë‹¹ ë‚ ì§œì—ì„œ í•™ìƒ ì°¾ê¸°
                    let fFromIdx = -1;
                    let fStudent = null;
                    fGroups.forEach((g, idx) => {
                        const found = g.find(s => s.id === studentId);
                        if (found) { fFromIdx = idx; fStudent = found; }
                    });

                    // í•™ìƒì´ ì¡´ì¬í•˜ê³ , ì´ë¯¸ ëª©í‘œ ëª¨ë‘ ì— ìˆì§€ ì•Šë‹¤ë©´ ì´ë™
                    if (fStudent && fFromIdx !== -1 && fFromIdx !== toGroupIdx) {
                        fGroups[fFromIdx] = fGroups[fFromIdx].filter(s => s.id !== studentId);
                        fGroups[toGroupIdx] = [...fGroups[toGroupIdx], sanitizeStudent(fStudent)];
                        
                        newGroupsData[fDate] = fGroups;
                        groupsToSave[fDate] = fGroups;
                        syncCount++;

                        // ì—­í• ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì—­í• ë„ ì¬ê³„ì‚° (êµ¬ì„±ì›ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ)
                        if (groupRoles[fDate] && Object.keys(groupRoles[fDate]).length > 0) {
                             rolesToSave[fDate] = calculateRoles(fGroups);
                        }
                    }
                });

                setGroupsByDate(newGroupsData);
                
                // í˜„ì¬ ë‚ ì§œ ì—­í•  ì—…ë°ì´íŠ¸
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    rolesToSave[date] = calculateRoles(currentGroups);
                }
                
                const updates = { cls_groups_date: newGroupsData };
                if (Object.keys(rolesToSave).length > 0) {
                    const newGroupRoles = { ...groupRoles, ...rolesToSave };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }

                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore(groupsToSave);
                } else {
                    saveData(updates);
                }
                syncSeatsWithGroups(currentGroups);
                
                if (syncCount > 0) {
                    showToast(`ì´ë™ ì™„ë£Œ (ì´í›„ ${syncCount}ì¼ê°„ì˜ ê¸°ë¡ë„ ë³€ê²½ë¨)`);
                }
            };

            const handleAssignRoles = () => {
                const currentGroups = groupsByDate[date] || [];
                if (currentGroups.length === 0) return setToastMessage("í¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const newRolesForDate = calculateRoles(currentGroups);
                const newRoles = { ...groupRoles, [date]: newRolesForDate };
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ëª¨ë‘  ì—­í• ì´ ìë¦¬ì— ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleClearRoles = () => {
                const newRoles = { ...groupRoles };
                delete newRoles[date];
                setGroupRoles(newRoles);
                if (!isLocalMode) saveData('cls_group_roles', newRoles);
                setToastMessage("ì—­í•  ë°°ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleSaveRoles = (newRoles) => {
                setRolesList(newRoles);
                if (!isLocalMode) saveData('cls_roles_list', newRoles);
                setToastMessage("ì—­í•  ëª©ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setIsRoleEditOpen(false);
                
                // í˜„ì¬ ì—­í•  ë°°ì • ì¤‘ì´ë¼ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const currentGroups = groupsByDate[date] || [];
                    if (currentGroups.length > 0) {
                        // ì„ì‹œë¡œ rolesList ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì§ì ‘ ì „ë‹¬
                        const activeRoles = newRoles.length > 0 ? newRoles : ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        const rolesForDate = {};
                        currentGroups.forEach((group, gIdx) => {
                            rolesForDate[gIdx] = {};
                            for (let sIdx = 0; sIdx < group.length; sIdx++) {
                                const myRoles = [];
                                activeRoles.forEach((r, rIdx) => { 
                                    if (rIdx % group.length === sIdx) myRoles.push(r); 
                                });
                                rolesForDate[gIdx][sIdx] = myRoles.join(', ');
                            }
                        });
                        const newGroupRoles = { ...groupRoles, [date]: rolesForDate };
                        setGroupRoles(newGroupRoles);
                        if (!isLocalMode) saveData('cls_group_roles', newGroupRoles);
                    }
                }
            };

            const handleSaveRoleDescriptions = (newDesc) => {
                setRoleDescriptions(newDesc);
                if (!isLocalMode) saveData('cls_role_descriptions', newDesc);
            };

            const handleGroupsChange = (newGroups) => {
                // ë°ì´í„° í¬ê¸° ìµœì í™”ë¥¼ ìœ„í•´ ì‚¬ì§„ ë“± ë¶ˆí•„ìš”í•œ ì •ë³´ ì œê±°
                const newGroupsData = { ...groupsByDate, [date]: newGroups };
                setGroupsByDate(newGroupsData);
                
                const updates = {};
                if (groupRoles[date] && Object.keys(groupRoles[date]).length > 0) {
                    const newRolesForDate = calculateRoles(newGroups);
                    const newGroupRoles = { ...groupRoles, [date]: newRolesForDate };
                    setGroupRoles(newGroupRoles);
                    updates['cls_group_roles'] = newGroupRoles;
                }
                if (!isLocalMode) {
                    saveData(updates);
                    saveGroupsToFirestore({ [date]: newGroups });
                }
            };

            const roleMap = useMemo(() => {
                const map = {};
                const currentGroups = groupsByDate[date] || [];
                const currentRoles = groupRoles[date] || {};
                currentGroups.forEach((g, gIdx) => {
                    g.forEach((s, sIdx) => {
                        const role = currentRoles[gIdx]?.[sIdx] || currentRoles[gIdx]?.[s.id];
                        if (role) map[s.id] = role;
                    });
                });
                return map;
            }, [groupsByDate, groupRoles, date]);

            const stats = useMemo(() => { const dates = Object.keys(records).sort(); const isWithinPeriod = (dStr, period) => { const d = dayjs(dStr); const now = dayjs(); if (period === 'weekly') return d.isAfter(now.subtract(7, 'day')) && d.isBefore(now.add(1, 'day')); if (period === 'monthly') return d.isAfter(now.subtract(30, 'day')) && d.isBefore(now.add(1, 'day')); return true; }; const calcStatsForStudent = (s, period, tag) => { let doneCount = 0; let totalCount = 0; for(let i=34; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); if (!isWithinPeriod(d, period)) continue; const dayRecord = records[d]; const dayTasks = dailyTasks[d] || []; if (tag === 'ì „ì²´') { if (dayRecord) 
            { const tasksForDay = dailyTasks[d] || []; if (tasksForDay.length > 0) { totalCount += tasksForDay.length; const sRec = dayRecord[s.id]; if (sRec) { tasksForDay.forEach((_, idx) => { if (sRec.tasks && sRec.tasks[idx]) doneCount++; else if (!sRec.tasks && sRec.done) doneCount++; }); } } else { totalCount++;
            if (dayRecord[s.id]?.done) doneCount++; } } } else { const tagTasks = dayTasks.filter(t => (typeof t === 'object' ? t.tag : 'ê¸°íƒ€') === tag);
            if (tagTasks.length > 0) { totalCount += tagTasks.length; tagTasks.forEach((t, idx) => { const originalIdx = dayTasks.indexOf(t); const isTaskDone = dayRecord?.[s.id]?.done || dayRecord?.[s.id]?.tasks?.[originalIdx]; if(isTaskDone) doneCount++; });
            } } } return { count: doneCount, total: totalCount, rate: totalCount > 0 ?
            (doneCount / totalCount) * 100 : 0 }; }; const computedStudents = students.map(s => { let count = 0, currentStreak = 0; const history = []; const datesSorted = Object.keys(records).sort(); for(let i=29; i>=0; i--) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const dayIdx = dayjs(d).day(); if(dayIdx===0 || dayIdx===6) continue; let dailyDoneCount = 0; let dailyTotalCount = 0; const dayTasks = dailyTasks[d] || []; const dayRecord = records[d]; if(dayTasks.length > 0) { dailyTotalCount = dayTasks.length; if(dayRecord && dayRecord[s.id]) { dayTasks.forEach((_, idx) => { if(dayRecord[s.id].tasks && dayRecord[s.id].tasks[idx]) dailyDoneCount++; else if(!dayRecord[s.id].tasks && dayRecord[s.id].done) dailyDoneCount++; }); } } else { if(dayRecord && dayRecord[s.id]?.done) { dailyTotalCount = 1; dailyDoneCount = 1; } } const 
            ratio = dailyTotalCount > 0 ? dailyDoneCount / dailyTotalCount : 0; history.push({ date: d, ratio: ratio, count: dailyDoneCount, total: dailyTotalCount, done: dailyDoneCount === dailyTotalCount && dailyTotalCount > 0 }); if(ratio === 1) count++; } for(let i=0; i<365;
            i++) { const d = dayjs().subtract(i, 'day').format('YYYY-MM-DD'); const rec = records[d]?.[s.id]; let isDoneDay = false;
            if(rec) { if(rec.tasks) { if(rec.done) isDoneDay = true; } else if(rec.done) { isDoneDay = true; } } if(isDoneDay) currentStreak++;
            else if(i===0 && !isDoneDay) continue; else break; } const honorStats = calcStatsForStudent(s, honorPeriod, honorTag); const helpStats = calcStatsForStudent(s, helpPeriod, helpTag);
            return { ...s, count, streak: currentStreak, history, honorStats, helpStats }; }); const top5 = [...computedStudents].sort((a,b) => b.honorStats.count - a.honorStats.count).slice(0, 5);
            const bottom5 = [...computedStudents].sort((a,b) => a.helpStats.rate - b.helpStats.rate).slice(0, 5); return { students: computedStudents, top5, bottom5 };
            }, [students, records, dailyTasks, honorPeriod, honorTag, helpPeriod, helpTag]);
            
            const handleFirebaseConnect = (config) => { localStorage.setItem('checklist_config', JSON.stringify(config)); setIsSetupOpen(false);
            setToastMessage("ì—°ê²° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤."); setTimeout(() => window.location.reload(), 1500); };
            
            const handleResetAllData = (selectedItems) => { 
                openConfirm("ì„ íƒí•œ í•­ëª©ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                    const updates = {};
                    
                    if (selectedItems.includes('students')) {
                        setStudents([]);
                        updates['cls_students'] = [];
                    }
                    if (selectedItems.includes('records')) {
                        setRecords({});
                        setSimpleChecks({});
                        updates['cls_records'] = {};

                        // [New] í•™ìƒ ëª…ë‹¨ì€ ìœ ì§€í•˜ë©´ì„œ ê¸°ë¡ë§Œ ì‚­ì œí•˜ëŠ” ê²½ìš°: ìƒë‹´ ê¸°ë¡ê³¼ ìŠ¤í‹°ì»¤ë„ ì´ˆê¸°í™”
                        if (!selectedItems.includes('students')) {
                            const resetStudents = students.map(s => ({ ...s, counseling: [], stickers: 0 }));
                            setStudents(resetStudents);
                            updates['cls_students'] = resetStudents;
                        }
                    }
                    if (selectedItems.includes('groups')) {
                        setGroupsByDate({});
                        setGroupNames({});
                        setGroupRoles({});
                        setAvoidancePairs([]);
                        setMustPairs([]);
                        updates['cls_groups_date'] = {};
                        updates['cls_group_names'] = {};
                        updates['cls_group_roles'] = {};
                        updates['cls_avoidance'] = [];
                        updates['cls_mustPairs'] = [];
                    }
                    if (selectedItems.includes('tasks')) {
                        setDailyTasks({});
                        setWeeklyTasks({0:[],1:[],2:[],3:[],4:[],5:[],6:[]});
                        setTags(['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€']);
                        updates['cls_daily_tasks'] = {};
                        updates['cls_weekly_tasks'] = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
                        updates['cls_tags'] = ['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì˜ì–´', 'ê¸°íƒ€'];
                    }
                    if (selectedItems.includes('seats')) {
                        setSeatAssignments({});
                        setSeatConfig({rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']});
                        updates['cls_seat_assignments'] = {};
                        updates['cls_seat_config'] = {rows:5, cols:5, disabledSeats:['0-2', '1-2', '2-2', '3-2', '4-2', '2-0', '2-1', '2-3', '2-4']};
                    }
                    if (selectedItems.includes('roles')) {
                        setRolesList(['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´']);
                        setRoleDescriptions(DEFAULT_ROLE_DESCRIPTIONS);
                        updates['cls_roles_list'] = ['ë‚˜ëˆ”ì´', 'ë§ºìŒì´', 'ì±™ê¹€ì´', 'ê¹”ë”ì´'];
                        updates['cls_role_descriptions'] = DEFAULT_ROLE_DESCRIPTIONS;
                    }

                    if (!isLocalMode) {
                        saveData(updates);
                        if (db && appId) {
                            if (selectedItems.includes('students')) {
                                db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                            if (selectedItems.includes('records')) {
                                db.collection('classes').doc(appId).collection('records').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });

                                // [New] ìƒë‹´ ê¸°ë¡ í•„ë“œ ì‚­ì œ (í•™ìƒ ëª…ë‹¨ ìœ ì§€ ì‹œ)
                                if (!selectedItems.includes('students')) {
                                    db.collection('classes').doc(appId).collection('studentData').get().then(snapshot => {
                                        const batch = db.batch();
                                        snapshot.docs.forEach(doc => {
                                            batch.update(doc.ref, { counseling: firebase.firestore.FieldValue.delete() });
                                        });
                                        batch.commit();
                                    });
                                }
                            }
                            if (selectedItems.includes('groups')) {
                                db.collection('classes').doc(appId).collection('groupResults').get().then(snapshot => {
                                    const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); batch.commit();
                                });
                            }
                        }
                    } else {
                        saveData(updates);
                    }
                    setToastMessage("ì„ íƒí•œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                });
            };

            const handleFormationTitleClick = () => {
                if (formationClickTimer.current) clearTimeout(formationClickTimer.current);
                const newCount = formationClickCount + 1;
                setFormationClickCount(newCount);
                
                if (newCount >= 3) {
                    onOpenApiKeySetup();
                    setToastMessage("AI ì„¤ì • ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.");
                    setFormationClickCount(0);
                } else {
                    formationClickTimer.current = setTimeout(() => setFormationClickCount(0), 500);
                }
            };

            const handleGenerateBriefing = async () => {
                if (!apiKey) {
                    setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                setIsGenerating(true);
                setAiContent(""); 
                setShowWeeklyBriefing(true);
                setGenerationProgress(0);

                const timer = setInterval(() => {
                    setGenerationProgress(prev => {
                        if (prev >= 95) return prev;
                        return prev + Math.random() * 5;
                    });
                }, 300);

                try {
                    // ì„ íƒëœ ê¸°ê°„ ë°ì´í„° ì§‘ê³„
                    let curr = dayjs(briefingStart);
                    const end = dayjs(briefingEnd);
                    const targetDates = [];
                    while(curr.isBefore(end) || curr.isSame(end, 'day')) {
                        targetDates.push(curr.format('YYYY-MM-DD'));
                        curr = curr.add(1, 'day');
                    }
                    const summary = targetDates.reverse().map(d => {
                        const tasks = dailyTasks[d] || [];
                        const recs = records[d] || {};
                        const total = students.length * (tasks.length || 1);
                        let done = 0;
                        students.forEach(s => {
                            const r = recs[s.id];
                            if(r) {
                                if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                                else if(r.done) done++;
                            }
                        });
                        return `${d}: ìˆ˜í–‰ë¥  ${total > 0 ? Math.round(done/total*100) : 0}%`;
                    }).join('\n');

                    let toneDesc = "ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ ë¹„ì„œì²˜ëŸ¼";
                    if (briefingTone === 'encouraging') toneDesc = "ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'analytical') toneDesc = "ê°ê´€ì ì´ê³  ë¶„ì„ì ì¸ ì–´ì¡°ë¡œ";
                    else if (briefingTone === 'concise') toneDesc = "í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ì–´ì¡°ë¡œ";

                    const prompt = `
                        ${briefingStart}ë¶€í„° ${briefingEnd}ê¹Œì§€ì˜ í•™ê¸‰ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ ì„ ìƒë‹˜ì„ ìœ„í•œ 'ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

                        [ë°ì´í„° ìš”ì•½]
                        ${summary}

                        [ë¶„ì„ ìš”ì²­ì‚¬í•­]
                        1. **í•™ìŠµ íë¦„ ë¶„ì„**: ë‹¨ìˆœ ìˆ˜í–‰ë¥  ë‚˜ì—´ì´ ì•„ë‹Œ, ì£¼ê°„ í•™ìŠµ íë¦„ì˜ ë³€í™”ì™€ íŠ¹ì´ì ì„ íŒŒì•…í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì£¼ì´ˆ ëŒ€ë¹„ ì£¼ë§ì˜ ë³€í™”, íŠ¹ì • ìš”ì¼ì˜ ì €ì¡°í•¨ ë“±)
                        2. **ê´€ì‹¬ í•„ìš” ì˜ì—­**: ìˆ˜í–‰ë¥ ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§€ê±°ë‚˜ ì§€ì†ì ìœ¼ë¡œ ì €ì¡°í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì›ì¸ì„ ì¶”ë¡ í•˜ê³  ì–¸ê¸‰í•´ì£¼ì„¸ìš”.
                        3. **ë‹¤ìŒ ì£¼ ì „ëµ**: ë¶„ì„ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì£¼ í•™ê¸‰ ìš´ì˜ì— ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ 'ì›í¬ì¸íŠ¸ ë ˆìŠ¨'ì´ë‚˜ 'ë¯¸ì…˜'ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
                        4. **ì–´ì¡°**: ${toneDesc} ì‘ì„±í•´ì£¼ì„¸ìš”.
                        5. **í˜•ì‹**: ê°€ë…ì„± ì¢‹ê²Œ ì†Œì œëª©ì„ í™œìš©í•˜ì—¬ êµ¬ì¡°í™”í•˜ê³ , 400ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    clearInterval(timer);
                    setGenerationProgress(100);
                    setAiContent(text);
                } catch (e) {
                    clearInterval(timer);
                    setShowWeeklyBriefing(false);
                    setToastMessage("ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleDownloadBriefingPdf = async () => {
                if (!briefingRef.current) return;
                if (!window.jspdf) return setToastMessage("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
                
                try {
                    const canvas = await window.html2canvas(briefingRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`ì£¼ê°„ë¸Œë¦¬í•‘_${dayjs().format('YYYYMMDD')}.pdf`);
                    setToastMessage("PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) { setToastMessage("PDF ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            const handleGenerateStory = async () => {
                if (!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                setIsGenerating(true);
                try {
                    const tasks = dailyTasks[date] || [];
                    const recs = records[date] || {};
                    const total = students.length * (tasks.length || 1);
                    let done = 0;
                    students.forEach(s => {
                        const r = recs[s.id];
                        if(r) {
                            if(tasks.length > 0) tasks.forEach((_, i) => { if(r.tasks?.[i]) done++; });
                            else if(r.done) done++;
                        }
                    });
                    const rate = total > 0 ? Math.round(done/total*100) : 0;
                    
                    let genrePrompt = "ì˜¤ëŠ˜ í•˜ë£¨ ìš°ë¦¬ ë°˜ì˜ ì†Œì†Œí•œ ì¼ìƒì„ ë‹´ì€ ë”°ëœ»í•œ í•™ê¸‰ ì¼ê¸°";
                    let rolePrompt = "ìˆœìˆ˜í•˜ê³  ë°ì€ ì´ˆë“±í•™ìƒë“¤";
                    
                    if (storyGenre === 'growth') { genrePrompt = "ì–´ë ¤ì›€ì„ ì´ê²¨ë‚´ê³  í•œ ë¼˜ ë” ì„±ì¥í•˜ëŠ” ê°ë™ì ì¸ ì´ì•¼ê¸°"; rolePrompt = "ë…¸ë ¥í•˜ëŠ” ë©‹ì§„ í•™ìƒë“¤"; }
                    else if (storyGenre === 'friendship') { genrePrompt = "ì¹œêµ¬ë¥¼ ë°°ë ¤í•˜ê³  ì„œë¡œ ë•ëŠ” ì•„ë¦„ë‹¤ìš´ ìš°ì • ì´ì•¼ê¸°"; rolePrompt = "ë§ˆìŒì”¨ ì°©í•œ ì¹œêµ¬ë“¤"; }
                    else if (storyGenre === 'funny') { genrePrompt = "ì½ìœ¼ë©´ ì›ƒìŒì´ ë‚˜ì˜¤ëŠ” ìœ ì¾Œí•˜ê³  ì¬ì¹˜ ìˆëŠ” ì´ì•¼ê¸°"; rolePrompt = "ê°œêµ¬ìŸì´ ì¹œêµ¬ë“¤"; }
                    else if (storyGenre === 'lesson') { genrePrompt = "ì˜¤ëŠ˜ì˜ í™œë™ì„ í†µí•´ ì‚¶ì˜ ì§€í˜œë¥¼ ë°°ìš°ëŠ” êµí›ˆì ì¸ ì´ì•¼ê¸°"; rolePrompt = "ì§€í˜œë¡œìš´ í•™ìƒë“¤"; }

                    const prompt = `
                        ì˜¤ëŠ˜ ìš°ë¦¬ ë°˜ì˜ í•˜ë£¨ í™œë™ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì´ˆë“±í•™ìƒë“¤ì—ê²Œ ìœ ìµí•˜ê³  ì¬ë¯¸ìˆëŠ” ${genrePrompt}ë¥¼ ì°½ì‘í•´ì£¼ì„¸ìš”.

                        [ì˜¤ëŠ˜ì˜ í™œë™ ë°ì´í„°]
                        - ë‚ ì§œ: ${date}
                        - ê³¼ì œ ìˆ˜í–‰ë¥ : ${rate}% (ì´ ìˆ˜ì¹˜ëŠ” ì˜¤ëŠ˜ í•˜ë£¨ ì•„ì´ë“¤ì´ ì–¼ë§ˆë‚˜ ì„±ì‹¤í–ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤)
                        - ì¹­ì°¬ ìŠ¤í‹°ì»¤: ì˜¤ëŠ˜ ì „ì²´ ì§€ê¸‰ëœ ìŠ¤í‹°ì»¤ ìˆ˜ (ì•„ì´ë“¤ì˜ ë…¸ë ¥ì— ëŒ€í•œ ë³´ìƒ)

                        [ìŠ¤í† ë¦¬í…”ë§ ê°€ì´ë“œ]
                        1. **ë¶„ìœ„ê¸°**: ìê·¹ì ì´ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¸ íŒíƒ€ì§€ ìš”ì†Œ(ë§ˆë²•, ëª¬ìŠ¤í„° ë“±)ëŠ” ë°°ì œí•˜ê³ , í˜„ì‹¤ì ì¸ í•™êµ ìƒí™œì„ ë°°ê²½ìœ¼ë¡œ ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•´ì£¼ì„¸ìš”.
                        2. **ì „ê°œ**: 'ì•„ì¹¨ì˜ ì‹œì‘ - ê³¼ì œ(ë¯¸ì…˜) ìˆ˜í–‰ ê³¼ì •ì—ì„œì˜ ì—í”¼ì†Œë“œ - ì„œë¡œ ë•ëŠ” ëª¨ìŠµ - í•˜ë£¨ì˜ ë³´ëŒì°¬ ë§ˆë¬´ë¦¬'ì˜ íë¦„ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                        3. **ìºë¦­í„°**: í•™ìƒë“¤ì„ ${rolePrompt}ë¡œ ë¬˜ì‚¬í•˜ë˜, ì‹¤ëª… ëŒ€ì‹  'ìš°ë¦¬ ë°˜ ì¹œêµ¬ë“¤', 'ëª‡ëª‡ ì•„ì´ë“¤' ë“±ìœ¼ë¡œ ì§€ì¹­í•˜ì—¬ ëˆ„êµ¬ë‚˜ ê³µê°í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì„¸ìš”.
                        4. **ë©”ì‹œì§€**: ê²°ê³¼ë³´ë‹¤ëŠ” ê³¼ì •ì„ ì¹­ì°¬í•˜ê³ , ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¦ê±°ì›€ì„ ê°•ì¡°í•˜ë©° ë‚´ì¼ í•™êµ ì˜¤ëŠ” ê²ƒì´ ê¸°ëŒ€ë˜ë„ë¡ í¬ë§ì ì¸ ë©”ì‹œì§€ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”.
                        5. **ë¬¸ì²´**: ì´ˆë“±í•™ìƒì´ ì½ê¸° í¸í•œ ì¹œì ˆí•˜ê³  ë¶€ë“œëŸ¬ìš´ ë¬¸ì²´(í•´ìš”ì²´)ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                        6. **ë¶„ëŸ‰**: 500ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    `;
                    
                    const text = await callGemini(apiKey, prompt);
                    setAiContent(text);
                } catch (e) {
                    logSystemEvent(`í•™ê¸‰ ì´ì•¼ê¸° ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                    setToastMessage("ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleForceLocalMode = () => {
                setIsLocalMode(true);
                setIsLoading(false);
                setToastMessage("ë¡œì»¬ ëª¨ë“œë¡œ ê°•ì œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            if (isLoading) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-slate-50 space-y-6 p-8">
                        <div className="text-6xl animate-bounce mb-2">â³</div>
                        <div className="text-center space-y-2">
                            <div className="text-2xl font-bold text-slate-800">ì•±ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                            <div className="text-sm text-slate-500 font-medium">ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”.</div>
                        </div>
                        
                        <div className="w-full max-w-xs space-y-2">
                            <div className="h-3 w-full bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-300 ease-out" style={{ width: `${loadingProgress}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs font-bold text-slate-400">
                                <span>Loading...</span>
                                <span>{Math.round(loadingProgress)}%</span>
                            </div>
                        </div>

                        {showLongLoading && (
                            <div className="animate-fade-in flex flex-col items-center gap-3 mt-4 pt-4 border-t border-slate-200 w-full max-w-xs">
                                <p className="text-xs text-rose-500 font-bold text-center">
                                    ë¡œë”©ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.<br/>(ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” ì¼ì‹œì  ì˜¤ë¥˜)
                                </p>
                                <div className="flex gap-2 w-full">
                                    <button onClick={() => window.location.reload()} className="flex-1 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 shadow-sm text-sm transition-transform active:scale-95">
                                        ìƒˆë¡œê³ ì¹¨
                                    </button>
                                    <button onClick={handleForceLocalMode} className="flex-1 px-4 py-2.5 bg-slate-100 border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-200 shadow-sm text-sm transition-transform active:scale-95">
                                        ê°•ì œ ë¡œì»¬ ëª¨ë“œ
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`flex flex-col min-h-screen bg-slate-50 text-slate-900 ${appConfig.font === 'serif' ? 'font-serif' : appConfig.font === 'hand' ? 'font-hand' : appConfig.font === 'jua' ? 'font-jua' : appConfig.font === 'nanum' ? 'font-nanum' : appConfig.font === 'nanum-bold' ? 'font-nanum font-bold' : 'font-sans'}`}>
                    <header className="bg-white border-b border-notion-border z-20 sticky top-0"><div className="px-4 py-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-3"><div className="flex items-center gap-6"><div className="flex items-center gap-2"><div className="p-1.5 bg-notion-bg-alt text-notion-text rounded border border-notion-border"><Icon d={PATHS.list} size={18}/></div><h1 className="text-base font-bold text-notion-text">{appConfig.recordTitle}</h1><button 
    onClick={() => { setShowTutorial(true); setTutorialStep(0); }} 
    className="ml-2 w-7 h-7 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-200 transition-colors shadow-sm ring-1 ring-indigo-100" 
    title="ì‚¬ìš© ì„¤ëª…ì„œ ë³´ê¸°"
>
    ğŸ’¡
</button>{!isLocalMode && <div className="animate-fade-in" title="í´ë¼ìš°ë“œ ì—°ê²°ë¨">{appConfig.cloudIcon ? <img src={appConfig.cloudIcon} className="w-6 h-6 object-contain" alt="cloud"/> : <span className="text-xl">â˜ï¸</span>}</div>}</div><div className="hidden md:flex gap-1">{[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (<button key={m.id} onClick={()=>setMode(m.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-sm font-medium transition-all ${mode===m.id?'bg-notion-bg-hover text-notion-text':'text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text'}`}><Icon d={m.icon} size={14}/><span>{m.label}</span></button>))}</div></div>
                    <div className="flex items-center gap-2 absolute right-4 top-3 md:relative md:top-auto md:right-auto">
                        <button onClick={()=>setIsToolsOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>ğŸ§°</span><span className="text-sm font-medium">ë„êµ¬</span></button>
                        <button onClick={()=>setIsSettingOpen(true)} className="p-1.5 text-notion-text-light hover:bg-notion-bg-hover hover:text-notion-text rounded flex items-center gap-1.5"><span>âš™ï¸</span><span className="text-sm font-medium">ì„¤ì •</span></button>
                    </div>
                    </div>{(mode === 'record' || mode === 'group') && (<div className="bg-white border-b border-notion-border pt-2 pb-2 flex justify-center"><div className="w-full max-w-2xl px-4 flex flex-col gap-2">{mode === 'record' ? <><DateHeader date={date} setDate={setDate} onAdd={()=>setIsTaskModalOpen(true)} onReset={resetDateRecord} onCalendar={()=>setIsCalendarOpen(true)} appConfig={appConfig}/> <ProgressBar progress={progress} appConfig={appConfig} /></> : <div className="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-notion-border mx-auto w-fit justify-center cursor-pointer"
><Btn onClick={()=>setDate(dayjs(date).subtract(1,'day').format('YYYY-MM-DD'))} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.left} size={18}/></Btn><div className="flex flex-col items-center px-3" onClick={()=>setIsCalendarOpen(true)}><div className="text-base font-bold text-notion-text">{dayjs(date).format('YY.MM.DD')}</div><div className="text-[10px] font-bold text-notion-text-light">{dayjs(date).format('dddd')}</div></div><Btn onClick={()=>setDate(dayjs(date).add(1,'day').format('YYYY-MM-DD'))} className="p-1.5 text-notion-text-light hover:text-notion-text hover:bg-notion-bg-hover rounded"><Icon d={PATHS.right} size={18}/></Btn></div>}</div></div>)}</header>
                    <main className="flex-1 flex flex-col p-4 md:p-6 pb-20 md:pb-6 bg-white"
                    >
                        <div key={date} className="flex-1">
                            {mode === 'record' && (
                                <>
                                    <div className="flex justify-end mb-4 items-center gap-2">
                                        <Btn onClick={() => { if(!apiKey) return setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); setAiContent(""); setShowClassStory(true); }} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                            <Icon d={PATHS.book} size={16} /> ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸° ë³´ê¸°
                                        </Btn>
                                        <button onClick={() => setShowStoryHelp(true)} className="text-notion-text-light hover:text-notion-text p-1 rounded hover:bg-notion-bg-hover transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={18} /></button>
                                    </div>
                                    <RecordView students={students} records={records} dailyTasks={dailyTasks} date={date} toggleCheck={toggleCheck} appConfig={appConfig} stats={stats} onLongPress={(id) => setGrassStudentId(id)} />
                                </>
                            )}
                            {mode === 'simple' && <SimpleView students={students} simpleChecks={simpleChecks} toggleCheck={toggleCheck} onLongPress={(id) => setGrassStudentId(id)} />}
                            {mode === 'group' && (
                                <div className="w-full md:h-full h-auto flex flex-col md:flex-row gap-6 pb-4 md:overflow-hidden">
                                    <div className={`md:w-1/3 lg:w-1/4 space-y-4 md:h-full h-auto md:overflow-y-auto custom-scroll transition-all duration-300 ${isGroupPanelOpen ? 'block' : 'hidden'}`}>
                                        {isRotationDay && !hideRotationBanner && (
                                            <div className="bg-gradient-to-r from-amber-100 to-yellow-50 p-4 rounded-2xl border border-amber-200 shadow-sm animate-bounce-in relative overflow-hidden">
                                                <button onClick={() => setHideRotationBanner(true)} className="absolute top-2 right-2 text-amber-400 hover:text-amber-600 p-1"><Icon d={PATHS.x} size={14}/></button>
                                                <div className="absolute -right-2 -top-2 text-4xl opacity-20 pointer-events-none">ğŸ”„</div>
                                                <h4 className="font-bold text-amber-800 text-sm mb-1 flex items-center gap-2">
                                                    <span>ğŸ””</span> ì˜¤ëŠ˜ì€ ëª¨ë‘  íšŒì „í•˜ëŠ” ë‚ !
                                                </h4>
                                                <p className="text-xs text-amber-700 mb-3 opacity-90">ì„¤ì •ëœ ìš”ì¼ì…ë‹ˆë‹¤. ìì „ê³¼ ê³µì „ì„ ì‹¤í–‰í• ê¹Œìš”?</p>
                                                <Btn onClick={rotateCurrentGroups} className="w-full py-2 bg-amber-500 text-white rounded-xl font-bold text-xs shadow-md hover:bg-amber-600 flex items-center justify-center gap-1 transition-transform active:scale-95"><Icon d={PATHS.check} size={14}/> ì§€ê¸ˆ íšŒì „í•˜ê¸°</Btn>
                                            </div>
                                        )}
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 onClick={handleFormationTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-default select-none"><span className="text-xl">ğŸ§©</span> í¸ì„±</h3>
                                                <Btn onClick={()=>setIsAvoidanceVisible(!isAvoidanceVisible)} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${isAvoidanceVisible ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}><Icon d={PATHS.users} size={14}/> <span>ê´€ê³„ ì„¤ì •</span>{(avoidancePairs.length + mustPairs.length) > 0 && <span className="bg-indigo-500 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-0.5">{avoidancePairs.length + mustPairs.length}</span>}</Btn>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <Btn onClick={() => applyPreset('coop')} className={`py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${useGender && useSkill && useHistory ? 'bg-indigo-600 text-white shadow-md' : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'}`}>í˜‘ë™ í•™ìŠµ<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì‹¤ë ¥/ì„±ë³„/ê²¹ì¹¨ë°©ì§€</span></Btn>
                                                <Btn onClick={() => applyPreset('peer')} className={`py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${!useGender && useSkill && !useHistory ? 'bg-green-600 text-white shadow-md' : 'bg-green-50 text-green-700 hover:bg-green-100'}`}>ë˜ë˜ êµìˆ˜<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì‹¤ë ¥(ìƒ+í•˜) ë§¤ì¹­</span></Btn>
                                                <Btn onClick={() => applyPreset('project')} className={`py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${useLeader ? 'bg-purple-600 text-white shadow-md' : 'bg-purple-50 text-purple-700 hover:bg-purple-100'}`}>í”„ë¡œì íŠ¸<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ë¦¬ë” ë¶„ì‚° ë°°ì¹˜</span></Btn>
                                                <Btn onClick={() => applyPreset('random')} className={`py-2 rounded-lg text-[11px] sm:text-xs font-bold whitespace-nowrap ${!useGender && !useSkill && !useLeader ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>ì™„ì „ ëœë¤<span className="block text-[9px] font-normal opacity-80 mt-0.5 whitespace-nowrap">ì¡°ê±´ ì—†ì´ ì„ê¸°</span></Btn>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useGender ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useGender} onChange={e=>setUseGender(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useGender ? 'text-indigo-700' : 'text-slate-400'}`}>ì„±ë³„ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useSkill ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useSkill} onChange={e=>setUseSkill(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useSkill ? 'text-indigo-700' : 'text-slate-400'}`}>ì‹¤ë ¥ ê· í˜•</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useLeader ? 'bg-purple-50 border-purple-200 ring-1 ring-purple-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useLeader} onChange={e=>setUseLeader(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useLeader ? 'text-purple-700' : 'text-slate-400'}`}>ğŸ‘‘ ë¦¬ë” ë¶„ì‚°</span></label>
                                                <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${useHistory ? 'bg-orange-50 border-orange-200 ring-1 ring-orange-300' : 'bg-white border-slate-200'}`}><input type="checkbox" checked={useHistory} onChange={e=>setUseHistory(e.target.checked)} className="hidden"/><span className={`text-xs font-bold ${useHistory ? 'text-orange-700' : 'text-slate-400'}`}>ğŸ”„ ê²¹ì¹¨ ë°©ì§€</span></label>
                                                {useHistory && (
                                                    <div className="col-span-2 flex items-center justify-center gap-2 bg-orange-50/50 p-2 rounded-lg border border-orange-100 animate-fade-in">
                                                        <span className="text-[10px] font-bold text-orange-600">ìµœê·¼</span>
                                                        <input type="number" value={historyDuration} onChange={e=>setHistoryDuration(Math.max(1, parseInt(e.target.value) || 1))} className="w-10 p-1 text-center text-xs border border-orange-200 rounded bg-white font-bold text-orange-700 outline-none focus:ring-1 focus:ring-orange-300" />
                                                        <span className="text-[10px] font-bold text-orange-600">ì¼ê°„ì˜ ê¸°ë¡ ì°¸ê³ </span>
                                                    </div>
                                                )}
                                            </div>
                                            {isAvoidanceVisible && (
                                                <div className="mb-6 animate-fade-in bg-slate-50 p-3 rounded-xl">
                                                    <div className="flex bg-white rounded-lg p-1 mb-3 border">
                                                        <button onClick={()=>setPairTab('avoid')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-1 ${pairTab==='avoid'?'bg-rose-50 text-rose-600 shadow-sm ring-1 ring-rose-100':'text-slate-400 hover:bg-slate-50'}`}><span>ğŸš« ê¸°í”¼ ê´€ê³„</span>{avoidancePairs.length > 0 && <span className={`text-[9px] px-1.5 rounded-full ${pairTab==='avoid'?'bg-rose-200 text-rose-700':'bg-slate-200 text-slate-500'}`}>{avoidancePairs.length}</span>}</button>
                                                        <button onClick={()=>setPairTab('must')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-1 ${pairTab==='must'?'bg-green-50 text-green-600 shadow-sm ring-1 ring-green-100':'text-slate-400 hover:bg-slate-50'}`}><span>ğŸ¤ í•„ìˆ˜ ì§ê¿</span>{mustPairs.length > 0 && <span className={`text-[9px] px-1.5 rounded-full ${pairTab==='must'?'bg-green-200 text-green-700':'bg-slate-200 text-slate-500'}`}>{mustPairs.length}</span>}</button>
                                                    </div>
                                                    <div className="flex gap-2 mb-2">
                                                        <select value={p1} onChange={e=>setP1(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500"><option value="">í•™ìƒ1</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <select value={p2} onChange={e=>setP2(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs bg-white outline-none focus:border-indigo-500"><option value="">í•™ìƒ2</option>{students.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                                                        <Btn onClick={()=>{ if(p1&&p2&&p1!==p2){ if(pairTab==='avoid') { const newPairs = [...avoidancePairs,{p1,p2,id:Date.now()}]; setAvoidancePairs(newPairs); if(!isLocalMode) saveData('cls_avoidance', newPairs); } else { const newPairs = [...mustPairs,{p1,p2,id:Date.now()}]; setMustPairs(newPairs); if(!isLocalMode) saveData('cls_mustPairs', newPairs); } setP1(""); setP2(""); } }} className={`text-white px-3 rounded-lg shadow-sm font-bold text-lg ${pairTab==='avoid'?'bg-rose-500 hover:bg-rose-600':'bg-green-500 hover:bg-green-600'}`}>+</Btn>
                                                    </div>
                                                    <div className="flex flex-col gap-2 max-h-40 overflow-y-auto custom-scroll bg-white rounded-lg border border-slate-100 p-2">
                                                        {(pairTab === 'avoid' ? avoidancePairs : mustPairs).length === 0 && <div className="text-center text-xs text-slate-400 py-4">ë“±ë¡ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                                                        {pairTab === 'avoid' ? avoidancePairs.map(p=>(
                                                            <div key={p.id} className="flex justify-between items-center text-xs bg-rose-50 text-rose-700 px-3 py-2 rounded-lg border border-rose-100">
                                                                <span className="font-bold flex items-center gap-2"><Icon d={PATHS.users} size={12}/> {p.p1} <span className="text-rose-400">â‰ </span> {p.p2}</span>
                                                                <button onClick={()=>{ const newPairs = avoidancePairs.filter(x=>x.id!==p.id); setAvoidancePairs(newPairs); if(!isLocalMode) saveData('cls_avoidance', newPairs); }} className="text-rose-400 hover:text-rose-600 bg-white rounded-full p-0.5"><Icon d={PATHS.x} size={12}/></button>
                                                            </div>
                                                        )) : mustPairs.map(p=>(
                                                            <div key={p.id} className="flex justify-between items-center text-xs bg-green-50 text-green-700 px-3 py-2 rounded-lg border border-green-100">
                                                                <span className="font-bold flex items-center gap-2"><Icon d={PATHS.heart} size={12}/> {p.p1} <span className="text-green-400">=</span> {p.p2}</span>
                                                                <button onClick={()=>{ const newPairs = mustPairs.filter(x=>x.id!==p.id); setMustPairs(newPairs); if(!isLocalMode) saveData('cls_mustPairs', newPairs); }} className="text-green-400 hover:text-green-600 bg-white rounded-full p-0.5"><Icon d={PATHS.x} size={12}/></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-rose-100">
                                                        <label className={`flex items-center justify-center gap-2 p-2 rounded-lg border cursor-pointer transition-colors ${showAvoidanceLines ? 'bg-rose-100 border-rose-200 text-rose-700' : 'bg-white border-slate-200 text-slate-400'}`}><input type="checkbox" checked={showAvoidanceLines} onChange={e=>setShowAvoidanceLines(e.target.checked)} className="hidden"/><span className="text-xs font-bold">ğŸš« ê¸°í”¼ ê´€ê³„ ì‹œê°í™”</span></label>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="pt-4 border-t mt-4 border-slate-100">
                                                <div className={`flex items-center p-2 rounded-xl border transition-all mb-2 ${!apiKey ? 'bg-slate-50 border-slate-200' : useAI ? 'bg-violet-50 border-violet-200 ring-1 ring-violet-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                    <label className={`flex items-center flex-1 cursor-pointer ${!apiKey ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                                        <div className={`w-4 h-4 rounded-full border flex items-center justify-center mr-2 ${useAI ? 'bg-violet-500 border-violet-500' : 'border-slate-300'}`}>{useAI && <Icon d={PATHS.check} size={10} className="text-white"/>}</div>
                                                        <span className={`text-sm font-bold flex-1 ${useAI ? 'text-violet-700' : 'text-slate-500'}`}>AI ëª¨ë‘  í¸ì„±</span>
                                                        <input type="checkbox" checked={useAI} onChange={e => { if(!apiKey) { setToastMessage("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } setUseAI(e.target.checked); }} className="hidden" disabled={!apiKey} />
                                                    </label>
                                                    <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowAiHelp(true); }} className="text-slate-400 hover:text-violet-600 p-2 rounded-full hover:bg-white/50 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={16}/></button>
                                                </div>
                                                {useAI && (
                                                <div className="animate-fade-in space-y-2 relative">
                                                        <textarea value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)} className="w-full p-2 border rounded-xl text-xs outline-none focus:border-violet-500 resize-none bg-violet-50/30" placeholder="ì˜ˆ: ë‚¨ë…€ ì„ê³  ìˆ˜í•™ ì˜í•˜ëŠ” ì¹œêµ¬ ê³¨ê³ ë£¨ ë„£ì–´ì¤˜" rows="2"></textarea>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="space-y-3 mt-4 pt-4 border-t border-slate-100">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs font-bold text-slate-500 flex items-center gap-1">ğŸ“… ìœ ì§€ ê¸°ê°„</span>
                                                    <div className="flex items-center gap-1">
                                                        <select value={groupDuration} onChange={e=>setGroupDuration(parseInt(e.target.value))} className="p-1.5 border rounded-lg text-xs bg-white outline-none font-bold text-slate-700 focus:border-indigo-500 w-24">
                                                            <option value={1}>1ì¼</option>
                                                            <option value={7}>1ì£¼</option>
                                                            <option value={14}>2ì£¼</option>
                                                            <option value={21}>3ì£¼</option>
                                                            <option value={28}>4ì£¼</option>
                                                            {![1, 7, 14, 21, 28].includes(groupDuration) && <option value={groupDuration}>{groupDuration}ì¼</option>}
                                                        </select>
                                                        <Btn onClick={() => setIsRangeCalendarOpen(true)} className="p-1.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200" title="ë‹¬ë ¥ì—ì„œ ê¸°ê°„ ì„ íƒ"><Icon d={PATHS.calendar} size={14}/></Btn>
                                                        {groupDuration > 1 && <Btn onClick={() => setGroupDuration(1)} className="p-1.5 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-100" title="ê¸°ê°„ ì´ˆê¸°í™”"><Icon d={PATHS.x} size={14}/></Btn>}
                                                    </div>
                                                </div>
                                                <div className="text-[10px] text-slate-400 text-right mt-1 font-mono">
                                                    {dayjs(date).format('MM/DD')} ~ {dayjs(date).add(groupDuration-1, 'day').format('MM/DD')} ({groupDuration}ì¼)
                                                </div>
                                                <div className="flex bg-slate-100 p-1 rounded-lg"><Btn onClick={()=>setGroupMethod('count')} className={`flex-1 py-1.5 text-[11px] sm:text-xs font-bold rounded-md whitespace-nowrap ${groupMethod==='count'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ëª¨ë‘  ìˆ˜ ê¸°ì¤€</Btn><Btn onClick={()=>setGroupMethod('size')} className={`flex-1 py-1.5 text-[11px] sm:text-xs font-bold rounded-md whitespace-nowrap ${groupMethod==='size'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ì¸ì› ìˆ˜ ê¸°ì¤€</Btn></div>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={groupNumber} onChange={e=>setGroupNumber(parseInt(e.target.value))} className="flex-1 p-2 border rounded-lg text-center font-bold" min="1" max="20"/>
                                                    <span className="text-sm text-slate-500 shrink-0">{groupMethod==='count'?'ê°œ':'ëª…'}</span>
                                                    <Btn onClick={generateGroups} disabled={isGenerating} className={`w-auto px-4 py-2 rounded-lg font-bold shadow-md text-sm whitespace-nowrap flex items-center gap-2 transition-all ${isGenerating ? 'bg-slate-400 text-slate-100 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}>
                                                        {isGenerating ? (
                                                            <>
                                                                <Icon d={PATHS.spinner} className="animate-spin" size={14} />
                                                                <span>í¸ì„± ì¤‘...</span>
                                                            </>
                                                        ) : (useAI ? 'AI í¸ì„±' : 'ëª¨ë‘  í¸ì„±')}
                                                    </Btn>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 mt-2">
                                                    <Btn onClick={rotateCurrentGroups} className={`py-2.5 border rounded-xl font-bold transition-all relative overflow-hidden ${isRotationDay ? 'bg-amber-50 border-amber-300 text-amber-700 shadow-md ring-2 ring-amber-100' : 'bg-white border-slate-300 text-slate-700'}`}>{isRotationDay && <span className="absolute top-0 right-0 w-2 h-2 bg-amber-500 rounded-full animate-ping"></span>}ìì „ê³¼ ê³µì „</Btn>
                                                    <Btn onClick={() => setShowGroupResetModal(true)} className="py-2.5 bg-white border border-rose-200 text-rose-500 rounded-xl font-bold">ì´ˆê¸°í™”</Btn>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 transition-all">
                                            <div className="flex justify-between items-center cursor-pointer select-none" onClick={() => setIsGroupToolsOpen(!isGroupToolsOpen)}>
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                                    <span className="text-xl">ğŸ› ï¸</span> ëª¨ë‘  ë„êµ¬
                                                    <button onClick={(e) => { e.stopPropagation(); setShowRoleHelp(true); }} className="text-slate-400 hover:text-indigo-500"><Icon d={PATHS.help} size={16} /></button>
                                                </h3>
                                                <Icon d={isGroupToolsOpen ? PATHS.down : PATHS.right} size={16} className="text-slate-400" />
                                            </div>
                                            {isGroupToolsOpen && (
                                                <div className="mt-4 grid grid-cols-1 gap-2 animate-fade-in">
                                                    <label className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-50 border-indigo-200 ring-1 ring-indigo-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                        <span className={`text-sm font-bold ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'text-indigo-700' : 'text-slate-500'}`}>ëª¨ë‘  ì—­í•  ìë™ ë¶„ë‹´</span>
                                                        <div className={`w-10 h-6 flex items-center rounded-full p-1 transition-colors ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${groupRoles[date] && Object.keys(groupRoles[date]).length > 0 ? 'translate-x-4' : ''}`}></div></div>
                                                        <input type="checkbox" checked={!!(groupRoles[date] && Object.keys(groupRoles[date]).length > 0)} onChange={(e) => { if(e.target.checked) handleAssignRoles(); else openConfirm("ì—­í•  ë°°ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", handleClearRoles); }} className="hidden" />
                                                    </label>
                                                    <div className="flex gap-2">
                                                        <Btn onClick={() => setIsRoleEditOpen(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-sm">ì—­í•  ëª©ë¡ ìˆ˜ì •</Btn>
                                                        <Btn onClick={() => setShowPartnerAnalysis(true)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 text-sm">ğŸ‘« ì§ê¿ ì´ë ¥ ë¶„ì„</Btn>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className={`flex flex-col md:h-full h-auto gap-4 md:overflow-y-auto custom-scroll pb-10 transition-all duration-300 ${isGroupPanelOpen ? 'md:w-2/3 lg:w-3/4' : 'md:w-full'}`}>
                                        <div id="groups-container" className={`bg-white rounded-2xl border border-slate-200 flex flex-col relative transition-all duration-300 h-auto`}>
                                            <div className="flex justify-between items-center px-4 py-3 border-b border-slate-200 flex-shrink-0 bg-white rounded-t-2xl md:sticky md:top-0 z-10">
                                                <div className="flex items-center gap-2 w-full">
                                                    <Btn onClick={() => setIsGroupPanelOpen(!isGroupPanelOpen)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500">
                                                        <Icon d={isGroupPanelOpen ? PATHS.left : PATHS.right} />
                                                    </Btn>
                                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">ğŸ“… {date} ëª¨ë‘  ({groups.length}ê°œ)</h3>
                                                    {groups.length > 0 && <Btn onClick={handleDownloadGroupsImage} className="ml-auto p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="ì´ë¯¸ì§€ë¡œ ì €ì¥"><Icon d={PATHS.download} size={18} /></Btn>}
                                                </div>
                                            </div>
                                            <GroupOverlay groups={groups} avoidancePairs={avoidancePairs} isVisible={showAvoidanceLines} focusedGroupIdx={focusedGroupIdx} />
                                            <div className="p-4" ref={groupsRef}>
                                                {groups.length > 0 ? (
                                                    <div className="flex flex-wrap gap-4 pb-4 items-start">
                                                        {groups.map((g, i) => {
                                                            const groupAvgSkill = g.length > 0 ? g.reduce((a, s) => a + s.skill, 0) / g.length : 0;
                                                            const isSkillImbalanced = g.length > 0 && Math.abs(groupAvgSkill - classAvgSkill) > 0.5;
                                                            const isExpanded = expandedGroupCards[i];
                                                            const MAX_VISIBLE = 2;
                                                            const visibleStudents = (g.length > MAX_VISIBLE && !isExpanded) ? g.slice(0, MAX_VISIBLE) : g;
                                                            const hiddenCount = g.length - MAX_VISIBLE;
                                                            return (
                                                            <div key={i} className={`group-card bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-4 transition-all hover:shadow-md flex flex-col w-full sm:w-auto flex-grow ${focusedGroupIdx === i ? 'ring-2 ring-rose-400 shadow-md' : ''}`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, i)} onClick={() => setFocusedGroupIdx(prev => prev === i ? null : i)}>
                                                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-50">
                                                                    {editingGroupIdx === i ? (
                                                                        <div className="flex items-center gap-1 w-full max-w-[150px]">
                                                                            <input 
                                                                                className="font-bold text-lg text-slate-800 bg-white border border-indigo-200 rounded px-1 outline-none w-full focus:ring-2 focus:ring-indigo-200"
                                                                                value={editingGroupName}
                                                                                onChange={(e) => setEditingGroupName(e.target.value)}
                                                                                placeholder={`${i+1}ëª¨ë‘ `}
                                                                                autoFocus
                                                                                onKeyDown={(e) => {
                                                                                    if(e.key === 'Enter') {
                                                                                        handleGroupNameSave(i, editingGroupName);
                                                                                    }
                                                                                }}
                                                                                onBlur={() => {
                                                                                    handleGroupNameSave(i, editingGroupName);
                                                                                }}
                                                                            />
                                                                            <Btn onClick={() => handleGroupNameSave(i, editingGroupName)} className="p-1 bg-indigo-100 text-indigo-600 rounded hover:bg-indigo-200"><Icon d={PATHS.check} size={14} /></Btn>
                                                                        </div>
                                                                    ) : (
                                                                        <div className="flex items-center gap-2 group/title">
                                                                            <span className="font-bold text-lg text-slate-800 truncate max-w-[120px]" title={groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}>{groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `}</span>
                                                                            <Btn onClick={() => { setEditingGroupIdx(i); setEditingGroupName(groupNames[date]?.[i] || `${i+1}ëª¨ë‘ `); }} className="p-1 text-slate-300 hover:text-indigo-500 transition-colors"><Icon d={PATHS.edit} size={14} /></Btn>
                                                                        </div>
                                                                    )}
                                                                    <div className="flex items-center gap-1">
                                                                        {isSkillImbalanced && (
                                                                            <div className="text-orange-500 flex items-center animate-pulse" title={`ì‹¤ë ¥ ë¶ˆê· í˜• ê²½ê³  (ëª¨ë‘  í‰ê·  ${groupAvgSkill.toFixed(1)} vs ì „ì²´ ${classAvgSkill.toFixed(1)})`}>
                                                                                <Icon d={PATHS.warning} size={16} />
                                                                            </div>
                                                                        )}
                                                                        <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full">{g.length}ëª…</span>
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-col gap-2 flex-1">
                                                                    {visibleStudents.map((s, sIdx) => {
                                                                        const isLocked = lockedIds.includes(s.id);
                                                                        // ìë¦¬(Index) ê¸°ì¤€ ì—­í•  ì¡°íšŒ (ì—†ìœ¼ë©´ í•™ìƒ ID ê¸°ì¤€ ë ˆê±°ì‹œ ë°ì´í„° ì¡°íšŒ ì‹œë„)
                                                                        const role = groupRoles[date]?.[i]?.[sIdx] || groupRoles[date]?.[i]?.[s.id];
                                                                        return (
                                                                            <div key={s.id} data-student-name={s.name} draggable="true" onDragStart={(e) => handleDragStart(e, s.id, i)} onDragEnd={handleDragEnd} className={`flex items-center justify-between p-2 rounded-2xl border transition-all cursor-grab active:cursor-grabbing touch-none ${s.gender === 'M' ? 'bg-blue-50/50 border-blue-100 hover:bg-blue-50' : 'bg-pink-50/50 border-pink-100 hover:bg-pink-50'} ${isLocked ? 'ring-2 ring-indigo-400 shadow-sm' : ''}`}>
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full ${s.gender==='M'?'bg-blue-200 text-blue-700':'bg-pink-200 text-pink-700'}`}>{s.order}</span>
                                                                                    <span className="text-sm font-bold text-slate-700 whitespace-nowrap">{s.name}</span>
                                                                                    {s.leader && <span className="text-xs" title="ë¦¬ë”">ğŸ‘‘</span>}
                                                                                    <span onClick={(e) => { e.stopPropagation(); setEditingRoleTarget({ gIdx: i, sIdx, currentRole: role }); }} className={`text-[10px] px-1.5 py-0.5 rounded border cursor-pointer hover:bg-indigo-50 transition-colors ${role ? 'bg-white/80 border-slate-200 text-slate-600' : 'bg-slate-50 border-dashed border-slate-300 text-slate-300 hover:text-indigo-400 hover:border-indigo-300'}`} title="ì—­í•  ìˆ˜ì •">{role || "+"}</span>
                                                                                </div>
                                                                                <button onClick={(e) => { e.stopPropagation(); toggleLock(s.id); }} className={`p-1 rounded-full hover:bg-white/50 transition-colors ${isLocked ? 'text-indigo-500' : 'text-slate-300 hover:text-slate-400'}`} title={isLocked ? "ê³ ì • í•´ì œ" : "ê³ ì •í•˜ê¸°"}>
                                                                                    <Icon d={isLocked ? PATHS.lock : PATHS.unlock} size={12} />
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                    {g.length > MAX_VISIBLE && (
                                                                        <button 
                                                                            onClick={(e) => { e.stopPropagation(); setExpandedGroupCards(prev => ({...prev, [i]: !prev[i]})); }}
                                                                            className="w-full py-2 text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors flex items-center justify-center gap-1 mt-1"
                                                                        >
                                                                            {isExpanded ? <>ì ‘ê¸° <Icon d={PATHS.down} size={12} className="rotate-180"/></> : <>+{hiddenCount}ëª… ë” ë³´ê¸° <Icon d={PATHS.down} size={12}/></>}
                                                                        </button>
                                                                    )}
                                                                    {g.length === 0 && (
                                                                        <div className="flex-1 flex items-center justify-center text-slate-300 text-xs border-2 border-dashed border-slate-100 rounded-xl min-h-[60px]">ë¹ˆ ëª¨ë‘ </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ); })}
                                                    </div>
                                                ) : (
                                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-4"><Icon d={PATHS.users} size={48} className="opacity-20"/><p>í¸ì„±ëœ ëª¨ë‘  ì—†ìŒ</p></div>
                                                )}
                                            </div>
                                        </div>
                                        {groups.length > 0 && (
                                            <div className="h-auto flex-shrink-0 transition-all duration-300">
                                                {aiReason && (
                                                    <div className="bg-violet-50 p-4 rounded-2xl border border-violet-100 mb-4 animate-fade-in relative shadow-sm">
                                                        <button onClick={() => setAiReason(null)} className="absolute top-2 right-2 text-violet-300 hover:text-violet-500 p-1"><Icon d={PATHS.x} size={14}/></button>
                                                        <h4 className="font-bold text-violet-700 mb-2 flex items-center gap-2 text-sm"><Icon d={PATHS.magic} size={16}/> {useAI ? "AI í¸ì„± ë¦¬í¬íŠ¸" : "í¸ì„± ê²°ê³¼ ë¦¬í¬íŠ¸"}</h4>
                                                        <p className="text-xs text-violet-800 leading-relaxed whitespace-pre-wrap mb-3">{aiReason}</p>
                                                        <div className="flex justify-end gap-2 border-t border-violet-200/50 pt-3">
                                                            <Btn onClick={generateGroups} disabled={isGenerating} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm">
                                                                {isGenerating ? <Icon d={PATHS.spinner} size={12} className="animate-spin"/> : <Icon d={PATHS.magic} size={12}/>} ë‹¤ì‹œ í¸ì„±
                                                            </Btn>
                                                            <div className="w-px h-6 bg-violet-200 mx-1"></div>
                                                            <Btn onClick={handleCopyAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.copy} size={12}/> ë³µì‚¬</Btn>
                                                            <Btn onClick={handleSaveAiReport} className="px-3 py-1.5 bg-white border border-violet-200 text-violet-600 rounded-lg text-xs font-bold hover:bg-violet-50 flex items-center gap-1 shadow-sm"><Icon d={PATHS.download} size={12}/> ì €ì¥</Btn>
                                                        </div>
                                                    </div>
                                                )}
                                                <BalanceVisualizer groups={groups} students={students} groupNames={groupNames} date={date} />
                                            </div>
                                        )}
                                        <SeatChart students={students} seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments} seatConfig={seatConfig} setSeatConfig={setSeatConfig} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} groups={groups} onGroupsChange={handleGroupsChange} groupNumber={groupNumber} groupMethod={groupMethod} roleMap={roleMap} onOpenStudentInfo={(id) => setGrassStudentId(id)} />
                                    </div>
                                </div>
                            )}
                            {mode === 'stats' && (
                                <div className="max-w-5xl mx-auto space-y-6 animate-fade-in pb-10">
                                <div className="flex justify-end items-center gap-2">
                                    <Btn onClick={() => setShowWeeklyBriefing(true)} disabled={isGenerating} className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 transition-colors ${apiKey ? 'bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50' : 'bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed'} ${isGenerating ? 'opacity-50' : ''}`}>
                                        <Icon d={PATHS.magic} size={16} /> AI ì£¼ê°„ ë¸Œë¦¬í•‘
                                    </Btn>
                                    <button onClick={(e) => { e.stopPropagation(); setShowBriefingHelp(true); }} className="text-slate-400 hover:text-indigo-500 p-2 rounded-full hover:bg-slate-100 transition-colors" title="ë„ì›€ë§"><Icon d={PATHS.help} size={20} /></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸ†</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><div className="flex items-center gap-2"><div className="relative"><select value={honorTag} onChange={(e) => setHonorTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={honorPeriod} onChange={setHonorPeriod} /></div></div></div><div className="space-y-3">{stats.top5.map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-yellow-50/50 rounded-xl border border-yellow-100"><div className="flex items-center gap-3"><span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${i===0?'bg-yellow-500 text-white':i===1?'bg-slate-400 text-white':i===2?'bg-orange-400 text-white':'bg-slate-200 text-slate-500'}`}>{i+1}</span><span className="font-bold text-slate-700">{s.name}</span></div><span className="font-bold text-indigo-600">{s.honorStats.count}íšŒ</span></div>))}{stats.top5.length === 0 && <div className="text-center text-slate-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div>
                                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden"><div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸ“£</div><div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center"><h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">ğŸ“£ ë„ì›€ì´ í•„ìš”í•´ìš”</h3><div className="flex items-center gap-2"><div className="relative"><select value={helpTag} onChange={(e) => setHelpTag(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">{['ì „ì²´', ...tags].map(t => <option key={t} value={t}>{t}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d="M6 9l6 6 6-6" size={12} /></div></div><SwitchToggle value={helpPeriod} onChange={setHelpPeriod} /></div></div></div><div className="space-y-3">{stats.bottom5.filter(s => s.helpStats.rate < 100).map((s, i) => (<div key={s.id} className="flex justify-between items-center p-3 bg-rose-50/50 rounded-xl border border-rose-100"><div className="flex items-center gap-3"><span className="font-bold text-slate-700">{s.name}</span></div><div className="flex items-center gap-2"><div className="w-24 h-2 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-rose-400" style={{width:`${s.helpStats.rate}%`}}></div></div><span className="font-bold text-rose-500 text-sm">{Math.round(s.helpStats.rate)}%</span></div></div>))}{stats.bottom5.filter(s => s.helpStats.rate < 100).length === 0 && <div className="text-center text-slate-400 py-4">ëª¨ë‘ ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‰</div>}</div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <MissingView students={students} records={records} dailyTasks={dailyTasks} />
                                    <StickerAutomationView students={students} records={records} dailyTasks={dailyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} openConfirm={openConfirm} setStudents={setStudents} />
                                </div>
                                <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-lg relative overflow-hidden mt-6">
                                    <div className="absolute -right-4 -bottom-4 text-9xl opacity-10 select-none pointer-events-none">ğŸŒ±</div>
                                    <div className="flex justify-between items-center mb-6 relative z-10">
                                        <h3 onClick={handleGrassTitleClick} className="font-bold text-slate-800 flex items-center gap-2 cursor-pointer select-none"><span className="text-xl">ğŸŒ±</span> í™œë™ ì”ë”” (30ì¼)</h3>
                                        <Btn onClick={handleExportDrafts} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center gap-1 shadow-sm transition-transform active:scale-95">
                                            <Icon d={PATHS.upload} size={14} /> ì´ˆì•ˆ ë‚´ë³´ë‚´ê¸°
                                        </Btn>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 relative z-10">{stats.students.map(s => (<div key={s.id} onClick={() => setGrassStudentId(s.id)} className="flex items-center gap-3 p-2 bg-slate-50 border border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 hover:shadow-sm transition-all group"><div className="w-8 h-8 rounded-full bg-white border flex items-center justify-center font-bold text-xs text-slate-500 overflow-hidden">{s.photo ? <img src={s.photo} className="w-full h-full object-cover" alt={s.name} /> : s.order}</div><div className="flex flex-col min-w-0"><span className="text-sm font-bold text-slate-700 truncate">{s.name}</span><div className="flex gap-0.5 mt-1">{s.history.slice(0,5).map((h,i) => (<div key={i} className="w-2 h-2 rounded-full" style={h.ratio > 0 ? { background: `conic-gradient(#4ade80 0% ${h.ratio*100}%, #e2e8f0 ${h.ratio*100}% 100%)` } : { backgroundColor: '#e2e8f0' }}></div>))}</div></div></div>))}</div>
                                </div>
                                </div>
                            )}
                        </div>
                        <footer onClick={() => setShowUpdateNotes(true)} className="md:hidden text-center py-3 text-[10px] text-slate-400 cursor-pointer hover:text-indigo-500 transition-colors bg-slate-50 border-t border-slate-200 -mx-4 mt-4">{CURRENT_VERSION} | spk </footer>
                    </main>
                    <footer onClick={() => setShowUpdateNotes(true)} className="hidden md:block text-center py-2 text-xs text-slate-400 bg-slate-50 hover:bg-slate-100 border-t border-slate-200 cursor-pointer hover:text-indigo-500 transition-colors">{CURRENT_VERSION} | Visual Studio Code With Gemini</footer>
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-30 pb-safe">
                        <div className="flex justify-around items-center h-14">
                            {[{id:'record',label:'ê¸°ë¡',icon:PATHS.edit},{id:'simple',label:'ë‹¨ìˆœ',icon:PATHS.check},{id:'group',label:'ëª¨ë‘ ',icon:PATHS.users},{id:'stats',label:'í†µê³„',icon:PATHS.chart}].map(m => (
                                <button key={m.id} onClick={()=>setMode(m.id)} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mode===m.id ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                    <div className={`p-1 rounded-xl transition-all ${mode===m.id ? 'bg-indigo-50 transform -translate-y-1' : ''}`}><Icon d={m.icon} size={20} strokeWidth={mode===m.id?2.5:2} /></div>
                                    <span className={`text-[10px] font-bold mt-0.5 ${mode===m.id ? 'text-indigo-600' : 'text-slate-400'}`}>{m.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        message={confirmModal.message} 
                        onConfirm={() => { 
                            const action = confirmModal.onConfirm;
                            setConfirmModal({isOpen:false, message:"", onConfirm:null}); 
                            if(action) action();
                        }} 
                        onCancel={() => {
                            const action = confirmModal.onCancel;
                            setConfirmModal({isOpen:false, message:"", onConfirm:null, onCancel:null});
                            if(action) action();
                        }} 
                    />
                    {appConfig.updateNotificationType === 'toast' ? (
                        <UpdateNotificationToast
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    ) : (
                        <UpdateNotificationModal
                            isOpen={newVersionAvailable}
                            onUpdate={handleUpdateApp}
                            onClose={handleCloseUpdate}
                        />
                    )}
                    {/* ğŸŒŸ íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ì°½ */}
            {showTutorial && (
                <div className="fixed inset-0 bg-black/60 z-[6000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-pop-up flex flex-col">
                        {/* ìƒë‹¨ í”„ë¡œê·¸ë ˆìŠ¤ ë°” */}
                        <div className="flex gap-1 p-4 bg-slate-50 border-b border-slate-100">
                            {tutorialSlides.map((_, idx) => (
                                <div key={idx} className={`h-1.5 flex-1 rounded-full transition-colors duration-300 ${idx <= tutorialStep ? 'bg-indigo-500' : 'bg-slate-200'}`} />
                            ))}
                        </div>
                        
                        {/* ìŠ¬ë¼ì´ë“œ ë‚´ìš© */}
                        <div className="p-8 text-center flex-1 flex flex-col justify-center min-h-[250px]">
                            <div className="text-6xl mb-4 animate-bounce">{tutorialSlides[tutorialStep].emoji}</div>
                            <h3 className="text-xl font-black text-slate-800 mb-3 break-keep">{tutorialSlides[tutorialStep].title}</h3>
                            <p className="text-slate-600 text-sm leading-relaxed break-keep">{tutorialSlides[tutorialStep].desc}</p>
                        </div>
                        
                        {/* í•˜ë‹¨ ë²„íŠ¼ */}
                        <div className="p-4 bg-slate-50 flex items-center justify-between border-t border-slate-100">
                            <button 
                                onClick={() => setShowTutorial(false)} 
                                className="text-slate-400 hover:text-slate-600 text-sm font-bold px-3 py-2"
                            >
                                ê±´ë„ˆë›°ê¸°
                            </button>
                            <div className="flex gap-2">
                                {tutorialStep > 0 && (
                                    <button 
                                        onClick={() => setTutorialStep(prev => prev - 1)} 
                                        className="px-4 py-2 rounded-xl bg-white text-slate-600 font-bold border border-slate-200 hover:bg-slate-50 shadow-sm"
                                    >
                                        ì´ì „
                                    </button>
                                )}
                                {tutorialStep < tutorialSlides.length - 1 ? (
                                    <button 
                                        onClick={() => setTutorialStep(prev => prev + 1)} 
                                        className="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-md transition-colors"
                                    >
                                        ë‹¤ìŒ
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => setShowTutorial(false)} 
                                        className="px-6 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold hover:from-indigo-700 hover:to-purple-700 shadow-md transition-all transform hover:scale-105"
                                    >
                                        ì‹œì‘í•˜ê¸°!
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}
                    <Toast message={toastMessage} action={toastAction} onClose={()=>{ setToastMessage(null); setToastAction(null); }} />
                    <StatsGrassModal 
                        isOpen={!!grassStudentId} 
                        onClose={()=>setGrassStudentId(null)} 
                        student={stats.students.find(s=>s.id===grassStudentId)} 
                        students={students}
                        records={records} 
                        dates={Object.keys(records).sort()} 
                        dailyTasks={dailyTasks} 
                        onSaveCounseling={handleSaveCounseling} 
                        onSaveStickers={handleSaveStickers} 
                        onSaveStickerWithNote={handleSaveStickerWithNote} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        appConfig={appConfig} 
                        apiKey={apiKey} 
                        onSaveRecordDraft={handleSaveRecordDraft}
                        isLocalMode={isLocalMode}
                        db={db}
                        appId={appId}
                        isPortfolioMode={isPortfolioMode}
                        setStudents={setStudents}
                        saveData={saveData} />
                    <SettingsModal 
                        isOpen={isSettingOpen} 
                        onClose={()=>setIsSettingOpen(false)} 
                        students={students} 
                        setStudents={setStudents} 
                        appConfig={appConfig} 
                        setAppConfig={setAppConfig} 
                        isLocalMode={isLocalMode} 
                        saveData={saveData} 
                        showToast={setToastMessage} 
                        openConfirm={openConfirm} 
                        handleResetAllData={handleResetAllData} 
                        onOpenSetup={() => setIsSetupOpen(true)}
                        onOpenNotionSetup={() => setIsNotionSetupOpen(true)}
                        onOpenGoogleSheetSetup={() => setIsGoogleSheetSetupOpen(true)}
                        onOpenApiKeySetup={() => setIsApiKeySetupOpen(true)}
                        records={records} 
                        groupsByDate={groupsByDate} 
                        avoidancePairs={avoidancePairs} 
                        dailyTasks={dailyTasks} 
                        weeklyTasks={weeklyTasks} 
                        tags={tags} 
                        setRecords={setRecords} 
                        setGroupsByDate={setGroupsByDate} 
                        setAvoidancePairs={setAvoidancePairs} 
                        setDailyTasks={setDailyTasks} 
                        setWeeklyTasks={setWeeklyTasks} 
                        setTags={setTags} 
                        backupTimes={backupTimes} 
                        setBackupTimes={setBackupTimes} 
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                        mustPairs={mustPairs} setMustPairs={setMustPairs}
                        groupNames={groupNames} setGroupNames={setGroupNames}
                        groupRoles={groupRoles} setGroupRoles={setGroupRoles}
                        rolesList={rolesList} setRolesList={setRolesList}
                        roleDescriptions={roleDescriptions} setRoleDescriptions={setRoleDescriptions}
                        seatAssignments={seatAssignments} setSeatAssignments={setSeatAssignments}
                        seatConfig={seatConfig} setSeatConfig={setSeatConfig}
                        db={db}
                        appId={appId}
                        deferredPrompt={deferredPrompt}
                        isIOS={isIOS}
                        isStandalone={isStandalone}
                        onInstallApp={handleInstallApp}
                        isDevMode={isDevMode}
                        onDevModeClick={handleGearClick}
                        onTestUpdate={() => setNewVersionAvailable(true)}
                    />
                    <NotionSetupModal isOpen={isNotionSetupOpen} onClose={() => setIsNotionSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} isPortfolioMode={isPortfolioMode} setIsPortfolioMode={setIsPortfolioMode} studentMap={studentMap} setStudentMap={setStudentMap} portfolioDbId={portfolioDbId} setPortfolioDbId={setPortfolioDbId} />
                    <GoogleSheetSetupModal isOpen={isGoogleSheetSetupOpen} onClose={() => setIsGoogleSheetSetupOpen(false)} showToast={setToastMessage} saveData={saveData} isLocalMode={isLocalMode} />
                    <ApiKeySetupModal isOpen={isApiKeySetupOpen} onClose={() => setIsApiKeySetupOpen(false)} apiKey={apiKey} setApiKey={setApiKey} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} validateApiKey={validateApiKey} />
                    <InstallGuideModal isOpen={showInstallGuide} onClose={() => setShowInstallGuide(false)} onInstall={confirmInstall} isIOS={isIOS} />
                    <TaskModal isOpen={isTaskModalOpen} onClose={()=>setIsTaskModalOpen(false)} date={date} dailyTasks={dailyTasks} setDailyTasks={setDailyTasks} weeklyTasks={weeklyTasks} setWeeklyTasks={setWeeklyTasks} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} tags={tags} setTags={setTags} openConfirm={openConfirm} />
                    <CalendarModal isOpen={isCalendarOpen} onClose={()=>setIsCalendarOpen(false)} currentDate={date} onSelectDate={setDate} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <CalendarModal isOpen={isRangeCalendarOpen} onClose={()=>setIsRangeCalendarOpen(false)} currentDate={date} selectionMode="range" onSelectRange={handleRangeSelect} records={records} appConfig={appConfig} groupsByDate={groupsByDate} mode={mode} />
                    <RoleHelpModal isOpen={showRoleHelp} onClose={()=>setShowRoleHelp(false)} roleDescriptions={roleDescriptions} />
                    <RoleEditModal isOpen={isRoleEditOpen} onClose={() => setIsRoleEditOpen(false)} roles={rolesList} onSave={handleSaveRoles} roleDescriptions={roleDescriptions} onSaveDescriptions={handleSaveRoleDescriptions} />
                    <RoleSelectModal isOpen={!!editingRoleTarget} onClose={() => setEditingRoleTarget(null)} roles={rolesList} currentRole={editingRoleTarget?.currentRole} onSelect={(newRole) => handleRoleChange(editingRoleTarget.gIdx, editingRoleTarget.sIdx, newRole)} />
                    <PartnerAnalysisModal isOpen={showPartnerAnalysis} onClose={()=>setShowPartnerAnalysis(false)} groupsByDate={groupsByDate} />
                    <GroupResetModal isOpen={showGroupResetModal} onClose={() => setShowGroupResetModal(false)} onReset={handleGroupReset} />
                    <ClassToolsModal isOpen={isToolsOpen} onClose={() => setIsToolsOpen(false)} students={students} />
                    <BaseModal isOpen={showAiHelp} onClose={()=>setShowAiHelp(false)} title="AI ëª¨ë‘  í¸ì„± ë„ì›€ë§" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">
                            <p><strong>ì‚¬ìš© ë°©ë²•:</strong><br/>ì›í•˜ëŠ” ëª¨ë‘  êµ¬ì„± ì¡°ê±´ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.</p>
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <strong>ğŸ’¡ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ</strong>
                                <ul className="list-disc pl-4 mt-2 space-y-1">
                                    <li>ë‚¨ë…€ ì„±ë¹„ë¥¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì¤˜</li>
                                    <li>ë¦¬ë”(ì´ë„ë¯¸)ê°€ ê° ëª¨ë‘ ì— í•œ ëª…ì”© ë“¤ì–´ê°€ê²Œ í•´ì¤˜</li>
                                    <li>ìˆ˜í•™ ì‹¤ë ¥ì´ ìƒ/ì¤‘/í•˜ ê³¨ê³ ë£¨ ì„ì´ê²Œ í•´ì¤˜</li>
                                    <li>íŠ¹ì • í•™ìƒ(ì˜ˆ: ì² ìˆ˜, ì˜í¬)ì€ ê°™ì€ ëª¨ë‘ ì´ ë˜ì§€ ì•Šê²Œ í•´ì¤˜</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Weekly Briefing Modal */}
                    <BaseModal isOpen={showWeeklyBriefing} onClose={() => setShowWeeklyBriefing(false)} title="ğŸ“Š AI ì£¼ê°„ ë¸Œë¦¬í•‘" icon={PATHS.magic}>
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¶„ì„ ê¸°ê°„:</span>
                                        <input type="date" value={briefingStart} onChange={e=>setBriefingStart(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                        <span className="text-xs text-slate-400">~</span>
                                        <input type="date" value={briefingEnd} onChange={e=>setBriefingEnd(e.target.value)} className="text-xs p-2 border rounded-lg bg-white outline-none focus:border-indigo-500 flex-1"/>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-slate-500">ë¸Œë¦¬í•‘ ì–´ì¡°:</span>
                                        <div className="flex bg-white rounded-lg border border-slate-200 p-1 flex-1">
                                            <button onClick={()=>setBriefingTone('encouraging')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='encouraging'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ğŸ¥° ê²©ë ¤</button>
                                            <button onClick={()=>setBriefingTone('analytical')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='analytical'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>ğŸ“Š ë¶„ì„</button>
                                            <button onClick={()=>setBriefingTone('concise')} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all ${briefingTone==='concise'?'bg-indigo-100 text-indigo-700':'text-slate-400 hover:bg-slate-50'}`}>âš¡ ê°„ê²°</button>
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateBriefing} className="w-full py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ë¸Œë¦¬í•‘ ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-4">
                                    <div className="w-full max-w-xs bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div className="bg-indigo-500 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${generationProgress}%` }}></div>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm font-bold text-indigo-600">
                                        <Icon d={PATHS.spinner} size={16} className="animate-spin"/>
                                        <span>ë°ì´í„° ë¶„ì„ ì¤‘... {Math.round(generationProgress)}%</span>
                                    </div>
                                </div>
                            ) : aiContent && (
                                <div ref={briefingRef} className="bg-slate-50 p-6 rounded-2xl border border-slate-200 leading-relaxed whitespace-pre-wrap text-slate-700">
                                    {aiContent || "ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={() => setAiContent("")} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ë‹¤ì‹œ í•˜ê¸°</Btn>
                                        <Btn onClick={handleDownloadBriefingPdf} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.download} size={16} /> PDF
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ë¸Œë¦¬í•‘ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                                            <Icon d={PATHS.copy} size={16} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowWeeklyBriefing(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Briefing Help Modal */}
                    <BaseModal isOpen={showBriefingHelp} onClose={() => setShowBriefingHelp(false)} title="AI ì£¼ê°„ ë¸Œë¦¬í•‘ì´ë€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì„ íƒí•œ ê¸°ê°„ ë™ì•ˆì˜ í•™ê¸‰ ê¸°ë¡(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ì„ ë¶„ì„í•˜ì—¬ <strong>í•™ê¸‰ ìš´ì˜ì— ë„ì›€ì´ ë˜ëŠ” ì¸ì‚¬ì´íŠ¸</strong>ë¥¼ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <h4 className="font-bold text-indigo-700 mb-2">âœ¨ ì£¼ìš” ê¸°ëŠ¥ ë° í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>ê¸°ê°„ ì„¤ì •:</strong> ì›í•˜ëŠ” ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ê°„, ì›”ê°„, ë˜ëŠ” íŠ¹ì • ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>í•™ìŠµ ë¶„ìœ„ê¸° íŒŒì•…:</strong> ì „ì²´ì ì¸ ê³¼ì œ ìˆ˜í–‰ë¥  ì¶”ì„¸ë¥¼ í†µí•´ í•™ê¸‰ ë¶„ìœ„ê¸°ê°€ ì–´ë–»ê²Œ ë³€í™”í•˜ê³  ìˆëŠ”ì§€ í•œëˆˆì— ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                                    <li><strong>ë§ì¶¤í˜• ì¡°ì–¸:</strong> ë°ì´í„° ë¶„ì„ì„ í†µí•´ ì„ ìƒë‹˜ì—ê²Œ í•„ìš”í•œ ê²©ë ¤ì™€ êµ¬ì²´ì ì¸ í•™ê¸‰ ìš´ì˜ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
                                </ul>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ğŸ“– ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°" icon={PATHS.book} zIndex="z-[2000]">
                        <div className="space-y-4">
                            {!isGenerating && !aiContent && (
                                <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 space-y-3">
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold text-purple-700">ì¥ë¥´ ì„ íƒ:</span>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                            {[
                                                {id:'school', emoji:'ğŸ«', label:'í•™êµ'},
                                                {id:'growth', emoji:'ğŸŒ±', label:'ì„±ì¥'},
                                                {id:'friendship', emoji:'ğŸ¤', label:'ìš°ì •'},
                                                {id:'funny', emoji:'ğŸ˜„', label:'ìœ ë¨¸'},
                                                {id:'lesson', emoji:'ğŸ’¡', label:'êµí›ˆ'}
                                            ].map(g => (
                                                <button key={g.id} onClick={()=>setStoryGenre(g.id)} className={`flex flex-col items-center justify-center py-3 rounded-xl border-2 transition-all ${storyGenre===g.id?'bg-purple-50 border-purple-500 text-purple-700 shadow-md scale-105':'bg-white border-transparent hover:bg-purple-50 hover:border-purple-200 text-slate-500'}`}>
                                                    <span className="text-2xl mb-1">{g.emoji}</span>
                                                    <span className="text-xs font-bold">{g.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <Btn onClick={handleGenerateStory} className="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold hover:shadow-lg transition-all text-sm flex items-center justify-center gap-2">
                                        <Icon d={PATHS.magic} size={16} /> ì´ì•¼ê¸° ìƒì„±í•˜ê¸°
                                    </Btn>
                                </div>
                            )}

                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : aiContent && (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2 flex-wrap">
                                {aiContent && !isGenerating && (
                                    <>
                                        <Btn onClick={handleGenerateStory} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200 flex items-center gap-1">
                                            <Icon d={PATHS.magic} size={14} /> ë‹¤ì‹œ ì“°ê¸°
                                        </Btn>
                                        <Btn onClick={() => setAiContent("")} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">
                                            ë‹¤ë¥¸ ì¥ë¥´ë¡œ
                                        </Btn>
                                        <Btn onClick={() => { navigator.clipboard.writeText(aiContent); setToastMessage("ìŠ¤í† ë¦¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-1">
                                            <Icon d={PATHS.copy} size={14} /> ë³µì‚¬
                                        </Btn>
                                    </>
                                )}
                                <Btn onClick={() => setShowClassStory(false)} className="px-3 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>

                    {/* Class Story Modal */}
                    <BaseModal isOpen={showClassStory} onClose={() => setShowClassStory(false)} title="ğŸ° í•™ê¸‰ ì„¸ê³„ê´€ ìŠ¤í† ë¦¬" icon={PATHS.book}>
                        <div className="space-y-4">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                                    <Icon d={PATHS.spinner} size={32} className="animate-spin text-purple-500"/>
                                    <span>ì˜¤ëŠ˜ì˜ ëª¨í—˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            ) : (
                                <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100 leading-relaxed whitespace-pre-wrap text-slate-800 font-serif">
                                    {aiContent || "ìŠ¤í† ë¦¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}
                                </div>
                            )}
                            <div className="flex justify-end gap-2">
                                <Btn onClick={handleGenerateStory} disabled={isGenerating} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-xl font-bold hover:bg-purple-200">ë‹¤ì‹œ ì“°ê¸°</Btn>
                                <Btn onClick={() => setShowClassStory(false)} className="px-4 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-300">ë‹«ê¸°</Btn>
                            </div>
                        </div>
                    </BaseModal>
                    
                    {/* Story Help Modal */}
                    <BaseModal isOpen={showStoryHelp} onClose={() => setShowStoryHelp(false)} title="ì˜¤ëŠ˜ì˜ í•™ê¸‰ ì´ì•¼ê¸°ë€?" icon={PATHS.help}>
                        <div className="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p>ì˜¤ëŠ˜ í•˜ë£¨ ìš°ë¦¬ ë°˜ì˜ í™œë™ ë°ì´í„°(ê³¼ì œ ìˆ˜í–‰ë¥ , ìŠ¤í‹°ì»¤ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ <strong>ë”°ëœ»í•œ í•™ê¸‰ ì´ì•¼ê¸°</strong>ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                            
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-slate-700 mb-2">ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
                                <ol className="list-decimal pl-5 space-y-1">
                                    <li>ì˜¤ëŠ˜ì˜ ê³¼ì œ ì²´í¬ì™€ ìŠ¤í‹°ì»¤ ì§€ê¸‰ì„ ì™„ë£Œí•©ë‹ˆë‹¤.</li>
                                    <li><strong>'ì˜¤ëŠ˜ì˜ í•™ê¸‰ ìŠ¤í† ë¦¬ ë³´ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                                    <li>AIê°€ ì‘ì„±í•œ ìš°ë¦¬ ë°˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ í•¨ê»˜ ì½ìŠµë‹ˆë‹¤.</li>
                                </ol>
                            </div>

                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <h4 className="font-bold text-purple-700 mb-2">âœ¨ í™œìš© íŒ</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li>í•˜êµ ì‹œê°„ì— ì•„ì´ë“¤ê³¼ í•¨ê»˜ ì½ìœ¼ë©° í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•´ìš”.</li>
                                    <li>ê³¼ì œ ìˆ˜í–‰ë¥ ì´ ë†’ìœ¼ë©´ 'ì„±ì·¨ê° ìˆëŠ” ì´ì•¼ê¸°'ê°€, ë‚®ìœ¼ë©´ 'ê²©ë ¤ì˜ ì´ì•¼ê¸°'ê°€ ë‚˜ì˜µë‹ˆë‹¤.</li>
                                    <li>ì•„ì´ë“¤ì´ í•˜ë£¨ë¥¼ ë˜ëŒì•„ë³´ê³  ë‚´ì¼ì„ ê¸°ëŒ€í•˜ê²Œ ë„ì™€ì¤ë‹ˆë‹¤.</li>
                                </ul>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h4 className="font-bold text-slate-700 mb-2">ğŸ“œ ì´ì•¼ê¸° ì˜ˆì‹œ</h4>
                                <p className="italic text-slate-500 text-xs bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">
                                    "ì˜¤ëŠ˜ ìš°ë¦¬ 3í•™ë…„ 2ë°˜ ì¹œêµ¬ë“¤ì€ 'ìˆ˜í•™ ìµí˜ì±…'ì´ë¼ëŠ” ì‘ì€ ë„ì „ì„ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤. ì²˜ìŒì—ëŠ” ì–´ë ¤ì›Œí•˜ëŠ” ì¹œêµ¬ë“¤ë„ ìˆì—ˆì§€ë§Œ, ì„œë¡œ ë•ê³  ê²©ë ¤í•˜ë©° 95%ì˜ ê³¼ì œ ë‹¬ì„±ë¥ ì„ ê¸°ë¡í–ˆë‹µë‹ˆë‹¤! ì˜¤ëŠ˜ ìš°ë¦¬ê°€ í•¨ê»˜ ëª¨ì€ ì¹­ì°¬ ìŠ¤í‹°ì»¤ëŠ” ì´ 15ê°œ! ì¹œêµ¬ë“¤ì€ ë¿Œë“¯í•œ ë§ˆìŒì„ ì•ˆê³ , ë‚´ì¼ ë˜ ë§Œë‚  ì¦ê±°ìš´ í•™êµ ìƒí™œì„ ê¸°ëŒ€í•˜ë©° ì§‘ìœ¼ë¡œ í–¥í–ˆìŠµë‹ˆë‹¤."
                                </p>
                            </div>
                        </div>
                    </BaseModal>
                    
                        <SetupModal 
                        isOpen={isSetupOpen} 
                        onClose={() => setIsSetupOpen(false)} 
                        showToast={setToastMessage} 
                        onConnect={handleFirebaseConnect} 
                    />
                    <BaseModal isOpen={showOfflineModal} onClose={() => setShowOfflineModal(false)} title="ì¤€ë¹„ ì™„ë£Œ!" icon={PATHS.check}>
                        <div className="text-center space-y-4 py-4">
                            <div className="text-6xl animate-bounce">ğŸ‘Œ</div>
                            <h3 className="text-lg font-bold text-slate-800">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</h3>
                            <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-sm text-indigo-700">
                                ì´ì œ ì¸í„°ë„·ì„ ëŠì–´ë„ ë©ë‹ˆë‹¤.<br/>(ìƒˆë¡œê³ ì¹¨ ê¸ˆì§€)
                            </div>
                        </div>
                        <Btn onClick={() => setShowOfflineModal(false)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mt-2">
                            í™•ì¸ ({autoCloseTimer}ì´ˆ í›„ ë‹«í˜)
                        </Btn>
                    </BaseModal>
                    <UpdateNotesModal isOpen={showUpdateNotes} onClose={() => setShowUpdateNotes(false)} showToast={setToastMessage} notes={UPDATE_NOTES} />
                    {showGlobalRecord && (
                        <GlobalRecordModal isOpen={showGlobalRecord} onClose={()=>setShowGlobalRecord(false)} students={students} setStudents={setStudents} saveData={saveData} isLocalMode={isLocalMode} showToast={setToastMessage} buttonPos={buttonPos} appConfig={appConfig} db={db} appId={appId} />
                    )}
                    <AiSecurityCheckModal isOpen={aiCheckState.isOpen} onClose={handleAiCheckCancel} prompt={aiCheckState.prompt} onConfirm={handleAiCheckConfirm} />
                    <button 
                        onMouseEnter={() => { setIsHidden(false); if(hideTimer.current) clearTimeout(hideTimer.current); }}
                        onMouseDown={handleButtonDragStart}
                        onTouchStart={handleButtonDragStart}
                        onDoubleClick={() => {
                            setButtonPos({ x: window.innerWidth - 80, y: window.innerHeight - 80 });
                            setIsHidden(false);
                        }}
                        onClick={() => { if (!isDragGesture.current) { setShowGlobalRecord(true); resetButtonIdleTimer(); } }}
                        style={{ 
                            left: buttonPos.x, 
                            top: buttonPos.y,
                            transform: isHidden ? (buttonPos.x < window.innerWidth / 2 ? 'translateX(-50px)' : 'translateX(50px)') : 'none'
                        }}
                        className={`fixed z-[1500] ${appConfig.floatingButtonSize === 'small' ? 'w-10 h-10' : appConfig.floatingButtonSize === 'large' ? 'w-16 h-16' : appConfig.floatingButtonSize === 'xlarge' ? 'w-20 h-20' : 'w-14 h-14'} bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center group ${isDraggingButton ? '' : 'transition-all duration-300 hover:bg-indigo-700 hover:scale-105'} ${isHidden ? 'opacity-50' : (isButtonIdle ? 'opacity-30 hover:opacity-100' : 'opacity-100')}`}
                        title="ë¹ ë¥¸ ê´€ì°° ê¸°ë¡"
                    >
                        <Icon d={PATHS.edit} size={appConfig.floatingButtonSize === 'small' ? 20 : appConfig.floatingButtonSize === 'large' ? 28 : appConfig.floatingButtonSize === 'xlarge' ? 36 : 24} />
                        <span className={`absolute bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none ${buttonPos.x < window.innerWidth / 2 ? 'left-full ml-3' : 'right-full mr-3'}`}>ë¹ ë¥¸ ê¸°ë¡</span>
                    </button>
                </div>
            );
        };

        const SwitchToggle = ({ value, onChange }) => (
                <>
                    <div className="md:hidden relative">
                        <select value={value} onChange={(e) => onChange(e.target.value)} className="appearance-none bg-slate-100 text-slate-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 border-none cursor-pointer hover:bg-slate-200 transition-colors">
                            <option value="weekly">ì£¼ê°„</option>
                            <option value="monthly">ì›”ê°„</option>
                            <option value="all">ì „ì²´</option>
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon d={PATHS.down} size={12} /></div>
                    </div>
                    <div className="hidden md:flex bg-slate-100 p-1 rounded-xl shadow-inner">
                        <button onClick={() => onChange('weekly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'weekly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì£¼ê°„</button>
                        <button onClick={() => onChange('monthly')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'monthly' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì›”ê°„</button>
                        <button onClick={() => onChange('all')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${value === 'all' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>ì „ì²´</button>
                    </div>
                </>
        );

        const RoleSelectModal = ({ isOpen, onClose, roles, currentRole, onSelect }) => {
            const [selected, setSelected] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    if (currentRole) {
                        setSelected(currentRole.split(',').map(r => r.trim()).filter(r => r));
                    } else {
                        setSelected([]);
                    }
                }
            }, [isOpen, currentRole]);

            const toggle = (role) => {
                setSelected(prev => prev.includes(role) ? prev.filter(r => r !== role) : [...prev, role]);
            };

            const handleSave = () => {
                onSelect(selected.length > 0 ? selected.join(', ') : null);
            };

            if (!isOpen) return null;
            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ì„ íƒ (ì¤‘ë³µ ê°€ëŠ¥)" icon={PATHS.users} maxWidth="max-w-xs" footer={
                    <Btn onClick={handleSave} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">ì €ì¥í•˜ê¸°</Btn>
                }>
                    <div className="grid grid-cols-1 gap-2 max-h-[50vh] overflow-y-auto custom-scroll pr-1">
                        {roles.map((role, i) => {
                            const isSelected = selected.includes(role);
                            return (
                                <button key={i} onClick={() => toggle(role)} className={`p-3 rounded-xl border text-sm font-bold transition-all flex justify-between items-center ${isSelected ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                    <span>{role}</span>
                                    {isSelected && <Icon d={PATHS.check} size={16} />}
                                </button>
                            );
                        })}
                    </div>
                </BaseModal>
            );
        };

        const RoleEditModal = ({ isOpen, onClose, roles, onSave, roleDescriptions, onSaveDescriptions }) => {
            const [tempRoles, setTempRoles] = useState([]);
            const [newRole, setNewRole] = useState("");
            const [editingRole, setEditingRole] = useState(null);
            const [editTitle, setEditTitle] = useState("");
            const [editDesc, setEditDesc] = useState("");

            useEffect(() => { if (isOpen) setTempRoles([...roles]); }, [isOpen, roles]);

            const handleAdd = () => {
                if (newRole.trim()) {
                    setTempRoles([...tempRoles, newRole.trim()]);
                    setNewRole("");
                }
            };

            const handleDelete = (index) => {
                setTempRoles(tempRoles.filter((_, i) => i !== index));
            };

            const handleMove = (index, direction) => {
                const newRoles = [...tempRoles];
                const targetIndex = index + direction;
                if (targetIndex >= 0 && targetIndex < newRoles.length) {
                    [newRoles[index], newRoles[targetIndex]] = [newRoles[targetIndex], newRoles[index]];
                    setTempRoles(newRoles);
                }
            };

            const startEditDesc = (role) => {
                const descData = roleDescriptions[role] || { title: `${role}ì˜ ì—­í• `, desc: [] };
                setEditingRole(role);
                setEditTitle(descData.title);
                setEditDesc(descData.desc.join('\n'));
            };

            const saveDesc = () => {
                const newDescList = editDesc.split('\n').map(l => l.trim()).filter(l => l);
                const newDescriptions = {
                    ...roleDescriptions,
                    [editingRole]: { title: editTitle, desc: newDescList }
                };
                onSaveDescriptions(newDescriptions);
                setEditingRole(null);
            };

            const restoreDefault = () => {
                const def = DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                if (def) {
                    setEditTitle(def.title);
                    setEditDesc(def.desc.join('\n'));
                }
            };

            if (editingRole) {
                const hasDefault = !!DEFAULT_ROLE_DESCRIPTIONS[editingRole];
                return (
                    <BaseModal isOpen={isOpen} onClose={() => setEditingRole(null)} title={`${editingRole} ì„¤ëª… í¸ì§‘`} icon={PATHS.edit} footer={
                        <div className="flex gap-2">
                            <Btn onClick={() => setEditingRole(null)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">ì·¨ì†Œ</Btn>
                            <Btn onClick={saveDesc} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">ì €ì¥</Btn>
                        </div>
                    }>
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between items-center mb-1">
                                    <label className="text-xs font-bold text-slate-500">ì—­í•  íƒ€ì´í‹€</label>
                                    {hasDefault && <Btn onClick={restoreDefault} className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded hover:bg-slate-200">ê¸°ë³¸ê°’ ë³µì›</Btn>}
                                </div>
                                <input value={editTitle} onChange={e => setEditTitle(e.target.value)} className="w-full p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ì˜ˆ: ì¹œêµ¬ë“¤ì„ ë„ì™€ì£¼ëŠ” ë‚˜ëˆ”ì´!" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ìƒì„¸ ì„¤ëª… (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                                <textarea value={editDesc} onChange={e => setEditDesc(e.target.value)} className="w-full h-32 p-2 border rounded-xl text-sm resize-none outline-none focus:border-indigo-500" placeholder="í•  ì¼ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”." />
                            </div>
                        </div>
                    </BaseModal>
                );
            }

            return (
                <BaseModal isOpen={isOpen} onClose={onClose} title="ì—­í•  ëª©ë¡ í¸ì§‘" icon={PATHS.edit} footer={<Btn onClick={() => onSave(tempRoles)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">ì €ì¥í•˜ê¸°</Btn>}>
                    <div className="flex gap-2 mb-4"><input value={newRole} onChange={(e) => setNewRole(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.nativeEvent.isComposing && handleAdd()} className="flex-1 p-2 border rounded-xl text-sm outline-none focus:border-indigo-500" placeholder="ìƒˆ ì—­í•  ì´ë¦„" /><Btn onClick={handleAdd} className="bg-indigo-50 text-indigo-600 px-4 rounded-xl font-bold hover:bg-indigo-100">ì¶”ê°€</Btn></div>
                    <div className="space-y-2 max-h-[300px] overflow-y-auto custom-scroll pr-1">{tempRoles.map((role, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-200"><span className="font-bold text-slate-700 text-sm">{i + 1}. {role}</span><div className="flex items-center gap-1"><Btn onClick={() => startEditDesc(role)} className="p-1 text-indigo-400 hover:text-indigo-600" title="ì„¤ëª… ìˆ˜ì •"><Icon d={PATHS.document} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleMove(i, -1)} disabled={i === 0} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} className="rotate-180" size={16} /></Btn><Btn onClick={() => handleMove(i, 1)} disabled={i === tempRoles.length - 1} className="p-1 text-slate-400 hover:text-indigo-500 disabled:opacity-30"><Icon d={PATHS.down} size={16} /></Btn><div className="w-px h-4 bg-slate-300 mx-1"></div><Btn onClick={() => handleDelete(i)} className="p-1 text-rose-400 hover:text-rose-600"><Icon d={PATHS.trash} size={16} /></Btn></div></div>))}</div>
                    <p className="text-xs text-slate-400 mt-2 text-center">* ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ëª¨ë‘ ì›ì—ê²Œ ë°°ì •ë©ë‹ˆë‹¤.</p>
                </BaseModal>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

<!----comment node----></body><whale-quicksearch translate="no" style="visibility: visible;"></whale-quicksearch></html>